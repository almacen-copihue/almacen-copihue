    <script>
        // ========== PWA INSTALACI√ìN ==========
        let deferredPrompt;
        const installPrompt = document.getElementById('installPrompt');
        
        function isPWAInstalled() {
            if (window.matchMedia('(display-mode: standalone)').matches) return true;
            if (window.navigator.standalone === true) return true;
            return false;
        }
        
        window.addEventListener('beforeinstallprompt', (e) => {
            if (isPWAInstalled()) return;
            
            e.preventDefault();
            deferredPrompt = e;
            
            setTimeout(() => {
                if (deferredPrompt && installPrompt && !isPWAInstalled()) {
                    installPrompt.style.display = 'flex';
                    
                    setTimeout(() => {
                        if (installPrompt.style.display !== 'none') {
                            installPrompt.style.display = 'none';
                        }
                    }, 30000);
                }
            }, 3000);
        });
        
        if (installPrompt) {
            installPrompt.addEventListener('click', async () => {
                if (/iPhone|iPad|iPod/.test(navigator.userAgent)) {
                    document.getElementById('iosInstructions').style.display = 'flex';
                    installPrompt.style.display = 'none';
                    return;
                }
                
                if (deferredPrompt) {
                    try {
                        deferredPrompt.prompt();
                        const choiceResult = await deferredPrompt.userChoice;
                        deferredPrompt = null;
                        installPrompt.style.display = 'none';
                        
                        if (choiceResult.outcome === 'accepted') {
                            showSuccessMessage('‚úÖ ¬°App instalada exitosamente!');
                        }
                    } catch (error) {
                        console.error('Error instalaci√≥n:', error);
                    }
                } else {
                    location.reload();
                }
            });
        }
        
        window.addEventListener('appinstalled', () => {
            if (installPrompt) installPrompt.style.display = 'none';
            deferredPrompt = null;
            showSuccessMessage('‚úÖ ¬°App instalada correctamente!');
        });
        
        function showSuccessMessage(message) {
            const notification = document.createElement('div');
            notification.className = 'success-notification';
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
        }
        
function initPWA() {
    // 1. REGISTRAR SERVICE WORKER
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./sw.js')
            .then(registration => {
                console.log('‚úÖ Service Worker registrado:', registration.scope);
                
                // Verificar actualizaciones peri√≥dicamente
                setInterval(() => {
                    registration.update();
                }, 60 * 60 * 1000); // Cada hora
                
                // Escuchar actualizaciones
                registration.addEventListener('updatefound', () => {
                    const newWorker = registration.installing;
                    console.log('üîÑ Nueva versi√≥n del Service Worker encontrada');
                    
                    newWorker.addEventListener('statechange', () => {
                        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                            // Mostrar notificaci√≥n al usuario
                            if (confirm('¬°Nueva versi√≥n disponible! ¬øRecargar para actualizar?')) {
                                window.location.reload();
                            }
                        }
                    });
                });
            })
            .catch(error => {
                console.error('‚ùå Error registrando Service Worker:', error);
            });
        
        // Escuchar cambios en el controlador
        navigator.serviceWorker.addEventListener('controllerchange', () => {
            console.log('üéÆ Controller cambiado - Recargando...');
            window.location.reload();
        });
    }
    
    // 2. ESCUCHAR BEFOREINSTALLPROMPT
    window.addEventListener('beforeinstallprompt', (e) => {
        if (isPWAInstalled()) {
            if (installPrompt) installPrompt.style.display = 'none';
            return;
        }
        
        e.preventDefault();
        deferredPrompt = e;
        
        // Mostrar bot√≥n de instalaci√≥n despu√©s de 3 segundos
        setTimeout(() => {
            if (installPrompt && deferredPrompt && !isPWAInstalled()) {
                installPrompt.style.display = 'flex';
                
                // Ocultar despu√©s de 30 segundos
                setTimeout(() => {
                    if (installPrompt.style.display !== 'none') {
                        installPrompt.style.display = 'none';
                    }
                }, 30000);
            }
        }, 3000);
    });
    
    // 3. ESCUCHAR APP INSTALADA
    window.addEventListener('appinstalled', () => {
        console.log('üéâ PWA instalada exitosamente');
        if (installPrompt) installPrompt.style.display = 'none';
        deferredPrompt = null;
        showSuccessMessage('‚úÖ ¬°App instalada correctamente!');
    });
    
    // 4. VERIFICAR SI YA EST√Å INSTALADA
    if (isPWAInstalled() && installPrompt) {
        installPrompt.style.display = 'none';
    }
    
    // 5. MANEJAR INSTALACI√ìN PARA iOS
    if (installPrompt) {
        installPrompt.addEventListener('click', async () => {
            if (/iPhone|iPad|iPod/.test(navigator.userAgent)) {
                document.getElementById('iosInstructions').style.display = 'flex';
                installPrompt.style.display = 'none';
                return;
            }
            
            if (deferredPrompt) {
                try {
                    deferredPrompt.prompt();
                    const choiceResult = await deferredPrompt.userChoice;
                    deferredPrompt = null;
                    installPrompt.style.display = 'none';
                    
                    if (choiceResult.outcome === 'accepted') {
                        showSuccessMessage('‚úÖ ¬°App instalada exitosamente!');
                    }
                } catch (error) {
                    console.error('Error instalaci√≥n:', error);
                }
            } else {
                location.reload();
            }
        });
    }
}

function showSuccessMessage(message) {
    const notification = document.createElement('div');
    notification.className = 'success-notification';
    notification.textContent = message;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 3000);
}

        // ========== SISTEMA DE OFERTAS SIMPLIFICADO ==========
        const OFERTAS_SISTEMA = {
            '1': { 
                nombre: "10% OFF",
                descuentos: [0.10],
                minUnidad: 1,
                maxUnidades: null
            },
            '2': { 
                nombre: "10-20% OFF",
                descuentos: [0.10, 0.20],
                minUnidad: 2,
                maxUnidades: null
            },
            '3': { 
                nombre: "10-30% OFF",
                descuentos: [0.10, 0.20, 0.30],
                minUnidad: 3,
                maxUnidades: 10
            },
            '4': { 
                nombre: "10-40% OFF",
                descuentos: [0.10, 0.20, 0.30, 0.40],
                minUnidad: 4,
                maxUnidades: 6
            },
            '5': { 
                nombre: "10-50% OFF",
                descuentos: [0.10, 0.20, 0.30, 0.40, 0.50],
                minUnidad: 5,
                maxUnidades: 6
            }
        };

        // ========== FUNCI√ìN DE REDONDEO ALMAC√âN COPIHUE ==========
        function redondearPrecioAlmacenCopihue(precio) {
            if (typeof precio !== 'number' || isNaN(precio) || precio <= 0) return 0;
            
            // Siempre a favor del cliente (hacia abajo) - Pol√≠tica del Almac√©n Copihue
            const redondeado = Math.floor(precio / 100) * 100;
            
            // Verificar si la diferencia es muy peque√±a (menos de $20)
            const diferencia = precio - redondeado;
            
            // Si la diferencia es menor a $20, mantenemos el redondeo hacia abajo
            // Esto evita que 1,020 se convierta en 1,000 (p√©rdida de $20)
            if (diferencia > 0 && diferencia < 20) {
                return redondeado;
            }
            
            return redondeado;
        }

        // ========== SISTEMA DE DETECCI√ìN DE TIPO DE VENTA COMPLETO ==========
        function obtenerTipoDeVenta(nombreProducto) {
            const nombre = nombreProducto.toLowerCase().trim();
            
            // PALABRAS CLAVE POR TIPO DE VENTA
            const palabrasPorPeso = [
                'kg', 'kilo', 'kilos', 'kilogramo', 'kilogramos',
                'gr', 'gramo', 'gramos', 'g', 'grs',
                'libra', 'lb', 'libras', 'lbs',
                'onza', 'oz', 'onzas'
            ];
            
            const palabrasPorUnidad = [
                'unidad', 'unidades', 'unid', 'unids', 'u', 
                'c/u', 'cada uno', 'cada unidad',
                'pieza', 'piezas', 'pza', 'pzas',
                'x unidad', 'por unidad'
            ];
            
            const palabrasPorEmpaque = [
                'bandeja', 'bandejas', 'bdeja',
                'paquete', 'paquetes', 'pqt', 'pqte',
                'bolsa', 'bolsas', 'bolsita', 'bolsitas',
                'caja', 'cajas', 'cajita', 'cajitas',
                'pack', 'packs', 'pkg',
                'atado', 'atados', 'atadito', 'ataditos',
                'ramo', 'ramos', 'ramito', 'ramitos',
                'blister', 'blisters'
            ];
            
            // LISTA EXTENSA DE FRUTAS Y VERDURAS
            const frutasVerduras = [
                // Frutas
                'durazno', 'duraznos', 'duraznito', 'duraznitos',
                'tomate', 'tomates', 'tomate redondo', 'tomate perita', 'tomate cherry',
                'manzana', 'manzanas', 'manzanita', 'manzanitas',
                'naranja', 'naranjas', 'naranjita', 'naranjitas',
                'lim√≥n', 'limones', 'limon', 'limoncito', 'limoncitos',
                'mandarina', 'mandarinas', 'mandarinita', 'mandarinitas',
                'banana', 'bananas', 'bananita', 'bananitas',
                'frutilla', 'frutillas', 'frutillita', 'frutillitas',
                'uva', 'uvas', 'uvita', 'uvitas',
                'ciruela', 'ciruelas', 'ciruelita', 'ciruelitas',
                'pera', 'peras', 'perita', 'peritas',
                'mel√≥n', 'melon', 'melones',
                'sand√≠a', 'sandia', 'sandias',
                'kiwi', 'kiwis',
                'anan√°', 'anana', 'anan√°s', 'pi√±a',
                'palta', 'paltas', 'paltita', 'paltitas',
                'frutilla', 'frutillas',
                'cereza', 'cerezas',
                'ar√°ndano', 'ar√°ndanos', 'arandano', 'arandanos',
                
                // Verduras
                'cebolla', 'cebollas', 'cebollita', 'cebollitas',
                'papa', 'papas', 'papita', 'papitas',
                'zanahoria', 'zanahorias', 'zanahorita', 'zanahoritas',
                'lechuga', 'lechugas', 'lechuguita', 'lechuguitas',
                'acelga', 'acelgas', 'acelguita', 'acelguitas',
                'espinaca', 'espinacas', 'espinacita', 'espinacitas',
                'zapallo', 'zapallos', 'zapallito', 'zapallitos',
                'berenjena', 'berenjenas', 'berenjenita', 'berenjenitas',
                'pepino', 'pepinos', 'pepinito', 'pepinitos',
                'pimiento', 'pimientos', 'pimientito', 'pimientitos',
                'morr√≥n', 'morron', 'morrones',
                'ajo', 'ajos', 'ajito', 'ajitos',
                'perejil', 'perejiles',
                'cilantro', 'cilantros',
                'apio', 'apios',
                'br√≥coli', 'brocoli', 'br√≥colis',
                'coliflor', 'coliflores',
                'repollo', 'repollos',
                'r√°bano', 'rabano', 'r√°banos', 'rabanos',
                'remolacha', 'remolachas',
                
                // Especias y otros
                'jengibre', 'jengibres', 'jengibrito',
                'or√©gano', 'oregano',
                'albahaca', 'albahacas',
                'romero', 'romeros',
                'tomillo', 'tomillos'
            ];
            
            // PASO 1: Verificar si contiene palabras espec√≠ficas de tipo
            for (const palabra of palabrasPorPeso) {
                // Buscar palabras completas, no substrings
                const regex = new RegExp(`\\b${palabra}\\b`, 'i');
                if (regex.test(nombre)) {
                    return 'peso'; // KG, GR, etc.
                }
            }
            
            for (const palabra of palabrasPorUnidad) {
                const regex = new RegExp(`\\b${palabra}\\b`, 'i');
                if (regex.test(nombre)) {
                    return 'unidad';
                }
            }
            
            for (const palabra of palabrasPorEmpaque) {
                const regex = new RegExp(`\\b${palabra}\\b`, 'i');
                if (regex.test(nombre)) {
                    return 'empaque';
                }
            }
            
            // PASO 2: Si es fruta/verdura y NO tiene especificaci√≥n, asumir por PESO
            for (const fv of frutasVerduras) {
                if (nombre.includes(fv)) {
                    // Verificar que NO tenga especificaci√≥n ya
                    const tieneAlgunaEspecificacion = [
                        ...palabrasPorPeso,
                        ...palabrasPorUnidad,
                        ...palabrasPorEmpaque
                    ].some(palabra => {
                        const regex = new RegExp(`\\b${palabra}\\b`, 'i');
                        return regex.test(nombre);
                    });
                    
                    if (!tieneAlgunaEspecificacion) {
                        return 'peso'; // Fruta/verdura sin especificar = por peso
                    }
                    break;
                }
            }
            
            // PASO 3: Default = unidad
            return 'unidad';
        }

        // ========== FUNCIONES PARA L√çMITES DE OFERTAS2 ==========
        function obtenerLimiteOfertas2(ofertas2) {
            if (!ofertas2 || ofertas2 === '') return null;
            
            const porcentaje = parseInt(ofertas2);
            if (isNaN(porcentaje)) return null;
            
            // Reglas de l√≠mites para descuentos altos
            if (porcentaje >= 70 && porcentaje <= 99) {
                return 3; // Para descuentos MUY altos (70-99%)
            } else if (porcentaje >= 50 && porcentaje <= 69) {
                return 5; // Para descuentos altos (50-69%)
            }
            
            return null; // Sin l√≠mite para descuentos < 50%
        }

        // ‚úÖ FUNCI√ìN PARA TEXTO DE L√çMITE MEJORADA
        function obtenerTextoLimiteOfertas2(ofertas2, nombreProducto = '') {
            const limite = obtenerLimiteOfertas2(ofertas2);
            if (limite === null) return '';
            
            const tipoVenta = obtenerTipoDeVenta(nombreProducto);
            
            switch(tipoVenta) {
                case 'peso':
                    // Detectar si es gramos o kilos
                    const nombreLower = nombreProducto.toLowerCase();
                    if (nombreLower.includes('gr') || nombreLower.includes('gramo')) {
                        return `<span class="tipo-venta-icon">‚öñÔ∏è</span> M√°x. ${limite * 1000} GRAMOS por familia`;
                    } else {
                        return `<span class="tipo-venta-icon">‚öñÔ∏è</span> M√°x. ${limite} KILOS por familia`;
                    }
                case 'unidad':
                    return `<span class="tipo-venta-icon">üì¶</span> M√°x. ${limite} UNIDADES por familia`;
                case 'empaque':
                    return `<span class="tipo-venta-icon">üéÅ</span> M√°x. ${limite} PAQUETES por familia`;
                default:
                    return `<span class="tipo-venta-icon">üì¶</span> M√°x. ${limite} unidades por familia`;
            }
        }

        // ‚úÖ FUNCI√ìN PARA TEXTO EN STOCK CON TIPO
        function obtenerTextoStock(product) {
            const tipoVenta = obtenerTipoDeVenta(product.name);
            const stockNumber = product.stockNumber || 0;
            
            if (stockNumber === 0) {
                return '‚ùå Sin Stock';
            }
            
            let icono = '';
            let unidad = '';
            
            switch(tipoVenta) {
                case 'peso':
                    const nombreLower = product.name.toLowerCase();
                    if (nombreLower.includes('gr') || nombreLower.includes('gramo')) {
                        icono = '‚öñÔ∏è';
                        unidad = `${stockNumber * 1000}g`;
                    } else {
                        icono = '‚öñÔ∏è';
                        unidad = `${stockNumber}kg`;
                    }
                    break;
                case 'unidad':
                    icono = 'üì¶';
                    unidad = `${stockNumber}u`;
                    break;
                case 'empaque':
                    icono = 'üéÅ';
                    unidad = `${stockNumber}pqt`;
                    break;
                default:
                    icono = 'üì¶';
                    unidad = `${stockNumber}`;
            }
            
            if (stockNumber > 0 && stockNumber <= 3) {
                return `‚ö†Ô∏è Stock Bajo ${icono} <span class="stock-tipo">(${unidad})</span>`;
            } else {
                return `‚úÖ En Stock ${icono} <span class="stock-tipo">(${unidad})</span>`;
            }
        }

        // ========== FUNCIONES CLAVE CORREGIDAS ==========
        // ‚úÖ FUNCI√ìN PARA CALCULAR DESCUENTO REAL (POST-REDONDEO)
        function calcularDescuentoReal(precioOriginal, precioFinal) {
            if (precioOriginal <= 0 || precioFinal >= precioOriginal) return 0;
            return Math.round(((precioOriginal - precioFinal) / precioOriginal) * 100);
        }

        // ‚úÖ FUNCI√ìN PRINCIPAL CORREGIDA - OFERTAS2 SIEMPRE GANA
        function calcularPrecioConDescuento(precioOriginal, ofertas1, ofertas2, cantidad) {
            if (!precioOriginal || precioOriginal <= 0) return 0;
            
            // ‚úÖ OFERTAS2 SIEMPRE TIENE PRIORIDAD (ACUERDO)
            if (ofertas2 !== undefined && ofertas2 !== null && ofertas2 !== '' && ofertas2 !== '0') {
                const porcentaje = parseInt(ofertas2);
                if (!isNaN(porcentaje) && porcentaje >= 1 && porcentaje <= 99) {
                    // Verificar l√≠mite para ofertas altas
                    const limiteOferta2 = obtenerLimiteOfertas2(ofertas2);
                    if (limiteOferta2 !== null && cantidad > limiteOferta2) {
                        cantidad = limiteOferta2;
                    }
                    
                    const descuento = porcentaje / 100;
                    const precioConDescuento = precioOriginal * (1 - descuento);
                    return redondearPrecioAlmacenCopihue(precioConDescuento);
                }
            }
            
            // ‚úÖ SOLO SI NO HAY OFERTAS2, USAR OFERTAS1
            if (ofertas1 !== undefined && ofertas1 !== null && ofertas1 !== '' && ofertas1 !== '0') {
                const ofertaNum = parseInt(ofertas1);
                if (!isNaN(ofertaNum) && ofertaNum >= 1 && ofertaNum <= 5) {
                    const oferta = OFERTAS_SISTEMA[ofertaNum.toString()];
                    if (!oferta) return redondearPrecioAlmacenCopihue(precioOriginal);
                    
                    if (oferta.maxUnidades !== null && cantidad > oferta.maxUnidades) {
                        cantidad = oferta.maxUnidades;
                    }
                    
                    let descuentoAplicar;
                    if (cantidad >= oferta.descuentos.length) {
                        descuentoAplicar = oferta.descuentos[oferta.descuentos.length - 1];
                    } else if (cantidad > 0) {
                        descuentoAplicar = oferta.descuentos[cantidad - 1];
                    } else {
                        descuentoAplicar = 0;
                    }
                    
                    const precioConDescuento = precioOriginal * (1 - descuentoAplicar);
                    return redondearPrecioAlmacenCopihue(precioConDescuento);
                }
            }
            
            return redondearPrecioAlmacenCopihue(precioOriginal);
        }

        // ‚úÖ FUNCI√ìN PARA OBTENER TEXTO DE OFERTA (SIMPLIFICADO)
        function obtenerTextoOfertaTarjeta(precioOriginal, precioFinal) {
            const descuentoReal = calcularDescuentoReal(precioOriginal, precioFinal);
            // Solo mostrar si hay descuento, pero no el porcentaje exacto
            return descuentoReal > 0 ? `üî• OFERTA` : '';
        }

        // ‚úÖ FUNCI√ìN PARA OBTENER DESCRIPCI√ìN DE OFERTA (SIN PORCENTAJES)
        function obtenerDescripcionOferta(ofertas1, ofertas2, precioOriginal) {
            // ‚úÖ SI HAY OFERTAS2, MOSTRAR "OFERTA ESPECIAL"
            if (ofertas2 && ofertas2 !== '' && ofertas2 !== '0') {
                const porcentaje = parseInt(ofertas2);
                if (!isNaN(porcentaje)) {
                    return `üéØ OFERTA ESPECIAL`;
                }
            }
            
            // ‚úÖ SOLO SI NO HAY OFERTAS2, MOSTRAR "OFERTA PROGRESIVA"
            if (!ofertas1 || ofertas1 === '' || ofertas1 === '0') return "";
            
            const ofertaNum = parseInt(ofertas1);
            if (isNaN(ofertaNum) || ofertaNum < 1 || ofertaNum > 5) return "";
            
            const oferta = OFERTAS_SISTEMA[ofertaNum.toString()];
            if (!oferta) return "";
            
            const esOfertaFija = oferta.descuentos.length === 1;
            
            if (esOfertaFija) {
                return `üéØ OFERTA`;
            } else {
                let descripcion = `üìà OFERTA PROGRESIVA`;
                if (oferta.maxUnidades !== null) {
                    descripcion += ` (M√°x. ${oferta.maxUnidades}u)`;
                }
                return descripcion;
            }
        }

        // ========== MODIFICAR showLimitError ==========
        function showLimitError(productName, limit, promoName) {
            const tipoVenta = obtenerTipoDeVenta(productName);
            const notification = document.createElement('div');
            notification.className = 'limit-notification';
            
            let icono = '';
            let unidad = '';
            
            switch(tipoVenta) {
                case 'peso':
                    const nombreLower = productName.toLowerCase();
                    if (nombreLower.includes('gr') || nombreLower.includes('gramo')) {
                        icono = '‚öñÔ∏è';
                        unidad = `${limit * 1000} GRAMOS`;
                    } else {
                        icono = '‚öñÔ∏è';
                        unidad = `${limit} KILOS`;
                    }
                    break;
                case 'unidad':
                    icono = 'üì¶';
                    unidad = `${limit} UNIDADES`;
                    break;
                case 'empaque':
                    icono = 'üéÅ';
                    unidad = `${limit} PAQUETES`;
                    break;
                default:
                    icono = 'üì¶';
                    unidad = `${limit} unidades`;
            }
            
            notification.innerHTML = `${icono} ${promoName}: m√°ximo ${unidad} de ${productName} por familia`;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // ========== VARIABLES GLOBALES ==========
        const SHEET_ID = '1hKeM-13t6wyGD5Ya4Rx9NeUJXsgJoVN4dOb-rklPznA';
        let products = [];
        let cart = [];
        let currentCategory = "TODOS";
        let lowStockAlertSent = false;
        let esAdmin = false;
        let isSearching = false;

        // ========== ELEMENTOS DOM ==========
        const categoriesContainer = document.getElementById("categories");
        const productsGrid = document.getElementById("productsGrid");
        const featuredOffers = document.getElementById("featuredOffers");
        const featuredProductsGrid = document.getElementById("featuredProductsGrid");
        const viewAllOffers = document.getElementById("viewAllOffers");
        const cartIcon = document.getElementById("cartIcon");
        const floatingCart = document.getElementById("floatingCart");
        const floatingSearch = document.getElementById("floatingSearch");
        const searchModal = document.getElementById("searchModal");
        const closeSearch = document.getElementById("closeSearch");
        const mobileSearch = document.getElementById("mobileSearch");
        const mobileSearchResults = document.getElementById("mobileSearchResults");
        const cartModal = document.getElementById("cartModal");
        const closeCart = document.getElementById("closeCart");
        const cartItems = document.getElementById("cartItems");
        const cartTotal = document.getElementById("cartTotal");
        const cartCount = document.getElementById("cartCount");
        const floatingCartCount = document.getElementById("floatingCartCount");
        const sendOrder = document.getElementById("sendOrder");
        const adminBadge = document.getElementById("adminBadge");
        const adminNotification = document.getElementById("adminNotification");
        const productSearch = document.getElementById("productSearch");
        const clearSearchBtn = document.getElementById("clearSearchBtn");
        const clearMobileSearchBtn = document.getElementById("clearMobileSearchBtn");
        const searchSuggestions = document.getElementById("searchSuggestions");
        // AGREGA ESTO AL INICIO, despu√©s de las otras variables globales:
        const SEARCH_DICTIONARY = {
            'tomate': ['tomates'],
            'durazno': ['duraznos'],
            'manzana': ['manzanas'],
            'naranja': ['naranjas'],
            'limon': ['limones'],
            'cebolla': ['cebollas'],
            'papa': ['papas'],
            'zanahoria': ['zanahorias'],
            'lechuga': ['lechugas'],
            'kg': ['kilo', 'kilos'],
            'gr': ['gramo', 'gramos'],
            'unid': ['unidad', 'unidades']
        };

        // ========== FUNCIONES PRINCIPALES ==========
        window.handleMobileSearchEnter = function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const searchTerm = mobileSearch.value.trim();
                if (searchTerm.length >= 2) {
                    filterMobileProducts(searchTerm);
                    mobileSearch.blur();
                }
            }
        };

function sendOrderViaWhatsApp() {
    if (cart.length === 0) {
        alert("Tu carrito est√° vac√≠o.");
        return;
    }
    
    const phoneNumber = "5492944907380";
    
    let totalOriginal = 0;        // Precio sin descuentos
    let totalExacto = 0;          // Con descuentos, sin redondear
    let totalRedondeado = 0;      // Con descuentos y redondeo
    let totalAhorroDescuentos = 0;
    let orderLines = [];
    let ofertasCount = 0;

    cart.forEach(item => {
        const product = products.find(p => p.id === item.id);
        if (!product) return;
        
        // 1. Precio original (sin nada)
        const precioOriginalTotal = product.price * item.quantity;
        totalOriginal += precioOriginalTotal;
        
        // 2. Calcular precio exacto con descuentos (sin redondear)
        let precioExactoUnitario = product.price;
        
        // Aplicar descuentos
        if (item.ofertas2) {
            const porcentaje = parseInt(item.ofertas2);
            if (!isNaN(porcentaje)) {
                precioExactoUnitario = product.price * (1 - (porcentaje / 100));
            }
        } else if (item.ofertas1) {
            const ofertaNum = parseInt(item.ofertas1);
            if (!isNaN(ofertaNum) && ofertaNum >= 1 && ofertaNum <= 5) {
                const oferta = OFERTAS_SISTEMA[ofertaNum.toString()];
                if (oferta) {
                    let descuentoAplicar;
                    if (item.quantity >= oferta.descuentos.length) {
                        descuentoAplicar = oferta.descuentos[oferta.descuentos.length - 1];
                    } else if (item.quantity > 0) {
                        descuentoAplicar = oferta.descuentos[item.quantity - 1];
                    } else {
                        descuentoAplicar = 0;
                    }
                    precioExactoUnitario = product.price * (1 - descuentoAplicar);
                }
            }
        }
        
        const precioExactoTotal = precioExactoUnitario * item.quantity;
        totalExacto += precioExactoTotal;
        
        // 3. Redondear a favor del cliente (m√∫ltiplo de 50)
        const precioRedondeadoUnitario = Math.floor(precioExactoUnitario / 50) * 50;
        const precioRedondeadoTotal = precioRedondeadoUnitario * item.quantity;
        totalRedondeado += precioRedondeadoTotal;
        
        // Verificar si tuvo oferta
        if (precioExactoUnitario < product.price) {
            ofertasCount++;
            totalAhorroDescuentos += (product.price * item.quantity) - precioExactoTotal;
        }
        
        // L√≠nea del producto (igual que antes)
        const nombreUpper = product.name.toUpperCase();
        const tuvoOferta = precioExactoUnitario < product.price;
        let icono = tuvoOferta ? 'üî•' : '‚úÖ';
        
        let descripcion = `${icono} ${nombreUpper}\n`;
        descripcion += `   ${item.quantity} √ó $${precioRedondeadoUnitario} = $${precioRedondeadoTotal}`;
        
        orderLines.push(descripcion);
    });

    const ahorroPorRedondeo = totalExacto - totalRedondeado;
    const ahorroTotal = totalOriginal - totalRedondeado;
    const porcentajeTotal = Math.round((ahorroTotal / totalOriginal) * 100);
    
    // CONSTRUIR MENSAJE (MANTENIENDO TU ESTRUCTURA ORIGINAL)
    let message = `*üõí PEDIDO ALMAC√âN COPIHUE*\n`;
    message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
    message += `üì¶ *TU COMPRA:*\n\n`;
    
    orderLines.forEach(line => {
        message += line + '\n\n';
    });
    
    message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
    
    if (ofertasCount > 0) {
        message += `üéä *¬°GENIAL! APROVECHASTE ${ofertasCount} OFERTAS!*\n`;
    }
    
    message += `üõçÔ∏è  *Productos:* ${cart.length} items\n`;
    message += `üìä *Unidades:* ${cart.reduce((sum, item) => sum + item.quantity, 0)}\n\n`;
    
    if (ahorroTotal > 0) {
        message += `üí∞ *Precio original:* $${totalOriginal.toFixed(0)}\n`;
        message += `‚ö° *¬°AHORRASTE $${ahorroTotal.toFixed(0)}!*\n`;
        message += `üéØ *Eso es ${porcentajeTotal}% de descuento*\n\n`;
        
        if (ahorroPorRedondeo > 0) {
            // ‚úÖ AQU√ç EL AGREGADO DISCRETO
            message += `‚ú® *Incluye $${ahorroPorRedondeo.toFixed(0)} de redondeo a tu favor*\n\n`;
        }
        
        if (porcentajeTotal >= 30) {
            message += `üèÜ *¬°OFERT√ìN! M√°s del 30% de descuento*\n`;
        } else if (porcentajeTotal >= 20) {
            message += `‚ú® *¬°GRAN OFERTA! M√°s del 20% de descuento*\n`;
        }
    }
    
    message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
    message += `üíµ *TOTAL A PAGAR:* $${totalRedondeado.toFixed(0)}\n`;
    message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
    
    message += `üöÄ *¬°TU PEDIDO EST√Å LISTO!*\n\n`;
    
    message += `‚úÖ *Retiro r√°pido en 15-20 min*\n`;
    message += `‚úÖ *Productos frescos y de calidad*\n`;
    message += `‚úÖ *Atenci√≥n personalizada*\n`;
    message += `‚úÖ *Precios de barrio*\n\n`;
    
    message += `üìç *Direcci√≥n:* Copihue 457\n`;
    message += `‚è∞ *Horario:* 11:30 a 23:30 hs\n`;
    message += `üì± *Confirm√° por este WhatsApp*\n\n`;
    
    if (ahorroTotal > 0) {
        message += `üí° *¬øSab√≠as que ahorraste $${ahorroTotal.toFixed(0)}?\n`;
        message += `   ¬°Eso te alcanza para un caf√© extra! ‚òï*\n\n`;
    }
    
    message += `‚è≥ *Pedido listo en 15-20 minutos*\n`;
    message += `üéÅ *Gracias por elegir tu almac√©n de confianza*\n\n`;
    
    message += `#Almac√©nCopihue #PreciosDeBarrio #LaConfianzaDeSiempre`;
    
    const encodedMessage = encodeURIComponent(message);
    const whatsappURL = `https://wa.me/${phoneNumber}?text=${encodedMessage}`;
    window.open(whatsappURL, "_blank");

    closeCartModal();
    cart = [];
    updateCartCount();
}

        // ========== B√öSQUEDA ==========
        function normalizeSearchTerm(term) {
            let normalized = term.toLowerCase().trim();
            normalized = normalized.replace(/[^\w\s]/g, ' ');
            normalized = normalized.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            normalized = normalized.replace(/\s+/g, ' ');
            return normalized;
        }

        function expandSearchTerms(searchTerm) {
            const normalizedTerm = normalizeSearchTerm(searchTerm);
            const words = normalizedTerm.split(' ');
            const expandedTerms = new Set();
            
            expandedTerms.add(normalizedTerm);
            
            words.forEach(word => {
                if (word.length < 2) return;
                
                expandedTerms.add(word);
                
                for (const [key, synonyms] of Object.entries(SEARCH_DICTIONARY)) {
                    if (key === word) {
                        synonyms.forEach(synonym => expandedTerms.add(synonym));
                    }
                    
                    if (synonyms.includes(word)) {
                        expandedTerms.add(key);
                        synonyms.forEach(synonym => expandedTerms.add(synonym));
                    }
                }
            });
            
            if (words.length > 1) {
                expandedTerms.add(words.join(''));
                expandedTerms.add(words.join('-'));
                
                if (words.length === 2) {
                    expandedTerms.add(`${words[1]} ${words[0]}`);
                }
            }
            
            return Array.from(expandedTerms);
        }

        function searchProducts(searchTerm) {
            if (!products || products.length === 0) return [];
            if (searchTerm.length < 2) return [];
            
            const expandedTerms = expandSearchTerms(searchTerm);
            
            const results = products.filter(product => {
                const productName = normalizeSearchTerm(product.name);
                const hasStock = product.stock === "STOCK" || product.stockNumber > 0;
                
                if (!hasStock) return false;
                
                return expandedTerms.some(term => {
                    if (productName.includes(term) && term.length > 1) return true;
                    
                    if (term.length <= 3 && term.length > 1) {
                        const initials = productName.split(' ')
                            .map(word => word.charAt(0))
                            .join('');
                        if (initials.includes(term)) return true;
                    }
                    
                    if (term.length > 3) {
                        if (productName.includes(term.substring(0, Math.max(3, term.length - 1)))) {
                            return true;
                        }
                    }
                    
                    return false;
                });
            });
            
            results.sort((a, b) => {
                const nameA = normalizeSearchTerm(a.name);
                const nameB = normalizeSearchTerm(b.name);
                
                const exactMatchA = expandedTerms.some(term => nameA === term);
                const exactMatchB = expandedTerms.some(term => nameB === term);
                
                if (exactMatchA && !exactMatchB) return -1;
                if (!exactMatchA && exactMatchB) return 1;
                
                if (a.stockNumber !== b.stockNumber) {
                    return b.stockNumber - a.stockNumber;
                }
                
                if (a.hasPromo !== b.hasPromo) {
                    return b.hasPromo - a.hasPromo;
                }
                
                return 0;
            });
            
            return results;
        }

        // ========== CARGA DE PRODUCTOS ==========
        async function loadProductsFromSheets() {
            try {
                productsGrid.innerHTML = '<div class="loading">üîÑ Cargando productos...</div>';

                const PROXY_URL = 'https://corsproxy.io/?';
                const sheetNames = ['inventario', 'Inventario', 'Stock', 'stock'];
                let response = null;
                let csvText = '';

                for (let i = 0; i < sheetNames.length; i++) {
                    let sheet = sheetNames[i];
                    let SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheet)}&_cb=${Date.now()}`;
                    let URL_CON_PROXY = PROXY_URL + encodeURIComponent(SHEET_URL);
                    console.log('Intentando with sheet:', sheet, URL_CON_PROXY);

                    try {
                        response = await fetch(URL_CON_PROXY);
                        if (response && response.ok) {
                            csvText = await response.text();
                            if (csvText && csvText.trim() !== '') {
                                console.log('CSV obtenido desde hoja:', sheet);
                                break;
                            }
                        }
                    } catch (errFetch) {
                        console.warn('Error fetching sheet', sheet, errFetch);
                    }
                }

                if (!csvText || csvText.trim() === '') {
                    throw new Error('No se pudo obtener CSV v√°lido.');
                }

                processCSVData(csvText);
            } catch (error) {
                console.error('Error en loadProductsFromSheets:', error);
                loadBackupProducts();
            }
        }

        function processCSVData(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim() !== '');
            
            if (lines.length < 2) {
                throw new Error('No hay suficientes datos en el Sheets');
            }
            
            const headers = parseCSVLine(lines[0]);
            const stockColumnIndex = findStockColumn(headers);
            const ofertas1ColumnIndex = findColumnByName(headers, ['ofertas1', 'oferta1', 'oferta']);
            const ofertas2ColumnIndex = findColumnByName(headers, ['ofertas2', 'oferta2', 'porcentaje']);
            const priceColumnIndex = findPriceColumn(headers);
            
            products = lines.slice(1).map((line, index) => {
                const values = parseCSVLine(line);
                if (values.length < 2) return null;
                
                const nombreProducto = values[0] || '';
                const nombreImagen = simplificarNombre(nombreProducto) + '.jpg';
                
                let stock = "";
                let stockNumber = 0;
                
                if (stockColumnIndex !== -1 && values[stockColumnIndex] !== undefined) {
                    const stockValue = values[stockColumnIndex].toString().trim();
                    stockNumber = parseInt(stockValue) || 0;
                    
                    if (stockNumber > 10) {
                        stock = "STOCK";
                    } else if (stockNumber > 0 && stockNumber <= 10) {
                        stock = "STOCK BAJO";
                    } else {
                        stock = "SIN STOCK";
                    }
                }
                
                // Obtener valores de ofertas
                let ofertas1 = '';
                let ofertas2 = '';
                
                if (ofertas1ColumnIndex !== -1 && values[ofertas1ColumnIndex] !== undefined) {
                    ofertas1 = values[ofertas1ColumnIndex].toString().trim();
                }
                
                if (ofertas2ColumnIndex !== -1 && values[ofertas2ColumnIndex] !== undefined) {
                    ofertas2 = values[ofertas2ColumnIndex].toString().trim();
                }
                
                // Obtener precio
                let price = 0;
                if (priceColumnIndex !== -1 && values[priceColumnIndex] !== undefined) {
                    price = parseInt(values[priceColumnIndex]) || 0;
                } else if (values.length > 1) {
                    price = parseInt(values[1]) || 0;
                }
                
                // ‚úÖ CALCULAR PRECIO CON DESCUENTO (1 unidad) usando la nueva funci√≥n de redondeo
                const precioConDescuento = calcularPrecioConDescuento(price, ofertas1, ofertas2, 1);
                
                // ‚úÖ CALCULAR DESCUENTO REAL
                const descuentoReal = calcularDescuentoReal(price, precioConDescuento);
                
                // ‚úÖ TEXTO DE OFERTA: Solo mostrar "üî• OFERTA" sin porcentaje
                let textoOferta = '';
                if ((ofertas2 && ofertas2 !== '' && ofertas2 !== '0') || 
                    (ofertas1 && ofertas1 !== '' && ofertas1 !== '0')) {
                    textoOferta = 'üî• OFERTA';
                }
                
                // Obtener detalles de la oferta
                let ofertaDetalles = null;
                
                if (ofertas1 && ofertas1 !== '' && ofertas1 !== '0') {
                    const ofertaNum = parseInt(ofertas1);
                    if (!isNaN(ofertaNum) && ofertaNum >= 1 && ofertaNum <= 5) {
                        ofertaDetalles = OFERTAS_SISTEMA[ofertaNum.toString()];
                    }
                }
                
                // Calcular l√≠mites de ofertas2
                const limiteOfertas2 = obtenerLimiteOfertas2(ofertas2);
                const textoLimiteOfertas2 = obtenerTextoLimiteOfertas2(ofertas2, nombreProducto);
                
                return {
                    id: index + 1,
                    name: nombreProducto,
                    price: price,
                    category: values[2] || 'ALMACEN',
                    description: values[3] || '',
                    image: `imagenes-productos/${nombreImagen}`,
                    stock: stock,
                    stockNumber: stockNumber,
                    nombreArchivo: nombreImagen,
                    hasPromo: textoOferta !== '',
                    ofertas1: ofertas1,
                    ofertas2: ofertas2,
                    discountedPrice: precioConDescuento,
                    discountPercent: descuentoReal,
                    offerText: textoOferta,
                    ofertaDetalles: ofertaDetalles,
                    limiteOfertas2: limiteOfertas2,
                    textoLimiteOfertas2: textoLimiteOfertas2,
                    tipoVenta: obtenerTipoDeVenta(nombreProducto)
                };
            }).filter(product => product && product.name && product.name.trim() !== '');
            
            if (products.length === 0) {
                throw new Error('No se pudieron cargar productos v√°lidos');
            }
            
            renderCategories();
            mostrarOfertasDestacadas();
            renderProducts();
        }

        function findStockColumn(headers) {
            const stockKeywords = ['stock', 'inventario', 'cantidad', 'disponible', 'existencia'];
            
            for (let i = 0; i < headers.length; i++) {
                const header = headers[i].toLowerCase().trim();
                if (stockKeywords.some(keyword => header.includes(keyword))) {
                    return i;
                }
            }
            
            return headers.length > 4 ? 4 : -1;
        }

        function findColumnByName(headers, possibleNames) {
            for (let i = 0; i < headers.length; i++) {
                const header = headers[i].toLowerCase().trim();
                if (possibleNames.some(name => header.includes(name))) {
                    return i;
                }
            }
            return -1;
        }

        function findPriceColumn(headers) {
            const priceKeywords = ['precio', 'valor', 'costo', 'importe'];
            
            for (let i = 0; i < headers.length; i++) {
                const header = headers[i].toLowerCase().trim();
                if (priceKeywords.some(keyword => header.includes(keyword))) {
                    return i;
                }
            }
            
            return 1;
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current.trim());
            return result.map(field => field.replace(/^"|"$/g, ''));
        }

        function simplificarNombre(nombre) {
            return nombre
                .toLowerCase()
                .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
                .replace(/[^a-z0-9 ]/g, "")
                .replace(/\s+/g, '-')
                .replace(/-+/g, '-')
                .trim();
        }

        function loadBackupProducts() {
            // Crear productos de ejemplo con el sistema corregido
            const precioEjemplo = 1600;
            const precioConDesc = calcularPrecioConDescuento(precioEjemplo, "1", "", 1);
            const descuentoReal = calcularDescuentoReal(precioEjemplo, precioConDesc);
            
            // Ejemplos de diferentes tipos de venta
            products = [
                { 
                    id: 1, 
                    name: "TOMATE REDONDO KG", 
                    price: 5000,
                    category: "FRUTAS Y VERDURAS", 
                    stock: "STOCK", 
                    stockNumber: 10,
                    image: "imagenes-productos/tomate-rojo.jpg",
                    hasPromo: true,
                    ofertas1: "",
                    ofertas2: "60",
                    discountedPrice: calcularPrecioConDescuento(5000, "", "60", 1),
                    discountPercent: 60,
                    offerText: "üî• OFERTA",
                    ofertaDetalles: null,
                    limiteOfertas2: 5,
                    textoLimiteOfertas2: obtenerTextoLimiteOfertas2("60", "TOMATE REDONDO KG"),
                    tipoVenta: obtenerTipoDeVenta("TOMATE REDONDO KG")
                },
                { 
                    id: 2, 
                    name: "DURAZNOS x UNIDAD", 
                    price: 350,
                    category: "FRUTAS Y VERDURAS", 
                    stock: "STOCK", 
                    stockNumber: 50,
                    image: "imagenes-productos/duraznos.jpg",
                    hasPromo: true,
                    ofertas1: "",
                    ofertas2: "30",
                    discountedPrice: calcularPrecioConDescuento(350, "", "30", 1),
                    discountPercent: 30,
                    offerText: "üî• OFERTA",
                    ofertaDetalles: null,
                    limiteOfertas2: 10,
                    textoLimiteOfertas2: obtenerTextoLimiteOfertas2("30", "DURAZNOS x UNIDAD"),
                    tipoVenta: obtenerTipoDeVenta("DURAZNOS x UNIDAD")
                },
                { 
                    id: 3, 
                    name: "JENGIBRE 100GR", 
                    price: 1200,
                    category: "FRUTAS Y VERDURAS", 
                    stock: "STOCK BAJO", 
                    stockNumber: 2,
                    image: "imagenes-productos/jengibre.jpg",
                    hasPromo: true,
                    ofertas1: "",
                    ofertas2: "40",
                    discountedPrice: calcularPrecioConDescuento(1200, "", "40", 1),
                    discountPercent: 40,
                    offerText: "üî• OFERTA",
                    ofertaDetalles: null,
                    limiteOfertas2: 3,
                    textoLimiteOfertas2: obtenerTextoLimiteOfertas2("40", "JENGIBRE 100GR"),
                    tipoVenta: obtenerTipoDeVenta("JENGIBRE 100GR")
                },
                { 
                    id: 4, 
                    name: "LECHUGA BANDEJA",
                    price: 1800,
                    category: "FRUTAS Y VERDURAS",
                    stock: "STOCK",
                    stockNumber: 8,
                    image: "imagenes-productos/lechuga.jpg",
                    hasPromo: true,
                    ofertas1: "",
                    ofertas2: "25",
                    discountedPrice: calcularPrecioConDescuento(1800, "", "25", 1),
                    discountPercent: 25,
                    offerText: "üî• OFERTA",
                    ofertaDetalles: null,
                    limiteOfertas2: 5,
                    textoLimiteOfertas2: obtenerTextoLimiteOfertas2("25", "LECHUGA BANDEJA"),
                    tipoVenta: obtenerTipoDeVenta("LECHUGA BANDEJA")
                },
                { 
                    id: 5, 
                    name: "ZANAHORIAS SUELTAS", 
                    price: 800,
                    category: "FRUTAS Y VERDURAS", 
                    stock: "STOCK", 
                    stockNumber: 25,
                    image: "imagenes-productos/zanahoria.jpg",
                    hasPromo: false,
                    ofertas1: "",
                    ofertas2: "",
                    discountedPrice: 800,
                    discountPercent: 0,
                    offerText: "",
                    ofertaDetalles: null,
                    limiteOfertas2: null,
                    textoLimiteOfertas2: "",
                    tipoVenta: obtenerTipoDeVenta("ZANAHORIAS SUELTAS")
                },
                { 
                    id: 6, 
                    name: "MANZANAS ROJAS", 
                    price: 3200,
                    category: "FRUTAS Y VERDURAS", 
                    stock: "STOCK", 
                    stockNumber: 15,
                    image: "imagenes-productos/manzana.jpg",
                    hasPromo: true,
                    ofertas1: "2",
                    ofertas2: "",
                    discountedPrice: calcularPrecioConDescuento(3200, "2", "", 1),
                    discountPercent: calcularDescuentoReal(3200, calcularPrecioConDescuento(3200, "2", "", 1)),
                    offerText: "üî• OFERTA",
                    ofertaDetalles: OFERTAS_SISTEMA["2"],
                    limiteOfertas2: null,
                    textoLimiteOfertas2: "",
                    tipoVenta: obtenerTipoDeVenta("MANZANAS ROJAS")
                }
            ];
            
            // Convertir productos demo a CSV simulado y procesar
            const demoCSV = convertDemoProductsToCSV(products);
            processCSVData(demoCSV);
            
            productsGrid.innerHTML = `
                <div class="demo-notification" style="background: #e3f2fd; padding: 1rem; border-radius: 10px; margin-bottom: 1rem; text-align: center; border-left: 4px solid #2196f3;">
                    <strong>üîß Modo Demo Activado</strong>
                    <br>
                    <small>Usando datos de ejemplo de frutas y verduras con sistema de detecci√≥n de tipo de venta.</small>
                    <br>
                    <small><strong>üéØ SISTEMA DE TIPO DE VENTA ACTIVADO:</strong></small><br>
                    <small>‚úÖ "TOMATE REDONDO KG" ‚Üí ‚öñÔ∏è M√°x. 5 KILOS por familia</small><br>
                    <small>‚úÖ "DURAZNOS x UNIDAD" ‚Üí üì¶ M√°x. 10 UNIDADES por familia</small><br>
                    <small>‚úÖ "JENGIBRE 100GR" ‚Üí ‚öñÔ∏è M√°x. 3000 GRAMOS por familia</small><br>
                    <small>‚úÖ "LECHUGA BANDEJA" ‚Üí üéÅ M√°x. 5 PAQUETES por familia</small><br>
                    <small>‚úÖ Stock muestra icono y unidad espec√≠fica</small>
                </div>
                ${productsGrid.innerHTML}
            `;
        }

        function convertDemoProductsToCSV(demoProducts) {
            // Convertir array de productos a formato CSV
            let csv = 'Producto,Precio,Categoria,Stock,Ofertas1,Ofertas2\n';
            demoProducts.forEach(p => {
                csv += `"${p.name}",${p.price},"${p.category}",${p.stockNumber},"${p.ofertas1}","${p.ofertas2}"\n`;
            });
            return csv;
        }

        // ========== OFERTAS DESTACADAS ==========
function mostrarOfertasDestacadas() {
    if (!products || products.length === 0) return;
    
    // Obtener productos con oferta y stock
    const productosConOferta = products.filter(p => 
        p.hasPromo && (p.stock === "STOCK" || p.stockNumber > 0)
    );
    
    // ‚úÖ NUEVO: Ordenar con PRIORIDAD para ofertas2
    const ofertasOrdenadas = productosConOferta.sort((a, b) => {
        // PRIORIDAD 1: Productos con ofertas2 (descuento fijo directo)
        const aTieneOferta2 = a.ofertas2 && a.ofertas2 !== '' && a.ofertas2 !== '0';
        const bTieneOferta2 = b.ofertas2 && b.ofertas2 !== '' && b.ofertas2 !== '0';
        
        if (aTieneOferta2 && !bTieneOferta2) return -1; // a primero
        if (!aTieneOferta2 && bTieneOferta2) return 1;  // b primero
        
        // Si ambos tienen ofertas2, ordenar por mayor porcentaje
        if (aTieneOferta2 && bTieneOferta2) {
            const porcentajeA = parseInt(a.ofertas2) || 0;
            const porcentajeB = parseInt(b.ofertas2) || 0;
            return porcentajeB - porcentajeA; // Mayor porcentaje primero
        }
        
        // Si ambos tienen ofertas1 (o ninguno tiene ofertas2), ordenar por descuento real
        return b.discountPercent - a.discountPercent;
    }).slice(0, 8); // Limitar a 8 productos
    
    if (ofertasOrdenadas.length > 0) {
        featuredOffers.style.display = 'block';
        
        // Renderizar m√°ximo 4 productos destacados
        const productosDestacados = ofertasOrdenadas.slice(0, 4);
        featuredProductsGrid.innerHTML = renderProductsToHTML(productosDestacados);
        
        // Actualizar texto del bot√≥n
        viewAllOffers.textContent = `Ver todas las ofertas (${productosConOferta.length})`;
    } else {
        featuredOffers.style.display = 'none';
    }
}

        function renderProductsToHTML(productsArray) {
            return productsArray.map(product => {
                const hasStock = product.stock === "STOCK" || product.stockNumber > 0;
                const isLowStock = product.stockNumber > 0 && product.stockNumber <= 3;
                const isOutOfStock = product.stockNumber === 0;
                
                // USAR LA NUEVA FUNCI√ìN DE STOCK
                const stockText = obtenerTextoStock(product);
                
                // Determinar clase seg√∫n stock
                let stockClass = '';
                if (product.stockNumber === 0) {
                    stockClass = 'out-of-stock';
                } else if (product.stockNumber > 0 && product.stockNumber <= 3) {
                    stockClass = 'low-stock';
                } else {
                    stockClass = 'in-stock';
                }
                
                const addButton = isOutOfStock 
                    ? `<button class="add-to-cart" disabled>‚ùå Sin Stock</button>`
                    : `<button class="add-to-cart" data-id="${product.id}">üõí Agregar al Carrito</button>`;
                
                // ‚úÖ USAR offerText que ahora muestra "üî• OFERTA"
                const offerBadge = product.offerText 
                    ? `<div class="offer-badge">${product.offerText}</div>`
                    : '';
                
                // ‚úÖ USAR LA FUNCI√ìN CORREGIDA PARA DESCRIPCI√ìN
                const descripcionOferta = obtenerDescripcionOferta(
                    product.ofertas1, 
                    product.ofertas2,
                    product.price
                );
                
                const limiteOferta1 = product.ofertaDetalles ? product.ofertaDetalles.maxUnidades : null;
                const tieneLimiteOferta2 = product.textoLimiteOfertas2 !== '';
                
                return `
                    <div class="product-card">
                        ${offerBadge}
                        <div class="product-image">
                            <img src="${product.image}" 
                                 alt="${product.name}"
                                 onerror="handleImageError(this, '${product.name.replace(/'/g, "\\'")}')">
                        </div>
                        <div class="product-info">
                            <div class="product-name">${product.name}</div>
                            ${descripcionOferta ? `<div class="offer-description">${descripcionOferta}</div>` : ''}
                            <div class="product-price-container">
                                ${product.discountedPrice < product.price ? 
                                    `<span class="original-price">$${product.price}</span>` : ''}
                                <span class="product-price">$${product.discountedPrice}</span>
                                ${product.offerText ? 
                                    `<span class="discount-percent">${product.offerText}</span>` : ''}
                            </div>
                            <!-- MOSTRAR L√çMITES ESPEC√çFICOS -->
                            ${product.textoLimiteOfertas2 ? `
                                <div class="promo-limit" style="color: #ff6f00; font-weight: 500;">
                                    ${product.textoLimiteOfertas2}
                                </div>
                            ` : ''}
                            ${product.ofertaDetalles && product.ofertaDetalles.maxUnidades !== null ? `
                                <div class="promo-limit">
                                    ‚ö†Ô∏è M√°x. ${product.ofertaDetalles.maxUnidades} unidades por grupo familiar
                                </div>
                            ` : ''}
                            <!-- STOCK CON TIPO ESPEC√çFICO -->
                            <div class="product-stock ${stockClass}">
                                ${stockText}
                            </div>
                            ${addButton}
                        </div>
                    </div>
                `;
            }).join("");
        }

        function verTodasLasOfertas() {
            // Cambiar a categor√≠a OFERTAS
            currentCategory = "OFERTAS";
            document.querySelectorAll(".category-btn").forEach(b => b.classList.remove("active"));
            const ofertasBtn = document.querySelector('[data-category="OFERTAS"]');
            if (ofertasBtn) {
                ofertasBtn.classList.add("active");
            }
            renderProducts();
            
            // Scroll suave a la secci√≥n de productos
            document.querySelector('.products-grid').scrollIntoView({ behavior: 'smooth' });
        }

        // ========== MENSAJES TEMPORADA ==========
        function obtenerMensajeEstacional() {
            const hoy = new Date();
            const mes = hoy.getMonth() + 1;
            const dia = hoy.getDate();

            if (mes === 1 && dia <= 5) return "¬°Feliz A√±o Nuevo! üéâ Gracias por comprar con nosotros.";
            if (mes === 1) return "Arrancando el a√±o con toda la energ√≠a üí™.";
            if (mes === 4 && dia <= 10) return "¬°Felices Pascuas! üê£ Gracias por elegirnos.";
            if (mes === 5 && dia === 25) return "¬°Feliz 25 de Mayo! üá¶üá∑.";
            if (mes === 6 && dia >= 10 && dia <= 20) return "¬°Feliz D√≠a del Padre! ‚ù§Ô∏è.";
            if (mes === 7) return "Vacaciones de invierno ‚ùÑÔ∏è ¬°Abrigate bien!";
            if (mes === 8 && dia >= 10 && dia <= 25) return "¬°Feliz D√≠a de las Infancias! üéà.";
            if (mes === 9 && dia >= 21 && dia <= 25) return "¬°Feliz Primavera! üå∏.";
            if (mes === 10 && dia >= 10 && dia <= 20) return "¬°Feliz D√≠a de la Madre! üíê.";
            if (mes === 12 && dia >= 1 && dia <= 24) return "¬°Se viene Navidad! üéÑ Gracias por elegirnos.";
            if (mes === 12 && dia === 25) return "¬°Feliz Navidad! üéÑ.";
            if (mes === 12 && dia >= 26) return "Cerrando el a√±o üéÜ ¬°Gracias por estar con nosotros!";

            return "Gracias por elegirnos üôå.";
        }

        // ========== INTERFAZ ==========
        function init() {
            detectarAdmin();
            loadProductsFromSheets();
            setupEventListeners();
            setupSearch();
            updateCartCount();
            initPWA();
        }

        function detectarAdmin() {
            const urlParams = new URLSearchParams(window.location.search);
            esAdmin = urlParams.has('admin');
            
            if (esAdmin) {
                adminBadge.style.display = 'inline-block';
                adminNotification.style.display = 'block';
            }
        }

        function setupEventListeners() {
            cartIcon.addEventListener("click", openCart);
            floatingCart.addEventListener("click", openCart);
            floatingSearch.addEventListener("click", openSearchModal);
            closeSearch.addEventListener("click", closeSearchModal);
            closeCart.addEventListener("click", closeCartModal);
            sendOrder.addEventListener("click", sendOrderViaWhatsApp);
            viewAllOffers.addEventListener("click", verTodasLasOfertas);
            
            clearSearchBtn.addEventListener("click", clearSearch);
            clearMobileSearchBtn.addEventListener("click", clearMobileSearch);
            
            cartModal.addEventListener("click", function(e) {
                if (e.target === cartModal) {
                    closeCartModal();
                }
            });
            
            searchModal.addEventListener("click", function(e) {
                if (e.target === searchModal) {
                    closeSearchModal();
                }
            });
        }

        function setupSearch() {
            productSearch.addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase().trim();
                toggleClearButton(clearSearchBtn, searchTerm);
                
                if (searchTerm === '') {
                    clearSearch();
                    return;
                }
                
                if (searchTerm.length >= 2) {
                    filterProducts(searchTerm);
                }
            });
            
            productSearch.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const searchTerm = this.value.trim();
                    if (searchTerm.length >= 2) {
                        filterProducts(searchTerm);
                    }
                }
            });
            
            mobileSearch.addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase().trim();
                toggleClearButton(clearMobileSearchBtn, searchTerm);
                
                if (searchTerm === '') {
                    mobileSearchResults.innerHTML = '';
                    return;
                }
                
                if (searchTerm.length >= 2) {
                    filterMobileProducts(searchTerm);
                }
            });
        }

        function toggleClearButton(button, searchTerm) {
            button.style.display = searchTerm.length > 0 ? 'block' : 'none';
        }

        function openSearchModal() {
            searchModal.style.display = "flex";
            mobileSearch.focus();
            mobileSearchResults.innerHTML = '';
        }

        function closeSearchModal() {
            searchModal.style.display = "none";
            mobileSearch.value = '';
            mobileSearchResults.innerHTML = '';
            clearMobileSearchBtn.style.display = 'none';
        }

        function clearMobileSearch() {
            mobileSearch.value = '';
            mobileSearchResults.innerHTML = '';
            clearMobileSearchBtn.style.display = 'none';
        }

        function filterProducts(searchTerm) {
            if (!products || products.length === 0) return;
            
            isSearching = true;
            const filtered = searchProducts(searchTerm);
            renderFilteredProducts(filtered, searchTerm);
        }

        function filterMobileProducts(searchTerm) {
            if (!products || products.length === 0) return;
            
            const filtered = searchProducts(searchTerm);
            
            if (filtered.length === 0) {
                mobileSearchResults.innerHTML = `
                    <div style="text-align: center; padding: 1rem; color: #666;">
                        üîç No se encontraron productos para "<strong>${searchTerm}</strong>"
                    </div>
                `;
                return;
            }
            
            let resultsHTML = '<div style="display: grid; gap: 1rem;">';
            
            filtered.forEach(product => {
                // USAR LA NUEVA FUNCI√ìN DE STOCK
                const stockText = obtenerTextoStock(product);
                
                // Determinar clase seg√∫n stock
                let stockClass = '';
                if (product.stockNumber === 0) {
                    stockClass = 'out-of-stock';
                } else if (product.stockNumber > 0 && product.stockNumber <= 3) {
                    stockClass = 'low-stock';
                } else {
                    stockClass = 'in-stock';
                }
                
                const addButton = product.stockNumber === 0
                    ? `<button class="add-to-cart" disabled>‚ùå Sin Stock</button>`
                    : `<button class="add-to-cart" data-id="${product.id}">üõí Agregar al Carrito</button>`;
                
                const offerBadge = product.hasPromo && product.offerText 
                    ? `<div class="offer-badge">${product.offerText}</div>`
                    : '';
                
                const descripcionOferta = obtenerDescripcionOferta(product.ofertas1, product.ofertas2, product.price);
                
                resultsHTML += `
                    <div class="product-card" style="margin: 0;">
                        ${offerBadge}
                        <div class="product-image">
                            <img src="${product.image}" 
                                 alt="${product.name}"
                                 onerror="handleImageError(this, '${product.name.replace(/'/g, "\\'")}')">
                        </div>
                        <div class="product-info">
                            <div class="product-name">${product.name}</div>
                            ${descripcionOferta ? `<div class="offer-description">${descripcionOferta}</div>` : ''}
                            <div class="product-price-container">
                                ${product.hasPromo && product.discountedPrice < product.price ? 
                                    `<span class="original-price">$${product.price}</span>` : ''}
                                <span class="product-price">$${product.discountedPrice}</span>
                                ${product.hasPromo && product.discountPercent > 0 ? 
                                    `<span class="discount-percent">${product.offerText}</span>` : ''}
                            </div>
                            ${product.textoLimiteOfertas2 ? `
                                <div class="promo-limit" style="color: #ff6f00; font-weight: 500;">
                                    ${product.textoLimiteOfertas2}
                                </div>
                            ` : ''}
                            ${product.ofertaDetalles && product.ofertaDetalles.maxUnidades !== null ? `
                                <div class="promo-limit">
                                    ‚ö†Ô∏è M√°x. ${product.ofertaDetalles.maxUnidades} unidades por grupo familiar
                                </div>
                            ` : ''}
                            <div class="product-stock ${stockClass}">
                                ${stockText}
                            </div>
                            ${addButton}
                        </div>
                    </div>
                `;
            });
            
            resultsHTML += '</div>';
            mobileSearchResults.innerHTML = resultsHTML;
            
            setTimeout(() => {
                addCartEventListeners();
            }, 100);
        }

        function renderFilteredProducts(filteredProducts, searchTerm) {
            if (filteredProducts.length === 0) {
                productsGrid.innerHTML = `
                    <div class="loading" style="text-align: center; padding: 2rem;">
                        üîç No se encontraron productos para "<strong>${searchTerm}</strong>"
                        <br><br>
                        <button onclick="clearSearch()" class="retry-btn">
                            ‚ú® Ver todos los productos
                        </button>
                    </div>
                `;
                return;
            }
            
            renderProductsFromArray(filteredProducts, searchTerm);
        }

        function clearSearch() {
            productSearch.value = '';
            mobileSearch.value = '';
            isSearching = false;
            clearSearchBtn.style.display = 'none';
            clearMobileSearchBtn.style.display = 'none';
            renderProducts();
            currentCategory = "TODOS";
            
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-category') === 'TODOS') {
                    btn.classList.add('active');
                }
            });
        }

        function renderCategories() {
            const categories = [...new Set(products.map(p => p.category))];
            
            // Agregar categor√≠a "OFERTAS" al inicio
            categories.unshift("OFERTAS");
            // Agregar categor√≠a "TODOS" al inicio
            categories.unshift("TODOS");
            
            // Contar ofertas por categor√≠a (excepto TODOS y OFERTAS)
            const ofertasPorCategoria = {};
            products.forEach(p => {
                if (p.hasPromo && (p.stock === "STOCK" || p.stockNumber > 0)) {
                    ofertasPorCategoria[p.category] = (ofertasPorCategoria[p.category] || 0) + 1;
                }
            });
            
            // Contar ofertas totales para categor√≠a OFERTAS
            const totalOfertas = Object.values(ofertasPorCategoria).reduce((sum, count) => sum + count, 0);
            
            categoriesContainer.innerHTML = categories.map(category => {
                let badge = '';
                
                if (category === "OFERTAS" && totalOfertas > 0) {
                    badge = `<span class="offer-count-badge">${totalOfertas}üî•</span>`;
                } else if (category !== "TODOS" && category !== "OFERTAS" && ofertasPorCategoria[category]) {
                    badge = `<span class="offer-count-badge">${ofertasPorCategoria[category]}üî•</span>`;
                }
                
                return `
                    <button class="category-btn ${category === currentCategory ? 'active' : ''}" 
                            data-category="${category}">
                        ${category} ${badge}
                    </button>
                `;
            }).join("");
            
            if (categories.length > 0 && currentCategory === "TODOS") {
                currentCategory = "TODOS";
                const todosBtn = document.querySelector('[data-category="TODOS"]');
                if (todosBtn) {
                    todosBtn.classList.add('active');
                }
            }
            
            document.querySelectorAll(".category-btn").forEach(btn => {
                btn.addEventListener("click", function() {
                    currentCategory = this.getAttribute("data-category");
                    document.querySelectorAll(".category-btn").forEach(b => b.classList.remove("active"));
                    this.classList.add("active");
                    renderProducts();
                });
            });
        }

        function renderProducts() {
            let filteredProducts;
            
            if (currentCategory === "TODOS") {
                // Mostrar TODOS los productos con stock
                filteredProducts = products.filter(p => 
                    p.stock === "STOCK" || p.stockNumber > 0
                );
            } else if (currentCategory === "OFERTAS") {
                // Mostrar SOLO productos con oferta
                filteredProducts = products.filter(p => 
                    (p.stock === "STOCK" || p.stockNumber > 0) && 
                    (p.hasPromo === true)
                );
            } else {
                // Mostrar productos de categor√≠a normal
                filteredProducts = products.filter(p => 
                    p.category === currentCategory && 
                    (p.stock === "STOCK" || p.stockNumber > 0)
                );
            }
            
            // Ordenar: primero productos con oferta, luego sin oferta
            filteredProducts.sort((a, b) => {
                if (a.hasPromo && !b.hasPromo) return -1;
                if (!a.hasPromo && b.hasPromo) return 1;
                return 0;
            });
            
            renderProductsFromArray(filteredProducts);
        }

        function renderProductsFromArray(productsArray, searchTerm = '') {
            const productsToShow = productsArray;
            
            if (productsToShow.length === 0) {
                let mensaje = '';
                if (currentCategory === "OFERTAS") {
                    mensaje = '<div class="loading">No hay ofertas disponibles en este momento</div>';
                } else {
                    mensaje = '<div class="loading">No hay productos disponibles</div>';
                }
                productsGrid.innerHTML = mensaje;
                return;
            }
            
            productsGrid.innerHTML = renderProductsToHTML(productsToShow);
            
            setTimeout(() => {
                addCartEventListeners();
            }, 100);
            
            if (searchTerm) {
                const searchHeader = `
                    <div class="search-results">
                        <strong>üîç B√∫squeda inteligente: "${searchTerm}"</strong>
                        <br>
                        <small>Encontraste ${productsToShow.length} producto(s)</small>
                        <button onclick="clearSearch()" style="margin-left: 10px; padding: 6px 12px; 
                                background: #ff6f00; color: white; border: none; border-radius: 15px; 
                                cursor: pointer; font-size: 0.8rem;">
                            ‚úñÔ∏è Limpiar b√∫squeda
                        </button>
                    </div>
                `;
                productsGrid.innerHTML = searchHeader + productsGrid.innerHTML;
            }
        }

        function addCartEventListeners() {
            document.querySelectorAll(".add-to-cart").forEach(btn => {
                btn.replaceWith(btn.cloneNode(true));
            });
            
            document.querySelectorAll(".add-to-cart").forEach(btn => {
                btn.addEventListener("click", function() {
                    const productId = parseInt(this.getAttribute("data-id"));
                    addToCart(productId);
                });
            });
        }

        function addToCart(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            const availableStock = product.stockNumber;
            const existingItem = cart.find(item => item.id === productId);
            const currentQuantityInCart = existingItem ? existingItem.quantity : 0;
            
            if (currentQuantityInCart >= availableStock) {
                showStockError(product.name, availableStock);
                return;
            }
            
            // VERIFICAR L√çMITE DE OFERTAS1
            if (product.ofertaDetalles && product.ofertaDetalles.maxUnidades !== null) {
                const newQuantity = currentQuantityInCart + 1;
                if (newQuantity > product.ofertaDetalles.maxUnidades) {
                    showLimitError(product.name, product.ofertaDetalles.maxUnidades, product.ofertaDetalles.nombre);
                    return;
                }
            }
            
            // VERIFICAR L√çMITE DE OFERTAS2
            if (product.ofertas2) {
                const limiteOferta2 = obtenerLimiteOfertas2(product.ofertas2);
                if (limiteOferta2 !== null) {
                    const newQuantity = currentQuantityInCart + 1;
                    if (newQuantity > limiteOferta2) {
                        showLimitError(product.name, limiteOferta2, `${product.ofertas2}% OFF`);
                        return;
                    }
                }
            }
            
            if (existingItem) {
                existingItem.quantity += 1;
                existingItem.price = calcularPrecioConDescuento(
                    product.price, 
                    product.ofertas1, 
                    product.ofertas2, 
                    existingItem.quantity
                );
            } else {
                const initialPrice = calcularPrecioConDescuento(
                    product.price, 
                    product.ofertas1, 
                    product.ofertas2, 
                    1
                );
                
                const initialDiscount = calcularDescuentoReal(product.price, initialPrice);
                
                cart.push({
                    id: product.id,
                    name: product.name,
                    price: initialPrice,
                    originalPrice: product.price,
                    hasPromo: product.hasPromo,
                    ofertas1: product.ofertas1,
                    ofertas2: product.ofertas2,
                    ofertaDetalles: product.ofertaDetalles,
                    quantity: 1,
                    maxStock: availableStock,
                    maxOfertaLimit: product.ofertaDetalles ? product.ofertaDetalles.maxUnidades : null,
                    maxOferta2Limit: obtenerLimiteOfertas2(product.ofertas2)
                });
                
                if (initialDiscount > 0) {
                    showAddToCartFeedback(product.name, initialDiscount);
                } else {
                    showAddToCartFeedback(product.name);
                }
            }
            
            updateCartCount();
        }

        function showAddToCartFeedback(productName, discount = 0) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 100px;
                left: 50%;
                transform: translateX(-50%);
                background: var(--primary);
                color: white;
                padding: 12px 20px;
                border-radius: 25px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                z-index: 1002;
                font-weight: 500;
                animation: slideDown 0.3s ease;
            `;
            
            if (discount > 0) {
                notification.innerHTML = `‚úÖ ${productName} agregado (üî• OFERTA)`;
            } else {
                notification.innerHTML = `‚úÖ ${productName} agregado al carrito`;
            }
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 2000);
        }

        function showStockError(productName, availableStock) {
            const notification = document.createElement('div');
            notification.className = 'stock-notification';
            notification.innerHTML = `‚ùå No hay suficiente stock de ${productName}. M√°ximo: ${availableStock} unidades`;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function updateCartCount() {
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            cartCount.textContent = totalItems;
            floatingCartCount.textContent = totalItems;
        }

        function openCart() {
            renderCartItems();
            cartModal.style.display = "flex";
        }

        function closeCartModal() {
            cartModal.style.display = "none";
        }

        function renderCartItems() {
            if (cart.length === 0) {
                cartItems.innerHTML = "<p style='text-align: center; padding: 2rem; color: #666;'>Tu carrito est√° vac√≠o</p>";
                cartTotal.textContent = "Total: $0";
                
                // Limpiar mensajes de ahorro si existen
                const existingSavings = document.querySelector('.total-savings');
                if (existingSavings) existingSavings.remove();
                
                // Limpiar total original si existe
                const existingOriginal = document.querySelector('.original-total');
                if (existingOriginal) existingOriginal.remove();
                
                return;
            }
            
            let totalNormalPrice = 0;
            let totalWithPromos = 0;
            let totalSavings = 0;
            let cartItemsHTML = '';
            
            // Limpiar cualquier mensaje de ahorro anterior
            const existingSavings = document.querySelector('.total-savings');
            if (existingSavings) existingSavings.remove();
            
            // Limpiar total original anterior
            const existingOriginal = document.querySelector('.original-total');
            if (existingOriginal) existingOriginal.remove();
            
            cart.forEach(item => {
                const product = products.find(p => p.id === item.id);
                if (!product) return;
                
                const itemNormalPrice = product.price * item.quantity;
                const itemFinalPrice = item.price * item.quantity;
                const itemSavings = itemNormalPrice - itemFinalPrice;
                
                totalNormalPrice += itemNormalPrice;
                totalWithPromos += itemFinalPrice;
                totalSavings += itemSavings;
                
                // ‚úÖ CALCULAR DESCUENTO REAL (pero solo mostrar si es > 0)
                const discountPercent = calcularDescuentoReal(product.price, item.price);
                
                cartItemsHTML += `
                    <div class="cart-item">
                        <div class="cart-item-info">
                            <div class="cart-item-name">${item.name}</div>
                            <div class="cart-item-price">
                                ${item.price < product.price 
                                    ? `<span style="text-decoration: line-through; color: #666; margin-right: 5px;">$${product.price}</span>` 
                                    : ''}
                                $${item.price} c/u
                                ${discountPercent > 0 
                                    ? `<span style="background: #4CAF50; color: white; padding: 2px 6px; border-radius: 8px; font-size: 0.75rem; margin-left: 5px; font-weight: bold;">üî• OFERTA</span>` 
                                    : ''}
                            </div>
                        </div>
                        <div class="cart-item-quantity">
                            <button class="quantity-btn decrease-btn" data-id="${item.id}">-</button>
                            <span class="quantity-value">${item.quantity}</span>
                            <button class="quantity-btn increase-btn" data-id="${item.id}">+</button>
                        </div>
                    </div>
                `;
            });
            
            cartItems.innerHTML = cartItemsHTML;
            cartTotal.textContent = `TOTAL A PAGAR: $${totalWithPromos.toFixed(0)}`;
            
            // ‚úÖ MOSTRAR AHORRO TOTAL SOLO UNA VEZ
            if (totalSavings > 0) {
                // AGREGAR TOTAL ORIGINAL TACHADO
                const originalTotalElement = document.createElement('div');
                originalTotalElement.className = 'original-total';
                originalTotalElement.style.cssText = `
                    text-align: right;
                    color: #666;
                    font-size: 0.9rem;
                    margin-bottom: 0.5rem;
                    text-decoration: line-through;
                `;
                originalTotalElement.textContent = `(~~$${totalNormalPrice.toFixed(0)}~~ sin oferta)`;
                cartTotal.parentNode.insertBefore(originalTotalElement, cartTotal);
                
                const savingsElement = document.createElement('div');
                savingsElement.className = 'total-savings';
                const percentSavings = Math.round((totalSavings / totalNormalPrice) * 100);
                savingsElement.textContent = `üéâ ¬°Ahorraste $${totalSavings.toFixed(0)}!`;
                cartTotal.parentNode.insertBefore(savingsElement, cartTotal);
            }
            
            // ‚úÖ AGREGAR EVENT LISTENERS NUEVOS (evitar duplicados)
            document.querySelectorAll('.increase-btn').forEach(btn => {
                btn.replaceWith(btn.cloneNode(true));
            });
            
            document.querySelectorAll('.decrease-btn').forEach(btn => {
                btn.replaceWith(btn.cloneNode(true));
            });
            
            document.querySelectorAll('.increase-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const productId = parseInt(this.getAttribute('data-id'));
                    updateCartQuantity(productId, 1);
                });
            });
            
            document.querySelectorAll('.decrease-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const productId = parseInt(this.getAttribute('data-id'));
                    updateCartQuantity(productId, -1);
                });
            });
        }

        function updateCartQuantity(productId, change) {
            const itemIndex = cart.findIndex(item => item.id === productId);
            if (itemIndex === -1) return;
            
            const item = cart[itemIndex];
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            const newQuantity = item.quantity + change;
            
            if (newQuantity < 1) {
                cart.splice(itemIndex, 1);
                updateCartCount();
                renderCartItems();
                return;
            }
            
            // VERIFICAR STOCK M√ÅXIMO
            if (newQuantity > product.stockNumber) {
                showStockError(product.name, product.stockNumber);
                return;
            }
            
            // VERIFICAR L√çMITE OFERTAS1
            if (product.ofertaDetalles && product.ofertaDetalles.maxUnidades !== null) {
                if (newQuantity > product.ofertaDetalles.maxUnidades) {
                    showLimitError(product.name, product.ofertaDetalles.maxUnidades, product.ofertaDetalles.nombre);
                    return;
                }
            }
            
            // VERIFICAR L√çMITE OFERTAS2
            if (product.ofertas2) {
                const limiteOferta2 = obtenerLimiteOfertas2(product.ofertas2);
                if (limiteOferta2 !== null && newQuantity > limiteOferta2) {
                    showLimitError(product.name, limiteOferta2, `${product.ofertas2}% OFF`);
                    return;
                }
            }
            
            item.quantity = newQuantity;
            item.price = calcularPrecioConDescuento(
                product.price, 
                product.ofertas1, 
                product.ofertas2, 
                newQuantity
            );
            
            updateCartCount();
            renderCartItems();
        }

        // ========== FUNCIONES DE IMAGEN ==========
        function handleImageError(img, productName) {
            console.warn('Error cargando imagen:', img.src);
            
            const defaultImages = [
                'imagenes-productos/default1.jpg',
                'imagenes-productos/default2.jpg',
                'imagenes-productos/default3.jpg',
                'imagenes-productos/default4.jpg'
            ];
            
            // Crear imagen gen√©rica con colores
            const colors = ['#e8f5e9', '#f1f8e9', '#f9fbe7', '#fffde7', '#fff3e0'];
            const randomColor = colors[Math.floor(Math.random() * colors.length)];
            
            img.src = '';
            img.onerror = null;
            
            const container = img.parentElement;
            container.style.background = `linear-gradient(135deg, ${randomColor}, ${adjustColor(randomColor, -20)})`;
            container.style.display = 'flex';
            container.style.justifyContent = 'center';
            container.style.alignItems = 'center';  // <-- CORRECTO
            container.style.position: = 'relative';
            
            // Crear icono gen√©rico
            const icon = document.createElement('div');
            icon.innerHTML = 'üõí';
            icon.style.fontSize = '3rem';
            icon.style.opacity = '0.5';
            
            // Texto del producto (abreviado)
            const text = document.createElement('div');
            text.textContent = productName.length > 20 ? productName.substring(0, 20) + '...' : productName;
            text.style.position = 'absolute';
            text.style.bottom = '10px';
            text.style.left = '0';
            text.style.right = '0';
            text.style.textAlign = 'center';
            text.style.fontSize = '0.7rem';
            text.style.color = '#666';
            text.style.padding = '0 10px';
            
            container.innerHTML = '';
            container.appendChild(icon);
            container.appendChild(text);
        }

        function adjustColor(color, amount) {
            const hex = color.replace('#', '');
            const num = parseInt(hex, 16);
            let r = (num >> 16) + amount;
            let g = ((num >> 8) & 0x00FF) + amount;
            let b = (num & 0x0000FF) + amount;
            
            r = Math.min(Math.max(0, r), 255);
            g = Math.min(Math.max(0, g), 255);
            b = Math.min(Math.max(0, b), 255);
            
            return `#${((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1)}`;
        }

        // ========== MONITOREO DE STOCK BAJO ==========
        function verificarStockBajo() {
            if (!esAdmin) return;
            
            const lowStockProducts = products.filter(p => 
                p.stockNumber > 0 && p.stockNumber <= 3
            );
            
            if (lowStockProducts.length > 0 && !lowStockAlertSent) {
                lowStockAlertSent = true;
                
                const lowStockNotification = document.createElement('div');
                lowStockNotification.className = 'stock-notification';
                lowStockNotification.innerHTML = `
                    ‚ö†Ô∏è <strong>ALERTA ADMIN:</strong> ${lowStockProducts.length} producto(s) con stock bajo
                    <br>
                    <small>${lowStockProducts.map(p => `${p.name} (${p.stockNumber})`).join(', ')}</small>
                `;
                
                document.body.appendChild(lowStockNotification);
                
                setTimeout(() => {
                    lowStockNotification.remove();
                    lowStockAlertSent = false;
                }, 10000);
            }
        }

// ========== INICIALIZACI√ìN ==========
document.addEventListener("DOMContentLoaded", function() {
    // 1. Inicializar app principal
    init();
    
    // 2. Inicializar PWA MEJORADO
    //initPWA();
    
    // 3. Verificar stock bajo peri√≥dicamente (solo admin)
    setInterval(verificarStockBajo, 60000);
    
    // 4. Service Worker - Ya est√° registrado en initPWA(), pero por seguridad
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            // Verificar si ya est√° registrado
            navigator.serviceWorker.getRegistration().then(existingRegistration => {
                if (!existingRegistration) {
                    // Registrar como backup
                    navigator.serviceWorker.register('sw.js')
                        .then(registration => {
                            console.log('‚úÖ Service Worker registrado (backup):', registration.scope);
                        })
                        .catch(error => {
                            console.error('‚ùå Error en registro backup:', error);
                        });
                } else {
                    console.log('‚úÖ Service Worker ya registrado:', existingRegistration.scope);
                }
            });
        });
    }
    
    // 5. Verificar si ya est√° instalada como PWA y actualizar UI
    setTimeout(() => {
        if (isPWAInstalled()) {
            console.log('üì± PWA ya instalada - Modo standalone activo');
            // Ocultar bot√≥n de instalaci√≥n si existe
            const installBtn = document.getElementById('installPrompt');
            if (installBtn) installBtn.style.display = 'none';
            
            // A√±adir indicador visual de que es PWA (opcional)
            const header = document.querySelector('header .logo');
            if (header) {
                header.innerHTML += '<span style="margin-left: 8px; font-size: 0.7rem; background: #4CAF50; color: white; padding: 2px 6px; border-radius: 10px;">APP</span>';
            }
        }
    }, 1000);
});
    </script>