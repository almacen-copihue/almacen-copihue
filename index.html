<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Almac√©n Copihue - Productos de calidad con la confianza de siempre</title>
    
    <!-- META TAGS PARA PWA (INSTALACI√ìN EN M√ìVILES) -->
    <meta name="theme-color" content="#2e7d32">
    <meta name="description" content="Almac√©n Copihue">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Almac√©n Copihue">
    
    <!-- ICONOS PARA TODAS LAS PLATAFORMAS -->
    <!-- Favicon b√°sico -->
    <link rel="icon" href="iconos-pwa/android/android-launchericon-48-48.png" type="image/png">
    
    <!-- Iconos Apple (iPhone/iPad) -->
    <link rel="apple-touch-icon" href="iconos-pwa/ios/180.png">
    <link rel="apple-touch-icon" sizes="152x152" href="iconos-pwa/ios/152.png">
    <link rel="apple-touch-icon" sizes="167x167" href="iconos-pwa/ios/167.png">
    <link rel="apple-touch-icon" sizes="180x180" href="iconos-pwa/ios/180.png">
    
    <!-- Splash screens para iOS -->
    <link rel="apple-touch-startup-image" href="iconos-pwa/ios/1024.png">
    
    <!-- MANIFEST EXTERNO -->
    <link rel="manifest" href="manifest.json">
    
    <!-- ESTILOS -->
    <style>
        :root {
            --primary: #2e7d32;
            --primary-dark: #1b5e20;
            --primary-light: #4caf50;
            --secondary: #ff6f00;
            --secondary-dark: #f57c00;
            --accent: #ffeb3b;
            --light: #f8fff8;
            --dark: #1b5e20;
            --gray: #757575;
            --white: #ffffff;
            --card-bg: #ffffff;
            --shadow: 0 4px 15px rgba(46,125,50,0.1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--light);
            color: var(--dark);
            line-height: 1.6;
            background-image: linear-gradient(135deg, #f8fff8 0%, #e8f5e9 100%);
        }
        
        header {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: var(--white);
            padding: 1rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow);
        }
        
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .logo-icon {
            font-size: 1.8rem;
        }

        .admin-badge {
            background: var(--secondary);
            color: white;
            padding: 0.2rem 0.6rem;
            border-radius: 12px;
            font-size: 0.7rem;
            margin-left: 0.5rem;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        .cart-icon {
            position: relative;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: background 0.3s;
        }
        
        .cart-icon:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .cart-count {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--secondary);
            color: white;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }
        
        .hero {
            background: linear-gradient(135deg, rgba(46,125,50,0.9), rgba(76,175,80,0.8));
            background-size: cover;
            color: white;
            padding: 3rem 1rem;
            text-align: center;
            border-radius: 15px;
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
        }
        
        .hero h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .hero p {
            font-size: 1.1rem;
            margin-bottom: 1rem;
            opacity: 0.9;
        }
        
        .info-bar {
            background-color: var(--white);
            padding: 1.2rem;
            border-radius: 12px;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-around;
            text-align: center;
            border-left: 4px solid var(--secondary);
        }
        
        .info-item {
            margin: 0.5rem;
            font-weight: 500;
        }
        
        .search-container {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            padding: 1rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #e8f5e9;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-radius: 12px;
            position: relative;
        }
        
        .search-wrapper {
            position: relative;
            width: 100%;
        }
        
        .search-input {
            width: 100%;
            padding: 14px 50px 14px 20px;
            border: 2px solid var(--primary);
            border-radius: 25px;
            font-size: 1rem;
            background: white;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(46,125,50,0.1);
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--primary-dark);
            box-shadow: 0 0 0 3px rgba(46,125,50,0.2);
        }
        
        .clear-search {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: var(--gray);
            transition: color 0.3s;
            padding: 5px;
            z-index: 2;
            display: none;
        }
        
        .clear-search:hover {
            color: var(--primary);
        }
        
        .search-results {
            text-align: center;
            padding: 12px;
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            border-radius: 10px;
            margin-bottom: 1rem;
            border-left: 4px solid #2196f3;
        }
        
        .categories {
            display: flex;
            overflow-x: auto;
            padding: 1rem 0;
            margin-bottom: 1rem;
            gap: 0.8rem;
        }
        
        .category-btn {
            background-color: var(--white);
            border: 2px solid #e8f5e9;
            padding: 0.7rem 1.2rem;
            border-radius: 25px;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.3s;
            font-weight: 500;
            color: var(--dark);
        }
        
        .category-btn.active {
            background-color: var(--primary);
            color: var(--white);
            border-color: var(--primary);
            transform: translateY(-2px);
        }
        
        .category-btn:hover {
            border-color: var(--primary-light);
            transform: translateY(-2px);
        }
        
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        @media (min-width: 1200px) {
            .products-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        @media (min-width: 768px) and (max-width: 1199px) {
            .products-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 767px) {
            .products-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            /* OCULTAR CARRITO DEL HEADER EN M√ìVIL */
            .cart-icon {
                display: none;
            }
        }

        @media (max-width: 480px) {
            .products-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .product-card {
            background-color: var(--card-bg);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            border: 1px solid #e8f5e9;
            position: relative;
        }
        
        .product-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 8px 25px rgba(46,125,50,0.15);
        }
        
        /* ETIQUETA DE OFERTA */
        .offer-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: linear-gradient(135deg, #ff6f00, #f57c00);
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.75rem;
            font-weight: bold;
            z-index: 10;
            box-shadow: 0 3px 10px rgba(255,111,0,0.3);
        }
        
        .promo-badge {
            position: absolute;
            top: 40px;
            right: 10px;
            background: linear-gradient(135deg, #4caf50, #2e7d32);
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.7rem;
            font-weight: bold;
            z-index: 10;
            box-shadow: 0 3px 10px rgba(46,125,50,0.3);
        }
        
        .product-image {
            height: 160px;
            background: linear-gradient(135deg, #e8f5e8, #c8e6c9);
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0.8rem;
            position: relative;
            overflow: hidden;
        }
        
        .product-image img {
            max-width: 100%;
            max-height: 130px;
            object-fit: contain;
            transition: transform 0.3s ease;
        }
        
        .product-card:hover .product-image img {
            transform: scale(1.05);
        }
        
        .product-info {
            padding: 1rem;
        }
        
        .product-name {
            font-weight: 600;
            margin-bottom: 0.4rem;
            font-size: 0.9rem;
            color: var(--dark);
            line-height: 1.3;
        }
        
        .product-price-container {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 0.5rem;
        }
        
        .original-price {
            color: var(--gray);
            text-decoration: line-through;
            font-size: 0.9rem;
        }
        
        .product-price {
            color: var(--secondary);
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        .discount-percent {
            background: #ffeb3b;
            color: #333;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: bold;
        }
        
        .product-stock {
            font-size: 0.75rem;
            margin-bottom: 0.8rem;
            font-weight: 500;
        }
        
        .in-stock {
            color: var(--primary-light);
        }
        
        .out-of-stock {
            color: var(--gray);
        }

        .low-stock {
            color: #ff9800;
            font-weight: bold;
        }
        
        .add-to-cart {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            border: none;
            padding: 0.7rem;
            border-radius: 8px;
            width: 100%;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .add-to-cart:hover {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary));
            transform: translateY(-2px);
        }
        
        .add-to-cart:disabled {
            background: var(--gray);
            cursor: not-allowed;
            transform: none;
        }

        .cart-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .cart-content {
            background-color: var(--white);
            width: 90%;
            max-width: 500px;
            border-radius: 15px;
            padding: 1.5rem;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow);
        }
        
        .cart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            border-bottom: 2px solid #e8f5e9;
            padding-bottom: 0.8rem;
        }
        
        .close-cart {
            background: none;
            border: none;
            font-size: 1.8rem;
            cursor: pointer;
            color: var(--gray);
            transition: color 0.3s;
        }
        
        .close-cart:hover {
            color: var(--primary);
        }
        
        .cart-items {
            margin-bottom: 1rem;
        }
        
        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.8rem 0;
            border-bottom: 1px solid #e8f5e9;
        }
        
        .cart-item-info {
            flex-grow: 1;
        }
        
        .cart-item-name {
            font-weight: bold;
            color: var(--dark);
        }
        
        .cart-item-price {
            color: var(--gray);
            font-size: 0.9rem;
        }
        
        .cart-item-quantity {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .quantity-btn {
            background-color: var(--light);
            border: 1px solid #c8e6c9;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .quantity-btn:hover {
            background-color: var(--primary-light);
            color: white;
        }
        
        .quantity-value {
            margin: 0 0.5rem;
            font-weight: bold;
            min-width: 20px;
            text-align: center;
        }
        
        .cart-total {
            font-weight: bold;
            font-size: 1.3rem;
            text-align: right;
            margin-bottom: 1rem;
            color: var(--primary);
            padding-top: 1rem;
            border-top: 2px solid #e8f5e9;
        }
        
        .total-savings {
            background: #4caf50;
            color: white;
            padding: 0.8rem;
            border-radius: 8px;
            margin: 0.5rem 0;
            text-align: center;
            font-weight: bold;
        }
        
        .send-order {
            background: linear-gradient(135deg, var(--secondary), var(--secondary-dark));
            color: white;
            border: none;
            padding: 1.2rem;
            border-radius: 10px;
            width: 100%;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .send-order:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255,111,0,0.3);
        }
        
        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--gray);
            font-size: 1.1rem;
        }
        
        .error-message {
            text-align: center;
            padding: 2rem;
            color: #d32f2f;
            background: #ffebee;
            border-radius: 10px;
            margin: 1rem 0;
            border-left: 4px solid #d32f2f;
        }
        
        .retry-btn {
            margin-top: 10px;
            padding: 10px 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.3s;
        }
        
        .retry-btn:hover {
            background: var(--primary-dark);
        }
        
        footer {
            background: linear-gradient(135deg, var(--dark), var(--primary));
            color: var(--white);
            padding: 2rem 1rem;
            text-align: center;
            margin-top: 3rem;
        }
        
        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
        }

        .admin-notification {
            background: linear-gradient(135deg, #ff9800, #f57c00);
            color: white;
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            text-align: center;
            animation: slideIn 0.5s ease;
        }

        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* ========== ESTILOS PARA PWA ========== */
        
        /* Bot√≥n de instalaci√≥n */
        .install-prompt {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 15px 20px;
            border-radius: 50px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            cursor: pointer;
            z-index: 1000;
            display: none;
            align-items: center;
            gap: 10px;
            font-weight: bold;
            font-size: 16px;
            animation: slideUp 0.5s ease;
            border: 2px solid white;
        }
        
        @keyframes slideUp {
            from { transform: translateY(100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .install-prompt:hover {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary));
            transform: scale(1.05);
        }
        
        /* Notificaci√≥n cuando se instala */
        .success-notification {
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: #4CAF50;
            color: white;
            padding: 15px 30px;
            border-radius: 50px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            z-index: 10000;
            font-weight: bold;
            text-align: center;
            animation: fadeInOut 3s ease;
        }
        
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
            20% { opacity: 1; transform: translateX(-50%) translateY(0); }
            80% { opacity: 1; transform: translateX(-50%) translateY(0); }
            100% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
        }

        /* FLOTANTE OPTIMIZADO PARA CELULAR */
        .floating-cart {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, var(--secondary), var(--secondary-dark));
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(255,111,0,0.4);
            z-index: 999;
            transition: all 0.3s ease;
            font-size: 1.5rem;
        }
        
        .floating-cart:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(255,111,0,0.6);
        }
        
        .floating-cart .cart-count {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--primary);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.8rem;
            font-weight: bold;
            border: 2px solid white;
        }

        /* BUSCADOR FLOTANTE PARA M√ìVIL */
        .floating-search {
            position: fixed;
            bottom: 90px;
            right: 20px;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: none;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(46,125,50,0.4);
            z-index: 998;
            transition: all 0.3s ease;
            font-size: 1.5rem;
        }
        
        .floating-search:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(46,125,50,0.6);
        }

        /* MODAL DE B√öSQUEDA */
        .search-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1001;
            justify-content: center;
            align-items: flex-start;
            padding-top: 80px;
        }
        
        .search-modal-content {
            background-color: var(--white);
            width: 90%;
            max-width: 500px;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
        }
        
        .search-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            border-bottom: 2px solid #e8f5e9;
            padding-bottom: 0.8rem;
        }
        
        .close-search {
            background: none;
            border: none;
            font-size: 1.8rem;
            cursor: pointer;
            color: var(--gray);
            transition: color 0.3s;
        }
        
        .close-search:hover {
            color: var(--primary);
        }

        /* MOSTRAR BUSCADOR FLOTANTE SOLO EN M√ìVIL */
        @media (max-width: 767px) {
            .search-container {
                display: none;
            }
            
            .floating-search {
                display: flex;
            }
        }

        /* ESTILOS PARA NOTIFICACIONES DE STOCK */
        .stock-notification {
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: #f44336;
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1002;
            font-weight: 500;
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from { transform: translateX(-50%) translateY(-20px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }
        
        /* SUGERENCIAS DE B√öSQUEDA */
        .search-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            z-index: 1000;
            max-height: 300px;
            overflow-y: auto;
            display: none;
        }
        
        .suggestion-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
        }
        
        .suggestion-item:hover {
            background: #f5f5f5;
        }
        
        .suggestion-name {
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .suggestion-details {
            font-size: 0.8rem;
            color: #666;
        }
        
        .suggestion-badge {
            background: #ff9800;
            color: white;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 0.7rem;
        }

        /* RESULTADOS DE B√öSQUEDA M√ìVIL */
        .mobile-search-results {
            margin-top: 1rem;
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
<header>
    <div class="header-content">
        <div class="logo">
            <img src="iconos-pwa/android/android-launchericon-48-48.png" alt="Logo Almac√©n Copihue" class="logo-icon">
            Almac√©n Copihue
            <span id="adminBadge" class="admin-badge" style="display: none;">ADMIN</span>
        </div>
        <div class="cart-icon" id="cartIcon">
            üõí <span class="cart-count" id="cartCount">0</span>
        </div>
    </div>
</header>
    <div class="container">
        <div id="adminNotification" class="admin-notification" style="display: none;">
            <strong>üîî MODO ADMIN ACTIVADO</strong> - Recibir√°s alertas de stock bajo
        </div>

        <section class="hero">
            <h1>"Almac√©n Copihue"</h1>
            <p>Productos de calidad con la confianza de siempre</p>
        </section>

        <section class="info-bar">
            <div class="info-item">
                <strong>üìç Retiro en el local:</strong> Copihue 457
            </div>
            <div class="info-item">
                <strong>üìû WhatsApp:</strong> +5492944907380
            </div>
            <div class="info-item">
                <strong>‚è∞ Horario:</strong> 11:30 a 23:30 hrs.
            </div>
        </section>

        <!-- BUSCADOR PARA ESCRITORIO - CON SUGERENCIAS -->
        <div class="search-container" id="desktopSearch">
            <div class="search-wrapper">
                <input type="text" id="productSearch" class="search-input" 
                       placeholder="üîç Buscar productos por nombre, abreviatura o sin√≥nimo...">
                <button class="clear-search" id="clearSearchBtn">‚úñÔ∏è</button>
                <div id="searchSuggestions" class="search-suggestions"></div>
            </div>
        </div>

        <section class="categories" id="categories">
            <!-- Las categor√≠as se cargar√°n din√°micamente con JavaScript -->
        </section>

        <section class="products-grid" id="productsGrid">
            <div class="loading">üîÑ Cargando productos desde Google Sheets...</div>
        </section>
    </div>

    <!-- BUSCADOR FLOTANTE PARA M√ìVIL -->
    <div class="floating-search" id="floatingSearch">
        üîç
    </div>

    <!-- CARRITO FLOTANTE OPTIMIZADO PARA CELULAR -->
    <div class="floating-cart" id="floatingCart">
        üõí
        <span class="cart-count" id="floatingCartCount">0</span>
    </div>

    <!-- MODAL DE B√öSQUEDA PARA M√ìVIL -->
    <div class="search-modal" id="searchModal">
        <div class="search-modal-content">
            <div class="search-modal-header">
                <h2>Buscar Productos</h2>
                <button class="close-search" id="closeSearch">&times;</button>
            </div>
            <div class="search-wrapper">
                <input type="text" id="mobileSearch" class="search-input" 
                       placeholder="üîç Escribe nombre, abreviatura o sin√≥nimo..."
                       onkeydown="handleMobileSearchEnter(event)">
                <button class="clear-search" id="clearMobileSearchBtn">‚úñÔ∏è</button>
            </div>
            <div class="mobile-search-results" id="mobileSearchResults">
                <!-- Resultados de b√∫squeda m√≥vil se cargar√°n aqu√≠ -->
            </div>
        </div>
    </div>

    <!-- MODAL DEL CARRITO -->
    <div class="cart-modal" id="cartModal">
        <div class="cart-content">
            <div class="cart-header">
                <h2>Tu Pedido</h2>
                <button class="close-cart" id="closeCart">&times;</button>
            </div>
            <div class="cart-items" id="cartItems">
                <!-- Los items del carrito se cargar√°n din√°micamente -->
            </div>
            <div class="cart-total" id="cartTotal">Total: $0</div>
            <button class="send-order" id="sendOrder">Enviar Pedido por WhatsApp</button>
        </div>
    </div>

    <!-- Bot√≥n para instalar la app en el celular -->
    <div class="install-prompt" id="installPrompt">
        <span>üì± Instalar App</span>
    </div>

    <!-- Instrucciones para iPhone -->
    <div class="ios-instructions" id="iosInstructions" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 10000; justify-content: center; align-items: center; padding: 20px;">
        <div style="background: white; border-radius: 20px; padding: 30px; max-width: 400px; text-align: center;">
            <h2 style="color: #2e7d32; margin-bottom: 20px;">üì± Instalar en iPhone/iPad</h2>
            <div style="text-align: left; margin: 20px 0; font-size: 16px; line-height: 1.8;">
                <p>1. Toca el bot√≥n <strong style="color: #2e7d32;">Compartir</strong> üì§</p>
                <p>2. Despl√°zate hacia abajo</p>
                <p>3. Selecciona <strong style="color: #2e7d32;">"Agregar a Inicio"</strong></p>
                <p>4. Toca <strong style="color: #2e7d32;">"Agregar"</strong></p>
            </div>
            <button onclick="document.getElementById('iosInstructions').style.display='none'" 
                    style="background: #2e7d32; color: white; border: none; padding: 12px 30px; 
                           border-radius: 25px; font-size: 16px; font-weight: bold; cursor: pointer; 
                           margin-top: 10px; width: 100%;">
                Entendido
            </button>
        </div>
    </div>

    <footer>
        <div class="footer-content">
            <p>Almac√©n Copihue - Productos de calidad con la confianza de siempre</p>
            <p>üìç Copihue 457 | üìû +5492944907380 | ‚è∞ 11:30 a 23:30 hrs.</p>
        </div>
    </footer>

    <script>
        // ========== C√ìDIGO PARA INSTALAR LA APP EN EL CELULAR ==========
        
        // Variables para la instalaci√≥n
        let deferredPrompt;
        const installPrompt = document.getElementById('installPrompt');
        
        // Verificar si la PWA ya est√° instalada
        function isPWAInstalled() {
            // Para Android/Chrome
            if (window.matchMedia('(display-mode: standalone)').matches) {
                console.log('üì± App ya instalada (modo standalone)');
                return true;
            }
            
            // Para iOS
            if (window.navigator.standalone === true) {
                console.log('üì± App ya instalada en iOS');
                return true;
            }
            
            return false;
        }
        
        // 1. Cuando el navegador detecta que se puede instalar
        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('üì± Navegador quiere instalar la app');
            
            // Verificar si ya est√° instalada
            if (isPWAInstalled()) {
                console.log('üì± Ya est√° instalada, ignorando prompt');
                return;
            }
            
            // Prevenir que muestre el banner autom√°tico
            e.preventDefault();
            
            // Guardar el evento para usarlo despu√©s
            deferredPrompt = e;
            
            // Mostrar nuestro bot√≥n personalizado despu√©s de 3 segundos
            setTimeout(() => {
                if (deferredPrompt && installPrompt && !isPWAInstalled()) {
                    console.log('‚úÖ Mostrando bot√≥n de instalaci√≥n');
                    installPrompt.style.display = 'flex';
                    
                    // Ocultar despu√©s de 30 segundos si no se usa
                    setTimeout(() => {
                        if (installPrompt.style.display !== 'none') {
                            installPrompt.style.display = 'none';
                        }
                    }, 30000);
                }
            }, 3000);
        });
        
        // 2. Cuando el usuario toca el bot√≥n "Instalar App"
        if (installPrompt) {
            installPrompt.addEventListener('click', async () => {
                console.log('üñ±Ô∏è Usuario toc√≥ el bot√≥n de instalaci√≥n');
                
                // Si es iPhone/iPad
                if (/iPhone|iPad|iPod/.test(navigator.userAgent)) {
                    console.log('üì± Dispositivo iOS detectado');
                    document.getElementById('iosInstructions').style.display = 'flex';
                    installPrompt.style.display = 'none';
                    return;
                }
                
                // Si es Android/Chrome y tenemos el prompt
                if (deferredPrompt) {
                    try {
                        console.log('üì± Mostrando di√°logo de instalaci√≥n...');
                        deferredPrompt.prompt();
                        
                        // Esperar a que el usuario decida
                        const choiceResult = await deferredPrompt.userChoice;
                        
                        console.log(`üìä Usuario ${choiceResult.outcome === 'accepted' ? 'acept√≥' : 'rechaz√≥'} la instalaci√≥n`);
                        
                        // Limpiar el prompt
                        deferredPrompt = null;
                        
                        // Ocultar nuestro bot√≥n
                        installPrompt.style.display = 'none';
                        
                        // Mostrar mensaje de √©xito si acept√≥
                        if (choiceResult.outcome === 'accepted') {
                            showSuccessMessage('‚úÖ ¬°App instalada exitosamente!');
                        }
                        
                    } catch (error) {
                        console.error('‚ùå Error durante la instalaci√≥n:', error);
                        showSuccessMessage('‚ö†Ô∏è Error en la instalaci√≥n');
                    }
                } else {
                    console.log('‚ö†Ô∏è No hay prompt disponible, recargando...');
                    location.reload();
                }
            });
        }
        
        // 3. Cuando la app ya se instal√≥
        window.addEventListener('appinstalled', () => {
            console.log('üéâ ¬°App instalada exitosamente!');
            
            if (installPrompt) {
                installPrompt.style.display = 'none';
            }
            
            deferredPrompt = null;
            
            showSuccessMessage('‚úÖ ¬°App instalada correctamente!');
        });
        
        // 4. Funci√≥n para mostrar mensajes de √©xito/error
        function showSuccessMessage(message) {
            const notification = document.createElement('div');
            notification.className = 'success-notification';
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Auto-eliminar despu√©s de 3 segundos
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
        }
        
        // 5. Inicializar el sistema de instalaci√≥n (VERSI√ìN SIMPLIFICADA)
        function initPWA() {
            console.log('üöÄ Iniciando sistema de instalaci√≥n PWA...');
            console.log('üì± Dispositivo:', navigator.userAgent);
            
            // Verificar si ya est√° instalada y ocultar el bot√≥n
            if (isPWAInstalled() && installPrompt) {
                installPrompt.style.display = 'none';
            }
            
            // ELIMINADO: El c√≥digo que creaba el manifest din√°mico
            // AHORA USAMOS EL MANIFEST.JSON EXTERNO
        }

        // ========== DICCIONARIO DE B√öSQUEDA INTELIGENTE ==========
        const SEARCH_DICTIONARY = {
            // Bebidas
            'coca': ['coca cola', 'coca-cola', 'cocacola', 'cola'],
            'pepsi': ['pepsi cola', 'pepsi-cola', 'pepsicola'],
            'sprite': ['esprite', 'sprait'],
            'fanta': ['fanta naranja', 'fantas'],
            'cerveza': ['birra', 'chela', 'cervezas', 'birras'],
            'quilmes': ['quilmes', 'quilme'],
            'brahma': ['brahama', 'brama'],
            'heineken': ['heineken', 'hineken'],
            'vino': ['vinito', 'vinitos', 'vinos'],
            'agua': ['aguita', 'agua mineral', 'agua con gas'],
            'jugo': ['juguito', 'jugos', 'zumo', 'zumos'],
            'energizante': ['energ√©tico', 'energetico', 'monster', 'red bull'],
            
            // Almac√©n
            'azucar': ['az√∫car', 'azuquita', 'azucar blanca'],
            'arroz': ['arro', 'arrozz', 'arros'],
            'fideo': ['fideos', 'fideitos', 'pastas', 'pasta'],
            'aceite': ['aceite girasol', 'aceite oliva', 'aceites'],
            'sal': ['sal fina', 'sal gruesa', 'sal marina'],
            'harina': ['harina 0000', 'harina leudante', 'harinas'],
            'yerba': ['yerba mate', 'yerbas', 'mate'],
            'te': ['t√©', 'te negro', 'te verde', 'tes'],
            'cafe': ['caf√©', 'cafecito', 'caf√©s'],
            'leche': ['leche entera', 'leche descremada', 'leches'],
            'galletas': ['galletitas', 'galleta', 'galletas dulces'],
            'pan': ['pan lactal', 'pan de molde', 'panes'],
            
            // Snacks
            'papas': ['papas fritas', 'papitas', 'patatas', 'chips'],
            'chizitos': ['chicitos', 'chizito', 'snack'],
            'palitos': ['palitos salados', 'palitos queso'],
            'mani': ['man√≠', 'mani salado', 'manises'],
            'chocolate': ['chocolates', 'chocolat√≠n', 'tableta'],
            'caramelos': ['caramelitos', 'golosinas', 'golosina', 'dulces'],
            'alfajor': ['alfajores', 'alfajorcito', 'alfajorcitos'],
            
            // Limpieza
            'jabon': ['jab√≥n', 'jabones', 'jaboncito'],
            'lavandina': ['cloro', 'lavandina concentrada'],
            'detergente': ['detergente l√≠quido', 'detergentes'],
            'limpiador': ['limpia pisos', 'limpia vidrios', 'limpiadores'],
            'papel': ['papel higi√©nico', 'papelitos', 'rollos'],
            'shampoo': ['champ√∫', 'shampoo', 'shampoos'],
            
            // L√°cteos
            'queso': ['quesos', 'quesito', 'quesillo'],
            'manteca': ['mantequilla', 'manteca', 'mantequilla'],
            'yogur': ['yogurt', 'yogures', 'yogurth'],
            'crema': ['crema de leche', 'cremita'],
            
            // Congelados
            'helado': ['helados', 'heladito', 'postre helado'],
            'pizza': ['pizzas', 'pizzeta', 'pizzetas'],
            'hamburguesa': ['hamburguesas', 'burguer', 'burgers'],
            
            // Abreviaturas comunes
            'l': ['litro', 'lt', 'lts', 'litros'],
            'ml': ['mililitros', 'mililitro'],
            'kg': ['kilo', 'kilos', 'kilogramo'],
            'g': ['gramo', 'gramos', 'gr', 'grs'],
            'un': ['unidad', 'unidades', 'uni', 'unid'],
            'pkg': ['paquete', 'pack', 'packs', 'paquetes'],
            'caja': ['cajita', 'cajas', 'caj√≥n'],
            'c/u': ['cada uno', 'cada unidad'],
            
            // Sin√≥nimos generales
            'grande': ['big', 'large', 'xl', 'extragrande'],
            'chico': ['peque√±o', 'peque√±a', 'peque', 'chiquito'],
            'medio': ['mediano', 'medium', 'md'],
            'promo': ['oferta', 'promoci√≥n', 'promocion', 'descuento'],
            'combo': ['pack', 'lote', 'conjunto'],
            '2x1': ['dos por uno', 'doble', 'dosxuno'],
            '3x2': ['tres por dos', 'tresxdos'],
            
            // Marcas populares
            'marolio': ['marol', 'marolios'],
            'sancor': ['sanc', 'sancors'],
            'la serenisima': ['seren√≠sima', 'serenisima', 'laserenisima'],
            'arcor': ['arc', 'arcors'],
            'bagley': ['bagle', 'bagleys'],
            'terrabusi': ['terrabus', 'terrabusis'],
            
            // Preparaciones
            'lista': ['listo para', 'preparado', 'instant√°neo'],
            'instantaneo': ['instant√°neo', 'r√°pido', 'express'],
            'natural': ['org√°nico', 'org√°nico', 'bio', 'ecol√≥gico']
        };

        // ========== SISTEMA DE OFERTAS PROGRESIVAS ESCALONADAS - VERSI√ìN DEFINITIVA ==========
        const PROMO_SYSTEM = {
            // OFERTAS PROGRESIVAS ESCALONADAS (0,1,2,3,4,5) - SISTEMA CORREGIDO
            '0': { 
                discount: 0.10,   // 10% OFF FIJO desde 1 unidad
                name: "Oferta Inicial",
                minQuantity: 1,
                type: "progresiva_fija",
                maxStockMultiplier: 1.0
            },
            '1': { 
                discount: 1/6,    // 16.67% OFF desde 1 unidad
                name: "Oferta B√°sica",
                minQuantity: 1,
                type: "progresiva_escalonada",
                maxStockMultiplier: 0.9
            },
            '2': { 
                discount: 0.25,   // 25% OFF desde 2 unidades
                name: "Oferta Duo", 
                minQuantity: 2,
                type: "progresiva_escalonada",
                maxStockMultiplier: 0.8
            },
            '3': { 
                discount: 1/3,    // 33.33% OFF desde 3 unidades
                name: "Oferta Triple",
                minQuantity: 3,
                type: "progresiva_escalonada",
                maxStockMultiplier: 0.7
            },
            '4': { 
                discount: 0.40,   // 40% OFF desde 4 unidades
                name: "Oferta Max",
                minQuantity: 4,
                type: "progresiva_escalonada",
                maxStockMultiplier: 0.6
            },
            '5': { 
                discount: 0.50,   // 50% OFF desde 5 unidades
                name: "Oferta Super",
                minQuantity: 5,
                type: "progresiva_escalonada",
                maxStockMultiplier: 0.5
            },
            
            // OFERTAS DIRECTAS (D25,D30,D40,D50,D60)
            'D25': { 
                discount: 0.25,
                name: "25% OFF",
                minQuantity: 1,
                type: "directa",
                maxStockMultiplier: 0.8
            },
            'D30': { 
                discount: 0.30,
                name: "30% OFF",
                minQuantity: 1,
                type: "directa",
                maxStockMultiplier: 0.7
            },
            'D40': { 
                discount: 0.40,
                name: "40% OFF",
                minQuantity: 1,
                type: "directa",
                maxStockMultiplier: 0.6
            },
            'D50': { 
                discount: 0.50,
                name: "50% OFF",
                minQuantity: 1,
                type: "directa",
                maxStockMultiplier: 0.5
            },
            'D60': { 
                discount: 0.60,
                name: "60% OFF",
                minQuantity: 1,
                type: "directa",
                maxStockMultiplier: 0.4
            }
        };

        // ========== C√ìDIGO ALMAC√âN COPIHUE ==========
        const SHEET_ID = '1hKeM-13t6wyGD5Ya4Rx9NeUJXsgJoVN4dOb-rklPznA';
        
        // Variables globales
        let products = [];
        let cart = [];
        let currentCategory = "TODOS";
        let lowStockAlertSent = false;
        let esAdmin = false;
        let isSearching = false;

        // Elementos del DOM
        const categoriesContainer = document.getElementById("categories");
        const productsGrid = document.getElementById("productsGrid");
        const cartIcon = document.getElementById("cartIcon");
        const floatingCart = document.getElementById("floatingCart");
        const floatingSearch = document.getElementById("floatingSearch");
        const searchModal = document.getElementById("searchModal");
        const closeSearch = document.getElementById("closeSearch");
        const mobileSearch = document.getElementById("mobileSearch");
        const mobileSearchResults = document.getElementById("mobileSearchResults");
        const cartModal = document.getElementById("cartModal");
        const closeCart = document.getElementById("closeCart");
        const cartItems = document.getElementById("cartItems");
        const cartTotal = document.getElementById("cartTotal");
        const cartCount = document.getElementById("cartCount");
        const floatingCartCount = document.getElementById("floatingCartCount");
        const sendOrder = document.getElementById("sendOrder");
        const adminBadge = document.getElementById("adminBadge");
        const adminNotification = document.getElementById("adminNotification");
        const productSearch = document.getElementById("productSearch");
        const clearSearchBtn = document.getElementById("clearSearchBtn");
        const clearMobileSearchBtn = document.getElementById("clearMobileSearchBtn");
        const searchSuggestions = document.getElementById("searchSuggestions");

        // ‚úÖ FUNCI√ìN PARA MANEJAR ENTER EN B√öSQUEDA M√ìVIL
        window.handleMobileSearchEnter = function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const searchTerm = mobileSearch.value.trim();
                if (searchTerm.length >= 2) {
                    filterMobileProducts(searchTerm);
                    // Ocultar teclado virtual en m√≥vil
                    mobileSearch.blur();
                }
            }
        };

        // ‚úÖ FUNCI√ìN DEFINITIVA PARA CALCULAR DESCUENTOS - TODAS LAS OFERTAS FUNCIONAN
        function calculateDiscountedPrice(originalPrice, promoCode, quantity) {
            // Si no hay c√≥digo de oferta o el c√≥digo no existe, precio normal
            if (!promoCode || !PROMO_SYSTEM[promoCode]) {
                return originalPrice;
            }
            
            const promo = PROMO_SYSTEM[promoCode];
            
            // Verificar que se cumpla la cantidad m√≠nima
            if (quantity < promo.minQuantity) {
                return originalPrice;
            }
            
            // OFERTAS DIRECTAS: descuento fijo
            if (promo.type === "directa") {
                const discountAmount = originalPrice * promo.discount;
                const discountedPrice = originalPrice - discountAmount;
                return Math.floor(discountedPrice / 100) * 100;
            }
            
            // OFERTA 0: 10% FIJO (no escalona)
            if (promoCode === "0") {
                const discountAmount = originalPrice * 0.10;
                const discountedPrice = originalPrice - discountAmount;
                return Math.floor(discountedPrice / 100) * 100;
            }
            
            // OFERTAS PROGRESIVAS ESCALONADAS (1,2,3,4,5):
            if (promo.type === "progresiva_escalonada") {
                // Determinar qu√© descuento aplicar seg√∫n la cantidad
                let discountToApply = 0;
                
                if (promoCode === "1") {
                    // Oferta 1: 16.67% desde 1 unidad
                    discountToApply = 1/6;
                }
                else if (promoCode === "2") {
                    // Oferta 2: Si tiene 2 unidades = 25%, si tiene 1 = 16.67%
                    if (quantity >= 2) {
                        discountToApply = 0.25;
                    } else {
                        discountToApply = 1/6;
                    }
                }
                else if (promoCode === "3") {
                    // Oferta 3: Si tiene 3 unidades = 33.33%, si tiene 2 = 25%, si tiene 1 = 16.67%
                    if (quantity >= 3) {
                        discountToApply = 1/3;
                    } else if (quantity >= 2) {
                        discountToApply = 0.25;
                    } else {
                        discountToApply = 1/6;
                    }
                }
                else if (promoCode === "4") {
                    // Oferta 4: Si tiene 4 unidades = 40%, si tiene 3 = 33.33%, etc.
                    if (quantity >= 4) {
                        discountToApply = 0.40;
                    } else if (quantity >= 3) {
                        discountToApply = 1/3;
                    } else if (quantity >= 2) {
                        discountToApply = 0.25;
                    } else {
                        discountToApply = 1/6;
                    }
                }
                else if (promoCode === "5") {
                    // Oferta 5: Si tiene 5 unidades = 50%, si tiene 4 = 40%, etc.
                    if (quantity >= 5) {
                        discountToApply = 0.50;
                    } else if (quantity >= 4) {
                        discountToApply = 0.40;
                    } else if (quantity >= 3) {
                        discountToApply = 1/3;
                    } else if (quantity >= 2) {
                        discountToApply = 0.25;
                    } else {
                        discountToApply = 1/6;
                    }
                }
                
                const discountAmount = originalPrice * discountToApply;
                const discountedPrice = originalPrice - discountAmount;
                return Math.floor(discountedPrice / 100) * 100;
            }
            
            return originalPrice;
        }

        // ‚úÖ FUNCI√ìN PARA OBTENER EL M√ÅXIMO STOCK PERMITIDO SEG√öN LA OFERTA (L√çMITE INVERSO)
        function getMaxAllowedStock(stockNumber, promoCode) {
            if (!promoCode || !PROMO_SYSTEM[promoCode]) {
                return stockNumber;
            }
            
            const promo = PROMO_SYSTEM[promoCode];
            const maxAllowed = Math.floor(stockNumber * promo.maxStockMultiplier);
            
            return Math.max(1, maxAllowed);
        }

        // ‚úÖ FUNCI√ìN PARA MOSTRAR ERROR DE STOCK (CON L√çMITE INVERSO)
        function showStockError(productName, availableStock, maxAllowed) {
            const notification = document.createElement('div');
            notification.className = 'stock-notification';
            
            if (maxAllowed < availableStock) {
                notification.innerHTML = `‚ö†Ô∏è L√≠mite por oferta: ${productName}. M√°ximo: ${maxAllowed} unidades (Stock real: ${availableStock})`;
            } else {
                notification.innerHTML = `‚ùå No hay suficiente stock de ${productName}. M√°ximo: ${availableStock} unidades`;
            }
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // ‚úÖ FUNCI√ìN PARA OBTENER TEXTO DE OFERTA (CORREGIDO)
        function getOfferText(promoCode) {
            if (!promoCode || !PROMO_SYSTEM[promoCode]) return "";
            
            const promo = PROMO_SYSTEM[promoCode];
            
            if (promoCode === "0") {
                return "10% OFF"; // FIJO, no "Hasta"
            }
            
            if (promo.type === "directa") {
                return `${Math.round(promo.discount * 100)}% OFF`;
            }
            
            if (promo.type === "progresiva_escalonada") {
                return `Hasta ${Math.round(promo.discount * 100)}% OFF`;
            }
            
            return "";
        }

        // ‚úÖ FUNCI√ìN PARA OBTENER DESCUENTO REAL QUE SE MUESTRA (PARA 1 UNIDAD)
        function getRealDiscountForDisplay(originalPrice, promoCode) {
            if (!promoCode || !PROMO_SYSTEM[promoCode]) return 0;
            
            const priceFor1 = calculateDiscountedPrice(originalPrice, promoCode, 1);
            
            if (originalPrice <= priceFor1 || originalPrice === 0) return 0;
            
            const discount = ((originalPrice - priceFor1) / originalPrice) * 100;
            return Math.round(discount);
        }

        // ‚úÖ FUNCI√ìN PARA SABER SI DEBE MOSTRARSE PRECIO TACHADO
        function shouldShowOriginalPrice(originalPrice, promoCode) {
            if (!promoCode || !PROMO_SYSTEM[promoCode]) return false;
            
            const priceFor1 = calculateDiscountedPrice(originalPrice, promoCode, 1);
            return priceFor1 < originalPrice;
        }

        // DETECTAR SI ES ADMIN
        function detectarAdmin() {
            const urlParams = new URLSearchParams(window.location.search);
            esAdmin = urlParams.has('admin');
            
            if (esAdmin) {
                adminBadge.style.display = 'inline-block';
                adminNotification.style.display = 'block';
            }
        }

        // FUNCIONES DE B√öSQUEDA INTELIGENTE
        function normalizeSearchTerm(term) {
            let normalized = term.toLowerCase().trim();
            normalized = normalized.replace(/[^\w\s]/g, ' ');
            normalized = normalized.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            normalized = normalized.replace(/\s+/g, ' ');
            return normalized;
        }

        function expandSearchTerms(searchTerm) {
            const normalizedTerm = normalizeSearchTerm(searchTerm);
            const words = normalizedTerm.split(' ');
            const expandedTerms = new Set();
            
            expandedTerms.add(normalizedTerm);
            
            words.forEach(word => {
                if (word.length < 2) return;
                
                expandedTerms.add(word);
                
                for (const [key, synonyms] of Object.entries(SEARCH_DICTIONARY)) {
                    if (key === word) {
                        synonyms.forEach(synonym => expandedTerms.add(synonym));
                    }
                    
                    if (synonyms.includes(word)) {
                        expandedTerms.add(key);
                        synonyms.forEach(synonym => expandedTerms.add(synonym));
                    }
                }
            });
            
            if (words.length > 1) {
                expandedTerms.add(words.join(''));
                expandedTerms.add(words.join('-'));
                
                if (words.length === 2) {
                    expandedTerms.add(`${words[1]} ${words[0]}`);
                }
            }
            
            return Array.from(expandedTerms);
        }

        function searchProducts(searchTerm) {
            if (!products || products.length === 0) return [];
            if (searchTerm.length < 2) return [];
            
            const expandedTerms = expandSearchTerms(searchTerm);
            
            const results = products.filter(product => {
                const productName = normalizeSearchTerm(product.name);
                const hasStock = product.stock === "STOCK" || product.stockNumber > 0;
                
                if (!hasStock) return false;
                
                return expandedTerms.some(term => {
                    if (productName.includes(term) && term.length > 1) return true;
                    
                    if (term.length <= 3 && term.length > 1) {
                        const initials = productName.split(' ')
                            .map(word => word.charAt(0))
                            .join('');
                        if (initials.includes(term)) return true;
                    }
                    
                    if (term.length > 3) {
                        if (productName.includes(term.substring(0, Math.max(3, term.length - 1)))) {
                            return true;
                        }
                    }
                    
                    return false;
                });
            });
            
            results.sort((a, b) => {
                const nameA = normalizeSearchTerm(a.name);
                const nameB = normalizeSearchTerm(b.name);
                
                const exactMatchA = expandedTerms.some(term => nameA === term);
                const exactMatchB = expandedTerms.some(term => nameB === term);
                
                if (exactMatchA && !exactMatchB) return -1;
                if (!exactMatchA && exactMatchB) return 1;
                
                if (a.stockNumber !== b.stockNumber) {
                    return b.stockNumber - a.stockNumber;
                }
                
                if (a.hasPromo !== b.hasPromo) {
                    return b.hasPromo - a.hasPromo;
                }
                
                return 0;
            });
            
            return results;
        }


async function loadProductsFromSheets() {
    try {
        productsGrid.innerHTML = '<div class="loading">üîÑ Cargando productos...</div>';

        const PROXY_URL = 'https://corsproxy.io/?';
        const sheetNames = ['inventario', 'Inventario', 'Stock', 'stock'];
        let response = null;
        let csvText = '';

        for (let i = 0; i < sheetNames.length; i++) {
            let sheet = sheetNames[i];
            let SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheet)}&_cb=${Date.now()}`;
            let URL_CON_PROXY = PROXY_URL + encodeURIComponent(SHEET_URL);
            console.log('Intentando with sheet:', sheet, URL_CON_PROXY);

            try {
                response = await fetch(URL_CON_PROXY);
                if (response && response.ok) {
                    csvText = await response.text();
                    if (csvText && csvText.trim() !== '') {
                        console.log('CSV obtenido desde hoja:', sheet);
                        break;
                    }
                }
            } catch (errFetch) {
                console.warn('Error fetching sheet', sheet, errFetch);
            }
        }

        if (!csvText || csvText.trim() === '') {
            throw new Error('No se pudo obtener CSV v√°lido.');
        }

        processCSVData(csvText);
    } catch (error) {
        console.error('Error en loadProductsFromSheets:', error);
        loadBackupProducts();
    }
}


        function processCSVData(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim() !== '');
            
            if (lines.length < 2) {
                throw new Error('No hay suficientes datos en el Sheets');
            }
            
            const headers = parseCSVLine(lines[0]);
            const stockColumnIndex = findStockColumn(headers);
            const offerColumnIndex = findOfferColumn(headers);
            const priceColumnIndex = findPriceColumn(headers);
            const offer2ColumnIndex = findOffer2Column(headers);
            
            products = lines.slice(1).map((line, index) => {
                const values = parseCSVLine(line);
                if (values.length < 2) return null;
                
                const nombreProducto = values[0] || '';
                const nombreImagen = simplificarNombre(nombreProducto) + '.jpg';
                
                let stock = "";
                let stockNumber = 0;
                
                if (stockColumnIndex !== -1 && values[stockColumnIndex] !== undefined) {
                    const stockValue = values[stockColumnIndex].toString().trim();
                    stockNumber = parseInt(stockValue) || 0;
                    
                    if (stockNumber > 10) {
                        stock = "STOCK";
                    } else if (stockNumber > 0 && stockNumber <= 10) {
                        stock = "STOCK BAJO";
                    } else {
                        stock = "SIN STOCK";
                    }
                }
                
                // PRIORIDAD: Oferta2 (directa) primero, luego Oferta1 (progresiva)
                let promoCode = '';
                
                // Buscar oferta directa en columna "oferta2" primero
                if (offer2ColumnIndex !== -1 && values[offer2ColumnIndex] !== undefined) {
                    const offer2Value = values[offer2ColumnIndex].toString().trim().toUpperCase();
                    if (offer2Value && PROMO_SYSTEM[offer2Value]) {
                        promoCode = offer2Value;
                    }
                }
                
                // Si no hay oferta directa, buscar oferta progresiva
                if (!promoCode && offerColumnIndex !== -1 && values[offerColumnIndex] !== undefined) {
                    const offerValue = values[offerColumnIndex].toString().trim().toUpperCase();
                    if (offerValue && PROMO_SYSTEM[offerValue]) {
                        promoCode = offerValue;
                    }
                }
                
                // Validar que el c√≥digo de oferta exista en nuestro sistema
                const isValidPromo = PROMO_SYSTEM.hasOwnProperty(promoCode);
                const promo = isValidPromo ? PROMO_SYSTEM[promoCode] : null;
                let hasPromo = !!promo;
                
                // Obtener precio
                let price = 0;
                if (priceColumnIndex !== -1 && values[priceColumnIndex] !== undefined) {
                    price = parseInt(values[priceColumnIndex]) || 0;
                } else if (values.length > 1) {
                    price = parseInt(values[1]) || 0;
                }
                
                // Calcular precio con descuento para 1 unidad
                const discountedPrice = hasPromo ? calculateDiscountedPrice(price, promoCode, 1) : price;
                const realDiscount = getRealDiscountForDisplay(price, promoCode);
                const showOriginal = shouldShowOriginalPrice(price, promoCode);
                
                return {
                    id: index + 1,
                    name: nombreProducto,
                    price: price,
                    discountedPrice: discountedPrice,
                    realDiscount: realDiscount,
                    showOriginalPrice: showOriginal,
                    category: values[2] || 'ALMACEN',
                    description: values[3] || '',
                    image: `imagenes-productos/${nombreImagen}`,
                    stock: stock,
                    stockNumber: stockNumber,
                    maxAllowedStock: hasPromo ? getMaxAllowedStock(stockNumber, promoCode) : stockNumber,
                    nombreArchivo: nombreImagen,
                    hasPromo: hasPromo,
                    promoCode: promoCode,
                    promoDetails: promo,
                    offerText: getOfferText(promoCode),
                    isDirectOffer: promo && promo.type === "directa"
                };
            }).filter(product => product && product.name && product.name.trim() !== '');
            
            if (products.length === 0) {
                throw new Error('No se pudieron cargar productos v√°lidos');
            }
            
            renderCategories();
            renderProducts();
        }

        function findStockColumn(headers) {
            const stockKeywords = ['stock', 'inventario', 'cantidad', 'disponible', 'existencia'];
            
            for (let i = 0; i < headers.length; i++) {
                const header = headers[i].toLowerCase().trim();
                if (stockKeywords.some(keyword => header.includes(keyword))) {
                    return i;
                }
            }
            
            return headers.length > 4 ? 4 : -1;
        }

        function findOfferColumn(headers) {
            const offerKeywords = ['oferta', 'promo', 'promocion', 'combo', 'descuento'];
            
            for (let i = 0; i < headers.length; i++) {
                const header = headers[i].toLowerCase().trim();
                if (offerKeywords.some(keyword => header.includes(keyword))) {
                    return i;
                }
            }
            
            return headers.length > 6 ? 6 : -1;
        }

        function findOffer2Column(headers) {
            const offer2Keywords = ['oferta2', 'promo2', 'descuento2', 'oferta_directa'];
            
            for (let i = 0; i < headers.length; i++) {
                const header = headers[i].toLowerCase().trim();
                if (offer2Keywords.some(keyword => header.includes(keyword))) {
                    return i;
                }
            }
            
            return -1;
        }

        function findPriceColumn(headers) {
            const priceKeywords = ['precio', 'valor', 'costo', 'importe'];
            
            for (let i = 0; i < headers.length; i++) {
                const header = headers[i].toLowerCase().trim();
                if (priceKeywords.some(keyword => header.includes(keyword))) {
                    return i;
                }
            }
            
            return 1;
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current.trim());
            return result.map(field => field.replace(/^"|"$/g, ''));
        }

        function simplificarNombre(nombre) {
            return nombre
                .toLowerCase()
                .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
                .replace(/[^a-z0-9 ]/g, "")
                .replace(/\s+/g, '-')
                .replace(/-+/g, '-')
                .trim();
        }

        function loadBackupProducts() {
            products = [
                { 
                    id: 1, 
                    name: "CERVEZA QUILMES CLASICA 473CC - OFERTA 5", 
                    price: 3500,
                    discountedPrice: calculateDiscountedPrice(3500, "5", 1),
                    realDiscount: getRealDiscountForDisplay(3500, "5"),
                    showOriginalPrice: shouldShowOriginalPrice(3500, "5"),
                    category: "BEBIDAS", 
                    stock: "STOCK", 
                    stockNumber: 8,
                    maxAllowedStock: getMaxAllowedStock(8, "5"),
                    image: "imagenes-productos/cerveza-quilmes-1l.jpg",
                    hasPromo: true,
                    promoCode: "5",
                    promoDetails: PROMO_SYSTEM["5"],
                    offerText: getOfferText("5"),
                    isDirectOffer: false
                },
                { 
                    id: 2, 
                    name: "CERVEZA BUDWEISER 710CC - OFERTA D40", 
                    price: 4500,
                    discountedPrice: calculateDiscountedPrice(4500, "D40", 1),
                    realDiscount: getRealDiscountForDisplay(4500, "D40"),
                    showOriginalPrice: shouldShowOriginalPrice(4500, "D40"),
                    category: "BEBIDAS", 
                    stock: "STOCK BAJO", 
                    stockNumber: 3,
                    maxAllowedStock: getMaxAllowedStock(3, "D40"),
                    image: "imagenes-productos/cerveza-budweiser-710cc.jpg",
                    hasPromo: true,
                    promoCode: "D40",
                    promoDetails: PROMO_SYSTEM["D40"],
                    offerText: getOfferText("D40"),
                    isDirectOffer: true
                },
                { 
                    id: 3, 
                    name: "CERVEZA QUILMES CLASICA 710CC - OFERTA 3", 
                    price: 4500,
                    discountedPrice: calculateDiscountedPrice(4500, "3", 1),
                    realDiscount: getRealDiscountForDisplay(4500, "3"),
                    showOriginalPrice: shouldShowOriginalPrice(4500, "3"),
                    category: "BEBIDAS", 
                    stock: "STOCK", 
                    stockNumber: 15,
                    maxAllowedStock: getMaxAllowedStock(15, "3"),
                    image: "imagenes-productos/cerveza-quilmes-710cc.jpg",
                    hasPromo: true,
                    promoCode: "3",
                    promoDetails: PROMO_SYSTEM["3"],
                    offerText: getOfferText("3"),
                    isDirectOffer: false
                },
                { 
                    id: 4, 
                    name: "CERVEZA BUDWEISER 473CC - OFERTA D30", 
                    price: 3500,
                    discountedPrice: calculateDiscountedPrice(3500, "D30", 1),
                    realDiscount: getRealDiscountForDisplay(3500, "D30"),
                    showOriginalPrice: shouldShowOriginalPrice(3500, "D30"),
                    category: "BEBIDAS", 
                    stock: "STOCK", 
                    stockNumber: 12,
                    maxAllowedStock: getMaxAllowedStock(12, "D30"),
                    image: "imagenes-productos/cerveza-budweiser-473cc.jpg",
                    hasPromo: true,
                    promoCode: "D30",
                    promoDetails: PROMO_SYSTEM["D30"],
                    offerText: getOfferText("D30"),
                    isDirectOffer: true
                },
                { 
                    id: 5, 
                    name: "CENTURION COCO RALLADO 25GR - OFERTA 0", 
                    price: 1800,
                    discountedPrice: calculateDiscountedPrice(1800, "0", 1),
                    realDiscount: getRealDiscountForDisplay(1800, "0"),
                    showOriginalPrice: shouldShowOriginalPrice(1800, "0"),
                    category: "ALMACEN", 
                    stock: "STOCK", 
                    stockNumber: 20,
                    maxAllowedStock: getMaxAllowedStock(20, "0"),
                    image: "imagenes-productos/coco-rallado-25gr.jpg",
                    hasPromo: true,
                    promoCode: "0",
                    promoDetails: PROMO_SYSTEM["0"],
                    offerText: getOfferText("0"),
                    isDirectOffer: false
                },
                { 
                    id: 6, 
                    name: "AZUCAR LDC 1KG - OFERTA D25", 
                    price: 1200,
                    discountedPrice: calculateDiscountedPrice(1200, "D25", 1),
                    realDiscount: getRealDiscountForDisplay(1200, "D25"),
                    showOriginalPrice: shouldShowOriginalPrice(1200, "D25"),
                    category: "ALMACEN", 
                    stock: "STOCK", 
                    stockNumber: 25,
                    maxAllowedStock: getMaxAllowedStock(25, "D25"),
                    image: "imagenes-productos/azucar-ldc-1kg.jpg",
                    hasPromo: true,
                    promoCode: "D25",
                    promoDetails: PROMO_SYSTEM["D25"],
                    offerText: getOfferText("D25"),
                    isDirectOffer: true
                },
                { 
                    id: 7, 
                    name: "FIDEOS MAROLIO 500G - OFERTA D50", 
                    price: 800,
                    discountedPrice: calculateDiscountedPrice(800, "D50", 1),
                    realDiscount: getRealDiscountForDisplay(800, "D50"),
                    showOriginalPrice: shouldShowOriginalPrice(800, "D50"),
                    category: "ALMACEN", 
                    stock: "STOCK", 
                    stockNumber: 18,
                    maxAllowedStock: getMaxAllowedStock(18, "D50"),
                    image: "imagenes-productos/fideos-marolio.jpg",
                    hasPromo: true,
                    promoCode: "D50",
                    promoDetails: PROMO_SYSTEM["D50"],
                    offerText: getOfferText("D50"),
                    isDirectOffer: true
                },
                { 
                    id: 8, 
                    name: "AGUA VILLAVICENCIO 2L - OFERTA 2", 
                    price: 1000,
                    discountedPrice: calculateDiscountedPrice(1000, "2", 1),
                    realDiscount: getRealDiscountForDisplay(1000, "2"),
                    showOriginalPrice: shouldShowOriginalPrice(1000, "2"),
                    category: "BEBIDAS", 
                    stock: "STOCK", 
                    stockNumber: 10,
                    maxAllowedStock: getMaxAllowedStock(10, "2"),
                    image: "imagenes-productos/agua-villavicencio.jpg",
                    hasPromo: true,
                    promoCode: "2",
                    promoDetails: PROMO_SYSTEM["2"],
                    offerText: getOfferText("2"),
                    isDirectOffer: false
                }
            ];
            
            renderCategories();
            renderProducts();
            
            productsGrid.innerHTML = `
                <div class="demo-notification" style="background: #e3f2fd; padding: 1rem; border-radius: 10px; margin-bottom: 1rem; text-align: center; border-left: 4px solid #2196f3;">
                    <strong>üîß Modo Demo Activado</strong>
                    <br>
                    <small>Usando datos de ejemplo. Cuando tu Google Sheets est√© listo, se conectar√°n autom√°ticamente.</small>
                    <br>
                    <small><strong>üéØ SISTEMA DE OFERTAS INTEGRADO:</strong></small><br>
                    <small>‚úÖ Progresivas escalonadas: 0=10% FIJO, 1=17%, 2=25%, 3=33%, 4=40%, 5=50%</small><br>
                    <small>‚úÖ Directas: D25=25%, D30=30%, D40=40%, D50=50%, D60=60%</small><br>
                    <small>‚úÖ L√≠mite inverso: M√°s descuento = menos unidades permitidas</small><br>
                    <small>‚úÖ Control de stock y l√≠mites activado</small>
                </div>
                ${productsGrid.innerHTML}
            `;
        }

        // ======================================================
        // SISTEMA DE MENSAJES AUTOM√ÅTICOS SEG√öN EL CALENDARIO üá¶üá∑
        // ======================================================
        
        function obtenerMensajeEstacional() {
            const hoy = new Date();
            const mes = hoy.getMonth() + 1;
            const dia = hoy.getDate();

            if (mes === 1 && dia <= 5)
                return "¬°Feliz A√±o Nuevo! üéâ Gracias por comprar con nosotros.";
            if (mes === 1)
                return "Arrancando el a√±o con toda la energ√≠a üí™.";
            if (mes === 4 && dia <= 10)
                return "¬°Felices Pascuas! üê£ Gracias por elegirnos.";
            if (mes === 5 && dia === 25)
                return "¬°Feliz 25 de Mayo! üá¶üá∑.";
            if (mes === 6 && dia >= 10 && dia <= 20)
                return "¬°Feliz D√≠a del Padre! ‚ù§Ô∏è.";
            if (mes === 7)
                return "Vacaciones de invierno ‚ùÑÔ∏è ¬°Abrigate bien!";
            if (mes === 8 && dia >= 10 && dia <= 25)
                return "¬°Feliz D√≠a de las Infancias! üéà.";
            if (mes === 9 && dia >= 21 && dia <= 25)
                return "¬°Feliz Primavera! üå∏.";
            if (mes === 10 && dia >= 10 && dia <= 20)
                return "¬°Feliz D√≠a de la Madre! üíê.";
            if (mes === 12 && dia >= 1 && dia <= 24)
                return "¬°Se viene Navidad! üéÑ Gracias por elegirnos.";
            if (mes === 12 && dia === 25)
                return "¬°Feliz Navidad! üéÑ.";
            if (mes === 12 && dia >= 26)
                return "Cerrando el a√±o üéÜ ¬°Gracias por estar con nosotros!";

            return "Gracias por elegirnos üôå.";
        }

        // Funci√≥n para formatear columnas (alinear texto)
        function col(texto, largo) {
            return (texto + " ".repeat(largo)).substring(0, largo);
        }

        // ======================================================
        // FUNCI√ìN PRINCIPAL PARA ENVIAR PEDIDO POR WHATSAPP
        // ======================================================

        function sendOrderViaWhatsApp() {
            if (cart.length === 0) {
                alert("Tu carrito est√° vac√≠o.");
                return;
            }
            
            const phoneNumber = "5492944907380";
            
            let totalNormal = 0;
            let totalFinal = 0;
            let totalSavings = 0;
            let allOffers = [];
            
            // Calcular totales y recoger todas las ofertas
            cart.forEach(item => {
                const product = products.find(p => p.id === item.id);
                if (!product) return;
                
                const itemNormal = product.price * item.quantity;
                const itemFinal = item.price * item.quantity;
                const itemSavings = itemNormal - itemFinal;
                
                totalNormal += itemNormal;
                totalFinal += itemFinal;
                totalSavings += itemSavings;
                
                // Si hay ahorro, guardar los detalles de la oferta
                if (itemSavings > 0) {
                    const ahorroPorUnidad = product.price - item.price;
                    const ahorroPorCantidad = ahorroPorUnidad * item.quantity;
                    const porcentajeAhorro = Math.round((ahorroPorUnidad / product.price) * 100);
                    
                    allOffers.push({
                        nombre: item.name,
                        precioNormal: product.price,
                        precioOferta: item.price,
                        cantidad: item.quantity,
                        porcentaje: porcentajeAhorro,
                        ahorroPorCantidad: ahorroPorCantidad,
                        ahorroTotal: itemSavings,
                        tipoOferta: item.promoDetails ? item.promoDetails.name : "Descuento"
                    });
                }
            });

            // MENSAJE CLIENTE A MI TELEFONO POR WHATSAPP
            let message = `‚ú¶ *PEDIDO ALMAC√âN COPIHUE*\n\n`;
            message += `üìÖ ${new Date().toLocaleDateString('es-AR')}\n`;
            message += `üïê ${new Date().toLocaleTimeString('es-AR', { hour: '2-digit', minute: '2-digit' })}\n\n`;
            message += `‚ú¶ *PRODUCTOS*\n`;

            // LISTA DEL PEDIDO CON ALINEACI√ìN
            cart.forEach(item => {
                const product = products.find(p => p.id === item.id);
                if (!product) return;

                const subtotal = product.price * item.quantity;
                const subtotalFinal = item.price * item.quantity;
                const unidadTexto = item.quantity > 1 ? `($${product.price} √ó ${item.quantity}u)` : `(1u)`;
                const nombreFormateado = col(item.name, 32);

                if (item.price < product.price) {
                    message += `‚Ä¢ ${nombreFormateado} ${unidadTexto}\n`;
                    message += `  Precio normal: $${subtotal}\n`;
                    message += `  Con descuento: *$${subtotalFinal}*\n`;
                } else {
                    message += `‚Ä¢ ${nombreFormateado} ${unidadTexto}: *$${subtotal}*\n`;
                }
            });

            message += `\n‚ú¶ *RESUMEN DE PAGO*\n`;

            // TOTAL SIN DESCUENTOS
            message += `Total sin ofertas: $${totalNormal.toFixed(2)}\n`;

            // OFERTAS APLICADAS
            if (totalSavings > 0) {
                message += `\n‚ú¶ *OFERTAS APLICADAS*\n\n`;

                allOffers.forEach(o => {
                    const nombreFormateado = col(o.nombre, 30);
                    message += `‚Ä¢ ${nombreFormateado}\n`;
                    message += `  ${o.tipoOferta}: ${o.porcentaje}% OFF\n`;
                    message += `  Ahorrado: *$${o.ahorroPorCantidad.toFixed(2)}*\n\n`;
                });

                message += `‚ú¶ *TOTAL AHORRADO*\n`;
                message += `*$${totalSavings.toFixed(2)}*\n`;
            }

            // TOTAL FINAL
            message += `\n‚ú¶ *TOTAL A PAGAR*\n`;
            message += `*$${totalFinal.toFixed(2)}*\n`;

            // Separador
            message += `\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n`;

            // Informaci√≥n de contacto
            message += `üìç *Copihue 457*\n`;
            message += `üìû *+5492944907380*\n`;
            message += `üïê *11:30 a 23:30 hrs.*\n\n`;

            // N√∫mero de ticket
            const ticketNumber = Math.floor(Math.random() * 10000) + 1;
            message += `Ticket #${ticketNumber.toString().padStart(6, '0')}\n`;

            // Mensaje autom√°tico seg√∫n temporada
            message += obtenerMensajeEstacional();

            // Enviar WhatsApp
            const encodedMessage = encodeURIComponent(message);
            const whatsappURL = `https://wa.me/${phoneNumber}?text=${encodedMessage}`;
            window.open(whatsappURL, "_blank");

            // Limpiar carrito
            closeCartModal();
            cart = [];
            updateCartCount();
        }

        function init() {
            detectarAdmin();
            loadProductsFromSheets();
            setupEventListeners();
            setupSearch();
            updateCartCount();
            
            // INICIAR EL SISTEMA DE INSTALACI√ìN PARA CELULARES
            initPWA();
        }

        function setupEventListeners() {
            cartIcon.addEventListener("click", openCart);
            floatingCart.addEventListener("click", openCart);
            floatingSearch.addEventListener("click", openSearchModal);
            closeSearch.addEventListener("click", closeSearchModal);
            closeCart.addEventListener("click", closeCartModal);
            sendOrder.addEventListener("click", sendOrderViaWhatsApp);
            
            clearSearchBtn.addEventListener("click", clearSearch);
            clearMobileSearchBtn.addEventListener("click", clearMobileSearch);
            
            cartModal.addEventListener("click", function(e) {
                if (e.target === cartModal) {
                    closeCartModal();
                }
            });
            
            searchModal.addEventListener("click", function(e) {
                if (e.target === searchModal) {
                    closeSearchModal();
                }
            });
        }

        function setupSearch() {
            // Buscador de escritorio
            productSearch.addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase().trim();
                toggleClearButton(clearSearchBtn, searchTerm);
                
                if (searchTerm === '') {
                    clearSearch();
                    return;
                }
                
                if (searchTerm.length >= 2) {
                    filterProducts(searchTerm);
                }
            });
            
            // Buscador de escritorio - Enter
            productSearch.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const searchTerm = this.value.trim();
                    if (searchTerm.length >= 2) {
                        filterProducts(searchTerm);
                    }
                }
            });
            
            // Buscador m√≥vil
            mobileSearch.addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase().trim();
                toggleClearButton(clearMobileSearchBtn, searchTerm);
                
                if (searchTerm === '') {
                    mobileSearchResults.innerHTML = '';
                    return;
                }
                
                if (searchTerm.length >= 2) {
                    filterMobileProducts(searchTerm);
                }
            });
        }

        function toggleClearButton(button, searchTerm) {
            button.style.display = searchTerm.length > 0 ? 'block' : 'none';
        }

        function openSearchModal() {
            searchModal.style.display = "flex";
            mobileSearch.focus();
            mobileSearchResults.innerHTML = '';
        }

        function closeSearchModal() {
            searchModal.style.display = "none";
            mobileSearch.value = '';
            mobileSearchResults.innerHTML = '';
            clearMobileSearchBtn.style.display = 'none';
        }

        function clearMobileSearch() {
            mobileSearch.value = '';
            mobileSearchResults.innerHTML = '';
            clearMobileSearchBtn.style.display = 'none';
        }

        function filterProducts(searchTerm) {
            if (!products || products.length === 0) return;
            
            isSearching = true;
            const filtered = searchProducts(searchTerm);
            renderFilteredProducts(filtered, searchTerm);
        }

        function filterMobileProducts(searchTerm) {
            if (!products || products.length === 0) return;
            
            const filtered = searchProducts(searchTerm);
            
            if (filtered.length === 0) {
                mobileSearchResults.innerHTML = `
                    <div style="text-align: center; padding: 1rem; color: #666;">
                        üîç No se encontraron productos para "<strong>${searchTerm}</strong>"
                    </div>
                `;
                return;
            }
            
            let resultsHTML = '<div style="display: grid; gap: 1rem;">';
            
            filtered.forEach(product => {
                const hasStock = product.stock === "STOCK" || product.stockNumber > 0;
                const isLowStock = product.stockNumber > 0 && product.stockNumber <= 3;
                const isOutOfStock = product.stockNumber === 0;
                
                let stockText = '';
                let stockClass = '';
                
                if (isOutOfStock) {
                    stockText = '‚ùå Sin Stock';
                    stockClass = 'out-of-stock';
                } else if (isLowStock) {
                    stockText = `‚ö†Ô∏è Stock Bajo (${product.stockNumber})`;
                    stockClass = 'low-stock';
                } else {
                    stockText = `‚úÖ En Stock (${product.stockNumber})`;
                    stockClass = 'in-stock';
                }
                
                const addButton = isOutOfStock 
                    ? `<button class="add-to-cart" disabled>‚ùå Sin Stock</button>`
                    : `<button class="add-to-cart" data-id="${product.id}">üõí Agregar al Carrito</button>`;
                
                const offerBadge = product.hasPromo && product.offerText 
                    ? `<div class="offer-badge">${product.offerText}</div>`
                    : '';
                
                resultsHTML += `
                    <div class="product-card" style="margin: 0;">
                        ${offerBadge}
                        <div class="product-image">
                            <img src="${product.image}" 
                                 alt="${product.name}"
                                 onerror="handleImageError(this, '${product.name.replace(/'/g, "\\'")}')">
                        </div>
                        <div class="product-info">
                            <div class="product-name">${product.name}</div>
                            <div class="product-price-container">
                                ${product.showOriginalPrice ? `<span class="original-price">$${product.price}</span>` : ''}
                                <span class="product-price">$${product.discountedPrice}</span>
                                ${product.realDiscount > 0 ? `<span class="discount-percent">${product.realDiscount}% OFF</span>` : ''}
                            </div>
                            <div class="product-stock ${stockClass}">
                                ${stockText}
                            </div>
                            ${addButton}
                        </div>
                    </div>
                `;
            });
            
            resultsHTML += '</div>';
            mobileSearchResults.innerHTML = resultsHTML;
            
            setTimeout(() => {
                addCartEventListeners();
            }, 100);
        }

        function renderFilteredProducts(filteredProducts, searchTerm) {
            if (filteredProducts.length === 0) {
                productsGrid.innerHTML = `
                    <div class="loading" style="text-align: center; padding: 2rem;">
                        üîç No se encontraron productos para "<strong>${searchTerm}</strong>"
                        <br><br>
                        <button onclick="clearSearch()" class="retry-btn">
                            ‚ú® Ver todos los productos
                        </button>
                    </div>
                `;
                return;
            }
            
            renderProductsFromArray(filteredProducts, searchTerm);
        }

        function clearSearch() {
            productSearch.value = '';
            mobileSearch.value = '';
            isSearching = false;
            clearSearchBtn.style.display = 'none';
            clearMobileSearchBtn.style.display = 'none';
            renderProducts();
            currentCategory = "TODOS";
            
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-category') === 'TODOS') {
                    btn.classList.add('active');
                }
            });
        }

        function renderCategories() {
            const categories = [...new Set(products.map(p => p.category))];
            
            categoriesContainer.innerHTML = categories.map(category => `
                <button class="category-btn ${category === currentCategory ? 'active' : ''}" 
                        data-category="${category}">
                    ${category}
                </button>
            `).join("");
            
            if (categories.length > 0 && currentCategory === "TODOS") {
                currentCategory = categories[0];
                document.querySelector(`[data-category="${categories[0]}"]`).classList.add('active');
            }
            
            document.querySelectorAll(".category-btn").forEach(btn => {
                btn.addEventListener("click", function() {
                    currentCategory = this.getAttribute("data-category");
                    document.querySelectorAll(".category-btn").forEach(b => b.classList.remove("active"));
                    this.classList.add("active");
                    renderProducts();
                });
            });
        }

        function renderProducts() {
            const filteredProducts = products.filter(p => p.category === currentCategory);
            renderProductsFromArray(filteredProducts);
        }

        function renderProductsFromArray(productsArray, searchTerm = '') {
            const productsToShow = productsArray.filter(product => {
                return product.stock === "STOCK" || product.stockNumber > 0;
            });
            
            if (productsToShow.length === 0) {
                productsGrid.innerHTML = '<div class="loading">No hay productos disponibles</div>';
                return;
            }
            
            productsGrid.innerHTML = productsToShow.map(product => {
                const hasStock = product.stock === "STOCK" || product.stockNumber > 0;
                const isLowStock = product.stockNumber > 0 && product.stockNumber <= 3;
                const isOutOfStock = product.stockNumber === 0;
                
                let stockText = '';
                let stockClass = '';
                
                if (isOutOfStock) {
                    stockText = '‚ùå Sin Stock';
                    stockClass = 'out-of-stock';
                } else if (isLowStock) {
                    stockText = `‚ö†Ô∏è Stock Bajo (${product.stockNumber})`;
                    stockClass = 'low-stock';
                } else {
                    stockText = `‚úÖ En Stock (${product.stockNumber})`;
                    stockClass = 'in-stock';
                }
                
                // Mostrar l√≠mite inverso si aplica
                if (product.hasPromo && product.maxAllowedStock < product.stockNumber) {
                    stockText += ` | L√≠mite: ${product.maxAllowedStock}u`;
                }
                
                const addButton = isOutOfStock 
                    ? `<button class="add-to-cart" disabled>‚ùå Sin Stock</button>`
                    : `<button class="add-to-cart" data-id="${product.id}">üõí Agregar al Carrito</button>`;
                
                const offerBadge = product.hasPromo && product.offerText 
                    ? `<div class="offer-badge">${product.offerText}</div>`
                    : '';
                
                const promoBadge = product.hasPromo && product.promoDetails
                    ? `<div class="promo-badge">${product.promoDetails.name}</div>`
                    : '';
                
                return `
                    <div class="product-card">
                        ${offerBadge}
                        ${promoBadge}
                        <div class="product-image">
                            <img src="${product.image}" 
                                 alt="${product.name}"
                                 onerror="handleImageError(this, '${product.name.replace(/'/g, "\\'")}')">
                        </div>
                        <div class="product-info">
                            <div class="product-name">${product.name}</div>
                            <div class="product-price-container">
                                ${product.showOriginalPrice ? `<span class="original-price">$${product.price}</span>` : ''}
                                <span class="product-price">$${product.discountedPrice}</span>
                                ${product.realDiscount > 0 ? `<span class="discount-percent">${product.realDiscount}% OFF</span>` : ''}
                            </div>
                            <div class="product-stock ${stockClass}">
                                ${stockText}
                            </div>
                            ${addButton}
                        </div>
                    </div>
                `;
            }).join("");
            
            setTimeout(() => {
                addCartEventListeners();
            }, 100);
            
            if (searchTerm) {
                const searchHeader = `
                    <div class="search-results">
                        <strong>üîç B√∫squeda inteligente: "${searchTerm}"</strong>
                        <br>
                        <small>Encontraste ${productsToShow.length} producto(s)</small>
                        <button onclick="clearSearch()" style="margin-left: 10px; padding: 6px 12px; 
                                background: #ff6f00; color: white; border: none; border-radius: 15px; 
                                cursor: pointer; font-size: 0.8rem;">
                            ‚úñÔ∏è Limpiar b√∫squeda
                        </button>
                    </div>
                `;
                productsGrid.innerHTML = searchHeader + productsGrid.innerHTML;
            }
        }

        function addCartEventListeners() {
            document.querySelectorAll(".add-to-cart").forEach(btn => {
                btn.replaceWith(btn.cloneNode(true));
            });
            
            document.querySelectorAll(".add-to-cart").forEach(btn => {
                btn.addEventListener("click", function() {
                    const productId = parseInt(this.getAttribute("data-id"));
                    addToCart(productId);
                });
            });
        }

        function addToCart(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            const availableStock = product.stockNumber;
            const maxAllowedStock = product.maxAllowedStock || availableStock;
            const existingItem = cart.find(item => item.id === productId);
            const currentQuantityInCart = existingItem ? existingItem.quantity : 0;
            
            // Verificar l√≠mite inverso
            if (currentQuantityInCart >= maxAllowedStock) {
                showStockError(product.name, availableStock, maxAllowedStock);
                return;
            }
            
            if (existingItem) {
                existingItem.quantity += 1;
                // RECALCULAR EL PRECIO CON LA NUEVA CANTIDAD
                existingItem.price = calculateDiscountedPrice(
                    product.price, 
                    product.promoCode, 
                    existingItem.quantity
                );
            } else {
                const initialPrice = calculateDiscountedPrice(
                    product.price, 
                    product.promoCode, 
                    1
                );
                
                cart.push({
                    id: product.id,
                    name: product.name,
                    price: initialPrice,
                    originalPrice: product.price,
                    hasPromo: product.hasPromo,
                    promoCode: product.promoCode,
                    promoDetails: product.promoDetails,
                    quantity: 1,
                    maxStock: maxAllowedStock,
                    availableStock: availableStock
                });
            }
            
            updateCartCount();
            showAddToCartFeedback(product.name);
        }

        function showAddToCartFeedback(productName) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 100px;
                left: 50%;
                transform: translateX(-50%);
                background: var(--primary);
                color: white;
                padding: 12px 20px;
                border-radius: 25px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                z-index: 1002;
                font-weight: 500;
                animation: slideDown 0.3s ease;
            `;
            notification.innerHTML = `‚úÖ ${productName} agregado al carrito`;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 2000);
        }

        function updateCartCount() {
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            cartCount.textContent = totalItems;
            floatingCartCount.textContent = totalItems;
        }

        function openCart() {
            renderCartItems();
            cartModal.style.display = "flex";
        }

        function closeCartModal() {
            cartModal.style.display = "none";
        }

        function renderCartItems() {
            if (cart.length === 0) {
                cartItems.innerHTML = "<p>Tu carrito est√° vac√≠o</p>";
                cartTotal.textContent = "Total: $0";
                return;
            }
            
            let totalNormalPrice = 0;
            let totalWithPromos = 0;
            let totalSavings = 0;
            let cartItemsHTML = '';
            
            cart.forEach(item => {
                const itemNormalPrice = item.originalPrice * item.quantity;
                const itemFinalPrice = item.price * item.quantity;
                const itemSavings = itemNormalPrice - itemFinalPrice;
                
                totalNormalPrice += itemNormalPrice;
                totalWithPromos += itemFinalPrice;
                totalSavings += itemSavings;
                
                const discountPercent = item.price < item.originalPrice 
                    ? Math.round(((item.originalPrice - item.price) / item.originalPrice) * 100)
                    : 0;
                
                cartItemsHTML += `
                    <div class="cart-item">
                        <div class="cart-item-info">
                            <div class="cart-item-name">${item.name}</div>
                            <div class="cart-item-price">
                                ${item.price < item.originalPrice 
                                    ? `<span style="text-decoration: line-through; color: #999; margin-right: 5px;">$${item.originalPrice}</span>` 
                                    : ''}
                                $${item.price} c/u
                                ${discountPercent > 0 ? `<span style="color: #4caf50; font-size: 0.8rem; margin-left: 5px;">(${discountPercent}% OFF)</span>` : ''}
                                <br>
                                <small style="color: #666; font-size: 0.75rem;">
                                    L√≠mite: ${item.quantity}/${item.maxStock}u (Stock: ${item.availableStock}u)
                                </small>
                            </div>
                        </div>
                        <div class="cart-item-quantity">
                            <button class="quantity-btn" data-id="${item.id}" data-action="decrease">-</button>
                            <span class="quantity-value">${item.quantity}</span>
                            <button class="quantity-btn" data-id="${item.id}" data-action="increase">+</button>
                        </div>
                    </div>
                `;
            });
            
            cartItems.innerHTML = cartItemsHTML;
            
            let totalHTML = '';
            if (totalSavings > 0) {
                totalHTML = `
                    <div class="cart-total">
                        <div>Subtotal normal: $${totalNormalPrice}</div>
                        <div class="total-savings">
                            üéâ ¬°Ahorras: $${totalSavings}!
                        </div>
                        <div><strong>Total a pagar: $${totalWithPromos}</strong></div>
                    </div>
                `;
            } else {
                totalHTML = `
                    <div class="cart-total">
                        <div><strong>Total: $${totalNormalPrice}</strong></div>
                    </div>
                `;
            }
            
            cartTotal.innerHTML = totalHTML;
            
            document.querySelectorAll(".quantity-btn").forEach(btn => {
                btn.addEventListener("click", function() {
                    const productId = parseInt(this.getAttribute("data-id"));
                    const action = this.getAttribute("data-action");
                    updateCartItemQuantity(productId, action);
                });
            });
        }

        function updateCartItemQuantity(productId, action) {
            const item = cart.find(item => item.id === productId);
            if (!item) return;
            
            if (action === "increase") {
                if (item.quantity >= item.maxStock) {
                    showStockError(item.name, item.availableStock, item.maxStock);
                    return;
                }
                item.quantity += 1;
            } else if (action === "decrease") {
                item.quantity -= 1;
                if (item.quantity <= 0) {
                    cart = cart.filter(i => i.id !== productId);
                    updateCartCount();
                    renderCartItems();
                    return;
                }
            }
            
            const product = products.find(p => p.id === productId);
            if (product) {
                // CALCULAR NUEVO PRECIO CON LA CANTIDAD ACTUALIZADA
                item.price = calculateDiscountedPrice(
                    product.price, 
                    product.promoCode, 
                    item.quantity
                );
            }
            
            updateCartCount();
            renderCartItems();
        }

        function handleImageError(imgElement, productName) {
            console.log('‚ö†Ô∏è Imagen no encontrada para:', productName);
            imgElement.src = `https://via.placeholder.com/200x150/E8F5E9/1B5E20?text=${encodeURIComponent(productName.substring(0, 20))}`;
        }

        document.addEventListener("DOMContentLoaded", init);
    </script>
</body>
</html>