<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Almac√©n Copihue - Productos de calidad con la confianza de siempre</title>
    
    <!-- META TAGS PARA PWA -->
    <meta name="theme-color" content="#2e7d32">
    <meta name="description" content="Almac√©n Copihue">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Almac√©n Copihue">
    
    <!-- SISTEMA ANTI-CACHE CAPA 1 -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <!-- ICONOS -->
    <link rel="icon" href="iconos-pwa/android/android-launchericon-48-48.png" type="image/png">
    <link rel="apple-touch-icon" href="iconos-pwa/ios/180.png">
    <link rel="apple-touch-icon" sizes="152x152" href="iconos-pwa/ios/152.png">
    <link rel="apple-touch-icon" sizes="167x167" href="iconos-pwa/ios/167.png">
    <link rel="apple-touch-icon" sizes="180x180" href="iconos-pwa/ios/180.png">
    <link rel="apple-touch-startup-image" href="iconos-pwa/ios/1024.png">
    
    <!-- MANIFEST EXTERNO -->
    <link rel="manifest" href="manifest.json">
    
    <!-- ESTILOS -->
    <style>
        :root {
            --primary: #2e7d32;
            --primary-dark: #1b5e20;
            --primary-light: #4caf50;
            --secondary: #ff6f00;
            --secondary-dark: #f57c00;
            --accent: #ffeb3b;
            --light: #f8fff8;
            --dark: #1b5e20;
            --gray: #757575;
            --white: #ffffff;
            --card-bg: #ffffff;
            --shadow: 0 4px 15px rgba(46,125,50,0.1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--light);
            color: var(--dark);
            line-height: 1.6;
            background-image: linear-gradient(135deg, #f8fff8 0%, #e8f5e9 100%);
        }
        
        header {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: var(--white);
            padding: 1rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow);
        }
        
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .logo-icon {
            font-size: 1.8rem;
        }

        .admin-badge {
            background: var(--secondary);
            color: white;
            padding: 0.2rem 0.6rem;
            border-radius: 12px;
            font-size: 0.7rem;
            margin-left: 0.5rem;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        .cart-icon {
            position: relative;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: background 0.3s;
        }
        
        .cart-icon:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .cart-count {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--secondary);
            color: white;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }
        
        .hero {
            background: linear-gradient(135deg, rgba(46,125,50,0.9), rgba(76,175,80,0.8));
            background-size: cover;
            color: white;
            padding: 3rem 1rem;
            text-align: center;
            border-radius: 15px;
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
        }
        
        .hero h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .hero p {
            font-size: 1.1rem;
            margin-bottom: 1rem;
            opacity: 0.9;
        }
        
        .info-bar {
            background-color: var(--white);
            padding: 1.2rem;
            border-radius: 12px;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-around;
            text-align: center;
            border-left: 4px solid var(--secondary);
        }
        
        .info-item {
            margin: 0.5rem;
            font-weight: 500;
        }
        
        .featured-offers {
            margin-bottom: 2rem;
            text-align: center;
        }
        
        .featured-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding: 0 0.5rem;
        }
        
        .featured-title {
            font-size: 1.5rem;
            color: var(--primary);
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .view-all-offers {
            background: linear-gradient(135deg, #ff6f00, #f57c00);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9rem;
            transition: all 0.3s;
        }
        
        .view-all-offers:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255,111,0,0.3);
        }
        
        .search-container {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            padding: 1rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #e8f5e9;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-radius: 12px;
            position: relative;
        }
        
        .search-wrapper {
            position: relative;
            width: 100%;
        }
        
        .search-input {
            width: 100%;
            padding: 14px 50px 14px 20px;
            border: 2px solid var(--primary);
            border-radius: 25px;
            font-size: 1rem;
            background: white;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(46,125,50,0.1);
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--primary-dark);
            box-shadow: 0 0 0 3px rgba(46,125,50,0.2);
        }
        
        .clear-search {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: var(--gray);
            transition: color 0.3s;
            padding: 5px;
            z-index: 2;
            display: none;
        }
        
        .clear-search:hover {
            color: var(--primary);
        }
        
        .search-results {
            text-align: center;
            padding: 12px;
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            border-radius: 10px;
            margin-bottom: 1rem;
            border-left: 4px solid #2196f3;
        }

        /* CATEGOR√çAS */
        .category-btn {
            background: #29B6F6;
            border: 2px solid #0288D1;
            color: #FFFFFF;
            box-shadow: 0 2px 6px rgba(2, 136, 209, 0.2);
            font-weight: 600;
            padding: 0.7rem 1.2rem;
            border-radius: 25px;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.25s ease;
            position: relative;
            user-select: none;
        }

        .category-btn.active {
            background: #0288D1;
            border-color: #29B6F6;
            color: #FFFFFF;
            box-shadow: 0 4px 12px rgba(41, 182, 246, 0.3);
            transform: translateY(-1px);
        }

        @media (hover: hover) {
            .category-btn:hover:not(.active) {
                background: #03A9F4;
                border-color: #0277BD;
                transform: translateY(-1px);
                box-shadow: 0 3px 8px rgba(2, 119, 189, 0.25);
            }
            .category-btn.active:hover {
                background: #0277BD;
                border-color: #4FC3F7;
            }
        }

        .offer-count-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #FF6F00;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: bold;
            min-width: 20px;
            text-align: center;
            border: 2px solid #FFFFFF;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 1;
        }

        @media (min-width: 768px) {
            .categories {
                display: flex;
                flex-wrap: wrap;
                gap: 0.8rem;
                margin-bottom: 2rem;
                justify-content: flex-start;
            }
            
            .category-btn {
                padding: 0.8rem 1.5rem;
                font-size: 0.9rem;
                min-width: auto;
            }
            
            .offer-count-badge {
                top: -6px;
                right: -6px;
                font-size: 0.75rem;
                padding: 2px 6px;
                min-width: 22px;
            }
        }

        @media (max-width: 767px) {
            .categories {
                display: flex;
                overflow-x: auto;
                gap: 0.6rem;
                margin-bottom: 1.5rem;
                padding-bottom: 0.5rem;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: thin;
                scrollbar-color: #0288D1 #e8f5e9;
            }
            
            .categories::-webkit-scrollbar {
                height: 6px;
            }
            
            .categories::-webkit-scrollbar-track {
                background: #e8f5e9;
                border-radius: 10px;
            }
            
            .categories::-webkit-scrollbar-thumb {
                background: #0288D1;
                border-radius: 10px;
            }
            
            .category-btn {
                padding: 0.8rem 1rem;
                font-size: 0.85rem;
                min-width: max-content;
                flex-shrink: 0;
            }
            
            .offer-count-badge {
                top: -5px;
                right: -5px;
                font-size: 0.65rem;
                padding: 1px 4px;
                min-width: 18px;
            }
        }
        
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        @media (min-width: 1200px) {
            .products-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        @media (min-width: 768px) and (max-width: 1199px) {
            .products-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 767px) {
            .products-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .cart-icon {
                display: none;
            }
            
            .featured-header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }
        }

        @media (max-width: 480px) {
            .products-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .product-card {
            background-color: var(--card-bg);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            border: 1px solid #e8f5e9;
            position: relative;
        }
        
        .product-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 8px 25px rgba(46,125,50,0.15);
        }
        
        .offer-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: linear-gradient(135deg, #ff6f00, #f57c00);
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.75rem;
            font-weight: bold;
            z-index: 10;
            box-shadow: 0 3px 10px rgba(255,111,0,0.3);
        }
        
        .promo-badge {
            position: absolute;
            top: 40px;
            right: 10px;
            background: linear-gradient(135deg, #4caf50, #2e7d32);
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.7rem;
            font-weight: bold;
            z-index: 10;
            box-shadow: 0 3px 10px rgba(46,125,50,0.3);
        }
        
        .product-image {
            height: 160px;
            background: linear-gradient(135deg, #e8f5e8, #c8e6c9);
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0.8rem;
            position: relative;
            overflow: hidden;
        }
        
        .product-image img {
            max-width: 100%;
            max-height: 130px;
            object-fit: contain;
            transition: transform 0.3s ease;
        }
        
        .product-card:hover .product-image img {
            transform: scale(1.05);
        }
        
        .product-info {
            padding: 1rem;
        }
        
        .product-name {
            font-weight: 600;
            margin-bottom: 0.4rem;
            font-size: 0.9rem;
            color: var(--dark);
            line-height: 1.3;
        }
        
        .product-price-container {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 0.5rem;
        }
        
        .original-price {
            color: var(--gray);
            text-decoration: line-through;
            font-size: 0.9rem;
        }
        
        .product-price {
            color: var(--secondary);
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        .discount-percent {
            background: #ffeb3b;
            color: #333;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: bold;
        }
        
        .product-stock {
            font-size: 0.75rem;
            margin-bottom: 0.8rem;
            font-weight: 500;
        }
        
        .in-stock {
            color: var(--primary-light);
        }
        
        .out-of-stock {
            color: var(--gray);
        }

        .low-stock {
            color: #ff9800;
            font-weight: bold;
        }
        
        .add-to-cart {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            border: none;
            padding: 0.7rem;
            border-radius: 8px;
            width: 100%;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .add-to-cart:hover {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary));
            transform: translateY(-2px);
        }
        
        .add-to-cart:disabled {
            background: var(--gray);
            cursor: not-allowed;
            transform: none;
        }

        .cart-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .cart-content {
            background-color: var(--white);
            width: 90%;
            max-width: 500px;
            border-radius: 15px;
            padding: 1.5rem;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow);
        }
        
        .cart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            border-bottom: 2px solid #e8f5e9;
            padding-bottom: 0.8rem;
        }
        
        .close-cart {
            background: none;
            border: none;
            font-size: 1.8rem;
            cursor: pointer;
            color: var(--gray);
            transition: color 0.3s;
        }
        
        .close-cart:hover {
            color: var(--primary);
        }
        
        .cart-items {
            margin-bottom: 1rem;
        }
        
        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.8rem 0;
            border-bottom: 1px solid #e8f5e9;
        }
        
        .cart-item-info {
            flex-grow: 1;
        }
        
        .cart-item-name {
            font-weight: bold;
            color: var(--dark);
        }
        
        .cart-item-price {
            color: var(--gray);
            font-size: 0.9rem;
        }
        
        .cart-item-quantity {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .quantity-btn {
            background-color: var(--light);
            border: 1px solid #c8e6c9;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .quantity-btn:hover {
            background-color: var(--primary-light);
            color: white;
        }
        
        .quantity-value {
            margin: 0 0.5rem;
            font-weight: bold;
            min-width: 20px;
            text-align: center;
        }
        
        .cart-total {
            font-weight: bold;
            font-size: 1.3rem;
            text-align: right;
            margin-bottom: 1rem;
            color: var(--primary);
            padding-top: 1rem;
            border-top: 2px solid #e8f5e9;
        }
        
        .total-savings {
            background: #4caf50;
            color: white;
            padding: 0.8rem;
            border-radius: 8px;
            margin: 0.5rem 0;
            text-align: center;
            font-weight: bold;
        }
        
        .send-order {
            background: linear-gradient(135deg, var(--secondary), var(--secondary-dark));
            color: white;
            border: none;
            padding: 1.2rem;
            border-radius: 10px;
            width: 100%;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .send-order:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255,111,0,0.3);
        }
        
        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--gray);
            font-size: 1.1rem;
        }
        
        .error-message {
            text-align: center;
            padding: 2rem;
            color: #d32f2f;
            background: #ffebee;
            border-radius: 10px;
            margin: 1rem 0;
            border-left: 4px solid #d32f2f;
        }
        
        .retry-btn {
            margin-top: 10px;
            padding: 10px 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.3s;
        }
        
        .retry-btn:hover {
            background: var(--primary-dark);
        }
        
        footer {
            background: linear-gradient(135deg, var(--dark), var(--primary));
            color: var(--white);
            padding: 2rem 1rem;
            text-align: center;
            margin-top: 3rem;
        }
        
        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
        }

        .admin-notification {
            background: linear-gradient(135deg, #ff9800, #f57c00);
            color: white;
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            text-align: center;
            animation: slideIn 0.5s ease;
        }

        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* PWA */
        .install-prompt {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 15px 20px;
            border-radius: 50px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            cursor: pointer;
            z-index: 1000;
            display: none;
            align-items: center;
            gap: 10px;
            font-weight: bold;
            font-size: 16px;
            animation: slideUp 0.5s ease;
            border: 2px solid white;
        }
        
        @keyframes slideUp {
            from { transform: translateY(100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .install-prompt:hover {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary));
            transform: scale(1.05);
        }
        
        .success-notification {
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: #4CAF50;
            color: white;
            padding: 15px 30px;
            border-radius: 50px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            z-index: 10000;
            font-weight: bold;
            text-align: center;
            animation: fadeInOut 3s ease;
        }
        
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
            20% { opacity: 1; transform: translateX(-50%) translateY(0); }
            80% { opacity: 1; transform: translateX(-50%) translateY(0); }
            100% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
        }

        /* FLOTANTE CELULAR */
        .floating-cart {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, var(--secondary), var(--secondary-dark));
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(255,111,0,0.4);
            z-index: 999;
            transition: all 0.3s ease;
            font-size: 1.5rem;
        }
        
        .floating-cart:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(255,111,0,0.6);
        }
        
        .floating-cart .cart-count {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--primary);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.8rem;
            font-weight: bold;
            border: 2px solid white;
        }

        .floating-search {
            position: fixed;
            bottom: 90px;
            right: 20px;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: none;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(46,125,50,0.4);
            z-index: 998;
            transition: all 0.3s ease;
            font-size: 1.5rem;
        }
        
        .floating-search:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(46,125,50,0.6);
        }

        .search-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1001;
            justify-content: center;
            align-items: flex-start;
            padding-top: 80px;
        }
        
        .search-modal-content {
            background-color: var(--white);
            width: 90%;
            max-width: 500px;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
        }
        
        .search-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            border-bottom: 2px solid #e8f5e9;
            padding-bottom: 0.8rem;
        }
        
        .close-search {
            background: none;
            border: none;
            font-size: 1.8rem;
            cursor: pointer;
            color: var(--gray);
            transition: color 0.3s;
        }
        
        .close-search:hover {
            color: var(--primary);
        }

        @media (max-width: 767px) {
            .search-container {
                display: none;
            }
            
            .floating-search {
                display: flex;
            }
        }

        .stock-notification {
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: #f44336;
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1002;
            font-weight: 500;
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from { 
                transform: translateX(-50%) translateY(-20px); 
                opacity: 0; 
            }
            to { 
                transform: translateX(-50%) translateY(0); 
                opacity: 1; 
            }
        }
        .search-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            z-index: 1000;
            max-height: 300px;
            overflow-y: auto;
            display: none;
        }
        
        .suggestion-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
        }
        
        .suggestion-item:hover {
            background: #f5f5f5;
        }
        
        .suggestion-name {
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .suggestion-details {
            font-size: 0.8rem;
            color: #666;
        }
        
        .suggestion-badge {
            background: #ff9800;
            color: white;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 0.7rem;
        }

        .mobile-search-results {
            margin-top: 1rem;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .promo-limit {
            font-size: 0.7rem;
            color: #666;
            margin-bottom: 5px;
            font-style: italic;
        }
        
        .offer-description {
            font-size: 0.8rem;
            color: #ff6f00;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .limit-notification {
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: #ff9800;
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1002;
            font-weight: 500;
            animation: slideDown 0.3s ease;
        }
        
        .tipo-venta-icon {
            font-size: 0.8rem;
            margin-right: 4px;
            vertical-align: middle;
        }
        
        .stock-tipo {
            display: inline-block;
            margin-left: 5px;
            font-size: 0.7rem;
            color: #666;
            font-weight: 500;
        }
        /* Ocultar bot√≥n de Ver productos con oferta */
        #viewAllOffers {
            display: none !important;
        }
        /* Ocultar bot√≥n Ver productos con oferta en TODA la p√°gina */
        #viewAllOffers,
        .view-all-offers {
            display: none !important;
        }
        /* Bot√≥n "Compartir esta OFERTA" (solo aparece en la mayor oferta) */
        .share-offer-btn {
            margin-top: 8px;
            width: 100%;
            padding: 10px 14px;
            border: none;
            border-radius: 18px;
            font-size: 14px;
            font-weight: 600;
            background: linear-gradient(135deg,#00c853,#00b14a);
            color: white;
            cursor: pointer;
            box-shadow: 0 3px 12px rgba(0,0,0,0.18);
        }
        .share-offer-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 18px rgba(0,0,0,0.22);
        }

        /* NUEVOS ESTILOS PARA TEXTO DE OFERTA PROGRESIVA */
        .progressive-offer-info {
            background: #e8f5e9;
            border-radius: 8px;
            padding: 8px 10px;
            margin: 5px 0 10px 0;
            border-left: 3px solid #4CAF50;
            font-size: 0.75rem;
        }
        
        .progressive-level {
            display: inline-block;
            margin-right: 6px;
            padding: 2px 6px;
            background: #4CAF50;
            color: white;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.7rem;
        }
        
        .progressive-text {
            color: #1b5e20;
            font-weight: 500;
        }
        
        .progressive-highlight {
            color: #ff6f00;
            font-weight: bold;
        }
        
        /* ESTILOS PARA OFERTA 3x2 ESPEC√çFICOS */
        .oferta-3x2-detalle {
            background: #fff8e1;
            border-radius: 8px;
            padding: 8px 10px;
            margin: 5px 0 10px 0;
            border-left: 3px solid #ff9800;
            font-size: 0.75rem;
            color: #5d4037;
        }
        
        .oferta-3x2-titulo {
            font-weight: bold;
            color: #ff6f00;
            margin-bottom: 3px;
        }
        
        .oferta-3x2-ejemplo {
            font-size: 0.7rem;
            color: #795548;
        }
        
        /* ESTILOS PARA BOT√ìN CASITA FLOTANTE */
        .floating-home {
            position: fixed;
            bottom: 160px;
            right: 20px;
            background: linear-gradient(135deg, #2196F3, #0D47A1);
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(33, 150, 243, 0.4);
            z-index: 997;
            transition: all 0.3s ease;
            font-size: 1.8rem;
        }

        .floating-home:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(33, 150, 243, 0.6);
        }

        /* Ajustar posici√≥n de otros botones flotantes */
        .floating-search {
            bottom: 90px; /* Subimos la b√∫squeda */
        }

        .floating-cart {
            bottom: 20px; /* El carrito queda abajo */
        }

        /* En m√≥vil, reorganizar los botones */
        @media (max-width: 767px) {
            .floating-home {
                bottom: 150px;
                right: 20px;
                width: 55px;
                height: 55px;
                font-size: 1.6rem;
            }
            
            .floating-search {
                bottom: 85px;
                width: 55px;
                height: 55px;
                font-size: 1.3rem;
            }
            
            .floating-cart {
                bottom: 20px;
                width: 55px;
                height: 55px;
                font-size: 1.3rem;
            }
            
            .floating-cart .cart-count {
                width: 22px;
                height: 22px;
                font-size: 0.7rem;
            }
        }
    </style>
</head>
<body>
<header>
    <div class="header-content">
        <div class="logo">
            <img src="iconos-pwa/android/android-launchericon-48-48.png" alt="Logo Almac√©n Copihue" class="logo-icon">
            Almac√©n Copihue
            <span id="adminBadge" class="admin-badge" style="display: none;">ADMIN</span>
        </div>
        <div class="cart-icon" id="cartIcon">
            üõí <span class="cart-count" id="cartCount">0</span>
        </div>
    </div>
</header>
    <div class="container">
        <div id="adminNotification" class="admin-notification" style="display: none;">
            <strong>üîî MODO ADMIN ACTIVADO</strong> - Recibir√°s alertas de stock bajo
        </div>

        <section class="hero">
            <h1>"Almac√©n Copihue"</h1>
            <p>Productos de calidad con la confianza de siempre</p>
        </section>

        <section class="info-bar">
            <div class="info-item">
                <strong>üìç Retiro en el local:</strong> Copihue 457
            </div>
            <div class="info-item">
                <strong>üìû WhatsApp:</strong> +5492944907380
            </div>
            <div class="info-item">
                <strong>‚è∞ Horario:</strong> 11:30 a 23:30 hrs.
            </div>
        </section>

        <section class="featured-offers" id="featuredOffers" style="display: none;">
            <div class="featured-header">
                <div class="featured-title">
                    üî• OFERTAS DESTACADAS
                </div>
                <button class="view-all-offers" id="viewAllOffers">
                    Ver todas las ofertas
                </button>
            </div>
            <div class="products-grid" id="featuredProductsGrid">
                <!-- Ofertas destacadas din√°micas -->
            </div>
        </section>

        <div class="search-container" id="desktopSearch">
            <div class="search-wrapper">
                <input type="text" id="productSearch" class="search-input" 
                       placeholder="üîç Buscar productos por nombre, abreviatura o sin√≥nimo...">
                <button class="clear-search" id="clearSearchBtn">‚úñÔ∏è</button>
                <div id="searchSuggestions" class="search-suggestions"></div>
            </div>
        </div>

        <!-- CATEGOR√çAS √öNICAS - SCROLL HORIZONTAL EN M√ìVIL -->
        <section class="categories" id="categories">
            <!-- Categor√≠as din√°micas -->
        </section>

        <section class="products-grid" id="productsGrid">
            <div class="loading">üîÑ Cargando productos desde Google Sheets...</div>
        </section>
    </div>

    <!-- BOTONES FLOTANTES -->
    <div class="floating-home" id="floatingHome">
        üè†
    </div>
    
    <div class="floating-search" id="floatingSearch">
        üîç
    </div>

    <div class="floating-cart" id="floatingCart">
        üõí
        <span class="cart-count" id="floatingCartCount">0</span>
    </div>

    <div class="search-modal" id="searchModal">
        <div class="search-modal-content">
            <div class="search-modal-header">
                <h2>Buscar Productos</h2>
                <button class="close-search" id="closeSearch">&times;</button>
            </div>
            <div class="search-wrapper">
                <input type="text" id="mobileSearch" class="search-input" 
                       placeholder="üîç Escribe nombre, abreviatura o sin√≥nimo..."
                       onkeydown="handleMobileSearchEnter(event)">
                <button class="clear-search" id="clearMobileSearchBtn">‚úñÔ∏è</button>
            </div>
            <div class="mobile-search-results" id="mobileSearchResults">
                <!-- Resultados b√∫squeda m√≥vil -->
            </div>
        </div>
    </div>

    <div class="cart-modal" id="cartModal">
        <div class="cart-content">
            <div class="cart-header">
                <h2>Tu Pedido</h2>
                <button class="close-cart" id="closeCart">&times;</button>
            </div>
            <div class="cart-items" id="cartItems">
                <!-- Items del carrito -->
            </div>
            <div class="cart-total" id="cartTotal">Total: $0</div>
            <button class="send-order" id="sendOrder">Enviar Pedido por WhatsApp</button>
        </div>
    </div>

    <div class="install-prompt" id="installPrompt">
        <span>üì± Instalar App</span>
    </div>

<div class="ios-instructions" id="iosInstructions" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 10000; justify-content: center; align-items: center; padding: 20px;">
    <div style="background: white; border-radius: 20px; padding: 30px; max-width: 400px; text-align: center; position: relative;">
        <!-- Bot√≥n cerrar (X) -->
        <button onclick="document.getElementById('iosInstructions').style.display='none'" 
                style="position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 24px; cursor: pointer; color: #666; padding: 5px; line-height: 1;">
            &times;
        </button>
        
        <h2 style="color: #2e7d32; margin-bottom: 20px; padding-right: 30px;">üì± Instalar en iPhone/iPad</h2>
        <div style="text-align: left; margin: 20px 0; font-size: 16px; line-height: 1.8;">
            <p>1. Toca el bot√≥n <strong style="color: #2e7d32;">Compartir</strong> üì§</p>
            <p>2. Despl√°zate hacia abajo</p>
            <p>3. Selecciona <strong style="color: #2e7d32;">"Agregar a Inicio"</strong></p>
            <p>4. Toca <strong style="color: #2e7d32;">"Agregar"</strong></p>
        </div>
        <button onclick="document.getElementById('iosInstructions').style.display='none'" 
                style="background: #2e7d32; color: white; border: none; padding: 12px 30px; 
                       border-radius: 25px; font-size: 16px; font-weight: bold; cursor: pointer; 
                       margin-top: 10px; width: 100%;">
            Entendido
        </button>
    </div>
</div>

    <footer>
        <div class="footer-content">
            <p>Almac√©n Copihue - Productos de calidad con la confianza de siempre</p>
            <p>üìç Copihue 457 | üìû +5492944907380 | ‚è∞ 11:30 a 23:30 hrs.</p>
        </div>
    </footer>

    <script>
// ========== SISTEMA ANTI-CACHE CAPA 2 ==========
// VERSI√ìN FORZADA - CAMBIA ESTO CON CADA ACTUALIZACI√ìN
const APP_VERSION = '20241216-v10-CALCULOS-CORREGIDOS';

// ‚úÖ OBJETO OFERTAS ACTUALIZADO
const OFERTAS_SISTEMA = {
    '2': {
        nombre: "2x1",
        eslogan: "üí• ¬°2x1! - Llev√° 2, Pag√° 1",
        tipo: "2x1",
        ejemplo: "2 unidades = 50% OFF (¬°MITAD DE PRECIO!)",
        color: "#d50000",
        descuentoReal: 50
    },
    '1': {
        nombre: "3x2",
        eslogan: "üéØ 3x2 - Llev√° 3, Pag√° 2",
        tipo: "3x2",
        ejemplo: "3 unidades = 33% OFF (una GRATIS)",
        color: "#ff6f00",
        descuentoReal: 33
    },
    '3': {
        nombre: "4x3",
        eslogan: "üèÜ 4x3 - Llev√° 4, Pag√° 3",
        tipo: "4x3",
        ejemplo: "4 unidades = 25% OFF",
        color: "#2196f3",
        descuentoReal: 25
    },
    '4': {
        nombre: "5x4",
        eslogan: "üíé 5x4 - Llev√° 5, Pag√° 4",
        tipo: "5x4",
        ejemplo: "5 unidades = 20% OFF",
        color: "#9c27b0",
        descuentoReal: 20
    },
    '5': {
        nombre: "6x5",
        eslogan: "üëë 6x5 - Llev√° 6, Pag√° 5",
        tipo: "6x5",
        ejemplo: "6 unidades = 17% OFF",
        color: "#ff4081",
        descuentoReal: 17
    },
    '25': {
        nombre: "2da 50%",
        eslogan: "üî• 2da UNIDAD 50% OFF",
        tipo: "2da50",
        ejemplo: "2 unidades = 25% OFF total",
        color: "#f57c00",
        descuentoReal: 25
    },
    '30': {
        nombre: "30% 2da+",
        eslogan: "‚ö° 30% OFF desde la 2da",
        tipo: "30progresivo",
        ejemplo: "2 unidades = 15% c/u, 3+ = 20% c/u",
        color: "#4caf50",
        descuentoReal: 15
    }
};

// ‚úÖ FUNCI√ìN CORREGIDA: Calcular precio unitario con descuento
function calcularPrecioConDescuento(precioUnitario, cantidad, descuento) {
    if (!descuento || descuento === '' || descuento === '0') {
        return precioUnitario;
    }
    
    let precioTotal = precioUnitario * cantidad;
    
    // ‚úÖ 1. Descuento porcentual (ej: 10% OFF)
    if (descuento.includes('%')) {
        const porcentaje = parseFloat(descuento.replace('% OFF', '').replace('%', '')) / 100;
        precioTotal = precioUnitario * cantidad * (1 - porcentaje);
    }
    
    // ‚úÖ 2. Oferta "X por Y" (ej: 3x2, 2x1)
    if (descuento.includes('x')) {
        const partes = descuento.split('x');
        const lleva = parseInt(partes[0]);
        const paga = parseInt(partes[1]);
        
        if (cantidad >= lleva && lleva > 0 && paga > 0) {
            const gruposCompletos = Math.floor(cantidad / lleva);
            const unidadesSobrantes = cantidad % lleva;
            precioTotal = (gruposCompletos * paga * precioUnitario) + (unidadesSobrantes * precioUnitario);
        }
    }
    
    // ‚úÖ 3. Redondear SOLO SI TIENE DECIMALES
    const precioUnitarioFinal = precioTotal / cantidad;
    
    if (precioUnitarioFinal % 1 === 0) {
        return precioUnitarioFinal;
    } else {
        return Math.round(precioUnitarioFinal);
    }
}

// ‚úÖ FUNCI√ìN NUEVA: Calcular total por producto (para WhatsApp y totales)
function calcularTotalPorProducto(precioUnitario, cantidad, descuento) {
    if (!descuento || descuento === '' || descuento === '0') {
        return precioUnitario * cantidad;
    }
    
    let total = precioUnitario * cantidad;
    
    // Descuento porcentual
    if (descuento.includes('%')) {
        const porcentaje = parseFloat(descuento.replace('% OFF', '').replace('%', '')) / 100;
        total = precioUnitario * cantidad * (1 - porcentaje);
    }
    
    // Oferta "X por Y"
    if (descuento.includes('x')) {
        const partes = descuento.split('x');
        const lleva = parseInt(partes[0]);
        const paga = parseInt(partes[1]);
        
        if (cantidad >= lleva && lleva > 0 && paga > 0) {
            const gruposCompletos = Math.floor(cantidad / lleva);
            const unidadesSobrantes = cantidad % lleva;
            total = (gruposCompletos * paga * precioUnitario) + (unidadesSobrantes * precioUnitario);
        }
    }
    
    // Redondear total
    return Math.round(total);
}

// ‚úÖ FUNCI√ìN PARA CALCULAR DESCUENTO REAL (SOLO PARA ADMIN)
function calcularDescuentoReal(precioOriginal, precioFinal) {
    if (precioOriginal <= 0 || precioFinal >= precioOriginal) return 0;
    return Math.round(((precioOriginal - precioFinal) / precioOriginal) * 100);
}

// ‚úÖ FUNCI√ìN PARA OBTENER DESCRIPCI√ìN DE OFERTA
function obtenerDescripcionOferta(ofertas1, ofertas2, precioOriginal, cantidad = 1) {
    if (ofertas2 && !isNaN(parseInt(ofertas2))) {
        const descuento = parseInt(ofertas2);
        if (descuento > 0 && descuento <= 100) {
            const precioConDescuento = calcularPrecioConDescuento(precioOriginal, ofertas1, ofertas2, 1);
            const ahorro = precioOriginal - precioConDescuento;
            return `üî• ¬°${descuento}% OFF! Ahorr√° $${Math.round(ahorro)} por unidad`;
        }
    }
    
    if (ofertas1 && OFERTAS_SISTEMA[ofertas1]) {
        const oferta = OFERTAS_SISTEMA[ofertas1];
        return oferta.eslogan;
    }
    
    return "";
}

// ‚úÖ FUNCI√ìN PARA TEXTO SIMPLIFICADO DE OFERTA
function obtenerTextoCortoOferta(ofertas1, ofertas2) {
    if (ofertas2 && !isNaN(parseInt(ofertas2))) {
        const descuento = parseInt(ofertas2);
        if (descuento > 0 && descuento <= 100) {
            return `üî• ${descuento}% OFF`;
        }
    }
    
    if (ofertas1 && OFERTAS_SISTEMA[ofertas1]) {
        const oferta = OFERTAS_SISTEMA[ofertas1];
        return `üéØ ${oferta.nombre}`;
    }
    
    return "";
}

// ‚úÖ FUNCI√ìN PARA DETALLE DE OFERTA 3x2
function obtenerDetalleOferta3x2(ofertas1, precioOriginal, cantidad = 1) {
    if (!ofertas1 || !OFERTAS_SISTEMA[ofertas1]) return "";
    
    const oferta = OFERTAS_SISTEMA[ofertas1];
    
    switch(oferta.tipo) {
        case '3x2':
            let detalle3x2 = `<div class="oferta-3x2-detalle">
                <div class="oferta-3x2-titulo">üéØ OFERTA 3x2 REAL</div>
                <div class="oferta-3x2-ejemplo">`;
            
            if (cantidad === 1) {
                detalle3x2 += `‚Ä¢ 1 unidad: $${precioOriginal} (normal)`;
            } else if (cantidad === 2) {
                detalle3x2 += `‚Ä¢ 2 unidades: $${precioOriginal * 2} (normales)`;
            } else if (cantidad === 3) {
                const precio3unidades = calcularTotalPorProducto(precioOriginal, 3, '3x2');
                detalle3x2 += `‚Ä¢ 3 unidades: $${precio3unidades} (la 3ra GRATIS)`;
            } else if (cantidad === 4) {
                const precio4unidades = calcularTotalPorProducto(precioOriginal, 4, '3x2');
                detalle3x2 += `‚Ä¢ 4 unidades: $${precio4unidades} (3x2 + 1 normal)`;
            } else if (cantidad === 6) {
                const precio6unidades = calcularTotalPorProducto(precioOriginal, 6, '3x2');
                detalle3x2 += `‚Ä¢ 6 unidades: $${precio6unidades} (2 paquetes 3x2)`;
            } else {
                detalle3x2 += oferta.ejemplo;
            }
            
            detalle3x2 += `</div></div>`;
            return detalle3x2;
            
        case '2da50':
            return `<div class="oferta-3x2-detalle">
                <div class="oferta-3x2-titulo">${oferta.eslogan}</div>
                <div class="oferta-3x2-ejemplo">${oferta.ejemplo}</div>
            </div>`;
            
        case '30progresivo':
            return `<div class="oferta-3x2-detalle">
                <div class="oferta-3x2-titulo">${oferta.eslogan}</div>
                <div class="oferta-3x2-ejemplo">${oferta.ejemplo}</div>
            </div>`;
            
        default:
            return "";
    }
}

// ‚úÖ FUNCI√ìN MAYOR OFERTA DEL D√çA
function obtenerMayorOfertaDelDia() {
    if (!products || products.length === 0) return null;
    
    const ofertas = products.filter(p => 
        Number(p.ofertas2) > 0 && 
        (p.stock === "STOCK" || p.stockNumber > 0)
    );
    
    if (ofertas.length === 0) return null;
    
    ofertas.sort((a, b) => Number(b.ofertas2) - Number(a.ofertas2));
    return ofertas[0];
}

// ‚úÖ FUNCI√ìN PARA ETIQUETA DE OFERTA DESTACADA
function obtenerEtiquetaOfertaDestacada(descuento) {
    const desc = Number(descuento);
    if (desc >= 50) return "üèÜ ¬°SUPER OFERT√ìN!";
    if (desc >= 30) return "üî• ¬°OFERT√ìN!";
    if (desc >= 20) return "‚ú® ¬°GRAN OFERTA!";
    if (desc > 0) return "üëç ¬°OFERTA!";
    return "";
}

// ‚úÖ FUNCI√ìN PARA COMPARTIR OFERTA
function compartirMegaOferta(id) {
    const producto = products.find(p => p.id === id);
    if (!producto) return;
    
    const mensaje = `ü§ù *¬°Vecino! Mir√° esta oferta del Almac√©n Copihue*\n\n` +
                    `üõí *${producto.name}*\n` +
                    `üí∞ Antes: $${producto.price}\n` +
                    `üî• **AHORA: $${producto.discountedPrice}**\n\n` +
                    `üìç Copihue 457\n` +
                    `üì± Pedila ac√°: ${window.location.href}\n\n` +
                    `*¬°Aprovechala!* üòâ`;
    
    if (navigator.share) {
        navigator.share({
            title: `Oferta: ${producto.name}`,
            text: mensaje,
            url: window.location.href
        });
    } else {
        const waUrl = `https://wa.me/?text=${encodeURIComponent(mensaje)}`;
        window.open(waUrl, "_blank");
    }
}

// ‚úÖ FUNCI√ìN PARA INFO ADMIN (SOLO SI ES ADMIN)
function mostrarInfoAdmin(producto) {
    if (!esAdmin) return '';
    
    let info = '<div style="font-size: 0.7rem; color: #666; background: #f5f5f5; padding: 5px; margin-top: 5px; border-radius: 5px; border-left: 3px solid #ff9800;">';
    info += '<strong>üëÅÔ∏è INFO ADMIN:</strong><br>';
    
    if (producto.ofertas2 && producto.ofertas2 !== '0') {
        info += `Ofertas2: ${producto.ofertas2}%<br>`;
    }
    if (producto.ofertas1 && producto.ofertas1 !== '0') {
        const oferta = OFERTAS_SISTEMA[producto.ofertas1];
        if (oferta) {
            info += `Ofertas1: ${oferta.nombre} (${oferta.descuentoReal}% real)<br>`;
        }
    }
    
    const descuentoReal = calcularDescuentoReal(producto.price, producto.discountedPrice);
    if (descuentoReal > 0) {
        info += `Descuento real: ${descuentoReal}%<br>`;
        info += `Precio unit. real: $${(producto.discountedPrice).toFixed(2)}`;
    }
    info += '</div>';
    
    return info;
}

// ‚úÖ FUNCIONES PARA L√çMITES DE OFERTAS2
function obtenerLimiteOfertas2(ofertas2) {
    if (!ofertas2 || ofertas2 === '') return null;
    
    const porcentaje = parseInt(ofertas2);
    if (isNaN(porcentaje)) return null;
    
    if (porcentaje >= 70 && porcentaje <= 99) {
        return 3;
    } else if (porcentaje >= 50 && porcentaje <= 69) {
        return 5;
    }
    
    return null;
}

// ‚úÖ FUNCI√ìN PARA TEXTO DE L√çMITE MEJORADA
function obtenerTextoLimiteOfertas2(ofertas2, nombreProducto = '') {
    const limite = obtenerLimiteOfertas2(ofertas2);
    if (limite === null) return '';
    
    const tipoVenta = obtenerTipoDeVenta(nombreProducto);
    
    switch(tipoVenta) {
        case 'peso':
            const nombreLower = nombreProducto.toLowerCase();
            if (nombreLower.includes('gr') || nombreLower.includes('gramo')) {
                return `<span class="tipo-venta-icon">‚öñÔ∏è</span> M√°x. ${limite * 1000} GRAMOS por familia`;
            } else {
                return `<span class="tipo-venta-icon">‚öñÔ∏è</span> M√°x. ${limite} KILOS por familia`;
            }
        case 'unidad':
            return `<span class="tipo-venta-icon">üì¶</span> M√°x. ${limite} UNIDADES por familia`;
        case 'empaque':
            return `<span class="tipo-venta-icon">üéÅ</span> M√°x. ${limite} PAQUETES por familia`;
        default:
            return `<span class="tipo-venta-icon">üì¶</span> M√°x. ${limite} unidades por familia`;
    }
}

// ‚úÖ FUNCI√ìN PARA TEXTO EN STOCK CON TIPO
function obtenerTextoStock(product) {
    const tipoVenta = obtenerTipoDeVenta(product.name);
    const stockNumber = product.stockNumber || 0;
    
    if (stockNumber === 0) {
        return '‚ùå Sin Stock';
    }
    
    let icono = '';
    let unidad = '';
    
    if (tipoVenta === 'peso') {
        const nombreLower = product.name.toLowerCase();
        
        if (nombreLower.includes(' gr') || nombreLower.includes('gramo') || 
            /\bgr\b/i.test(product.name)) {
            icono = '‚öñÔ∏è';
            unidad = `${stockNumber}g`;
        } else {
            icono = '‚öñÔ∏è';
            unidad = `${stockNumber}kg`;
        }
    } 
    else if (tipoVenta === 'unidad') {
        icono = 'üì¶';
        unidad = `${stockNumber}u`;
    }
    else if (tipoVenta === 'empaque') {
        icono = 'üéÅ';
        unidad = `${stockNumber}pqt`;
    }
    else {
        icono = 'üì¶';
        unidad = `${stockNumber}u`;
    }
    
    if (stockNumber > 0 && stockNumber <= 3) {
        return `‚ö†Ô∏è Stock Bajo ${icono} <span class="stock-tipo">(${unidad})</span>`;
    } else {
        return `‚úÖ En Stock ${icono} <span class="stock-tipo">(${unidad})</span>`;
    }
}

// ========== DETECCI√ìN DE TIPO DE VENTA ==========
function obtenerTipoDeVenta(nombreProducto) {
    const nombre = nombreProducto.toLowerCase().trim();
    
    const tieneGramosEspecificados = /\d+\s*(gr|g|gramo|gramos)\b/i.test(nombreProducto);
    if (tieneGramosEspecificados) {
        const esProductoSuelto = /^(jengibre|pimienta|comino|oregano|pimenton|laurel|provenzal)\s+gr?\b/i.test(nombreProducto);
        if (!esProductoSuelto) {
            return 'unidad';
        }
    }
    
    if (nombre.includes(' kg') || /\bkg\b/i.test(nombreProducto)) {
        const excepcionesUnidad = ['arroz', 'azucar', 'az√∫car', 'harina', 'sal', 'yerba', 'polenta', 'grasa'];
        const esExcepcion = excepcionesUnidad.some(ex => 
            nombre.includes(ex) && nombre.includes('1 kg')
        );
        if (!esExcepcion) return 'peso';
    }
    
    if (nombre.includes('gaseosa') || nombre.includes('jugo') || 
        nombre.includes('bebida') || nombre.includes('refresco') ||
        nombre.includes('agua') || nombre.includes('helado') ||
        nombre.includes('vino') || nombre.includes('cerveza') ||
        nombre.includes('fernet') || nombre.includes('manaos') ||
        nombre.includes('cunnington') || nombre.includes('powerade')) {
        return 'unidad';
    }
    
    if (nombre.includes('alfajor') || nombre.includes('galletita') ||
        nombre.includes('galleta') || nombre.includes('chocolate') ||
        nombre.includes('caramelo') || nombre.includes('chicle') ||
        nombre.includes('turron') || nombre.includes('golosina') ||
        nombre.includes('snack') || nombre.includes('budin') ||
        nombre.includes('pan dulce') || nombre.includes('pure de tomate') ||
        nombre.includes('salsa de tomate') || nombre.includes('pure') ||
        nombre.includes('salsa')) {
        return 'unidad';
    }
    
    const frutasVerduras = ['tomate', 'durazno', 'manzana', 'naranja', 
                           'cebolla', 'papa', 'zanahoria', 'lechuga',
                           'limon', 'mandarina', 'banana'];
    
    for (const fv of frutasVerduras) {
        if (nombre.includes(fv)) {
            if (!nombre.includes('unidad') && !nombre.includes('unid') && 
                !nombre.includes('u ') && !nombre.includes(' c/u')) {
                return 'peso';
            }
        }
    }
    
    const especiasSuelto = ['jengibre gr', 'pimienta gr', 'comino gr', 
                           'oregano gr', 'pimenton gr', 'laurel gr', 
                           'provenzal gr', 'aji molido gr'];
    
    for (const especia of especiasSuelto) {
        if (nombre.includes(especia)) {
            return 'peso';
        }
    }
    
    return 'unidad';
}

// ========== VARIABLES GLOBALES ==========
const SHEET_ID = '1hKeM-13t6wyGD5Ya4Rx9NeUJXsgJoVN4dOb-rklPznA';
let products = [];
let cart = [];
let currentCategory = "ALMACEN";
let lowStockAlertSent = false;
let esAdmin = false;
let isSearching = false;

// ========== ELEMENTOS DOM ==========
const categoriesContainer = document.getElementById("categories");
const productsGrid = document.getElementById("productsGrid");
const featuredOffers = document.getElementById("featuredOffers");
const featuredProductsGrid = document.getElementById("featuredProductsGrid");
const viewAllOffers = document.getElementById("viewAllOffers");
const cartIcon = document.getElementById("cartIcon");
const floatingCart = document.getElementById("floatingCart");
const floatingSearch = document.getElementById("floatingSearch");
const floatingHome = document.getElementById("floatingHome");
const searchModal = document.getElementById("searchModal");
const closeSearch = document.getElementById("closeSearch");
const mobileSearch = document.getElementById("mobileSearch");
const mobileSearchResults = document.getElementById("mobileSearchResults");
const cartModal = document.getElementById("cartModal");
const closeCart = document.getElementById("closeCart");
const cartItems = document.getElementById("cartItems");
const cartTotal = document.getElementById("cartTotal");
const cartCount = document.getElementById("cartCount");
const floatingCartCount = document.getElementById("floatingCartCount");
const sendOrder = document.getElementById("sendOrder");
const adminBadge = document.getElementById("adminBadge");
const adminNotification = document.getElementById("adminNotification");
const productSearch = document.getElementById("productSearch");
const clearSearchBtn = document.getElementById("clearSearchBtn");
const clearMobileSearchBtn = document.getElementById("clearMobileSearchBtn");
const searchSuggestions = document.getElementById("searchSuggestions");

// DICCIONARIO DE B√öSQUEDA
const SEARCH_DICTIONARY = {
    'tomate': ['tomates'],
    'durazno': ['duraznos'],
    'manzana': ['manzanas'],
    'naranja': ['naranjas'],
    'limon': ['limones'],
    'cebolla': ['cebollas'],
    'papa': ['papas'],
    'zanahoria': ['zanahorias'],
    'lechuga': ['lechugas'],
    'kg': ['kilo', 'kilos'],
    'gr': ['gramo', 'gramos'],
    'unid': ['unidad', 'unidades'],
    'alfajor': ['alfajores'],
    'alfajores': ['alfajor'],
    'galletita': ['galletitas', 'galletas'],
    'galleta': ['galletas', 'galletita'],
    'chocolate': ['chocolates'],
    'chocolates': ['chocolate']
};

// ========== FUNCIONES PRINCIPALES ==========
window.handleMobileSearchEnter = function(event) {
    if (event.key === 'Enter') {
        event.preventDefault();
        const searchTerm = mobileSearch.value.trim();
        if (searchTerm.length >= 2) {
            filterMobileProducts(searchTerm);
            mobileSearch.blur();
        }
    }
};

// ‚úÖ FUNCI√ìN CORREGIDA: Enviar pedido por WhatsApp
function sendOrderViaWhatsApp() {
    if (cart.length === 0) {
        alert("Tu carrito est√° vac√≠o.");
        return;
    }
    
    const phoneNumber = "5492944907380";
    
    let totalOriginal = 0;
    let totalConDescuentos = 0;
    let totalRedondeado = 0;
    let totalAhorro = 0;
    let orderLines = [];
    let ofertasCount = 0;
    let itemsCount = cart.reduce((sum, item) => sum + item.quantity, 0);

    // ‚úÖ PROCESAR CADA PRODUCTO CON C√ÅLCULOS CORRECTOS
    cart.forEach(item => {
        const product = products.find(p => p.id === item.id);
        if (!product) return;
        
        // Precio original (sin descuentos)
        const precioOriginalTotal = product.price * item.quantity;
        totalOriginal += precioOriginalTotal;
        
        // ‚úÖ CALCULAR TOTAL CORRECTO con ofertas
        const totalConOfertas = calcularTotalPorProducto(
            product.price,
            item.quantity,
            product.ofertas2 || product.ofertas1 || ''
        );
        
        totalConDescuentos += totalConOfertas;
        
        // ‚úÖ Calcular ahorro
        const ahorroProducto = precioOriginalTotal - totalConOfertas;
        totalAhorro += ahorroProducto;
        
        // Contar ofertas
        if (ahorroProducto > 0) {
            ofertasCount++;
        }
        
        // ‚úÖ Calcular precio unitario "te√≥rico" para WhatsApp
        let precioUnitarioWhatsapp = product.price;
        if (product.ofertas1 === '1' && item.quantity >= 3) { // 3x2
            precioUnitarioWhatsapp = Math.round(totalConOfertas / item.quantity);
        } else if (product.ofertas2 && product.ofertas2 !== '0') { // % OFF
            const descuento = parseInt(product.ofertas2) / 100;
            precioUnitarioWhatsapp = Math.round(product.price * (1 - descuento));
        }
        
        // ‚úÖ L√≠nea del producto para WhatsApp
        const nombreUpper = product.name.toUpperCase();
        let tipoOferta = '';
        
        if (product.ofertas2 && product.ofertas2 !== '0') {
            const descuento = parseInt(product.ofertas2);
            if (descuento >= 50) tipoOferta = ` (¬°OFERT√ìN!)`;
            else if (descuento >= 30) tipoOferta = ` (¬°GRAN OFERTA!)`;
            else tipoOferta = ` (¬°OFERTA!)`;
        } else if (product.ofertas1 && product.ofertas1 !== '0') {
            if (OFERTAS_SISTEMA[product.ofertas1]) {
                tipoOferta = ` (${OFERTAS_SISTEMA[product.ofertas1].nombre})`;
            }
        }
        
        let descripcion = `‚úÖ ${nombreUpper}${tipoOferta}\n`;
        descripcion += `   ${item.quantity} √ó $${precioUnitarioWhatsapp} = $${totalConOfertas}`;
        
        // Agregar detalle para 3x2
        if (product.ofertas1 === '1' && item.quantity >= 3) {
            const grupos3x2 = Math.floor(item.quantity / 3);
            if (grupos3x2 > 0) {
                descripcion += `\n   üéØ ¬°Llev√° ${grupos3x2 * 3}, pag√° ${grupos3x2 * 2}!`;
            }
        }
        
        orderLines.push(descripcion);
    });

    totalRedondeado = totalConDescuentos;
    const porcentajeAhorro = totalOriginal > 0 ? Math.round((totalAhorro / totalOriginal) * 100) : 0;
    
    // ‚úÖ CONSTRUIR MENSAJE CORRECTO
    let message = `üõí PEDIDO ALMAC√âN COPIHUE\n`;
    message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
    message += `üì¶ *TU COMPRA:*\n\n`;
    
    orderLines.forEach(line => {
        message += line + '\n\n';
    });
    
    message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
    
    if (ofertasCount > 0) {
        const textoOfertas = ofertasCount === 1 ? '1 OFERTA' : `${ofertasCount} OFERTAS`;
        message += `üéä *¬°GENIAL! APROVECHASTE ${textoOfertas}!*\n`;
    }
    
    message += `üõçÔ∏è  *Productos:* ${cart.length} items\n`;
    message += `üìä *Unidades:* ${itemsCount}\n\n`;
    
    if (totalAhorro > 0) {
        message += `üí∞ *Precio original:* $${totalOriginal.toFixed(0)}\n`;
        message += `‚ö° *¬°AHORRASTE $${totalAhorro.toFixed(0)}!*\n`;
        message += `üéØ *Descuento total: ${porcentajeAhorro}%*\n\n`;
    }
    
    message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
    message += `üíµ *TOTAL A PAGAR:* $${totalRedondeado.toFixed(0)}\n`;
    message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
    
    message += `üöÄ *¬°TU PEDIDO EST√Å LISTO!*\n\n`;
    message += `üìç *Direcci√≥n:* Copihue 457\n`;
    message += `‚è∞ *Horario:* 11:30 a 23:30 hs\n`;
    message += `üì± *Confirm√° por este WhatsApp*\n\n`;
    message += `#Almac√©nCopihue #PreciosDeBarrio`;
    
    const encodedMessage = encodeURIComponent(message);
    const whatsappURL = `https://wa.me/${phoneNumber}?text=${encodedMessage}`;
    
    // Vaciar carrito despu√©s de enviar
    cart = [];
    updateCartCount();
    closeCartModal();
    
    // Mostrar notificaci√≥n
    showSuccessNotification(`‚úÖ Pedido listo para enviar por WhatsApp`);
    
    // Abrir WhatsApp despu√©s de un breve retraso
    setTimeout(() => {
        window.open(whatsappURL, "_blank");
    }, 800);
}

// ‚úÖ FUNCI√ìN AUXILIAR: Mostrar notificaci√≥n
function showSuccessNotification(mensaje) {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 100px;
        left: 50%;
        transform: translateX(-50%);
        background: #4CAF50;
        color: white;
        padding: 15px 25px;
        border-radius: 25px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        z-index: 10000;
        font-weight: bold;
        text-align: center;
        animation: fadeInOut 3s ease;
    `;
    notification.textContent = mensaje;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 3000);
}

// ========== B√öSQUEDA ==========
function normalizeSearchTerm(term) {
    let normalized = term.toLowerCase().trim();
    normalized = normalized.replace(/[^\w\s]/g, ' ');
    normalized = normalized.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
    normalized = normalized.replace(/\s+/g, ' ');
    return normalized;
}

function expandSearchTerms(searchTerm) {
    const normalizedTerm = normalizeSearchTerm(searchTerm);
    const words = normalizedTerm.split(' ');
    const expandedTerms = new Set();
    
    expandedTerms.add(normalizedTerm);
    
    words.forEach(word => {
        if (word.length < 2) return;
        
        expandedTerms.add(word);
        
        for (const [key, synonyms] of Object.entries(SEARCH_DICTIONARY)) {
            if (key === word) {
                synonyms.forEach(synonym => expandedTerms.add(synonym));
            }
            
            if (synonyms.includes(word)) {
                expandedTerms.add(key);
                synonyms.forEach(synonym => expandedTerms.add(synonym));
            }
        }
    });
    
    if (words.length > 1) {
        expandedTerms.add(words.join(''));
        expandedTerms.add(words.join('-'));
        
        if (words.length === 2) {
            expandedTerms.add(`${words[1]} ${words[0]}`);
        }
    }
    
    return Array.from(expandedTerms);
}

function searchProducts(searchTerm) {
    if (!products || products.length === 0) return [];
    if (searchTerm.length < 2) return [];
    
    const expandedTerms = expandSearchTerms(searchTerm);
    
    const results = products.filter(product => {
        const productName = normalizeSearchTerm(product.name);
        const hasStock = product.stock === "STOCK" || product.stockNumber > 0;
        
        if (!hasStock) return false;
        
        return expandedTerms.some(term => {
            if (productName.includes(term) && term.length > 1) return true;
            
            if (term.length <= 3 && term.length > 1) {
                const initials = productName.split(' ')
                    .map(word => word.charAt(0))
                    .join('');
                if (initials.includes(term)) return true;
            }
            
            if (term.length > 3) {
                if (productName.includes(term.substring(0, Math.max(3, term.length - 1)))) {
                    return true;
                }
            }
            
            return false;
        });
    });
    
    results.sort((a, b) => {
        const nameA = normalizeSearchTerm(a.name);
        const nameB = normalizeSearchTerm(b.name);
        
        const exactMatchA = expandedTerms.some(term => nameA === term);
        const exactMatchB = expandedTerms.some(term => nameB === term);
        
        if (exactMatchA && !exactMatchB) return -1;
        if (!exactMatchA && exactMatchB) return 1;
        
        if (a.stockNumber !== b.stockNumber) {
            return b.stockNumber - a.stockNumber;
        }
        
        if (a.hasPromo !== b.hasPromo) {
            return b.hasPromo - a.hasPromo;
        }
        
        return 0;
    });
    
    return results;
}

// ========== CARGA DE PRODUCTOS DESDE TU GOOGLE SHEETS ==========
async function loadProductsFromSheets() {
    try {
        productsGrid.innerHTML = '<div class="loading">üîÑ Cargando 400+ productos desde Google Sheets...</div>';
        
        const SHEET_URL = `https://docs.google.com/spreadsheets/d/1hKeM-13t6wyGD5Ya4Rx9NeUJXsgJoVN4dOb-rklPznA/gviz/tq?tqx=out:csv&gid=0&t=${Date.now()}`;
        
        console.log('üì° Conectando a:', SHEET_URL);
        
        const proxyUrls = [
            `https://corsproxy.io/?${encodeURIComponent(SHEET_URL)}`,
            `https://api.allorigins.win/get?url=${encodeURIComponent(SHEET_URL)}`,
            SHEET_URL
        ];
        
        let csvData = '';
        let success = false;
        
        for (let i = 0; i < proxyUrls.length; i++) {
            try {
                console.log(`üîÑ Probando conexi√≥n ${i+1}...`);
                const response = await fetch(proxyUrls[i]);
                
                if (response.ok) {
                    const text = await response.text();
                    
                    if (proxyUrls[i].includes('api.allorigins.win')) {
                        try {
                            const jsonData = JSON.parse(text);
                            csvData = jsonData.contents;
                        } catch {
                            csvData = text;
                        }
                    } else {
                        csvData = text;
                    }
                    
                    success = true;
                    console.log('‚úÖ Conexi√≥n exitosa');
                    break;
                }
            } catch (error) {
                console.log(`‚ùå Intento ${i+1} fall√≥:`, error.message);
            }
        }
        
        if (!success) {
            throw new Error("No se pudo conectar a Google Sheets");
        }
        
        processYourSheetsData(csvData);
        
    } catch (error) {
        console.error('‚ùå Error cargando productos:', error);
        
        productsGrid.innerHTML = `
            <div class="error-message">
                <strong>‚ö†Ô∏è Error temporal</strong>
                <p>No se pudieron cargar los productos desde Google Sheets.</p>
                <p><small>${error.message}</small></p>
                <div style="margin-top: 15px;">
                    <button onclick="loadProductsFromSheets()" class="retry-btn">
                        üîÑ Reintentar conexi√≥n
                    </button>
                    <button onclick="loadDemoProducts()" class="retry-btn" style="background: #ff9800; margin-left: 10px;">
                        üöÄ Cargar datos de demostraci√≥n
                    </button>
                </div>
            </div>
        `;
        
        setTimeout(loadDemoProducts, 3000);
    }
}

// ========== PROCESAR DATOS DE TU HOJA ESPEC√çFICA ==========
function processYourSheetsData(csvText) {
    console.log('üìä Procesando datos de tu hoja...');
    
    let cleanText = csvText;
    if (csvText.includes('<!DOCTYPE') || csvText.includes('<html')) {
        const csvMatch = csvText.match(/"Producto","Precio".*?(?=\n\n|\r\n\r\n)/s);
        if (csvMatch) {
            cleanText = csvMatch[0];
        } else {
            throw new Error('Google Sheets devolvi√≥ una p√°gina de error');
        }
    }
    
    const lines = cleanText.split(/\r?\n/)
        .map(line => line.trim())
        .filter(line => line && line.length > 0 && !line.startsWith('<!--'));
    
    console.log(`üìà Total de l√≠neas: ${lines.length}`);
    
    if (lines.length < 2) {
        throw new Error('La hoja parece estar vac√≠a o tiene formato incorrecto');
    }
    
    const headers = parseCSVLine(lines[0]);
    console.log('üè∑Ô∏è Encabezados encontrados:', headers);
    
    const columnMap = {
        producto: findColumnIndex(headers, ['Producto', 'producto', 'Nombre', 'nombre']),
        precio: findColumnIndex(headers, ['Precio', 'precio', 'Valor', 'valor']),
        categoria: findColumnIndex(headers, ['Categor√≠a', 'categoria', 'Categoria', 'Rubro']),
        stock: findColumnIndex(headers, ['Stock', 'stock', 'Cantidad', 'cantidad']),
        ofertas1: findColumnIndex(headers, ['Ofertas1', 'ofertas1', 'Oferta1', 'oferta1']),
        ofertas2: findColumnIndex(headers, ['Ofertas2', 'ofertas2', 'Oferta2', 'oferta2'])
    };
    
    console.log('üó∫Ô∏è Columnas mapeadas:', columnMap);
    
    if (columnMap.producto === -1 || columnMap.precio === -1) {
        throw new Error('Formato de hoja incorrecto. Columnas "Producto" o "Precio" no encontradas');
    }
    
    products = [];
    let productsProcessed = 0;
    let productsWithErrors = 0;
    
    for (let i = 1; i < lines.length; i++) {
        try {
            const values = parseCSVLine(lines[i]);
            
            if (values.length < 2 || !values[0] || values[0].trim() === '') {
                continue;
            }
            
            const nombre = values[columnMap.producto] || 'Producto sin nombre';
            const precio = parseInt(values[columnMap.precio]) || 0;
            const categoria = columnMap.categoria !== -1 ? values[columnMap.categoria] : 'ALMACEN';
            const stockValue = columnMap.stock !== -1 ? values[columnMap.stock] : '10';
            const ofertas1 = columnMap.ofertas1 !== -1 ? values[columnMap.ofertas1] : '';
            const ofertas2 = columnMap.ofertas2 !== -1 ? values[columnMap.ofertas2] : '';
            
            let stockNumber = parseInt(stockValue);
            if (isNaN(stockNumber) || stockNumber < 0) stockNumber = 0;
            let stockStatus = "STOCK";
            if (stockNumber === 0) {
                stockStatus = "SIN STOCK";
            } else if (stockNumber > 0 && stockNumber <= 3) {
                stockStatus = "STOCK BAJO";
            }
            
            const precioConDescuento = calcularPrecioConDescuento(precio, ofertas1, ofertas2, 1);
            const descuentoReal = calcularDescuentoReal(precio, precioConDescuento);
            const tieneOferta = descuentoReal > 0;
            
            const product = {
                id: i,
                name: nombre,
                price: precio,
                category: categoria,
                stock: stockStatus,
                stockNumber: stockNumber,
                image: `imagenes-productos/${simplificarNombre(nombre)}.jpg`,
                hasPromo: tieneOferta,
                ofertas1: ofertas1,
                ofertas2: ofertas2,
                discountedPrice: precioConDescuento,
                discountPercent: descuentoReal,
                offerText: tieneOferta ? obtenerTextoCortoOferta(ofertas1, ofertas2) : '',
                tipoVenta: obtenerTipoDeVenta(nombre)
            };
            
            products.push(product);
            productsProcessed++;
            
        } catch (error) {
            productsWithErrors++;
            console.warn(`‚ö†Ô∏è Error procesando l√≠nea ${i+1}:`, error.message);
        }
    }
    
    console.log(`‚úÖ ${productsProcessed} productos procesados correctamente`);
    if (productsWithErrors > 0) {
        console.warn(`‚ö†Ô∏è ${productsWithErrors} productos con errores (ignorados)`);
    }
    
    if (products.length === 0) {
        throw new Error('No se pudieron procesar productos v√°lidos');
    }
    
    renderCategories();
    mostrarOfertasDestacadas();
    renderProducts();
    
    productsGrid.innerHTML = `
        <div style="background: #4CAF50; color: white; padding: 10px; border-radius: 10px; margin-bottom: 1rem; text-align: center;">
            ‚úÖ <strong>${products.length} productos cargados desde tu Google Sheets</strong>
        </div>
        ${productsGrid.innerHTML}
    `;
}

// ========== FUNCIONES AUXILIARES ==========
function parseCSVLine(line) {
    const result = [];
    let current = '';
    let inQuotes = false;
    
    for (let i = 0; i < line.length; i++) {
        const char = line[i];
        
        if (char === '"') {
            inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
            result.push(current.trim());
            current = '';
        } else {
            current += char;
        }
    }
    
    result.push(current.trim());
    return result.map(field => field.replace(/^"|"$/g, ''));
}

function findColumnIndex(headers, possibleNames) {
    const headerLower = headers.map(h => h.toLowerCase().trim());
    
    for (const name of possibleNames) {
        const nameLower = name.toLowerCase();
        const index = headerLower.findIndex(h => h === nameLower || h.includes(nameLower));
        if (index !== -1) return index;
    }
    
    return -1;
}

function simplificarNombre(nombre) {
    return nombre
        .toLowerCase()
        .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
        .replace(/[^a-z0-9 ]/g, "")
        .replace(/\s+/g, '-')
        .replace(/-+/g, '-')
        .trim();
}

// ========== DATOS DE DEMOSTRACI√ìN (RESPALDO) ==========
function loadDemoProducts() {
    console.log('üîÑ Cargando datos de demostraci√≥n...');
    
    products = [
        { 
            id: 1, 
            name: "TOMATE REDONDO KG", 
            price: 5000,
            category: "FRUTAS Y VERDURAS", 
            stock: "STOCK", 
            stockNumber: 10,
            image: "",
            hasPromo: true,
            ofertas1: "1",
            ofertas2: "",
            discountedPrice: calcularPrecioConDescuento(5000, "1", "", 1),
            discountPercent: 0,
            offerText: obtenerTextoCortoOferta("1", ""),
            tipoVenta: obtenerTipoDeVenta("TOMATE REDONDO KG")
        },
        { 
            id: 2, 
            name: "DURAZNOS x UNIDAD", 
            price: 350,
            category: "FRUTAS Y VERDURAS", 
            stock: "STOCK", 
            stockNumber: 50,
            image: "",
            hasPromo: true,
            ofertas1: "2",
            ofertas2: "",
            discountedPrice: calcularPrecioConDescuento(350, "2", "", 1),
            discountPercent: 0,
            offerText: obtenerTextoCortoOferta("2", ""),
            tipoVenta: obtenerTipoDeVenta("DURAZNOS x UNIDAD")
        },
        { 
            id: 3, 
            name: "ALFAJOR TRIPLE FANTOCHE BLANCO", 
            price: 2000,
            category: "ALMACEN", 
            stock: "STOCK", 
            stockNumber: 6,
            image: "",
            hasPromo: true,
            ofertas1: "",
            ofertas2: "10",
            discountedPrice: calcularPrecioConDescuento(2000, "", "10", 1),
            discountPercent: 10,
            offerText: obtenerTextoCortoOferta("", "10"),
            tipoVenta: obtenerTipoDeVenta("ALFAJOR TRIPLE FANTOCHE BLANCO")
        }
    ];
    
    productsGrid.innerHTML = `
        <div class="demo-banner">
            <strong>üîß MODO DEMO ACTIVADO</strong><br>
            <small>Usando datos de ejemplo. Tus 400+ productos est√°n en Google Sheets listos.</small>
            <br>
            <button onclick="loadProductsFromSheets()" style="margin-top: 10px; padding: 8px 16px; background: white; color: #ff9800; border: none; border-radius: 5px; font-weight: bold; cursor: pointer;">
                üîÑ Intentar cargar desde Google Sheets
            </button>
        </div>
        ${productsGrid.innerHTML}
    `;
    
    renderCategories();
    mostrarOfertasDestacadas();
    renderProducts();
}

// ========== INICIALIZACI√ìN MEJORADA ==========
function init() {
    console.log('üöÄ Inicializando Almac√©n Copihue v' + APP_VERSION);
    console.log('üìä Conectando a tu Google Sheets con 400+ productos...');
    
    detectarAdmin();
    
    setupEventListeners();
    setupSearch();
    updateCartCount();
    initPWA();
    
    loadProductsFromSheets();
    
    setTimeout(() => {
        console.log('‚úÖ Sistema listo. Bot√≥n üè† funcionando.');
    }, 1000);
}

document.addEventListener("DOMContentLoaded", init);

function detectarAdmin() {
    const urlParams = new URLSearchParams(window.location.search);
    esAdmin = urlParams.has('admin');
    
    if (esAdmin) {
        adminBadge.style.display = 'inline-block';
        adminNotification.style.display = 'block';
    }
}

function setupEventListeners() {
    cartIcon.addEventListener("click", openCart);
    floatingCart.addEventListener("click", openCart);
    floatingSearch.addEventListener("click", openSearchModal);
    floatingHome.addEventListener("click", scrollToTop);
    closeSearch.addEventListener("click", closeSearchModal);
    closeCart.addEventListener("click", closeCartModal);
    sendOrder.addEventListener("click", sendOrderViaWhatsApp);
    viewAllOffers.addEventListener("click", verTodasLasOfertas);
    
    clearSearchBtn.addEventListener("click", clearSearch);
    clearMobileSearchBtn.addEventListener("click", clearMobileSearch);
    
    cartModal.addEventListener("click", function(e) {
        if (e.target === cartModal) {
            closeCartModal();
        }
    });
    
    searchModal.addEventListener("click", function(e) {
        if (e.target === searchModal) {
            closeSearchModal();
        }
    });
}

// ========== FUNCI√ìN CASITA (HOME) ==========
function scrollToTop() {
    console.log('üè† CASITA INTELIGENTE - Posici√≥n actual:', window.scrollY + 'px');
    
    const categoriesElement = document.getElementById('categories');
    const categoriesPosition = categoriesElement ? categoriesElement.offsetTop : 300;
    const currentScroll = window.scrollY;
    
    const deberiaIrACategorias = currentScroll > categoriesPosition - 200;
    
    if (!deberiaIrACategorias) {
        console.log('   üìç Usuario arriba ‚Üí Scroll al INICIO');
        window.scrollTo({ top: 0, behavior: 'smooth' });
    } else {
        console.log('   üìç Usuario abajo ‚Üí Scroll a CATEGOR√çAS');
        const targetPosition = Math.max(0, categoriesPosition - 80);
        window.scrollTo({ top: targetPosition, behavior: 'smooth' });
    }
    
    console.log('   üìÅ Cambiando a categor√≠a: ALMACEN');
    currentCategory = "ALMACEN";
    
    document.querySelectorAll('.category-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.getAttribute('data-category') === "ALMACEN") {
            btn.classList.add('active');
            console.log('   ‚úÖ Bot√≥n ALMACEN activado');
        }
    });
    
    if (isSearching) {
        console.log('   üîç Limpiando b√∫squeda activa');
        clearSearch();
        isSearching = false;
    }
    
    setTimeout(() => {
        console.log('   üõçÔ∏è Mostrando productos de ALMACEN');
        renderProducts();
    }, 300);
    
    const mensajeFeedback = deberiaIrACategorias ? 
        "üè† Navegaci√≥n r√°pida a categor√≠as" : 
        "üè† Volviendo al inicio";
    showHomeFeedback(mensajeFeedback);
    
    setTimeout(() => {
        console.log('   üìè Nueva posici√≥n:', window.scrollY + 'px');
        console.log('   üéØ Categor√≠a:', currentCategory);
        console.log('   ‚úÖ CASITA INTELIGENTE - 100% FUNCIONAL');
    }, 500);
}

function showHomeFeedback(mensaje = "üè† Volviendo al inicio") {
    try {
        const oldNotifications = document.querySelectorAll('.home-feedback-notification');
        oldNotifications.forEach(el => el.remove());
        
        const notification = document.createElement('div');
        notification.className = 'home-feedback-notification';
        notification.innerHTML = mensaje;
        
        notification.style.cssText = `
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #2196F3, #0D47A1);
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.4);
            z-index: 99999;
            font-weight: 600;
            font-size: 14px;
            animation: slideDown 0.3s ease;
            border: 2px solid white;
            text-align: center;
            min-width: 200px;
            max-width: 80%;
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 1500);
        
    } catch (error) {
        console.warn('‚ö†Ô∏è Error en showHomeFeedback():', error);
    }
}

function setupSearch() {
    productSearch.addEventListener('input', function(e) {
        const searchTerm = e.target.value.toLowerCase().trim();
        toggleClearButton(clearSearchBtn, searchTerm);
        
        if (searchTerm === '') {
            clearSearch();
            return;
        }
        
        if (searchTerm.length >= 2) {
            filterProducts(searchTerm);
        }
    });
    
    productSearch.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            const searchTerm = this.value.trim();
            if (searchTerm.length >= 2) {
                filterProducts(searchTerm);
            }
        }
    });
    
    mobileSearch.addEventListener('input', function(e) {
        const searchTerm = e.target.value.toLowerCase().trim();
        toggleClearButton(clearMobileSearchBtn, searchTerm);
        
        if (searchTerm === '') {
            mobileSearchResults.innerHTML = '';
            return;
        }
        
        if (searchTerm.length >= 2) {
            filterMobileProducts(searchTerm);
        }
    });
}

function toggleClearButton(button, searchTerm) {
    button.style.display = searchTerm.length > 0 ? 'block' : 'none';
}

function openSearchModal() {
    searchModal.style.display = "flex";
    mobileSearch.focus();
    mobileSearchResults.innerHTML = '';
}

function closeSearchModal() {
    searchModal.style.display = "none";
    mobileSearch.value = '';
    mobileSearchResults.innerHTML = '';
    clearMobileSearchBtn.style.display = 'none';
}

function clearMobileSearch() {
    mobileSearch.value = '';
    mobileSearchResults.innerHTML = '';
    clearMobileSearchBtn.style.display = 'none';
}

function filterProducts(searchTerm) {
    if (!products || products.length === 0) return;
    
    isSearching = true;
    const filtered = searchProducts(searchTerm);
    renderFilteredProducts(filtered, searchTerm);
}

function filterMobileProducts(searchTerm) {
    if (!products || products.length === 0) return;
    
    const filtered = searchProducts(searchTerm);
    
    if (filtered.length === 0) {
        mobileSearchResults.innerHTML = `
            <div style="text-align: center; padding: 1rem; color: #666;">
                üîç No se encontraron productos para "<strong>${searchTerm}</strong>"
            </div>
        `;
        return;
    }
    
    let resultsHTML = '<div style="display: grid; gap: 1rem;">';
    
    filtered.forEach(product => {
        const stockText = obtenerTextoStock(product);
        
        let stockClass = '';
        if (product.stockNumber === 0) {
            stockClass = 'out-of-stock';
        } else if (product.stockNumber > 0 && product.stockNumber <= 3) {
            stockClass = 'low-stock';
        } else {
            stockClass = 'in-stock';
        }
        
        const addButton = product.stockNumber === 0
            ? `<button class="add-to-cart" disabled>‚ùå Sin Stock</button>`
            : `<button class="add-to-cart" data-id="${product.id}">üõí Agregar al Carrito</button>`;
        
        const textoCortoOferta = obtenerTextoCortoOferta(product.ofertas1, product.ofertas2);
        const offerBadge = textoCortoOferta 
            ? `<div class="offer-badge">${textoCortoOferta}</div>`
            : '';
        
        const descripcionOferta = obtenerDescripcionOferta(product.ofertas1, product.ofertas2, product.price);
        
        const detalleOferta = product.ofertas1 ? 
            obtenerDetalleOferta3x2(product.ofertas1, product.price, 1) : '';
        
        const textoLimiteOfertas2 = obtenerTextoLimiteOfertas2(product.ofertas2, product.name);
        
        resultsHTML += `
            <div class="product-card" style="margin: 0;">
                ${offerBadge}
                <div class="product-image">
                    <img src="${product.image}" 
                         alt="${product.name}"
                         onerror="handleImageError(this, '${product.name.replace(/'/g, "\\'")}')">
                </div>
                <div class="product-info">
                    <div class="product-name">${product.name}</div>
                    ${descripcionOferta ? `<div class="offer-description">${descripcionOferta}</div>` : ''}
                    ${detalleOferta}
                    <div class="product-price-container">
                        ${product.hasPromo && product.discountedPrice < product.price ? 
                            `<span class="original-price">$${product.price}</span>` : ''}
                        <span class="product-price">$${Math.round(product.discountedPrice)}</span>
                        ${textoCortoOferta ? 
                            `<span class="discount-percent">${textoCortoOferta.replace('üî• ', '').replace('üéØ ', '')}</span>` : ''}
                    </div>
                    ${textoLimiteOfertas2 ? `
                        <div class="promo-limit" style="color: #ff6f00; font-weight: 500;">
                            ${textoLimiteOfertas2}
                        </div>
                    ` : ''}
                    <div class="product-stock ${stockClass}">
                        ${stockText}
                    </div>
                    ${addButton}
                </div>
            </div>
        `;
    });
    
    resultsHTML += '</div>';
    mobileSearchResults.innerHTML = resultsHTML;
    
    setTimeout(() => {
        addCartEventListeners();
    }, 100);
}

function renderFilteredProducts(filteredProducts, searchTerm = '') {
    if (filteredProducts.length === 0) {
        productsGrid.innerHTML = `
            <div class="loading" style="text-align: center; padding: 2rem;">
                üîç No se encontraron productos para "<strong>${searchTerm}</strong>"
                <br><br>
                <button onclick="clearSearch()" class="retry-btn">
                    ‚ú® Ver todos los productos
                </button>
            </div>
        `;
        return;
    }
    
    renderProductsFromArray(filteredProducts, searchTerm);
}

function clearSearch() {
    productSearch.value = '';
    mobileSearch.value = '';
    isSearching = false;
    clearSearchBtn.style.display = 'none';
    clearMobileSearchBtn.style.display = 'none';

    currentCategory = "ALMACEN";

    renderProducts();

    document.querySelectorAll('.category-btn').forEach(btn => {
        btn.classList.toggle(
            'active',
            btn.getAttribute('data-category') === "ALMACEN"
        );
    });
}

function renderCategories() {
    const categories = [...new Set(products.map(p => p.category))];
    
    const ofertasPorCategoria = {};
    products.forEach(p => {
        if (p.hasPromo && (p.stock === "STOCK" || p.stockNumber > 0)) {
            ofertasPorCategoria[p.category] = (ofertasPorCategoria[p.category] || 0) + 1;
        }
    });
    
    categoriesContainer.innerHTML = categories.map(category => {
        let badge = '';
        
        if (ofertasPorCategoria[category]) {
            badge = `<span class="offer-count-badge">${ofertasPorCategoria[category]}üî•</span>`;
        }
        
        return `
            <button class="category-btn ${category === currentCategory ? 'active' : ''}" 
                    data-category="${category}">
                ${category} ${badge}
            </button>
        `;
    }).join("");
    
    if (categories.length > 0 && !currentCategory) {
        currentCategory = categories[0];
        const primeraCategoriaBtn = document.querySelector(`[data-category="${categories[0]}"]`);
        if (primeraCategoriaBtn) {
            primeraCategoriaBtn.classList.add('active');
        }
    }
    
    document.querySelectorAll(".category-btn").forEach(btn => {
        btn.addEventListener("click", function() {
            currentCategory = this.getAttribute("data-category");
            document.querySelectorAll(".category-btn").forEach(b => b.classList.remove("active"));
            this.classList.add("active");
            renderProducts();
        });
    });
}

// ‚úÖ FUNCI√ìN CORREGIDA: Agregar al carrito
function addToCart(productId) {
    const product = products.find(p => p.id === productId);
    if (!product) return;
    
    const availableStock = product.stockNumber;
    const existingItem = cart.find(item => item.id === productId);
    const currentQuantityInCart = existingItem ? existingItem.quantity : 0;
    
    if (currentQuantityInCart >= availableStock) {
        showStockError(product.name, availableStock);
        return;
    }
    
    // VERIFICAR L√çMITE DE OFERTAS2
    if (product.ofertas2) {
        const limiteOferta2 = obtenerLimiteOfertas2(product.ofertas2);
        if (limiteOferta2 !== null) {
            const newQuantity = currentQuantityInCart + 1;
            if (newQuantity > limiteOferta2) {
                showLimitError(product.name, limiteOferta2, `${product.ofertas2}% OFF`);
                return;
            }
        }
    }
    
    const newQuantity = currentQuantityInCart + 1;
    
    if (existingItem) {
        existingItem.quantity = newQuantity;
        // ‚úÖ RECALCULAR PRECIO UNITARIO CORRECTAMENTE
        existingItem.price = calcularPrecioConDescuento(
            product.price, 
            product.ofertas1, 
            product.ofertas2, 
            newQuantity
        );
    } else {
        // ‚úÖ PRECIO INICIAL CORRECTO
        const initialPrice = calcularPrecioConDescuento(
            product.price, 
            product.ofertas1, 
            product.ofertas2, 
            1
        );
        
        cart.push({
            id: product.id,
            name: product.name,
            price: initialPrice,
            originalPrice: product.price,
            hasPromo: product.hasPromo,
            ofertas1: product.ofertas1,
            ofertas2: product.ofertas2,
            quantity: 1,
            maxStock: availableStock,
            maxOferta2Limit: obtenerLimiteOfertas2(product.ofertas2)
        });
        
        // Mostrar feedback
        if (product.ofertas1 === '1') {
            showAddToCartFeedback(product.name, "3x2");
        } else if (product.ofertas2 && product.ofertas2 !== '0') {
            const descuento = parseInt(product.ofertas2);
            showAddToCartFeedback(product.name, `${descuento}% OFF`);
        } else {
            showAddToCartFeedback(product.name);
        }
    }
    
    updateCartCount();
    renderCartItems();
}

function showAddToCartFeedback(productName, tipoOferta = '') {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 100px;
        left: 50%;
        transform: translateX(-50%);
        background: var(--primary);
        color: white;
        padding: 12px 20px;
        border-radius: 25px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        z-index: 1002;
        font-weight: 500;
        animation: slideDown 0.3s ease;
    `;
    
    if (tipoOferta === '3x2') {
        notification.innerHTML = `‚úÖ ${productName} agregado (üéØ 3x2 activo)`;
    } else if (tipoOferta.includes('% OFF')) {
        notification.innerHTML = `‚úÖ ${productName} agregado (üî• ${tipoOferta})`;
    } else {
        notification.innerHTML = `‚úÖ ${productName} agregado al carrito`;
    }
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 2000);
}

function showStockError(productName, availableStock) {
    const notification = document.createElement('div');
    notification.className = 'stock-notification';
    notification.innerHTML = `‚ùå No hay suficiente stock de ${productName}. M√°ximo: ${availableStock} unidades`;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

function showLimitError(productName, limite, tipoOferta) {
    const notification = document.createElement('div');
    notification.className = 'limit-notification';
    notification.innerHTML = `‚ö†Ô∏è L√≠mite de ${tipoOferta}: M√°ximo ${limite} unidades por familia`;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

function updateCartCount() {
    const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
    cartCount.textContent = totalItems;
    floatingCartCount.textContent = totalItems;
}

function openCart() {
    renderCartItems();
    cartModal.style.display = "flex";
}

function closeCartModal() {
    cartModal.style.display = "none";
}

// ‚úÖ FUNCI√ìN CORREGIDA: Renderizar items del carrito
function renderCartItems() {
    if (cart.length === 0) {
        cartItems.innerHTML = "<p style='text-align: center; padding: 2rem; color: #666;'>Tu carrito est√° vac√≠o</p>";
        cartTotal.textContent = "Total: $0";
        return;
    }
    
    let totalNormalPrice = 0;
    let totalConOfertas = 0;
    let cartItemsHTML = '';
    
    cart.forEach(item => {
        const product = products.find(p => p.id === item.id);
        if (!product) return;
        
        // ‚úÖ CALCULAR TOTALES CORRECTOS
        const itemNormalPrice = product.price * item.quantity;
        const itemTotalConOfertas = calcularTotalPorProducto(
            product.price,
            item.quantity,
            product.ofertas2 || product.ofertas1 || ''
        );
        
        totalNormalPrice += itemNormalPrice;
        totalConOfertas += itemTotalConOfertas;
        
        // Calcular precio unitario mostrado
        const precioUnitarioMostrado = Math.round(itemTotalConOfertas / item.quantity);
        
        // Determinar texto de oferta
        let tipoOferta = '';
        if (product.ofertas2 && product.ofertas2 !== '0') {
            tipoOferta = ` <span style="color: #4CAF50; font-weight: bold;">(${product.ofertas2}% OFF)</span>`;
        } else if (product.ofertas1 && product.ofertas1 !== '0') {
            if (OFERTAS_SISTEMA[product.ofertas1]) {
                tipoOferta = ` <span style="color: #ff6f00; font-weight: bold;">(${OFERTAS_SISTEMA[product.ofertas1].nombre})</span>`;
            }
        }
        
        cartItemsHTML += `
            <div class="cart-item">
                <div class="cart-item-info">
                    <div class="cart-item-name">${item.name}${tipoOferta}</div>
                    <div class="cart-item-price">
                        $${precioUnitarioMostrado} c/u √ó ${item.quantity} = $${itemTotalConOfertas}
                        ${itemTotalConOfertas < itemNormalPrice 
                            ? `<span style="color: #4CAF50; margin-left: 5px;">(Ahorr√°s $${itemNormalPrice - itemTotalConOfertas})</span>` 
                            : ''}
                    </div>
                </div>
                <div class="cart-item-quantity">
                    <button class="quantity-btn decrease-btn" data-id="${item.id}">-</button>
                    <span class="quantity-value">${item.quantity}</span>
                    <button class="quantity-btn increase-btn" data-id="${item.id}">+</button>
                </div>
            </div>
        `;
    });
    
    cartItems.innerHTML = cartItemsHTML;
    cartTotal.textContent = `TOTAL A PAGAR: $${totalConOfertas}`;
    
    // Mostrar ahorro si existe
    if (totalConOfertas < totalNormalPrice) {
        const ahorroTotal = totalNormalPrice - totalConOfertas;
        const savingsElement = document.createElement('div');
        savingsElement.className = 'total-savings';
        savingsElement.textContent = `üéâ ¬°Ahorraste $${ahorroTotal}!`;
        cartTotal.parentNode.insertBefore(savingsElement, cartTotal);
    }
    
    // Event listeners para botones de cantidad
    document.querySelectorAll('.increase-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const productId = parseInt(this.getAttribute('data-id'));
            updateCartQuantity(productId, 1);
        });
    });
    
    document.querySelectorAll('.decrease-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const productId = parseInt(this.getAttribute('data-id'));
            updateCartQuantity(productId, -1);
        });
    });
}

function updateCartQuantity(productId, change) {
    const itemIndex = cart.findIndex(item => item.id === productId);
    if (itemIndex === -1) return;
    
    const item = cart[itemIndex];
    const product = products.find(p => p.id === productId);
    if (!product) return;
    
    const newQuantity = item.quantity + change;
    
    if (newQuantity < 1) {
        cart.splice(itemIndex, 1);
        updateCartCount();
        renderCartItems();
        return;
    }
    
    // VERIFICAR STOCK M√ÅXIMO
    if (newQuantity > product.stockNumber) {
        showStockError(product.name, product.stockNumber);
        return;
    }
    
    // VERIFICAR L√çMITE OFERTAS2
    if (product.ofertas2) {
        const limiteOferta2 = obtenerLimiteOfertas2(product.ofertas2);
        if (limiteOferta2 !== null && newQuantity > limiteOferta2) {
            showLimitError(product.name, limiteOferta2, `${product.ofertas2}% OFF`);
            return;
        }
    }
    
    item.quantity = newQuantity;
    
    // ‚úÖ RECALCULAR PRECIO CON EL NUEVO SISTEMA 3x2 REAL
    item.price = calcularPrecioConDescuento(
        product.price, 
        product.ofertas1, 
        product.ofertas2, 
        newQuantity
    );
    
    updateCartCount();
    renderCartItems();
    
    // Mostrar notificaci√≥n si hay descuento
    const precioOriginal = product.price;
    
    if (item.price < precioOriginal) {
        const descuento = Math.round(((precioOriginal - item.price) / precioOriginal) * 100);
        
        if (product.ofertas1 === '1' && newQuantity >= 3) {
            showAddToCartFeedback(product.name, "3x2");
        } else {
            showAddToCartFeedback(product.name, `${descuento}% OFF`);
        }
    }
}

function renderProductsToHTML(productsArray) {
    return productsArray.map(product => {
        const hasStock = product.stock === "STOCK" || product.stockNumber > 0;
        const isLowStock = product.stockNumber > 0 && product.stockNumber <= 3;
        const isOutOfStock = product.stockNumber === 0;
        
        const mayorOferta = obtenerMayorOfertaDelDia();
        const esMayorOferta = mayorOferta && mayorOferta.id === product.id;
        
        const etiquetaOferta = obtenerEtiquetaOfertaDestacada(product.ofertas2);

        const botonCompartir = esMayorOferta ? `
            <button class="share-offer-btn" onclick="compartirMegaOferta(${product.id})">
                ü§ù Compartir esta OFERTA
            </button>
        ` : '';
        
        const stockText = obtenerTextoStock(product);
        
        let stockClass = '';
        if (product.stockNumber === 0) {
            stockClass = 'out-of-stock';
        } else if (product.stockNumber > 0 && product.stockNumber <= 3) {
            stockClass = 'low-stock';
        } else {
            stockClass = 'in-stock';
        }
        
        const addButton = isOutOfStock 
            ? `<button class="add-to-cart" disabled>‚ùå Sin Stock</button>`
            : `<button class="add-to-cart" data-id="${product.id}">üõí Agregar al Carrito</button>`;
        
        const textoCortoOferta = obtenerTextoCortoOferta(product.ofertas1, product.ofertas2);
        const offerBadge = textoCortoOferta 
            ? `<div class="offer-badge">${textoCortoOferta}</div>`
            : '';
        
        const descripcionOferta = obtenerDescripcionOferta(
            product.ofertas1, 
            product.ofertas2,
            product.price
        );
        
        const detalleOferta = product.ofertas1 ? 
            obtenerDetalleOferta3x2(product.ofertas1, product.price, 1) : '';
        
        const textoLimiteOfertas2 = obtenerTextoLimiteOfertas2(product.ofertas2, product.name);
        
        return `
            <div class="product-card">
                ${offerBadge}
                ${esMayorOferta ? `<div class="promo-badge">üî• MEGA OFERTA</div>` : ''}
                <div class="product-image">
                    <img src="${product.image}" 
                         alt="${product.name}"
                         onerror="handleImageError(this, '${product.name.replace(/'/g, "\\'")}')">
                </div>
                <div class="product-info">
                    <div class="product-name">${product.name}</div>
                    ${descripcionOferta ? `<div class="offer-description">${descripcionOferta}</div>` : ''}
                    ${detalleOferta}
                    ${etiquetaOferta ? `<div class="offer-description" style="color: #d50000; font-weight: bold;">${etiquetaOferta}</div>` : ''}
                    ${esMayorOferta ? `<div class="offer-description" style="color: #d50000; font-weight: bold;">üéØ ¬°LA MEJOR OFERTA DEL D√çA!</div>` : ''}
                    <div class="product-price-container">
                        ${product.discountedPrice < product.price ? 
                            `<span class="original-price">$${product.price}</span>` : ''}
                        <span class="product-price">$${Math.round(product.discountedPrice)}</span>
                        ${textoCortoOferta ? 
                            `<span class="discount-percent">${textoCortoOferta.replace('üî• ', '').replace('üéØ ', '')}</span>` : ''}
                    </div>
                    ${textoLimiteOfertas2 ? `
                        <div class="promo-limit" style="color: #ff6f00; font-weight: 500;">
                            ${textoLimiteOfertas2}
                        </div>
                    ` : ''}
                    <div class="product-stock ${stockClass}">
                        ${stockText}
                    </div>
                    ${addButton}
                    ${botonCompartir}
                    ${esAdmin ? mostrarInfoAdmin(product) : ''}
                </div>
            </div>
        `;
    }).join("");
}

function mostrarOfertasDestacadas() {
    if (!products || products.length === 0) return;

    const productosConOferta = products.filter(p => 
        p.hasPromo && 
        p.stockNumber > 0
    );
    
    if (productosConOferta.length < 3) {
        featuredOffers.style.display = 'none';
        return;
    }
    
    productosConOferta.sort((a, b) => {
        const descA = Number(a.ofertas2) || 0;
        const descB = Number(b.ofertas2) || 0;
        
        if (descB !== descA) return descB - descA;
        
        const prioridad = {'3x2': 3, '2da50': 2, '30progresivo': 1, '': 0};
        const tipoA = OFERTAS_SISTEMA[a.ofertas1] ? OFERTAS_SISTEMA[a.ofertas1].tipo : '';
        const tipoB = OFERTAS_SISTEMA[b.ofertas1] ? OFERTAS_SISTEMA[b.ofertas1].tipo : '';
        
        return (prioridad[tipoB] || 0) - (prioridad[tipoA] || 0);
    });

    const productosDestacados = productosConOferta.slice(0, 9);

    if (productosDestacados.length > 0) {
        featuredOffers.style.display = 'block';
        featuredProductsGrid.innerHTML = renderProductsToHTML(productosDestacados);
        
        window.productosDestacadosIds = productosDestacados.map(p => p.id);
    } else {
        featuredOffers.style.display = 'none';
        window.productosDestacadosIds = [];
    }
}

function renderProducts() {
    let filteredProducts;
    
    filteredProducts = products.filter(p => 
        p.category === currentCategory && 
        (p.stock === "STOCK" || p.stockNumber > 0)
    );
    
    if (window.productosDestacadosIds && window.productosDestacadosIds.length > 0) {
        filteredProducts = filteredProducts.filter(p => 
            !window.productosDestacadosIds.includes(p.id)
        );
    }
    
    filteredProducts.sort((a, b) => {
        if (a.hasPromo && !b.hasPromo) return -1;
        if (!a.hasPromo && b.hasPromo) return 1;
        return 0;
    });
    
    renderProductsFromArray(filteredProducts);
}

function verTodasLasOfertas() {
    const categoriasConOfertas = [...new Set(products
        .filter(p => p.hasPromo && (p.stock === "STOCK" || p.stockNumber > 0))
        .map(p => p.category)
    )];
    
    if (categoriasConOfertas.length > 0) {
        currentCategory = categoriasConOfertas[0];
        document.querySelectorAll(".category-btn").forEach(b => b.classList.remove("active"));
        const ofertasBtn = document.querySelector(`[data-category="${categoriasConOfertas[0]}"]`);
        if (ofertasBtn) {
            ofertasBtn.classList.add("active");
        }
        renderProducts();
        
        document.querySelector('.products-grid').scrollIntoView({ behavior: 'smooth' });
    } else {
        alert("No hay ofertas disponibles en este momento");
    }
}

function renderProductsFromArray(productsArray, searchTerm = '') {
    const productsToShow = productsArray;
    
    if (productsToShow.length === 0) {
        let mensaje = '';
        mensaje = '<div class="loading">No hay productos disponibles</div>';
        productsGrid.innerHTML = mensaje;
        return;
    }
    
    productsGrid.innerHTML = renderProductsToHTML(productsToShow);
    
    setTimeout(() => {
        addCartEventListeners();
    }, 100);
    
    if (searchTerm) {
        const searchHeader = `
            <div class="search-results">
                <strong>üîç B√∫squeda inteligente: "${searchTerm}"</strong>
                <br>
                <small>Encontraste ${productsToShow.length} producto(s)</small>
                <button onclick="clearSearch()" style="margin-left: 10px; padding: 6px 12px; 
                        background: #ff6f00; color: white; border: none; border-radius: 15px; 
                        cursor: pointer; font-size: 0.8rem;">
                    ‚úñÔ∏è Limpiar b√∫squeda
                </button>
            </div>
        `;
        productsGrid.innerHTML = searchHeader + productsGrid.innerHTML;
    }
}

function addCartEventListeners() {
    document.querySelectorAll(".add-to-cart").forEach(btn => {
        btn.replaceWith(btn.cloneNode(true));
    });
    
    document.querySelectorAll(".add-to-cart").forEach(btn => {
        btn.addEventListener("click", function() {
            const productId = parseInt(this.getAttribute("data-id"));
            addToCart(productId);
        });
    });
}

function handleImageError(img, productName) {
    console.warn('Error cargando imagen:', img.src);
    
    const colors = ['#e8f5e9', '#f1f8e9', '#f9fbe7', '#fffde7', '#fff3e0'];
    const randomColor = colors[Math.floor(Math.random() * colors.length)];
    
    img.src = '';
    img.onerror = null;
    
    const container = img.parentElement;
    
    container.style.background = `linear-gradient(135deg, ${randomColor}, ${adjustColor(randomColor, -20)})`;
    container.style.display = 'flex';
    container.style.justifyContent = 'center';
    container.style.alignItems = 'center';
    container.style.position = 'relative';
    
    const icon = document.createElement('div');
    icon.innerHTML = 'üõí';
    icon.style.fontSize = '3rem';
    icon.style.opacity = '0.5';
    
    const text = document.createElement('div');
    text.textContent = productName.length > 20 ? productName.substring(0, 20) + '...' : productName;
    text.style.position = 'absolute';
    text.style.bottom = '10px';
    text.style.left = '0';
    text.style.right = '0';
    text.style.textAlign = 'center';
    text.style.fontSize = '0.7rem';
    text.style.color = '#666';
    text.style.padding = '0 10px';
    
    container.innerHTML = '';
    container.appendChild(icon);
    container.appendChild(text);
}

function adjustColor(color, amount) {
    const hex = color.replace('#', '');
    const num = parseInt(hex, 16);
    let r = (num >> 16) + amount;
    let g = ((num >> 8) & 0x00FF) + amount;
    let b = (num & 0x0000FF) + amount;
    
    r = Math.min(Math.max(0, r), 255);
    g = Math.min(Math.max(0, g), 255);
    b = Math.min(Math.max(0, b), 255);
    
    return `#${((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1)}`;
}

// ========== MONITOREO DE STOCK BAJO ==========
function verificarStockBajo() {
    if (!esAdmin) return;
    
    const lowStockProducts = products.filter(p => 
        p.stockNumber > 0 && p.stockNumber <= 3
    );
    
    if (lowStockProducts.length > 0 && !lowStockAlertSent) {
        lowStockAlertSent = true;
        
        const lowStockNotification = document.createElement('div');
        lowStockNotification.className = 'stock-notification';
        lowStockNotification.innerHTML = `
            ‚ö†Ô∏è <strong>ALERTA ADMIN:</strong> ${lowStockProducts.length} producto(s) con stock bajo
            <br>
            <small>${lowStockProducts.map(p => `${p.name} (${p.stockNumber})`).join(', ')}</small>
        `;
        
        document.body.appendChild(lowStockNotification);
        
        setTimeout(() => {
            lowStockNotification.remove();
            lowStockAlertSent = false;
        }, 10000);
    }
}

// ========== PWA INSTALACI√ìN ==========
let deferredPrompt;
const installPrompt = document.getElementById('installPrompt');

function isPWAInstalled() {
    return window.matchMedia('(display-mode: standalone)').matches || 
           window.navigator.standalone === true ||
           document.referrer.includes('android-app://');
}

function initPWA() {
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./sw.js?v=' + APP_VERSION)
            .then(registration => {
                console.log('‚úÖ Service Worker registrado:', registration.scope);
                
                setInterval(() => {
                    registration.update();
                }, 60 * 60 * 1000);
                
                registration.addEventListener('updatefound', () => {
                    const newWorker = registration.installing;
                    console.log('üîÑ Nueva versi√≥n del Service Worker encontrada');
                    
                    newWorker.addEventListener('statechange', () => {
                        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                            if (confirm('¬°Nueva versi√≥n disponible! ¬øRecargar para actualizar?')) {
                                window.location.reload();
                            }
                        }
                    });
                });
            })
            .catch(error => {
                console.error('‚ùå Error registrando Service Worker:', error);
            });
    }
    
    window.showSuccessMessage = function(message) {
        const notification = document.createElement('div');
        notification.className = 'success-notification';
        notification.textContent = message;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 3000);
    };
}

// ========== INICIALIZACI√ìN ==========
document.addEventListener("DOMContentLoaded", function() {
    init();
    
    setInterval(verificarStockBajo, 60000);
    
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.getRegistration().then(existingRegistration => {
                if (!existingRegistration) {
                    navigator.serviceWorker.register('sw.js?v=' + APP_VERSION)
                        .then(registration => {
                            console.log('‚úÖ Service Worker registrado (backup):', registration.scope);
                        })
                        .catch(error => {
                            console.error('‚ùå Error en registro backup:', error);
                        });
                } else {
                    console.log('‚úÖ Service Worker ya registrado:', existingRegistration.scope);
                }
            });
        });
    }
    
    setTimeout(() => {
        if (isPWAInstalled()) {
            console.log('üì± PWA ya instalada - Modo standalone activo');
            const installBtn = document.getElementById('installPrompt');
            if (installBtn) installBtn.style.display = 'none';
            
            const header = document.querySelector('header .logo');
            if (header) {
                header.innerHTML += '<span style="margin-left: 8px; font-size: 0.7rem; background: #4CAF50; color: white; padding: 2px 6px; border-radius: 10px;">APP</span>';
            }
        }
    }, 1000);
});

// ========== SISTEMA ANTI-CACHE CAPA 3 ==========
(function() {
    const versionGuardada = localStorage.getItem('almacen_version');
    
    if (versionGuardada !== APP_VERSION) {
        console.log('üîÑ Detecci√≥n de nueva versi√≥n:', APP_VERSION);
        localStorage.setItem('almacen_version', APP_VERSION);
        
        if (versionGuardada && versionGuardada !== '') {
            console.log('üîÑ Recargando para aplicar cambios...');
            setTimeout(() => {
                window.location.href = window.location.href.split('?')[0] + 
                                      '?v=' + APP_VERSION + 
                                      '&t=' + Date.now() + 
                                      '&cache=bust';
            }, 300);
        }
    } else {
        console.log('‚úÖ Versi√≥n actual:', APP_VERSION);
    }
})();
    </script>
</body>
</html>
