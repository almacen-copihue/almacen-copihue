<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Almac√©n Copihue - Productos de calidad con la confianza de siempre</title>
    
    <!-- META TAGS PARA PWA -->

    <meta name="theme-color" content="#2e7d32">
    <meta name="description" content="Almac√©n Copihue">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Almac√©n Copihue">
    
    <!-- SISTEMA ANTI-CACHE CAPA 1 -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <!-- ICONOS -->
    <link rel="icon" href="iconos-pwa/android/android-launchericon-48-48.png" type="image/png">
    <link rel="apple-touch-icon" href="iconos-pwa/ios/180.png">
    <link rel="apple-touch-icon" sizes="152x152" href="iconos-pwa/ios/152.png">
    <link rel="apple-touch-icon" sizes="167x167" href="iconos-pwa/ios/167.png">
    <link rel="apple-touch-icon" sizes="180x180" href="iconos-pwa/ios/180.png">
    <link rel="apple-touch-startup-image" href="iconos-pwa/ios/1024.png">
    
    <!-- MANIFEST EXTERNO -->
    <link rel="manifest" href="manifest.json">
    
    <!-- ESTILOS -->
    <style>
        :root {
            --primary: #2e7d32;
            --primary-dark: #1b5e20;
            --primary-light: #4caf50;
            --secondary: #ff6f00;
            --secondary-dark: #f57c00;
            --accent: #ffeb3b;
            --light: #f8fff8;
            --dark: #1b5e20;
            --gray: #757575;
            --white: #ffffff;
            --card-bg: #ffffff;
            --shadow: 0 4px 15px rgba(46,125,50,0.1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--light);
            color: var(--dark);
            line-height: 1.6;
            background-image: linear-gradient(135deg, #f8fff8 0%, #e8f5e9 100%);
        }
        
        header {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: var(--white);
            padding: 1rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow);
        }
        
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .logo-icon {
            font-size: 1.8rem;
        }

        .admin-badge {
            background: var(--secondary);
            color: white;
            padding: 0.2rem 0.6rem;
            border-radius: 12px;
            font-size: 0.7rem;
            margin-left: 0.5rem;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        .cart-icon {
            position: relative;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: background 0.3s;
        }
        
        .cart-icon:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .cart-count {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--secondary);
            color: white;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }
        
        .hero {
            background: linear-gradient(135deg, rgba(46,125,50,0.9), rgba(76,175,80,0.8));
            background-size: cover;
            color: white;
            padding: 3rem 1rem;
            text-align: center;
            border-radius: 15px;
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
        }
        
        .hero h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .hero p {
            font-size: 1.1rem;
            margin-bottom: 1rem;
            opacity: 0.9;
        }
        
        .info-bar {
            background-color: var(--white);
            padding: 1.2rem;
            border-radius: 12px;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-around;
            text-align: center;
            border-left: 4px solid var(--secondary);
        }
        
        .info-item {
            margin: 0.5rem;
            font-weight: 500;
        }
        
        /* ========== OFERTAS REL√ÅMPAGO ========== */
        .flash-sales-container {
            display: none;
            margin-bottom: 2rem;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 30px rgba(255, 0, 0, 0.15);
            border: 3px solid #ff3d00;
            position: relative;
            background: linear-gradient(135deg, #fff8e1, #ffecb3);
        }
        
        .flash-sales-header {
            background: linear-gradient(135deg, #ff3d00, #d50000);
            color: white;
            padding: 1rem;
            text-align: center;
            position: relative;
        }
        
        .flash-sales-header h2 {
            font-size: 1.4rem;
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .flash-badge {
            background: #ffff00;
            color: #d50000;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
            animation: flash 1.5s infinite;
        }
        
        @keyframes flash {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .flash-timer {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 15px;
            border-radius: 25px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        .flash-products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            padding: 1.5rem;
            background: white;
        }
        
        .flash-product-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(255, 61, 0, 0.1);
            border: 2px solid #ffccbc;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .flash-product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(255, 61, 0, 0.2);
            border-color: #ff3d00;
        }
        
        .flash-exclusive-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            background: linear-gradient(135deg, #ff3d00, #ff6d00);
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
            z-index: 10;
            box-shadow: 0 3px 10px rgba(255, 61, 0, 0.3);
        }
        
        .flash-price {
            color: #d50000;
            font-size: 1.3rem;
            font-weight: bold;
            margin: 5px 0;
        }
        
        .flash-discount {
            background: #ffeb3b;
            color: #d50000;
            padding: 3px 8px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 0.9rem;
            margin-left: 10px;
        }
        
        .flash-stock-warning {
            background: #ffecb3;
            color: #ff6f00;
            padding: 0.8rem;
            border-radius: 8px;
            margin-top: 1rem;
            text-align: center;
            font-size: 0.9rem;
            border-left: 4px solid #ff9800;
        }
        
        .flash-countdown-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
            border-radius: 15px;
        }
        
        .countdown-message {
            text-align: center;
            padding: 2rem;
        }
        
        .countdown-message h3 {
            color: #d50000;
            margin-bottom: 1rem;
        }
        
        .tomorrow-countdown {
            background: #e8f5e9;
            padding: 1rem;
            border-radius: 10px;
            text-align: center;
            margin-top: 1rem;
            border: 2px dashed #4CAF50;
        }
        
        .featured-offers {
            margin-bottom: 2rem;
            text-align: center;
        }
        
        .featured-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding: 0 0.5rem;
        }
        
        .featured-title {
            font-size: 1.5rem;
            color: var(--primary);
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .view-all-offers {
            background: linear-gradient(135deg, #ff6f00, #f57c00);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9rem;
            transition: all 0.3s;
        }
        
        .view-all-offers:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255,111,0,0.3);
        }
        
        .search-container {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            padding: 1rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #e8f5e9;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-radius: 12px;
            position: relative;
        }
        
        .search-wrapper {
            position: relative;
            width: 100%;
        }
        
        .search-input {
            width: 100%;
            padding: 14px 50px 14px 20px;
            border: 2px solid var(--primary);
            border-radius: 25px;
            font-size: 1rem;
            background: white;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(46,125,50,0.1);
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--primary-dark);
            box-shadow: 0 0 0 3px rgba(46,125,50,0.2);
        }
        
        .clear-search {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: var(--gray);
            transition: color 0.3s;
            padding: 5px;
            z-index: 2;
            display: none;
        }
        
        .clear-search:hover {
            color: var(--primary);
        }
        
        .search-results {
            text-align: center;
            padding: 12px;
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            border-radius: 10px;
            margin-bottom: 1rem;
            border-left: 4px solid #2196f3;
        }

/* ========== SISTEMA CIAN/AZUL PARA CATEGOR√çAS ========== */
/* ========== M√ìVIL: SCROLL HORIZONTAL ========== */
/* ========== DESKTOP: BOTONES NORMALES ========== */

/* ----- BOT√ìN BASE ----- */
.category-btn {
    /* FONDO: Cian luminoso */
    background: #29B6F6;
    
    /* BORDE: Azul profesional */
    border: 2px solid #0288D1;
    
    /* TEXTO: Blanco para m√°ximo contraste */
    color: #FFFFFF;
    
    /* EFECTOS: Sutil elevaci√≥n */
    box-shadow: 0 2px 6px rgba(2, 136, 209, 0.2);
    
    /* TIPOGRAF√çA Y ESPACIADO */
    font-weight: 600;
    padding: 0.7rem 1.2rem;
    border-radius: 25px;
    cursor: pointer;
    white-space: nowrap;
    transition: all 0.25s ease;
    position: relative;
    
    /* EVITAR SELECCI√ìN DE TEXTO */
    user-select: none;
}

/* ----- BOT√ìN ACTIVO (categor√≠a seleccionada) ----- */
.category-btn.active {
    /* FONDO: Azul s√≥lido (inversi√≥n del normal) */
    background: #0288D1;
    
    /* BORDE: Cian luminoso (inversi√≥n del normal) */
    border-color: #29B6F6;
    
    /* TEXTO: Se mantiene blanco */
    color: #FFFFFF;
    
    /* EFECTOS: M√°s elevaci√≥n para indicar "activado" */
    box-shadow: 0 4px 12px rgba(41, 182, 246, 0.3);
    transform: translateY(-1px);
}

/* ----- HOVER (solo desktop - opcional) ----- */
@media (hover: hover) {
    .category-btn:hover:not(.active) {
        /* Cian un poco m√°s intenso al pasar el mouse */
        background: #03A9F4;
        border-color: #0277BD;
        transform: translateY(-1px);
        box-shadow: 0 3px 8px rgba(2, 119, 189, 0.25);
    }
    .category-btn.active:hover {
        /* El activo puede tener hover tambi√©n */
        background: #0277BD;
        border-color: #4FC3F7;
    }
}
/* ----- BADGE DE OFERTAS (naranja vibrante) ----- */
.offer-count-badge {
    position: absolute;
    top: -8px;
    right: -8px;
    background: #FF6F00;
    color: white;
    padding: 2px 6px;
    border-radius: 10px;
    font-size: 0.7rem;
    font-weight: bold;
    min-width: 20px;
    text-align: center;
    border: 2px solid #FFFFFF;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    z-index: 1;
}

/* ----- CATEGOR√çAS EN DESKTOP ----- */
@media (min-width: 768px) {
    .categories {
        display: flex;
        flex-wrap: wrap;
        gap: 0.8rem;
        margin-bottom: 2rem;
        justify-content: flex-start;
    }
    
    .category-btn {
        padding: 0.8rem 1.5rem;
        font-size: 0.9rem;
        min-width: auto;
    }
    
    .offer-count-badge {
        top: -6px;
        right: -6px;
        font-size: 0.75rem;
        padding: 2px 6px;
        min-width: 22px;
    }
}

/* ----- CATEGOR√çAS EN M√ìVIL (SCROLL HORIZONTAL) ----- */
@media (max-width: 767px) {
    .categories {
        display: flex;
        overflow-x: auto;
        gap: 0.6rem;
        margin-bottom: 1.5rem;
        padding-bottom: 0.5rem;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: thin;
        scrollbar-color: #0288D1 #e8f5e9;
    }
    
    .categories::-webkit-scrollbar {
        height: 6px;
    }
    
    .categories::-webkit-scrollbar-track {
        background: #e8f5e9;
        border-radius: 10px;
    }
    
    .categories::-webkit-scrollbar-thumb {
        background: #0288D1;
        border-radius: 10px;
    }
    
    .category-btn {
        padding: 0.8rem 1rem;
        font-size: 0.85rem;
        min-width: max-content;
        flex-shrink: 0;
    }
    
    /* Ocultar dropdown en m√≥vil */
    .categories-dropdown-container {
        display: none !important;
    }
    
    .offer-count-badge {
        top: -5px;
        right: -5px;
        font-size: 0.65rem;
        padding: 1px 4px;
        min-width: 18px;
    }
}

        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        @media (min-width: 1200px) {
            .products-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        @media (min-width: 768px) and (max-width: 1199px) {
            .products-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 767px) {
            .products-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .cart-icon {
                display: none;
            }
            
            .featured-header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }
        }

        @media (max-width: 480px) {
            .products-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .product-card {
            background-color: var(--card-bg);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            border: 1px solid #e8f5e9;
            position: relative;
        }
        
        .product-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 8px 25px rgba(46,125,50,0.15);
        }
        
        .offer-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: linear-gradient(135deg, #ff6f00, #f57c00);
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.75rem;
            font-weight: bold;
            z-index: 10;
            box-shadow: 0 3px 10px rgba(255,111,0,0.3);
        }
        
        .promo-badge {
            position: absolute;
            top: 40px;
            right: 10px;
            background: linear-gradient(135deg, #4caf50, #2e7d32);
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.7rem;
            font-weight: bold;
            z-index: 10;
            box-shadow: 0 3px 10px rgba(46,125,50,0.3);
        }
        
        .product-image {
            height: 160px;
            background: linear-gradient(135deg, #e8f5e8, #c8e6c9);
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0.8rem;
            position: relative;
            overflow: hidden;
        }
        
        .product-image img {
            max-width: 100%;
            max-height: 130px;
            object-fit: contain;
            transition: transform 0.3s ease;
        }
        
        .product-card:hover .product-image img {
            transform: scale(1.05);
        }
        
        .product-info {
            padding: 1rem;
        }
        
        .product-name {
            font-weight: 600;
            margin-bottom: 0.4rem;
            font-size: 0.9rem;
            color: var(--dark);
            line-height: 1.3;
        }
        
        .product-price-container {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 0.5rem;
        }
        
        .original-price {
            color: var(--gray);
            text-decoration: line-through;
            font-size: 0.9rem;
        }
        
        .product-price {
            color: var(--secondary);
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        .discount-percent {
            background: #ffeb3b;
            color: #333;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: bold;
        }
        
        .product-stock {
            font-size: 0.75rem;
            margin-bottom: 0.8rem;
            font-weight: 500;
        }
        
        .in-stock {
            color: var(--primary-light);
        }
        
        .out-of-stock {
            color: var(--gray);
        }

        .low-stock {
            color: #ff9800;
            font-weight: bold;
        }
        
        .add-to-cart {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            border: none;
            padding: 0.7rem;
            border-radius: 8px;
            width: 100%;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .add-to-cart:hover {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary));
            transform: translateY(-2px);
        }
        
        .add-to-cart:disabled {
            background: var(--gray);
            cursor: not-allowed;
            transform: none;
        }

        .cart-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .cart-content {
            background-color: var(--white);
            width: 90%;
            max-width: 500px;
            border-radius: 15px;
            padding: 1.5rem;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow);
        }
        
        .cart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            border-bottom: 2px solid #e8f5e9;
            padding-bottom: 0.8rem;
        }
        
        .close-cart {
            background: none;
            border: none;
            font-size: 1.8rem;
            cursor: pointer;
            color: var(--gray);
            transition: color 0.3s;
        }
        
        .close-cart:hover {
            color: var(--primary);
        }
        
        .cart-items {
            margin-bottom: 1rem;
        }
        
        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.8rem 0;
            border-bottom: 1px solid #e8f5e9;
        }
        
        .cart-item-info {
            flex-grow: 1;
        }
        
        .cart-item-name {
            font-weight: bold;
            color: var(--dark);
        }
        
        .cart-item-price {
            color: var(--gray);
            font-size: 0.9rem;
        }
        
        .cart-item-quantity {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .quantity-btn {
            background-color: var(--light);
            border: 1px solid #c8e6c9;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .quantity-btn:hover {
            background-color: var(--primary-light);
            color: white;
        }
        
        .quantity-value {
            margin: 0 0.5rem;
            font-weight: bold;
            min-width: 20px;
            text-align: center;
        }
        
        .cart-total {
            font-weight: bold;
            font-size: 1.3rem;
            text-align: right;
            margin-bottom: 1rem;
            color: var(--primary);
            padding-top: 1rem;
            border-top: 2px solid #e8f5e9;
        }
        
        .total-savings {
            background: #4caf50;
            color: white;
            padding: 0.8rem;
            border-radius: 8px;
            margin: 0.5rem 0;
            text-align: center;
            font-weight: bold;
        }
        
        .send-order {
            background: linear-gradient(135deg, var(--secondary), var(--secondary-dark));
            color: white;
            border: none;
            padding: 1.2rem;
            border-radius: 10px;
            width: 100%;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .send-order:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255,111,0,0.3);
        }
        
        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--gray);
            font-size: 1.1rem;
        }
        
        .error-message {
            text-align: center;
            padding: 2rem;
            color: #d32f2f;
            background: #ffebee;
            border-radius: 10px;
            margin: 1rem 0;
            border-left: 4px solid #d32f2f;
        }
        
        .retry-btn {
            margin-top: 10px;
            padding: 10px 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.3s;
        }
        
        .retry-btn:hover {
            background: var(--primary-dark);
        }
        
        footer {
            background: linear-gradient(135deg, var(--dark), var(--primary));
            color: var(--white);
            padding: 2rem 1rem;
            text-align: center;
            margin-top: 3rem;
        }
        
        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
        }

        .admin-notification {
            background: linear-gradient(135deg, #ff9800, #f57c00);
            color: white;
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            text-align: center;
            animation: slideIn 0.5s ease;
        }

        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* PWA */
        .install-prompt {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 15px 20px;
            border-radius: 50px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            cursor: pointer;
            z-index: 1000;
            display: none;
            align-items: center;
            gap: 10px;
            font-weight: bold;
            font-size: 16px;
            animation: slideUp 0.5s ease;
            border: 2px solid white;
        }
        
        @keyframes slideUp {
            from { transform: translateY(100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .install-prompt:hover {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary));
            transform: scale(1.05);
        }
        
        .success-notification {
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: #4CAF50;
            color: white;
            padding: 15px 30px;
            border-radius: 50px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            z-index: 10000;
            font-weight: bold;
            text-align: center;
            animation: fadeInOut 3s ease;
        }
        
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
            20% { opacity: 1; transform: translateX(-50%) translateY(0); }
            80% { opacity: 1; transform: translateX(-50%) translateY(0); }
            100% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
        }

        /* FLOTANTE CELULAR */
        .floating-cart {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, var(--secondary), var(--secondary-dark));
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(255,111,0,0.4);
            z-index: 999;
            transition: all 0.3s ease;
            font-size: 1.5rem;
        }
        
        .floating-cart:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(255,111,0,0.6);
        }
        
        .floating-cart .cart-count {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--primary);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.8rem;
            font-weight: bold;
            border: 2px solid white;
        }

        .floating-search {
            position: fixed;
            bottom: 90px;
            right: 20px;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: none;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(46,125,50,0.4);
            z-index: 998;
            transition: all 0.3s ease;
            font-size: 1.5rem;
        }
        
        .floating-search:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(46,125,50,0.6);
        }

        .search-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1001;
            justify-content: center;
            align-items: flex-start;
            padding-top: 80px;
        }
        
        .search-modal-content {
            background-color: var(--white);
            width: 90%;
            max-width: 500px;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
        }
        
        .search-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            border-bottom: 2px solid #e8f5e9;
            padding-bottom: 0.8rem;
        }
        
        .close-search {
            background: none;
            border: none;
            font-size: 1.8rem;
            cursor: pointer;
            color: var(--gray);
            transition: color 0.3s;
        }
        
        .close-search:hover {
            color: var(--primary);
        }

        @media (max-width: 767px) {
            .search-container {
                display: none;
            }
            
            .floating-search {
                display: flex;
            }
        }

        .stock-notification {
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: #f44336;
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1002;
            font-weight: 500;
            animation: slideDown 0.3s ease;
        }
        
@keyframes slideDown {
    from { 
        transform: translateX(-50%) translateY(-20px); 
        opacity: 0; 
    }
    to { 
        transform: translateX(-50%) translateY(0); 
        opacity: 1; 
    }
}
        .search-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            z-index: 1000;
            max-height: 300px;
            overflow-y: auto;
            display: none;
        }
        
        .suggestion-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
        }
        
        .suggestion-item:hover {
            background: #f5f5f5;
        }
        
        .suggestion-name {
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .suggestion-details {
            font-size: 0.8rem;
            color: #666;
        }
        
        .suggestion-badge {
            background: #ff9800;
            color: white;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 0.7rem;
        }

        .mobile-search-results {
            margin-top: 1rem;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .promo-limit {
            font-size: 0.7rem;
            color: #666;
            margin-bottom: 5px;
            font-style: italic;
        }
        
        .offer-description {
            font-size: 0.8rem;
            color: #ff6f00;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .limit-notification {
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: #ff9800;
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1002;
            font-weight: 500;
            animation: slideDown 0.3s ease;
        }
        
        .tipo-venta-icon {
            font-size: 0.8rem;
            margin-right: 4px;
            vertical-align: middle;
        }
        
        .stock-tipo {
            display: inline-block;
            margin-left: 5px;
            font-size: 0.7rem;
            color: #666;
            font-weight: 500;
        }
        /* Ocultar bot√≥n de Ver productos con oferta */
        #viewAllOffers {
        
        }
        /* Ocultar bot√≥n Ver productos con oferta en TODA la p√°gina */
        #viewAllOffers,
        .view-all-offers {

        }
        /* Bot√≥n "Compartir esta OFERTA" (solo aparece en la mayor oferta) */
        .share-offer-btn {
            margin-top: 8px;
            width: 100%;
            padding: 10px 14px;
            border: none;
            border-radius: 18px;
            font-size: 14px;
            font-weight: 600;
            background: linear-gradient(135deg,#00c853,#00b14a);
            color: white;
            cursor: pointer;
            box-shadow: 0 3px 12px rgba(0,0,0,0.18);
        }
        .share-offer-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 18px rgba(0,0,0,0.22);
        }

        /* Ocultar dropdown en toda la p√°gina */
        .categories-dropdown-container {
            display: none !important;
        }

        /* NUEVOS ESTILOS PARA TEXTO DE OFERTA PROGRESIVA */
        .progressive-offer-info {
            background: #e8f5e9;
            border-radius: 8px;
            padding: 8px 10px;
            margin: 5px 0 10px 0;
            border-left: 3px solid #4CAF50;
            font-size: 0.75rem;
        }
        
        .progressive-level {
            display: inline-block;
            margin-right: 6px;
            padding: 2px 6px;
            background: #4CAF50;
            color: white;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.7rem;
        }
        
        .progressive-text {
            color: #1b5e20;
            font-weight: 500;
        }
        
        .progressive-highlight {
            color: #ff6f00;
            font-weight: bold;
        }
        
        /* ESTILOS PARA OFERTA 3x2 ESPEC√çFICOS */
        .oferta-3x2-detalle {
            background: #fff8e1;
            border-radius: 8px;
            padding: 8px 10px;
            margin: 5px 0 10px 0;
            border-left: 3px solid #ff9800;
            font-size: 0.75rem;
            color: #5d4037;
        }
        
        .oferta-3x2-titulo {
            font-weight: bold;
            color: #ff6f00;
            margin-bottom: 3px;
        }
        
        .oferta-3x2-ejemplo {
            font-size: 0.7rem;
            color: #795548;
        }
        
        /* ESTILOS PARA BOT√ìN CASITA FLOTANTE */
        .floating-home {
            position: fixed;
            bottom: 160px;
            right: 20px;
            background: linear-gradient(135deg, #2196F3, #0D47A1);
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(33, 150, 243, 0.4);
            z-index: 997;
            transition: all 0.3s ease;
            font-size: 1.8rem;
        }

        .floating-home:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(33, 150, 243, 0.6);
        }

        /* Ajustar posici√≥n de otros botones flotantes */
        .floating-search {
            bottom: 90px; /* Subimos la b√∫squeda */
        }

        .floating-cart {
            bottom: 20px; /* El carrito queda abajo */
        }

        /* En m√≥vil, reorganizar los botones */
        @media (max-width: 767px) {
            .floating-home {
                bottom: 150px;
                right: 20px;
                width: 55px;
                height: 55px;
                font-size: 1.6rem;
            }
            
            .floating-search {
                bottom: 85px;
                width: 55px;
                height: 55px;
                font-size: 1.3rem;
            }
            
            .floating-cart {
                bottom: 20px;
                width: 55px;
                height: 55px;
                font-size: 1.3rem;
            }
            
            .floating-cart .cart-count {
                width: 22px;
                height: 22px;
                font-size: 0.7rem;
            }
        }
    </style>
</head>
<body>
<header>
    <div class="header-content">
        <div class="logo">
            <img src="iconos-pwa/android/android-launchericon-48-48.png" alt="Logo Almac√©n Copihue" class="logo-icon">
            Almac√©n Copihue
            <span id="adminBadge" class="admin-badge" style="display: none;">ADMIN</span>
        </div>
        <div class="cart-icon" id="cartIcon">
            üõí <span class="cart-count" id="cartCount">0</span>
        </div>
    </div>
</header>
    <div class="container">
        <div id="adminNotification" class="admin-notification" style="display: none;">
            <strong>üîî MODO ADMIN ACTIVADO</strong> - Recibir√°s alertas de stock bajo
        </div>

        <section class="hero">
            <h1>"Almac√©n Copihue"</h1>
            <p>Productos de calidad con la confianza de siempre</p>
        </section>

        <section class="info-bar">
            <div class="info-item">
                <strong>üìç Retiro en el local:</strong> Copihue 457
            </div>
            <div class="info-item">
                <strong>üìû WhatsApp:</strong> +5492944907380
            </div>
            <div class="info-item">
                <strong>‚è∞ Horario:</strong> 11:30 a 23:30 hrs.
            </div>
        </section>

        <!-- ========== OFERTAS REL√ÅMPAGO ========== -->
        <div class="flash-sales-container" id="flashSalesContainer">
            <div class="flash-sales-header">
                <h2>
                    ‚ö° OFERTAS REL√ÅMPAGO 
                    <span class="flash-badge">HOY SOLO</span>
                </h2>
                <div class="flash-timer" id="flashTimer">
                    ‚è∞ Termina en: <span id="countdown">--:--:--</span>
                </div>
            </div>
            
            <div class="flash-stock-warning">
                ‚ö†Ô∏è <strong>ATENCI√ìN:</strong> Ofertas v√°lidas solo de Domingo a Jueves, de 11:30 a 17:00.
                ¬°Apurate, stock limitado!
            </div>
            
            <div class="flash-products-grid" id="flashProductsGrid">
                <!-- Productos rel√°mpago se cargan aqu√≠ -->
            </div>
            
            <div class="flash-countdown-overlay" id="flashCountdownOverlay">
                <div class="countdown-message">
                    <h3>‚è∞ OFERTAS REL√ÅMPAGO FINALIZADAS</h3>
                    <p>Las ofertas rel√°mpago de hoy han terminado.</p>
                    <p>Volver√°n ma√±ana de 11:30 a 17:00 hrs.</p>
                    <div class="tomorrow-countdown">
                        <strong>üîÑ Pr√≥ximas ofertas rel√°mpago en:</strong>
                        <div id="nextFlashCountdown">--:--:--</div>
                    </div>
                </div>
            </div>
        </div>

        <section class="featured-offers" id="featuredOffers" style="display: none;">
            <div class="featured-header">
                <div class="featured-title">
                    üî• OFERTAS FINDE
                </div>
                <button class="view-all-offers" id="viewAllOffers">
                    Ver todas las ofertas
                </button>
            </div>
            <div class="products-grid" id="featuredProductsGrid">
                <!-- Ofertas destacadas din√°micas -->
            </div>
        </section>

        <div class="search-container" id="desktopSearch">
            <div class="search-wrapper">
                <input type="text" id="productSearch" class="search-input" 
                       placeholder="üîç Buscar productos por nombre, abreviatura o sin√≥nimo...">
                <button class="clear-search" id="clearSearchBtn">‚úñÔ∏è</button>
                <div id="searchSuggestions" class="search-suggestions"></div>
            </div>
        </div>

        <!-- CATEGOR√çAS √öNICAS - SCROLL HORIZONTAL EN M√ìVIL -->
        <section class="categories" id="categories">
            <!-- Categor√≠as din√°micas -->
        </section>

        <section class="products-grid" id="productsGrid">
            <div class="loading">üîÑ Cargando productos desde tu API...</div>
        </section>
    </div>

    <!-- BOTONES FLOTANTES -->
    <div class="floating-home" id="floatingHome">
        üè†
    </div>
    
    <div class="floating-search" id="floatingSearch">
        üîç
    </div>

    <div class="floating-cart" id="floatingCart">
        üõí
        <span class="cart-count" id="floatingCartCount">0</span>
    </div>

    <div class="search-modal" id="searchModal">
        <div class="search-modal-content">
            <div class="search-modal-header">
                <h2>Buscar Productos</h2>
                <button class="close-search" id="closeSearch">&times;</button>
            </div>
            <div class="search-wrapper">
                <input type="text" id="mobileSearch" class="search-input" 
                       placeholder="üîç Escribe nombre, abreviatura o sin√≥nimo..."
                       onkeydown="handleMobileSearchEnter(event)">
                <button class="clear-search" id="clearMobileSearchBtn">‚úñÔ∏è</button>
            </div>
            <div class="mobile-search-results" id="mobileSearchResults">
                <!-- Resultados b√∫squeda m√≥vil -->
            </div>
        </div>
    </div>

    <div class="cart-modal" id="cartModal">
        <div class="cart-content">
            <div class="cart-header">
                <h2>Tu Pedido</h2>
                <button class="close-cart" id="closeCart">&times;</button>
            </div>
            <div class="cart-items" id="cartItems">
                <!-- Items del carrito -->
            </div>
            <div class="cart-total" id="cartTotal">Total: $0</div>
            <button class="send-order" id="sendOrder">Enviar Pedido por WhatsApp</button>
        </div>
    </div>

    <div class="install-prompt" id="installPrompt">
        <span>üì± Instalar App</span>
    </div>

<div class="ios-instructions" id="iosInstructions" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 10000; justify-content: center; align-items: center; padding: 20px;">
    <div style="background: white; border-radius: 20px; padding: 30px; max-width: 400px; text-align: center; position: relative;">
        <!-- Bot√≥n cerrar (X) -->
        <button onclick="document.getElementById('iosInstructions').style.display='none'" 
                style="position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 24px; cursor: pointer; color: #666; padding: 5px; line-height: 1;">
            &times;
        </button>
        
        <h2 style="color: #2e7d32; margin-bottom: 20px; padding-right: 30px;">üì± Instalar en iPhone/iPad</h2>
        <div style="text-align: left; margin: 20px 0; font-size: 16px; line-height: 1.8;">
            <p>1. Toca el bot√≥n <strong style="color: #2e7d32;">Compartir</strong> üì§</p>
            <p>2. Despl√°zate hacia abajo</p>
            <p>3. Selecciona <strong style="color: #2e7d32;">"Agregar a Inicio"</strong></p>
            <p>4. Toca <strong style="color: #2e7d32;">"Agregar"</strong></p>
        </div>
        <button onclick="document.getElementById('iosInstructions').style.display='none'" 
                style="background: #2e7d32; color: white; border: none; padding: 12px 30px; 
                       border-radius: 25px; font-size: 16px; font-weight: bold; cursor: pointer; 
                       margin-top: 10px; width: 100%;">
            Entendido
        </button>
    </div>
</div>

    <footer>
        <div class="footer-content">
            <p>Almac√©n Copihue - Productos de calidad con la confianza de siempre</p>
            <p>üìç Copihue 457 | üìû +5492944907380 | ‚è∞ 11:30 a 23:30 hrs.</p>
        </div>
    </footer>

    <script>
// ========== VERSI√ìN Y CONFIGURACI√ìN ==========
const APP_VERSION = '20241218-V124-SEPARACION-ESTRICTA-OFERTAS';

// ========== SISTEMA DE OFERTAS ==========
const OFERTAS_SISTEMA = {
    '1': { 
        nombre: "2x1", 
        tipo: "2x1", 
        eslogan: "üí• ¬°2x1! - Llev√° 2, Pag√° 1",
        ejemplo: "2 unidades = 50% OFF (¬°MITAD DE PRECIO!)",
        color: "#d50000",
        descuentoReal: 50
    },
    '2': { 
        nombre: "3x2", 
        tipo: "3x2", 
        eslogan: "üéØ 3x2 - Llev√° 3, Pag√° 2",
        ejemplo: "3 unidades = 33% OFF (una GRATIS)",
        color: "#ff6f00",
        descuentoReal: 33
    },
    '3': { 
        nombre: "4x3", 
        tipo: "4x3", 
        eslogan: "üèÜ 4x3 - Llev√° 4, Pag√° 3",
        ejemplo: "4 unidades = 25% OFF",
        color: "#2196f3",
        descuentoReal: 25
    },
    '4': { 
        nombre: "5x4", 
        tipo: "5x4", 
        eslogan: "üíé 5x4 - Llev√° 5, Pag√° 4",
        ejemplo: "5 unidades = 20% OFF",
        color: "#9c27b0",
        descuentoReal: 20
    },
    '5': { 
        nombre: "6x5", 
        tipo: "6x5", 
        eslogan: "üëë 6x5 - Llev√° 6, Pag√° 5",
        ejemplo: "6 unidades = 17% OFF",
        color: "#ff4081",
        descuentoReal: 17
    },
    '6': { 
        nombre: "7x6", 
        tipo: "7x6", 
        eslogan: "üöÄ 7x6 - Llev√° 7, Pag√° 6",
        ejemplo: "7 unidades = 14% OFF",
        color: "#00bcd4",
        descuentoReal: 14
    },
    '7': { 
        nombre: "8x7", 
        tipo: "8x7", 
        eslogan: "üåü 8x7 - Llev√° 8, Pag√° 7",
        ejemplo: "8 unidades = 13% OFF",
        color: "#8e24aa",
        descuentoReal: 13
    },
    '8': { 
        nombre: "9x8", 
        tipo: "9x8", 
        eslogan: "üí´ 9x8 - Llev√° 9, Pag√° 8",
        ejemplo: "9 unidades = 11% OFF",
        color: "#43a047",
        descuentoReal: 11
    },
    '9': { 
        nombre: "10x9", 
        tipo: "10x9", 
        eslogan: "üéä 10x9 - Llev√° 10, Pag√° 9",
        ejemplo: "10 unidades = 10% OFF",
        color: "#fb8c00",
        descuentoReal: 10
    },
    '10': { 
        nombre: "2da50", 
        tipo: "2da50", 
        eslogan: "üéÅ 2da unidad 50% OFF",
        ejemplo: "2 unidades = 25% OFF en total",
        color: "#e91e63",
        descuentoReal: 25
    },
    '11': { 
        nombre: "30progresivo", 
        tipo: "30progresivo", 
        eslogan: "üìà 30% desde la 2da",
        ejemplo: "2da: 15% OFF | 3ra+: 20% OFF",
        color: "#3f51b5",
        descuentoReal: 20
    }
};

function getDisplayProps(product, renderContext = 'grid') {
  const isFlashActive = FLASH_SALES_SYSTEM?.isActive ?? false;
  const isFeaturedActive = isValidFeaturedOffersTime?.() ?? false;

  const inFlash =
    isFlashActive &&
    FLASH_SALES_SYSTEM.todaySelection?.some(p => p.id === product.id);

  const inFeatured =
    isFeaturedActive &&
    window.productosDestacadosIds?.includes(product.id);

  if (renderContext === 'grid' && (inFlash || inFeatured)) {
    return null;
  }

  if (renderContext === 'flash' && inFlash) return { show: true };
  if (renderContext === 'featured' && inFeatured) return { show: true };

  return { show: true };
}


// ========== VALIDACI√ìN HORARIO OFERTAS DESTACADAS ==========
function isValidFeaturedOffersTime() {
    const now = new Date();
    const currentDay = now.getDay(); // 0=Domingo, 5=Viernes, 6=S√°bado
    const currentHour = now.getHours();
    const currentMinutes = now.getMinutes();
    
    // Solo Viernes (5) y S√°bados (6)
    if (currentDay !== 5 && currentDay !== 6) {
        console.log('üìÖ Ofertas Destacadas: Fuera de d√≠as v√°lidos (solo Viernes y S√°bados)');
        return false;
    }
    
    // Entre 18:00 y 23:00 inclusive
    const isAfter18 = currentHour > 18 || (currentHour === 18 && currentMinutes >= 0);
    const isBefore23 = currentHour < 23 || (currentHour === 23 && currentMinutes === 0);
    
    const isValid = isAfter18 && isBefore23;
    
    console.log(`üìÖ Ofertas Destacadas - D√≠a: ${currentDay}, Hora: ${currentHour}:${currentMinutes}, V√°lido: ${isValid}`);
    return isValid;
}

// ========== FUNCIONES DE OFERTAS ==========
function redondearPrecioAlmacenCopihue(precio) {
    if (typeof precio !== 'number' || isNaN(precio) || precio <= 0) return 0;
    
    if (precio === Math.floor(precio)) {
        return precio;
    }
    
    return Math.round(precio);
}

function calcularPrecioConDescuento(precioOriginal, ofertas1, ofertas2, cantidad) {
    if (!precioOriginal || precioOriginal <= 0 || !cantidad || cantidad <= 0) {
        return precioOriginal || 0;
    }
    
    if (ofertas2 && !isNaN(parseInt(ofertas2))) {
        const descuentoPorcentaje = parseInt(ofertas2);
        
        if (descuentoPorcentaje > 0 && descuentoPorcentaje <= 100) {
            const limiteOferta2 = obtenerLimiteOfertas2(ofertas2);
            if (limiteOferta2 !== null && cantidad > limiteOferta2) {
                cantidad = limiteOferta2;
            }
            
            const descuentoDecimal = descuentoPorcentaje / 100;
            const precioTotal = precioOriginal * cantidad;
            const precioConDescuento = precioTotal * (1 - descuentoDecimal);
            
            return redondearPrecioAlmacenCopihue(precioConDescuento) / cantidad;
        }
    }
    
    if (ofertas1 && OFERTAS_SISTEMA[ofertas1]) {
        const oferta = OFERTAS_SISTEMA[ofertas1];
        
        let totalAPagar = 0;
        
        switch(oferta.tipo) {
            case '2x1':
                const grupos2 = Math.floor(cantidad / 2);
                const sobras2 = cantidad % 2;
                totalAPagar = (grupos2 * precioOriginal * 1) + (sobras2 * precioOriginal);
                break;
                
            case '3x2':
                const grupos3 = Math.floor(cantidad / 3);
                const sobras3 = cantidad % 3;
                totalAPagar = (grupos3 * precioOriginal * 2) + (sobras3 * precioOriginal);
                break;
                
            case '4x3':
                const grupos4 = Math.floor(cantidad / 4);
                const sobras4 = cantidad % 4;
                totalAPagar = (grupos4 * precioOriginal * 3) + (sobras4 * precioOriginal);
                break;
                
            case '5x4':
                const grupos5 = Math.floor(cantidad / 5);
                const sobras5 = cantidad % 5;
                totalAPagar = (grupos5 * precioOriginal * 4) + (sobras5 * precioOriginal);
                break;
                
            case '6x5':
                const grupos6 = Math.floor(cantidad / 6);
                const sobras6 = cantidad % 6;
                totalAPagar = (grupos6 * precioOriginal * 5) + (sobras6 * precioOriginal);
                break;
                
            case '2da50':
                const pares = Math.floor(cantidad / 2);
                const impares = cantidad % 2;
                totalAPagar = (pares * (precioOriginal + (precioOriginal * 0.5))) + (impares * precioOriginal);
                break;
                
            case '30progresivo':
                let descuento = 0;
                if (cantidad === 1) descuento = 0;
                else if (cantidad === 2) descuento = 0.15;
                else descuento = 0.20;
                
                totalAPagar = precioOriginal * cantidad * (1 - descuento);
                break;
                
            default:
                totalAPagar = precioOriginal * cantidad;
        }
        
        return totalAPagar / cantidad;
    }
    
    return precioOriginal;
}

function calcularDescuentoReal(precioOriginal, precioFinal) {
    if (precioOriginal <= 0 || precioFinal >= precioOriginal) return 0;
    return Math.round(((precioOriginal - precioFinal) / precioOriginal) * 100);
}

function obtenerDescripcionOferta(ofertas1, ofertas2, precioOriginal, cantidad = 1) {
    if (ofertas2 && !isNaN(parseInt(ofertas2))) {
        const descuento = parseInt(ofertas2);
        if (descuento > 0 && descuento <= 100) {
            const precioConDescuento = calcularPrecioConDescuento(precioOriginal, ofertas1, ofertas2, 1);
            const ahorro = precioOriginal - precioConDescuento;
            return `üî• ¬°${descuento}% OFF! Ahorr√° $${Math.round(ahorro)} por unidad`;
        }
    }
    
    if (ofertas1 && OFERTAS_SISTEMA[ofertas1]) {
        const oferta = OFERTAS_SISTEMA[ofertas1];
        return oferta.eslogan;
    }
    
    return "";
}

function obtenerTextoCortoOferta(ofertas1, ofertas2) {
    if (ofertas2 && !isNaN(parseInt(ofertas2))) {
        const descuento = parseInt(ofertas2);
        if (descuento > 0 && descuento <= 100) {
            return `üî• ${descuento}% OFF`;
        }
    }
    
    if (ofertas1 && OFERTAS_SISTEMA[ofertas1]) {
        const oferta = OFERTAS_SISTEMA[ofertas1];
        return `üéØ ${oferta.nombre}`;
    }
    
    return "";
}

function obtenerDetalleOferta3x2(ofertas1, precioOriginal, cantidad = 1) {
    if (!ofertas1 || !OFERTAS_SISTEMA[ofertas1]) return "";
    
    const oferta = OFERTAS_SISTEMA[ofertas1];
    
    switch(oferta.tipo) {
        case '3x2':
            let detalle3x2 = `<div class="oferta-3x2-detalle">
                <div class="oferta-3x2-titulo">üéØ OFERTA 3x2 REAL</div>
                <div class="oferta-3x2-ejemplo">`;
            
            if (cantidad === 1) {
                detalle3x2 += `‚Ä¢ 1 unidad: $${precioOriginal} (normal)`;
            } else if (cantidad === 2) {
                detalle3x2 += `‚Ä¢ 2 unidades: $${precioOriginal * 2} (normales)`;
            } else if (cantidad === 3) {
                const precio3unidades = redondearPrecioAlmacenCopihue(calcularPrecioConDescuento(precioOriginal, ofertas1, '', 3) * 3);
                detalle3x2 += `‚Ä¢ 3 unidades: $${precio3unidades} (la 3ra GRATIS)`;
            } else if (cantidad === 4) {
                const precio4unidades = redondearPrecioAlmacenCopihue(calcularPrecioConDescuento(precioOriginal, ofertas1, '', 4) * 4);
                detalle3x2 += `‚Ä¢ 4 unidades: $${precio4unidades} (3x2 + 1 normal)`;
            } else if (cantidad === 6) {
                const precio6unidades = redondearPrecioAlmacenCopihue(calcularPrecioConDescuento(precioOriginal, ofertas1, '', 6) * 6);
                detalle3x2 += `‚Ä¢ 6 unidades: $${precio6unidades} (2 paquetes 3x2)`;
            } else {
                detalle3x2 += oferta.ejemplo;
            }
            
            detalle3x2 += `</div></div>`;
            return detalle3x2;
            
        case '2da50':
            return `<div class="oferta-3x2-detalle">
                <div class="oferta-3x2-titulo">${oferta.eslogan}</div>
                <div class="oferta-3x2-ejemplo">${oferta.ejemplo}</div>
            </div>`;
            
        case '30progresivo':
            return `<div class="oferta-3x2-detalle">
                <div class="oferta-3x2-titulo">${oferta.eslogan}</div>
                <div class="oferta-3x2-ejemplo">${oferta.ejemplo}</div>
            </div>`;
            
        default:
            return "";
    }
}

function obtenerMayorOfertaDelDia() {
    if (!products || products.length === 0) return null;
    
    const ofertas = products.filter(p => 
        Number(p.ofertas2) > 0 && 
        (p.stock === "STOCK" || p.stockNumber > 0)
    );
    
    if (ofertas.length === 0) return null;
    
    ofertas.sort((a, b) => Number(b.ofertas2) - Number(a.ofertas2));
    return ofertas[0];
}

function obtenerEtiquetaOfertaDestacada(descuento) {
    const desc = Number(descuento);
    if (desc >= 50) return "üèÜ ¬°SUPER OFERT√ìN!";
    if (desc >= 30) return "üî• ¬°OFERT√ìN!";
    if (desc >= 20) return "‚ú® ¬°GRAN OFERTA!";
    if (desc > 0) return "üëç ¬°OFERTA!";
    return "";
}

// ===============================
// CATEGOR√çA SEG√öN % DE DESCUENTO
// ===============================
function obtenerFraseCategoria(descuento) {
    if (descuento >= 70) return "üö® REMATE ¬∑ Se va o se va";
    if (descuento >= 60) return "üö® Liquidaci√≥n ¬∑ Hasta agotar stock";
    if (descuento >= 40) return "üî• Alta oferta ¬∑ Precio que no se ve siempre";
    if (descuento >= 25) return "üü† OFERT√ìN";
    if (descuento >= 15) return "üü° En oferta";
    return "üü¢ Buen precio";
}

function compartirMegaOferta(id) {
    console.log('ü§ù Compartiendo oferta ID:', id);

    const producto = window.products?.find(p => p.id === id);
    if (!producto) {
        alert('No se pudo encontrar el producto');
        return;
    }

    const precioOriginal = producto.price || 0;
    const precioOferta = producto.discountedPrice || precioOriginal;
    const ahorro = Math.round(precioOriginal - precioOferta);
    const descuento = producto.ofertas2 ? parseInt(producto.ofertas2) : 0;

    const categoria = obtenerFraseCategoria(descuento);

    // üî• LINK FIJO ONLINE (NO LOCALHOST)
    const linkOferta = "https://almacen-copihue.vercel.app";

    let mensaje = `${categoria}\n\n`;
    mensaje += `Hola, mir√° esta oferta del Almac√©n Copihue üëá\n\n`;
    mensaje += `üõí *${producto.name}*\n\n`;
    mensaje += `üí∞ Antes: $${precioOriginal}\n`;
    mensaje += `üî• Ahora: *$${precioOferta}*\n`;
    if (ahorro > 0) mensaje += `üí∏ Ahorr√°s $${ahorro}\n\n`;

    mensaje += `üëâ Ver las ofertas ac√°:\n${linkOferta}\n\n`;
    mensaje += `Almac√©n Copihue\n`;
    mensaje += `Productos de calidad con la confianza de siempre`;

    console.log('üì§ Mensaje generado:', mensaje);

    window.open(
        `https://wa.me/?text=${encodeURIComponent(mensaje)}`,
        "_blank",
        "noopener,noreferrer"
    );
}

function mostrarFeedbackWhatsApp() {
    try {
        // Eliminar feedbacks anteriores
        document.querySelectorAll('.feedback-whatsapp').forEach(el => el.remove());
        
        // Crear feedback
        const feedback = document.createElement('div');
        feedback.className = 'feedback-whatsapp';
        
        feedback.innerHTML = `
            <div style="display: flex; align-items: center; gap: 12px;">
                <div style="font-size: 28px; animation: pulse 1.5s infinite;">üì±</div>
                <div>
                    <div style="font-weight: bold; font-size: 16px;">¬°Abriendo WhatsApp!</div>
                    <div style="font-size: 13px; opacity: 0.9; margin-top: 3px;">
                        Mensaje listo para enviar al Almac√©n Copihue
                    </div>
                </div>
            </div>
        `;
        
        feedback.style.cssText = `
            position: fixed;
            top: 130px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #25D366, #128C7E);
            color: white;
            padding: 18px 24px;
            border-radius: 14px;
            box-shadow: 0 10px 30px rgba(37, 211, 102, 0.5);
            z-index: 10000;
            animation: slideDown 0.4s ease;
            border: 3px solid white;
            min-width: 340px;
            max-width: 90%;
        `;
        
        document.body.appendChild(feedback);
        
        // Auto-eliminar despu√©s de 3 segundos
        setTimeout(() => {
            if (feedback.parentNode) {
                feedback.parentNode.removeChild(feedback);
            }
        }, 3000);
        
    } catch (error) {
        console.warn('‚ö†Ô∏è Error en feedback:', error);
    }
}

// Agregar animaci√≥n de pulso si no existe
if (!document.querySelector('style#pulse-animation')) {
    const style = document.createElement('style');
    style.id = 'pulse-animation';
    style.textContent = `
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
    `;
    document.head.appendChild(style);
}

function compartirPorWhatsApp(mensaje) {
    const phoneNumber = "5492944907380";
    const encodedMessage = encodeURIComponent(mensaje);
    const whatsappURL = `https://wa.me/${phoneNumber}?text=${encodedMessage}`;
    
    console.log('üì≤ Abriendo WhatsApp:', whatsappURL);
    
    // Abrir en nueva pesta√±a
    const nuevaVentana = window.open(whatsappURL, '_blank', 'noopener,noreferrer');
    
    if (!nuevaVentana) {
        alert('‚ö†Ô∏è Por favor, permite ventanas emergentes para compartir por WhatsApp');
        console.error('‚ùå Bloqueo de ventanas emergentes detectado');
    }
    
    mostrarFeedbackCompartir();
}

function mostrarFeedbackCompartir(productName = '') {
    try {
        // Eliminar notificaciones previas
        const notificacionesPrevias = document.querySelectorAll('.feedback-compartir');
        notificacionesPrevias.forEach(el => el.remove());
        
        // Crear nueva notificaci√≥n
        const notification = document.createElement('div');
        notification.className = 'feedback-compartir';
        
        const mensaje = productName 
            ? `‚úÖ ¬°Oferta de "${productName}" lista para compartir!` 
            : `‚úÖ ¬°Oferta lista para compartir por WhatsApp!`;
        
        notification.innerHTML = `
            <div style="display: flex; align-items: center; gap: 10px;">
                <div style="font-size: 20px;">üì±</div>
                <div>
                    <div style="font-weight: bold;">${mensaje}</div>
                    <div style="font-size: 12px; opacity: 0.9;">Se abrir√° WhatsApp en una nueva pesta√±a</div>
                </div>
            </div>
        `;
        
        notification.style.cssText = `
            position: fixed;
            top: 120px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #25D366, #128C7E);
            color: white;
            padding: 15px 25px;
            border-radius: 15px;
            box-shadow: 0 6px 20px rgba(37, 211, 102, 0.5);
            z-index: 1003;
            font-weight: 600;
            font-size: 14px;
            animation: slideDown 0.3s ease;
            border: 2px solid white;
            text-align: center;
            min-width: 300px;
            max-width: 90%;
        `;
        
        document.body.appendChild(notification);
        
        // Auto-eliminar despu√©s de 3 segundos
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 3000);
        
    } catch (error) {
        console.warn('‚ö†Ô∏è Error en mostrarFeedbackCompartir:', error);
    }
}

function mostrarInfoAdmin(producto) {
    if (!esAdmin) return '';
    
    let info = '<div style="font-size: 0.7rem; color: #666; background: #f5f5f5; padding: 5px; margin-top: 5px; border-radius: 5px; border-left: 3px solid #ff9800;">';
    info += '<strong>üëÅÔ∏è INFO ADMIN:</strong><br>';
    
    if (producto.ofertas2 && producto.ofertas2 !== '0') {
        info += `Ofertas2: ${producto.ofertas2}%<br>`;
    }
    if (producto.ofertas1 && producto.ofertas1 !== '0') {
        const oferta = OFERTAS_SISTEMA[producto.ofertas1];
        if (oferta) {
            info += `Ofertas1: ${oferta.nombre} (${oferta.descuentoReal}% real)<br>`;
        }
    }
    
    const descuentoReal = calcularDescuentoReal(producto.price, producto.discountedPrice);
    if (descuentoReal > 0) {
        info += `Descuento real: ${descuentoReal}%<br>`;
        info += `Precio unit. real: $${(producto.discountedPrice).toFixed(2)}`;
    }
    info += '</div>';
    
    return info;
}

function obtenerLimiteOfertas2(ofertas2) {
    if (!ofertas2 || ofertas2 === '') return null;
    
    const porcentaje = parseInt(ofertas2);
    if (isNaN(porcentaje)) return null;
    
    if (porcentaje >= 70 && porcentaje <= 99) {
        return 3;
    } else if (porcentaje >= 50 && porcentaje <= 69) {
        return 5;
    }
    
    return null;
}

function obtenerTextoLimiteOfertas2(ofertas2, nombreProducto = '') {
    const limite = obtenerLimiteOfertas2(ofertas2);
    if (limite === null) return '';
    
    const tipoVenta = obtenerTipoDeVenta(nombreProducto);
    
    switch(tipoVenta) {
        case 'peso':
            const nombreLower = nombreProducto.toLowerCase();
            if (nombreLower.includes('gr') || nombreLower.includes('gramo')) {
                return `<span class="tipo-venta-icon">‚öñÔ∏è</span> M√°x. ${limite * 1000} GRAMOS por familia`;
            } else {
                return `<span class="tipo-venta-icon">‚öñÔ∏è</span> M√°x. ${limite} KILOS por familia`;
            }
        case 'unidad':
            return `<span class="tipo-venta-icon">üì¶</span> M√°x. ${limite} UNIDADES por familia`;
        case 'empaque':
            return `<span class="tipo-venta-icon">üéÅ</span> M√°x. ${limite} PAQUETES por familia`;
        default:
            return `<span class="tipo-venta-icon">üì¶</span> M√°x. ${limite} unidades por familia`;
    }
}

function obtenerTextoStock(product) {
    const tipoVenta = obtenerTipoDeVenta(product.name);
    const stockNumber = product.stockNumber || 0;
    
    if (stockNumber === 0) {
        return '‚ùå Sin Stock';
    }
    
    let icono = '';
    let unidad = '';
    
    if (tipoVenta === 'peso') {
        const nombreLower = product.name.toLowerCase();
        
        if (nombreLower.includes(' gr') || nombreLower.includes('gramo') || 
            /\bgr\b/i.test(product.name)) {
            icono = '‚öñÔ∏è';
            unidad = `${stockNumber}g`;
        } else {
            icono = '‚öñÔ∏è';
            unidad = `${stockNumber}kg`;
        }
    } 
    else if (tipoVenta === 'unidad') {
        icono = 'üì¶';
        unidad = `${stockNumber}u`;
    }
    else if (tipoVenta === 'empaque') {
        icono = 'üéÅ';
        unidad = `${stockNumber}pqt`;
    }
    else {
        icono = 'üì¶';
        unidad = `${stockNumber}u`;
    }
    
    if (stockNumber > 0 && stockNumber <= 3) {
        return `‚ö†Ô∏è Stock Bajo ${icono} <span class="stock-tipo">(${unidad})</span>`;
    } else {
        return `‚úÖ En Stock ${icono} <span class="stock-tipo">(${unidad})</span>`;
    }
}

function obtenerTipoDeVenta(nombreProducto) {
    const nombre = nombreProducto.toLowerCase().trim();
    
    const tieneGramosEspecificados = /\d+\s*(gr|g|gramo|gramos)\b/i.test(nombreProducto);
    if (tieneGramosEspecificados) {
        const esProductoSuelto = /^(jengibre|pimienta|comino|oregano|pimenton|laurel|provenzal)\s+gr?\b/i.test(nombreProducto);
        if (!esProductoSuelto) {
            return 'unidad';
        }
    }
    
    if (nombre.includes(' kg') || /\bkg\b/i.test(nombreProducto)) {
        const excepcionesUnidad = ['arroz', 'azucar', 'az√∫car', 'harina', 'sal', 'yerba', 'polenta', 'grasa'];
        const esExcepcion = excepcionesUnidad.some(ex => 
            nombre.includes(ex) && nombre.includes('1 kg')
        );
        if (!esExcepcion) return 'peso';
    }
    
    if (nombre.includes('gaseosa') || nombre.includes('jugo') || 
        nombre.includes('bebida') || nombre.includes('refresco') ||
        nombre.includes('agua') || nombre.includes('helado') ||
        nombre.includes('vino') || nombre.includes('cerveza') ||
        nombre.includes('fernet') || nombre.includes('manaos') ||
        nombre.includes('cunnington') || nombre.includes('powerade')) {
        return 'unidad';
    }
    
    if (nombre.includes('alfajor') || nombre.includes('galletita') ||
        nombre.includes('galleta') || nombre.includes('chocolate') ||
        nombre.includes('caramelo') || nombre.includes('chicle') ||
        nombre.includes('turron') || nombre.includes('golosina') ||
        nombre.includes('snack') || nombre.includes('budin') ||
        nombre.includes('pan dulce') || nombre.includes('pure de tomate') ||
        nombre.includes('salsa de tomate') || nombre.includes('pure') ||
        nombre.includes('salsa')) {
        return 'unidad';
    }
    
    const frutasVerduras = ['tomate', 'durazno', 'manzana', 'naranja', 
                           'cebolla', 'papa', 'zanahoria', 'lechuga',
                           'limon', 'mandarina', 'banana'];
    
    for (const fv of frutasVerduras) {
        if (nombre.includes(fv)) {
            if (!nombre.includes('unidad') && !nombre.includes('unid') && 
                !nombre.includes('u ') && !nombre.includes(' c/u')) {
                return 'peso';
            }
        }
    }
    
    const especiasSuelto = ['jengibre gr', 'pimienta gr', 'comino gr', 
                           'oregano gr', 'pimenton gr', 'laurel gr', 
                           'provenzal gr', 'aji molido gr'];
    
    for (const especia of especiasSuelto) {
        if (nombre.includes(especia)) {
            return 'peso';
        }
    }
    
    return 'unidad';
}

// ========== DETECTAR ERRORES DE PLANILLA ==========
/**
 * Detecta y reporta errores de planilla (productos con ambas ofertas)
 */
function detectarErroresPlanilla() {
    if (!window.products) return [];
    
    const errores = window.products.filter(product => {
        const tieneOferta1 = product.ofertas1 && 
                           product.ofertas1 !== '' && 
                           product.ofertas1 !== '0';
        
        const tieneOferta2 = product.ofertas2 && 
                           product.ofertas2 !== '' && 
                           product.ofertas2 !== '0';
        
        return tieneOferta1 && tieneOferta2;
    });
    
    if (errores.length > 0) {
        console.error('‚ùå ERRORES DE PLANILLA DETECTADOS:', errores.length);
        errores.forEach((p, i) => {
            console.error(`${i+1}. ${p.name} - Ofertas1: ${p.ofertas1}, Ofertas2: ${p.ofertas2}`);
        });
    }
    
    return errores;
}

// ========== VARIABLES GLOBALES ==========
let products = [];
let cart = [];
let currentCategory = "ALMACEN";
let lowStockAlertSent = false;
let esAdmin = false;
let isSearching = false;

// ========== SISTEMA OFERTAS REL√ÅMPAGO ==========
const FLASH_SALES_SYSTEM = {
    ENABLED: true,
    ACTIVE_HOURS: {
        start: 11,
        startMinutes: 30,
        end: 17,
        endMinutes: 0
    },
    ACTIVE_DAYS: [0, 1, 2, 3, 4],
    POOL_SIZE: 15,
    DAILY_SELECTION: 3,
    
    isActive: false,
    todaySelection: [],
    yesterdaySelection: [],
    productPool: [],
    
    init: function() {
        console.log('‚ö° Inicializando sistema de ofertas rel√°mpago...');
        this.checkTimeAndDay();
        this.loadHistory();
        this.loadProductPool();
        this.generateDailySelection();
        this.updateUI();
        this.startCountdown();
        console.log('‚úÖ Sistema rel√°mpago listo. Activo:', this.isActive);
    },
    
    checkTimeAndDay: function() {
        const now = new Date();
        const currentDay = now.getDay();
        const currentHour = now.getHours();
        const currentMinutes = now.getMinutes();
        
        const isActiveDay = this.ACTIVE_DAYS.includes(currentDay);
        
        let isActiveHour = false;
        
        if (currentHour > this.ACTIVE_HOURS.start && 
            currentHour < this.ACTIVE_HOURS.end) {
            isActiveHour = true;
        } else if (currentHour === this.ACTIVE_HOURS.start) {
            isActiveHour = currentMinutes >= this.ACTIVE_HOURS.startMinutes;
        } else if (currentHour === this.ACTIVE_HOURS.end) {
            isActiveHour = currentMinutes < this.ACTIVE_HOURS.endMinutes;
        }
        
        this.isActive = isActiveDay && isActiveHour && this.ENABLED;
        
        return this.isActive;
    },
    
    loadHistory: function() {
        try {
            const today = this.getTodayKey();
            const yesterday = this.getYesterdayKey();
            
            const todayData = localStorage.getItem(`flash_sales_${today}`);
            if (todayData) {
                this.todaySelection = JSON.parse(todayData);
            }
            
            const yesterdayData = localStorage.getItem(`flash_sales_${yesterday}`);
            if (yesterdayData) {
                this.yesterdaySelection = JSON.parse(yesterdayData);
            }
        } catch (error) {
            console.error('‚ùå Error cargando historial:', error);
            this.clearHistory();
        }
    },
    
    saveTodaySelection: function() {
        try {
            const today = this.getTodayKey();
            localStorage.setItem(`flash_sales_${today}`, JSON.stringify(this.todaySelection));
            this.updateHistory();
        } catch (error) {
            console.error('‚ùå Error guardando selecci√≥n:', error);
        }
    },
    
    updateHistory: function() {
        try {
            const today = this.getTodayKey();
            let history = {};
            
            const historyData = localStorage.getItem('flash_sales_history');
            if (historyData) {
                history = JSON.parse(historyData);
            }
            
            history[today] = {
                date: new Date().toISOString(),
                products: this.todaySelection.map(p => p.descripcion),
                count: this.todaySelection.length
            };
            
            const keys = Object.keys(history);
            if (keys.length > 30) {
                const oldestKey = keys.sort()[0];
                delete history[oldestKey];
            }
            
            localStorage.setItem('flash_sales_history', JSON.stringify(history));
        } catch (error) {
            console.error('‚ùå Error actualizando historial:', error);
        }
    },
    
    clearHistory: function() {
        const keysToRemove = [];
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key.startsWith('flash_sales_')) {
                keysToRemove.push(key);
            }
        }
        
        keysToRemove.forEach(key => localStorage.removeItem(key));
    },
    
    loadProductPool: function() {
        if (!window.products || window.products.length === 0) {
            this.productPool = [];
            return;
        }
        
        // SOLO ofertas1 (NO ofertas2)
        const candidates = window.products.filter(product => {
            const tieneOferta1 = product.ofertas1 && 
                               product.ofertas1 !== '' && 
                               product.ofertas1 !== '0' &&
                               OFERTAS_SISTEMA[product.ofertas1];
            
            // NO debe tener ofertas2 (error de planilla)
            const noTieneOferta2 = !product.ofertas2 || 
                                  product.ofertas2 === '' || 
                                  product.ofertas2 === '0';
            
            const tieneStock = product.stockNumber > 0;
            const tieneDescripcion = product.descripcion || product.id;
            
            return tieneOferta1 && noTieneOferta2 && tieneStock && tieneDescripcion;
        });
        
        // Ordenar por tipo de oferta (prioridad 2x1, 3x2, etc.)
        candidates.sort((a, b) => {
            const tipoA = parseInt(a.ofertas1) || 0;
            const tipoB = parseInt(b.ofertas1) || 0;
            return tipoA - tipoB; // Menor n√∫mero = oferta mejor (2x1=1, 3x2=2, etc.)
        });
        
        this.productPool = candidates.slice(0, this.POOL_SIZE);
        
        console.log(`‚ö° Ofertas Rel√°mpago (solo ofertas1): ${candidates.length} candidatos, ${this.productPool.length} en pool`);
    },
    
    generateDailySelection: function() {
        if (this.todaySelection.length > 0) {
            return;
        }
        
        if (this.productPool.length === 0) {
            this.todaySelection = [];
            return;
        }
        
        let availablePool = [...this.productPool];
        const yesterdayIds = this.yesterdaySelection.map(p => p.descripcion || p.id);
        availablePool = availablePool.filter(p => 
            !yesterdayIds.includes(p.descripcion || p.id)
        );
        
        if (availablePool.length < this.DAILY_SELECTION) {
            availablePool = [...this.productPool];
        }
        
        const selected = [];
        const maxAttempts = 50;
        let attempts = 0;
        
        while (selected.length < this.DAILY_SELECTION && 
               availablePool.length > 0 && 
               attempts < maxAttempts) {
            
            const randomIndex = Math.floor(Math.random() * availablePool.length);
            const product = availablePool[randomIndex];
            
            const alreadySelected = selected.some(p => 
                (p.descripcion || p.id) === (product.descripcion || product.id)
            );
            
            if (!alreadySelected) {
                const flashProduct = {
                    ...product,
                    flashPrice: calcularPrecioConDescuento(
                        product.price,
                        product.ofertas1, // SOLO ofertas1
                        '', // NUNCA ofertas2 aqu√≠
                        1
                    ),
                    flashDiscount: product.ofertas1 ? OFERTAS_SISTEMA[product.ofertas1]?.descuentoReal || 0 : 0,
                    flashOriginalPrice: product.price,
                    flashId: product.descripcion || product.id
                };
                
                selected.push(flashProduct);
                availablePool.splice(randomIndex, 1);
            }
            
            attempts++;
        }
        
        this.todaySelection = selected;
        this.saveTodaySelection();
    },
    
 renderFlashProducts: function() {
    const container = document.getElementById('flashProductsGrid');
    if (!container) return;
    
    if (this.todaySelection.length === 0) {
        container.innerHTML = `
            <div style="grid-column: 1 / -1; text-align: center; padding: 2rem; color: #666;">
                ‚è≥ No hay ofertas rel√°mpago disponibles por el momento.
            </div>
        `;
        return;
    }
    
    container.innerHTML = this.todaySelection.map(product => {
        if (!getDisplayProps(product, 'flash')) return '';
        const oferta = OFERTAS_SISTEMA[product.ofertas1];
        const descripcionOferta = oferta ? oferta.eslogan : '';
        
        const textoLimiteOfertas2 = obtenerTextoLimiteOfertas2('', product.name);
        const stockText = obtenerTextoStock(product);
        
        return `
            <div class="flash-product-card">
                <div class="flash-exclusive-badge">‚ö° EXCLUSIVO</div>
                
                <div class="product-image" style="height: 180px;">
                    <img src="${product.image}" 
                         alt="${product.name}"
                         onerror="handleImageError(this, '${product.name.replace(/'/g, "\\'")}')">
                </div>
                
                <div class="product-info" style="padding: 1.2rem;">
                    <div class="product-name" style="font-size: 1rem; font-weight: bold; color: #d50000;">
                        ${product.name}
                    </div>
                    
                    <div class="product-price-container" style="margin: 10px 0;">
                        ${oferta && oferta.tipo === '3x2' ? `
                            <div style="font-size: 1.2rem; color: #333; margin-bottom: 8px;">
                                <strong>$${product.price}</strong> <span style="font-size: 0.9rem; color: #666;">c/u</span>
                            </div>
                            <div style="background: #fff3cd; padding: 10px; border-radius: 8px; margin: 8px 0; border: 2px solid #ff6f00;">
                                <div style="color: #ff6f00; font-weight: bold; font-size: 0.95rem;">
                                    ${descripcionOferta}
                                </div>
                                <div style="color: #666; font-size: 0.85rem; margin-top: 4px;">
                                    üí∞ Ahorr√°s $${product.price} llevando 3 unidades
                                </div>
                            </div>
                            <span class="flash-discount">${oferta.nombre}</span>
                        ` : `
                            <div class="offer-description" style="color: #ff6f00; font-weight: bold; margin: 8px 0;">
                                ${descripcionOferta}
                            </div>
                            <span class="original-price" style="font-size: 1rem;">$${product.price}</span>
                            <span class="flash-price">$${Math.round(product.flashPrice)}</span>
                            <span class="flash-discount">${oferta ? oferta.nombre : 'OFERTA'}</span>
                        `}
                    </div>
                    
                    ${textoLimiteOfertas2 ? `
                        <div class="promo-limit" style="color: #ff3d00; font-weight: bold; margin: 5px 0;">
                            ‚ö†Ô∏è ${textoLimiteOfertas2}
                        </div>
                    ` : ''}
                    
                    <div class="product-stock in-stock" style="margin: 8px 0;">
                        ${stockText}
                    </div>
                    
                    <button class="add-to-cart" 
                            data-id="${product.id}"
                            style="background: linear-gradient(135deg, #ff3d00, #d50000);">
                        üõí Agregar al Carrito
                    </button>
                    
                    <div style="font-size: 0.75rem; color: #666; margin-top: 8px; text-align: center;">
                        ‚ö° Oferta v√°lida solo hoy hasta las 17:00
                    </div>
                </div>
            </div>
        `;
    }).join('');
    
    setTimeout(() => {
        this.addFlashCartEventListeners();
    }, 100);
},
    
    addFlashCartEventListeners: function() {
        document.querySelectorAll('#flashProductsGrid .add-to-cart').forEach(btn => {
            btn.replaceWith(btn.cloneNode(true));
        });
        
        document.querySelectorAll('#flashProductsGrid .add-to-cart').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const productId = parseInt(btn.getAttribute('data-id'));
                this.addFlashProductToCart(productId);
            });
        });
    },
    
    addFlashProductToCart: function(productId) {
        const product = this.todaySelection.find(p => p.id === productId);
        if (!product) return;
        
        if (typeof addToCart === 'function') {
            addToCart(productId);
            this.showFlashFeedback(product.name, product.ofertas1);
        }
    },
    
    showFlashFeedback: function(productName, oferta1) {
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 120px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #ff3d00, #d50000);
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            box-shadow: 0 6px 20px rgba(255, 61, 0, 0.4);
            z-index: 1003;
            font-weight: 600;
            font-size: 14px;
            animation: slideDown 0.3s ease;
            border: 2px solid white;
            text-align: center;
            min-width: 250px;
        `;
        
        const oferta = OFERTAS_SISTEMA[oferta1];
        const textoOferta = oferta ? oferta.nombre : 'OFERTA';
        
        notification.innerHTML = `
            ‚ö° <strong>¬°OFERTA REL√ÅMPAGO!</strong><br>
            ${productName} - ${textoOferta}
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 2000);
    },
    
    updateUI: function() {
        const container = document.getElementById('flashSalesContainer');
        const timer = document.getElementById('flashTimer');
        const overlay = document.getElementById('flashCountdownOverlay');
        
        if (!container || !timer || !overlay) return;
        
        if (this.isActive) {
            container.style.display = 'block';
            timer.style.display = 'inline-flex';
            overlay.style.display = 'none';
            this.renderFlashProducts();
        } else {
            const now = new Date();
            const currentDay = now.getDay();
            const isActiveDay = this.ACTIVE_DAYS.includes(currentDay);
            const currentHour = now.getHours();
            
            if (isActiveDay && this.ENABLED) {
                if (currentHour < this.ACTIVE_HOURS.start || 
                    (currentHour === this.ACTIVE_HOURS.start && 
                     now.getMinutes() < this.ACTIVE_HOURS.startMinutes)) {
                    container.style.display = 'none';
                } else {
                    container.style.display = 'block';
                    timer.style.display = 'none';
                    overlay.style.display = 'flex';
                    this.renderTomorrowCountdown();
                }
            } else {
                container.style.display = 'none';
            }
        }
    },
    
    startCountdown: function() {
        if (!this.isActive) {
            this.startTomorrowCountdown();
            return;
        }
        
        const countdownElement = document.getElementById('countdown');
        if (!countdownElement) return;
        
        const updateCountdown = () => {
            const now = new Date();
            const endTime = new Date();
            
            endTime.setHours(this.ACTIVE_HOURS.end, this.ACTIVE_HOURS.endMinutes, 0, 0);
            
            if (now >= endTime) {
                this.isActive = false;
                this.updateUI();
                return;
            }
            
            const diff = endTime - now;
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);
            
            countdownElement.textContent = 
                `${hours.toString().padStart(2, '0')}:` +
                `${minutes.toString().padStart(2, '0')}:` +
                `${seconds.toString().padStart(2, '0')}`;
            
            if (hours === 0 && minutes < 30) {
                countdownElement.style.color = '#ff3d00';
                countdownElement.style.fontWeight = 'bold';
            }
            
            requestAnimationFrame(updateCountdown);
        };
        
        updateCountdown();
    },
    
    startTomorrowCountdown: function() {
        const nextCountdownElement = document.getElementById('nextFlashCountdown');
        if (!nextCountdownElement) return;
        
        const updateNextCountdown = () => {
            const now = new Date();
            let nextFlashTime = new Date();
            
            const currentDay = now.getDay();
            const currentHour = now.getHours();
            
            if (this.ACTIVE_DAYS.includes(currentDay) && 
                currentHour >= this.ACTIVE_HOURS.end) {
                nextFlashTime.setDate(now.getDate() + 1);
            }
            
            while (!this.ACTIVE_DAYS.includes(nextFlashTime.getDay())) {
                nextFlashTime.setDate(nextFlashTime.getDate() + 1);
            }
            
            nextFlashTime.setHours(this.ACTIVE_HOURS.start, 
                                 this.ACTIVE_HOURS.startMinutes, 0, 0);
            
            const diff = nextFlashTime - now;
            
            if (diff <= 0) {
                requestAnimationFrame(updateNextCountdown);
                return;
            }
            
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);
            
            let countdownText = '';
            if (days > 0) {
                countdownText += `${days}d `;
            }
            countdownText += 
                `${hours.toString().padStart(2, '0')}:` +
                `${minutes.toString().padStart(2, '0')}:` +
                `${seconds.toString().padStart(2, '0')}`;
            
            nextCountdownElement.textContent = countdownText;
            
            requestAnimationFrame(updateNextCountdown);
        };
        
        updateNextCountdown();
    },
    
    renderTomorrowCountdown: function() {
        const element = document.getElementById('nextFlashCountdown');
        if (!element) return;
        
        this.startTomorrowCountdown();
    },
    
    getTodayKey: function() {
        const today = new Date();
        return `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}-${today.getDate().toString().padStart(2, '0')}`;
    },
    
    getYesterdayKey: function() {
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        return `${yesterday.getFullYear()}-${(yesterday.getMonth() + 1).toString().padStart(2, '0')}-${yesterday.getDate().toString().padStart(2, '0')}`;
    }
};

// ========== SISTEMA DE FILTRADO CENTRALIZADO ==========
const ProductFilterSystem = {
  /**
   * Obtiene productos filtrados seg√∫n el contexto actual
   */
  getFilteredProducts(options = {}) {
    const {
      category = currentCategory,
      isSearchMode = isSearching,
      searchTerm = '',
      excludeFlashSales = true,
      excludeFeaturedOffers = true,
      onlyFlashSales = false,
      onlyFeaturedOffers = false,
      limit = null
    } = options;

    if (!window.products || !Array.isArray(window.products)) {
      console.warn('‚ö†Ô∏è No hay productos disponibles para filtrar');
      return [];
    }

    console.log(`üîç FILTRANDO productos - Categor√≠a: ${category}, B√∫squeda: ${isSearchMode ? 'S√≠' : 'No'}`);

    let filtered = [...window.products];

    if (onlyFlashSales) {
      return this._getFlashSalesProducts();
    }

    if (onlyFeaturedOffers) {
      return this._getFeaturedOffersProducts();
    }

    if (excludeFlashSales) {
      filtered = this._excludeFlashSales(filtered);
    }

    if (excludeFeaturedOffers) {
      filtered = this._excludeFeaturedOffers(filtered);
    }

    if (category !== 'ALL' && !isSearchMode) {
      filtered = filtered.filter(p => p.category === category);
    }

    if (isSearchMode && searchTerm.trim().length >= 2) {
      filtered = this._filterBySearchTerm(filtered, searchTerm);
    }

    filtered = filtered.filter(p => p.stockNumber > 0);
    filtered = this._sortProducts(filtered);

    // Excluir productos que est√°n en cualquier secci√≥n especial
    filtered = filtered.filter(p => {
        const enRelampago = FLASH_SALES_SYSTEM?.todaySelection?.some(
            flash => flash.id === p.id
        ) || false;
        
        const enDestacadas = window.productosDestacadosIds?.includes(p.id) || false;
        
        return !enRelampago && !enDestacadas;
    });

    if (limit && limit > 0) {
      filtered = filtered.slice(0, limit);
    }

    console.log(`‚úÖ Filtrados ${filtered.length} productos`);
    return filtered;
  },

  _getFlashSalesProducts() {
    if (!FLASH_SALES_SYSTEM || !FLASH_SALES_SYSTEM.todaySelection) {
      return [];
    }
    return FLASH_SALES_SYSTEM.todaySelection.filter(p => p.stockNumber > 0);
  },

  _getFeaturedOffersProducts() {
    // SOLO ofertas2, NO ofertas1
    const productosConOferta2 = window.products.filter(product => {
        const tieneOferta2 = product.ofertas2 && 
                           product.ofertas2 !== '' && 
                           product.ofertas2 !== '0' && 
                           !isNaN(parseInt(product.ofertas2));
        
        // NO debe tener ofertas1 (error de planilla)
        const noTieneOferta1 = !product.ofertas1 || 
                              product.ofertas1 === '' || 
                              product.ofertas1 === '0';
        
        const tieneStock = product.stockNumber > 0;
        
        return tieneOferta2 && noTieneOferta1 && tieneStock;
    });
    
    // Ordenar por % de descuento
    return productosConOferta2
      .sort((a, b) => {
        const descA = parseInt(a.ofertas2);
        const descB = parseInt(b.ofertas2);
        return descB - descA;
      })
      .slice(0, 9);
  },

  _excludeFlashSales(productsArray) {
    if (!FLASH_SALES_SYSTEM || !FLASH_SALES_SYSTEM.todaySelection) {
      return productsArray;
    }
    
    const flashIds = FLASH_SALES_SYSTEM.todaySelection.map(p => p.id);
    return productsArray.filter(p => !flashIds.includes(p.id));
  },

  _excludeFeaturedOffers(productsArray) {
    if (!window.productosDestacadosIds) {
      return productsArray;
    }
    
    return productsArray.filter(p => !window.productosDestacadosIds.includes(p.id));
  },

  _filterBySearchTerm(productsArray, searchTerm) {
    const normalizedTerm = normalizeSearchTerm(searchTerm);
    const expandedTerms = expandSearchTerms(searchTerm);
    
    return productsArray.filter(product => {
      const productName = normalizeSearchTerm(product.name);
      const hasStock = product.stockNumber > 0;
      
      if (!hasStock) return false;
      
      return expandedTerms.some(term => {
        if (productName.includes(term) && term.length > 1) return true;
        
        if (term.length <= 3 && term.length > 1) {
          const initials = productName.split(' ')
            .map(word => word.charAt(0))
            .join('');
          return initials.includes(term);
        }
        
        return false;
      });
    });
  },

  _sortProducts(productsArray) {
    return [...productsArray].sort((a, b) => {
      if (a.hasPromo && !b.hasPromo) return -1;
      if (!a.hasPromo && b.hasPromo) return 1;
      
      if (a.stockNumber !== b.stockNumber) {
        return b.stockNumber - a.stockNumber;
      }
      
      return a.name.localeCompare(b.name);
    });
  },

  getFilterStats() {
    return {
      totalProducts: window.products?.length || 0,
      withStock: window.products?.filter(p => p.stockNumber > 0).length || 0,
      withOffers1: window.products?.filter(p => p.ofertas1 && p.ofertas1 !== '' && p.ofertas1 !== '0').length || 0,
      withOffers2: window.products?.filter(p => p.ofertas2 && p.ofertas2 !== '' && p.ofertas2 !== '0').length || 0,
      flashSalesCount: FLASH_SALES_SYSTEM?.todaySelection?.length || 0,
      currentCategory,
      isSearching,
      searchTerm: document.getElementById('productSearch')?.value || ''
    };
  }
};

// ========== SISTEMA DE RENDERIZADO ==========
const ProductRenderer = {
  /**
   * Renderiza la grilla principal de productos
   */
renderMainProductsGrid(context = 'category') {
  const productsGrid = document.getElementById('productsGrid');
  if (!productsGrid) return;
  
  const options = {
    category: currentCategory,
    excludeFlashSales: true,
    excludeFeaturedOffers: true
  };
  
  if (isSearching) {
    options.isSearchMode = true;
    options.searchTerm = document.getElementById('productSearch')?.value || '';
  }
  
  // 1Ô∏è‚É£ obtenemos todos los productos como siempre
  const allProducts = ProductFilterSystem.getFilteredProducts(options);

  // 2Ô∏è‚É£ filtramos SOLO los visibles seg√∫n getDisplayProps
  const products = allProducts.filter(
    p => getDisplayProps(p, 'grid') !== null
  );
  
  if (products.length === 0) {
    this._renderEmptyState(productsGrid, context);
    return;
  }
  
  this._renderProductsGrid(productsGrid, products, context);
},

  /**
   * Renderiza la secci√≥n de ofertas rel√°mpago
   */
  renderFlashSalesSection() {
    const container = document.getElementById('flashSalesContainer');
    const grid = document.getElementById('flashProductsGrid');
    
    if (!container || !grid) return;
    
    if (FLASH_SALES_SYSTEM && FLASH_SALES_SYSTEM.renderFlashProducts) {
      FLASH_SALES_SYSTEM.renderFlashProducts();
    }
  },

  /**
   * Renderiza la secci√≥n de ofertas destacadas
   * SOLO con ofertas2, SOLO en horario Viernes/S√°bados 18:00-23:00
   */
  renderFeaturedOffersSection() {
    const container = document.getElementById('featuredOffers');
    const grid = document.getElementById('featuredProductsGrid');
    
    if (!container || !grid) return;
    
    // 1. VALIDAR HORARIO (OBLIGATORIO)
    if (!isValidFeaturedOffersTime()) {
        container.style.display = 'none';
        grid.innerHTML = '';
        console.log('‚è∞ Ofertas Destacadas: Fuera de horario - Secci√≥n oculta');
        return;
    }
    
    // 2. FILTRAR PRODUCTOS EXCLUSIVAMENTE POR OFERTAS2
    const featuredProducts = window.products?.filter(product => {
        // SOLO ofertas2 (NO ofertas1)
        const tieneOferta2 = product.ofertas2 && 
                           product.ofertas2 !== '' && 
                           product.ofertas2 !== '0' && 
                           !isNaN(parseInt(product.ofertas2));
        
        // NO debe tener ofertas1 (error de planilla)
        const noTieneOferta1 = !product.ofertas1 || 
                              product.ofertas1 === '' || 
                              product.ofertas1 === '0';
        
        // Stock v√°lido
        const tieneStock = product.stockNumber > 0;
        
        return tieneOferta2 && noTieneOferta1 && tieneStock;
    }) || [];
    
    console.log(`üéØ Ofertas Destacadas (solo ofertas2): ${featuredProducts.length} productos`);
    
    // 3. MOSTRAR/OCULTAR SEG√öN RESULTADOS
    if (featuredProducts.length === 0) {
        container.style.display = 'none';
        grid.innerHTML = '';
        console.log('üì≠ Ofertas Destacadas: No hay productos v√°lidos');
        return;
    }
    
    // 4. ORDENAR POR % DESCUENTO (ofertas2)
    featuredProducts.sort((a, b) => {
        const descA = parseInt(a.ofertas2);
        const descB = parseInt(b.ofertas2);
        return descB - descA; // Mayor a menor
    });
    
    // 5. LIMITAR A 9 PRODUCTOS
    const limitedProducts = featuredProducts.slice(0, 9);
    
    // 6. RENDERIZAR
    container.style.display = 'block';
    grid.innerHTML = limitedProducts.map(product => this._renderFeaturedProductCard(product)).join('');
    
    window.productosDestacadosIds = limitedProducts.map(p => p.id);
    
    // 7. AGREGAR EVENTOS (sin compartir l√≥gica)
    setTimeout(() => this._addCartEventListenersToFeatured(), 100);
    
    console.log(`‚úÖ Ofertas Destacadas renderizadas: ${limitedProducts.length} productos`);
  },

  /**
   * Renderiza tarjeta individual de oferta destacada
   * Solo con datos de ofertas2
   */
  _renderFeaturedProductCard(product) {
    const descuento = parseInt(product.ofertas2);
    const precioConDescuento = calcularPrecioConDescuento(
        product.price, 
        '', // NUNCA usar ofertas1 aqu√≠
        product.ofertas2, 
        1
    );
    
    const stockText = obtenerTextoStock(product);
    const textoLimite = obtenerTextoLimiteOfertas2(product.ofertas2, product.name);
    
    return `
        <div class="product-card">
            <div class="offer-badge" style="background: linear-gradient(135deg, #ff6f00, #f57c00);">
                üî• ${descuento}% OFF
            </div>
            
            <div class="product-image">
                <img src="${product.image}" 
                     alt="${product.name}"
                     onerror="handleImageError(this, '${product.name.replace(/'/g, "\\'")}')">
            </div>
            
            <div class="product-info">
                <div class="product-name">${product.name}</div>
                
                <div class="offer-description" style="color: #ff6f00; font-weight: bold;">
                    ¬°${descuento}% DE DESCUENTO!
                </div>
                
                <div class="product-price-container">
                    <span class="original-price">$${product.price}</span>
                    <span class="product-price">$${Math.round(precioConDescuento)}</span>
                    <span class="discount-percent">${descuento}% OFF</span>
                </div>
                
                ${textoLimite ? `
                    <div class="promo-limit" style="color: #ff6f00; font-weight: 500;">
                        ${textoLimite}
                    </div>
                ` : ''}
                
                <div class="product-stock in-stock">
                    ${stockText}
                </div>
                
                <button class="add-to-cart" data-id="${product.id}">
                    üõí Agregar al Carrito
                </button>
                
                <div style="font-size: 0.75rem; color: #666; margin-top: 8px; text-align: center;">
                    ‚≠ê OFERTA DESTACADA - Viernes y S√°bados 18:00-23:00
                </div>
            </div>
        </div>
    `;
  },

  /**
   * Eventos exclusivos para destacadas (sin compartir)
   */
  _addCartEventListenersToFeatured() {
    document.querySelectorAll('#featuredProductsGrid .add-to-cart').forEach(btn => {
        btn.replaceWith(btn.cloneNode(true));
    });
    
    document.querySelectorAll('#featuredProductsGrid .add-to-cart').forEach(btn => {
        btn.addEventListener('click', function() {
            const productId = parseInt(this.getAttribute('data-id'));
            addToCart(productId);
        });
    });
  },

  /**
   * Renderiza resultados de b√∫squeda
   */
  renderSearchResults(searchTerm) {
    const productsGrid = document.getElementById('productsGrid');
    if (!productsGrid) return;
    
    const products = ProductFilterSystem.getFilteredProducts({
      isSearchMode: true,
      searchTerm: searchTerm,
      excludeFlashSales: true,
      excludeFeaturedOffers: false
    });
    
    if (products.length === 0) {
      this._renderEmptySearchState(productsGrid, searchTerm);
      return;
    }
    
    this._renderSearchResultsGrid(productsGrid, products, searchTerm);
  },

  /**
   * Renderiza resultados de b√∫squeda m√≥vil
   */
  renderMobileSearchResults(searchTerm) {
    const resultsContainer = document.getElementById('mobileSearchResults');
    if (!resultsContainer) return;
    
    const products = ProductFilterSystem.getFilteredProducts({
      isSearchMode: true,
      searchTerm: searchTerm,
      excludeFlashSales: true,
      excludeFeaturedOffers: false
    });
    
    if (products.length === 0) {
      resultsContainer.innerHTML = this._renderEmptyMobileSearch(searchTerm);
      return;
    }
    
    resultsContainer.innerHTML = this._renderMobileSearchResults(products);
    setTimeout(() => this._addCartEventListeners(), 100);
  },

  // ========== M√âTODOS PRIVADOS DE RENDERIZADO ==========
  _renderEmptyState(container, context) {
    let message = '';
    
    switch(context) {
      case 'search':
        message = 'üîç No se encontraron productos para tu b√∫squeda';
        break;
      case 'category':
        message = `üõí No hay productos disponibles en "${currentCategory}"`;
        break;
      default:
        message = 'üõí No hay productos disponibles';
    }
    
    container.innerHTML = `
      <div class="loading" style="text-align: center; padding: 3rem;">
        <div style="font-size: 3rem; margin-bottom: 1rem;">üòï</div>
        <h3>${message}</h3>
        ${context === 'search' ? `
          <button onclick="clearSearch()" class="retry-btn" style="margin-top: 1rem;">
            ‚ú® Ver todos los productos
          </button>
        ` : ''}
      </div>
    `;
  },

  _renderEmptySearchState(container, searchTerm) {
    container.innerHTML = `
      <div class="loading" style="text-align: center; padding: 3rem;">
        <div style="font-size: 3rem; margin-bottom: 1rem;">üîç</div>
        <h3>No se encontraron productos para "<strong>${searchTerm}</strong>"</h3>
        <p style="color: #666; margin: 1rem 0;">Prueba con otros t√©rminos o revisa la ortograf√≠a</p>
        <button onclick="clearSearch()" class="retry-btn" style="margin-top: 1rem;">
          ‚ú® Ver todos los productos
        </button>
      </div>
    `;
  },


  _renderProductsGrid(container, products, context) {
    let header = '';
    
    if (context === 'search') {
      const searchTerm = document.getElementById('productSearch')?.value || '';
      header = `
        <div class="search-results">
          <strong>üîç B√∫squeda inteligente: "${searchTerm}"</strong>
          <br>
          <small>Encontraste ${products.length} producto(s)</small>
          <button onclick="clearSearch()" style="margin-left: 10px; padding: 6px 12px; 
                  background: #ff6f00; color: white; border: none; border-radius: 15px; 
                  cursor: pointer; font-size: 0.8rem;">
            ‚úñÔ∏è Limpiar b√∫squeda
          </button>
        </div>
      `;
    }
    
    // üî• FILTRAR productos que est√°n en ofertas especiales
    const filteredProducts = products.filter(p => getDisplayProps(p, 'grid') !== null);
container.innerHTML = header + this._renderProductsToHTML(filteredProducts);
setTimeout(() => this._addCartEventListeners(), 100);
  },

  _renderSearchResultsGrid(container, products, searchTerm) {
    const header = `
      <div class="search-results">
        <strong>üîç B√∫squeda inteligente: "${searchTerm}"</strong>
        <br>
        <small>Encontraste ${products.length} producto(s)</small>
        <button onclick="clearSearch()" style="margin-left: 10px; padding: 6px 12px; 
                background: #ff6f00; color: white; border: none; border-radius: 15px; 
                cursor: pointer; font-size: 0.8rem;">
          ‚úñÔ∏è Limpiar b√∫squeda
        </button>
      </div>
    `;
    
    container.innerHTML = header + this._renderProductsToHTML(products);
    setTimeout(() => this._addCartEventListeners(), 100);
  },

  _renderProductsToHTML(productsArray) {
    if (!productsArray || !Array.isArray(productsArray)) {
      return '<div class="error-message">‚ùå Error al renderizar productos</div>';
    }
    
    return productsArray.map(product => {
      return renderProductsToHTML([product]);
    }).join('');
  },

  _renderMobileSearchResults(products) {
    return '<div style="display: grid; gap: 1rem;">' + 
           products.map(product => this._renderMobileProductCard(product)).join('') + 
           '</div>';
  },

  _renderMobileProductCard(product) {
    const stockText = obtenerTextoStock(product);
    const isOutOfStock = product.stockNumber === 0;
    
    const stockClass = isOutOfStock ? 'out-of-stock' : 
                      product.stockNumber <= 3 ? 'low-stock' : 'in-stock';
    
    const addButton = isOutOfStock 
      ? `<button class="add-to-cart" disabled>‚ùå Sin Stock</button>`
      : `<button class="add-to-cart" data-id="${product.id}">üõí Agregar al Carrito</button>`;
    
    const textoCortoOferta = obtenerTextoCortoOferta(product.ofertas1, product.ofertas2);
    const offerBadge = textoCortoOferta 
      ? `<div class="offer-badge">${textoCortoOferta}</div>`
      : '';
    
    const descripcionOferta = obtenerDescripcionOferta(product.ofertas1, product.ofertas2, product.price);
    const detalleOferta = product.ofertas1 ? 
      obtenerDetalleOferta3x2(product.ofertas1, product.price, 1) : '';
    
    const textoLimiteOfertas2 = obtenerTextoLimiteOfertas2(product.ofertas2, product.name);
    
    return `
      <div class="product-card" style="margin: 0;">
        ${offerBadge}
        <div class="product-image">
          <img src="${product.image}" 
               alt="${product.name}"
               onerror="handleImageError(this, '${product.name.replace(/'/g, "\\'")}')">
        </div>
        <div class="product-info">
          <div class="product-name">${product.name}</div>
          ${descripcionOferta ? `<div class="offer-description">${descripcionOferta}</div>` : ''}
          ${detalleOferta}
          <div class="product-price-container">
            ${product.hasPromo && product.discountedPrice < product.price ? 
              `<span class="original-price">$${product.price}</span>` : ''}
            <span class="product-price">$${Math.round(product.discountedPrice)}</span>
            ${textoCortoOferta ? 
              `<span class="discount-percent">${textoCortoOferta.replace('üî• ', '').replace('üéØ ', '')}</span>` : ''}
          </div>
          ${textoLimiteOfertas2 ? `
            <div class="promo-limit" style="color: #ff6f00; font-weight: 500;">
              ${textoLimiteOfertas2}
            </div>
          ` : ''}
          <div class="product-stock ${stockClass}">
            ${stockText}
          </div>
          ${addButton}
        </div>
      </div>
    `;
  },

  _renderEmptyMobileSearch(searchTerm) {
    return `
      <div style="text-align: center; padding: 2rem; color: #666;">
        üîç No se encontraron productos para "<strong>${searchTerm}</strong>"
      </div>
    `;
  },

  _addCartEventListeners() {
    document.querySelectorAll(".add-to-cart").forEach(btn => {
      btn.replaceWith(btn.cloneNode(true));
    });
    
    document.querySelectorAll(".add-to-cart").forEach(btn => {
      btn.addEventListener("click", function() {
        const productId = parseInt(this.getAttribute("data-id"));
        if (typeof addToCart === 'function') {
          addToCart(productId);
        }
      });
    });
  }
};

// ========== ELEMENTOS DOM ==========
const categoriesContainer = document.getElementById("categories");
const productsGrid = document.getElementById("productsGrid");
const featuredOffers = document.getElementById("featuredOffers");
const featuredProductsGrid = document.getElementById("featuredProductsGrid");
const viewAllOffers = document.getElementById("viewAllOffers");
const cartIcon = document.getElementById("cartIcon");
const floatingCart = document.getElementById("floatingCart");
const floatingSearch = document.getElementById("floatingSearch");
const floatingHome = document.getElementById("floatingHome");
const searchModal = document.getElementById("searchModal");
const closeSearch = document.getElementById("closeSearch");
const mobileSearch = document.getElementById("mobileSearch");
const mobileSearchResults = document.getElementById("mobileSearchResults");
const cartModal = document.getElementById("cartModal");
const closeCart = document.getElementById("closeCart");
const cartItems = document.getElementById("cartItems");
const cartTotal = document.getElementById("cartTotal");
const cartCount = document.getElementById("cartCount");
const floatingCartCount = document.getElementById("floatingCartCount");
const sendOrder = document.getElementById("sendOrder");
const adminBadge = document.getElementById("adminBadge");
const adminNotification = document.getElementById("adminNotification");
const productSearch = document.getElementById("productSearch");
const clearSearchBtn = document.getElementById("clearSearchBtn");
const clearMobileSearchBtn = document.getElementById("clearMobileSearchBtn");
const searchSuggestions = document.getElementById("searchSuggestions");

// ========== FUNCIONES PRINCIPALES ==========
window.handleMobileSearchEnter = function(event) {
    if (event.key === 'Enter') {
        event.preventDefault();
        const searchTerm = mobileSearch.value.trim();
        if (searchTerm.length >= 2) {
            filterMobileProducts(searchTerm);
            mobileSearch.blur();
        }
    }
};

function sendOrderViaWhatsApp() {
    if (cart.length === 0) {
        alert("Tu carrito est√° vac√≠o.");
        return;
    }
    
    const phoneNumber = "5492944907380";
    
    let totalOriginal = 0;
    let totalExacto = 0;
    let totalRedondeado = 0;
    let totalAhorroDescuentos = 0;
    let orderLines = [];
    let ofertasCount = 0;

    cart.forEach(item => {
        const product = products.find(p => p.id === item.id);
        if (!product) return;
        
        const precioOriginalTotal = product.price * item.quantity;
        totalOriginal += precioOriginalTotal;
        
        let precioExactoUnitario = calcularPrecioConDescuento(
            product.price, 
            product.ofertas1, 
            product.ofertas2, 
            item.quantity
        );
        
        const precioExactoTotal = precioExactoUnitario * item.quantity;
        totalExacto += precioExactoTotal;
        
        const precioRedondeadoUnitario = precioExactoUnitario;
        const precioRedondeadoTotal = precioRedondeadoUnitario * item.quantity;
        totalRedondeado += precioRedondeadoTotal;
        
        if (precioExactoUnitario < product.price) {
            ofertasCount++;
            totalAhorroDescuentos += (product.price * item.quantity) - precioExactoTotal;
        }
        
        const nombreUpper = product.name.toUpperCase();
        const tuvoOferta = precioExactoUnitario < product.price;
        let icono = tuvoOferta ? 'üî•' : '‚úÖ';
        
        let tipoOferta = '';
        if (product.ofertas2 && product.ofertas2 !== '0') {
            const descuento = parseInt(product.ofertas2);
            if (descuento >= 50) {
                tipoOferta = ` (¬°OFERT√ìN!)`;
            } else if (descuento >= 30) {
                tipoOferta = ` (¬°GRAN OFERTA!)`;
            } else {
                tipoOferta = ` (¬°OFERTA!)`;
            }
        } else if (product.ofertas1 && product.ofertas1 !== '0') {
            if (OFERTAS_SISTEMA[product.ofertas1]) {
                tipoOferta = ` (${OFERTAS_SISTEMA[product.ofertas1].nombre})`;
            }
        }
        
        let descripcion = `${icono} ${nombreUpper}${tipoOferta}\n`;
        const precioUnitarioRedondeado = Math.round(precioRedondeadoUnitario);
        const precioTotalRedondeado = Math.round(precioRedondeadoTotal);
        descripcion += `   ${item.quantity} √ó $${precioUnitarioRedondeado} = $${precioTotalRedondeado}`;
        
        if (product.ofertas1 === '1' && item.quantity >= 3) {
            const grupos3x2 = Math.floor(item.quantity / 3);
            const sobrantes = item.quantity % 3;
            
            if (grupos3x2 > 0) {
                if (grupos3x2 === 1 && sobrantes === 0) {
                    descripcion += `\n   üì¶ ¬°Llev√° 3, pag√° 2!`;
                } else if (grupos3x2 > 1) {
                    descripcion += `\n   üì¶ Incluye ${grupos3x2} promo(s) 3x2`;
                }
            }
        }
        
        orderLines.push(descripcion);
    });

    const ahorroPorRedondeo = totalExacto - totalRedondeado;
    const ahorroTotal = totalOriginal - totalRedondeado;
    const porcentajeTotal = Math.round((ahorroTotal / totalOriginal) * 100);
    
    let message = `*üõí PEDIDO ALMAC√âN COPIHUE*\n`;
    message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
    message += `üì¶ *TU COMPRA:*\n\n`;
    
    orderLines.forEach(line => {
        message += line + '\n\n';
    });
    
    message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
    
    if (ofertasCount > 0) {
        const textoOfertas = ofertasCount === 1 ? '1 OFERTA' : `${ofertasCount} OFERTAS`;
        message += `üéä *¬°GENIAL! APROVECHASTE ${textoOfertas}!*\n`;
    }
    
    message += `üõçÔ∏è  *Productos:* ${cart.length} items\n`;
    message += `üìä *Unidades:* ${cart.reduce((sum, item) => sum + item.quantity, 0)}\n\n`;
    
    if (ahorroTotal > 0) {
        message += `üí∞ *Precio original:* $${totalOriginal.toFixed(0)}\n`;
        message += `‚ö° *¬°AHORRASTE $${ahorroTotal.toFixed(0)}!*\n`;
        message += `üéØ *Descuento total: ${porcentajeTotal}%*\n\n`;
        
        if (ahorroPorRedondeo > 0) {
            message += `‚ú® *Incluye $${ahorroPorRedondeo.toFixed(0)} de redondeo a tu favor*\n\n`;
        }
        
        if (porcentajeTotal >= 30) {
            message += `üèÜ *¬°Compra inteligente!*\n\n`;
        }
    }
    
    message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
    message += `üíµ *TOTAL A PAGAR:* $${totalRedondeado.toFixed(0)}\n`;
    message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
    
    message += `üöÄ *¬°TU PEDIDO EST√Å LISTO!*\n\n`;
    
    message += `‚úÖ *Retiro r√°pido en 15-20 min*\n`;
    message += `‚úÖ *Productos frescos y de calidad*\n`;
    message += `‚úÖ *Atenci√≥n personalizada*\n`;
    message += `‚úÖ *Precios de barrio*\n\n`;
    
    message += `üìç *Direcci√≥n:* Copihue 457\n`;
    message += `‚è∞ *Horario:* 11:30 a 23:30 hs\n`;
    message += `üì± *Confirm√° por este WhatsApp*\n\n`;
    
    if (ahorroTotal > 0) {
        message += `üí° *¬øSab√≠as que ahorraste $${ahorroTotal.toFixed(0)}?*\n`;
        message += `üéâ *¬°Ese ahorro ya es ganancia para vos!*\n\n`;
    }
    
    message += `‚è≥ *Pedido listo en 15-20 minutos*\n`;
    message += `üéÅ *Gracias por elegir tu almac√©n de confianza*\n\n`;
    
    message += `#Almac√©nCopihue #PreciosDeBarrio #LaConfianzaDeSiempre`;
    
    const encodedMessage = encodeURIComponent(message);
    const whatsappURL = `https://wa.me/${phoneNumber}?text=${encodedMessage}`;
    
    cart = [];
    updateCartCount();
    closeCartModal();
    
    if (typeof showNotification === 'function') {
        showNotification(`‚úÖ Pedido listo para enviar por WhatsApp`, 'success');
    }
    
    setTimeout(() => {
        window.open(whatsappURL, "_blank");
    }, 800);
}

// ========== B√öSQUEDA ==========
const SEARCH_DICTIONARY = {
    'tomate': ['tomates'],
    'durazno': ['duraznos'],
    'manzana': ['manzanas'],
    'naranja': ['naranjas'],
    'limon': ['limones'],
    'cebolla': ['cebollas'],
    'papa': ['papas'],
    'zanahoria': ['zanahorias'],
    'lechuga': ['lechugas'],
    'kg': ['kilo', 'kilos'],
    'gr': ['gramo', 'gramos'],
    'unid': ['unidad', 'unidades'],
    'alfajor': ['alfajores'],
    'alfajores': ['alfajor'],
    'galletita': ['galletitas', 'galletas'],
    'galleta': ['galletas', 'galletita'],
    'chocolate': ['chocolates'],
    'chocolates': ['chocolate']
};

function normalizeSearchTerm(term) {
    let normalized = term.toLowerCase().trim();
    normalized = normalized.replace(/[^\w\s]/g, ' ');
    normalized = normalized.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
    normalized = normalized.replace(/\s+/g, ' ');
    return normalized;
}

function expandSearchTerms(searchTerm) {
    const normalizedTerm = normalizeSearchTerm(searchTerm);
    const words = normalizedTerm.split(' ');
    const expandedTerms = new Set();
    
    expandedTerms.add(normalizedTerm);
    
    words.forEach(word => {
        if (word.length < 2) return;
        
        expandedTerms.add(word);
        
        for (const [key, synonyms] of Object.entries(SEARCH_DICTIONARY)) {
            if (key === word) {
                synonyms.forEach(synonym => expandedTerms.add(synonym));
            }
            
            if (synonyms.includes(word)) {
                expandedTerms.add(key);
                synonyms.forEach(synonym => expandedTerms.add(synonym));
            }
        }
    });
    
    if (words.length > 1) {
        expandedTerms.add(words.join(''));
        expandedTerms.add(words.join('-'));
        
        if (words.length === 2) {
            expandedTerms.add(`${words[1]} ${words[0]}`);
        }
    }
    
    return Array.from(expandedTerms);
}

function searchProducts(searchTerm) {
    if (!products || products.length === 0) return [];
    if (searchTerm.length < 2) return [];
    
    const expandedTerms = expandSearchTerms(searchTerm);
    
    const results = products.filter(product => {
        const productName = normalizeSearchTerm(product.name);
        const hasStock = product.stock === "STOCK" || product.stockNumber > 0;
        
        if (!hasStock) return false;
        
        return expandedTerms.some(term => {
            if (productName.includes(term) && term.length > 1) return true;
            
            if (term.length <= 3 && term.length > 1) {
                const initials = productName.split(' ')
                    .map(word => word.charAt(0))
                    .join('');
                if (initials.includes(term)) return true;
            }
            
            if (term.length > 3) {
                if (productName.includes(term.substring(0, Math.max(3, term.length - 1)))) {
                    return true;
                }
            }
            
            return false;
        });
    });
    
    results.sort((a, b) => {
        const nameA = normalizeSearchTerm(a.name);
        const nameB = normalizeSearchTerm(b.name);
        
        const exactMatchA = expandedTerms.some(term => nameA === term);
        const exactMatchB = expandedTerms.some(term => nameB === term);
        
        if (exactMatchA && !exactMatchB) return -1;
        if (!exactMatchA && exactMatchB) return 1;
        
        if (a.stockNumber !== b.stockNumber) {
            return b.stockNumber - a.stockNumber;
        }
        
        if (a.hasPromo !== b.hasPromo) {
            return b.hasPromo - a.hasPromo;
        }
        
        return 0;
    });
    
    return results;
}

// ========== FUNCIONES DE INTERFAZ MEJORADAS ==========
/**
 * Filtra productos (para b√∫squeda desktop)
 */
function filterProducts(searchTerm) {
  if (!products || products.length === 0) return;
  
  isSearching = true;
  ProductRenderer.renderSearchResults(searchTerm);
}

/**
 * Filtra productos (para b√∫squeda m√≥vil)
 */
function filterMobileProducts(searchTerm) {
  if (!products || products.length === 0) return;
  
  ProductRenderer.renderMobileSearchResults(searchTerm);
}

/**
 * Renderiza productos seg√∫n categor√≠a actual
 */
function renderProductsByCategory() {
  ProductRenderer.renderMainProductsGrid('category');
}

/**
 * Renderiza HTML de productos (funci√≥n original mejorada)
 */
function renderProductsToHTML(productsArray) {
    return productsArray.map(product => {
        const isOutOfStock = product.stockNumber === 0;
        
        const stockText = obtenerTextoStock(product);
        
        let stockClass = '';
        if (product.stockNumber === 0) {
            stockClass = 'out-of-stock';
        } else if (product.stockNumber > 0 && product.stockNumber <= 3) {
            stockClass = 'low-stock';
        } else {
            stockClass = 'in-stock';
        }
        
        const addButton = isOutOfStock 
            ? `<button class="add-to-cart" disabled>‚ùå Sin Stock</button>`
            : `<button class="add-to-cart" data-id="${product.id}">üõí Agregar al Carrito</button>`;
        
        // üî• EN GRILLA NORMAL: SIN badges, SIN precios tachados, SIN descuentos
        
        return `
            <div class="product-card">
                <div class="product-image">
                    <img src="${product.image}" 
                         alt="${product.name}"
                         onerror="handleImageError(this, '${product.name.replace(/'/g, "\\'")}')">
                </div>
                <div class="product-info">
                    <div class="product-name">${product.name}</div>
                    
                    <div class="product-price-container">
                        <span class="product-price">$${product.price}</span>
                    </div>
                    
                    <div class="product-stock ${stockClass}">
                        ${stockText}
                    </div>
                    
                    ${addButton}
                    ${esAdmin ? mostrarInfoAdmin(product) : ''}
                </div>
            </div>
        `;
    }).join("");
}

/**
 * Limpia b√∫squeda y vuelve a vista normal
 */
function clearSearch() {
  const searchInput = document.getElementById('productSearch');
  const mobileSearch = document.getElementById('mobileSearch');
  
  if (searchInput) searchInput.value = '';
  if (mobileSearch) mobileSearch.value = '';
  
  isSearching = false;
  
  const clearButtons = document.querySelectorAll('.clear-search');
  clearButtons.forEach(btn => btn.style.display = 'none');
  
  currentCategory = "ALMACEN";
  
  document.querySelectorAll('.category-btn').forEach(btn => {
    btn.classList.toggle(
      'active',
      btn.getAttribute('data-category') === "ALMACEN"
    );
  });
  
  ProductRenderer.renderMainProductsGrid('category');
}

/**
 * Ver todas las ofertas
 */
function verTodasLasOfertas() {
  const categoriasConOfertas = [...new Set(products
    .filter(p => p.hasPromo && p.stockNumber > 0)
    .map(p => p.category)
  )];
  
  if (categoriasConOfertas.length > 0) {
    currentCategory = categoriasConOfertas[0];
    
    document.querySelectorAll(".category-btn").forEach(b => b.classList.remove("active"));
    const ofertasBtn = document.querySelector(`[data-category="${categoriasConOfertas[0]}"]`);
    if (ofertasBtn) {
      ofertasBtn.classList.add("active");
    }
    
    ProductRenderer.renderMainProductsGrid('category');
    
    document.querySelector('.products-grid')?.scrollIntoView({ behavior: 'smooth' });
  } else {
    alert("No hay ofertas disponibles en este momento");
  }
}

// ========== CARGAR PRODUCTOS ==========
async function loadProductsFromAPI() {
    try {
        console.log('üöÄ INICIANDO CARGA DESDE TU SCRIPT...');
        if (productsGrid) {
            productsGrid.innerHTML = '<div class="loading">üîÑ Contactando tu base de datos...</div>';
        }
        
        const TU_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxhKFk2WAi-KRY5xGBsI6_6Pvp3jDjt8mSRXvy7I1WehNmBpJamqK9G9Q1ZJSCSgAdfDA/exec';
        
        console.log('üì° Conectando a tu Apps Script...');
        
        const urlConCache = TU_APPS_SCRIPT_URL + '?cache=' + Date.now();
        
        const respuesta = await fetch(urlConCache, {
            method: 'GET',
            headers: {
                'Accept': 'application/json'
            }
        });
        
        console.log('üìä Estado de respuesta:', respuesta.status, respuesta.statusText);
        
        if (!respuesta.ok) {
            throw new Error(`Tu Script devolvi√≥ error ${respuesta.status}`);
        }
        
        const datos = await respuesta.json();
        console.log('‚úÖ JSON recibido de tu Apps Script');
        
        if (datos.productos && Array.isArray(datos.productos)) {
            console.log('üéØ ¬°PERFECTO! Formato correcto:', datos.productos.length, 'productos');
            processAPIData(datos);
        } 
        else if (Array.isArray(datos)) {
            console.log('üì¶ Formato array directo:', datos.length, 'elementos');
            processAPIData({ productos: datos });
        }
        else if (datos.values && Array.isArray(datos.values)) {
            console.log('üîß Formato Google Sheets API:', datos.values.length, 'filas');
            const productosConvertidos = datos.values.slice(1).map((fila, index) => ({
                id: index + 1,
                name: fila[0] || '',
                price: parseInt(fila[1]) || 0,
                category: fila[2] || 'ALMACEN',
                stock: parseInt(fila[3]) || 0,
                oferta1: fila[4] || '',
                oferta2: fila[5] || '',
                descripcion: fila[6] || `producto_${index + 1}`
            }));
            processAPIData({ productos: productosConvertidos });
        }
        else {
            console.warn('‚ö†Ô∏è Formato no reconocido:', Object.keys(datos));
            mostrarErrorFormato(datos);
        }
        
    } catch (error) {
        console.error('üí• ERROR en carga:', error);
        mostrarErrorAmigable(error);
    }
}

function processAPIData(apiData) {
    console.log('üì¶ Datos recibidos:', apiData);
    
    const productosArray = apiData.productos || apiData;
    console.log('üîÑ Procesando', productosArray.length, 'productos desde API');
    
    products = [];
    window.products = products;
    
    productosArray.forEach((item, index) => {
        try {
            const nombre = item.name || 'Producto sin nombre';
            const precio = parseInt(item.price) || 0;
            const descripcion = item.descripcion || item.name.replace(/\s+/g, '_').toLowerCase() || `producto_${index}`;
            
            let categoriaRaw = item.category;
            let categoria = 'ALMACEN';
            if (categoriaRaw) {
                categoria = String(categoriaRaw).trim().toUpperCase();
            }
            
            const stockValue = item.stock || 0;
            const ofertas1 = item.oferta1 || '';
            const ofertas2 = item.oferta2 || '';
            
            let stockNumber = parseInt(stockValue);
            if (isNaN(stockNumber) || stockNumber < 0) stockNumber = 0;
            let stockStatus = "STOCK";
            if (stockNumber === 0) {
                stockStatus = "SIN STOCK";
            } else if (stockNumber > 0 && stockNumber <= 3) {
                stockStatus = "STOCK BAJO";
            }
            
            const tieneOferta1 = ofertas1 !== '' && ofertas1 !== '0';
            const tieneOferta2 = ofertas2 !== '' && ofertas2 !== '0' && !isNaN(parseInt(ofertas2));
            const tieneOferta = tieneOferta1 || tieneOferta2;
            
            let precioConDescuento = precio;
            let descuentoReal = 0;
            let textoCortoOferta = '';
            
            if (tieneOferta2) {
                const porcentaje = parseInt(ofertas2);
                if (porcentaje > 0 && porcentaje <= 100) {
                    precioConDescuento = calcularPrecioConDescuento(precio, '', ofertas2, 1);
                    descuentoReal = calcularDescuentoReal(precio, precioConDescuento);
                    textoCortoOferta = obtenerTextoCortoOferta('', ofertas2);
                }
            } 
            else if (tieneOferta1) {
                if (OFERTAS_SISTEMA[ofertas1]) {
                    const oferta = OFERTAS_SISTEMA[ofertas1];
                    precioConDescuento = calcularPrecioConDescuento(precio, ofertas1, '', 1);
                    descuentoReal = oferta.descuentoReal;
                    textoCortoOferta = obtenerTextoCortoOferta(ofertas1, '');
                }
            }
            
            precioConDescuento = redondearPrecioAlmacenCopihue(precioConDescuento);
            
            const tipoVenta = obtenerTipoDeVenta(nombre);
            const textoStock = obtenerTextoStock({
                name: nombre,
                stockNumber: stockNumber
            });
            
            const product = {
                id: item.id || index + 1,
                name: nombre,
                price: precio,
                category: categoria,
                stock: stockStatus,
                stockNumber: stockNumber,
                image: `imagenes-productos/${simplificarNombre(nombre)}.jpg`,
                descripcion: descripcion,
                hasPromo: tieneOferta,
                ofertas1: ofertas1,
                ofertas2: ofertas2,
                discountedPrice: precioConDescuento,
                discountPercent: descuentoReal,
                offerText: textoCortoOferta,
                tipoVenta: tipoVenta,
                textoStock: textoStock,
                precioUnitarioReal: precioConDescuento,
                ahorroPorUnidad: precio - precioConDescuento
            };
            
            products.push(product);
            
        } catch (error) {
            console.warn(`‚ö†Ô∏è Error procesando producto ${index}:`, error.message, item);
        }
    });
    
    console.log('‚úÖ', products.length, 'productos listos para mostrar');
    
    const productosConOferta = products.filter(p => p.hasPromo).length;
    const productosConStock = products.filter(p => p.stockNumber > 0).length;
    
    if (productsGrid) {
        productsGrid.innerHTML = `
            <div style="background: linear-gradient(135deg, #4CAF50, #2e7d32); 
                        color: white; padding: 12px; border-radius: 10px; 
                        margin-bottom: 1rem; text-align: center;">
                ‚úÖ <strong>${products.length} productos cargados desde tu base de datos</strong>
                <div style="display: flex; justify-content: center; gap: 20px; margin-top: 8px; font-size: 0.9rem;">
                    <span>üì¶ ${productosConStock} con stock</span>
                    <span>üî• ${productosConOferta} con ofertas</span>
                    <span>üè™ ${[...new Set(products.map(p => p.category))].length} categor√≠as</span>
                </div>
            </div>
        `;
    }
    
    // Inicializar sistema mejorado
    initProductSystem();
    
    setTimeout(() => {
        if (typeof FLASH_SALES_SYSTEM !== 'undefined' && 
            FLASH_SALES_SYSTEM.init) {
            FLASH_SALES_SYSTEM.init();
        }
    }, 500);
}

function simplificarNombre(nombre) {
    return nombre
        .toLowerCase()
        .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
        .replace(/[^a-z0-9 ]/g, "")
        .replace(/\s+/g, '-')
        .replace(/-+/g, '-')
        .trim();
}

// ========== INICIALIZACI√ìN MEJORADA ==========
/**
 * Inicializa el sistema de productos despu√©s de cargar desde API
 */
function initProductSystem() {
  console.log('üîÑ Inicializando sistema de productos mejorado...');
  
  // Renderizar categor√≠as (funci√≥n existente)
  if (typeof renderCategories === 'function') {
    renderCategories();
  }
  
  // Renderizar secciones en orden (SIN CRUCE)
  
  // 1. Ofertas Destacadas (solo ofertas2, solo horario)
  ProductRenderer.renderFeaturedOffersSection();
  
  // 2. Ofertas Rel√°mpago (solo ofertas1, horario propio)
  if (typeof FLASH_SALES_SYSTEM !== 'undefined' && FLASH_SALES_SYSTEM.init) {
    FLASH_SALES_SYSTEM.init();
  }
  
  // 3. Productos normales (sin ofertas destacadas ni rel√°mpago)
  ProductRenderer.renderMainProductsGrid('home');
  
  // 4. Detectar errores de planilla
  detectarErroresPlanilla();
  
  console.log('‚úÖ Sistema de productos inicializado');
  console.log('üìä Estad√≠sticas:', ProductFilterSystem.getFilterStats());
}

/**
 * Actualiza todas las vistas (√∫til despu√©s de cambios)
 */
function refreshAllViews() {
  console.log('üîÑ Actualizando todas las vistas...');
  
  // 1. Destacadas (solo horario, solo ofertas2)
  ProductRenderer.renderFeaturedOffersSection();
  
  // 2. Rel√°mpago (horario propio, solo ofertas1)
  if (typeof FLASH_SALES_SYSTEM !== 'undefined' && FLASH_SALES_SYSTEM.updateUI) {
    FLASH_SALES_SYSTEM.updateUI();
  }
  
  // 3. Productos normales (sin cruce)
  ProductRenderer.renderMainProductsGrid('category');
  
  // 4. Si estamos en b√∫squeda, mantener resultados
  if (isSearching) {
    const searchTerm = document.getElementById('productSearch')?.value || 
                       document.getElementById('mobileSearch')?.value || '';
    if (searchTerm.length >= 2) {
      ProductRenderer.renderSearchResults(searchTerm);
    }
  }
}

// ========== INTERFAZ ==========
function detectarAdmin() {
    const urlParams = new URLSearchParams(window.location.search);
    esAdmin = urlParams.has('admin');
    
    if (esAdmin) {
        adminBadge.style.display = 'inline-block';
        adminNotification.style.display = 'block';
    }
}

function setupEventListeners() {
    cartIcon.addEventListener("click", openCart);
    floatingCart.addEventListener("click", openCart);
    floatingSearch.addEventListener("click", openSearchModal);
    floatingHome.addEventListener("click", scrollToTop);
    closeSearch.addEventListener("click", closeSearchModal);
    closeCart.addEventListener("click", closeCartModal);
    sendOrder.addEventListener("click", sendOrderViaWhatsApp);
    viewAllOffers.addEventListener("click", verTodasLasOfertas);
    
    clearSearchBtn.addEventListener("click", clearSearch);
    clearMobileSearchBtn.addEventListener("click", clearMobileSearch);
    
    cartModal.addEventListener("click", function(e) {
        if (e.target === cartModal) {
            closeCartModal();
        }
    });
    
    searchModal.addEventListener("click", function(e) {
        if (e.target === searchModal) {
            closeSearchModal();
        }
    });
}

function scrollToTop() {
    console.log('üè† CASITA INTELIGENTE - Posici√≥n actual:', window.scrollY + 'px');
    
    const categoriesElement = document.getElementById('categories');
    const categoriesPosition = categoriesElement ? categoriesElement.offsetTop : 300;
    const currentScroll = window.scrollY;
    
    const deberiaIrACategorias = currentScroll > categoriesPosition - 200;
    
    if (!deberiaIrACategorias) {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    } else {
        const targetPosition = Math.max(0, categoriesPosition - 80);
        window.scrollTo({ top: targetPosition, behavior: 'smooth' });
    }
    
    currentCategory = "ALMACEN";
    
    document.querySelectorAll('.category-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.getAttribute('data-category') === "ALMACEN") {
            btn.classList.add('active');
        }
    });
    
    if (isSearching) {
        clearSearch();
        isSearching = false;
    }
    
    if (categoriesElement) {
        const originalBoxShadow = categoriesElement.style.boxShadow;
        const originalBorder = categoriesElement.style.border;
        
        categoriesElement.style.transition = 'all 0.5s ease';
        categoriesElement.style.boxShadow = '0 0 0 3px #2196F3, 0 4px 15px rgba(33, 150, 243, 0.3)';
        categoriesElement.style.border = '2px solid #2196F3';
        categoriesElement.style.borderRadius = '12px';
        categoriesElement.style.padding = '10px';
        categoriesElement.style.margin = '5px';
        
        setTimeout(() => {
            categoriesElement.style.boxShadow = originalBoxShadow;
            categoriesElement.style.border = originalBorder;
            categoriesElement.style.borderRadius = '';
            categoriesElement.style.padding = '';
            categoriesElement.style.margin = '';
        }, 1500);
    }
    
    setTimeout(() => {
        ProductRenderer.renderMainProductsGrid('category');
    }, 300);
    
    const mensajeFeedback = deberiaIrACategorias ? 
        "üè† Navegaci√≥n r√°pida a categor√≠as" : 
        "üè† Volviendo al inicio";
    showHomeFeedback(mensajeFeedback);
}

function showHomeFeedback(mensaje = "üè† Volviendo al inicio") {
    try {
        const oldNotifications = document.querySelectorAll('.home-feedback-notification');
        oldNotifications.forEach(el => el.remove());
        
        const notification = document.createElement('div');
        notification.className = 'home-feedback-notification';
        notification.innerHTML = mensaje;
        
        notification.style.cssText = `
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #2196F3, #0D47A1);
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.4);
            z-index: 99999;
            font-weight: 600;
            font-size: 14px;
            animation: slideDown 0.3s ease;
            border: 2px solid white;
            text-align: center;
            min-width: 200px;
            max-width: 80%;
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 1500);
        
    } catch (error) {
        console.warn('‚ö†Ô∏è Error en showHomeFeedback():', error);
    }
}

function setupSearch() {
    productSearch.addEventListener('input', function(e) {
        const searchTerm = e.target.value.toLowerCase().trim();
        toggleClearButton(clearSearchBtn, searchTerm);
        
        if (searchTerm === '') {
            clearSearch();
            return;
        }
        
        if (searchTerm.length >= 2) {
            filterProducts(searchTerm);
        }
    });
    
    productSearch.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            const searchTerm = this.value.trim();
            if (searchTerm.length >= 2) {
                filterProducts(searchTerm);
            }
        }
    });
    
    mobileSearch.addEventListener('input', function(e) {
        const searchTerm = e.target.value.toLowerCase().trim();
        toggleClearButton(clearMobileSearchBtn, searchTerm);
        
        if (searchTerm === '') {
            mobileSearchResults.innerHTML = '';
            return;
        }
        
        if (searchTerm.length >= 2) {
            filterMobileProducts(searchTerm);
        }
    });
}

function toggleClearButton(button, searchTerm) {
    button.style.display = searchTerm.length > 0 ? 'block' : 'none';
}

function openSearchModal() {
    searchModal.style.display = "flex";
    mobileSearch.focus();
    mobileSearchResults.innerHTML = '';
}

function closeSearchModal() {
    searchModal.style.display = "none";
    mobileSearch.value = '';
    mobileSearchResults.innerHTML = '';
    clearMobileSearchBtn.style.display = 'none';
}

function clearMobileSearch() {
    mobileSearch.value = '';
    mobileSearchResults.innerHTML = '';
    clearMobileSearchBtn.style.display = 'none';
}

function renderCategories() {
    const categories = [...new Set(products.map(p => p.category))];

    categoriesContainer.innerHTML = categories.map(category => {
        return `
            <button class="category-btn ${category === currentCategory ? 'active' : ''}" 
                    data-category="${category}">
                ${category}
            </button>
        `;
    }).join("");
    
    if (categories.length > 0) {
        if (categories.includes("ALMACEN")) {
            currentCategory = "ALMACEN";
        } else {
            currentCategory = categories[0];
        }
        
        document.querySelectorAll('.category-btn').forEach(btn => {
            btn.classList.remove('active');
            if (btn.getAttribute('data-category') === currentCategory) {
                btn.classList.add('active');
            }
        });
    }
    
    document.querySelectorAll(".category-btn").forEach(btn => {
        btn.addEventListener("click", function() {
            currentCategory = this.getAttribute("data-category");
            document.querySelectorAll(".category-btn").forEach(b => b.classList.remove("active"));
            this.classList.add("active");
            ProductRenderer.renderMainProductsGrid('category');
        });
    });
}

function addToCart(productId) {
    const product = products.find(p => p.id === productId);
    if (!product) return;
    
    const availableStock = product.stockNumber;
    const existingItem = cart.find(item => item.id === productId);
    const currentQuantityInCart = existingItem ? existingItem.quantity : 0;
    
    if (currentQuantityInCart >= availableStock) {
        showStockError(product.name, availableStock);
        return;
    }
    
    // üî• VERIFICAR SI EST√Å EN OFERTA ACTIVA
    const enRelampago = (FLASH_SALES_SYSTEM?.isActive && 
                        FLASH_SALES_SYSTEM?.todaySelection?.some(p => p.id === productId)) || false;
    const enDestacadas = (isValidFeaturedOffersTime() && 
                         window.productosDestacadosIds?.includes(productId)) || false;
    const tieneOfertaActiva = enRelampago || enDestacadas;
    
    // üî• SOLO aplicar l√≠mites si tiene oferta activa
    if (tieneOfertaActiva && product.ofertas2) {
        const limiteOferta2 = obtenerLimiteOfertas2(product.ofertas2);
        if (limiteOferta2 !== null) {
            const newQuantity = currentQuantityInCart + 1;
            if (newQuantity > limiteOferta2) {
                showLimitError(product.name, limiteOferta2, `${product.ofertas2}% OFF`);
                return;
            }
        }
    }
    
    const newQuantity = currentQuantityInCart + 1;
    
    if (existingItem) {
        existingItem.quantity = newQuantity;
        
        // üî• SOLO calcular descuento si tiene oferta activa
        if (tieneOfertaActiva) {
            existingItem.price = calcularPrecioConDescuento(
                product.price, 
                product.ofertas1, 
                product.ofertas2, 
                newQuantity
            );
        } else {
            existingItem.price = product.price; // Precio normal
        }
    } else {
        // üî• SOLO calcular descuento si tiene oferta activa
        const initialPrice = tieneOfertaActiva 
            ? calcularPrecioConDescuento(product.price, product.ofertas1, product.ofertas2, 1)
            : product.price;
        
        cart.push({
            id: product.id,
            name: product.name,
            price: initialPrice,
            originalPrice: product.price,
            hasPromo: tieneOfertaActiva,
            ofertas1: tieneOfertaActiva ? product.ofertas1 : '',
            ofertas2: tieneOfertaActiva ? product.ofertas2 : '',
            quantity: 1,
            maxStock: availableStock,
            maxOferta2Limit: tieneOfertaActiva ? obtenerLimiteOfertas2(product.ofertas2) : null
        });
        
        if (tieneOfertaActiva && product.ofertas1 === '1') {
            showAddToCartFeedback(product.name, 0, "3x2");
        } else if (tieneOfertaActiva) {
            const initialDiscount = calcularDescuentoReal(product.price, initialPrice);
            showAddToCartFeedback(product.name, initialDiscount);
        } else {
            showAddToCartFeedback(product.name, 0);
        }
    }
    
    updateCartCount();
    renderCartItems();
}
function showAddToCartFeedback(productName, discount = 0, tipoOferta = '') {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 100px;
        left: 50%;
        transform: translateX(-50%);
        background: var(--primary);
        color: white;
        padding: 12px 20px;
        border-radius: 25px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        z-index: 1002;
        font-weight: 500;
        animation: slideDown 0.3s ease;
    `;
    
    if (tipoOferta === '3x2') {
        notification.innerHTML = `‚úÖ ${productName} agregado (üéØ 3x2 activo)`;
    } else if (discount > 0) {
        notification.innerHTML = `‚úÖ ${productName} agregado (üî• OFERTA)`;
    } else {
        notification.innerHTML = `‚úÖ ${productName} agregado al carrito`;
    }
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 2000);
}

function showStockError(productName, availableStock) {
    const notification = document.createElement('div');
    notification.className = 'stock-notification';
    notification.innerHTML = `‚ùå No hay suficiente stock de ${productName}. M√°ximo: ${availableStock} unidades`;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

function showLimitError(productName, limite, tipoOferta) {
    const notification = document.createElement('div');
    notification.className = 'limit-notification';
    notification.innerHTML = `‚ö†Ô∏è L√≠mite de ${tipoOferta}: M√°ximo ${limite} unidades por familia`;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

function updateCartCount() {
    const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
    cartCount.textContent = totalItems;
    floatingCartCount.textContent = totalItems;
}

function openCart() {
    renderCartItems();
    cartModal.style.display = "flex";
}

function closeCartModal() {
    cartModal.style.display = "none";
}

function renderCartItems() {
    if (cart.length === 0) {
        cartItems.innerHTML = "<p style='text-align: center; padding: 2rem; color: #666;'>Tu carrito est√° vac√≠o</p>";
        cartTotal.textContent = "Total: $0";
        
        const existingSavings = document.querySelector('.total-savings');
        if (existingSavings) existingSavings.remove();
        
        const existingOriginal = document.querySelector('.original-total');
        if (existingOriginal) existingOriginal.remove();
        
        return;
    }
    
    let totalNormalPrice = 0;
    let totalWithPromos = 0;
    let totalSavings = 0;
    let cartItemsHTML = '';
    let tiene3x2 = false;
    
    const existingSavings = document.querySelector('.total-savings');
    if (existingSavings) existingSavings.remove();
    
    const existingOriginal = document.querySelector('.original-total');
    if (existingOriginal) existingOriginal.remove();
    
    cart.forEach(item => {
        const product = products.find(p => p.id === item.id);
        if (!product) return;
        
        // üî• VERIFICAR SI LA OFERTA EST√Å ACTIVA
        const enRelampago = (FLASH_SALES_SYSTEM?.isActive && 
                            FLASH_SALES_SYSTEM?.todaySelection?.some(p => p.id === item.id)) || false;
        const enDestacadas = (isValidFeaturedOffersTime() && 
                             window.productosDestacadosIds?.includes(item.id)) || false;
        const tieneOfertaActiva = enRelampago || enDestacadas;
        
        const itemNormalPrice = product.price * item.quantity;
        const itemFinalPrice = item.price * item.quantity;
        const itemSavings = itemNormalPrice - itemFinalPrice;
        
        totalNormalPrice += itemNormalPrice;
        totalWithPromos += itemFinalPrice;
        totalSavings += itemSavings;
        
        const discountPercent = calcularDescuentoReal(product.price, item.price);
        
        let tipoOferta = '';
        let detalleOferta = '';
        
        // üî• SOLO mostrar badges si la oferta est√° activa
        if (tieneOfertaActiva) {
            if (product.ofertas2 && product.ofertas2 !== '0') {
                tipoOferta = ` <small style="color: #4CAF50; font-weight: bold;">(${product.ofertas2}% OFF)</small>`;
            } else if (product.ofertas1 && product.ofertas1 !== '0') {
                if (OFERTAS_SISTEMA[product.ofertas1]) {
                    const oferta = OFERTAS_SISTEMA[product.ofertas1];
                    tipoOferta = ` <small style="color: #ff6f00; font-weight: bold;">(${oferta.nombre})</small>`;
                    
                    if (product.ofertas1 === '1' && item.quantity >= 3) {
                        tiene3x2 = true;
                        const grupos3x2 = Math.floor(item.quantity / 3);
                        const sobrantes = item.quantity % 3;
                        
                        detalleOferta = `<div style="font-size: 0.75rem; color: #666; margin-top: 2px;">
                            üì¶ Incluye: ${grupos3x2} promo(s) 3x2`;
                        if (sobrantes > 0) {
                            detalleOferta += ` + ${sobrantes} unidad(es) normal(es)`;
                        }
                        detalleOferta += `</div>`;
                    }
                }
            }
        }
        
        cartItemsHTML += `
            <div class="cart-item">
                <div class="cart-item-info">
                    <div class="cart-item-name">${item.name}${tipoOferta}</div>
                    ${detalleOferta}
                    <div class="cart-item-price">
                        ${tieneOfertaActiva && item.price < product.price 
                            ? `<span style="text-decoration: line-through; color: #666; margin-right: 5px;">$${product.price}</span>` 
                            : ''}
                        $${Math.round(item.price)} c/u
                        ${tieneOfertaActiva && discountPercent > 0 
                            ? `<span style="background: #4CAF50; color: white; padding: 2px 6px; border-radius: 8px; font-size: 0.75rem; margin-left: 5px; font-weight: bold;">üî• OFERTA</span>` 
                            : ''}
                    </div>
                </div>
                <div class="cart-item-quantity">
                    <button class="quantity-btn decrease-btn" data-id="${item.id}">-</button>
                    <span class="quantity-value">${item.quantity}</span>
                    <button class="quantity-btn increase-btn" data-id="${item.id}">+</button>
                </div>
            </div>
        `;
    });
    
    cartItems.innerHTML = cartItemsHTML;
    cartTotal.textContent = `TOTAL A PAGAR: $${totalWithPromos.toFixed(0)}`;
    
    if (totalSavings > 0) {
        const originalTotalElement = document.createElement('div');
        originalTotalElement.className = 'original-total';
        originalTotalElement.style.cssText = `
            text-align: right;
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            text-decoration: line-through;
        `;
        originalTotalElement.textContent = `(~~$${totalNormalPrice.toFixed(0)}~~ sin oferta)`;
        cartTotal.parentNode.insertBefore(originalTotalElement, cartTotal);
        
        const savingsElement = document.createElement('div');
        savingsElement.className = 'total-savings';
        
        let mensajeAhorro = `üéâ ¬°Ahorraste $${totalSavings.toFixed(0)}!`;
        
        if (tiene3x2) {
            mensajeAhorro += ` (con promo 3x2)`;
        }
        
        savingsElement.textContent = mensajeAhorro;
        cartTotal.parentNode.insertBefore(savingsElement, cartTotal);
    }
    
    document.querySelectorAll('.increase-btn').forEach(btn => {
        btn.replaceWith(btn.cloneNode(true));
    });
    
    document.querySelectorAll('.decrease-btn').forEach(btn => {
        btn.replaceWith(btn.cloneNode(true));
    });
    
    document.querySelectorAll('.increase-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const productId = parseInt(this.getAttribute('data-id'));
            updateCartQuantity(productId, 1);
        });
    });
    
    document.querySelectorAll('.decrease-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const productId = parseInt(this.getAttribute('data-id'));
            updateCartQuantity(productId, -1);
        });
    });
}

function updateCartQuantity(productId, change) {
    const itemIndex = cart.findIndex(item => item.id === productId);
    if (itemIndex === -1) return;
    
    const item = cart[itemIndex];
    const product = products.find(p => p.id === productId);
    if (!product) return;
    
    const newQuantity = item.quantity + change;
    
    if (newQuantity < 1) {
        cart.splice(itemIndex, 1);
        updateCartCount();
        renderCartItems();
        return;
    }
    
    if (newQuantity > product.stockNumber) {
        showStockError(product.name, product.stockNumber);
        return;
    }
    
    // üî• VERIFICAR SI EST√Å EN OFERTA ACTIVA
    const enRelampago = (FLASH_SALES_SYSTEM?.isActive && 
                        FLASH_SALES_SYSTEM?.todaySelection?.some(p => p.id === productId)) || false;
    const enDestacadas = (isValidFeaturedOffersTime() && 
                         window.productosDestacadosIds?.includes(productId)) || false;
    const tieneOfertaActiva = enRelampago || enDestacadas;
    
    if (tieneOfertaActiva && product.ofertas2) {
        const limiteOferta2 = obtenerLimiteOfertas2(product.ofertas2);
        if (limiteOferta2 !== null && newQuantity > limiteOferta2) {
            showLimitError(product.name, limiteOferta2, `${product.ofertas2}% OFF`);
            return;
        }
    }
    
    item.quantity = newQuantity;
    
    // üî• SOLO calcular descuento si tiene oferta activa
    if (tieneOfertaActiva) {
        item.price = calcularPrecioConDescuento(
            product.price, 
            product.ofertas1, 
            product.ofertas2, 
            newQuantity
        );
    } else {
        item.price = product.price; // Precio normal
    }
    
    updateCartCount();
    renderCartItems();
    
    if (tieneOfertaActiva && item.price < product.price) {
        const descuento = Math.round(((product.price - item.price) / product.price) * 100);
        
        if (product.ofertas1 === '1' && newQuantity >= 3) {
            showAddToCartFeedback(product.name, 0, "3x2");
        } else {
            showAddToCartFeedback(product.name, descuento);
        }
    }
}

function handleImageError(img, productName) {
    console.warn('Error cargando imagen:', img.src);
    
    const colors = ['#e8f5e9', '#f1f8e9', '#f9fbe7', '#fffde7', '#fff3e0'];
    const randomColor = colors[Math.floor(Math.random() * colors.length)];
    
    img.src = '';
    img.onerror = null;
    
    const container = img.parentElement;
    
    container.style.background = `linear-gradient(135deg, ${randomColor}, ${adjustColor(randomColor, -20)})`;
    container.style.display = 'flex';
    container.style.justifyContent = 'center';
    container.style.alignItems = 'center';
    container.style.position = 'relative';
    
    const icon = document.createElement('div');
    icon.innerHTML = 'üõí';
    icon.style.fontSize = '3rem';
    icon.style.opacity = '0.5';
    
    const text = document.createElement('div');
    text.textContent = productName.length > 20 ? productName.substring(0, 20) + '...' : productName;
    text.style.position = 'absolute';
    text.style.bottom = '10px';
    text.style.left = '0';
    text.style.right = '0';
    text.style.textAlign = 'center';
    text.style.fontSize = '0.7rem';
    text.style.color = '#666';
    text.style.padding = '0 10px';
    
    container.innerHTML = '';
    container.appendChild(icon);
    container.appendChild(text);
}

function adjustColor(color, amount) {
    const hex = color.replace('#', '');
    const num = parseInt(hex, 16);
    let r = (num >> 16) + amount;
    let g = ((num >> 8) & 0x00FF) + amount;
    let b = (num & 0x0000FF) + amount;
    
    r = Math.min(Math.max(0, r), 255);
    g = Math.min(Math.max(0, g), 255);
    b = Math.min(Math.max(0, b), 255);
    
    return `#${((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1)}`;
}

function verificarStockBajo() {
    if (!esAdmin) return;
    
    const lowStockProducts = products.filter(p => 
        p.stockNumber > 0 && p.stockNumber <= 3
    );
    
    if (lowStockProducts.length > 0 && !lowStockAlertSent) {
        lowStockAlertSent = true;
        
        const lowStockNotification = document.createElement('div');
        lowStockNotification.className = 'stock-notification';
        lowStockNotification.innerHTML = `
            ‚ö†Ô∏è <strong>ALERTA ADMIN:</strong> ${lowStockProducts.length} producto(s) con stock bajo
            <br>
            <small>${lowStockProducts.map(p => `${p.name} (${p.stockNumber})`).join(', ')}</small>
        `;
        
        document.body.appendChild(lowStockNotification);
        
        setTimeout(() => {
            lowStockNotification.remove();
            lowStockAlertSent = false;
        }, 10000);
    }
}

// ========== INICIALIZACI√ìN ==========
function init() {
    console.log('üöÄ Inicializando Almac√©n Copihue v' + APP_VERSION);
    console.log('üìä Sistema de SEPARACI√ìN ESTRICTA activo');
    
    if (window.appInitialized) {
        console.log('‚ö†Ô∏è App ya inicializada, saltando...');
        return;
    }
    window.appInitialized = true;
    
    detectarAdmin();
    setupEventListeners();
    setupSearch();
    updateCartCount();
    initPWA();
    
    loadProductsFromAPI();
    
    setTimeout(() => {
        console.log('‚úÖ Sistema mejorado listo. Bot√≥n üè† funcionando.');
    }, 1000);
}

function initPWA() {
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./sw.js?v=' + APP_VERSION)
            .then(registration => {
                console.log('‚úÖ Service Worker registrado:', registration.scope);
                
                setInterval(() => {
                    registration.update();
                }, 60 * 60 * 1000);
                
                registration.addEventListener('updatefound', () => {
                    const newWorker = registration.installing;
                    console.log('üîÑ Nueva versi√≥n del Service Worker encontrada');
                    
                    newWorker.addEventListener('statechange', () => {
                        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                            if (confirm('¬°Nueva versi√≥n disponible! ¬øRecargar para actualizar?')) {
                                window.location.reload();
                            }
                        }
                    });
                });
            })
            .catch(error => {
                console.error('‚ùå Error registrando Service Worker:', error);
            });
    }
    
    window.showSuccessMessage = function(message) {
        const notification = document.createElement('div');
        notification.className = 'success-notification';
        notification.textContent = message;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 3000);
    };
}

// ========== FUNCIONES DE ERROR ==========
function mostrarErrorFormato(datos) {
    console.log('üîç Mostrando ayuda por formato incorrecto...');
    
    const tipo = typeof datos;
    const esArray = Array.isArray(datos);
    const claves = esArray ? 'ES ARRAY' : Object.keys(datos).join(', ');
    
    if (productsGrid) {
        productsGrid.innerHTML = `
            <div style="background: #fff3e0; border-radius: 10px; padding: 20px; margin: 20px;">
                <h3 style="color: #e65100;">üîß Formato de datos no reconocido</h3>
                <p>Tu Apps Script devolvi√≥ datos en un formato diferente.</p>
                
                <div style="background: white; padding: 15px; border-radius: 8px; margin: 15px 0;">
                    <h4>üìä Informaci√≥n t√©cnica:</h4>
                    <p><strong>Tipo:</strong> ${tipo}</p>
                    <p><strong>¬øEs array?:</strong> ${esArray ? 'S√ç' : 'NO'}</p>
                    <p><strong>Propiedades:</strong> ${claves}</p>
                    <p><strong>Muestra:</strong></p>
                    <pre style="background: #f5f5f5; padding: 10px; border-radius: 5px; overflow: auto; max-height: 200px;">
${JSON.stringify(datos, null, 2).substring(0, 300)}...
                    </pre>
                </div>
                
                <p>Tu Script debe devolver EXACTAMENTE esto:</p>
                <pre style="background: #e8f5e9; padding: 10px; border-radius: 5px;">
{
  "productos": [
    { "name": "Producto", "price": 100, "category": "ALMACEN", "stock": 10, "oferta1": "", "oferta2": "", "descripcion": "sku_unico" }
  ]
}
                </pre>
                
                <button onclick="verCodigoCorrector()" 
                        style="background: #4CAF50; color: white; padding: 10px 20px; 
                               border: none; border-radius: 5px; margin-top: 15px; cursor: pointer;">
                    üìã Ver c√≥digo CORRECTO para Apps Script
                </button>
            </div>
        `;
    }
}

function mostrarErrorAmigable(error) {
    console.log('üîç Mostrando error amigable...');
    
    if (productsGrid) {
        productsGrid.innerHTML = `
            <div style="text-align: center; padding: 40px 20px;">
                <div style="font-size: 60px; margin-bottom: 20px;">üòï</div>
                <h2 style="color: #d32f2f;">No se pudo conectar</h2>
                <p style="color: #666; margin: 20px 0;">${error.message}</p>
                
                <div style="display: inline-block; background: #f5f5f5; 
                          border-radius: 10px; padding: 20px; margin: 20px 0;">
                    <h4 style="color: #2e7d32;">Soluci√≥n r√°pida:</h4>
                    <p>1. Verifica que tu Apps Script est√© publicado</p>
                    <p>2. Copia la URL correcta</p>
                    <p>3. Usa el c√≥digo correcto (ver abajo)</p>
                </div>
                
                <div>
                    <button onclick="verInstruccionesCompletas()" 
                            style="background: #4CAF50; color: white; padding: 12px 24px; 
                                   border: none; border-radius: 8px; margin: 5px; cursor: pointer;">
                        üìñ Ver instrucciones
                    </button>
                    
                    <button onclick="cargarModoDemo()" 
                            style="background: #2196F3; color: white; padding: 12px 24px; 
                                   border: none; border-radius: 8px; margin: 5px; cursor: pointer;">
                        üöÄ Usar modo DEMO
                    </button>
                    
                    <button onclick="location.reload()" 
                            style="background: #FF9800; color: white; padding: 12px 24px; 
                                   border: none; border-radius: 8px; margin: 5px; cursor: pointer;">
                        üîÑ Recargar
                    </button>
                </div>
            </div>
        `;
    }
}

function verCodigoCorrector() {
    const codigo = `function doGet() {
  // 1. Obtener hoja activa
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  
  // 2. Leer todos los datos
  const datos = sheet.getDataRange().getValues();
  
  // 3. Crear array de productos
  const productos = [];
  
  // 4. Recorrer filas (saltar encabezados, fila 0)
  for (let i = 1; i < datos.length; i++) {
    const fila = datos[i];
    
    // 5. Crear objeto producto - AJUSTA ESTOS √çNDICES
    const producto = {
      name: fila[0] || '',           // Columna A: Nombre
      price: fila[1] || 0,           // Columna B: Precio  
      category: fila[2] || 'ALMACEN', // Columna C: Categor√≠a
      stock: fila[3] || 0,           // Columna D: Stock
      oferta1: fila[4] || '',        // Columna E: Oferta1
      oferta2: fila[5] || '',        // Columna F: Oferta2
      descripcion: fila[6] || \`producto_\${i}\`  // Columna G: Descripci√≥n √∫nica
    };
    
    productos.push(producto);
  }
  
  // 6. Devolver como JSON
  return ContentService
    .createTextOutput(JSON.stringify({ productos }))
    .setMimeType(ContentService.MimeType.JSON);
}`;

    alert(`üìã COPIA Y PEGA ESTO EN TU APPS SCRIPT:\n\n${codigo}\n\n‚úÖ Luego: 1) Guarda  2) Deploy  3) Copia nueva URL`);
}

function verInstruccionesCompletas() {
    alert(`üìã INSTRUCCIONES COMPLETAS:

1. ABRIR TU GOOGLE SHEET
‚Ä¢ Ve a tu Sheet con los 422 productos

2. AGREGAR COLUMNA "descripcion"
‚Ä¢ Inserta una nueva columna G
‚Ä¢ Ponle t√≠tulo "descripcion"
‚Ä¢ Llena con valores √∫nicos (SKU, c√≥digo, o nombre sin espacios)

3. IR A APPS SCRIPT
‚Ä¢ Extensions ‚Üí Apps Script

4. PEGAR C√ìDIGO NUEVO
‚Ä¢ Borra todo el c√≥digo viejo
‚Ä¢ Pega el c√≥digo que te mostr√©

5. GUARDAR Y PUBLICAR
‚Ä¢ Guarda (Ctrl+S)
‚Ä¢ Ve a Deploy ‚Üí New deployment
‚Ä¢ Tipo: Web app
‚Ä¢ Acceso: Anyone
‚Ä¢ Haz clic en Deploy

6. COPIAR NUEVA URL
‚Ä¢ Copia la URL que te da
‚Ä¢ Reempl√°zala en TU_APPS_SCRIPT_URL (en el c√≥digo)

¬°Listo! Tu tienda funcionar√°.`);
}

function cargarModoDemo() {
    console.log('üîÑ Cargando modo demo...');
    loadDemoProducts();
}

function loadDemoProducts() {
    console.log('üîÑ Cargando datos de demostraci√≥n...');
    
    products = [
        { 
            id: 1, 
            name: "TOMATE REDONDO KG", 
            price: 5000,
            category: "FRUTAS Y VERDURAS", 
            stock: "STOCK", 
            stockNumber: 10,
            descripcion: "tomate_rojo_kg",
            image: "",
            hasPromo: true,
            ofertas1: "1",
            ofertas2: "",
            discountedPrice: calcularPrecioConDescuento(5000, "1", "", 1),
            discountPercent: 0,
            offerText: obtenerTextoCortoOferta("1", ""),
            tipoVenta: obtenerTipoDeVenta("TOMATE REDONDO KG")
        },
        { 
            id: 2, 
            name: "DURAZNOS x UNIDAD", 
            price: 350,
            category: "FRUTAS Y VERDURAS", 
            stock: "STOCK", 
            stockNumber: 50,
            descripcion: "durazno_unidad",
            image: "",
            hasPromo: true,
            ofertas1: "2",
            ofertas2: "",
            discountedPrice: calcularPrecioConDescuento(350, "2", "", 1),
            discountPercent: 0,
            offerText: obtenerTextoCortoOferta("2", ""),
            tipoVenta: obtenerTipoDeVenta("DURAZNOS x UNIDAD")
        },
        { 
            id: 3, 
            name: "ALFAJOR TRIPLE FANTOCHE BLANCO", 
            price: 2000,
            category: "ALMACEN", 
            stock: "STOCK", 
            stockNumber: 6,
            descripcion: "alfajor_fantoche_blanco",
            image: "",
            hasPromo: true,
            ofertas1: "",
            ofertas2: "10",
            discountedPrice: calcularPrecioConDescuento(2000, "", "10", 1),
            discountPercent: 10,
            offerText: obtenerTextoCortoOferta("", "10"),
            tipoVenta: obtenerTipoDeVenta("ALFAJOR TRIPLE FANTOCHE BLANCO")
        }
    ];
    
    productsGrid.innerHTML = `
        <div class="demo-banner">
            <strong>üîß MODO DEMO ACTIVADO</strong><br>
            <small>Usando datos de ejemplo. Tus 400+ productos est√°n en Google Sheets listos.</small>
            <br>
            <button onclick="loadProductsFromAPI()" style="margin-top: 10px; padding: 8px 16px; background: white; color: #ff9800; border: none; border-radius: 5px; font-weight: bold; cursor: pointer;">
                üîÑ Intentar cargar desde API
            </button>
        </div>
        ${productsGrid.innerHTML}
    `;
    
    renderCategories();
    ProductRenderer.renderFeaturedOffersSection();
    ProductRenderer.renderMainProductsGrid('category');
    
    setTimeout(() => {
        if (typeof FLASH_SALES_SYSTEM !== 'undefined' && 
            FLASH_SALES_SYSTEM.init) {
            FLASH_SALES_SYSTEM.init();
        }
    }, 500);
}

// ========== INICIALIZACI√ìN FINAL ==========
document.addEventListener("DOMContentLoaded", function() {
    console.log('üì± DOM completamente cargado - Iniciando app mejorada...');
    
    init();
    
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.getRegistration().then(existingRegistration => {
                if (!existingRegistration) {
                    navigator.serviceWorker.register('sw.js?v=' + APP_VERSION)
                        .then(registration => {
                            console.log('‚úÖ Service Worker registrado (backup):', registration.scope);
                        })
                        .catch(error => {
                            console.error('‚ùå Error en registro backup:', error);
                        });
                } else {
                    console.log('‚úÖ Service Worker ya registrado:', existingRegistration.scope);
                }
            });
        });
    }
    
    setTimeout(() => {
        if (isPWAInstalled()) {
            console.log('üì± PWA ya instalada - Modo standalone activo');
            const installBtn = document.getElementById('installPrompt');
            if (installBtn) installBtn.style.display = 'none';
            
            const header = document.querySelector('header .logo');
            if (header) {
                const existingBadge = header.querySelector('.pwa-badge');
                if (!existingBadge) {
                    header.innerHTML += '<span style="margin-left: 8px; font-size: 0.7rem; background: #4CAF50; color: white; padding: 2px 6px; border-radius: 10px;">APP</span>';
                }
            }
        }
    }, 2000);
    
    const versionGuardada = localStorage.getItem('almacen_version');
    
    if (versionGuardada !== APP_VERSION) {
        console.log('üîÑ Detecci√≥n de nueva versi√≥n:', APP_VERSION);
        localStorage.setItem('almacen_version', APP_VERSION);
        
        if (versionGuardada && versionGuardada !== '') {
            console.log('üîÑ Recargando para aplicar cambios...');
            setTimeout(() => {
                window.location.href = window.location.href.split('?')[0] + 
                                      '?v=' + APP_VERSION + 
                                      '&t=' + Date.now() + 
                                      '&cache=bust&force=true';
            }, 1000);
        }
    } else {
        console.log('‚úÖ Versi√≥n actual:', APP_VERSION);
    }
});

function isPWAInstalled() {
    return window.matchMedia('(display-mode: standalone)').matches || 
           window.navigator.standalone === true ||
           document.referrer.includes('android-app://');
}

// ========== FUNCIONES DE DEPURACI√ìN ==========
function debugFlashSales() {
    console.log('=== DEBUG OFERTAS REL√ÅMPAGO ===');
    console.log('Estado:', FLASH_SALES_SYSTEM.isActive ? 'ACTIVO' : 'INACTIVO');
    console.log('Pool:', FLASH_SALES_SYSTEM.productPool.length);
    console.log('Selecci√≥n hoy:', FLASH_SALES_SYSTEM.todaySelection.length);
    console.log('Selecci√≥n ayer:', FLASH_SALES_SYSTEM.yesterdaySelection.length);
    
    console.log('--- POOL ---');
    FLASH_SALES_SYSTEM.productPool.forEach((p, i) => {
        console.log(`${i+1}. ${p.name} - ${p.ofertas1} (ID: ${p.descripcion})`);
    });
    
    console.log('--- SELECCI√ìN HOY ---');
    FLASH_SALES_SYSTEM.todaySelection.forEach((p, i) => {
        console.log(`${i+1}. ${p.name} - ${p.ofertas1} ($${p.flashPrice})`);
    });
    
    const historyData = localStorage.getItem('flash_sales_history');
    if (historyData) {
        const history = JSON.parse(historyData);
        console.log('--- HISTORIAL (√∫ltimos 30 d√≠as) ---');
        Object.keys(history).forEach(date => {
            console.log(`${date}: ${history[date].products.length} productos`);
        });
    }
}

function forceRegenerateFlashSales() {
    console.log('üîÑ Forzando regeneraci√≥n de ofertas rel√°mpago...');
    FLASH_SALES_SYSTEM.todaySelection = [];
    FLASH_SALES_SYSTEM.generateDailySelection();
    FLASH_SALES_SYSTEM.updateUI();
}

function toggleFlashSales(show) {
    const container = document.getElementById('flashSalesContainer');
    if (container) {
        container.style.display = show ? 'block' : 'none';
        FLASH_SALES_SYSTEM.isActive = show;
        FLASH_SALES_SYSTEM.updateUI();
    }
}

// Exportar funciones para debugging
window.ProductFilterSystem = ProductFilterSystem;
window.ProductRenderer = ProductRenderer;
window.refreshAllViews = refreshAllViews;
window.renderProductsToHTML = renderProductsToHTML;
window.renderProductsByCategory = renderProductsByCategory;
window.filterProducts = filterProducts;
window.filterMobileProducts = filterMobileProducts;
window.clearSearch = clearSearch;
window.verTodasLasOfertas = verTodasLasOfertas;

console.log('üéØ Sistema de SEPARACI√ìN ESTRICTA cargado - Sin cruce entre ofertas');
    </script>
</body>
</html>
