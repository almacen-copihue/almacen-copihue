<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Almac√©n Copihue - Tu almac√©n de barrio</title>
    
    <!-- Meta tags PWA -->
    <meta name="theme-color" content="#2e7d32">
    <meta name="description" content="Tu almac√©n de barrio - Productos de calidad con la confianza de siempre">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Almac√©n Copihue">
    
    <!-- Icons -->
    <link rel="icon" href="icon-192x192.png" type="image/png">
    <link rel="apple-touch-icon" href="icon-192x192.png">
    
    <!-- Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <style>
        :root {
            --primary: #2e7d32;
            --primary-dark: #1b5e20;
            --primary-light: #4caf50;
            --secondary: #ff6f00;
            --secondary-dark: #f57c00;
            --accent: #ffeb3b;
            --light: #f8fff8;
            --dark: #1b5e20;
            --gray: #757575;
            --white: #ffffff;
            --card-bg: #ffffff;
            --shadow: 0 4px 15px rgba(46,125,50,0.1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--light);
            color: var(--dark);
            line-height: 1.6;
            background-image: linear-gradient(135deg, #f8fff8 0%, #e8f5e9 100%);
        }
        
        header {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: var(--white);
            padding: 1rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow);
        }
        
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .logo-icon {
            font-size: 1.8rem;
        }

        .admin-badge {
            background: var(--secondary);
            color: white;
            padding: 0.2rem 0.6rem;
            border-radius: 12px;
            font-size: 0.7rem;
            margin-left: 0.5rem;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        .cart-icon {
            position: relative;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: background 0.3s;
        }
        
        .cart-icon:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .cart-count {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--secondary);
            color: white;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }
        
        .hero {
            background: linear-gradient(135deg, rgba(46,125,50,0.9), rgba(76,175,80,0.8));
            background-size: cover;
            color: white;
            padding: 3rem 1rem;
            text-align: center;
            border-radius: 15px;
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
        }
        
        .hero h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .hero p {
            font-size: 1.1rem;
            margin-bottom: 1rem;
            opacity: 0.9;
        }
        
        .info-bar {
            background-color: var(--white);
            padding: 1.2rem;
            border-radius: 12px;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-around;
            text-align: center;
            border-left: 4px solid var(--secondary);
        }
        
        .info-item {
            margin: 0.5rem;
            font-weight: 500;
        }
        
        .search-container {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            padding: 1rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #e8f5e9;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-radius: 12px;
            position: relative;
        }
        
        .search-wrapper {
            position: relative;
            width: 100%;
        }
        
        .search-input {
            width: 100%;
            padding: 14px 50px 14px 20px;
            border: 2px solid var(--primary);
            border-radius: 25px;
            font-size: 1rem;
            background: white;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(46,125,50,0.1);
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--primary-dark);
            box-shadow: 0 0 0 3px rgba(46,125,50,0.2);
        }
        
        .clear-search {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: var(--gray);
            transition: color 0.3s;
            padding: 5px;
            z-index: 2;
            display: none;
        }
        
        .clear-search:hover {
            color: var(--primary);
        }
        
        .search-results {
            text-align: center;
            padding: 12px;
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            border-radius: 10px;
            margin-bottom: 1rem;
            border-left: 4px solid #2196f3;
        }
        
        .categories {
            display: flex;
            overflow-x: auto;
            padding: 1rem 0;
            margin-bottom: 1rem;
            gap: 0.8rem;
        }
        
        .category-btn {
            background-color: var(--white);
            border: 2px solid #e8f5e9;
            padding: 0.7rem 1.2rem;
            border-radius: 25px;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.3s;
            font-weight: 500;
            color: var(--dark);
        }
        
        .category-btn.active {
            background-color: var(--primary);
            color: var(--white);
            border-color: var(--primary);
            transform: translateY(-2px);
        }
        
        .category-btn:hover {
            border-color: var(--primary-light);
            transform: translateY(-2px);
        }
        
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        @media (min-width: 1200px) {
            .products-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        @media (min-width: 768px) and (max-width: 1199px) {
            .products-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 767px) {
            .products-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            /* OCULTAR CARRITO DEL HEADER EN M√ìVIL */
            .cart-icon {
                display: none;
            }
        }

        @media (max-width: 480px) {
            .products-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .product-card {
            background-color: var(--card-bg);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            border: 1px solid #e8f5e9;
        }
        
        .product-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 8px 25px rgba(46,125,50,0.15);
        }
        
        .product-image {
            height: 160px;
            background: linear-gradient(135deg, #e8f5e8, #c8e6c9);
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0.8rem;
            position: relative;
            overflow: hidden;
        }
        
        .product-image img {
            max-width: 100%;
            max-height: 130px;
            object-fit: contain;
            transition: transform 0.3s ease;
        }
        
        .product-card:hover .product-image img {
            transform: scale(1.05);
        }
        
        .product-info {
            padding: 1rem;
        }
        
        .product-name {
            font-weight: 600;
            margin-bottom: 0.4rem;
            font-size: 0.9rem;
            color: var(--dark);
            line-height: 1.3;
        }
        
        .product-price {
            color: var(--secondary);
            font-weight: bold;
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }
        
        .product-stock {
            font-size: 0.75rem;
            margin-bottom: 0.8rem;
            font-weight: 500;
        }
        
        .in-stock {
            color: var(--primary-light);
        }
        
        .out-of-stock {
            color: var(--gray);
        }

        .low-stock {
            color: #ff9800;
            font-weight: bold;
        }
        
        .add-to-cart {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            border: none;
            padding: 0.7rem;
            border-radius: 8px;
            width: 100%;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .add-to-cart:hover {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary));
            transform: translateY(-2px);
        }
        
        .add-to-cart:disabled {
            background: var(--gray);
            cursor: not-allowed;
            transform: none;
        }

        .cart-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .cart-content {
            background-color: var(--white);
            width: 90%;
            max-width: 500px;
            border-radius: 15px;
            padding: 1.5rem;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow);
        }
        
        .cart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            border-bottom: 2px solid #e8f5e9;
            padding-bottom: 0.8rem;
        }
        
        .close-cart {
            background: none;
            border: none;
            font-size: 1.8rem;
            cursor: pointer;
            color: var(--gray);
            transition: color 0.3s;
        }
        
        .close-cart:hover {
            color: var(--primary);
        }
        
        .cart-items {
            margin-bottom: 1rem;
        }
        
        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.8rem 0;
            border-bottom: 1px solid #e8f5e9;
        }
        
        .cart-item-info {
            flex-grow: 1;
        }
        
        .cart-item-name {
            font-weight: bold;
            color: var(--dark);
        }
        
        .cart-item-price {
            color: var(--gray);
            font-size: 0.9rem;
        }
        
        .cart-item-quantity {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .quantity-btn {
            background-color: var(--light);
            border: 1px solid #c8e6c9;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .quantity-btn:hover {
            background-color: var(--primary-light);
            color: white;
        }
        
        .quantity-value {
            margin: 0 0.5rem;
            font-weight: bold;
            min-width: 20px;
            text-align: center;
        }
        
        .cart-total {
            font-weight: bold;
            font-size: 1.3rem;
            text-align: right;
            margin-bottom: 1rem;
            color: var(--primary);
            padding-top: 1rem;
            border-top: 2px solid #e8f5e9;
        }
        
        .total-savings {
            background: #4caf50;
            color: white;
            padding: 0.8rem;
            border-radius: 8px;
            margin: 0.5rem 0;
            text-align: center;
            font-weight: bold;
        }
        
        .send-order {
            background: linear-gradient(135deg, var(--secondary), var(--secondary-dark));
            color: white;
            border: none;
            padding: 1.2rem;
            border-radius: 10px;
            width: 100%;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .send-order:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255,111,0,0.3);
        }
        
        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--gray);
            font-size: 1.1rem;
        }
        
        .error-message {
            text-align: center;
            padding: 2rem;
            color: #d32f2f;
            background: #ffebee;
            border-radius: 10px;
            margin: 1rem 0;
            border-left: 4px solid #d32f2f;
        }
        
        .retry-btn {
            margin-top: 10px;
            padding: 10px 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.3s;
        }
        
        .retry-btn:hover {
            background: var(--primary-dark);
        }
        
        footer {
            background: linear-gradient(135deg, var(--dark), var(--primary));
            color: var(--white);
            padding: 2rem 1rem;
            text-align: center;
            margin-top: 3rem;
        }
        
        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
        }

        .admin-notification {
            background: linear-gradient(135deg, #ff9800, #f57c00);
            color: white;
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            text-align: center;
            animation: slideIn 0.5s ease;
        }

        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .install-prompt {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--primary);
            color: white;
            padding: 12px 16px;
            border-radius: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            cursor: pointer;
            z-index: 1000;
            display: none;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            animation: slideUp 0.3s ease;
        }
        
        @keyframes slideUp {
            from { transform: translateY(100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .install-prompt:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .demo-notification {
            text-align: center;
            padding: 15px;
            background: #e3f2fd;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #2196f3;
        }

        /* FLOTANTE OPTIMIZADO PARA CELULAR */
        .floating-cart {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, var(--secondary), var(--secondary-dark));
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(255,111,0,0.4);
            z-index: 999;
            transition: all 0.3s ease;
            font-size: 1.5rem;
        }
        
        .floating-cart:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(255,111,0,0.6);
        }
        
        .floating-cart .cart-count {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--primary);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.8rem;
            font-weight: bold;
            border: 2px solid white;
        }

        /* BUSCADOR FLOTANTE PARA M√ìVIL */
        .floating-search {
            position: fixed;
            bottom: 90px;
            right: 20px;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: none;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(46,125,50,0.4);
            z-index: 998;
            transition: all 0.3s ease;
            font-size: 1.5rem;
        }
        
        .floating-search:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(46,125,50,0.6);
        }

        /* MODAL DE B√öSQUEDA */
        .search-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1001;
            justify-content: center;
            align-items: flex-start;
            padding-top: 80px;
        }
        
        .search-modal-content {
            background-color: var(--white);
            width: 90%;
            max-width: 500px;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
        }
        
        .search-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            border-bottom: 2px solid #e8f5e9;
            padding-bottom: 0.8rem;
        }
        
        .close-search {
            background: none;
            border: none;
            font-size: 1.8rem;
            cursor: pointer;
            color: var(--gray);
            transition: color 0.3s;
        }
        
        .close-search:hover {
            color: var(--primary);
        }

        /* MOSTRAR BUSCADOR FLOTANTE SOLO EN M√ìVIL */
        @media (max-width: 767px) {
            .search-container {
                display: none;
            }
            
            .floating-search {
                display: flex;
            }
        }

        /* ESTILOS PARA NOTIFICACIONES DE STOCK */
        .stock-notification {
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: #f44336;
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1002;
            font-weight: 500;
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from { transform: translateX(-50%) translateY(-20px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <div class="logo">
                <span class="logo-icon">üå∫</span>
                Almac√©n Copihue
                <span id="adminBadge" class="admin-badge" style="display: none;">ADMIN</span>
            </div>
            <div class="cart-icon" id="cartIcon">
                üõí <span class="cart-count" id="cartCount">0</span>
            </div>
        </div>
    </header>

    <div class="container">
        <div id="adminNotification" class="admin-notification" style="display: none;">
            <strong>üîî MODO ADMIN ACTIVADO</strong> - Recibir√°s alertas de stock bajo
        </div>

        <section class="hero">
            <h1>Tu almac√©n de barrio</h1>
            <p>Productos de calidad con la confianza de siempre</p>
        </section>

        <section class="info-bar">
            <div class="info-item">
                <strong>üìç Retiro en el local:</strong> Copihue 457
            </div>
            <div class="info-item">
                <strong>üìû WhatsApp:</strong> +5492944907380
            </div>
            <div class="info-item">
                <strong>‚è∞ Horario:</strong> 10:30 a 23:00 hrs.
            </div>
        </section>

        <!-- BUSCADOR PARA ESCRITORIO - CORREGIDO -->
        <div class="search-container" id="desktopSearch">
            <div class="search-wrapper">
                <input type="text" id="productSearch" class="search-input" 
                       placeholder="üîç Buscar productos por nombre...">
                <button class="clear-search" id="clearSearchBtn">‚úñÔ∏è</button>
            </div>
        </div>

        <section class="categories" id="categories">
            <!-- Las categor√≠as se cargar√°n din√°micamente con JavaScript -->
        </section>

        <section class="products-grid" id="productsGrid">
            <div class="loading">üîÑ Cargando productos desde Google Sheets...</div>
        </section>
    </div>

    <!-- BUSCADOR FLOTANTE PARA M√ìVIL -->
    <div class="floating-search" id="floatingSearch">
        üîç
    </div>

    <!-- CARRITO FLOTANTE OPTIMIZADO PARA CELULAR -->
    <div class="floating-cart" id="floatingCart">
        üõí
        <span class="cart-count" id="floatingCartCount">0</span>
    </div>

    <!-- MODAL DE B√öSQUEDA PARA M√ìVIL -->
    <div class="search-modal" id="searchModal">
        <div class="search-modal-content">
            <div class="search-modal-header">
                <h2>Buscar Productos</h2>
                <button class="close-search" id="closeSearch">&times;</button>
            </div>
            <div class="search-wrapper">
                <input type="text" id="mobileSearch" class="search-input" 
                       placeholder="üîç Escribe el nombre del producto...">
                <button class="clear-search" id="clearMobileSearchBtn">‚úñÔ∏è</button>
            </div>
            <div class="search-results" id="mobileSearchResults" style="display: none; margin-top: 1rem;">
                <!-- Resultados de b√∫squeda m√≥vil -->
            </div>
        </div>
    </div>

    <!-- MODAL DEL CARRITO -->
    <div class="cart-modal" id="cartModal">
        <div class="cart-content">
            <div class="cart-header">
                <h2>Tu Pedido</h2>
                <button class="close-cart" id="closeCart">&times;</button>
            </div>
            <div class="cart-items" id="cartItems">
                <!-- Los items del carrito se cargar√°n din√°micamente -->
            </div>
            <div class="cart-total" id="cartTotal">Total: $0</div>
            <button class="send-order" id="sendOrder">Enviar Pedido por WhatsApp</button>
        </div>
    </div>

    <!-- Bot√≥n de instalaci√≥n PWA -->
    <div class="install-prompt" id="installPrompt">
        <span>üì± Instalar App</span>
    </div>

    <footer>
        <div class="footer-content">
            <p>Almac√©n Copihue - Tu almac√©n de confianza en el barrio</p>
            <p>üìç Copihue 457 | üìû +5492944907380 | ‚è∞ 10:30 a 23:00 hrs.</p>
        </div>
    </footer>

    <script>
        // ========== SISTEMA DE OFERTAS PROGRESIVAS HASTA 50% ==========
        const PROMO_SYSTEM = {
            '1': { 
                discount: 1/6,    // 16.67% OFF
                name: "Oferta B√°sica",
                minQuantity: 1,
                roundTo: 100
            },
            '2': { 
                discount: 0.25,   // 25% OFF
                name: "Oferta Duo", 
                minQuantity: 2,
                roundTo: 100
            },
            '3': { 
                discount: 1/3,    // 33.33% OFF
                name: "Oferta Triple",
                minQuantity: 3,
                roundTo: 100
            },
            '4': { 
                discount: 0.40,   // 40% OFF
                name: "Oferta Max",
                minQuantity: 4,
                roundTo: 100
            },
            '5': { 
                discount: 0.50,   // 50% OFF
                name: "Oferta Super",
                minQuantity: 5,
                roundTo: 100
            }
        };

        // ========== C√ìDIGO ALMAC√âN COPIHUE ==========
        const SHEET_ID = '1UFXOYC8uj1NK066SYDFiSZiS8scugImwwhw-OzmnQQU';
        
        // Variables globales
        let products = [];
        let cart = [];
        let currentCategory = "TODOS";
        let lowStockAlertSent = false;
        let esAdmin = false;
        let isSearching = false;

        // Elementos del DOM
        const categoriesContainer = document.getElementById("categories");
        const productsGrid = document.getElementById("productsGrid");
        const cartIcon = document.getElementById("cartIcon");
        const floatingCart = document.getElementById("floatingCart");
        const floatingSearch = document.getElementById("floatingSearch");
        const searchModal = document.getElementById("searchModal");
        const closeSearch = document.getElementById("closeSearch");
        const mobileSearch = document.getElementById("mobileSearch");
        const mobileSearchResults = document.getElementById("mobileSearchResults");
        const cartModal = document.getElementById("cartModal");
        const closeCart = document.getElementById("closeCart");
        const cartItems = document.getElementById("cartItems");
        const cartTotal = document.getElementById("cartTotal");
        const cartCount = document.getElementById("cartCount");
        const floatingCartCount = document.getElementById("floatingCartCount");
        const sendOrder = document.getElementById("sendOrder");
        const adminBadge = document.getElementById("adminBadge");
        const adminNotification = document.getElementById("adminNotification");
        const productSearch = document.getElementById("productSearch");
        const clearSearchBtn = document.getElementById("clearSearchBtn");
        const clearMobileSearchBtn = document.getElementById("clearMobileSearchBtn");

        // ‚úÖ FUNCI√ìN CORREGIDA - RESPETAR L√çMITES DE OFERTA POR PRODUCTO
        function calculateDiscountedPrice(originalPrice, promoCode, quantity) {
            const promo = PROMO_SYSTEM[promoCode];
            if (!promo) return originalPrice;
            
            // ‚úÖ BUSCAR MEJOR DESCUENTO QUE APLIQUE, PERO RESPETANDO EL L√çMITE DEL PRODUCTO
            let bestDiscount = 0;
            let bestPromoName = "Precio normal";
            
            // Verificar TODAS las ofertas que aplican por la cantidad, PERO solo hasta la oferta del producto
            Object.keys(PROMO_SYSTEM).forEach(code => {
                // ‚úÖ SOLO CONSIDERAR OFERTAS HASTA EL M√ÅXIMO PERMITIDO POR ESTE PRODUCTO
                if (parseInt(code) > parseInt(promoCode)) {
                    return; // Saltar ofertas superiores a la permitida para este producto
                }
                
                const currentPromo = PROMO_SYSTEM[code];
                if (quantity >= currentPromo.minQuantity) {
                    if (currentPromo.discount > bestDiscount) {
                        bestDiscount = currentPromo.discount;
                        bestPromoName = currentPromo.name;
                    }
                }
            });
            
            // Si no hay descuento que aplique, precio normal
            if (bestDiscount === 0) return originalPrice;
            
            // Calcular precio con el MEJOR descuento que aplica (dentro del l√≠mite)
            const discountAmount = originalPrice * bestDiscount;
            const priceBeforeRound = originalPrice - discountAmount;
            
            // Redondeo a favor del cliente
            let discountedPrice = Math.floor(priceBeforeRound / 100) * 100;
            
            console.log(`üéØ Producto: $${originalPrice}, Oferta m√°xima: ${promoCode}, Cantidad: ${quantity}, Mejor oferta aplicable: ${bestPromoName} (${(bestDiscount*100).toFixed(1)}% OFF), Precio final: $${discountedPrice}`);
            
            return discountedPrice;
        }

        // ‚úÖ FUNCI√ìN PARA CALCULAR PORCENTAJE REAL DE DESCUENTO
        function calculateActualDiscount(originalPrice, discountedPrice) {
            const discountAmount = originalPrice - discountedPrice;
            const discountPercent = (discountAmount / originalPrice) * 100;
            return Math.round(discountPercent * 10) / 10; // Redondear a 1 decimal
        }

        // ‚úÖ FUNCI√ìN PARA MOSTRAR ERROR DE STOCK
        function showStockError(productName, availableStock) {
            const notification = document.createElement('div');
            notification.className = 'stock-notification';
            notification.innerHTML = `‚ùå No hay suficiente stock de ${productName}. M√°ximo: ${availableStock} unidades`;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // DETECTAR SI ES ADMIN
        function detectarAdmin() {
            const urlParams = new URLSearchParams(window.location.search);
            esAdmin = urlParams.has('admin');
            
            if (esAdmin) {
                adminBadge.style.display = 'inline-block';
                adminNotification.style.display = 'block';
                console.log('üîë MODO ADMIN ACTIVADO');
            }
        }

        // FUNCI√ìN MEJORADA PARA MANEJAR IM√ÅGENES
        function handleImageError(imgElement, productName) {
            console.log(`üñºÔ∏è Imagen no encontrada: ${imgElement.src}`);
            imgElement.style.display = 'none';
            const parent = imgElement.parentElement;
            
            // ‚úÖ PLACEHOLDER M√ÅS BONITO
            const firstLetter = productName.charAt(0).toUpperCase();
            const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD'];
            const color = colors[productName.length % colors.length];
            
            parent.innerHTML = `
                <div class="image-fallback" style="
                    background: ${color}; 
                    color: white; 
                    height: 100%; 
                    display: flex; 
                    flex-direction: column; 
                    align-items: center; 
                    justify-content: center;
                    border-radius: 8px;
                    font-weight: bold;
                    font-size: 2rem;">
                    ${firstLetter}
                    <div style="font-size: 0.7rem; margin-top: 0.5rem; text-align: center;">
                        ${productName.split(' ').slice(0, 3).join(' ')}
                    </div>
                </div>
            `;
        }

        // Cargar productos desde Google Sheets
        async function loadProductsFromSheets() {
            try {
                productsGrid.innerHTML = '<div class="loading">üîÑ Conectando con Google Sheets...</div>';
                
                // ‚úÖ PROXY M√ÅS CONFIABLE
                const PROXY_URL = 'https://corsproxy.io/?';
                const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=Hoja1`;
                const URL_CON_PROXY = PROXY_URL + encodeURIComponent(SHEET_URL);
                
                console.log('üîó Intentando conectar con:', URL_CON_PROXY);
                
                const response = await fetch(URL_CON_PROXY);
                
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }
                
                const csvText = await response.text();
                
                if (!csvText || csvText.trim() === '') {
                    throw new Error('No se recibieron datos del Sheets');
                }
                
                console.log('‚úÖ Datos recibidos correctamente');
                processCSVData(csvText);
                
            } catch (error) {
                console.error('Error cargando productos:', error);
                // ‚úÖ CARGAR DATOS DE RESPALDO INMEDIATAMENTE
                loadBackupProducts();
            }
        }

        function processCSVData(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim() !== '');
            
            if (lines.length < 2) {
                throw new Error('No hay suficientes datos en el Sheets');
            }
            
            const headers = parseCSVLine(lines[0]);
            const stockColumnIndex = findStockColumn(headers);
            const offerColumnIndex = findOfferColumn(headers);
            
            products = lines.slice(1).map((line, index) => {
                const values = parseCSVLine(line);
                if (values.length < 2) return null;
                
                const nombreProducto = values[0] || '';
                const nombreImagen = simplificarNombre(nombreProducto) + '.jpg';
                
                let stock = "";
                let stockNumber = 0;
                
                // ‚úÖ MEJOR PROCESAMIENTO DE STOCK
                if (stockColumnIndex !== -1 && values[stockColumnIndex] !== undefined) {
                    const stockValue = values[stockColumnIndex].toString().trim();
                    stockNumber = parseInt(stockValue) || 0;
                    
                    // ‚úÖ DEFINIR TEXTO DE STOCK SEG√öN CANTIDAD
                    if (stockNumber > 10) {
                        stock = "STOCK";
                    } else if (stockNumber > 0 && stockNumber <= 10) {
                        stock = "STOCK BAJO";
                    } else {
                        stock = "SIN STOCK";
                    }
                }
                
                // ‚úÖ PROCESAR PROMOCIONES
                let promoCode = '';
                if (offerColumnIndex !== -1 && values[offerColumnIndex] !== undefined) {
                    promoCode = values[offerColumnIndex].toString().trim();
                }
                
                const promo = PROMO_SYSTEM[promoCode];
                let hasPromo = !!promo;
                
                return {
                    id: index + 1,
                    name: nombreProducto,
                    price: parseInt(values[1]) || 0,
                    category: values[2] || 'ALMACEN',
                    description: values[3] || '',
                    image: `imagenes-productos/${nombreImagen}`,
                    stock: stock,
                    stockNumber: stockNumber, // ‚úÖ N√öMERO EXACTO DE STOCK
                    nombreArchivo: nombreImagen,
                    hasPromo: hasPromo,
                    promoCode: promoCode,
                    promoDetails: promo
                };
            }).filter(product => product && product.name && product.name.trim() !== '');
            
            if (products.length === 0) {
                throw new Error('No se pudieron cargar productos v√°lidos');
            }
            
            renderCategories();
            renderProducts();
        }

        // FUNCI√ìN PARA ENCONTRAR LA COLUMNA DE STOCK
        function findStockColumn(headers) {
            const stockKeywords = ['stock', 'inventario', 'cantidad', 'disponible', 'existencia'];
            
            for (let i = 0; i < headers.length; i++) {
                const header = headers[i].toLowerCase().trim();
                if (stockKeywords.some(keyword => header.includes(keyword))) {
                    return i;
                }
            }
            
            return headers.length > 4 ? 4 : -1;
        }

        // FUNCI√ìN: Encontrar columna de ofertas
        function findOfferColumn(headers) {
            const offerKeywords = ['oferta', 'promo', 'promocion', 'combo'];
            
            for (let i = 0; i < headers.length; i++) {
                const header = headers[i].toLowerCase().trim();
                if (offerKeywords.some(keyword => header.includes(keyword))) {
                    return i;
                }
            }
            
            return headers.length > 6 ? 6 : -1;
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current.trim());
            return result.map(field => field.replace(/^"|"$/g, ''));
        }

        // FUNCI√ìN PARA SIMPLIFICAR NOMBRES
        function simplificarNombre(nombre) {
            return nombre
                .toLowerCase()
                .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
                .replace(/[^a-z0-9 ]/g, "")
                .replace(/\s+/g, '-')
                .replace(/-+/g, '-')
                .trim();
        }

        function loadBackupProducts() {
            console.log('üì¶ Cargando datos de respaldo...');
            
            // ‚úÖ PRODUCTOS CON STOCK REAL PARA PROBAR
            products = [
                { 
                    id: 1, 
                    name: "CERVEZA QUILMES 1L - OFERTA 5", 
                    price: 4000,
                    category: "BEBIDAS", 
                    stock: "STOCK", 
                    stockNumber: 8, // ‚úÖ STOCK LIMITADO
                    image: "imagenes-productos/cerveza-quilmes-1l.jpg",
                    hasPromo: true,
                    promoCode: "5",
                    promoDetails: PROMO_SYSTEM["5"]
                },
                { 
                    id: 2, 
                    name: "GASEOSA COCA COLA 2.25L - OFERTA 3", 
                    price: 3000,
                    category: "BEBIDAS", 
                    stock: "STOCK BAJO", 
                    stockNumber: 3, // ‚úÖ STOCK BAJO
                    image: "imagenes-productos/gaseosa-coca-cola-225l.jpg",
                    hasPromo: true,
                    promoCode: "3",
                    promoDetails: PROMO_SYSTEM["3"]
                },
                { 
                    id: 3, 
                    name: "SNACK PAPAS FRITAS 90G - OFERTA 2", 
                    price: 1600,
                    category: "SNACKS", 
                    stock: "STOCK", 
                    stockNumber: 15, // ‚úÖ STOCK ALTO
                    image: "imagenes-productos/snack-papas-fritas-90g.jpg",
                    hasPromo: true,
                    promoCode: "2",
                    promoDetails: PROMO_SYSTEM["2"]
                },
                { 
                    id: 4, 
                    name: "AGUA MINERAL 2L - SIN OFERTA", 
                    price: 800,  
                    category: "BEBIDAS", 
                    stock: "SIN STOCK", 
                    stockNumber: 0, // ‚úÖ SIN STOCK
                    image: "imagenes-productos/agua-mineral-2l.jpg",
                    hasPromo: false,
                    promoCode: "",
                    promoDetails: null
                }
            ];
            
            renderCategories();
            renderProducts();
            
            productsGrid.innerHTML = `
                <div class="demo-notification">
                    <strong>üîß Modo Demo Activado</strong>
                    <br>
                    <small>Usando datos de ejemplo. Cuando tu Google Sheets est√© listo, se conectar√°n autom√°ticamente.</small>
                    <br>
                    <small><strong>üí° Prueba los l√≠mites de stock: Cerveza (m√°x 8), Gaseosa (m√°x 3), Papas (m√°x 15), Agua (sin stock)</strong></small>
                </div>
                ${productsGrid.innerHTML}
            `;
            
            console.log('‚úÖ Datos de respaldo cargados correctamente');
        }

        function init() {
            detectarAdmin();
            loadProductsFromSheets();
            setupEventListeners();
            setupSearch();
            updateCartCount();
        }

        function setupEventListeners() {
            cartIcon.addEventListener("click", openCart);
            floatingCart.addEventListener("click", openCart);
            floatingSearch.addEventListener("click", openSearchModal);
            closeSearch.addEventListener("click", closeSearchModal);
            closeCart.addEventListener("click", closeCartModal);
            sendOrder.addEventListener("click", sendOrderViaWhatsApp);
            
            // ‚úÖ EVENT LISTENERS PARA BOTONES DE LIMPIAR B√öSQUEDA
            clearSearchBtn.addEventListener("click", clearSearch);
            clearMobileSearchBtn.addEventListener("click", clearMobileSearch);
            
            cartModal.addEventListener("click", function(e) {
                if (e.target === cartModal) {
                    closeCartModal();
                }
            });
            
            searchModal.addEventListener("click", function(e) {
                if (e.target === searchModal) {
                    closeSearchModal();
                }
            });
        }

        // ========== SISTEMA DE B√öSQUEDA MEJORADO ==========
        function setupSearch() {
            // Buscador de escritorio
            productSearch.addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase().trim();
                toggleClearButton(clearSearchBtn, searchTerm);
                
                if (searchTerm === '') {
                    clearSearch();
                    return;
                }
                
                if (searchTerm.length >= 2) {
                    filterProducts(searchTerm);
                }
            });
            
            productSearch.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    const searchTerm = e.target.value.toLowerCase().trim();
                    if (searchTerm.length >= 2) {
                        filterProducts(searchTerm);
                    }
                }
            });
            
            // Buscador m√≥vil
            mobileSearch.addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase().trim();
                toggleClearButton(clearMobileSearchBtn, searchTerm);
                
                if (searchTerm === '') {
                    mobileSearchResults.style.display = 'none';
                    return;
                }
                
                if (searchTerm.length >= 2) {
                    filterMobileProducts(searchTerm);
                }
            });
        }

        // ‚úÖ FUNCI√ìN PARA MOSTRAR/OCULTAR BOT√ìN DE LIMPIAR
        function toggleClearButton(button, searchTerm) {
            if (searchTerm.length > 0) {
                button.style.display = 'block';
            } else {
                button.style.display = 'none';
            }
        }

        function openSearchModal() {
            searchModal.style.display = "flex";
            mobileSearch.focus();
        }

        function closeSearchModal() {
            searchModal.style.display = "none";
            mobileSearch.value = '';
            mobileSearchResults.style.display = 'none';
            clearMobileSearchBtn.style.display = 'none';
        }

        function clearMobileSearch() {
            mobileSearch.value = '';
            mobileSearchResults.style.display = 'none';
            clearMobileSearchBtn.style.display = 'none';
        }

        function filterProducts(searchTerm) {
            if (!products || products.length === 0) {
                console.log('Esperando que carguen los productos...');
                return;
            }
            
            isSearching = true;
            const filtered = products.filter(product => 
                product.name.toLowerCase().includes(searchTerm) &&
                (product.stock === "STOCK" || product.stockNumber > 0)
            );
            
            renderFilteredProducts(filtered, searchTerm);
        }

        function filterMobileProducts(searchTerm) {
            if (!products || products.length === 0) return;
            
            const filtered = products.filter(product => 
                product.name.toLowerCase().includes(searchTerm) &&
                (product.stock === "STOCK" || product.stockNumber > 0)
            );
            
            if (filtered.length === 0) {
                mobileSearchResults.innerHTML = `
                    <div style="text-align: center; padding: 1rem;">
                        üîç No se encontraron productos para "<strong>${searchTerm}</strong>"
                    </div>
                `;
                mobileSearchResults.style.display = 'block';
                return;
            }
            
            mobileSearchResults.innerHTML = filtered.map(product => {
                const hasStock = product.stock === "STOCK" || product.stockNumber > 0;
                const isLowStock = product.stockNumber > 0 && product.stockNumber <= 3;
                const isOutOfStock = product.stockNumber === 0;
                
                let stockText = '';
                let stockClass = '';
                
                if (isOutOfStock) {
                    stockText = '‚ùå Sin Stock';
                    stockClass = 'out-of-stock';
                } else if (isLowStock) {
                    stockText = `‚ö†Ô∏è Stock Bajo (${product.stockNumber})`;
                    stockClass = 'low-stock';
                } else {
                    stockText = `‚úÖ En Stock (${product.stockNumber})`;
                    stockClass = 'in-stock';
                }
                
                // ‚úÖ BOT√ìN DESHABILITADO SI NO HAY STOCK
                const addButton = isOutOfStock 
                    ? `<button class="add-to-cart" disabled>‚ùå Sin Stock</button>`
                    : `<button class="add-to-cart" data-id="${product.id}">üõí Agregar al Carrito</button>`;
                
                return `
                    <div class="product-card" style="margin-bottom: 1rem;">
                        <div class="product-image">
                            <img src="${product.image}" 
                                 alt="${product.name}"
                                 onerror="handleImageError(this, '${product.name.replace(/'/g, "\\'")}')">
                        </div>
                        <div class="product-info">
                            <div class="product-name">${product.name}</div>
                            <div class="product-price">$${product.price}</div>
                            <div class="product-stock ${stockClass}">
                                ${stockText}
                            </div>
                            ${addButton}
                        </div>
                    </div>
                `;
            }).join("");
            
            mobileSearchResults.style.display = 'block';
            
            // ‚úÖ AGREGAR EVENT LISTENERS A LOS BOTONES DEL CARRITO EN B√öSQUEDA M√ìVIL
            setTimeout(() => {
                addCartEventListeners();
            }, 100);
        }

        function renderFilteredProducts(filteredProducts, searchTerm) {
            if (filteredProducts.length === 0) {
                productsGrid.innerHTML = `
                    <div class="loading" style="text-align: center; padding: 2rem;">
                        üîç No se encontraron productos para "<strong>${searchTerm}</strong>"
                        <br><br>
                        <button onclick="clearSearch()" class="retry-btn">
                            ‚ú® Ver todos los productos
                        </button>
                    </div>
                `;
                return;
            }
            
            // ‚úÖ RENDERIZAR CORRECTAMENTE LOS PRODUCTOS FILTRADOS
            renderProductsFromArray(filteredProducts, searchTerm);
        }

        function clearSearch() {
            productSearch.value = '';
            mobileSearch.value = '';
            isSearching = false;
            clearSearchBtn.style.display = 'none';
            clearMobileSearchBtn.style.display = 'none';
            renderProducts();
            currentCategory = "TODOS";
            
            // Restaurar botones de categor√≠a activos
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-category') === 'TODOS') {
                    btn.classList.add('active');
                }
            });
        }

        function renderCategories() {
            const categories = [...new Set(products.map(p => p.category))];
            
            categoriesContainer.innerHTML = categories.map(category => `
                <button class="category-btn ${category === currentCategory ? 'active' : ''}" 
                        data-category="${category}">
                    ${category}
                </button>
            `).join("");
            
            // ‚úÖ ACTIVAR PRIMERA CATEGOR√çA POR DEFECTO
            if (categories.length > 0 && currentCategory === "TODOS") {
                currentCategory = categories[0];
                document.querySelector(`[data-category="${categories[0]}"]`).classList.add('active');
            }
            
            document.querySelectorAll(".category-btn").forEach(btn => {
                btn.addEventListener("click", function() {
                    currentCategory = this.getAttribute("data-category");
                    document.querySelectorAll(".category-btn").forEach(b => b.classList.remove("active"));
                    this.classList.add("active");
                    renderProducts();
                });
            });
        }

        function renderProducts() {
            const filteredProducts = products.filter(p => p.category === currentCategory);
            
            renderProductsFromArray(filteredProducts);
        }

        // ‚úÖ FUNCI√ìN PARA RENDERIZAR PRODUCTOS DESDE UN ARRAY
        function renderProductsFromArray(productsArray, searchTerm = '') {
            const productsToShow = productsArray.filter(product => {
                const hasStock = product.stock === "STOCK" || product.stockNumber > 0;
                return hasStock;
            });
            
            if (productsToShow.length === 0) {
                productsGrid.innerHTML = '<div class="loading">No hay productos disponibles</div>';
                return;
            }
            
            productsGrid.innerHTML = productsToShow.map(product => {
                const hasStock = product.stock === "STOCK" || product.stockNumber > 0;
                const isLowStock = product.stockNumber > 0 && product.stockNumber <= 3;
                const isOutOfStock = product.stockNumber === 0;
                
                let stockText = '';
                let stockClass = '';
                
                if (isOutOfStock) {
                    stockText = '‚ùå Sin Stock';
                    stockClass = 'out-of-stock';
                } else if (isLowStock) {
                    stockText = `‚ö†Ô∏è Stock Bajo (${product.stockNumber})`;
                    stockClass = 'low-stock';
                } else {
                    stockText = `‚úÖ En Stock (${product.stockNumber})`;
                    stockClass = 'in-stock';
                }
                
                // ‚úÖ BOT√ìN DESHABILITADO SI NO HAY STOCK
                const addButton = isOutOfStock 
                    ? `<button class="add-to-cart" disabled>‚ùå Sin Stock</button>`
                    : `<button class="add-to-cart" data-id="${product.id}">üõí Agregar al Carrito</button>`;
                
                return `
                    <div class="product-card">
                        <div class="product-image">
                            <img src="${product.image}" 
                                 alt="${product.name}"
                                 onerror="handleImageError(this, '${product.name.replace(/'/g, "\\'")}')">
                        </div>
                        <div class="product-info">
                            <div class="product-name">${product.name}</div>
                            <div class="product-price">$${product.price}</div>
                            <div class="product-stock ${stockClass}">
                                ${stockText}
                            </div>
                            ${addButton}
                        </div>
                    </div>
                `;
            }).join("");
            
            // ‚úÖ AGREGAR EVENT LISTENERS A LOS BOTONES DEL CARRITO - CORREGIDO
            setTimeout(() => {
                addCartEventListeners();
            }, 100);
            
            // ‚úÖ AGREGAR HEADER DE B√öSQUEDA SI HAY T√âRMINO
            if (searchTerm) {
                const searchHeader = `
                    <div class="search-results">
                        <strong>üîç B√∫squeda: "${searchTerm}"</strong>
                        <br>
                        <small>Encontraste ${productsToShow.length} producto(s)</small>
                        <button onclick="clearSearch()" style="margin-left: 10px; padding: 6px 12px; 
                                background: #ff6f00; color: white; border: none; border-radius: 15px; 
                                cursor: pointer; font-size: 0.8rem;">
                            ‚úñÔ∏è Limpiar b√∫squeda
                        </button>
                    </div>
                `;
                productsGrid.innerHTML = searchHeader + productsGrid.innerHTML;
            }
        }

        // ‚úÖ FUNCI√ìN CORREGIDA - SOLO UN EVENT LISTENER
        function addCartEventListeners() {
            // Primero remover cualquier event listener previo
            document.querySelectorAll(".add-to-cart").forEach(btn => {
                btn.replaceWith(btn.cloneNode(true));
            });
            
            // Luego agregar nuevos event listeners
            document.querySelectorAll(".add-to-cart").forEach(btn => {
                btn.addEventListener("click", function() {
                    const productId = parseInt(this.getAttribute("data-id"));
                    addToCart(productId);
                });
            });
        }

        // ‚úÖ FUNCI√ìN addToCart CORREGIDA CON CONTROL DE STOCK
        function addToCart(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) {
                console.error('‚ùå Producto no encontrado:', productId);
                return;
            }
            
            // ‚úÖ VERIFICAR STOCK DISPONIBLE
            const availableStock = product.stockNumber;
            const existingItem = cart.find(item => item.id === productId);
            const currentQuantityInCart = existingItem ? existingItem.quantity : 0;
            
            // ‚úÖ SI NO HAY STOCK SUFICIENTE
            if (currentQuantityInCart >= availableStock) {
                showStockError(product.name, availableStock);
                return;
            }
            
            if (existingItem) {
                existingItem.quantity += 1;
                // ‚úÖ RECALCULAR PRECIO CON LA NUEVA CANTIDAD
                existingItem.price = calculateDiscountedPrice(
                    product.price, 
                    product.promoCode, 
                    existingItem.quantity
                );
            } else {
                // ‚úÖ PRECIO INICIAL
                const initialPrice = calculateDiscountedPrice(
                    product.price, 
                    product.promoCode, 
                    1
                );
                
                cart.push({
                    id: product.id,
                    name: product.name,
                    price: initialPrice,
                    originalPrice: product.price,
                    hasPromo: product.hasPromo,
                    promoCode: product.promoCode,
                    promoDetails: product.promoDetails,
                    quantity: 1,
                    maxStock: availableStock // ‚úÖ GUARDAR STOCK M√ÅXIMO
                });
            }
            
            updateCartCount();
            console.log('‚úÖ Producto agregado:', product.name);
            showAddToCartFeedback(product.name);
        }

        function showAddToCartFeedback(productName) {
            // Crear notificaci√≥n temporal
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 100px;
                left: 50%;
                transform: translateX(-50%);
                background: var(--primary);
                color: white;
                padding: 12px 20px;
                border-radius: 25px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                z-index: 1002;
                font-weight: 500;
                animation: slideDown 0.3s ease;
            `;
            notification.innerHTML = `‚úÖ ${productName} agregado al carrito`;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 2000);
        }

        function updateCartCount() {
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            cartCount.textContent = totalItems;
            floatingCartCount.textContent = totalItems;
        }

        function openCart() {
            renderCartItems();
            cartModal.style.display = "flex";
        }

        function closeCartModal() {
            cartModal.style.display = "none";
        }

        function renderCartItems() {
            if (cart.length === 0) {
                cartItems.innerHTML = "<p>Tu carrito est√° vac√≠o</p>";
                cartTotal.textContent = "Total: $0";
                return;
            }
            
            let totalNormalPrice = 0;
            let totalWithPromos = 0;
            let totalSavings = 0;
            let cartItemsHTML = '';
            
            cart.forEach(item => {
                const itemNormalPrice = item.originalPrice * item.quantity;
                const itemFinalPrice = item.price * item.quantity;
                const itemSavings = itemNormalPrice - itemFinalPrice;
                
                totalNormalPrice += itemNormalPrice;
                totalWithPromos += itemFinalPrice;
                totalSavings += itemSavings;
                
                cartItemsHTML += `
                    <div class="cart-item">
                        <div class="cart-item-info">
                            <div class="cart-item-name">${item.name}</div>
                            <div class="cart-item-price">$${item.price} c/u</div>
                        </div>
                        <div class="cart-item-quantity">
                            <button class="quantity-btn" data-id="${item.id}" data-action="decrease">-</button>
                            <span class="quantity-value">${item.quantity}</span>
                            <button class="quantity-btn" data-id="${item.id}" data-action="increase">+</button>
                        </div>
                    </div>
                `;
            });
            
            cartItems.innerHTML = cartItemsHTML;
            
            // MOSTRAR TOTALES Y AHORROS
            let totalHTML = '';
            
            if (totalSavings > 0) {
                totalHTML = `
                    <div class="cart-total">
                        <div>Subtotal normal: $${totalNormalPrice}</div>
                        <div class="total-savings">
                            üéâ ¬°Ahorras: $${totalSavings}!
                        </div>
                        <div><strong>Total a pagar: $${totalWithPromos}</strong></div>
                    </div>
                `;
            } else {
                totalHTML = `
                    <div class="cart-total">
                        <div><strong>Total: $${totalNormalPrice}</strong></div>
                    </div>
                `;
            }
            
            cartTotal.innerHTML = totalHTML;
            
            document.querySelectorAll(".quantity-btn").forEach(btn => {
                btn.addEventListener("click", function() {
                    const productId = parseInt(this.getAttribute("data-id"));
                    const action = this.getAttribute("data-action");
                    updateCartItemQuantity(productId, action);
                });
            });
        }

        // ‚úÖ FUNCI√ìN updateCartItemQuantity CORREGIDA CON CONTROL DE STOCK
        function updateCartItemQuantity(productId, action) {
            const item = cart.find(item => item.id === productId);
            if (!item) return;
            
            if (action === "increase") {
                // ‚úÖ VERIFICAR STOCK ANTES DE AUMENTAR
                if (item.quantity >= item.maxStock) {
                    showStockError(item.name, item.maxStock);
                    return;
                }
                item.quantity += 1;
            } else if (action === "decrease") {
                item.quantity -= 1;
                if (item.quantity <= 0) {
                    cart = cart.filter(i => i.id !== productId);
                    updateCartCount();
                    renderCartItems();
                    return;
                }
            }
            
            // ‚úÖ RECALCULAR PRECIO
            const product = products.find(p => p.id === productId);
            if (product) {
                item.price = calculateDiscountedPrice(
                    product.price, 
                    product.promoCode, 
                    item.quantity
                );
            }
            
            updateCartCount();
            renderCartItems();
        }

        // ========== MENSAJE WHATSAPP CORREGIDO ==========
        function sendOrderViaWhatsApp() {
            if (cart.length === 0) {
                alert("Tu carrito est√° vac√≠o");
                return;
            }
            
            const phoneNumber = "5492944907380";
            
            // Calcular totales
            let totalNormal = 0;
            let totalFinal = 0;
            let totalSavings = 0;
            let appliedOffers = [];
            
            // ‚úÖ CALCULAR PRECIOS CON OFERTAS PROGRESIVAS APLICADAS
            let message = "¬°Hola! Quiero hacer este pedido:\n\n";
            message += "MI PEDIDO:\n";
            
            cart.forEach(item => {
                const product = products.find(p => p.id === item.id);
                const itemNormal = product.price * item.quantity;
                const itemFinal = item.price * item.quantity; // ‚úÖ YA INCLUYE DESCUENTOS PROGRESIVOS
                const itemSavings = itemNormal - itemFinal;
                
                totalNormal += itemNormal;
                totalFinal += itemFinal;
                totalSavings += itemSavings;
                
                // ‚úÖ CALCULAR PORCENTAJE REAL APLICADO
                const actualDiscountPercent = calculateActualDiscount(product.price, item.price);
                
                // Verificar si aplic√≥ oferta progresiva
                if (itemSavings > 0) {
                    appliedOffers.push({
                        name: item.name,
                        normalPrice: product.price,
                        discountedPrice: item.price,
                        quantity: item.quantity,
                        savings: itemSavings,
                        discountPercent: actualDiscountPercent
                    });
                }
                
                // L√≠nea del producto
                message += `‚Ä¢ ${item.name} - $${product.price} c/u x ${item.quantity} = $${itemNormal}`;
                
                // ‚úÖ MOSTRAR SI APLIC√ì DESCUENTO PROGRESIVO
                if (itemSavings > 0) {
                    message += ` (¬°OFERTA ${actualDiscountPercent}%! = $${itemFinal})`;
                }
                message += `\n`;
            });
            
            message += `\nüíµ *TOTAL NORMAL:* $${totalNormal}\n`;
            
            // Mostrar ofertas progresivas aplicadas
            if (appliedOffers.length > 0) {
                message += `\nüéâ *OFERTAS APLICADAS*\n\n`;
                
                appliedOffers.forEach(offer => {
                    message += `‚ú® ${offer.name}\n`;
                    message += `   Precio normal: $${offer.normalPrice} c/u\n`;
                    message += `   Precio oferta: $${offer.discountedPrice} c/u (${offer.discountPercent}% OFF)\n`;
                    message += `   Llevando ${offer.quantity} unidades\n\n`;
                });
                message += `\nüíµ *TOTAL SIN DESCUENTOS:* $${totalNormal}\n`;
                message += `üí∞ *TOTAL AHORRO:* $${totalSavings}\n`;
                message += `üí≥ *TOTAL CON DESCUENTOS:* $${totalFinal}\n`;
            } else {
                message += `\nüí≥ *TOTAL A PAGAR:* $${totalNormal}\n`;
            }
            
            message += `\nüìç Retiro en Copihue 457\n`;
            message += `‚è∞ Horario: 10:30 a 23:00 hrs.`;
            
            const encodedMessage = encodeURIComponent(message);
            const whatsappURL = `https://wa.me/${phoneNumber}?text=${encodedMessage}`;
            
            window.open(whatsappURL, "_blank");
            closeCartModal();
            cart = [];
            updateCartCount();
        }

        document.addEventListener("DOMContentLoaded", init);
    </script>
</body>
</html>
