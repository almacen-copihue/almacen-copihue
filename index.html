<!DOCTYPE html>
<!-- vic311225_1956 -->
<html lang="es">
<head>
    <!-- REPARACI√ìN COMPLETA - OFERTAS ESPECIALES 24/7 -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Almac√©n Copihue - Productos de calidad con la confianza de siempre</title>
    
    <!-- META TAGS PARA PWA -->
    <meta name="theme-color" content="#2e7d32">
    <meta name="description" content="Almac√©n Copihue">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Almac√©n Copihue">
    
    <!-- SISTEMA ANTI-CACHE CAPA 1 -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <!-- ICONOS -->
    <link rel="icon" href="iconos-pwa/android/android-launchericon-48-48.png" type="image/png">
    <link rel="apple-touch-icon" href="iconos-pwa/ios/180.png">
    <link rel="apple-touch-icon" sizes="152x152" href="iconos-pwa/ios/152.png">
    <link rel="apple-touch-icon" sizes="167x167" href="iconos-pwa/ios/167.png">
    <link rel="apple-touch-icon" sizes="180x180" href="iconos-pwa/ios/180.png">
    <link rel="apple-touch-startup-image" href="iconos-pwa/ios/1024.png">
    
    <!-- MANIFEST EXTERNO -->
    <link rel="manifest" href="manifest.json">
    
    <!-- ESTILOS -->
<style>
        /* ========== VARIABLES Y ESTILOS BASE ========== */
        :root {
            --primary: #2e7d32;
            --primary-dark: #1b5e20;
            --primary-light: #4caf50;
            --secondary: #ff6f00;
            --secondary-dark: #f57c00;
            --accent: #ffeb3b;
            --light: #f8fff8;
            --dark: #1b5e20;
            --gray: #757575;
            --white: #ffffff;
            --card-bg: #ffffff;
            --shadow: 0 4px 15px rgba(46,125,50,0.1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--light);
            color: var(--dark);
            line-height: 1.6;
            background-image: linear-gradient(135deg, #f8fff8 0%, #e8f5e9 100%);
        }
        
        /* ========== HEADER ========== */
        header {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: var(--white);
            padding: 1rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow);
        }
        
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .logo-icon {
            font-size: 1.8rem;
        }

        .admin-badge {
            background: var(--secondary);
            color: white;
            padding: 0.2rem 0.6rem;
            border-radius: 12px;
            font-size: 0.7rem;
            margin-left: 0.5rem;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        .cart-icon {
            position: relative;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: background 0.3s;
        }
        
        .cart-icon:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .cart-count {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--secondary);
            color: white;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        /* ========== CONTENEDOR PRINCIPAL ========== */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }
        
        .hero {
            background: linear-gradient(135deg, rgba(46,125,50,0.9), rgba(76,175,80,0.8));
            background-size: cover;
            color: white;
            padding: 3rem 1rem;
            text-align: center;
            border-radius: 15px;
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
        }
        
        .hero h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .hero p {
            font-size: 1.1rem;
            margin-bottom: 1rem;
            opacity: 0.9;
        }
        
        .info-bar {
            background-color: var(--white);
            padding: 1.2rem;
            border-radius: 12px;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-around;
            text-align: center;
            border-left: 4px solid var(--secondary);
        }
        
        .info-item {
            margin: 0.5rem;
            font-weight: 500;
        }
        
        /* ========== OFERTAS REL√ÅMPAGO ========== */
        .flash-sales-container {
            display: none;
            margin-bottom: 2rem;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 30px rgba(255, 0, 0, 0.15);
            border: 3px solid #ff3d00;
            position: relative;
            background: linear-gradient(135deg, #fff8e1, #ffecb3);
        }
        
        .flash-sales-header {
            background: linear-gradient(135deg, #ff3d00, #d50000);
            color: white;
            padding: 1rem;
            text-align: center;
            position: relative;
        }
        
        .flash-sales-header h2 {
            font-size: 1.4rem;
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .flash-badge {
            background: #ffff00;
            color: #d50000;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
            animation: flash 1.5s infinite;
        }
        
        @keyframes flash {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .flash-timer {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 15px;
            border-radius: 25px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        .flash-products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            padding: 1.5rem;
            background: white;
        }
        
        .flash-product-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(255, 61, 0, 0.1);
            border: 2px solid #ffccbc;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .flash-product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(255, 61, 0, 0.2);
            border-color: #ff3d00;
        }
        
        .flash-exclusive-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            background: linear-gradient(135deg, #ff3d00, #ff6d00);
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
            z-index: 10;
            box-shadow: 0 3px 10px rgba(255, 61, 0, 0.3);
        }
        
        .flash-price {
            color: #d50000;
            font-size: 1.3rem;
            font-weight: bold;
            margin: 5px 0;
        }
        
        .flash-discount {
            background: #ffeb3b;
            color: #d50000;
            padding: 3px 8px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 0.9rem;
            margin-left: 10px;
        }
        
        .flash-stock-warning {
            background: #ffecb3;
            color: #ff6f00;
            padding: 0.8rem;
            border-radius: 8px;
            margin-top: 1rem;
            text-align: center;
            font-size: 0.9rem;
            border-left: 4px solid #ff9800;
        }
        
        .flash-countdown-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
            border-radius: 15px;
        }
        
        .countdown-message {
            text-align: center;
            padding: 2rem;
        }
        
        .countdown-message h3 {
            color: #d50000;
            margin-bottom: 1rem;
        }
        
        .tomorrow-countdown {
            background: #e8f5e9;
            padding: 1rem;
            border-radius: 10px;
            text-align: center;
            margin-top: 1rem;
            border: 2px dashed #4CAF50;
        }
        
        /* ========== OFERTAS DESTACADAS ========== */
        .featured-offers {
            margin-bottom: 2rem;
            text-align: center;
        }
        
        .featured-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding: 0 0.5rem;
        }
        
        .featured-title {
            font-size: 1.5rem;
            color: var(--primary);
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .view-all-offers {
            background: linear-gradient(135deg, #ff6f00, #f57c00);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9rem;
            transition: all 0.3s;
        }
        
        .view-all-offers:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255,111,0,0.3);
        }
        
        /* ========== B√öSQUEDA ========== */
        .search-container {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            padding: 1rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #e8f5e9;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-radius: 12px;
            position: relative;
        }
        
        .search-wrapper {
            position: relative;
            width: 100%;
        }
        
        .search-input {
            width: 100%;
            padding: 14px 50px 14px 20px;
            border: 2px solid var(--primary);
            border-radius: 25px;
            font-size: 1rem;
            background: white;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(46,125,50,0.1);
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--primary-dark);
            box-shadow: 0 0 0 3px rgba(46,125,50,0.2);
        }
        
        .clear-search {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: var(--gray);
            transition: color 0.3s;
            padding: 5px;
            z-index: 2;
            display: none;
        }
        
        .clear-search:hover {
            color: var(--primary);
        }
        
        .search-results {
            text-align: center;
            padding: 12px;
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            border-radius: 10px;
            margin-bottom: 1rem;
            border-left: 4px solid #2196f3;
        }

        /* ========== CATEGOR√çAS ========== */
        .category-btn {
            background: #29B6F6;
            border: 2px solid #0288D1;
            color: #FFFFFF;
            box-shadow: 0 2px 6px rgba(2, 136, 209, 0.2);
            font-weight: 600;
            padding: 0.7rem 1.2rem;
            border-radius: 25px;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.25s ease;
            position: relative;
            user-select: none;
        }

        .category-btn.active {
            background: #0288D1;
            border-color: #29B6F6;
            color: #FFFFFF;
            box-shadow: 0 4px 12px rgba(41, 182, 246, 0.3);
            transform: translateY(-1px);
        }

        @media (hover: hover) {
            .category-btn:hover:not(.active) {
                background: #03A9F4;
                border-color: #0277BD;
                transform: translateY(-1px);
                box-shadow: 0 3px 8px rgba(2, 119, 189, 0.25);
            }
            .category-btn.active:hover {
                background: #0277BD;
                border-color: #4FC3F7;
            }
        }
        
        .offer-count-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #FF6F00;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: bold;
            min-width: 20px;
            text-align: center;
            border: 2px solid #FFFFFF;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 1;
        }

        @media (min-width: 768px) {
            .categories {
                display: flex;
                flex-wrap: wrap;
                gap: 0.8rem;
                margin-bottom: 2rem;
                justify-content: flex-start;
            }
            
            .category-btn {
                padding: 0.8rem 1.5rem;
                font-size: 0.9rem;
                min-width: auto;
            }
            
            .offer-count-badge {
                top: -6px;
                right: -6px;
                font-size: 0.75rem;
                padding: 2px 6px;
                min-width: 22px;
            }
        }

        @media (max-width: 767px) {
            .categories {
                display: flex;
                overflow-x: auto;
                gap: 0.6rem;
                margin-bottom: 1.5rem;
                padding-bottom: 0.5rem;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: thin;
                scrollbar-color: #0288D1 #e8f5e9;
            }
            
            .categories::-webkit-scrollbar {
                height: 6px;
            }
            
            .categories::-webkit-scrollbar-track {
                background: #e8f5e9;
                border-radius: 10px;
            }
            
            .categories::-webkit-scrollbar-thumb {
                background: #0288D1;
                border-radius: 10px;
            }
            
            .category-btn {
                padding: 0.8rem 1rem;
                font-size: 0.85rem;
                min-width: max-content;
                flex-shrink: 0;
            }
            
            .categories-dropdown-container {
                display: none !important;
            }
            
            .offer-count-badge {
                top: -5px;
                right: -5px;
                font-size: 0.65rem;
                padding: 1px 4px;
                min-width: 18px;
            }
        }

        /* ========== PRODUCTOS ========== */
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        @media (min-width: 1200px) {
            .products-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        @media (min-width: 768px) and (max-width: 1199px) {
            .products-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 767px) {
            .products-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .cart-icon {
                display: none;
            }
            
            .featured-header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }
        }

        @media (max-width: 480px) {
            .products-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .product-card {
            background-color: var(--card-bg);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            border: 1px solid #e8f5e9;
            position: relative;
        }
        
        .product-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 8px 25px rgba(46,125,50,0.15);
        }
        
        .product-image {
            height: 160px;
            background: linear-gradient(135deg, #e8f5e8, #c8e6c9);
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0.8rem;
            position: relative;
            overflow: hidden;
        }
        
        .product-image img {
            max-width: 100%;
            max-height: 130px;
            object-fit: contain;
            transition: transform 0.3s ease;
        }
        
        .product-card:hover .product-image img {
            transform: scale(1.05);
        }
        
        .product-info {
            padding: 1rem;
        }
        
        .product-name {
            font-weight: 600;
            margin-bottom: 0.4rem;
            font-size: 0.9rem;
            color: var(--dark);
            line-height: 1.3;
        }
        
        .product-price-container {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 0.5rem;
        }
        
        .original-price {
            color: var(--gray);
            text-decoration: line-through;
            font-size: 0.9rem;
        }
        
        .product-price {
            color: var(--secondary);
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        .discount-percent {
            background: #ffeb3b;
            color: #333;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: bold;
        }
        
        .product-stock {
            font-size: 0.75rem;
            margin-bottom: 0.8rem;
            font-weight: 500;
        }
        
        .in-stock {
            color: var(--primary-light);
        }
        
        .out-of-stock {
            color: var(--gray);
        }

        .low-stock {
            color: #ff9800;
            font-weight: bold;
        }
        
        .add-to-cart {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            border: none;
            padding: 0.7rem;
            border-radius: 8px;
            width: 100%;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .add-to-cart:hover {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary));
            transform: translateY(-2px);
        }
        
        .add-to-cart:disabled {
            background: var(--gray);
            cursor: not-allowed;
            transform: none;
        }

        /* ========== OFERTAS ESPECIALES ========== */
        .especiales-container {
            margin-bottom: 2rem;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 30px rgba(56, 142, 60, 0.15);
            border: 3px solid #388e3c;
            position: relative;
            background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
        }

        .especiales-header {
            background: linear-gradient(135deg, #388e3c, #2e7d32);
            color: white;
            padding: 1rem;
            text-align: center;
            position: relative;
        }

        .especiales-header h2 {
            font-size: 1.4rem;
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .especial-badge {
            background: #c8e6c9;
            color: #1b5e20;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
        }

        .especial-timer {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 15px;
            border-radius: 25px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
            font-weight: bold;
            font-size: 1rem;
        }

        .especiales-products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            padding: 1.5rem;
            background: white;
        }

        .especiales-info {
            background: #e8f5e9;
            color: #1b5e20;
            padding: 0.8rem;
            text-align: center;
            font-size: 0.9rem;
            border-top: 2px dashed #81c784;
        }

 /* ========== SISTEMA DE COLORES DE OFERTAS ========== */
/* ‚ö° REL√ÅMPAGO - ROJO (‚â•50% OFF) */
.jerarquia-relampago {
    border: 4px solid #d50000 !important;
    background: #ffebee !important;
    position: relative;
}

.jerarquia-relampago::before {
    content: "‚ö° REL√ÅMPAGO";
    position: absolute;
    top: -12px;
    left: 50%;
    transform: translateX(-50%);
    background: #d50000;
    color: white;
    padding: 4px 12px;
    border-radius: 15px;
    font-size: 0.8rem;
    font-weight: bold;
    z-index: 100;
    white-space: nowrap;
    border: 2px solid white;
}

    

.jerarquia-relampago .offer-badge {
    top: 34px;   /* ajust√° 24‚Äì32 seg√∫n gusto */
    background: #d50000 !important;
    color: white !important;
    border: 2px solid white !important;
}

.jerarquia-relampago .product-price {
    color: #d50000 !important;
    font-weight: bold;
}

/* üî• DESTACADAS - NARANJA (15-49% OFF) */
.jerarquia-destacadas {
    border: 3px solid #ff6f00 !important;
    background: #fff3e0 !important;
    position: relative;
}

.jerarquia-destacadas::before {
    content: "üî• DESTACADA";
    position: absolute;
    top: -12px;
    left: 50%;
    transform: translateX(-50%);
    background: #ff6f00;
    color: white;
    padding: 4px 12px;
    border-radius: 15px;
    font-size: 0.8rem;
    font-weight: bold;
    z-index: 100;
    white-space: nowrap;
    border: 2px solid white;
}

.jerarquia-destacadas .offer-badge {
    background: #ff6f00 !important;
    color: white !important;
    border: 2px solid white !important;
}

.jerarquia-destacadas .product-price {
    color: #ff6f00 !important;
    font-weight: bold;
}

/* üéÅ ESPECIALES - VERDE (1-14% OFF) */
.jerarquia-especiales {
    border: 3px solid #388e3c !important;
    background: #e8f5e9 !important;
    position: relative;
}

.jerarquia-especiales::before {
    /*content: "üéÅ ESPECIAL";*/
    position: absolute;
    top: -12px;
    left: 50%;
    transform: translateX(-50%);
    background: #388e3c;
    color: white;
    padding: 4px 12px;
    border-radius: 15px;
    font-size: 0.8rem;
    font-weight: bold;
    z-index: 100;
    white-space: nowrap;
    border: 2px solid white;
}

.jerarquia-especiales .offer-badge {
    background: #388e3c !important;
    color: white !important;
    border: 2px solid white !important;
}

.jerarquia-especiales .product-price {
    color: #388e3c !important;
    font-weight: bold;
}

/* üì¶ RESERVA - AZUL (0% OFF - SIN DESCUENTO) */
.jerarquia-reserva {
    border: 2px dashed #2196F3 !important;
    background: #E3F2FD !important;
    position: relative;
}

.jerarquia-reserva::before {
    content: "üì¶ RESERVA";
    position: absolute;
    top: -12px;
    left: 50%;
    transform: translateX(-50%);
    background: #2196F3;
    color: white;
    padding: 4px 12px;
    border-radius: 15px;
    font-size: 0.8rem;
    font-weight: bold;
    z-index: 100;
    white-space: nowrap;
    border: 2px solid white;
}

.jerarquia-reserva .offer-badge {
    background: #2196F3 !important;
    color: white !important;
    border: 2px solid white !important;
}

.jerarquia-reserva .product-price {
    color: #2196F3 !important;
    font-weight: bold;
}

/* Badge general para todos */
.offer-badge {
    position: absolute;
    top: 10px;
    right: 10px;
    padding: 4px 10px;
    border-radius: 15px;
    font-size: 0.75rem;
    font-weight: bold;
    z-index: 10;
    box-shadow: 0 3px 10px rgba(0,0,0,0.2);
}

        /* ========== CARRITO ========== */
        .cart-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .cart-content {
            background-color: var(--white);
            width: 90%;
            max-width: 500px;
            border-radius: 15px;
            padding: 1.5rem;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow);
        }
        
        .cart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            border-bottom: 2px solid #e8f5e9;
            padding-bottom: 0.8rem;
        }
        
        .close-cart {
            background: none;
            border: none;
            font-size: 1.8rem;
            cursor: pointer;
            color: var(--gray);
            transition: color 0.3s;
        }
        
        .close-cart:hover {
            color: var(--primary);
        }
        
        .cart-items {
            margin-bottom: 1rem;
        }
        
        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.8rem 0;
            border-bottom: 1px solid #e8f5e9;
        }
        
        .cart-item-info {
            flex-grow: 1;
        }
        
        .cart-item-name {
            font-weight: bold;
            color: var(--dark);
        }
        
        .cart-item-price {
            color: var(--gray);
            font-size: 0.9rem;
        }
        
        .cart-item-quantity {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .quantity-btn {
            background-color: var(--light);
            border: 1px solid #c8e6c9;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .quantity-btn:hover {
            background-color: var(--primary-light);
            color: white;
        }
        
        .quantity-value {
            margin: 0 0.5rem;
            font-weight: bold;
            min-width: 20px;
            text-align: center;
        }
        
        .cart-total {
            font-weight: bold;
            font-size: 1.3rem;
            text-align: right;
            margin-bottom: 1rem;
            color: var(--primary);
            padding-top: 1rem;
            border-top: 2px solid #e8f5e9;
        }
        
        .total-savings {
            background: #4caf50;
            color: white;
            padding: 0.8rem;
            border-radius: 8px;
            margin: 0.5rem 0;
            text-align: center;
            font-weight: bold;
        }
        
        .send-order {
            background: linear-gradient(135deg, var(--secondary), var(--secondary-dark));
            color: white;
            border: none;
            padding: 1.2rem;
            border-radius: 10px;
            width: 100%;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .send-order:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255,111,0,0.3);
        }
        
        /* ========== NOTIFICACIONES ========== */
        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--gray);
            font-size: 1.1rem;
        }
        
        .error-message {
            text-align: center;
            padding: 2rem;
            color: #d32f2f;
            background: #ffebee;
            border-radius: 10px;
            margin: 1rem 0;
            border-left: 4px solid #d32f2f;
        }
        
        .retry-btn {
            margin-top: 10px;
            padding: 10px 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.3s;
        }
        
        .retry-btn:hover {
            background: var(--primary-dark);
        }

        .admin-notification {
            background: linear-gradient(135deg, #ff9800, #f57c00);
            color: white;
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            text-align: center;
            animation: slideIn 0.5s ease;
        }

        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* ========== BOTONES FLOTANTES ========== */
        .floating-home {
            position: fixed;
            bottom: 160px;
            right: 20px;
            background: linear-gradient(135deg, #2196F3, #0D47A1);
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(33, 150, 243, 0.4);
            z-index: 997;
            transition: all 0.3s ease;
            font-size: 1.8rem;
        }

        .floating-home:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(33, 150, 243, 0.6);
        }
        
        .floating-search {
            position: fixed;
            bottom: 90px;
            right: 20px;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: none;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(46,125,50,0.4);
            z-index: 998;
            transition: all 0.3s ease;
            font-size: 1.5rem;
        }
        
        .floating-search:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(46,125,50,0.6);
        }

        .floating-cart {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, var(--secondary), var(--secondary-dark));
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(255,111,0,0.4);
            z-index: 999;
            transition: all 0.3s ease;
            font-size: 1.5rem;
        }
        
        .floating-cart:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(255,111,0,0.6);
        }
        
        .floating-cart .cart-count {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--primary);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.8rem;
            font-weight: bold;
            border: 2px solid white;
        }

        /* ========== PANEL ADMIN ========== */
        .admin-floating-button {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: linear-gradient(135deg, #2e7d32, #1b5e20);
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: none;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(46,125,50,0.4);
            z-index: 9998;
            transition: all 0.3s ease;
            font-size: 1.5rem;
            border: 3px solid white;
        }

        .admin-floating-button:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(46,125,50,0.6);
        }

        .admin-panel {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            z-index: 9999;
            width: 320px;
            max-height: 80vh;
            overflow-y: auto;
            display: none;
            border: 3px solid #2e7d32;
            animation: slideInRight 0.3s ease;
        }

        .admin-panel-header {
            background: linear-gradient(135deg, #2e7d32, #1b5e20);
            color: white;
            padding: 15px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .admin-panel-header h3 {
            margin: 0;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .admin-panel-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.3s;
        }

        .admin-panel-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .admin-panel-content {
            padding: 15px;
        }

        .admin-section {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        .admin-section h4 {
            color: #2e7d32;
            margin-bottom: 10px;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .admin-buttons-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .admin-button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-align: center;
        }

        .admin-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        /* ========== FOOTER ========== */
        footer {
            background: linear-gradient(135deg, var(--dark), var(--primary));
            color: var(--white);
            padding: 2rem 1rem;
            text-align: center;
            margin-top: 3rem;
        }
        
        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* ========== RESPONSIVE ========== */
        @media (max-width: 767px) {
            .floating-home {
                bottom: 150px;
                right: 20px;
                width: 55px;
                height: 55px;
                font-size: 1.6rem;
            }
            
            .floating-search {
                bottom: 85px;
                width: 55px;
                height: 55px;
                font-size: 1.3rem;
            }
            
            .floating-cart {
                bottom: 20px;
                width: 55px;
                height: 55px;
                font-size: 1.3rem;
            }
            
            .floating-cart .cart-count {
                width: 22px;
                height: 22px;
                font-size: 0.7rem;
            }
            
            .search-container {
                display: none;
            }
            
            .floating-search {
                display: flex;
            }
        }

        /* ========== OTROS ESTILOS ========== */
        .search-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1001;
            justify-content: center;
            align-items: flex-start;
            padding-top: 80px;
        }
        
        .search-modal-content {
            background-color: var(--white);
            width: 90%;
            max-width: 500px;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
        }
        
        .search-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            border-bottom: 2px solid #e8f5e9;
            padding-bottom: 0.8rem;
        }
        
        .close-search {
            background: none;
            border: none;
            font-size: 1.8rem;
            cursor: pointer;
            color: var(--gray);
            transition: color 0.3s;
        }
        
        .close-search:hover {
            color: var(--primary);
        }

        .stock-notification {
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: #f44336;
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1002;
            font-weight: 500;
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from { 
                transform: translateX(-50%) translateY(-20px); 
                opacity: 0; 
            }
            to { 
                transform: translateX(-50%) translateY(0); 
                opacity: 1; 
            }
        }

        /* Ocultar botones innecesarios */
        #viewAllOffers,
        .view-all-offers,
        .categories-dropdown-container {
            display: none !important;
        }
</style>
</head>
<body>
    <header>
        <div class="header-content">
            <div class="logo">
                <img src="iconos-pwa/android/android-launchericon-48-48.png" alt="Logo Almac√©n Copihue" class="logo-icon">
                Almac√©n Copihue
                <span id="adminBadge" class="admin-badge" style="display: none;">ADMIN</span>
                <span id="adminOfertasContador" style="display: none;"></span>
                <span id="adminReservaContador" style="display: none;"></span>
            </div>
            <div class="cart-icon" id="cartIcon">
                üõí <span class="cart-count" id="cartCount">0</span>
            </div>
        </div>
    </header>

    <div class="container">
        <div id="adminNotification" class="admin-notification" style="display: none;">
            <strong>üîî MODO ADMIN ACTIVADO</strong> - Recibir√°s alertas de stock bajo
        </div>

        <section class="hero">
            <h1>"Almac√©n Copihue"</h1>
            <p>Productos de calidad con la confianza de siempre</p>
        </section>

        <section class="info-bar">
            <div class="info-item">
                <strong>üìç Retiro en el local:</strong> Copihue 457
            </div>
            <div class="info-item">
                <strong>üìû WhatsApp:</strong> +5492944907380
            </div>
            <div class="info-item">
                <strong>‚è∞ Horario:</strong> 11:30 a 23:30 hrs.
            </div>
        </section>

        <!-- ========== OFERTAS REL√ÅMPAGO ========== -->
        <div class="flash-sales-container" id="flashSalesContainer">
            <div class="flash-sales-header">
                <h2>
                    ‚ö° OFERTAS REL√ÅMPAGO 
                    <span class="flash-badge">URGENCIA M√ÅXIMA</span>
                </h2>
                <div class="flash-timer" id="flashTimer">
                    ‚è∞ ¬°√öLTIMA OPORTUNIDAD! Termina en: <span id="countdown">--:--:--</span>
                </div>
            </div>
            
            <div class="flash-stock-warning">
                ‚ö†Ô∏è <strong>NIVEL M√ÅXIMO:</strong> Solo 3 productos por d√≠a. 
                Descuentos superiores al 40% OFF. ¬°Selecci√≥n exclusiva!
            </div>
            
            <div class="flash-products-grid" id="flashProductsGrid">
                <!-- Productos rel√°mpago se cargan aqu√≠ -->
            

            </div>
            <div class="flash-countdown-overlay" id="flashCountdownOverlay">
                <div class="countdown-message">
                    <h3>‚è∞ OFERTAS REL√ÅMPAGO FINALIZADAS</h3>
                    <p>Las ofertas rel√°mpago de hoy han terminado.</p>
                    <p>Volver√°n ma√±ana de 11:30 a 17:00 hrs.</p>
                    <div class="tomorrow-countdown">
                        <strong>üîÑ Pr√≥ximas ofertas rel√°mpago en:</strong>
                        <div id="nextFlashCountdown">--:--:--</div>
                    </div>
                </div>
            </div>
        </div>

        <section class="featured-offers" id="featuredOffers" style="display: none;">
            <div class="featured-header">
                <div class="featured-title">
                    üî• OFERTAS DESTACADAS
                </div>
                <button class="view-all-offers" id="viewAllOffers">
                    Ver todas las ofertas
                </button>
            </div>
            <div class="products-grid" id="featuredProductsGrid">
                <!-- Ofertas destacadas din√°micas -->
            </div>
        </section>

        <!-- ========== OFERTAS ESPECIALES ROTATIVAS ========== -->
        <div class="especiales-container" id="especialesContainer" style="display: block;"> <!-- CAMBIADO: display: block por defecto -->
            <div class="especiales-header">
                <h2>
                    üéÅ OFERTA ESPECIAL DEL D√çA
                    <span class="especial-badge">¬°Solo 2 productos!</span>
                </h2>
                <div class="especial-timer">
                    ‚è∞ Disponible las 24 horas
                </div>
            </div>
            
            <div class="especiales-products-grid" id="especialesProductsGrid">
                <!-- Productos especiales rotativos se cargan aqu√≠ -->
            </div>
            
            <div class="especiales-info">
                <small>üéÅ OPORTUNIDAD DEL D√çA ‚Ä¢ Selecci√≥n limitada ‚Ä¢ Disponible hoy</small>
            </div>
        </div>

        <div class="search-container" id="desktopSearch">
            <div class="search-wrapper">
                <input type="text" id="productSearch" class="search-input" 
                       placeholder="üîç Buscar productos por nombre, abreviatura o sin√≥nimo...">
                <button class="clear-search" id="clearSearchBtn">‚úñÔ∏è</button>
                <div id="searchSuggestions" class="search-suggestions"></div>
            </div>
        </div>

        <!-- CATEGOR√çAS √öNICAS - SCROLL HORIZONTAL EN M√ìVIL -->
        <section class="categories" id="categories">
            <!-- Categor√≠as din√°micas -->
        </section>

        <section class="products-grid" id="productsGrid">
            <div class="loading">üîÑ Cargando productos desde tu API...</div>
        </section>
    </div>

    <!-- BOTONES FLOTANTES -->
    <div class="floating-home" id="floatingHome">
        üè†
    </div>
    
    <div class="floating-search" id="floatingSearch">
        üîç
    </div>

    <div class="floating-cart" id="floatingCart">
        üõí
        <span class="cart-count" id="floatingCartCount">0</span>
    </div>

    <!-- Bot√≥n flotante de administraci√≥n -->
    <div class="admin-floating-button" id="adminFloatingButton">
        ‚öôÔ∏è
    </div>

    <!-- Panel de administraci√≥n -->
    <div class="admin-panel" id="adminPanel">
        <div class="admin-panel-header">
            <h3>üîß PANEL ADMINISTRACI√ìN</h3>
            <button class="admin-panel-close" id="adminPanelClose">&times;</button>
        </div>
        <div class="admin-panel-content">
            <div class="admin-section">
                <h4>üîì FORZAR VISIBILIDAD</h4>
                <div class="admin-buttons-grid">
                    <button class="admin-button info" id="adminForceRelampago">
                        ‚ö° Rel√°mpago
                    </button>
                    <button class="admin-button warning" id="adminForceDestacadas">
                        üî• Destacadas
                    </button>
                    <button class="admin-button purple" id="adminForceEspeciales">
                        üéÅ Especiales
                    </button>
                </div>
                <div class="admin-status" id="adminForcedStatus">
                    üîÑ Forzado: Ninguno
                </div>
            </div>

            <div class="admin-section">
                <h4>üóëÔ∏è LIMPIAR CACHE</h4>
                <div class="admin-buttons-grid">
                    <button class="admin-button danger" id="adminClearCache">
                        üßπ Limpiar Todo
                    </button>
                    <button class="admin-button" id="adminClearLocal">
                        üì± LocalStorage
                    </button>
                    <button class="admin-button" id="adminClearSession">
                        üíæ SessionStorage
                    </button>
                    <button class="admin-button" id="adminClearFlash">
                        ‚ö° Flash Sales
                    </button>
                </div>
            </div>

            <div class="admin-section">
                <h4>üëÅÔ∏è VISIBILIDAD</h4>
                <div class="admin-toggle" id="adminToggleOcultos">
                    <div class="admin-toggle-label">
                        üëÅÔ∏è Mostrar productos ocultos
                    </div>
                    <div class="admin-toggle-switch"></div>
                </div>
                <div class="admin-toggle" id="adminToggleDebug">
                    <div class="admin-toggle-label">
                        üî¨ Modo debug
                    </div>
                    <div class="admin-toggle-switch"></div>
                </div>
                <div class="admin-buttons-grid">
                    <button class="admin-button" id="adminRefreshData">
                        üîÑ Recargar datos
                    </button>
                    <button class="admin-button" id="adminTestAPI">
                        üß™ Test API
                    </button>
                </div>
            </div>

<div class="admin-section">
    <h4>üî¨ TEST SECCIONES</h4>
    <div class="admin-buttons-grid">
        <button class="admin-button info" id="adminTestRelampago">
            ‚ö° Test Rel√°mpago
        </button>
        <button class="admin-button warning" id="adminTestDestacadas">
            üî• Test Destacadas
        </button>
        <button class="admin-button purple" id="adminTestEspeciales">
            üéÅ Test Especiales
        </button>
        <button class="admin-button" id="adminTestHorarios">
            üïí Test Horarios
        </button>
        <!-- NUEVO BOT√ìN AQU√ç -->
        <button class="admin-button danger" id="adminDebugFlash">
            ‚ö° Debug Flash
        </button>
    </div>
</div>
            <div class="admin-section">
                <h4>üìä INFORMACI√ìN DEL SISTEMA</h4>
                <div class="admin-status" id="adminSystemInfo">
                    Cargando informaci√≥n del sistema...
                </div>
                <div class="admin-buttons-grid">
                    <button class="admin-button" id="adminExportData">
                        üì§ Exportar datos
                    </button>
                    <button class="admin-button danger" id="adminResetAll">
                        üö® Reset total
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="search-modal" id="searchModal">
        <div class="search-modal-content">
            <div class="search-modal-header">
                <h2>Buscar Productos</h2>
                <button class="close-search" id="closeSearch">&times;</button>
            </div>
            <div class="search-wrapper">
                <input type="text" id="mobileSearch" class="search-input" 
                       placeholder="üîç Escribe nombre, abreviatura o sin√≥nimo..."
                       onkeydown="handleMobileSearchEnter(event)">
                <button class="clear-search" id="clearMobileSearchBtn">‚úñÔ∏è</button>
            </div>
            <div class="mobile-search-results" id="mobileSearchResults">
                <!-- Resultados b√∫squeda m√≥vil -->
            </div>
        </div>
    </div>

    <div class="cart-modal" id="cartModal">
        <div class="cart-content">
            <div class="cart-header">
                <h2>Tu Pedido</h2>
                <button class="close-cart" id="closeCart">&times;</button>
            </div>
            <div class="cart-items" id="cartItems">
                <!-- Items del carrito -->
            </div>
            <div class="cart-total" id="cartTotal">Total: $0</div>
            <button class="send-order" id="sendOrder">Enviar Pedido por WhatsApp</button>
        </div>
    </div>

    <div class="install-prompt" id="installPrompt">
        <span>üì± Instalar App</span>
    </div>

    <div class="ios-instructions" id="iosInstructions" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 10000; justify-content: center; align-items: center; padding: 20px;">
        <div style="background: white; border-radius: 20px; padding: 30px; max-width: 400px; text-align: center; position: relative;">
            <!-- Bot√≥n cerrar (X) -->
            <button onclick="document.getElementById('iosInstructions').style.display='none'" 
                    style="position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 24px; cursor: pointer; color: #666; padding: 5px; line-height: 1;">
                &times;
            </button>
            
            <h2 style="color: #2e7d32; margin-bottom: 20px; padding-right: 30px;">üì± Instalar en iPhone/iPad</h2>
            <div style="text-align: left; margin: 20px 0; font-size: 16px; line-height: 1.8;">
                <p>1. Toca el bot√≥n <strong style="color: #2e7d32;">Compartir</strong> üì§</p>
                <p>2. Despl√°zate hacia abajo</p>
                <p>3. Selecciona <strong style="color: #2e7d32;">"Agregar a Inicio"</strong></p>
                <p>4. Toca <strong style="color: #2e7d32;">"Agregar"</strong></p>
            </div>
            <button onclick="document.getElementById('iosInstructions').style.display='none'" 
                    style="background: #2e7d32; color: white; border: none; padding: 12px 30px; 
                           border-radius: 25px; font-size: 16px; font-weight: bold; cursor: pointer; 
                           margin-top: 10px; width: 100%;">
                Entendido
            </button>
        </div>
    </div>

    <footer>
        <div class="footer-content">
            <p>Almac√©n Copihue - Productos de calidad con la confianza de siempre</p>
            <p>üìç Copihue 457 | üìû +5492944907380 | ‚è∞ 11:30 a 23:30 hrs.</p>
        </div>
    </footer>

    <script>
        // ========== CONTROL DE INICIALIZACI√ìN ==========
        
        // ========== VERSI√ìN Y CONFIGURACI√ìN ==========
        const APP_VERSION = '20241220-REPARACION-ESPECIALES-24-7';
        
        // ========== VARIABLES GLOBALES ==========
        let products = [];
        let cart = [];
        let currentCategory = "ALMACEN";
        let lowStockAlertSent = false;
        let esAdmin = false;
        let isSearching = false;
        let mostrarProductosOcultos = false;
        let modoDebug = false;
        
        // ¬°NUEVA VARIABLE PARA CONTROL DE INICIALIZACI√ìN!
        let appInitialized = false;

function simplificarNombre(texto = '') {
    if (!texto || typeof texto !== 'string') {
        console.log('‚ö†Ô∏è simplificarNombre: texto vac√≠o o no es string');
        return 'producto';
    }
    
    // Limpiar el texto paso a paso
    let resultado = texto
        .toString()
        .toLowerCase()
        .normalize("NFD")                     // Separa acentos
        .replace(/[\u0300-\u036f]/g, "")     // Elimina diacr√≠ticos
        .replace(/√±/g, 'n')                  // Mantiene la √±
        .replace(/[^a-z0-9\s]/g, ' ')        // Todo lo que no sea letra/n√∫mero a espacio
        .replace(/\s+/g, ' ')                // M√∫ltiples espacios a uno
        .trim();
    
    // Reemplazar espacios por guiones SOLO si hay espacios
    resultado = resultado.replace(/\s+/g, '-');
    
    // Si qued√≥ vac√≠o, devolver un nombre gen√©rico
    if (!resultado || resultado === '-' || resultado === '') {
        return 'producto';
    }
    
    return resultado;
}

function getImageUrl(productName) {
    try {
        if (!productName) return 'imagenes-productos/producto.jpg';
        const baseName = simplificarNombre(productName);
        return `imagenes-productos/${baseName}.jpg`;
    } catch (error) {
        console.warn('Error generando URL de imagen:', error);
        return 'imagenes-productos/producto.jpg';
    }
}

function getImageUrl(productName) {
    try {
        const baseName = simplificarNombre(productName);
        return `imagenes-productos/${baseName}.jpg`;
    } catch (error) {
        console.warn('Error generando URL de imagen:', error);
        return `imagenes-productos/producto.jpg`;
    }
}
        
        // Inicializar arrays globales
        window.productosRelampagoIds = [];
        window.productosDestacadosIds = [];
        window.productosEspecialesIds = [];
        window.productosReservaIds = [];
        
        // Variables de control admin
        window.ADMIN_TOOLS = {
            forcedSections: {
                relampago: false,
                destacadas: false,
                especiales: false
            },
            showHidden: false,
            debugMode: false
        };
        
function handleImageError(imgElement, productName) {
    // Evitar loops
    if (imgElement.hasAttribute('data-error-handled')) {
        return;
    }
    
    imgElement.setAttribute('data-error-handled', 'true');
    
    // Solo mostrar log si es admin
    if (esAdmin) {
        const nombreArchivo = imgElement.src.split('/').pop();
        console.log(`üñºÔ∏è Imagen faltante: ${nombreArchivo} (${productName.substring(0, 30)}...)`);
    }
    
    // Crear placeholder m√°s informativo
    const cleanName = (productName || 'Producto')
        .replace(/[^\w\s]/g, '')
        .substring(0, 20);
    
    const esOferta = imgElement.closest('.jerarquia-relampago, .jerarquia-destacadas, .jerarquia-especiales');
    const colorFondo = esOferta ? '#fff3e0' : '#e8f5e9';
    const colorTexto = esOferta ? '#ff6f00' : '#2e7d32';
    
    imgElement.src = `data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="150">
        <rect width="200" height="150" fill="${colorFondo}"/>
        <rect x="5" y="5" width="190" height="140" fill="white" rx="5"/>
        <text x="100" y="50" text-anchor="middle" font-size="12" fill="${colorTexto}" font-family="Arial">
            ${encodeURIComponent(cleanName)}
        </text>
        <text x="100" y="85" text-anchor="middle" font-size="10" fill="#666">
            ${esOferta ? 'üéÅ OFERTA ESPECIAL' : 'üì¶ PRODUCTO'}
        </text>
        <text x="100" y="105" text-anchor="middle" font-size="9" fill="#999">
            Imagen no disponible
        </text>
    </svg>`;
    
    imgElement.onerror = null;
    imgElement.style.objectFit = 'contain';
    imgElement.style.padding = '10px';
    imgElement.style.backgroundColor = colorFondo;
    imgElement.style.border = '2px dashed ' + (esOferta ? '#ff9800' : '#c8e6c9');
}
        
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            const colors = {
                'error': '#f44336',
                'success': '#4CAF50', 
                'info': '#2196F3',
                'warning': '#ff9800'
            };
            
            notification.style.cssText = `
                position: fixed;
                top: 100px;
                left: 50%;
                transform: translateX(-50%);
                background: ${colors[type] || colors.info};
                color: white;
                padding: 12px 24px;
                border-radius: 25px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                z-index: 10000;
                font-weight: 500;
                animation: slideDown 0.3s ease;
                border: 2px solid white;
            `;
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => notification.remove(), 3000);
        }
        
        function mostrarErrorFormato(datos) {
            console.error('Formato de datos inesperado:', datos);
            if (productsGrid) {
                productsGrid.innerHTML = `
                    <div class="error-message">
                        ‚ö†Ô∏è Error en el formato de datos recibido
                        <br><br>
                        <button class="retry-btn" onclick="loadProductsFromAPI()">Reintentar</button>
                    </div>
                `;
            }
        }
        
        function mostrarErrorAmigable(error) {
            console.error('Error detallado:', error);
            if (productsGrid) {
                productsGrid.innerHTML = `
                    <div class="error-message">
                        ‚ö†Ô∏è No se pudieron cargar los productos
                        <br><br>
                        <small>${error.message || 'Error de conexi√≥n'}</small>
                        <br><br>
                        <button class="retry-btn" onclick="loadProductsFromAPI()">Reintentar carga</button>
                    </div>
                `;
            }
        }
        
        // ========== SISTEMA DE ROTACI√ìN COMPLETO - IMPLEMENTACI√ìN FINAL ==========
        
        // 1. ACTUALIZAR JERARQU√çA DE OFERTAS CON NUEVOS HORARIOS
        const JERARQUIA_OFERTAS = {
            // NIVEL 1: REL√ÅMPAGO (URGENCIA M√ÅXIMA) - DOMINGO A JUEVES 11:30-17:00
            'relampago': {
                nombre: 'REL√ÅMPAGO',
                icono: '‚ö°',
                descuentoMinimo: 33,
                stockMaximo: 5,
                cantidadVisible: 3,
                color: '#ff3d00',
                horario: { 
                    start: 11, 
                    startMinutes: 30, 
                    end: 17, 
                    endMinutes: 0 
                },
                dias: [0, 1, 2, 3, 4], // Domingo(0) a Jueves(4)
                mensaje: '¬°√öLTIMA OPORTUNIDAD! Se acaba HOY',
                pool: []
            },
            
            // NIVEL 2: DESTACADAS (OFERTAS MEDIAS) - VIERNES Y S√ÅBADO 18:00-23:00
            'destacadas': {
                nombre: 'DESTACADAS',
                icono: 'üî•',
                descuentoMinimo: 15,
                descuentoMaximo: 32,
                stockMaximo: 10,
                cantidadVisible: 9,
                color: '#ff9800',
                horario: { 
                    start: 18, 
                    startMinutes: 0, 
                    end: 23, 
                    endMinutes: 0 
                },
                dias: [5, 6], // Viernes(5) y S√°bado(6)
                mensaje: 'OFERTAS ESPECIALES - Precios rebajados',
                pool: []
            },
            
            // NUEVO NIVEL 3: ESPECIALES (OFERTAS SUAVES) - SIEMPRE VISIBLES 24/7
            'especiales': {
                nombre: 'ESPECIALES',
                icono: 'üéÅ',
                descuentoMinimo: 1,
                descuentoMaximo: 14,
                stockMaximo: 10,
                cantidadVisible: 2,
                color: '#9c27b0',
                horario: { 
                    start: 0, 
                    startMinutes: 0, 
                    end: 24, 
                    endMinutes: 0 
                },
                dias: [0, 1, 2, 3, 4, 5, 6], // Todos los d√≠as
                mensaje: 'üéÅ OFERTA ESPECIAL DEL D√çA - ¬°Solo 2 productos!',
                pool: [],
                siempreVisible: true // ¬°NUEVA PROPIEDAD - 24/7!
            }
        };
        
        const OFERTAS_SISTEMA = {
            '1': { 
                nombre: "2x1", 
                tipo: "2x1", 
                eslogan: "üí• ¬°2x1! - Llev√° 2, Pag√° 1",
                ejemplo: "2 unidades = 50% OFF (¬°MITAD DE PRECIO!)",
                color: "#d50000",
                descuentoReal: 50
            },
            '2': { 
                nombre: "3x2", 
                tipo: "3x2", 
                eslogan: "üéØ 3x2 - Llev√° 3, Pag√° 2",
                ejemplo: "3 unidades = (una es GRATIS)",
                color: "#ff6f00",
                descuentoReal: 33
            },
            '3': { 
                nombre: "4x3", 
                tipo: "4x3", 
                eslogan: "üèÜ 4x3 - Llev√° 4, Pag√° 3",
                ejemplo: "4 unidades = 25% OFF",
                color: "#2196f3",
                descuentoReal: 25
            },
            '4': { 
                nombre: "5x4", 
                tipo: "5x4", 
                eslogan: "üíé 5x4 - Llev√° 5, Pag√° 4",
                ejemplo: "5 unidades = 20% OFF",
                color: "#9c27b0",
                descuentoReal: 20
            },
            '5': { 
                nombre: "6x5", 
                tipo: "6x5", 
                eslogan: "üëë 6x5 - Llev√° 6, Pag√° 5",
                ejemplo: "6 unidades = 17% OFF",
                color: "#ff4081",
                descuentoReal: 17
            },
            '6': { 
                nombre: "7x6", 
                tipo: "7x6", 
                eslogan: "üöÄ 7x6 - Llev√° 7, Pag√° 6",
                ejemplo: "7 unidades = 14% OFF",
                color: "#00bcd4",
                descuentoReal: 14
            },
            '7': { 
                nombre: "8x7", 
                tipo: "8x7", 
                eslogan: "üåü 8x7 - Llev√° 8, Pag√° 7",
                ejemplo: "8 unidades = 13% OFF",
                color: "#8e24aa",
                descuentoReal: 13
            },
            '8': { 
                nombre: "9x8", 
                tipo: "9x8", 
                eslogan: "üí´ 9x8 - Llev√° 9, Pag√° 8",
                ejemplo: "9 unidades = 11% OFF",
                color: "#43a047",
                descuentoReal: 11
            },
            '9': { 
                nombre: "10x9", 
                tipo: "10x9", 
                eslogan: "üéä 10x9 - Llev√° 10, Pag√° 9",
                ejemplo: "10 unidades = 10% OFF",
                color: "#fb8c00",
                descuentoReal: 10
            },
            '10': { 
                nombre: "2da50", 
                tipo: "2da50", 
                eslogan: "üéÅ 2da unidad 50% OFF",
                ejemplo: "2 unidades = 25% OFF en total",
                color: "#e91e63",
                descuentoReal: 25
            },
            '11': { 
                nombre: "30progresivo", 
                tipo: "30progresivo", 
                eslogan: "üìà 30% desde la 2da",
                ejemplo: "2da: 15% OFF | 3ra+: 20% OFF",
                color: "#3f51b5",
                descuentoReal: 20
            }
        };
        
        // ========== FUNCI√ìN CR√çTICA: OBTENER DESCUENTO REAL ==========
        function obtenerDescuentoRealProducto(producto) {
            if (producto.ofertas2 && producto.ofertas2 !== '0' && producto.ofertas2 !== '') {
                const descuento = parseInt(producto.ofertas2);
                if (!isNaN(descuento) && descuento > 0) {
                    return descuento;
                }
            }
            
            if (producto.ofertas1 && producto.ofertas1 !== '0' && producto.ofertas1 !== '') {
                const oferta = OFERTAS_SISTEMA[producto.ofertas1];
                if (oferta && oferta.descuentoReal) {
                    return oferta.descuentoReal;
                }
            }
            
            return 0;
        }
        
        // ========== FUNCIONES DE OFERTAS ==========
        function redondearPrecioAlmacenCopihue(precio) {
            if (typeof precio !== 'number' || isNaN(precio) || precio <= 0) return 0;
            
            if (precio === Math.floor(precio)) {
                return precio;
            }
            
            return Math.round(precio);
        }
        
        // üö® REPARACI√ìN CR√çTICA: FUNCI√ìN CALCULAR PRECIO CON DESCUENTO
        function calcularPrecioConDescuento(precioOriginal, ofertas1, ofertas2, cantidad) {
            if (!precioOriginal || precioOriginal <= 0 || !cantidad || cantidad <= 0) {
                return precioOriginal || 0;
            }
            
            // üéØ CORRECCI√ìN: Descuento porcentual directo (ofertas2)
            if (ofertas2 && !isNaN(parseInt(ofertas2))) {
                const descuentoPorcentaje = parseInt(ofertas2);
                
                if (descuentoPorcentaje > 0 && descuentoPorcentaje <= 100) {
                    const limiteOferta2 = obtenerLimiteOfertas2(ofertas2);
                    if (limiteOferta2 !== null && cantidad > limiteOferta2) {
                        cantidad = limiteOferta2;
                    }
                    
                    // üéØ CALCULAR CORRECTAMENTE el precio unitario con descuento
                    const descuentoDecimal = descuentoPorcentaje / 100;
                    const precioUnitarioConDescuento = precioOriginal * (1 - descuentoDecimal);
                    
                    // Redondear seg√∫n las reglas del almac√©n
                    return redondearPrecioAlmacenCopihue(precioUnitarioConDescuento);
                }
            }
            
            if (ofertas1 && OFERTAS_SISTEMA[ofertas1]) {
                const oferta = OFERTAS_SISTEMA[ofertas1];
                
                let totalAPagar = 0;
                
                switch(oferta.tipo) {
                    case '2x1':
                        const grupos2 = Math.floor(cantidad / 2);
                        const sobras2 = cantidad % 2;
                        totalAPagar = (grupos2 * precioOriginal * 1) + (sobras2 * precioOriginal);
                        break;
                        
                    case '3x2':
                        const grupos3 = Math.floor(cantidad / 3);
                        const sobras3 = cantidad % 3;
                        totalAPagar = (grupos3 * precioOriginal * 2) + (sobras3 * precioOriginal);
                        break;
                        
                    case '4x3':
                        const grupos4 = Math.floor(cantidad / 4);
                        const sobras4 = cantidad % 4;
                        totalAPagar = (grupos4 * precioOriginal * 3) + (sobras4 * precioOriginal);
                        break;
                        
                    case '5x4':
                        const grupos5 = Math.floor(cantidad / 5);
                        const sobras5 = cantidad % 5;
                        totalAPagar = (grupos5 * precioOriginal * 4) + (sobras5 * precioOriginal);
                        break;
                        
                    case '6x5':
                        const grupos6 = Math.floor(cantidad / 6);
                        const sobras6 = cantidad % 6;
                        totalAPagar = (grupos6 * precioOriginal * 5) + (sobras6 * precioOriginal);
                        break;
                        
                    case '2da50':
                        const pares = Math.floor(cantidad / 2);
                        const impares = cantidad % 2;
                        totalAPagar = (pares * (precioOriginal + (precioOriginal * 0.5))) + (impares * precioOriginal);
                        break;
                        
                    case '30progresivo':
                        let descuento = 0;
                        if (cantidad === 1) descuento = 0;
                        else if (cantidad === 2) descuento = 0.15;
                        else descuento = 0.20;
                        
                        totalAPagar = precioOriginal * cantidad * (1 - descuento);
                        break;
                        
                    default:
                        totalAPagar = precioOriginal * cantidad;
                }
                
                // Calcular precio unitario despu√©s de aplicar la oferta
                const precioUnitario = totalAPagar / cantidad;
                return redondearPrecioAlmacenCopihue(precioUnitario);
            }
            
            return precioOriginal;
        }
        
        // üéØ NUEVA FUNCI√ìN PARA CALCULAR PRECIO DE OFERTA REL√ÅMPAGO
        function calcularPrecioOfertaRelampago(producto) {
            const precioOriginal = producto.price || 0;
            
            if (producto.ofertas2 && producto.ofertas2 !== '0') {
                const descuento = parseInt(producto.ofertas2);
                if (descuento > 0 && descuento <= 100) {
                    const precioConDescuento = precioOriginal * (1 - (descuento / 100));
                    return redondearPrecioAlmacenCopihue(precioConDescuento);
                }
            }
            
            // Si no hay oferta2, usar el precio normal
            return precioOriginal;
        }
        
        function calcularDescuentoReal(precioOriginal, precioFinal) {
            if (precioOriginal <= 0 || precioFinal >= precioOriginal) return 0;
            return Math.round(((precioOriginal - precioFinal) / precioOriginal) * 100);
        }
        
        function obtenerDescripcionOferta(ofertas1, ofertas2, precioOriginal, cantidad = 1) {
            if (ofertas2 && !isNaN(parseInt(ofertas2))) {
                const descuento = parseInt(ofertas2);
                if (descuento > 0 && descuento <= 100) {
                    const precioConDescuento = calcularPrecioConDescuento(precioOriginal, ofertas1, ofertas2, 1);
                    const ahorro = precioOriginal - precioConDescuento;
                    return `üî• ¬°${descuento}% OFF! Ahorr√° $${Math.round(ahorro)} por unidad`;
                }
            }
            
            if (ofertas1 && OFERTAS_SISTEMA[ofertas1]) {
                const oferta = OFERTAS_SISTEMA[ofertas1];
                return oferta.eslogan;
            }
            
            return "";
        }
        
        function obtenerTextoCortoOferta(ofertas1, ofertas2) {
            if (ofertas2 && !isNaN(parseInt(ofertas2))) {
                const descuento = parseInt(ofertas2);
                if (descuento > 0 && descuento <= 100) {
                    return `üî• ${descuento}% OFF`;
                }
            }
            
            if (ofertas1 && OFERTAS_SISTEMA[ofertas1]) {
                const oferta = OFERTAS_SISTEMA[ofertas1];
                return `üéØ ${oferta.nombre}`;
            }
            
            return "";
        }
        
        function obtenerDetalleOferta3x2(ofertas1, precioOriginal, cantidad = 1) {
            if (!ofertas1 || !OFERTAS_SISTEMA[ofertas1]) return "";
            
            const oferta = OFERTAS_SISTEMA[ofertas1];
            
            switch(oferta.tipo) {
                case '3x2':
                    let detalle3x2 = `<div class="oferta-3x2-detalle">
                        <div class="oferta-3x2-titulo">üéØ OFERTA 3x2 REAL</div>
                        <div class="oferta-3x2-ejemplo">`;
                    
                    if (cantidad === 1) {
                        detalle3x2 += `‚Ä¢ 1 unidad: $${precioOriginal} (normal)`;
                    } else if (cantidad === 2) {
                        detalle3x2 += `‚Ä¢ 2 unidades: $${precioOriginal * 2} (normales)`;
                    } else if (cantidad === 3) {
                        const precio3unidades = redondearPrecioAlmacenCopihue(calcularPrecioConDescuento(precioOriginal, ofertas1, '', 3) * 3);
                        detalle3x2 += `‚Ä¢ 3 unidades: $${precio3unidades} (la 3ra GRATIS)`;
                    } else if (cantidad === 4) {
                        const precio4unidades = redondearPrecioAlmacenCopihue(calcularPrecioConDescuento(precioOriginal, ofertas1, '', 4) * 4);
                        detalle3x2 += `‚Ä¢ 4 unidades: $${precio4unidades} (3x2 + 1 normal)`;
                    } else if (cantidad === 6) {
                        const precio6unidades = redondearPrecioAlmacenCopihue(calcularPrecioConDescuento(precioOriginal, ofertas1, '', 6) * 6);
                        detalle3x2 += `‚Ä¢ 6 unidades: $${precio6unidades} (2 paquetes 3x2)`;
                    } else {
                        detalle3x2 += oferta.ejemplo;
                    }
                    
                    detalle3x2 += `</div></div>`;
                    return detalle3x2;
                    
                case '2da50':
                    return `<div class="oferta-3x2-detalle">
                        <div class="oferta-3x2-titulo">${oferta.eslogan}</div>
                        <div class="oferta-3x2-ejemplo">${oferta.ejemplo}</div>
                    </div>`;
                    
                case '30progresivo':
                    return `<div class="oferta-3x2-detalle">
                        <div class="oferta-3x2-titulo">${oferta.eslogan}</div>
                        <div class="oferta-3x2-ejemplo">${oferta.ejemplo}</div>
                    </div>`;
                    
                default:
                    return "";
            }
        }
        
        function obtenerMayorOfertaDelDia() {
            if (!products || products.length === 0) return null;
            
            const ofertas = products.filter(p => 
                Number(p.ofertas2) > 0 && 
                (p.stock === "STOCK" || p.stockNumber > 0)
            );
            
            if (ofertas.length === 0) return null;
            
            ofertas.sort((a, b) => Number(b.ofertas2) - Number(a.ofertas2));
            return ofertas[0];
        }
        
        function obtenerEtiquetaOfertaDestacada(descuento) {
            const desc = Number(descuento);
            if (desc >= 50) return "üèÜ ¬°SUPER OFERT√ìN!";
            if (desc >= 30) return "üî• ¬°OFERT√ìN!";
            if (desc >= 20) return "‚ú® ¬°GRAN OFERTA!";
            if (desc > 0) return "üëç ¬°OFERTA!";
            return "";
        }
        
        // ===============================
        // CATEGOR√çA SEG√öN % DE DESCUENTO
        // ===============================
        function obtenerFraseCategoria(descuento) {
            if (descuento >= 70) return "üö® REMATE ¬∑ Se va o se va";
            if (descuento >= 60) return "üö® Liquidaci√≥n ¬∑ Hasta agotar stock";
            if (descuento >= 40) return "üî• Alta oferta ¬∑ Precio que no se ve siempre";
            if (descuento >= 25) return "üü† OFERT√ìN";
            if (descuento >= 15) return "üü° En oferta";
            return "üü¢ Buen precio";
        }
        
        function compartirMegaOferta(id) {
            console.log('ü§ù Compartiendo oferta ID:', id);

            const producto = window.products?.find(p => p.id === id);
            if (!producto) {
                alert('No se pudo encontrar el producto');
                return;
            }

            const precioOriginal = producto.price || 0;
            const precioOferta = producto.discountedPrice || precioOriginal;
            const ahorro = Math.round(precioOriginal - precioOferta);
            const descuento = producto.ofertas2 ? parseInt(producto.ofertas2) : 0;

            const categoria = obtenerFraseCategoria(descuento);

            const linkOferta = "https://almacen-copihue.vercel.app";

            let mensaje = `${categoria}\n\n`;
            mensaje += `Hola, mir√° esta oferta del Almac√©n Copihue üëá\n\n`;
            mensaje += `üõí *${producto.name}*\n\n`;
            mensaje += `üí∞ Antes: $${precioOriginal}\n`;
            mensaje += `üî• Ahora: *$${precioOferta}*\n`;
            if (ahorro > 0) mensaje += `üí∏ Ahorr√°s $${ahorro}\n\n`;

            mensaje += `üëâ Ver las ofertas ac√°:\n${linkOferta}\n\n`;
            mensaje += `Almac√©n Copihue\n`;
            mensaje += `Productos de calidad con la confianza de siempre`;

            console.log('üì§ Mensaje generado:', mensaje);

            window.open(
                `https://wa.me/?text=${encodeURIComponent(mensaje)}`,
                "_blank",
                "noopener,noreferrer"
            );
        }
        
        function mostrarFeedbackWhatsApp() {
            try {
                document.querySelectorAll('.feedback-whatsapp').forEach(el => el.remove());
                
                const feedback = document.createElement('div');
                feedback.className = 'feedback-whatsapp';
                
                feedback.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="font-size: 28px; animation: pulse 1.5s infinite;">üì±</div>
                        <div>
                            <div style="font-weight: bold; font-size: 16px;">¬°Abriendo WhatsApp!</div>
                            <div style="font-size: 13px; opacity: 0.9; margin-top: 3px;">
                                Mensaje listo para enviar al Almac√©n Copihue
                            </div>
                        </div>
                    </div>
                `;
                
                feedback.style.cssText = `
                    position: fixed;
                    top: 130px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: linear-gradient(135deg, #25D366, #128C7E);
                    color: white;
                    padding: 18px 24px;
                    border-radius: 14px;
                    box-shadow: 0 10px 30px rgba(37, 211, 102, 0.5);
                    z-index: 10000;
                    animation: slideDown 0.4s ease;
                    border: 3px solid white;
                    min-width: 340px;
                    max-width: 90%;
                `;
                
                document.body.appendChild(feedback);
                
                setTimeout(() => {
                    if (feedback.parentNode) {
                        feedback.parentNode.removeChild(feedback);
                    }
                }, 3000);
                
            } catch (error) {
                console.warn('‚ö†Ô∏è Error en feedback:', error);
            }
        }
        
        if (!document.querySelector('style#pulse-animation')) {
            const style = document.createElement('style');
            style.id = 'pulse-animation';
            style.textContent = `
                @keyframes pulse {
                    0% { transform: scale(1); }
                    50% { transform: scale(1.1); }
                    100% { transform: scale(1); }
                }
            `;
            document.head.appendChild(style);
        }
        
        function compartirPorWhatsApp(mensaje) {
            const phoneNumber = "5492944907380";
            const encodedMessage = encodeURIComponent(mensaje);
            const whatsappURL = `https://wa.me/${phoneNumber}?text=${encodedMessage}`;
            
            console.log('üì≤ Abriendo WhatsApp:', whatsappURL);
            
            const nuevaVentana = window.open(whatsappURL, '_blank', 'noopener,noreferrer');
            
            if (!nuevaVentana) {
                alert('‚ö†Ô∏è Por favor, permite ventanas emergentes para compartir por WhatsApp');
                console.error('‚ùå Bloqueo de ventanas emergentes detectado');
            }
            
            mostrarFeedbackCompartir();
        }
        
        function mostrarFeedbackCompartir(productName = '') {
            try {
                const notificacionesPrevias = document.querySelectorAll('.feedback-compartir');
                notificacionesPrevias.forEach(el => el.remove());
                
                const notification = document.createElement('div');
                notification.className = 'feedback-compartir';
                
                const mensaje = productName 
                    ? `‚úÖ ¬°Oferta de "${productName}" lista para compartir!` 
                    : `‚úÖ ¬°Oferta lista para compartir por WhatsApp!`;
                
                notification.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="font-size: 20px;">üì±</div>
                        <div>
                            <div style="font-weight: bold;">${mensaje}</div>
                            <div style="font-size: 12px; opacity: 0.9;">Se abrir√° WhatsApp en una nueva pesta√±a</div>
                        </div>
                    </div>
                `;
                
                notification.style.cssText = `
                    position: fixed;
                    top: 120px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: linear-gradient(135deg, #25D366, #128C7E);
                    color: white;
                    padding: 15px 25px;
                    border-radius: 15px;
                    box-shadow: 0 6px 20px rgba(37, 211, 102, 0.5);
                    z-index: 1003;
                    font-weight: 600;
                    font-size: 14px;
                    animation: slideDown 0.3s ease;
                    border: 2px solid white;
                    text-align: center;
                    min-width: 300px;
                    max-width: 90%;
                `;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 3000);
                
            } catch (error) {
                console.warn('‚ö†Ô∏è Error en mostrarFeedbackCompartir:', error);
            }
        }
        
        function mostrarInfoAdmin(producto) {
            if (!esAdmin) return '';
            
            let info = '<div style="font-size: 0.7rem; color: #666; background: #f5f5f5; padding: 5px; margin-top: 5px; border-radius: 5px; border-left: 3px solid #ff9800;">';
            info += '<strong>üëÅÔ∏è INFO ADMIN:</strong><br>';
            
            if (producto.ofertas2 && producto.ofertas2 !== '0') {
                info += `Ofertas2: ${producto.ofertas2}%<br>`;
            }
            if (producto.ofertas1 && producto.ofertas1 !== '0') {
                const oferta = OFERTAS_SISTEMA[producto.ofertas1];
                if (oferta) {
                    info += `Ofertas1: ${oferta.nombre} (${oferta.descuentoReal}% real)<br>`;
                }
            }
            
            const descuentoReal = calcularDescuentoReal(producto.price, producto.discountedPrice);
            if (descuentoReal > 0) {
                info += `Descuento real: ${descuentoReal}%<br>`;
                info += `Precio unit. real: $${(producto.discountedPrice).toFixed(2)}`;
            }
            info += '</div>';
            
            return info;
        }
        
        function obtenerLimiteOfertas2(ofertas2) {
            if (!ofertas2 || ofertas2 === '') return null;
            
            const porcentaje = parseInt(ofertas2);
            if (isNaN(porcentaje)) return null;
            
            if (porcentaje >= 70 && porcentaje <= 99) {
                return 3;
            } else if (porcentaje >= 50 && porcentaje <= 69) {
                return 5;
            }
            
            return null;
        }
        
        function obtenerTextoLimiteOfertas2(ofertas2, nombreProducto = '') {
            const limite = obtenerLimiteOfertas2(ofertas2);
            if (limite === null) return '';
            
            const tipoVenta = obtenerTipoDeVenta(nombreProducto);
            
            switch(tipoVenta) {
                case 'peso':
                    const nombreLower = nombreProducto.toLowerCase();
                    if (nombreLower.includes('gr') || nombreLower.includes('gramo')) {
                        return `<span class="tipo-venta-icon">‚öñÔ∏è</span> M√°x. ${limite * 1000} GRAMOS por familia`;
                    } else {
                        return `<span class="tipo-venta-icon">‚öñÔ∏è</span> M√°x. ${limite} KILOS por familia`;
                    }
                case 'unidad':
                    return `<span class="tipo-venta-icon">üì¶</span> M√°x. ${limite} UNIDADES por familia`;
                case 'empaque':
                    return `<span class="tipo-venta-icon">üéÅ</span> M√°x. ${limite} PAQUETES por familia`;
                default:
                    return `<span class="tipo-venta-icon">üì¶</span> M√°x. ${limite} unidades por familia`;
            }
        }
        
        function obtenerTextoStock(product) {
            const tipoVenta = obtenerTipoDeVenta(product.name);
            const stockNumber = product.stockNumber || 0;
            
            if (stockNumber === 0) {
                return '‚ùå Sin Stock';
            }
            
            let icono = '';
            let unidad = '';
            
            if (tipoVenta === 'peso') {
                const nombreLower = product.name.toLowerCase();
                
                if (nombreLower.includes(' gr') || nombreLower.includes('gramo') || 
                    /\bgr\b/i.test(product.name)) {
                    icono = '‚öñÔ∏è';
                    unidad = `${stockNumber}g`;
                } else {
                    icono = '‚öñÔ∏è';
                    unidad = `${stockNumber}kg`;
                }
            } 
            else if (tipoVenta === 'unidad') {
                icono = 'üì¶';
                unidad = `${stockNumber}u`;
            }
            else if (tipoVenta === 'empaque') {
                icono = 'üéÅ';
                unidad = `${stockNumber}pqt`;
            }
            else {
                icono = 'üì¶';
                unidad = `${stockNumber}u`;
            }
            
            if (stockNumber > 0 && stockNumber <= 3) {
                return `‚ö†Ô∏è Stock Bajo ${icono} <span class="stock-tipo">(${unidad})</span>`;
            } else {
                return `‚úÖ En Stock ${icono} <span class="stock-tipo">(${unidad})</span>`;
            }
        }
        
        function obtenerTipoDeVenta(nombreProducto) {
            const nombre = nombreProducto.toLowerCase().trim();
            
            const tieneGramosEspecificados = /\d+\s*(gr|g|gramo|gramos)\b/i.test(nombreProducto);
            if (tieneGramosEspecificados) {
                const esProductoSuelto = /^(jengibre|pimienta|comino|oregano|pimenton|laurel|provenzal)\s+gr?\b/i.test(nombreProducto);
                if (!esProductoSuelto) {
                    return 'unidad';
                }
            }
            
            if (nombre.includes(' kg') || /\bkg\b/i.test(nombreProducto)) {
                const excepcionesUnidad = ['arroz', 'azucar', 'az√∫car', 'harina', 'sal', 'yerba', 'polenta', 'grasa'];
                const esExcepcion = excepcionesUnidad.some(ex => 
                    nombre.includes(ex) && nombre.includes('1 kg')
                );
                if (!esExcepcion) return 'peso';
            }
            
            if (nombre.includes('gaseosa') || nombre.includes('jugo') || 
                nombre.includes('bebida') || nombre.includes('refresco') ||
                nombre.includes('agua') || nombre.includes('helado') ||
                nombre.includes('vino') || nombre.includes('cerveza') ||
                nombre.includes('fernet') || nombre.includes('manaos') ||
                nombre.includes('cunnington') || nombre.includes('powerade')) {
                return 'unidad';
            }
            
            if (nombre.includes('alfajor') || nombre.includes('galletita') ||
                nombre.includes('galleta') || nombre.includes('chocolate') ||
                nombre.includes('caramelo') || nombre.includes('chicle') ||
                nombre.includes('turron') || nombre.includes('golosina') ||
                nombre.includes('snack') || nombre.includes('budin') ||
                nombre.includes('pan dulce') || nombre.includes('pure de tomate') ||
                nombre.includes('salsa de tomate') || nombre.includes('pure') ||
                nombre.includes('salsa')) {
                return 'unidad';
            }
            
            const frutasVerduras = ['tomate', 'durazno', 'manzana', 'naranja', 
                                   'cebolla', 'papa', 'zanahoria', 'lechuga',
                                   'limon', 'mandarina', 'banana'];
            
            for (const fv of frutasVerduras) {
                if (nombre.includes(fv)) {
                    if (!nombre.includes('unidad') && !nombre.includes('unid') && 
                        !nombre.includes('u ') && !nombre.includes(' c/u')) {
                        return 'peso';
                    }
                }
            }
            
            const especiasSuelto = ['jengibre gr', 'pimienta gr', 'comino gr', 
                                   'oregano gr', 'pimenton gr', 'laurel gr', 
                                   'provenzal gr', 'aji molido gr'];
            
            for (const especia of especiasSuelto) {
                if (nombre.includes(especia)) {
                    return 'peso';
                }
            }
            
            return 'unidad';
        }
        
// ========== SISTEMA DE CLASIFICACI√ìN SIMPLIFICADO Y CLARO ==========
function clasificarProductosPorJerarquia() {
    console.log('üéØ CLASIFICANDO productos - SISTEMA SIMPLIFICADO');
    
    // Resetear arrays
    window.productosRelampagoIds = [];
    window.productosDestacadosIds = [];
    window.productosEspecialesIds = [];
    window.productosReservaIds = [];
    
    // PASO 1: UN SOLO REL√ÅMPAGO ‚â•50% (cambia diariamente)
    const productos50plus = products
        .filter(p => p.descuentoReal >= 50 && p.stockNumber > 0)
        .sort((a, b) => b.descuentoReal - a.descuentoReal);
    
    if (productos50plus.length > 0) {
        const hoy = new Date();
        const diaDelMes = hoy.getDate(); // 1-31
        const indice = diaDelMes % productos50plus.length;
        window.productosRelampagoIds.push(productos50plus[indice].id);
        console.log(`‚ö° REL√ÅMPAGO DEL D√çA: ${productos50plus[indice].name} (${productos50plus[indice].descuentoReal}% OFF)`);
    }
    
    // PASO 2: DESTACADAS 15-49% (9 productos, solo Vie-S√°b 18-23hrs)
    products.forEach(p => {
        if (window.productosRelampagoIds.includes(p.id)) return;
        
        if (p.descuentoReal >= 15 && p.descuentoReal < 50 && p.stockNumber > 0) {
            window.productosDestacadosIds.push(p.id);
        }
    });
    
    // Limitar a 9 productos para destacadas (ordenados por mejor descuento)
    if (window.productosDestacadosIds.length > 9) {
        const destacadosOrdenados = products
            .filter(p => window.productosDestacadosIds.includes(p.id))
            .sort((a, b) => b.descuentoReal - a.descuentoReal)
            .slice(0, 9);
        window.productosDestacadosIds = destacadosOrdenados.map(p => p.id);
    }
    
    // PASO 3: ESPECIALES 1-14% (2 productos, rotan diariamente)
    const todosEspeciales = products
        .filter(p => p.descuentoReal >= 1 && p.descuentoReal < 15 && p.stockNumber > 0)
        .sort((a, b) => b.descuentoReal - a.descuentoReal);
    
    if (todosEspeciales.length > 0) {
        const hoy = new Date();
        const diaDelA√±o = Math.floor((hoy - new Date(hoy.getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
        const indiceBase = diaDelA√±o % todosEspeciales.length;
        
        window.productosEspecialesIds = [
            todosEspeciales[indiceBase],
            todosEspeciales[(indiceBase + 1) % todosEspeciales.length]
        ].filter(p => p !== undefined).map(p => p.id);
    }
    
    // PASO 4: RESERVA (sin descuento o 0%)
    products.forEach(p => {
        if (!window.productosRelampagoIds.includes(p.id) &&
            !window.productosDestacadosIds.includes(p.id) &&
            !window.productosEspecialesIds.includes(p.id) &&
            p.stockNumber > 0) {
            window.productosReservaIds.push(p.id);
        }
    });
    
    console.log('üìä CLASIFICACI√ìN FINAL:');
    console.log(`‚ö° REL√ÅMPAGO: ${window.productosRelampagoIds.length} producto (‚â•50% OFF)`);
    console.log(`üî• DESTACADAS: ${window.productosDestacadosIds.length} productos (15-49% OFF)`);
    console.log(`üéÅ ESPECIALES: ${window.productosEspecialesIds.length} productos (1-14% OFF)`);
    console.log(`üì¶ RESERVA: ${window.productosReservaIds.length} productos (sin descuento)`);
} 
        // ========== GENERAR OFERTAS ESPECIALES DESDE RESERVA ==========
        function generarEspecialesDesdeReserva(productosReserva = null) {
            console.log('üéÅ GENERANDO ESPECIALES DESDE RESERVA');
            
            // Si no se proporciona productosReserva, obtenerlos
            if (!productosReserva && window.productosReservaIds) {
                productosReserva = products.filter(p => 
                    window.productosReservaIds.includes(p.id)
                );
            }
            
            if (!productosReserva || productosReserva.length === 0) {
                console.warn('‚ùå No hay productos en reserva para generar especiales');
                window.productosEspecialesIds = [];
                return;
            }
            
            // Filtrar productos con descuento suave (1-14%)
            const reservaConDescuentoSuave = productosReserva.filter(p => {
                const descuento = p.descuentoReal || obtenerDescuentoRealProducto(p);
                return descuento >= 1 && descuento <= 14 && p.stockNumber > 0;
            });
            
            if (reservaConDescuentoSuave.length === 0) {
                console.warn('‚ùå No hay productos con descuento suave (1-14%)');
                window.productosEspecialesIds = [];
                return;
            }
            
            // Generar seed basada en la fecha
            const hoy = new Date().toISOString().slice(0, 10); // YYYY-MM-DD
            const seed = parseInt(hoy.replace(/-/g, '')) % 1000;
            
            // Seleccionar 2 productos de forma pseudo-aleatoria pero consistente por d√≠a
            const seleccionados = [];
            const maxSeleccion = Math.min(2, reservaConDescuentoSuave.length);
            
            // Usar el seed para seleccion consistente
            for (let i = 0; i < maxSeleccion; i++) {
                const index = (seed + i) % reservaConDescuentoSuave.length;
                const producto = reservaConDescuentoSuave[index];
                if (producto && !seleccionados.find(p => p.id === producto.id)) {
                    seleccionados.push(producto);
                }
            }
            
            window.productosEspecialesIds = seleccionados.map(p => p.id);
            console.log('‚úÖ ESPECIALES GENERADAS:', window.productosEspecialesIds, seleccionados.map(p => p.name));
            
            return seleccionados;
        }
        
function mostrarOfertasEspeciales() {
    console.log('üéÅ MOSTRANDO OFERTAS ESPECIALES (2 productos, rotan diariamente)');
    
    const grid = document.getElementById('especialesProductsGrid');
    const container = document.getElementById('especialesContainer');
    
    if (!grid || !container) return;
    
    // 1. Obtener productos especiales clasificados
    const productosEspeciales = products.filter(p => 
        window.productosEspecialesIds.includes(p.id) && p.stockNumber > 0
    );
    
    console.log(`üìä Especiales disponibles hoy: ${productosEspeciales.length}`);
    
    if (productosEspeciales.length === 0) {
        grid.innerHTML = `
            <div style="padding:2rem; text-align:center; color:#666; grid-column:1/-1">
                üéÅ No hay ofertas especiales disponibles hoy
            </div>
        `;
        return;
    }
    
    // 2. HEADER CLARO Y EXPLICATIVO
    const header = `
        <div style="text-align:center; margin-bottom:20px; grid-column:1/-1">
            <div style="display:inline-flex; align-items:center; gap:10px;
                background:linear-gradient(135deg, #388e3c, #2e7d32);
                color:white; padding:12px 24px; border-radius:25px;
                font-weight:bold; font-size:1.2rem; box-shadow:0 4px 12px rgba(56, 142, 60, 0.3);
                border:3px solid white;">
                üéÅ OFERTAS ESPECIALES DEL D√çA
                <span style="font-size:0.9rem; background:rgba(255,255,255,0.2); 
                      padding:2px 8px; border-radius:12px;">
                    ${productosEspeciales.length} producto${productosEspeciales.length !== 1 ? 's' : ''}
                </span>
            </div>
            <div style="margin-top:10px; color:#1b5e20; font-size:0.9rem; font-weight:500;">
                üíö Descuentos del 1% al 14% OFF ‚Ä¢ Cambian todos los d√≠as ‚Ä¢ Solo 2 oportunidades
            </div>
        </div>
    `;
    
    // 3. RENDERIZAR productos con BADGETS CLAROS
    grid.innerHTML = header + productosEspeciales.map(product => {
        const stockText = obtenerTextoStock(product);
        const stockClass = product.stockNumber === 0 ? 'out-of-stock' : 
                          product.stockNumber <= 3 ? 'low-stock' : 'in-stock';
        
        // TEXTO CLARO DE OFERTA
        let textoOferta = '';
        if (product.ofertas2 && product.ofertas2 !== '0') {
            textoOferta = `üî• ¬°${product.ofertas2}% DE DESCUENTO DIRECTO!`;
        } else if (product.ofertas1 && product.ofertas1 !== '0') {
            const oferta = OFERTAS_SISTEMA[product.ofertas1];
            if (oferta) {
                textoOferta = `üéØ ${oferta.eslogan}`;
            }
        }
        
        // BADGET DE COLOR VERDE (ESPECIAL)
        const offerBadge = `
            <div class="offer-badge" style="background:linear-gradient(135deg, #388e3c, #2e7d32);">
                üéÅ OFERTA ESPECIAL
            </div>
        `;
        
        // EXPLICACI√ìN CLARA DEL DESCUENTO
        const ahorro = product.price - product.discountedPrice;
        const explicacion = `
            <div style="background:#e8f5e9; padding:8px; border-radius:8px; margin:5px 0; border-left:3px solid #388e3c;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span style="font-weight:bold; color:#1b5e20;">üéÅ OFERTA ESPECIAL:</span>
                    <span style="background:#388e3c; color:white; padding:3px 8px; border-radius:12px; font-weight:bold;">
                        ${product.descuentoReal}% OFF
                    </span>
                </div>
                <div style="font-size:0.85rem; color:#2e7d32; margin-top:4px;">
                    Ahorr√°s $${Math.round(ahorro)} por unidad ‚Ä¢ Descuento suave
                </div>
            </div>
        `;
        
        return `
            <div class="product-card jerarquia-especiales">
                ${offerBadge}
                <div class="product-image">
                    <img src="${product.image}" 
                         alt="${product.name}"
                         onerror="handleImageError(this, '${product.name.replace(/'/g, "\\'")}')">
                </div>
                <div class="product-info">
                    <div class="product-name">${product.name}</div>
                    
                    ${textoOferta ? `
                        <div class="offer-description" style="color:#ff6f00; font-weight:bold; margin:5px 0;">
                            ${textoOferta}
                        </div>
                    ` : ''}
                    
                    ${explicacion}
                    
                    <div class="product-price-container">
                        <span class="original-price">$${product.price}</span>
                        <span class="product-price" style="color:#2e7d32;">$${Math.round(product.discountedPrice)}</span>
                        <span class="discount-percent" style="background:#c8e6c9; color:#1b5e20;">
                            ${product.descuentoReal}% OFF
                        </span>
                    </div>
                    
                    <div class="product-stock ${stockClass}">
                        ${stockText}
                    </div>
                    
                    <button class="add-to-cart" data-id="${product.id}">
                        üõí Agregar al Carrito
                    </button>
                    
                    <div style="font-size:0.75rem; color:#666; margin-top:8px; text-align:center;">
                        üíö Oferta especial del d√≠a ‚Ä¢ Cambia ma√±ana
                    </div>
                </div>
            </div>
        `;
    }).join('');
    
    console.log(`‚úÖ ESPECIALES RENDERIZADOS: ${productosEspeciales.length}`);
}

// ========== LIMPIAR C√ìDIGO VIEJO ==========
function limpiarCodigoViejo() {
    console.log('üßπ LIMPIANDO C√ìDIGO Y ELEMENTOS VIEJOS...');
    
    // 1. Eliminar secciones duplicadas (por clase violeta)
    const seccionesVioletas = document.querySelectorAll('[style*="#9c27b0"], [style*="violet"], [style*="purple"]');
    seccionesVioletas.forEach(seccion => {
        if (seccion.id && seccion.id.includes('especial')) {
            console.log('üóëÔ∏è Eliminando secci√≥n violeta vieja:', seccion.id);
            seccion.remove();
        }
    });
    
    // 2. Eliminar estilos CSS violetas viejos
    const estilosVioletas = document.querySelectorAll('style');
    estilosVioletas.forEach(styleTag => {
        if (styleTag.textContent.includes('#9c27b0') && 
            styleTag.textContent.includes('especiales-container')) {
            console.log('üé® Eliminando estilos CSS violetas viejos');
            styleTag.remove();
        }
    });
    
    // 3. Forzar solo UNA secci√≥n de especiales
    const todasSeccionesEspeciales = document.querySelectorAll('[id*="especial"]');
    if (todasSeccionesEspeciales.length > 1) {
        // Mantener solo la primera (verde)
        for (let i = 1; i < todasSeccionesEspeciales.length; i++) {
            todasSeccionesEspeciales[i].remove();
        }
    }
}
        
        // ========== CONTROL AUTOM√ÅTICO DE HORARIOS ACTUALIZADO ==========
        function controlarVisibilidadPorHorario() {
            const ahora = new Date();
            const hora = ahora.getHours();
            const minutos = ahora.getMinutes();
            const diaSemana = ahora.getDay();
            const horaDecimal = hora + (minutos / 100);
            
            // REL√ÅMPAGO: Dom-Jue | 11:30-17:00
            const enDiaRelampago = JERARQUIA_OFERTAS.relampago.dias.includes(diaSemana);
            const enHorarioRelampago = enDiaRelampago && 
                                       (hora > 11 || (hora === 11 && minutos >= 30)) && 
                                       (hora < 17 || (hora === 17 && minutos === 0));
            const relampagoContainer = document.getElementById('flashSalesContainer');
            
            // DESTACADAS: Viernes y S√°bado | 18:00-23:00
            const enDiaDestacadas = JERARQUIA_OFERTAS.destacadas.dias.includes(diaSemana);
            const enHorarioDestacadas = enDiaDestacadas && 
                                        (hora >= 18) && (hora < 23);
            const destacadasSection = document.getElementById('featuredOffers');
            
            // ESPECIALES: SIEMPRE VISIBLES 24/7
            const especialesContainer = document.getElementById('especialesContainer');
            
            // Control rel√°mpago
            if (relampagoContainer) {
                const adminForzado = esAdmin && window.ADMIN_TOOLS?.forcedSections?.relampago;
                
                if (enHorarioRelampago || adminForzado) {
                    relampagoContainer.style.display = 'block';
                    console.log('‚ö° OFERTAS REL√ÅMPAGO: ACTIVAS');
                    
                    if (typeof FLASH_SALES_SYSTEM !== 'undefined' && FLASH_SALES_SYSTEM.isActive !== undefined) {
                        FLASH_SALES_SYSTEM.isActive = true;
                        FLASH_SALES_SYSTEM.updateUI();
                    }
                } else {
                    relampagoContainer.style.display = 'none';
                    console.log('‚ö° OFERTAS REL√ÅMPAGO: OCULTAS');
                }
            }
            
            // Control destacadas
            if (destacadasSection) {
                const adminForzadoDestacadas = esAdmin && window.ADMIN_TOOLS?.forcedSections?.destacadas;
                
                if (enHorarioDestacadas || adminForzadoDestacadas) {
                    destacadasSection.style.display = 'block';
                    mostrarOfertasDestacadas();
                    
                    if (adminForzadoDestacadas && !enHorarioDestacadas) {
                        console.log('üõ†Ô∏è DESTACADAS FORZADAS POR ADMIN');
                    }
                } else {
                    destacadasSection.style.display = 'none';
                    console.log('üî• OFERTAS DESTACADAS: OCULTAS');
                }
            }
            
            // Control especiales - SIEMPRE VISIBLES 24/7
            if (especialesContainer) {
                // Siempre mostrar especiales - 24/7
                especialesContainer.style.display = 'block';
                mostrarOfertasEspeciales();
                console.log('üéÅ OFERTAS ESPECIALES: ACTIVAS (24/7)');
            }
            
            // DEBUG ADMIN
            if (esAdmin && modoDebug) {
                console.log('üïí CONTROL HORARIO ADMIN', {
                    hora: `${hora}:${minutos.toString().padStart(2, '0')}`,
                    dia: ['Dom','Lun','Mar','Mi√©','Jue','Vie','S√°b'][diaSemana],
                    relampago: enHorarioRelampago,
                    destacadas: enHorarioDestacadas,
                    especiales: 'SIEMPRE VISIBLES 24/7',
                    forced: window.ADMIN_TOOLS?.forcedSections
                });
            }
            
            // Rechequeo cada minuto
            setTimeout(controlarVisibilidadPorHorario, 60000);
        }
        
        // ========== SISTEMA OFERTAS REL√ÅMPAGO ==========
        const FLASH_SALES_SYSTEM = {
            ENABLED: true,
            ACTIVE_HOURS: JERARQUIA_OFERTAS.relampago.horario,
            ACTIVE_DAYS: [0, 1, 2, 3, 4], // Domingo a Jueves
            POOL_SIZE: 15,
            DAILY_SELECTION: 3,
            
            isActive: false,
            todaySelection: [],
            yesterdaySelection: [],
            productPool: [],
            
            init: function() {
                console.log('‚ö° Inicializando sistema de ofertas rel√°mpago...');
                this.checkTimeAndDay();
                this.loadHistory();
                this.loadProductPool();
                this.generateDailySelection();
                this.updateUI();
                this.startCountdown();
                console.log('‚úÖ Sistema rel√°mpago listo. Activo:', this.isActive);
            },
            
            checkTimeAndDay: function() {
                const now = new Date();
                const currentDay = now.getDay();
                const currentHour = now.getHours();
                const currentMinutes = now.getMinutes();
                
                const isActiveDay = this.ACTIVE_DAYS.includes(currentDay);
                
                let isActiveHour = false;
                
                if (currentHour > this.ACTIVE_HOURS.start && 
                    currentHour < this.ACTIVE_HOURS.end) {
                    isActiveHour = true;
                } else if (currentHour === this.ACTIVE_HOURS.start) {
                    isActiveHour = currentMinutes >= this.ACTIVE_HOURS.startMinutes;
                } else if (currentHour === this.ACTIVE_HOURS.end) {
                    isActiveHour = currentMinutes < this.ACTIVE_HOURS.endMinutes;
                }
                
                this.isActive = isActiveDay && isActiveHour && this.ENABLED;
                
                return this.isActive;
            },
            
            loadHistory: function() {
                try {
                    const today = this.getTodayKey();
                    const yesterday = this.getYesterdayKey();
                    
                    const todayData = localStorage.getItem(`flash_sales_${today}`);
                    if (todayData) {
                        this.todaySelection = JSON.parse(todayData);
                    }
                    
                    const yesterdayData = localStorage.getItem(`flash_sales_${yesterday}`);
                    if (yesterdayData) {
                        this.yesterdaySelection = JSON.parse(yesterdayData);
                    }
                } catch (error) {
                    console.error('‚ùå Error cargando historial:', error);
                    this.clearHistory();
                }
            },
            
            saveTodaySelection: function() {
                try {
                    const today = this.getTodayKey();
                    localStorage.setItem(`flash_sales_${today}`, JSON.stringify(this.todaySelection));
                    this.updateHistory();
                } catch (error) {
                    console.error('‚ùå Error guardando selecci√≥n:', error);
                }
            },
            
            updateHistory: function() {
                try {
                    const today = this.getTodayKey();
                    let history = {};
                    
                    const historyData = localStorage.getItem('flash_sales_history');
                    if (historyData) {
                        history = JSON.parse(historyData);
                    }
                    
                    history[today] = {
                        date: new Date().toISOString(),
                        products: this.todaySelection.map(p => p.descripcion),
                        count: this.todaySelection.length
                    };
                    
                    const keys = Object.keys(history);
                    if (keys.length > 30) {
                        const oldestKey = keys.sort()[0];
                        delete history[oldestKey];
                    }
                    
                    localStorage.setItem('flash_sales_history', JSON.stringify(history));
                } catch (error) {
                    console.error('‚ùå Error actualizando historial:', error);
                }
            },
            
            clearHistory: function() {
                const keysToRemove = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key.startsWith('flash_sales_')) {
                        keysToRemove.push(key);
                    }
                }
                
                keysToRemove.forEach(key => localStorage.removeItem(key));
            },
            
            loadProductPool: function() {
                if (!window.products || window.products.length === 0) {
                    this.productPool = [];
                    return;
                }
                
                const candidates = window.products.filter(product => {
                    const descuentoReal = obtenerDescuentoRealProducto(product);
                    const calificaRelampago = descuentoReal >= JERARQUIA_OFERTAS.relampago.descuentoMinimo;
                    
                    const tieneStock = product.stockNumber > 0;
                    const tieneDescripcion = product.descripcion || product.id;
                    
                    return calificaRelampago && tieneStock && tieneDescripcion;
                });
                
                candidates.sort((a, b) => {
                    const descA = obtenerDescuentoRealProducto(a);
                    const descB = obtenerDescuentoRealProducto(b);
                    return descB - descA;
                });
                
                this.productPool = candidates.slice(0, this.POOL_SIZE);
            },
            
            generateDailySelection: function() {
                if (this.todaySelection.length > 0) {
                    return;
                }
                
                if (this.productPool.length === 0) {
                    this.todaySelection = [];
                    return;
                }
                
                let availablePool = [...this.productPool];
                const yesterdayIds = this.yesterdaySelection.map(p => p.descripcion || p.id);
                availablePool = availablePool.filter(p => 
                    !yesterdayIds.includes(p.descripcion || p.id)
                );
                
                if (availablePool.length < this.DAILY_SELECTION) {
                    availablePool = [...this.productPool];
                }
                
                const selected = [];
                const maxAttempts = 50;
                let attempts = 0;
                
                while (selected.length < this.DAILY_SELECTION && 
                       availablePool.length > 0 && 
                       attempts < maxAttempts) {
                    
                    const randomIndex = Math.floor(Math.random() * availablePool.length);
                    const product = availablePool[randomIndex];
                    
                    const alreadySelected = selected.some(p => 
                        (p.descripcion || p.id) === (product.descripcion || product.id)
                    );
                    
                    if (!alreadySelected) {
                        const flashProduct = {
                            ...product,
                            flashPrice: calcularPrecioOfertaRelampago(product), // üéØ USAR FUNCI√ìN REPARADA
                            flashDiscount: obtenerDescuentoRealProducto(product),
                            flashOriginalPrice: product.price,
                            flashId: product.descripcion || product.id
                        };
                        
                        selected.push(flashProduct);
                        availablePool.splice(randomIndex, 1);
                    }
                    
                    attempts++;
                }
                
                this.todaySelection = selected;
                this.saveTodaySelection();
            },
            
            renderFlashProducts: function() {
                const container = document.getElementById('flashProductsGrid');
                if (!container) return;
                
                if (this.todaySelection.length === 0) {
                    container.innerHTML = `
                        <div style="grid-column: 1 / -1; text-align: center; padding: 2rem; color: #666;">
                            ‚è≥ No hay ofertas rel√°mpago disponibles por el momento.
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = this.todaySelection.map(product => {
                    const descuentoReal = obtenerDescuentoRealProducto(product);
                    const descripcionOferta = obtenerDescripcionOferta(
                        '', 
                        product.ofertas2,
                        product.price
                    );
                    
                    const textoLimiteOfertas2 = obtenerTextoLimiteOfertas2(product.ofertas2, product.name);
                    const stockText = obtenerTextoStock(product);
                    
                    return `
                        <div class="flash-product-card jerarquia-relampago">
                            <div class="flash-exclusive-badge">‚ö° EXCLUSIVO</div>
                            
                            <div class="product-image" style="height: 180px;">
                                <img src="${product.image}" 
                                     alt="${product.name}"
                                     onerror="handleImageError(this, '${product.name.replace(/'/g, "\\'")}')">
                            </div>
                            
                            <div class="product-info" style="padding: 1.2rem;">
                                <div class="product-name" style="font-size: 1rem; font-weight: bold; color: #d50000;">
                                    ${product.name}
                                </div>
                                
                                <div class="offer-description" style="color: #ff6f00; font-weight: bold; margin: 8px 0;">
                                    ${descripcionOferta}
                                </div>
                                
                                <div style="background: #ffebee; padding: 8px; border-radius: 8px; margin: 8px 0; border-left: 3px solid #ff3d00;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <strong style="color: #d50000;">‚ö° NIVEL REL√ÅMPAGO</strong>
                                        <span style="background: #d50000; color: white; padding: 3px 8px; border-radius: 12px; font-weight: bold;">
                                            ${descuentoReal}% OFF
                                        </span>
                                    </div>
                                    <div style="font-size: 0.8rem; color: #666; margin-top: 4px;">
                                        Descuento ‚â•33% - Solo hoy hasta las 17:00
                                    </div>
                                </div>
                                
                                <div class="product-price-container" style="margin: 10px 0;">
                                    <span class="original-price" style="font-size: 1rem;">$${product.flashOriginalPrice}</span>
                                    <span class="flash-price">$${Math.round(product.flashPrice)}</span>
                                    <span class="flash-discount">${descuentoReal}% OFF</span>
                                </div>
                                
                                ${textoLimiteOfertas2 ? `
                                    <div class="promo-limit" style="color: #ff3d00; font-weight: bold; margin: 5px 0;">
                                        ‚ö†Ô∏è ${textoLimiteOfertas2}
                                    </div>
                                ` : ''}
                                
                                <div class="product-stock in-stock" style="margin: 8px 0;">
                                    ${stockText}
                                </div>
                                
                                <button class="add-to-cart" 
                                        data-id="${product.id}"
                                        style="background: linear-gradient(135deg, #ff3d00, #d50000);">
                                    üõí Agregar al Carrito
                                </button>
                                
                                <div style="font-size: 0.75rem; color: #666; margin-top: 8px; text-align: center;">
                                    ‚ö° Oferta v√°lida solo hoy hasta las 17:00
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            },
            
            updateUI: function() {
                const container = document.getElementById('flashSalesContainer');
                const timer = document.getElementById('flashTimer');
                const overlay = document.getElementById('flashCountdownOverlay');
                
                if (!container || !timer || !overlay) return;
                
                const adminForzado = esAdmin && window.ADMIN_TOOLS?.forcedSections?.relampago;
                
                if (this.isActive || adminForzado) {
                    container.style.display = 'block';
                    timer.style.display = 'inline-flex';
                    overlay.style.display = 'none';
                    this.renderFlashProducts();
                    
                    if (adminForzado && !this.isActive) {
                        const adminWarning = document.createElement('div');
                        adminWarning.style.cssText = `
                            background: #ff9800;
                            color: white;
                            padding: 8px;
                            text-align: center;
                            font-size: 0.8rem;
                            font-weight: bold;
                            border-bottom: 2px dashed white;
                        `;
                        adminWarning.innerHTML = 'üõ†Ô∏è MODO TEST: Ofertas rel√°mpago forzadas (fuera de horario)';
                        
                        const header = container.querySelector('.flash-sales-header');
                        if (header && !container.querySelector('.admin-warning')) {
                            header.parentNode.insertBefore(adminWarning, header.nextSibling);
                            adminWarning.className = 'admin-warning';
                        }
                    }
                } else {
                    container.style.display = 'none';
                }
            },
            
            startCountdown: function() {
                if (!this.isActive) {
                    this.startTomorrowCountdown();
                    return;
                }
                
                const countdownElement = document.getElementById('countdown');
                if (!countdownElement) return;
                
                const updateCountdown = () => {
                    const now = new Date();
                    const endTime = new Date();
                    
                    endTime.setHours(this.ACTIVE_HOURS.end, this.ACTIVE_HOURS.endMinutes, 0, 0);
                    
                    if (now >= endTime) {
                        this.isActive = false;
                        this.updateUI();
                        return;
                    }
                    
                    const diff = endTime - now;
                    const hours = Math.floor(diff / (1000 * 60 * 60));
                    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                    
                    const hoursStr = isNaN(hours) ? "00" : hours.toString().padStart(2, '0');
                    const minutesStr = isNaN(minutes) ? "00" : minutes.toString().padStart(2, '0');
                    const secondsStr = isNaN(seconds) ? "00" : seconds.toString().padStart(2, '0');
                    
                    countdownElement.textContent = `${hoursStr}:${minutesStr}:${secondsStr}`;
                    
                    if (hours === 0 && minutes < 30) {
                        countdownElement.style.color = '#ff3d00';
                        countdownElement.style.fontWeight = 'bold';
                    }
                    
                    requestAnimationFrame(updateCountdown);
                };
                
                updateCountdown();
            },
            
            startTomorrowCountdown: function() {
                const nextCountdownElement = document.getElementById('nextFlashCountdown');
                if (!nextCountdownElement) return;
                
                const updateNextCountdown = () => {
                    const now = new Date();
                    let nextFlashTime = new Date();
                    
                    const currentDay = now.getDay();
                    const currentHour = now.getHours();
                    
                    if (this.ACTIVE_DAYS.includes(currentDay) && 
                        currentHour >= this.ACTIVE_HOURS.end) {
                        nextFlashTime.setDate(now.getDate() + 1);
                    }
                    
                    while (!this.ACTIVE_DAYS.includes(nextFlashTime.getDay())) {
                        nextFlashTime.setDate(nextFlashTime.getDate() + 1);
                    }
                    
                    nextFlashTime.setHours(this.ACTIVE_HOURS.start, 
                                         this.ACTIVE_HOURS.startMinutes, 0, 0);
                    
                    const diff = nextFlashTime - now;
                    
                    if (diff <= 0) {
                        requestAnimationFrame(updateNextCountdown);
                        return;
                    }
                    
                    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                    
                    let countdownText = '';
                    if (days > 0) {
                        countdownText += `${days}d `;
                    }
                    countdownText += 
                        `${hours.toString().padStart(2, '0')}:` +
                        `${minutes.toString().padStart(2, '0')}:` +
                        `${seconds.toString().padStart(2, '0')}`;
                    
                    nextCountdownElement.textContent = countdownText;
                    
                    requestAnimationFrame(updateNextCountdown);
                };
                
                updateNextCountdown();
            },
            
            renderTomorrowCountdown: function() {
                const element = document.getElementById('nextFlashCountdown');
                if (!element) return;
                
                this.startTomorrowCountdown();
            },
            
            getTodayKey: function() {
                const today = new Date();
                return `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}-${today.getDate().toString().padStart(2, '0')}`;
            },
            
            getYesterdayKey: function() {
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                return `${yesterday.getFullYear()}-${(yesterday.getMonth() + 1).toString().padStart(2, '0')}-${yesterday.getDate().toString().padStart(2, '0')}`;
            }
        };
        
        // ========== ELEMENTOS DOM ==========
        const categoriesContainer = document.getElementById("categories");
        const productsGrid = document.getElementById("productsGrid");
        const featuredOffers = document.getElementById("featuredOffers");
        const featuredProductsGrid = document.getElementById("featuredProductsGrid");
        const viewAllOffers = document.getElementById("viewAllOffers");
        const cartIcon = document.getElementById("cartIcon");
        const floatingCart = document.getElementById("floatingCart");
        const floatingSearch = document.getElementById("floatingSearch");
        const floatingHome = document.getElementById("floatingHome");
        const adminFloatingButton = document.getElementById("adminFloatingButton");
        const adminPanel = document.getElementById("adminPanel");
        const adminPanelClose = document.getElementById("adminPanelClose");
        const searchModal = document.getElementById("searchModal");
        const closeSearch = document.getElementById("closeSearch");
        const mobileSearch = document.getElementById("mobileSearch");
        const mobileSearchResults = document.getElementById("mobileSearchResults");
        const cartModal = document.getElementById("cartModal");
        const closeCart = document.getElementById("closeCart");
        const cartItems = document.getElementById("cartItems");
        const cartTotal = document.getElementById("cartTotal");
        const cartCount = document.getElementById("cartCount");
        const floatingCartCount = document.getElementById("floatingCartCount");
        const sendOrder = document.getElementById("sendOrder");
        const adminBadge = document.getElementById("adminBadge");
        const adminNotification = document.getElementById("adminNotification");
        const productSearch = document.getElementById("productSearch");
        const clearSearchBtn = document.getElementById("clearSearchBtn");
        const clearMobileSearchBtn = document.getElementById("clearMobileSearchBtn");
        const searchSuggestions = document.getElementById("searchSuggestions");
        
        // ========== FUNCIONES PRINCIPALES ==========
        window.handleMobileSearchEnter = function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const searchTerm = mobileSearch.value.trim();
                if (searchTerm.length >= 2) {
                    filterMobileProducts(searchTerm);
                    mobileSearch.blur();
                }
            }
        };
        
        function sendOrderViaWhatsApp() {
            if (cart.length === 0) {
                showNotification("Tu carrito est√° vac√≠o.", "error");
                return;
            }
            
            const phoneNumber = "5492944907380";
            
            let totalOriginal = 0;
            let totalWithPromos = 0;
            let totalSavings = 0;
            let orderLines = [];
            let ofertasCount = 0;

            cart.forEach(item => {
                const product = products.find(p => p.id === item.id);
                if (!product) return;
                
                const precioConDescuentoUnitario = calcularPrecioConDescuento(
                    product.price, 
                    product.ofertas1, 
                    product.ofertas2, 
                    item.quantity
                );
                
                const precioNormalTotal = product.price * item.quantity;
                const precioDescuentoTotal = precioConDescuentoUnitario * item.quantity;
                
                totalOriginal += precioNormalTotal;
                totalWithPromos += precioDescuentoTotal;
                totalSavings += precioNormalTotal - precioDescuentoTotal;
                
                if (precioConDescuentoUnitario < product.price) {
                    ofertasCount++;
                }
                
                let nombreUpper = product.name.toUpperCase();
                let icono = precioConDescuentoUnitario < product.price ? 'üî•' : '‚úÖ';
                
                let tipoOferta = '';
                if (product.ofertas2 && product.ofertas2 !== '0') {
                    const descuento = parseInt(product.ofertas2);
                    if (descuento >= 50) tipoOferta = ` (¬°OFERT√ìN ${descuento}% OFF!)`;
                    else if (descuento >= 30) tipoOferta = ` (¬°OFERTA ${descuento}% OFF!)`;
                    else tipoOferta = ` (${descuento}% OFF)`;
                } else if (product.ofertas1 && product.ofertas1 !== '0') {
                    const oferta = OFERTAS_SISTEMA[product.ofertas1];
                    if (oferta) tipoOferta = ` (${oferta.nombre})`;
                }
                
                const precioUnitarioRedondeado = Math.round(precioConDescuentoUnitario);
                const precioTotalRedondeado = Math.round(precioDescuentoTotal);
                
                let descripcion = `${icono} *${nombreUpper}*${tipoOferta}\n`;
                descripcion += `   ${item.quantity} √ó $${precioUnitarioRedondeado} = $${precioTotalRedondeado}`;
                
                if (product.ofertas1 === '1' && item.quantity >= 3) {
                    const grupos3x2 = Math.floor(item.quantity / 3);
                    const sobrantes = item.quantity % 3;
                    
                    if (grupos3x2 > 0) {
                        descripcion += `\n   üì¶ ¬°${grupos3x2} promo(s) 3x2 incluida(s)!`;
                    }
                }
                
                orderLines.push(descripcion);
            });

            const ahorroTotal = Math.round(totalSavings);
            const totalAPagar = Math.round(totalWithPromos);
            const porcentajeTotal = totalOriginal > 0 ? 
                Math.round((ahorroTotal / totalOriginal) * 100) : 0;
            
            const ahora = new Date();
            const mes = ahora.getMonth();
            const dia = ahora.getDate();
            const diaSemana = ahora.getDay();
            const currentYear = new Date().getFullYear();
            
            let saludoEspecial = "";
            let calendarioMensaje = "";
            
            if (mes === 0) {
                saludoEspecial = "üéâ *¬°FELIZ A√ëO NUEVO!* üéâ\nComienza el a√±o con las mejores ofertas\n";
                calendarioMensaje = "üìÖ *Calendario Anual*\nEnero: ¬°A√±o nuevo, ofertas nuevas!\nFebrero: Descuentos de verano\nMarzo: Vuelta al cole con precios especiales\nAbril: Semana Santa con promociones\nMayo: D√≠a de la madre\nJunio: Invierno con calor de hogar\nJulio: Vacaciones de invierno\nAgosto: D√≠a del ni√±o\nSeptiembre: Primavera florida\nOctubre: D√≠a de la madre (Arg)\nNoviembre: Preparando Navidad\nDiciembre: ¬°La mejor Navidad!\n\n";
            } else if (mes === 11) {
                saludoEspecial = "üéÑ *¬°FELIZ NAVIDAD!* üéÖ\nQue la luz de la Navidad ilumine tu hogar\n";
                calendarioMensaje = "üìÖ *Calendario Navide√±o*\n‚Ä¢ Diciembre 24: Nochebuena\n‚Ä¢ Diciembre 25: Navidad\n‚Ä¢ Diciembre 31: A√±o Nuevo\n\nüåü *Promesa para el 2025:*\nSeguiremos siendo tu almac√©n de confianza\n\n";
            } else if (mes === 9) {
                saludoEspecial = "üå∏ *¬°FELIZ D√çA DE LA MADRE!* üíê\nPara la reina del hogar, los mejores precios\n";
            } else if (mes === 7) {
                saludoEspecial = "üéà *¬°FELIZ D√çA DEL NI√ëO!* üéÅ\nPara los m√°s chicos, las mejores golosinas\n";
            } else if (mes === 4) {
                saludoEspecial = "üíê *¬°FELIZ D√çA DE LA MADRE!* üåπ\nCelebremos a las mam√°s con amor\n";
            } else if (mes === 2) {
                saludoEspecial = "üìö *¬°VUELTA AL COLE!* ‚úèÔ∏è\nTodo lo que necesitan para estudiar\n";
            }
            
            if (diaSemana === 0 || diaSemana === 6) {
                saludoEspecial += "üèñÔ∏è *¬°FELIZ FIN DE SEMANA!*\nDisfruta con los mejores productos\n\n";
            }
            
            let message = `*üõí PEDIDO ALMAC√âN COPIHUE*\n`;
            message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
            
            if (saludoEspecial) {
                message += saludoEspecial;
                message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
            }
            
            message += `üì¶ *TU COMPRA:*\n\n`;
            
            orderLines.forEach(line => {
                message += line + '\n\n';
            });
            
            message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
            
            if (ofertasCount > 0) {
                message += `üéä *¬°APROVECHASTE ${ofertasCount} OFERTA(S)!*\n`;
            }
            
            message += `üõçÔ∏è  *Productos:* ${cart.length} items\n`;
            message += `üìä *Unidades:* ${cart.reduce((sum, item) => sum + item.quantity, 0)}\n\n`;
            
            if (ahorroTotal > 0) {
                message += `üí∞ *Precio normal:* $${Math.round(totalOriginal)}\n`;
                message += `‚ö° *¬°AHORRASTE $${ahorroTotal}!*\n`;
                message += `üéØ *Descuento total: ${porcentajeTotal}%*\n\n`;
                
                if (porcentajeTotal >= 30) {
                    message += `üèÜ *¬°Compra inteligente!*\n\n`;
                }
            }
            
            message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
            message += `üíµ *TOTAL A PAGAR:* $${totalAPagar}\n`;
            message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
            
            if (calendarioMensaje) {
                message += calendarioMensaje;
                message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
            }
            
            message += `üöÄ *¬°TU PEDIDO EST√Å LISTO PARA RETIRAR!*\n\n`;
            
            message += `‚úÖ *Retiro r√°pido en 15-20 minutos*\n`;
            message += `‚úÖ *Productos frescos y de calidad*\n`;
            message += `‚úÖ *Atenci√≥n personalizada*\n`;
            message += `‚úÖ *Precios de barrio*\n\n`;
            
            message += `üìç *Direcci√≥n:* Copihue 457\n`;
            message += `‚è∞ *Horario:* 11:30 a 23:30 hs\n`;
            message += `üì± *Confirm√° por este WhatsApp*\n\n`;
            
            if (ahorroTotal > 0) {
                message += `üí° *¬øSab√≠as que ahorraste $${ahorroTotal}?*\n`;
                message += `üéâ *¬°Ese ahorro ya es ganancia para vos!*\n\n`;
            }
            
            if (mes === 11) {
                message += `üéÖ *¬°Que tengas una Feliz Navidad y Pr√≥spero A√±o Nuevo!*\n`;
                message += `üåü *De todo el equipo de Almac√©n Copihue*\n\n`;
            } else if (mes === 0) {
                message += `‚ú® *¬°Te deseamos un a√±o ${currentYear} lleno de prosperidad!*\n`;
                message += `üéØ *Siempre a tu servicio en Almac√©n Copihue*\n\n`;
            } else {
                message += `‚è≥ *Pedido listo en 15-20 minutos*\n`;
                message += `üéÅ *Gracias por elegir tu almac√©n de confianza*\n\n`;
            }
            
            message += `#Almac√©nCopihue #PreciosDeBarrio #LaConfianzaDeSiempre`;
            
            const encodedMessage = encodeURIComponent(message);
            const whatsappURL = `https://wa.me/${phoneNumber}?text=${encodedMessage}`;
            
            showNotification("üì± Abriendo WhatsApp...", "info");
            
            cart = [];
            updateCartCount();
            closeCartModal();
            
            window.open(whatsappURL, "_blank");
        }
        
        // ========== EVENT LISTENERS ==========
        cartIcon.addEventListener("click", openCart);
        floatingCart.addEventListener("click", openCart);
        closeCart.addEventListener("click", closeCartModal);
        floatingSearch.addEventListener("click", openSearchModal);
        closeSearch.addEventListener("click", closeSearchModal);
        floatingHome.addEventListener("click", () => { 
            currentCategory = "TODOS"; 
            renderCategories(); 
            renderProducts(); 
            showHomeFeedback(); 
        });
        clearSearchBtn.addEventListener("click", clearSearch);
        clearMobileSearchBtn.addEventListener("click", clearMobileSearch);
        viewAllOffers.addEventListener("click", verTodasLasOfertas);
        
        // ========== B√öSQUEDA ==========
        const SEARCH_DICTIONARY = {
            'tomate': ['tomates'],
            'durazno': ['duraznos'],
            'manzana': ['manzanas'],
            'naranja': ['naranjas'],
            'limon': ['limones'],
            'cebolla': ['cebollas'],
            'papa': ['papas'],
            'zanahoria': ['zanahorias'],
            'lechuga': ['lechugas'],
            'kg': ['kilo', 'kilos'],
            'gr': ['gramo', 'gramos'],
            'unid': ['unidad', 'unidades'],
            'alfajor': ['alfajores'],
            'alfajores': ['alfajor'],
            'galletita': ['galletitas', 'galletas'],
            'galleta': ['galletas', 'galletita'],
            'chocolate': ['chocolates'],
            'chocolates': ['chocolate']
        };
        
        function normalizeSearchTerm(term) {
            let normalized = term.toLowerCase().trim();
            normalized = normalized.replace(/[^\w\s]/g, ' ');
            normalized = normalized.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            normalized = normalized.replace(/\s+/g, ' ');
            return normalized;
        }
        
        function expandSearchTerms(searchTerm) {
            const normalizedTerm = normalizeSearchTerm(searchTerm);
            const words = normalizedTerm.split(' ');
            const expandedTerms = new Set();
            
            expandedTerms.add(normalizedTerm);
            
            words.forEach(word => {
                if (word.length < 2) return;
                
                expandedTerms.add(word);
                
                for (const [key, synonyms] of Object.entries(SEARCH_DICTIONARY)) {
                    if (key === word) {
                        synonyms.forEach(synonym => expandedTerms.add(synonym));
                    }
                    
                    if (synonyms.includes(word)) {
                        expandedTerms.add(key);
                        synonyms.forEach(synonym => expandedTerms.add(synonym));
                    }
                }
            });
            
            if (words.length > 1) {
                expandedTerms.add(words.join(''));
                expandedTerms.add(words.join('-'));
                
                if (words.length === 2) {
                    expandedTerms.add(`${words[1]} ${words[0]}`);
                }
            }
            
            return Array.from(expandedTerms);
        }
        
        function searchProducts(searchTerm) {
            if (!products || products.length === 0) return [];
            if (searchTerm.length < 2) return [];
            
            const expandedTerms = expandSearchTerms(searchTerm);
            
            const results = products.filter(product => {
                const productName = normalizeSearchTerm(product.name);
                const hasStock = product.stock === "STOCK" || product.stockNumber > 0;
                
                if (!hasStock && !ADMIN_TOOLS.showHidden) return false;
                
                return expandedTerms.some(term => {
                    if (productName.includes(term) && term.length > 1) return true;
                    
                    if (term.length <= 3 && term.length > 1) {
                        const initials = productName.split(' ')
                            .map(word => word.charAt(0))
                            .join('');
                        if (initials.includes(term)) return true;
                    }
                    
                    if (term.length > 3) {
                        if (productName.includes(term.substring(0, Math.max(3, term.length - 1)))) {
                            return true;
                        }
                    }
                    
                    return false;
                });
            });
            
            results.sort((a, b) => {
                const nameA = normalizeSearchTerm(a.name);
                const nameB = normalizeSearchTerm(b.name);
                
                const exactMatchA = expandedTerms.some(term => nameA === term);
                const exactMatchB = expandedTerms.some(term => nameB === term);
                
                if (exactMatchA && !exactMatchB) return -1;
                if (!exactMatchA && exactMatchB) return 1;
                
                if (a.stockNumber !== b.stockNumber) {
                    return b.stockNumber - a.stockNumber;
                }
                
                if (a.hasPromo !== b.hasPromo) {
                    return b.hasPromo - a.hasPromo;
                }
                
                return 0;
            });
            
            return results;
        }
        
        // ========== CARGAR PRODUCTOS ==========
        async function loadProductsFromAPI() {
            if (window.appInitialized) {
                console.log('‚ö†Ô∏è Ya cargu√© antes');
                return;
            }
            
            window.appInitialized = true;
            
            try {
                console.log('üöÄ Cargando productos...');
                
                if (productsGrid) {
                    productsGrid.innerHTML = '<div class="loading">üîÑ Contactando base de datos...</div>';
                }
                
                const TU_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxhKFk2WAi-KRY5xGBsI6_6Pvp3jDjt8mSRXvy7I1WehNmBpJamqK9G9Q1ZJSCSgAdfDA/exec';
                const urlConCache = TU_APPS_SCRIPT_URL + '?cache=' + Date.now();
                
                const respuesta = await fetch(urlConCache, {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                });
                
                if (!respuesta.ok) throw new Error(`Error ${respuesta.status}`);
                
                const datos = await respuesta.json();
                
                if (datos.productos && Array.isArray(datos.productos)) {
                    processAPIData(datos);
                } else if (Array.isArray(datos)) {
                    processAPIData({ productos: datos });
                } else if (datos.values && Array.isArray(datos.values)) {
                    const productosConvertidos = datos.values.slice(1).map((fila, index) => ({
                        id: index + 1,
                        name: fila[0] || '',
                        price: parseInt(fila[1]) || 0,
                        category: fila[2] || 'ALMACEN',
                        stock: parseInt(fila[3]) || 0,
                        oferta1: fila[4] || '',
                        oferta2: fila[5] || '',
                        descripcion: fila[6] || `producto_${index + 1}`
                    }));
                    processAPIData({ productos: productosConvertidos });
                } else {
                    mostrarErrorFormato(datos);
                }
                
            } catch (error) {
                console.error('üí• ERROR:', error);
                mostrarErrorAmigable(error);
            }
        }
        function processAPIData(apiData) {
            console.log('üì¶ Datos recibidos:', apiData);
            
            const productosArray = apiData.productos || apiData;
            console.log('üîÑ Procesando', productosArray.length, 'productos desde API');
            
            products = [];
            window.products = products;
            
            productosArray.forEach((item, index) => {
                try {
                    const nombre = item.name || 'Producto sin nombre';
                    const precio = parseInt(item.price) || 0;
                    const descripcion = item.descripcion || item.name.replace(/\s+/g, '_').toLowerCase() || `producto_${index}`;
                    
                    let categoriaRaw = item.category;
                    let categoria = 'ALMACEN';
                    if (categoriaRaw) {
                        categoria = String(categoriaRaw).trim().toUpperCase();
                    }
                    
                    const stockValue = item.stock || 0;
                    const ofertas1 = item.oferta1 || '';
                    const ofertas2 = item.oferta2 || '';
                    
                    let stockNumber = parseInt(stockValue);
                    if (isNaN(stockNumber) || stockNumber < 0) stockNumber = 0;
                    let stockStatus = "STOCK";
                    if (stockNumber === 0) {
                        stockStatus = "SIN STOCK";
                    } else if (stockNumber > 0 && stockNumber <= 3) {
                        stockStatus = "STOCK BAJO";
                    }
                    
                    const tieneOferta1 = ofertas1 && ofertas1 !== '' && ofertas1 !== '0';
                    const tieneOferta2 = ofertas2 && ofertas2 !== '' && ofertas2 !== '0';
                    const tieneOferta = tieneOferta1 || tieneOferta2;
                    
                    const descuentoReal = obtenerDescuentoRealProducto({
                        ofertas1: ofertas1,
                        ofertas2: ofertas2
                    });
                    
                    let precioConDescuento = precio;
                    let textoCortoOferta = '';
                    
                    if (tieneOferta2) {
                        const porcentaje = parseInt(ofertas2);
                        if (porcentaje > 0 && porcentaje <= 100) {
                            precioConDescuento = calcularPrecioConDescuento(precio, '', ofertas2, 1);
                            textoCortoOferta = obtenerTextoCortoOferta('', ofertas2);
                        }
                    } 
                    else if (tieneOferta1) {
                        if (OFERTAS_SISTEMA[ofertas1]) {
                            const oferta = OFERTAS_SISTEMA[ofertas1];
                            precioConDescuento = calcularPrecioConDescuento(precio, ofertas1, '', 1);
                            textoCortoOferta = obtenerTextoCortoOferta(ofertas1, '');
                        }
                    }
                    
                    precioConDescuento = redondearPrecioAlmacenCopihue(precioConDescuento);
                    
                    const tipoVenta = obtenerTipoDeVenta(nombre);
                    const textoStock = obtenerTextoStock({
                        name: nombre,
                        stockNumber: stockNumber
                    });
                    
                    const product = {
                        id: item.id || index + 1,
                        name: nombre,
                        price: precio,
                        category: categoria,
                        stock: stockStatus,
                        stockNumber: stockNumber,
// Reemplaza la l√≠nea donde se define la imagen del producto con:
image: `imagenes-productos/${nombre.toLowerCase()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .replace(/[^a-z0-9]/g, '-')
    .replace(/-+/g, '-')
    .replace(/^-|-$/g, '')}.jpg`,
                        descripcion: descripcion,
                        hasPromo: tieneOferta,
                        ofertas1: ofertas1,
                        ofertas2: ofertas2,
                        discountedPrice: precioConDescuento,
                        discountPercent: descuentoReal,
                        descuentoReal: descuentoReal,
                        offerText: textoCortoOferta,
                        tipoVenta: tipoVenta,
                        textoStock: textoStock,
                        precioUnitarioReal: precioConDescuento,
                        ahorroPorUnidad: precio - precioConDescuento,
                        tieneOferta1: tieneOferta1,
                        tieneOferta2: tieneOferta2,
                    };
                    
                    products.push(product);
                    
                } catch (error) {
                    console.warn(`‚ö†Ô∏è Error procesando producto ${index}:`, error.message, item);
                }
            });
            
            console.log('‚úÖ', products.length, 'productos listos para mostrar');
            
            const productosConOferta = products.filter(p => p.hasPromo).length;
            const productosConStock = products.filter(p => p.stockNumber > 0).length;
            
            if (productsGrid) {
                productsGrid.innerHTML = `
                    <div style="background: linear-gradient(135deg, #4CAF50, #2e7d32); 
                                color: white; padding: 12px; border-radius: 10px; 
                                margin-bottom: 1rem; text-align: center;">
                        ‚úÖ <strong>${products.length} productos cargados desde tu base de datos</strong>
                        <div style="display: flex; justify-content: center; gap: 20px; margin-top: 8px; font-size: 0.9rem;">
                            <span>üì¶ ${productosConStock} con stock</span>
                            <span>üî• ${productosConOferta} con ofertas</span>
                            <span>üè™ ${[...new Set(products.map(p => p.category))].length} categor√≠as</span>
                        </div>
                    </div>
                `;
            }
            
            renderCategories();
            
            clasificarProductosPorJerarquia();
            
            mostrarOfertasDestacadas();
            mostrarOfertasEspeciales(); // LLAMAR A ESPECIALES DIRECTAMENTE
            renderProducts();
            
            // IMPORTANTE: Inicializar Flash Sales DESPU√âS de tener los productos
            setTimeout(() => {
                console.log('üîÑ Inicializando sistemas de ofertas...');
                
                // 1. Primero clasificar productos
                clasificarProductosPorJerarquia();
                
                // 2. Luego controlar visibilidad por horario
                controlarVisibilidadPorHorario();
                
                // 3. FINALMENTE inicializar Flash Sales
                if (typeof FLASH_SALES_SYSTEM !== 'undefined' && FLASH_SALES_SYSTEM.init) {
                    console.log('‚ö° Inicializando Flash Sales System...');
                    FLASH_SALES_SYSTEM.init();
                } else {
                    console.error('‚ùå FLASH_SALES_SYSTEM no est√° definido');
                }
            }, 1000);
        }
        
        // ========== INTERFAZ ==========
        function detectarAdmin() {
            const urlParams = new URLSearchParams(window.location.search);
            const hasAdminParam = urlParams.has('admin');
            const adminKey = urlParams.get('key');
            
            const ADMIN_PASSWORD = "AlmacenCopihue2024";
            
            if (hasAdminParam) {
                if (adminKey === ADMIN_PASSWORD) {
                    esAdmin = true;
                } 
                else if (!adminKey) {
                    const password = prompt("üîí MODO ADMINISTRADOR\n\nIntroduce la clave de acceso:", "");
                    if (password === ADMIN_PASSWORD) {
                        esAdmin = true;
                        urlParams.set('key', ADMIN_PASSWORD);
                        const newUrl = `${window.location.pathname}?${urlParams.toString()}`;
                        window.history.replaceState({}, '', newUrl);
                    } else {
                        esAdmin = false;
                        alert("‚ùå Clave incorrecta. Modo administrador desactivado.");
                        urlParams.delete('admin');
                        urlParams.delete('key');
                        const newUrl = `${window.location.pathname}${urlParams.toString() ? '?' + urlParams.toString() : ''}`;
                        window.history.replaceState({}, '', newUrl);
                    }
                } 
                else {
                    esAdmin = false;
                    alert("‚ùå Clave incorrecta en URL. Modo administrador desactivado.");
                    urlParams.delete('admin');
                    urlParams.delete('key');
                    const newUrl = `${window.location.pathname}${urlParams.toString() ? '?' + urlParams.toString() : ''}`;
                    window.history.replaceState({}, '', newUrl);
                }
            } else {
                esAdmin = false;
            }
            
            if (esAdmin) {
                adminBadge.style.display = 'inline-block';
                adminNotification.style.display = 'block';
                adminFloatingButton.style.display = 'flex';
                console.log('üîß MODO ADMIN ACTIVADO - Acceso seguro');
                
                // Inicializar panel admin
                initAdminPanel();
            }
        }
        
        // ========== PANEL DE ADMINISTRACI√ìN ==========
        function initAdminPanel() {
            console.log('üõ†Ô∏è Inicializando panel de administraci√≥n...');
            
            // Mostrar bot√≥n flotante
            adminFloatingButton.style.display = 'flex';
            
            // Event listeners para panel admin
            adminFloatingButton.addEventListener('click', toggleAdminPanel);
            adminPanelClose.addEventListener('click', closeAdminPanel);
            
            // Botones de forzar visibilidad
            document.getElementById('adminForceRelampago').addEventListener('click', () => {
                ADMIN_TOOLS.forcedSections.relampago = !ADMIN_TOOLS.forcedSections.relampago;
                updateAdminForcedStatus();
                controlarVisibilidadPorHorario();
                showNotification(`‚ö° Rel√°mpago ${ADMIN_TOOLS.forcedSections.relampago ? 'forzado' : 'normal'}`, 'info');
            });
            
            document.getElementById('adminForceDestacadas').addEventListener('click', () => {
                ADMIN_TOOLS.forcedSections.destacadas = !ADMIN_TOOLS.forcedSections.destacadas;
                updateAdminForcedStatus();
                controlarVisibilidadPorHorario();
                showNotification(`üî• Destacadas ${ADMIN_TOOLS.forcedSections.destacadas ? 'forzadas' : 'normal'}`, 'info');
            });
            
            document.getElementById('adminForceEspeciales').addEventListener('click', () => {
                ADMIN_TOOLS.forcedSections.especiales = !ADMIN_TOOLS.forcedSections.especiales;
                updateAdminForcedStatus();
                controlarVisibilidadPorHorario();
                showNotification(`üéÅ Especiales ${ADMIN_TOOLS.forcedSections.especiales ? 'forzados' : 'normal'}`, 'info');
            });
            
            // Botones de limpiar cache
            document.getElementById('adminClearCache').addEventListener('click', limpiarCacheCompleto);
            document.getElementById('adminClearLocal').addEventListener('click', () => {
                localStorage.clear();
                showNotification('üóëÔ∏è LocalStorage limpiado', 'success');
                updateSystemInfo();
            });
            document.getElementById('adminClearSession').addEventListener('click', () => {
                sessionStorage.clear();
                showNotification('üóëÔ∏è SessionStorage limpiado', 'success');
                updateSystemInfo();
            });
            document.getElementById('adminClearFlash').addEventListener('click', () => {
                if (typeof FLASH_SALES_SYSTEM !== 'undefined' && FLASH_SALES_SYSTEM.clearHistory) {
                    FLASH_SALES_SYSTEM.clearHistory();
                    showNotification('‚ö° Historial Flash Sales limpiado', 'success');
                    updateSystemInfo();
                }
            });
            
            // Toggles
            document.getElementById('adminToggleOcultos').addEventListener('click', () => {
                ADMIN_TOOLS.showHidden = !ADMIN_TOOLS.showHidden;
                const toggle = document.querySelector('#adminToggleOcultos .admin-toggle-switch');
                toggle.classList.toggle('active', ADMIN_TOOLS.showHidden);
                mostrarProductosOcultos = ADMIN_TOOLS.showHidden;
                showNotification(`üëÅÔ∏è Productos ocultos ${ADMIN_TOOLS.showHidden ? 'visibles' : 'ocultos'}`, 'info');
                renderProducts();
                updateSystemInfo();
            });
            
            document.getElementById('adminToggleDebug').addEventListener('click', () => {
                ADMIN_TOOLS.debugMode = !ADMIN_TOOLS.debugMode;
                const toggle = document.querySelector('#adminToggleDebug .admin-toggle-switch');
                toggle.classList.toggle('active', ADMIN_TOOLS.debugMode);
                modoDebug = ADMIN_TOOLS.debugMode;
                showNotification(`üî¨ Modo debug ${ADMIN_TOOLS.debugMode ? 'activado' : 'desactivado'}`, 'info');
                updateSystemInfo();
            });
            
            // Botones de recargar/test
            document.getElementById('adminRefreshData').addEventListener('click', () => {
                window.appInitialized = false;
                loadProductsFromAPI();
                showNotification('üîÑ Recargando datos...', 'info');
            });
            
            document.getElementById('adminTestAPI').addEventListener('click', testAPI);
            
            // Botones de test de secciones
            document.getElementById('adminTestRelampago').addEventListener('click', () => {
                testSeccion('relampago');
            });
            
            document.getElementById('adminTestDestacadas').addEventListener('click', () => {
                testSeccion('destacadas');
            });
            
            document.getElementById('adminTestEspeciales').addEventListener('click', () => {
                testSeccion('especiales');
            });
            
            document.getElementById('adminTestHorarios').addEventListener('click', testHorarios);
            
            // Bot√≥n de debug Flash Sales
            document.getElementById('adminDebugFlash').addEventListener('click', function() {
                debugFlashSales();
                showNotification('üîç Debug Flash Sales ejecutado - Ver consola', 'info');
            });
            
            // Botones de sistema
            document.getElementById('adminExportData').addEventListener('click', exportarDatos);
            document.getElementById('adminResetAll').addEventListener('click', resetTotal);
            
            // Actualizar informaci√≥n inicial
            updateAdminForcedStatus();
            updateSystemInfo();
            
            console.log('‚úÖ Panel de administraci√≥n listo');
        }
        
        function toggleAdminPanel() {
            if (adminPanel.style.display === 'block') {
                closeAdminPanel();
            } else {
                openAdminPanel();
            }
        }
        
        function openAdminPanel() {
            adminPanel.style.display = 'block';
            document.body.classList.add('admin-panel-visible');
            updateSystemInfo();
        }
        
        function closeAdminPanel() {
            adminPanel.style.display = 'none';
            document.body.classList.remove('admin-panel-visible');
            }

            // En el panel admin, agrega un bot√≥n para listar im√°genes faltantes
function listarImagenesFaltantes() {
    if (!products || products.length === 0) return;
    
    const nombresImagenes = [];
    const productosConImagenesFaltantes = [];
    
    products.forEach(product => {
        // Obtener el nombre de archivo actual
        const nombreArchivo = simplificarNombre(product.name) + '.jpg';
        nombresImagenes.push(nombreArchivo);
        
        // Verificar si el producto mostr√≥ error
        productosConImagenesFaltantes.push({
            nombre: product.name,
            archivo: nombreArchivo,
            tieneOferta: product.descuentoReal > 0
        });
    });
    
    // Mostrar en consola
    console.log('üìã LISTA DE IM√ÅGENES NECESARIAS:');
    console.log('================================');
    
    // Ordenar por productos con oferta primero
    const productosOrdenados = productosConImagenesFaltantes.sort((a, b) => {
        if (a.tieneOferta && !b.tieneOferta) return -1;
        if (!a.tieneOferta && b.tieneOferta) return 1;
        return 0;
    });
    
    productosOrdenados.forEach((item, index) => {
        const icono = item.tieneOferta ? 'üî•' : 'üì¶';
        console.log(`${icono} ${index + 1}. ${item.archivo}`);
        console.log(`   Producto: ${item.nombre.substring(0, 40)}...`);
    });
    
    // Tambi√©n crear un archivo descargable
    const contenido = productosOrdenados.map(item => 
        `${item.tieneOferta ? '[OFERTA]' : '[NORMAL]'} ${item.archivo} - ${item.nombre}`
    ).join('\n');
    
    const blob = new Blob([contenido], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'lista-imagenes-faltantes.txt';
    a.click();
    URL.revokeObjectURL(url);
    
    alert(`‚úÖ Lista generada. Se descarg√≥ un archivo con ${nombresImagenes.length} nombres de im√°genes.\n\nRevisa la consola (F12) para ver la lista completa.`);
}

// Agrega este bot√≥n al panel admin
document.getElementById('adminExportData').insertAdjacentHTML('beforebegin', 
    `<button class="admin-button info" id="adminListImages">üñºÔ∏è Listar Im√°genes</button>`
);

document.getElementById('adminListImages').addEventListener('click', listarImagenesFaltantes);
        
        function updateAdminForcedStatus() {
            const statusElement = document.getElementById('adminForcedStatus');
            if (!statusElement) return;
            
            const forced = [];
            if (ADMIN_TOOLS.forcedSections.relampago) forced.push('‚ö° Rel√°mpago');
            if (ADMIN_TOOLS.forcedSections.destacadas) forced.push('üî• Destacadas');
            if (ADMIN_TOOLS.forcedSections.especiales) forced.push('üéÅ Especiales');
            
            if (forced.length === 0) {
                statusElement.innerHTML = 'üîÑ Forzado: Ninguno';
            } else {
                statusElement.innerHTML = `üîÑ Forzado: ${forced.join(', ')}`;
            }
        }
        
        function updateSystemInfo() {
            const infoElement = document.getElementById('adminSystemInfo');
            if (!infoElement) return;
            
            const ahora = new Date();
            const diaSemana = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'][ahora.getDay()];
            const hora = ahora.getHours().toString().padStart(2, '0');
            const minutos = ahora.getMinutes().toString().padStart(2, '0');
            
            const productosTotal = products.length;
            const productosConStock = products.filter(p => p.stockNumber > 0).length;
            const productosConOferta = products.filter(p => p.descuentoReal > 0).length;
            
            let info = `üìÖ ${diaSemana} ${hora}:${minutos}<br>`;
            info += `üì¶ Productos: ${productosTotal} total, ${productosConStock} con stock<br>`;
            info += `üî• Ofertas: ${productosConOferta} productos con descuento<br>`;
            info += `‚ö° Rel√°mpago: ${window.productosRelampagoIds?.length || 0} productos<br>`;
            info += `üîß Admin: ${ADMIN_TOOLS.showHidden ? 'üëÅÔ∏è Ocultos visibles' : 'üëÅÔ∏è Ocultos ocultos'} | ${ADMIN_TOOLS.debugMode ? 'üî¨ Debug ON' : 'üî¨ Debug OFF'}`;
            
            infoElement.innerHTML = info;
        }
        
        function limpiarCacheCompleto() {
            // Limpiar localStorage
            localStorage.clear();
            
            // Limpiar sessionStorage
            sessionStorage.clear();
            
            // Limpiar cach√© de im√°genes
            if ('caches' in window) {
                caches.keys().then(function(names) {
                    for (let name of names) {
                        caches.delete(name);
                    }
                });
            }
            
            // Forzar recarga sin cache
            window.appInitialized = false;
            
            showNotification('üßπ Cach√© completo limpiado', 'success');
            
            // Recargar productos
            setTimeout(() => {
                loadProductsFromAPI();
            }, 1000);
            
            updateSystemInfo();
        }
        
        async function testAPI() {
            try {
                showNotification('üß™ Probando conexi√≥n con API...', 'info');
                
                const TU_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxhKFk2WAi-KRY5xGBsI6_6Pvp3jDjt8mSRXvy7I1WehNmBpJamqK9G9Q1ZJSCSgAdfDA/exec';
                const startTime = Date.now();
                
                const respuesta = await fetch(TU_APPS_SCRIPT_URL + '?test=' + Date.now());
                const endTime = Date.now();
                const tiempoRespuesta = endTime - startTime;
                
                if (respuesta.ok) {
                    showNotification(`‚úÖ API respondi√≥ en ${tiempoRespuesta}ms`, 'success');
                    console.log('‚úÖ Test API exitoso:', { tiempoRespuesta });
                } else {
                    showNotification(`‚ùå API error: ${respuesta.status}`, 'error');
                }
            } catch (error) {
                showNotification(`‚ùå Error de conexi√≥n: ${error.message}`, 'error');
            }
        }
        
        function testSeccion(seccion) {
            const tests = {
                relampago: {
                    nombre: '‚ö° Rel√°mpago',
                    dias: JERARQUIA_OFERTAS.relampago.dias,
                    horario: JERARQUIA_OFERTAS.relampago.horario
                },
                destacadas: {
                    nombre: 'üî• Destacadas',
                    dias: JERARQUIA_OFERTAS.destacadas.dias,
                    horario: JERARQUIA_OFERTAS.destacadas.horario
                },
                especiales: {
                    nombre: 'üéÅ Especiales',
                    dias: JERARQUIA_OFERTAS.especiales.dias,
                    horario: JERARQUIA_OFERTAS.especiales.horario,
                    siempreVisible: true
                }
            };
            
            const test = tests[seccion];
            if (!test) return;
            
            const ahora = new Date();
            const hora = ahora.getHours();
            const minutos = ahora.getMinutes();
            const diaSemana = ahora.getDay();
            
            const enDiaCorrecto = test.dias.includes(diaSemana);
            const horaDecimal = hora + (minutos / 100);
            const horaInicio = test.horario.start + (test.horario.startMinutes / 100);
            const horaFin = test.horario.end + (test.horario.endMinutes / 100);
            
            const enHorarioCorrecto = horaDecimal >= horaInicio && horaDecimal <= horaFin;
            
            let mensaje = `üß™ Test ${test.nombre}:\n`;
            mensaje += `‚Ä¢ D√≠a actual: ${['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'][diaSemana]}\n`;
            mensaje += `‚Ä¢ D√≠as v√°lidos: ${test.dias.map(d => ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'][d]).join(', ')}\n`;
            mensaje += `‚Ä¢ D√≠a correcto: ${enDiaCorrecto ? '‚úÖ' : '‚ùå'}\n`;
            mensaje += `‚Ä¢ Hora actual: ${hora}:${minutos.toString().padStart(2, '0')}\n`;
            mensaje += `‚Ä¢ Horario v√°lido: ${test.horario.start}:${test.horario.startMinutes.toString().padStart(2, '0')} - ${test.horario.end}:${test.horario.endMinutes.toString().padStart(2, '0')}\n`;
            mensaje += `‚Ä¢ Horario correcto: ${enHorarioCorrecto ? '‚úÖ' : '‚ùå'}\n`;
            mensaje += `‚Ä¢ Siempre visible: ${test.siempreVisible ? '‚úÖ S√ç' : '‚ùå NO'}\n`;
            mensaje += `‚Ä¢ Secci√≥n deber√≠a estar: ${(test.siempreVisible || (enDiaCorrecto && enHorarioCorrecto)) ? 'VISIBLE' : 'OCULTA'}`;
            
            alert(mensaje);
            console.log(`üß™ Test ${seccion}:`, { 
                diaActual: diaSemana, 
                horaActual: `${hora}:${minutos}`,
                enDiaCorrecto, 
                enHorarioCorrecto,
                siempreVisible: test.siempreVisible,
                deberiaEstarVisible: (test.siempreVisible || (enDiaCorrecto && enHorarioCorrecto))
            });
        }
        
        function testHorarios() {
            const ahora = new Date();
            const hora = ahora.getHours();
            const minutos = ahora.getMinutes();
            const diaSemana = ahora.getDay();
            const nombreDia = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'][diaSemana];
            
            let mensaje = `üïí TEST HORARIOS COMPLETO:\n\n`;
            mensaje += `üìÖ ${nombreDia} ${hora}:${minutos.toString().padStart(2, '0')}\n\n`;
            
            // Test Rel√°mpago
            const enDiaRelampago = JERARQUIA_OFERTAS.relampago.dias.includes(diaSemana);
            const enHorarioRelampago = (hora > 11 || (hora === 11 && minutos >= 30)) && 
                                       (hora < 17 || (hora === 17 && minutos === 0));
            mensaje += `‚ö° REL√ÅMPAGO (Dom-Jue 11:30-17:00):\n`;
            mensaje += `  ‚Ä¢ D√≠as: ${JERARQUIA_OFERTAS.relampago.dias.map(d => ['D', 'L', 'M', 'X', 'J', 'V', 'S'][d]).join(', ')}\n`;
            mensaje += `  ‚Ä¢ D√≠a actual v√°lido: ${enDiaRelampago ? '‚úÖ' : '‚ùå'}\n`;
            mensaje += `  ‚Ä¢ Horario actual v√°lido: ${enHorarioRelampago ? '‚úÖ' : '‚ùå'}\n`;
            mensaje += `  ‚Ä¢ VISIBLE: ${(enDiaRelampago && enHorarioRelampago) ? '‚úÖ S√ç' : '‚ùå NO'}\n\n`;
            
            // Test Destacadas
            const enDiaDestacadas = JERARQUIA_OFERTAS.destacadas.dias.includes(diaSemana);
            const enHorarioDestacadas = (hora >= 18) && (hora < 23);
            mensaje += `üî• DESTACADAS (Vie-S√°b 18:00-23:00):\n`;
            mensaje += `  ‚Ä¢ D√≠as: ${JERARQUIA_OFERTAS.destacadas.dias.map(d => ['D', 'L', 'M', 'X', 'J', 'V', 'S'][d]).join(', ')}\n`;
            mensaje += `  ‚Ä¢ D√≠a actual v√°lido: ${enDiaDestacadas ? '‚úÖ' : '‚ùå'}\n`;
            mensaje += `  ‚Ä¢ Horario actual v√°lido: ${enHorarioDestacadas ? '‚úÖ' : '‚ùå'}\n`;
            mensaje += `  ‚Ä¢ VISIBLE: ${(enDiaDestacadas && enHorarioDestacadas) ? '‚úÖ S√ç' : '‚ùå NO'}\n\n`;
            
            // Test Especiales
            mensaje += `üéÅ ESPECIALES (SIEMPRE VISIBLES 24/7):\n`;
            mensaje += `  ‚Ä¢ VISIBLE: ‚úÖ SIEMPRE 24/7\n\n`;
            
            // Estado forzado admin
            mensaje += `üîß ESTADO ADMIN FORZADO:\n`;
            mensaje += `  ‚Ä¢ ‚ö° Rel√°mpago: ${ADMIN_TOOLS.forcedSections.relampago ? '‚úÖ FORZADO' : 'üîÑ NORMAL'}\n`;
            mensaje += `  ‚Ä¢ üî• Destacadas: ${ADMIN_TOOLS.forcedSections.destacadas ? '‚úÖ FORZADO' : 'üîÑ NORMAL'}\n`;
            mensaje += `  ‚Ä¢ üéÅ Especiales: ${ADMIN_TOOLS.forcedSections.especiales ? '‚úÖ FORZADO' : 'üîÑ NORMAL'}`;
            
            alert(mensaje);
        }
        
        function exportarDatos() {
            const datos = {
                version: APP_VERSION,
                timestamp: new Date().toISOString(),
                productos: products.length,
                categorias: [...new Set(products.map(p => p.category))],
                estadisticas: {
                    total: products.length,
                    conStock: products.filter(p => p.stockNumber > 0).length,
                    conOferta: products.filter(p => p.descuentoReal > 0).length,
                    relampago: window.productosRelampagoIds?.length || 0,
                    destacadas: window.productosDestacadosIds?.length || 0,
                    especiales: window.productosEspecialesIds?.length || 0
                },
                configuracion: {
                    horarios: JERARQUIA_OFERTAS,
                    admin: ADMIN_TOOLS
                }
            };
            
            const datosStr = JSON.stringify(datos, null, 2);
            const blob = new Blob([datosStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `almacen-copihue-export-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showNotification('üì§ Datos exportados', 'success');
        }
        
        function resetTotal() {
            if (confirm('üö® ¬øEST√ÅS SEGURO DE QUERER RESETEAR TODO?\n\nEsto limpiar√°:\n‚Ä¢ Cach√© completo\n‚Ä¢ Historial Flash Sales\n‚Ä¢ Configuraciones admin\n\nLa acci√≥n NO se puede deshacer.')) {
                // Limpiar todo
                localStorage.clear();
                sessionStorage.clear();
                
                if (typeof FLASH_SALES_SYSTEM !== 'undefined' && FLASH_SALES_SYSTEM.clearHistory) {
                    FLASH_SALES_SYSTEM.clearHistory();
                }
                
                // Resetear variables admin
                ADMIN_TOOLS.forcedSections = {
                    relampago: false,
                    destacadas: false,
                    especiales: false
                };
                ADMIN_TOOLS.showHidden = false;
                ADMIN_TOOLS.debugMode = false;
                
                // Recargar p√°gina
                window.location.reload();
            }
        }
        
        // ========== FUNCI√ìN showHomeFeedback - REPARADA ==========
        function showHomeFeedback(mensaje = "üè† Volviendo al inicio") {
            try {
                // Eliminar notificaciones previas
                document.querySelectorAll('.home-feedback-notification').forEach(el => el.remove());
                
                const notification = document.createElement('div');
                notification.className = 'home-feedback-notification';
                notification.textContent = mensaje;
                
                notification.style.cssText = `
                    position: fixed;
                    top: 100px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: linear-gradient(135deg, #2196F3, #0D47A1);
                    color: white;
                    padding: 12px 24px;
                    border-radius: 25px;
                    box-shadow: 0 4px 15px rgba(33, 150, 243, 0.4);
                    z-index: 99999;
                    font-weight: 600;
                    font-size: 14px;
                    animation: slideDown 0.3s ease;
                    border: 2px solid white;
                    text-align: center;
                    min-width: 200px;
                    max-width: 80%;
                `;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 1500);
                
            } catch (error) {
                console.warn('‚ö†Ô∏è Error en showHomeFeedback:', error);
            }
        }

        // ========== EVENT LISTENER CORREGIDO ==========
        floatingHome.addEventListener("click", function() {
            console.log('‚úÖ Bot√≥n INICIO clickeado');
            
            // 1. Resetear categor√≠a
            currentCategory = "TODOS";
            
            // 2. Limpiar b√∫squeda si est√° activa
            if (productSearch) productSearch.value = '';
            if (mobileSearch) mobileSearch.value = '';
            isSearching = false;
            
            // 3. Actualizar botones de categor√≠a
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-category') === 'TODOS') {
                    btn.classList.add('active');
                }
            });
            
            // 4. Renderizar productos
            renderProducts();
            
            // 5. Mostrar feedback
            showHomeFeedback('üè† Mostrando TODOS los productos');
            
            // 6. Scroll al inicio
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
            
            console.log('üè† Inicio: Categor√≠a TODOS activada');
        });
        
        function setupSearch() {
            productSearch.addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase().trim();
                toggleClearButton(clearSearchBtn, searchTerm);
                
                if (searchTerm === '') {
                    clearSearch();
                    return;
                }
                
                if (searchTerm.length >= 2) {
                    filterProducts(searchTerm);
                }
            });
            
            productSearch.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const searchTerm = this.value.trim();
                    if (searchTerm.length >= 2) {
                        filterProducts(searchTerm);
                    }
                }
            });
            
            mobileSearch.addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase().trim();
                toggleClearButton(clearMobileSearchBtn, searchTerm);
                
                if (searchTerm === '') {
                    mobileSearchResults.innerHTML = '';
                    return;
                }
                
                if (searchTerm.length >= 2) {
                    filterMobileProducts(searchTerm);
                }
            });
        }
        
        function toggleClearButton(button, searchTerm) {
            button.style.display = searchTerm.length > 0 ? 'block' : 'none';
        }
        
        function openSearchModal() {
            searchModal.style.display = "flex";
            mobileSearch.focus();
            mobileSearchResults.innerHTML = '';
        }
        
        function closeSearchModal() {
            searchModal.style.display = "none";
            mobileSearch.value = '';
            mobileSearchResults.innerHTML = '';
            clearMobileSearchBtn.style.display = 'none';
        }
        
        function clearMobileSearch() {
            mobileSearch.value = '';
            mobileSearchResults.innerHTML = '';
            clearMobileSearchBtn.style.display = 'none';
        }
        
        function filterProducts(searchTerm) {
            if (!products || products.length === 0) return;
            
            isSearching = true;
            const filtered = searchProducts(searchTerm);
            renderFilteredProducts(filtered, searchTerm);
        }
        
        function filterMobileProducts(searchTerm) {
            if (!products || products.length === 0) return;
            
            const filtered = searchProducts(searchTerm);
            
            if (filtered.length === 0) {
                mobileSearchResults.innerHTML = `
                    <div style="text-align: center; padding: 1rem; color: #666;">
                        üîç No se encontraron productos para "<strong>${searchTerm}</strong>"
                    </div>
                `;
                return;
            }
            
            let resultsHTML = '<div style="display: grid; gap: 1rem;">';
            
            filtered.forEach(product => {
                const stockText = obtenerTextoStock(product);
                
                let stockClass = '';
                if (product.stockNumber === 0) {
                    stockClass = 'out-of-stock';
                } else if (product.stockNumber > 0 && product.stockNumber <= 3) {
                    stockClass = 'low-stock';
                } else {
                    stockClass = 'in-stock';
                }
                
                const addButton = product.stockNumber === 0
                    ? `<button class="add-to-cart" disabled>‚ùå Sin Stock</button>`
                    : `<button class="add-to-cart" data-id="${product.id}">üõí Agregar al Carrito</button>`;
                
                const textoCortoOferta = obtenerTextoCortoOferta(product.ofertas1, product.ofertas2);
                const offerBadge = textoCortoOferta 
                    ? `<div class="offer-badge">${textoCortoOferta}</div>`
                    : '';
                
                const descripcionOferta = obtenerDescripcionOferta(product.ofertas1, product.ofertas2, product.price);
                const detalleOferta = product.ofertas1 ? 
                    obtenerDetalleOferta3x2(product.ofertas1, product.price, 1) : '';
                
                const textoLimiteOfertas2 = obtenerTextoLimiteOfertas2(product.ofertas2, product.name);
                
                resultsHTML += `
                    <div class="product-card">
                        ${offerBadge}
                        <div class="product-image">
                            <img src="${product.image}" 
                                 alt="${product.name}"
                                 onerror="handleImageError(this, '${product.name.replace(/'/g, "\\'")}')">
                        </div>
                        <div class="product-info">
                            <div class="product-name">${product.name}</div>
                            ${descripcionOferta ? `<div class="offer-description">${descripcionOferta}</div>` : ''}
                            ${detalleOferta}
                            <div class="product-price-container">
                                ${product.hasPromo && product.discountedPrice < product.price ? 
                                    `<span class="original-price">$${product.price}</span>` : ''}
                                <span class="product-price">$${Math.round(product.discountedPrice)}</span>
                                ${textoCortoOferta ? 
                                    `<span class="discount-percent">${textoCortoOferta.replace('üî• ', '').replace('üéØ ', '')}</span>` : ''}
                            </div>
                            ${textoLimiteOfertas2 ? `
                                <div class="promo-limit" style="color: #ff6f00; font-weight: 500;">
                                    ${textoLimiteOfertas2}
                                </div>
                            ` : ''}
                            <div class="product-stock ${stockClass}">
                                ${stockText}
                            </div>
                            ${addButton}
                        </div>
                    </div>
                `;
            });
            
            resultsHTML += '</div>';
            mobileSearchResults.innerHTML = resultsHTML;
        }
        
        function renderFilteredProducts(filteredProducts, searchTerm = '') {
            if (filteredProducts.length === 0) {
                productsGrid.innerHTML = `
                    <div class="loading" style="text-align: center; padding: 2rem;">
                        üîç No se encontraron productos para "<strong>${searchTerm}</strong>"
                        <br><br>
                        <button onclick="clearSearch()" class="retry-btn">
                            ‚ú® Ver todos los productos
                        </button>
                    </div>
                `;
                return;
            }
            
            renderProductsFromArray(filteredProducts, searchTerm);
        }
        
        function clearSearch() {
            productSearch.value = '';
            mobileSearch.value = '';
            isSearching = false;
            clearSearchBtn.style.display = 'none';
            clearMobileSearchBtn.style.display = 'none';

            currentCategory = "ALMACEN";

            renderProducts();

            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.toggle(
                    'active',
                    btn.getAttribute('data-category') === "ALMACEN"
                );
            });
        }
        
        // ========== SISTEMA PERFECTO DE CATEGOR√çAS ==========
        function renderCategories() {
            const categories = [...new Set(products.map(p => p.category))];
            
            const allCategories = ['TODOS', ...categories];
            
            categoriesContainer.innerHTML = allCategories.map(category => {
                const isAll = category === 'TODOS';
                const isActive = (isAll && currentCategory === 'TODOS') || (!isAll && category === currentCategory);
                
                return `
                    <button class="category-btn ${isActive ? 'active' : ''}" 
                            data-category="${category}">
                        ${category}
                    </button>
                `;
            }).join("");
            
            if (categories.length > 0) {
                if (!currentCategory || currentCategory === 'TODOS') {
                    currentCategory = 'TODOS';
                }
                
                document.querySelectorAll('.category-btn').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.getAttribute('data-category') === currentCategory) {
                        btn.classList.add('active');
                    }
                });
            }
            
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.addEventListener("click", function() {
                    currentCategory = this.getAttribute("data-category");
                    document.querySelectorAll(".category-btn").forEach(b => b.classList.remove("active"));
                    this.classList.add("active");
                    renderProducts();
                });
            });
        }
        
        // ========== MOSTRAR OFERTAS DESTACADAS ==========
        function mostrarOfertasDestacadas() {
            console.log('üî• OFERTAS DESTACADAS - Sistema jer√°rquico');
            
            if (!window.productosDestacadosIds) {
                clasificarProductosPorJerarquia();
            }
            
            const productosDestacadas = products.filter(p => 
                window.productosDestacadosIds.includes(p.id)
            );
            
            const ahora = new Date();
            const hora = ahora.getHours();
            const minutos = ahora.getMinutes();
            const horaDecimal = hora + (minutos / 100);
            
            // Destacadas solo Viernes y S√°bado 18:00-23:00
            const enDiaDestacadas = JERARQUIA_OFERTAS.destacadas.dias.includes(ahora.getDay());
            const enHorarioDestacadas = horaDecimal >= 18.00 && horaDecimal < 23.00;
            
            if (!enHorarioDestacadas || !enDiaDestacadas) {
                console.log('‚è∞ Fuera de horario/d√≠a de destacadas (Vie-S√°b 18-23hrs)');
                if (featuredOffers) {
                    featuredOffers.style.display = 'none';
                    
                    const existingMsg = document.querySelector('.horario-destacadas');
                    if (!existingMsg && productsGrid) {
                        const mensajeHorario = document.createElement('div');
                        mensajeHorario.className = 'horario-destacadas';
                        mensajeHorario.innerHTML = `
                            <div style="background: #ff9800; color: white; padding: 15px; 
                                border-radius: 10px; text-align: center; margin-bottom: 20px;
                                border-left: 5px solid #ff5722;">
                                <strong>‚è∞ OFERTAS DESTACADAS</strong><br>
                                <div style="font-size: 0.9rem; margin-top: 5px;">
                                    Disponibles solo <strong>Viernes y S√°bado de 18:00 a 23:00 hrs</strong><br>
                                    <small>Descuentos del 15% al 32% OFF</small>
                                </div>
                            </div>
                        `;
                        productsGrid.parentNode.insertBefore(mensajeHorario, productsGrid);
                    }
                }
                return;
            }
            
            if (productosDestacadas.length > 0 && featuredOffers && featuredProductsGrid) {
                featuredOffers.style.display = 'block';
                
                const headerDestacadas = `
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div style="display: inline-flex; align-items: center; gap: 10px; 
                            background: ${JERARQUIA_OFERTAS.destacadas.color}; 
                            color: white; padding: 10px 20px; border-radius: 25px;
                            font-weight: bold; font-size: 1.1rem; box-shadow: 0 4px 12px rgba(255, 152, 0, 0.3);">
                            ${JERARQUIA_OFERTAS.destacadas.icono} 
                            ${JERARQUIA_OFERTAS.destacadas.nombre}
                            <span style="font-size: 0.9rem; opacity: 0.9; margin-left: 8px;">
                                (${productosDestacadas.length} ofertas seleccionadas)
                            </span>
                        </div>
                        <div style="margin-top: 10px; color: #666; font-size: 0.9rem;">
                            ${JERARQUIA_OFERTAS.destacadas.mensaje}
                        </div>
                    </div>
                `;
                
                featuredProductsGrid.innerHTML = headerDestacadas + renderProductsToHTML(productosDestacadas);
                
                console.log('‚úÖ DESTACADAS VISIBLES (Vie-S√°b 18-23hrs)');
                
                const mensajeExistente = document.querySelector('.horario-destacadas');
                if (mensajeExistente) mensajeExistente.remove();
                
            } else {
                if (featuredOffers) featuredOffers.style.display = 'none';
            }
        }
        
        // ========== RENDERIZAR PRODUCTOS CON JERARQU√çA ==========
        function renderProducts() {
            console.log('üîç renderProducts() - Sistema jer√°rquico activo');
            
            if (!window.productosRelampagoIds || !window.productosDestacadosIds) {
                clasificarProductosPorJerarquia();
            }
            
            let filteredProducts = [];
            
            if (currentCategory === 'TODOS') {
                filteredProducts = products.filter(p => {
                    const tieneStock = p.stockNumber > 0;
                    
                    if (p.descuentoReal > 0) {
                        const estaEnRelampago = window.productosRelampagoIds.includes(p.id);
                        const estaEnDestacadas = window.productosDestacadosIds.includes(p.id);
                        const estaEnEspeciales = window.productosEspecialesIds.includes(p.id);
                        const estaEnReserva = window.productosReservaIds.includes(p.id);
                        
                        if (!esAdmin && !ADMIN_TOOLS.showHidden) {
                            return false;
                        }
                    }
                    
                    return tieneStock || ADMIN_TOOLS.showHidden;
                });
            } else {
                filteredProducts = products.filter(p => {
                    const enCategoriaCorrecta = p.category === currentCategory;
                    const tieneStock = p.stockNumber > 0;
                    
                    if (p.descuentoReal > 0) {
                        const estaEnRelampago = window.productosRelampagoIds.includes(p.id);
                        const estaEnDestacadas = window.productosDestacadosIds.includes(p.id);
                        const estaEnEspeciales = window.productosEspecialesIds.includes(p.id);
                        const estaEnReserva = window.productosReservaIds.includes(p.id);
                        
                        if (!esAdmin && !ADMIN_TOOLS.showHidden) {
                            return false;
                        }
                    }
                    
                    return enCategoriaCorrecta && (tieneStock || ADMIN_TOOLS.showHidden);
                });
            }
            
            console.log(`üì¶ Productos en categor√≠a "${currentCategory}": ${filteredProducts.length}`);
            
            if (filteredProducts.length === 0) {
                productsGrid.innerHTML = `
                    <div class="loading" style="text-align: center; padding: 2rem;">
                        üõí No hay productos disponibles en "${currentCategory}"
                    </div>
                `;
                return;
            }
            
            renderProductsFromArray(filteredProducts);
        }
        
        function renderProductsFromArray(productsArray, searchTerm = '') {
            const productsToShow = productsArray;
            
            if (productsToShow.length === 0) {
                productsGrid.innerHTML = '<div class="loading">No hay productos disponibles</div>';
                return;
            }
            
            productsGrid.innerHTML = productsToShow.map(product => {
                const isOutOfStock = product.stockNumber === 0;
                const stockText = obtenerTextoStock(product);
                
                let stockClass = '';
                if (product.stockNumber === 0) {
                    stockClass = 'out-of-stock';
                } else if (product.stockNumber > 0 && product.stockNumber <= 3) {
                    stockClass = 'low-stock';
                } else {
                    stockClass = 'in-stock';
                }
                
                const addButton = isOutOfStock 
                    ? `<button class="add-to-cart" disabled>‚ùå Sin Stock</button>`
                    : `<button class="add-to-cart" data-id="${product.id}">üõí Agregar al Carrito</button>`;
                
                const tieneOfertaPeroOculta = product.descuentoReal > 0;
                const esAdminIndicator = (esAdmin || ADMIN_TOOLS.showHidden) && tieneOfertaPeroOculta;
                
                // Si es admin o showHidden est√° activado, mostrar ofertas normalmente
                if (esAdmin || ADMIN_TOOLS.showHidden) {
                    const textoCortoOferta = obtenerTextoCortoOferta(product.ofertas1, product.ofertas2);
                    const descripcionOferta = obtenerDescripcionOferta(product.ofertas1, product.ofertas2, product.price);
                    const detalleOferta = product.ofertas1 ? 
                        obtenerDetalleOferta3x2(product.ofertas1, product.price, 1) : '';
                    const textoLimiteOfertas2 = obtenerTextoLimiteOfertas2(product.ofertas2, product.name);
                    
                    // üé® SISTEMA DE COLORES POR DESCUENTO REAL (SIN categoriaOferta)
                    let jerarquiaClass = ''; // Inicialmente vac√≠o

                    if (esAdmin || ADMIN_TOOLS.showHidden) {
                        // DEBUG: Mostrar info √∫til
                        console.log('üé® Producto:', product.name.substring(0,25),
                                    '| Descuento:', product.descuentoReal + '%',
                                    '| Ofertas1:', product.ofertas1,
                                    '| Ofertas2:', product.ofertas2);
                        
                        // PRIORIDAD 1: Descuentos ALTOS (‚â•33%) ‚Üí REL√ÅMPAGO (ROJO)
                        if (product.descuentoReal >= 33) {
                            jerarquiaClass = 'jerarquia-relampago';
                            console.log('   ‚Üí Rel√°mpago ROJO (‚â•33%)');
                        }
                        // PRIORIDAD 2: Descuentos MEDIOS (15-32%) ‚Üí DESTACADA (NARANJA)
                        else if (product.descuentoReal >= 15) {
                            jerarquiaClass = 'jerarquia-destacadas';
                            console.log('   ‚Üí Destacada NARANJA (15-32%)');
                        }
                        // PRIORIDAD 3: Descuentos BAJOS (1-14%) ‚Üí ESPECIAL (VERDE)
                        else if (product.descuentoReal >= 1) {
                            jerarquiaClass = 'jerarquia-especiales';
                            console.log('   ‚Üí Especial VERDE (1-14%)');
                        }
                        // PRIORIDAD 4: Tiene oferta pero sin % claro ‚Üí RESERVA (VERDE CLARO)
                        else if (tieneOfertaPeroOculta) {
                            jerarquiaClass = 'jerarquia-reserva';
                            console.log('   ‚Üí Reserva VERDE CLARO (oferta sin %)');
                        }
                    } else {
                        // Para clientes normales
                        jerarquiaClass = tieneOfertaPeroOculta ? 'jerarquia-reserva' : '';
                    }

                    return `
                        <div class="product-card ${jerarquiaClass}">
                            ${textoCortoOferta ? `<div class="offer-badge">${textoCortoOferta}</div>` : ''}
                            <div class="product-image">
                                <img src="${product.image}" 
                                     alt="${product.name}"
                                     onerror="handleImageError(this, '${product.name.replace(/'/g, "\\'")}')">
                            </div>
                            <div class="product-info">
                                <div class="product-name">${product.name}</div>
                                ${descripcionOferta ? `<div class="offer-description">${descripcionOferta}</div>` : ''}
                                ${detalleOferta}
                                <div class="product-price-container">
                                    ${product.discountedPrice < product.price ? 
                                        `<span class="original-price">$${product.price}</span>` : ''}
                                    <span class="product-price">$${Math.round(product.discountedPrice)}</span>
                                    ${textoCortoOferta ? 
                                        `<span class="discount-percent">${textoCortoOferta.replace('üî• ', '').replace('üéØ ', '')}</span>` : ''}
                                </div>
                                ${textoLimiteOfertas2 ? `
                                    <div class="promo-limit" style="color: #ff6f00; font-weight: 500;">
                                        ${textoLimiteOfertas2}
                                    </div>
                                ` : ''}
                                <div class="product-stock ${stockClass}">
                                    ${stockText}
                                </div>
                                ${addButton}
                                ${esAdminIndicator ? 
                                    `<div style="font-size:0.7rem; color:#666; background:#f3e5f5; padding:4px; margin-top:5px; border-radius:4px; border-left:3px solid #9c27b0;">
                                        ‚ö†Ô∏è Este producto tiene ${product.descuentoReal}% OFF pero est√° OCULTO para clientes
<div style="font-size:0.6rem; margin-top:2px;">
    Promo base: ${product.ofertas1 || '‚Äî'} | % directo: ${product.ofertas2 || '‚Äî'}
</div>

                                    </div>` 
                                    : ''}
                            </div>
                        </div>
                    `;
                } else {
                    // Para clientes normales, solo mostrar productos sin oferta o con oferta visible
                    return `
                        <div class="product-card">
                            <div class="product-image">
                                <img src="${product.image}" 
                                     alt="${product.name}"
                                     onerror="handleImageError(this, '${product.name.replace(/'/g, "\\'")}')">
                            </div>
                            <div class="product-info">
                                <div class="product-name">${product.name}</div>
                                
                                <div class="product-price-container">
                                    <span class="product-price">$${Math.round(product.price)}</span>
                                </div>
                                
                                <div class="product-stock ${stockClass}">
                                    ${stockText}
                                </div>
                                ${addButton}
                            </div>
                        </div>
                    `;
                }
            }).join("");
            
            if (searchTerm) {
                const searchHeader = `
                    <div class="search-results">
                        <strong>üîç B√∫squeda inteligente: "${searchTerm}"</strong>
                        <br>
                        <small>Encontraste ${productsToShow.length} producto(s)</small>
                        <button onclick="clearSearch()" style="margin-left: 10px; padding: 6px 12px; 
                                background: #ff6f00; color: white; border: none; border-radius: 15px; 
                                cursor: pointer; font-size: 0.8rem;">
                            ‚úñÔ∏è Limpiar b√∫squeda
                        </button>
                    </div>
                `;
                productsGrid.innerHTML = searchHeader + productsGrid.innerHTML;
            }
        }
        
        function renderProductsToHTML(productsArray) {
            return productsArray.map(product => {
                const isOutOfStock = product.stockNumber === 0;
                const mayorOferta = obtenerMayorOfertaDelDia();
                const esMayorOferta = mayorOferta && mayorOferta.id === product.id;
                const etiquetaOferta = obtenerEtiquetaOfertaDestacada(product.ofertas2);

                const botonCompartir = esMayorOferta ? `
                    <button class="share-offer-btn" onclick="compartirMegaOferta(${product.id})">
                        ü§ù Compartir esta OFERTA
                    </button>
                ` : '';
                
                const stockText = obtenerTextoStock(product);
                
                let stockClass = '';
                if (product.stockNumber === 0) {
                    stockClass = 'out-of-stock';
                } else if (product.stockNumber > 0 && product.stockNumber <= 3) {
                    stockClass = 'low-stock';
                } else {
                    stockClass = 'in-stock';
                }
                
                const addButton = isOutOfStock 
                    ? `<button class="add-to-cart" disabled>‚ùå Sin Stock</button>`
                    : `<button class="add-to-cart" data-id="${product.id}">üõí Agregar al Carrito</button>`;
                
                if (!product.descuentoReal) {
                    product.descuentoReal = obtenerDescuentoRealProducto(product);
                }
                
                let tipoOfertaTexto = '';
                let tipoOfertaDetalle = '';
                
                if (product.ofertas2 && product.ofertas2 !== '0') {
                    tipoOfertaTexto = `${product.ofertas2}% OFF`;
                    tipoOfertaDetalle = `Descuento directo`;
                } else if (product.ofertas1 && product.ofertas1 !== '0' && OFERTAS_SISTEMA[product.ofertas1]) {
                    const oferta = OFERTAS_SISTEMA[product.ofertas1];
                    tipoOfertaTexto = `${oferta.nombre}`;
                    tipoOfertaDetalle = `${oferta.eslogan} (${product.descuentoReal}% OFF)`;
                }
                
                const textoCortoOferta = obtenerTextoCortoOferta(product.ofertas1, product.ofertas2);
                const offerBadge = textoCortoOferta 
                    ? `<div class="offer-badge">${textoCortoOferta}</div>`
                    : '';
                
                const descripcionOferta = obtenerDescripcionOferta(
                    product.ofertas1, 
                    product.ofertas2,
                    product.price
                );
                
                const detalleOferta = product.ofertas1 ? 
                    obtenerDetalleOferta3x2(product.ofertas1, product.price, 1) : '';
                
                const textoLimiteOfertas2 = obtenerTextoLimiteOfertas2(product.ofertas2, product.name);
                
                return `
                    <div class="product-card jerarquia-destacadas">
                        ${offerBadge}
                        ${esMayorOferta ? `<div class="promo-badge">üî• MEGA OFERTA</div>` : ''}
                        <div class="product-image">
                            <img src="${product.image}" 
                                 alt="${product.name}"
                                 onerror="handleImageError(this, '${product.name.replace(/'/g, "\\'")}')">
                        </div>
                        <div class="product-info">
                            <div class="product-name">${product.name}</div>
                            ${tipoOfertaTexto ? `
                                <div class="offer-description" style="color: #ff6f00; font-weight: bold; margin: 5px 0;">
                                    üéØ ${tipoOfertaTexto}
                                    ${tipoOfertaDetalle ? `<div style="font-size: 0.8rem; color: #666; margin-top: 2px;">${tipoOfertaDetalle}</div>` : ''}
                                </div>
                            ` : ''}
                            ${descripcionOferta ? `<div class="offer-description">${descripcionOferta}</div>` : ''}
                            ${detalleOferta}
                            ${etiquetaOferta ? `<div class="offer-description" style="color: #d50000; font-weight: bold;">${etiquetaOferta}</div>` : ''}
                            ${esMayorOferta ? `<div class="offer-description" style="color: #d50000; font-weight: bold;">üéØ ¬°LA MEJOR OFERTA DEL D√çA!</div>` : ''}
                            <div class="product-price-container">
                                ${product.discountedPrice < product.price ? 
                                    `<span class="original-price">$${product.price}</span>` : ''}
                                <span class="product-price">$${Math.round(product.discountedPrice)}</span>
                                ${textoCortoOferta ? 
                                    `<span class="discount-percent">${textoCortoOferta.replace('üî• ', '').replace('üéØ ', '')}</span>` : ''}
                            </div>
                            ${textoLimiteOfertas2 ? `
                                <div class="promo-limit" style="color: #ff6f00; font-weight: 500;">
                                    ${textoLimiteOfertas2}
                                </div>
                            ` : ''}
                            <div class="product-stock ${stockClass}">
                                ${stockText}
                            </div>
                            ${addButton}
                            ${botonCompartir}
                            ${esAdmin ? mostrarInfoAdmin(product) : ''}
                        </div>
                    </div>
                `;
            }).join("");
        }
        
        function verTodasLasOfertas() {
            const categoriasConOfertas = [...new Set(products
                .filter(p => p.hasPromo && (p.stock === "STOCK" || p.stockNumber > 0))
                .map(p => p.category)
            )];
            
            if (categoriasConOfertas.length > 0) {
                currentCategory = categoriasConOfertas[0];
                document.querySelectorAll(".category-btn").forEach(b => b.classList.remove("active"));
                const ofertasBtn = document.querySelector(`[data-category="${categoriasConOfertas[0]}"]`);
                if (ofertasBtn) {
                    ofertasBtn.classList.add("active");
                }
                renderProducts();
                
                document.querySelector('.products-grid').scrollIntoView({ behavior: 'smooth' });
            } else {
                alert("No hay ofertas disponibles en este momento");
            }
        }
        
        // ========== SISTEMA DELEGACI√ìN DE EVENTOS - REPARADO ==========
        function setupEventDelegation() {
            console.log('üéØ Configurando delegaci√≥n de eventos...');
            
            // Delegaci√≥n en el contenedor principal de productos
            document.addEventListener('click', function(e) {
                const addToCartBtn = e.target.closest('.add-to-cart');
                
                if (addToCartBtn && !addToCartBtn.disabled) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const productId = parseInt(addToCartBtn.getAttribute('data-id'));
                    if (productId && !isNaN(productId)) {
                        console.log(`‚úÖ Click detectado en producto ID: ${productId}`);
                        addToCart(productId);
                    }
                }
            });
            
            // Tambi√©n configuramos delegaci√≥n espec√≠fica en cada contenedor de productos
            const containers = [
                document.getElementById('productsGrid'),
                document.getElementById('featuredProductsGrid'),
                document.getElementById('flashProductsGrid'),
                document.getElementById('especialesProductsGrid'),
                document.getElementById('mobileSearchResults')
            ];
            
            containers.forEach(container => {
                if (container) {
                    container.addEventListener('click', function(e) {
                        const btn = e.target.closest('.add-to-cart');
                        if (btn && !btn.disabled) {
                            e.preventDefault();
                            e.stopPropagation();
                            const productId = parseInt(btn.getAttribute('data-id'));
                            if (productId) {
                                addToCart(productId);
                            }
                        }
                    });
                }
            });
            
            console.log('‚úÖ Delegaci√≥n de eventos configurada');
        }
        
        function addToCart(productId) {
            console.log(`üõí Agregando producto ID: ${productId} al carrito`);
            
            const product = products.find(p => p.id === productId);
            if (!product) {
                console.error(`‚ùå Producto no encontrado: ${productId}`);
                return;
            }
            
            const availableStock = product.stockNumber;
            const existingItem = cart.find(item => item.id === productId);
            const currentQuantityInCart = existingItem ? existingItem.quantity : 0;
            
            if (currentQuantityInCart >= availableStock) {
                showStockError(product.name, availableStock);
                return;
            }
            
            if (product.ofertas2) {
                const limiteOferta2 = obtenerLimiteOfertas2(product.ofertas2);
                if (limiteOferta2 !== null) {
                    const newQuantity = currentQuantityInCart + 1;
                    if (newQuantity > limiteOferta2) {
                        showLimitError(product.name, limiteOferta2, `${product.ofertas2}% OFF`);
                        return;
                    }
                }
            }
            
            const newQuantity = currentQuantityInCart + 1;
            
            if (existingItem) {
                existingItem.quantity = newQuantity;
                existingItem.price = calcularPrecioConDescuento(
                    product.price, 
                    product.ofertas1, 
                    product.ofertas2, 
                    newQuantity
                );
            } else {
                const initialPrice = calcularPrecioConDescuento(
                    product.price, 
                    product.ofertas1, 
                    product.ofertas2, 
                    1
                );
                
                cart.push({
                    id: product.id,
                    name: product.name,
                    price: initialPrice,
                    originalPrice: product.price,
                    hasPromo: product.hasPromo,
                    ofertas1: product.ofertas1,
                    ofertas2: product.ofertas2,
                    quantity: 1,
                    maxStock: availableStock,
                    maxOferta2Limit: obtenerLimiteOfertas2(product.ofertas2)
                });
                
                if (product.ofertas1 === '1') {
                    showAddToCartFeedback(product.name, 'üéâ ¬°Agregaste 1 unidad! Ma√±ana puedes agregar otra para completar el 2x1.');
                } else {
                    showAddToCartFeedback(product.name, '‚úÖ Producto agregado al carrito');
                }
            }
            
            updateCartCount();
            updateCartModal();
            
            console.log('üõí Carrito actualizado:', cart);
        }
        
        function showStockError(productName, availableStock) {
            const notification = document.createElement('div');
            notification.className = 'stock-notification';
            notification.innerHTML = `‚ùå <strong>Stock agotado</strong><br>${productName} - Solo ${availableStock} disponibles`;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
        }
        
        function showLimitError(productName, limit, offerType) {
            const notification = document.createElement('div');
            notification.className = 'limit-notification';
            notification.innerHTML = `‚ö†Ô∏è <strong>L√≠mite de oferta</strong><br>${productName} - M√°ximo ${limit} unidades por familia (${offerType})`;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
        }
        
        function showAddToCartFeedback(productName, message = '') {
            const feedback = document.createElement('div');
            feedback.className = 'success-notification';
            feedback.innerHTML = `üõí <strong>${productName}</strong> ${message}`;
            
            document.body.appendChild(feedback);
            
            setTimeout(() => {
                if (feedback.parentNode) {
                    feedback.parentNode.removeChild(feedback);
                }
            }, 2000);
        }
        
        function updateCartCount() {
            const totalItems = cart.reduce((total, item) => total + item.quantity, 0);
            cartCount.textContent = totalItems;
            floatingCartCount.textContent = totalItems;
        }
        
        function updateCartModal() {
            cartItems.innerHTML = '';
            
            if (cart.length === 0) {
                cartItems.innerHTML = '<div style="text-align: center; padding: 2rem; color: #666;">üõí Tu carrito est√° vac√≠o</div>';
                cartTotal.textContent = 'Total: $0';
                return;
            }
            
            let total = 0;
            let totalSavings = 0;
            
            cart.forEach(item => {
                const product = products.find(p => p.id === item.id);
                if (!product) return;
                
                const itemTotal = item.price * item.quantity;
                total += itemTotal;
                
                const normalPrice = product.price * item.quantity;
                const savings = normalPrice - itemTotal;
                totalSavings += savings;
                
                const cartItem = document.createElement('div');
                cartItem.className = 'cart-item';
                
                cartItem.innerHTML = `
                    <div class="cart-item-info">
                        <div class="cart-item-name">${product.name}</div>
                        <div class="cart-item-price">$${Math.round(item.price)} c/u</div>
                    </div>
                    <div class="cart-item-quantity">
                        <button class="quantity-btn" data-id="${item.id}" data-action="decrease">-</button>
                        <span class="quantity-value">${item.quantity}</span>
                        <button class="quantity-btn" data-id="${item.id}" data-action="increase">+</button>
                    </div>
                `;
                
                cartItems.appendChild(cartItem);
            });
            
            cartTotal.textContent = `Total: $${Math.round(total)}`;
            
            if (totalSavings > 0) {
                const savingsElement = document.createElement('div');
                savingsElement.className = 'total-savings';
                savingsElement.innerHTML = `üéâ ¬°Ahorraste $${Math.round(totalSavings)}!`;
                cartItems.appendChild(savingsElement);
            }
            
            // Agregar event listeners a los botones de cantidad
            document.querySelectorAll('.quantity-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const productId = parseInt(this.getAttribute('data-id'));
                    const action = this.getAttribute('data-action');
                    updateCartQuantity(productId, action);
                });
            });
        }
        
        function updateCartQuantity(productId, action) {
            const item = cart.find(item => item.id === productId);
            if (!item) return;
            
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            if (action === 'increase') {
                const availableStock = product.stockNumber;
                const currentQuantity = item.quantity;
                
                if (currentQuantity >= availableStock) {
                    showStockError(product.name, availableStock);
                    return;
                }
                
                if (product.ofertas2) {
                    const limiteOferta2 = obtenerLimiteOfertas2(product.ofertas2);
                    if (limiteOferta2 !== null && currentQuantity + 1 > limiteOferta2) {
                        showLimitError(product.name, limiteOferta2, `${product.ofertas2}% OFF`);
                        return;
                    }
                }
                
                item.quantity++;
            } else if (action === 'decrease') {
                if (item.quantity > 1) {
                    item.quantity--;
                } else {
                    // Eliminar del carrito si la cantidad llega a 0
                    cart = cart.filter(i => i.id !== productId);
                }
            }
            
            // Recalcular precio con la nueva cantidad
            item.price = calcularPrecioConDescuento(
                product.price, 
                product.ofertas1, 
                product.ofertas2, 
                item.quantity
            );
            
            updateCartCount();
            updateCartModal();
        }
        
        function openCart() {
            cartModal.style.display = "flex";
            updateCartModal();
        }
        
        function closeCartModal() {
            cartModal.style.display = "none";
        }
        
        // ========== INICIALIZACI√ìN ==========
        function init() {
            console.log('üöÄ Inicializando Almac√©n Copihue v' + APP_VERSION);
            
            // 1. Detectar modo admin primero
            detectarAdmin();
            
            // 2. Configurar b√∫squeda
            setupSearch();
            
            // 3. Configurar eventos
            setupEventDelegation();
            
            // 4. Configurar bot√≥n de enviar pedido
            if (sendOrder) {
                sendOrder.addEventListener("click", sendOrderViaWhatsApp);
            }
            
            // 5. Configurar b√∫squeda en tiempo real
            if (productSearch) {
                productSearch.addEventListener('input', function() {
                    const searchTerm = this.value.trim();
                    if (searchTerm.length >= 2) {
                        filterProducts(searchTerm);
                    } else if (searchTerm.length === 0) {
                        clearSearch();
                    }
                });
            }
            
            // 6. Cargar productos desde API
            loadProductsFromAPI();
            
            console.log('‚úÖ Sistema inicializado correctamente');
        }
        
        // Iniciar cuando el DOM est√© listo
        document.addEventListener('DOMContentLoaded', init);
        
        // Configurar PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('‚úÖ Service Worker registrado:', registration);
                    })
                    .catch(error => {
                        console.log('‚ùå Error registrando Service Worker:', error);
                    });
            });
        }
        
        // Detectar si la app est√° instalada
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            const installPrompt = document.getElementById('installPrompt');
            installPrompt.style.display = 'flex';
            
            installPrompt.addEventListener('click', () => {
                e.prompt();
                installPrompt.style.display = 'none';
            });
        });
        
        // Detectar iOS para mostrar instrucciones especiales
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        if (isIOS && window.navigator.standalone === false) {
            document.getElementById('iosInstructions').style.display = 'flex';
        }
        
        // ========== FUNCI√ìN DE DEBUG PARA REL√ÅMPAGO ==========
        function debugFlashSales() {
            console.log('=== DEBUG FLASH SALES ===');
            console.log('1. Total productos:', products.length);
            console.log('2. FLASH_SALES_SYSTEM definido:', typeof FLASH_SALES_SYSTEM !== 'undefined');
            
            if (typeof FLASH_SALES_SYSTEM !== 'undefined') {
                console.log('3. Estado:', {
                    isActive: FLASH_SALES_SYSTEM.isActive,
                    productPool: FLASH_SALES_SYSTEM.productPool.length,
                    todaySelection: FLASH_SALES_SYSTEM.todaySelection.length,
                    yesterdaySelection: FLASH_SALES_SYSTEM.yesterdaySelection.length
                });
                
                console.log('4. Productos en pool:');
                FLASH_SALES_SYSTEM.productPool.forEach(p => {
                    console.log(`   ‚Ä¢ ${p.name} (${obtenerDescuentoRealProducto(p)}% OFF)`);
                });
                
                console.log('5. Productos seleccionados hoy:');
                FLASH_SALES_SYSTEM.todaySelection.forEach(p => {
                    console.log(`   ‚Ä¢ ${p.name} (${p.flashDiscount}% OFF)`);
                });
            }
            
            const ahora = new Date();
            console.log('6. Fecha/hora actual:', {
                hora: ahora.getHours() + ':' + ahora.getMinutes(),
                dia: ['Dom','Lun','Mar','Mi√©','Jue','Vie','S√°b'][ahora.getDay()],
                diaNum: ahora.getDay()
            });
            
            // Mostrar en pantalla tambi√©n
            const debugInfo = document.createElement('div');
            debugInfo.style.cssText = `
                position: fixed;
                bottom: 10px;
                left: 10px;
                background: rgba(0,0,0,0.8);
                color: white;
                padding: 10px;
                border-radius: 5px;
                font-size: 12px;
                z-index: 99999;
                max-width: 300px;
            `;
            
            debugInfo.innerHTML = `
                <strong>Debug Flash Sales:</strong><br>
                ‚Ä¢ Productos: ${products.length}<br>
                ‚Ä¢ Pool: ${FLASH_SALES_SYSTEM?.productPool?.length || 0}<br>
                ‚Ä¢ Seleccionados hoy: ${FLASH_SALES_SYSTEM?.todaySelection?.length || 0}<br>
                ‚Ä¢ Activo: ${FLASH_SALES_SYSTEM?.isActive ? 'S√≠' : 'No'}<br>
                ‚Ä¢ Hora: ${ahora.getHours()}:${ahora.getMinutes().toString().padStart(2, '0')}
            `;
            
            document.body.appendChild(debugInfo);
            
            // Auto-remover despu√©s de 10 segundos
            setTimeout(() => debugInfo.remove(), 10000);
        }
    </script>
</body>
</html>
