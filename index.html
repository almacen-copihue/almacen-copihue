<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Almac√©n Copihue - Productos de calidad con la confianza de siempre</title>
    
    <!-- META TAGS PARA PWA -->
    <meta name="theme-color" content="#2e7d32">
    <meta name="description" content="Almac√©n Copihue">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Almac√©n Copihue">
    
    <!-- ICONOS -->
    <link rel="icon" href="iconos-pwa/android/android-launchericon-48-48.png" type="image/png">
    <link rel="apple-touch-icon" href="iconos-pwa/ios/180.png">
    <link rel="apple-touch-icon" sizes="152x152" href="iconos-pwa/ios/152.png">
    <link rel="apple-touch-icon" sizes="167x167" href="iconos-pwa/ios/167.png">
    <link rel="apple-touch-icon" sizes="180x180" href="iconos-pwa/ios/180.png">
    <link rel="apple-touch-startup-image" href="iconos-pwa/ios/1024.png">
    
    <!-- MANIFEST EXTERNO -->
    <link rel="manifest" href="manifest.json">
    
    <!-- ESTILOS -->
    <style>
        :root {
            --primary: #2e7d32;
            --primary-dark: #1b5e20;
            --primary-light: #4caf50;
            --secondary: #ff6f00;
            --secondary-dark: #f57c00;
            --accent: #ffeb3b;
            --light: #f8fff8;
            --dark: #1b5e20;
            --gray: #757575;
            --white: #ffffff;
            --card-bg: #ffffff;
            --shadow: 0 4px 15px rgba(46,125,50,0.1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--light);
            color: var(--dark);
            line-height: 1.6;
            background-image: linear-gradient(135deg, #f8fff8 0%, #e8f5e9 100%);
        }
        
        header {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: var(--white);
            padding: 1rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow);
        }
        
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .logo-icon {
            font-size: 1.8rem;
        }

        .admin-badge {
            background: var(--secondary);
            color: white;
            padding: 0.2rem 0.6rem;
            border-radius: 12px;
            font-size: 0.7rem;
            margin-left: 0.5rem;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        .cart-icon {
            position: relative;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: background 0.3s;
        }
        
        .cart-icon:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .cart-count {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--secondary);
            color: white;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }
        
        .hero {
            background: linear-gradient(135deg, rgba(46,125,50,0.9), rgba(76,175,80,0.8));
            background-size: cover;
            color: white;
            padding: 3rem 1rem;
            text-align: center;
            border-radius: 15px;
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
        }
        
        .hero h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .hero p {
            font-size: 1.1rem;
            margin-bottom: 1rem;
            opacity: 0.9;
        }
        
        .info-bar {
            background-color: var(--white);
            padding: 1.2rem;
            border-radius: 12px;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-around;
            text-align: center;
            border-left: 4px solid var(--secondary);
        }
        
        .info-item {
            margin: 0.5rem;
            font-weight: 500;
        }
        
        .search-container {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            padding: 1rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #e8f5e9;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-radius: 12px;
            position: relative;
        }
        
        .search-wrapper {
            position: relative;
            width: 100%;
        }
        
        .search-input {
            width: 100%;
            padding: 14px 50px 14px 20px;
            border: 2px solid var(--primary);
            border-radius: 25px;
            font-size: 1rem;
            background: white;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(46,125,50,0.1);
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--primary-dark);
            box-shadow: 0 0 0 3px rgba(46,125,50,0.2);
        }
        
        .clear-search {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: var(--gray);
            transition: color 0.3s;
            padding: 5px;
            z-index: 2;
            display: none;
        }
        
        .clear-search:hover {
            color: var(--primary);
        }
        
        .search-results {
            text-align: center;
            padding: 12px;
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            border-radius: 10px;
            margin-bottom: 1rem;
            border-left: 4px solid #2196f3;
        }
        
        .categories {
            display: flex;
            overflow-x: auto;
            padding: 1rem 0;
            margin-bottom: 1rem;
            gap: 0.8rem;
        }
        
        .category-btn {
            background-color: var(--white);
            border: 2px solid #e8f5e9;
            padding: 0.7rem 1.2rem;
            border-radius: 25px;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.3s;
            font-weight: 500;
            color: var(--dark);
        }
        
        .category-btn.active {
            background-color: var(--primary);
            color: var(--white);
            border-color: var(--primary);
            transform: translateY(-2px);
        }
        
        .category-btn:hover {
            border-color: var(--primary-light);
            transform: translateY(-2px);
        }
        
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        @media (min-width: 1200px) {
            .products-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        @media (min-width: 768px) and (max-width: 1199px) {
            .products-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 767px) {
            .products-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .cart-icon {
                display: none;
            }
        }

        @media (max-width: 480px) {
            .products-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .product-card {
            background-color: var(--card-bg);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            border: 1px solid #e8f5e9;
            position: relative;
        }
        
        .product-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 8px 25px rgba(46,125,50,0.15);
        }
        
        .offer-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: linear-gradient(135deg, #ff6f00, #f57c00);
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.75rem;
            font-weight: bold;
            z-index: 10;
            box-shadow: 0 3px 10px rgba(255,111,0,0.3);
        }
        
        .promo-badge {
            position: absolute;
            top: 40px;
            right: 10px;
            background: linear-gradient(135deg, #4caf50, #2e7d32);
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.7rem;
            font-weight: bold;
            z-index: 10;
            box-shadow: 0 3px 10px rgba(46,125,50,0.3);
        }
        
        .product-image {
            height: 160px;
            background: linear-gradient(135deg, #e8f5e8, #c8e6c9);
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0.8rem;
            position: relative;
            overflow: hidden;
        }
        
        .product-image img {
            max-width: 100%;
            max-height: 130px;
            object-fit: contain;
            transition: transform 0.3s ease;
        }
        
        .product-card:hover .product-image img {
            transform: scale(1.05);
        }
        
        .product-info {
            padding: 1rem;
        }
        
        .product-name {
            font-weight: 600;
            margin-bottom: 0.4rem;
            font-size: 0.9rem;
            color: var(--dark);
            line-height: 1.3;
        }
        
        .product-price-container {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 0.5rem;
        }
        
        .original-price {
            color: var(--gray);
            text-decoration: line-through;
            font-size: 0.9rem;
        }
        
        .product-price {
            color: var(--secondary);
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        .discount-percent {
            background: #ffeb3b;
            color: #333;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: bold;
        }
        
        .product-stock {
            font-size: 0.75rem;
            margin-bottom: 0.8rem;
            font-weight: 500;
        }
        
        .in-stock {
            color: var(--primary-light);
        }
        
        .out-of-stock {
            color: var(--gray);
        }

        .low-stock {
            color: #ff9800;
            font-weight: bold;
        }
        
        .add-to-cart {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            border: none;
            padding: 0.7rem;
            border-radius: 8px;
            width: 100%;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .add-to-cart:hover {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary));
            transform: translateY(-2px);
        }
        
        .add-to-cart:disabled {
            background: var(--gray);
            cursor: not-allowed;
            transform: none;
        }

        .cart-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .cart-content {
            background-color: var(--white);
            width: 90%;
            max-width: 500px;
            border-radius: 15px;
            padding: 1.5rem;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow);
        }
        
        .cart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            border-bottom: 2px solid #e8f5e9;
            padding-bottom: 0.8rem;
        }
        
        .close-cart {
            background: none;
            border: none;
            font-size: 1.8rem;
            cursor: pointer;
            color: var(--gray);
            transition: color 0.3s;
        }
        
        .close-cart:hover {
            color: var(--primary);
        }
        
        .cart-items {
            margin-bottom: 1rem;
        }
        
        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.8rem 0;
            border-bottom: 1px solid #e8f5e9;
        }
        
        .cart-item-info {
            flex-grow: 1;
        }
        
        .cart-item-name {
            font-weight: bold;
            color: var(--dark);
        }
        
        .cart-item-price {
            color: var(--gray);
            font-size: 0.9rem;
        }
        
        .cart-item-quantity {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .quantity-btn {
            background-color: var(--light);
            border: 1px solid #c8e6c9;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .quantity-btn:hover {
            background-color: var(--primary-light);
            color: white;
        }
        
        .quantity-value {
            margin: 0 0.5rem;
            font-weight: bold;
            min-width: 20px;
            text-align: center;
        }
        
        .cart-total {
            font-weight: bold;
            font-size: 1.3rem;
            text-align: right;
            margin-bottom: 1rem;
            color: var(--primary);
            padding-top: 1rem;
            border-top: 2px solid #e8f5e9;
        }
        
        .total-savings {
            background: #4caf50;
            color: white;
            padding: 0.8rem;
            border-radius: 8px;
            margin: 0.5rem 0;
            text-align: center;
            font-weight: bold;
        }
        
        .send-order {
            background: linear-gradient(135deg, var(--secondary), var(--secondary-dark));
            color: white;
            border: none;
            padding: 1.2rem;
            border-radius: 10px;
            width: 100%;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .send-order:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255,111,0,0.3);
        }
        
        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--gray);
            font-size: 1.1rem;
        }
        
        .error-message {
            text-align: center;
            padding: 2rem;
            color: #d32f2f;
            background: #ffebee;
            border-radius: 10px;
            margin: 1rem 0;
            border-left: 4px solid #d32f2f;
        }
        
        .retry-btn {
            margin-top: 10px;
            padding: 10px 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.3s;
        }
        
        .retry-btn:hover {
            background: var(--primary-dark);
        }
        
        footer {
            background: linear-gradient(135deg, var(--dark), var(--primary));
            color: var(--white);
            padding: 2rem 1rem;
            text-align: center;
            margin-top: 3rem;
        }
        
        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
        }

        .admin-notification {
            background: linear-gradient(135deg, #ff9800, #f57c00);
            color: white;
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            text-align: center;
            animation: slideIn 0.5s ease;
        }

        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* PWA */
        .install-prompt {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 15px 20px;
            border-radius: 50px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            cursor: pointer;
            z-index: 1000;
            display: none;
            align-items: center;
            gap: 10px;
            font-weight: bold;
            font-size: 16px;
            animation: slideUp 0.5s ease;
            border: 2px solid white;
        }
        
        @keyframes slideUp {
            from { transform: translateY(100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .install-prompt:hover {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary));
            transform: scale(1.05);
        }
        
        .success-notification {
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: #4CAF50;
            color: white;
            padding: 15px 30px;
            border-radius: 50px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            z-index: 10000;
            font-weight: bold;
            text-align: center;
            animation: fadeInOut 3s ease;
        }
        
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
            20% { opacity: 1; transform: translateX(-50%) translateY(0); }
            80% { opacity: 1; transform: translateX(-50%) translateY(0); }
            100% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
        }

        /* FLOTANTE CELULAR */
        .floating-cart {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, var(--secondary), var(--secondary-dark));
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(255,111,0,0.4);
            z-index: 999;
            transition: all 0.3s ease;
            font-size: 1.5rem;
        }
        
        .floating-cart:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(255,111,0,0.6);
        }
        
        .floating-cart .cart-count {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--primary);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.8rem;
            font-weight: bold;
            border: 2px solid white;
        }

        .floating-search {
            position: fixed;
            bottom: 90px;
            right: 20px;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: none;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(46,125,50,0.4);
            z-index: 998;
            transition: all 0.3s ease;
            font-size: 1.5rem;
        }
        
        .floating-search:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(46,125,50,0.6);
        }

        .search-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1001;
            justify-content: center;
            align-items: flex-start;
            padding-top: 80px;
        }
        
        .search-modal-content {
            background-color: var(--white);
            width: 90%;
            max-width: 500px;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
        }
        
        .search-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            border-bottom: 2px solid #e8f5e9;
            padding-bottom: 0.8rem;
        }
        
        .close-search {
            background: none;
            border: none;
            font-size: 1.8rem;
            cursor: pointer;
            color: var(--gray);
            transition: color 0.3s;
        }
        
        .close-search:hover {
            color: var(--primary);
        }

        @media (max-width: 767px) {
            .search-container {
                display: none;
            }
            
            .floating-search {
                display: flex;
            }
        }

        .stock-notification {
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: #f44336;
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1002;
            font-weight: 500;
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from { transform: translateX(-50%) translateY(-20px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }
        
        .search-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            z-index: 1000;
            max-height: 300px;
            overflow-y: auto;
            display: none;
        }
        
        .suggestion-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
        }
        
        .suggestion-item:hover {
            background: #f5f5f5;
        }
        
        .suggestion-name {
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .suggestion-details {
            font-size: 0.8rem;
            color: #666;
        }
        
        .suggestion-badge {
            background: #ff9800;
            color: white;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 0.7rem;
        }

        .mobile-search-results {
            margin-top: 1rem;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .promo-limit {
            font-size: 0.7rem;
            color: #666;
            margin-bottom: 5px;
            font-style: italic;
        }
        
        .offer-description {
            font-size: 0.8rem;
            color: #ff6f00;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .limit-notification {
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: #ff9800;
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1002;
            font-weight: 500;
            animation: slideDown 0.3s ease;
        }
    </style>
</head>
<body>
<header>
    <div class="header-content">
        <div class="logo">
            <img src="iconos-pwa/android/android-launchericon-48-48.png" alt="Logo Almac√©n Copihue" class="logo-icon">
            Almac√©n Copihue
            <span id="adminBadge" class="admin-badge" style="display: none;">ADMIN</span>
        </div>
        <div class="cart-icon" id="cartIcon">
            üõí <span class="cart-count" id="cartCount">0</span>
        </div>
    </div>
</header>
    <div class="container">
        <div id="adminNotification" class="admin-notification" style="display: none;">
            <strong>üîî MODO ADMIN ACTIVADO</strong> - Recibir√°s alertas de stock bajo
        </div>

        <section class="hero">
            <h1>"Almac√©n Copihue"</h1>
            <p>Productos de calidad con la confianza de siempre</p>
        </section>

        <section class="info-bar">
            <div class="info-item">
                <strong>üìç Retiro en el local:</strong> Copihue 457
            </div>
            <div class="info-item">
                <strong>üìû WhatsApp:</strong> +5492944907380
            </div>
            <div class="info-item">
                <strong>‚è∞ Horario:</strong> 11:30 a 23:30 hrs.
            </div>
        </section>

        <div class="search-container" id="desktopSearch">
            <div class="search-wrapper">
                <input type="text" id="productSearch" class="search-input" 
                       placeholder="üîç Buscar productos por nombre, abreviatura o sin√≥nimo...">
                <button class="clear-search" id="clearSearchBtn">‚úñÔ∏è</button>
                <div id="searchSuggestions" class="search-suggestions"></div>
            </div>
        </div>

        <section class="categories" id="categories">
            <!-- Categor√≠as din√°micas -->
        </section>

        <section class="products-grid" id="productsGrid">
            <div class="loading">üîÑ Cargando productos desde Google Sheets...</div>
        </section>
    </div>

    <div class="floating-search" id="floatingSearch">
        üîç
    </div>

    <div class="floating-cart" id="floatingCart">
        üõí
        <span class="cart-count" id="floatingCartCount">0</span>
    </div>

    <div class="search-modal" id="searchModal">
        <div class="search-modal-content">
            <div class="search-modal-header">
                <h2>Buscar Productos</h2>
                <button class="close-search" id="closeSearch">&times;</button>
            </div>
            <div class="search-wrapper">
                <input type="text" id="mobileSearch" class="search-input" 
                       placeholder="üîç Escribe nombre, abreviatura o sin√≥nimo..."
                       onkeydown="handleMobileSearchEnter(event)">
                <button class="clear-search" id="clearMobileSearchBtn">‚úñÔ∏è</button>
            </div>
            <div class="mobile-search-results" id="mobileSearchResults">
                <!-- Resultados b√∫squeda m√≥vil -->
            </div>
        </div>
    </div>

    <div class="cart-modal" id="cartModal">
        <div class="cart-content">
            <div class="cart-header">
                <h2>Tu Pedido</h2>
                <button class="close-cart" id="closeCart">&times;</button>
            </div>
            <div class="cart-items" id="cartItems">
                <!-- Items del carrito -->
            </div>
            <div class="cart-total" id="cartTotal">Total: $0</div>
            <button class="send-order" id="sendOrder">Enviar Pedido por WhatsApp</button>
        </div>
    </div>

    <div class="install-prompt" id="installPrompt">
        <span>üì± Instalar App</span>
    </div>

    <div class="ios-instructions" id="iosInstructions" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 10000; justify-content: center; align-items: center; padding: 20px;">
        <div style="background: white; border-radius: 20px; padding: 30px; max-width: 400px; text-align: center;">
            <h2 style="color: #2e7d32; margin-bottom: 20px;">üì± Instalar en iPhone/iPad</h2>
            <div style="text-align: left; margin: 20px 0; font-size: 16px; line-height: 1.8;">
                <p>1. Toca el bot√≥n <strong style="color: #2e7d32;">Compartir</strong> üì§</p>
                <p>2. Despl√°zate hacia abajo</p>
                <p>3. Selecciona <strong style="color: #2e7d32;">"Agregar a Inicio"</strong></p>
                <p>4. Toca <strong style="color: #2e7d32;">"Agregar"</strong></p>
            </div>
            <button onclick="document.getElementById('iosInstructions').style.display='none'" 
                    style="background: #2e7d32; color: white; border: none; padding: 12px 30px; 
                           border-radius: 25px; font-size: 16px; font-weight: bold; cursor: pointer; 
                           margin-top: 10px; width: 100%;">
                Entendido
            </button>
        </div>
    </div>

    <footer>
        <div class="footer-content">
            <p>Almac√©n Copihue - Productos de calidad con la confianza de siempre</p>
            <p>üìç Copihue 457 | üìû +5492944907380 | ‚è∞ 11:30 a 23:30 hrs.</p>
        </div>
    </footer>

    <script>
        // ========== PWA INSTALACI√ìN ==========
        let deferredPrompt;
        const installPrompt = document.getElementById('installPrompt');
        
        function isPWAInstalled() {
            if (window.matchMedia('(display-mode: standalone)').matches) return true;
            if (window.navigator.standalone === true) return true;
            return false;
        }
        
        window.addEventListener('beforeinstallprompt', (e) => {
            if (isPWAInstalled()) return;
            
            e.preventDefault();
            deferredPrompt = e;
            
            setTimeout(() => {
                if (deferredPrompt && installPrompt && !isPWAInstalled()) {
                    installPrompt.style.display = 'flex';
                    
                    setTimeout(() => {
                        if (installPrompt.style.display !== 'none') {
                            installPrompt.style.display = 'none';
                        }
                    }, 30000);
                }
            }, 3000);
        });
        
        if (installPrompt) {
            installPrompt.addEventListener('click', async () => {
                if (/iPhone|iPad|iPod/.test(navigator.userAgent)) {
                    document.getElementById('iosInstructions').style.display = 'flex';
                    installPrompt.style.display = 'none';
                    return;
                }
                
                if (deferredPrompt) {
                    try {
                        deferredPrompt.prompt();
                        const choiceResult = await deferredPrompt.userChoice;
                        deferredPrompt = null;
                        installPrompt.style.display = 'none';
                        
                        if (choiceResult.outcome === 'accepted') {
                            showSuccessMessage('‚úÖ ¬°App instalada exitosamente!');
                        }
                    } catch (error) {
                        console.error('Error instalaci√≥n:', error);
                    }
                } else {
                    location.reload();
                }
            });
        }
        
        window.addEventListener('appinstalled', () => {
            if (installPrompt) installPrompt.style.display = 'none';
            deferredPrompt = null;
            showSuccessMessage('‚úÖ ¬°App instalada correctamente!');
        });
        
        function showSuccessMessage(message) {
            const notification = document.createElement('div');
            notification.className = 'success-notification';
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
        }
        
        function initPWA() {
            if (isPWAInstalled() && installPrompt) {
                installPrompt.style.display = 'none';
            }
        }

        // ========== DICCIONARIO B√öSQUEDA ==========
        const SEARCH_DICTIONARY = {
            'coca': ['coca cola', 'coca-cola', 'cocacola', 'cola'],
            'pepsi': ['pepsi cola', 'pepsi-cola', 'pepsicola'],
            'sprite': ['esprite', 'sprait'],
            'fanta': ['fanta naranja', 'fantas'],
            'cerveza': ['birra', 'chela', 'cervezas', 'birras'],
            'quilmes': ['quilmes', 'quilme'],
            'brahma': ['brahama', 'brama'],
            'heineken': ['heineken', 'hineken'],
            'vino': ['vinito', 'vinitos', 'vinos'],
            'agua': ['aguita', 'agua mineral', 'agua con gas'],
            'jugo': ['juguito', 'jugos', 'zumo', 'zumos'],
            'energizante': ['energ√©tico', 'energetico', 'monster', 'red bull'],
            'azucar': ['az√∫car', 'azuquita', 'azucar blanca'],
            'arroz': ['arro', 'arrozz', 'arros'],
            'fideo': ['fideos', 'fideitos', 'pastas', 'pasta'],
            'aceite': ['aceite girasol', 'aceite oliva', 'aceites'],
            'sal': ['sal fina', 'sal gruesa', 'sal marina'],
            'harina': ['harina 0000', 'harina leudante', 'harinas'],
            'yerba': ['yerba mate', 'yerbas', 'mate'],
            'te': ['t√©', 'te negro', 'te verde', 'tes'],
            'cafe': ['caf√©', 'cafecito', 'caf√©s'],
            'leche': ['leche entera', 'leche descremada', 'leches'],
            'galletas': ['galletitas', 'galleta', 'galletas dulces'],
            'pan': ['pan lactal', 'pan de molde', 'panes'],
            'papas': ['papas fritas', 'papitas', 'patatas', 'chips'],
            'chizitos': ['chicitos', 'chizito', 'snack'],
            'palitos': ['palitos salados', 'palitos queso'],
            'mani': ['man√≠', 'mani salado', 'manises'],
            'chocolate': ['chocolates', 'chocolat√≠n', 'tableta'],
            'caramelos': ['caramelitos', 'golosinas', 'golosina', 'dulces'],
            'alfajor': ['alfajores', 'alfajorcito', 'alfajorcitos'],
            'jabon': ['jab√≥n', 'jabones', 'jaboncito'],
            'lavandina': ['cloro', 'lavandina concentrada'],
            'detergente': ['detergente l√≠quido', 'detergentes'],
            'limpiador': ['limpia pisos', 'limpia vidrios', 'limpiadores'],
            'papel': ['papel higi√©nico', 'papelitos', 'rollos'],
            'shampoo': ['champ√∫', 'shampoo', 'shampoos'],
            'queso': ['quesos', 'quesito', 'quesillo'],
            'manteca': ['mantequilla', 'manteca', 'mantequilla'],
            'yogur': ['yogurt', 'yogures', 'yogurth'],
            'crema': ['crema de leche', 'cremita'],
            'helado': ['helados', 'heladito', 'postre helado'],
            'pizza': ['pizzas', 'pizzeta', 'pizzetas'],
            'hamburguesa': ['hamburguesas', 'burguer', 'burgers'],
            'l': ['litro', 'lt', 'lts', 'litros'],
            'ml': ['mililitros', 'mililitro'],
            'kg': ['kilo', 'kilos', 'kilogramo'],
            'g': ['gramo', 'gramos', 'gr', 'grs'],
            'un': ['unidad', 'unidades', 'uni', 'unid'],
            'pkg': ['paquete', 'pack', 'packs', 'paquetes'],
            'caja': ['cajita', 'cajas', 'caj√≥n'],
            'c/u': ['cada uno', 'cada unidad'],
            'grande': ['big', 'large', 'xl', 'extragrande'],
            'chico': ['peque√±o', 'peque√±a', 'peque', 'chiquito'],
            'medio': ['mediano', 'medium', 'md'],
            'promo': ['oferta', 'promoci√≥n', 'promocion', 'descuento'],
            'combo': ['pack', 'lote', 'conjunto'],
            '2x1': ['dos por uno', 'doble', 'dosxuno'],
            '3x2': ['tres por dos', 'tresxdos'],
            'marolio': ['marol', 'marolios'],
            'sancor': ['sanc', 'sancors'],
            'la serenisima': ['seren√≠sima', 'serenisima', 'laserenisima'],
            'arcor': ['arc', 'arcors'],
            'bagley': ['bagle', 'bagleys'],
            'terrabusi': ['terrabus', 'terrabusis'],
            'lista': ['listo para', 'preparado', 'instant√°neo'],
            'instantaneo': ['instant√°neo', 'r√°pido', 'express'],
            'natural': ['org√°nico', 'org√°nico', 'bio', 'ecol√≥gico']
        };

        // ========== SISTEMA DE OFERTAS SUPER SIMPLE ==========
        const OFERTAS_SISTEMA = {
            // OFERTAS1 = 1 ‚Üí 10% FIJO siempre
            '1': { 
                nombre: "10% OFF",
                descuentos: [0.10],
                minUnidad: 1,
                maxUnidades: null
            },
            // OFERTAS1 = 2 ‚Üí 10% 1u, 20% 2u+
            '2': { 
                nombre: "10-20% OFF",
                descuentos: [0.10, 0.20],
                minUnidad: 2,
                maxUnidades: null
            },
            // OFERTAS1 = 3 ‚Üí 10% 1u, 20% 2u, 30% 3u+
            '3': { 
                nombre: "10-30% OFF",
                descuentos: [0.10, 0.20, 0.30],
                minUnidad: 3,
                maxUnidades: 10
            },
            // OFERTAS1 = 4 ‚Üí 10% 1u, 20% 2u, 30% 3u, 40% 4u+
            '4': { 
                nombre: "10-40% OFF",
                descuentos: [0.10, 0.20, 0.30, 0.40],
                minUnidad: 4,
                maxUnidades: 6
            },
            // OFERTAS1 = 5 ‚Üí 10% 1u, 20% 2u, 30% 3u, 40% 4u, 50% 5u+
            '5': { 
                nombre: "10-50% OFF",
                descuentos: [0.10, 0.20, 0.30, 0.40, 0.50],
                minUnidad: 5,
                maxUnidades: 6
            }
        };

        // ========== FUNCIONES PARA L√çMITES DE OFERTAS2 ==========
        function obtenerLimiteOfertas2(ofertas2) {
            if (!ofertas2 || ofertas2 === '') return null;
            
            const porcentaje = parseInt(ofertas2);
            if (isNaN(porcentaje)) return null;
            
            // Reglas de l√≠mites para descuentos altos
            if (porcentaje >= 70 && porcentaje <= 99) {
                return 3; // Para descuentos MUY altos (70-99%)
            } else if (porcentaje >= 50 && porcentaje <= 69) {
                return 5; // Para descuentos altos (50-69%)
            }
            
            return null; // Sin l√≠mite para descuentos < 50%
        }

        function obtenerTextoLimiteOfertas2(ofertas2) {
            const limite = obtenerLimiteOfertas2(ofertas2);
            if (limite === null) return '';
            
            return `‚ö†Ô∏è M√°x. ${limite} unidades por grupo familiar (oferta especial)`;
        }

        // ========== VARIABLES GLOBALES ==========
        const SHEET_ID = '1hKeM-13t6wyGD5Ya4Rx9NeUJXsgJoVN4dOb-rklPznA';
        let products = [];
        let cart = [];
        let currentCategory = "TODOS";
        let lowStockAlertSent = false;
        let esAdmin = false;
        let isSearching = false;

        // ========== ELEMENTOS DOM ==========
        const categoriesContainer = document.getElementById("categories");
        const productsGrid = document.getElementById("productsGrid");
        const cartIcon = document.getElementById("cartIcon");
        const floatingCart = document.getElementById("floatingCart");
        const floatingSearch = document.getElementById("floatingSearch");
        const searchModal = document.getElementById("searchModal");
        const closeSearch = document.getElementById("closeSearch");
        const mobileSearch = document.getElementById("mobileSearch");
        const mobileSearchResults = document.getElementById("mobileSearchResults");
        const cartModal = document.getElementById("cartModal");
        const closeCart = document.getElementById("closeCart");
        const cartItems = document.getElementById("cartItems");
        const cartTotal = document.getElementById("cartTotal");
        const cartCount = document.getElementById("cartCount");
        const floatingCartCount = document.getElementById("floatingCartCount");
        const sendOrder = document.getElementById("sendOrder");
        const adminBadge = document.getElementById("adminBadge");
        const adminNotification = document.getElementById("adminNotification");
        const productSearch = document.getElementById("productSearch");
        const clearSearchBtn = document.getElementById("clearSearchBtn");
        const clearMobileSearchBtn = document.getElementById("clearMobileSearchBtn");
        const searchSuggestions = document.getElementById("searchSuggestions");

        // ========== FUNCIONES PRINCIPALES ==========
        window.handleMobileSearchEnter = function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const searchTerm = mobileSearch.value.trim();
                if (searchTerm.length >= 2) {
                    filterMobileProducts(searchTerm);
                    mobileSearch.blur();
                }
            }
        };

        // ‚úÖ FUNCI√ìN PRINCIPAL - CALCULAR PRECIO CON DESCUENTO (REDONDEO A FAVOR DEL CLIENTE)
        function calcularPrecioConDescuento(precioOriginal, ofertas1, ofertas2, cantidad) {
            // ‚úÖ PRIORIDAD 1: OFERTAS2 (10-99 = % directo)
            if (ofertas2 !== undefined && ofertas2 !== null && ofertas2 !== '') {
                const porcentaje = parseInt(ofertas2);
                if (!isNaN(porcentaje) && porcentaje >= 10 && porcentaje <= 99) {
                    // Verificar l√≠mite para ofertas altas
                    const limiteOferta2 = obtenerLimiteOfertas2(ofertas2);
                    if (limiteOferta2 !== null && cantidad > limiteOferta2) {
                        cantidad = limiteOferta2;
                    }
                    
                    const descuento = porcentaje / 100;
                    const precioDescuento = precioOriginal - (precioOriginal * descuento);
                    return Math.floor(precioDescuento / 100) * 100; // REDONDEO A FAVOR DEL CLIENTE
                }
                if (porcentaje === 0) {
                    return precioOriginal; // 0 = sin oferta
                }
            }
            
            // ‚úÖ PRIORIDAD 2: OFERTAS1 (1-5 = escalonado)
            if (ofertas1 !== undefined && ofertas1 !== null && ofertas1 !== '') {
                const ofertaNum = parseInt(ofertas1);
                if (!isNaN(ofertaNum) && ofertaNum >= 1 && ofertaNum <= 5) {
                    const oferta = OFERTAS_SISTEMA[ofertaNum.toString()];
                    if (!oferta) return precioOriginal;
                    
                    // Verificar l√≠mite de unidades
                    if (oferta.maxUnidades !== null && cantidad > oferta.maxUnidades) {
                        cantidad = oferta.maxUnidades;
                    }
                    
                    // Determinar qu√© descuento aplicar
                    let descuentoAplicar;
                    if (cantidad >= oferta.descuentos.length) {
                        descuentoAplicar = oferta.descuentos[oferta.descuentos.length - 1];
                    } else if (cantidad > 0) {
                        descuentoAplicar = oferta.descuentos[cantidad - 1];
                    } else {
                        descuentoAplicar = 0; // Para cantidad 0
                    }
                    
                    const precioDescuento = precioOriginal - (precioOriginal * descuentoAplicar);
                    return Math.floor(precioDescuento / 100) * 100; // REDONDEO A FAVOR DEL CLIENTE
                }
            }
            
            // Sin oferta
            return precioOriginal;
        }

        // ‚úÖ FUNCI√ìN PARA ENVIAR PEDIDO POR WHATSAPP (VERSI√ìN MEJORADA)
        function sendOrderViaWhatsApp() {
            if (cart.length === 0) {
                alert("Tu carrito est√° vac√≠o.");
                return;
            }
            
            const phoneNumber = "5492944907380";
            
            let totalNormal = 0;
            let totalFinal = 0;
            let totalSavings = 0;
            let orderDetails = [];

            // Calcular todos los detalles
            cart.forEach(item => {
                const product = products.find(p => p.id === item.id);
                if (!product) return;
                
                const itemNormal = product.price * item.quantity;
                const itemFinal = item.price * item.quantity;
                const itemSavings = itemNormal - itemFinal;
                const ahorroPorUnidad = product.price - item.price;
                
                // CALCULAR PORCENTAJE REAL (post-redondeo)
                let porcentajeAhorro = 0;
                if (ahorroPorUnidad > 0 && product.price > 0) {
                    porcentajeAhorro = Math.round((ahorroPorUnidad / product.price) * 100);
                }
                
                totalNormal += itemNormal;
                totalFinal += itemFinal;
                totalSavings += itemSavings;
                
                orderDetails.push({
                    name: item.name,
                    quantity: item.quantity,
                    priceOriginal: product.price,
                    priceFinal: item.price,
                    subtotal: itemFinal,
                    ahorroUnidad: ahorroPorUnidad,
                    ahorroTotal: itemSavings,
                    porcentaje: porcentajeAhorro,
                    tieneOferta: ahorroPorUnidad > 0
                });
            });

            // FORMATO MEJORADO DE WHATSAPP
            let message = `‚ú¶ *PEDIDO*\n\n`;
            
            // PRODUCTOS PRINCIPALES
            orderDetails.forEach(item => {
                const emoji = item.tieneOferta ? "ü§ë" : "‚úÖ";
                message += `${emoji} ${item.name} (${item.quantity}u): $${item.priceFinal} c/u\n`;
            });
            
            message += `\n‚ú¶ *TOTAL SIN OFERTAS*\n`;
            message += `$${totalNormal.toFixed(0)}\n\n`;
            
            // SECCI√ìN DE OFERTAS (solo si hay)
            if (totalSavings > 0) {
                message += `‚ú¶ *OFERTAS APLICADAS*\n\n`;
                
                orderDetails.forEach(item => {
                    if (item.tieneOferta) {
                        message += `üéØ ${item.name}\n`;
                        message += `Antes: $${item.priceOriginal} ‚Üí Ahora: $${item.priceFinal}\n`;
                        message += `Ahorro: $${item.ahorroUnidad} c/u (${item.porcentaje}% OFF)\n`;
                        message += `Ahorrado √ó ${item.quantity}u: $${item.ahorroTotal}\n\n`;
                    }
                });
                
                // TOTAL AHORRADO CON PORCENTAJE REAL
                const porcentajeTotalAhorro = Math.round((totalSavings / totalNormal) * 100);
                message += `‚ú¶ *TOTAL AHORRADO*\n`;
                message += `$${totalSavings.toFixed(0)} (${porcentajeTotalAhorro}% OFF)\n\n`;
            }
            
            // TOTAL A PAGAR
            message += `‚ú¶ *TOTAL A PAGAR*\n`;
            message += `*$${totalFinal.toFixed(0)}*\n\n`;
            
            // INFORMACI√ìN DEL LOCAL
            message += `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n`;
            message += `üìç Copihue 457\n`;
            message += `‚è∞ 11:30 a 23:30 hrs.\n`;
            message += `üìû +5492944907380\n\n`;
            
            // MENSAJE SOBRE REDONDEO (solo si hay ahorro)
            if (totalSavings > 0) {
                message += `‚ú® *Precios redondeados a tu favor*\n`;
            }
            
            message += `üõí Pedido desde app`;
            
            const encodedMessage = encodeURIComponent(message);
            const whatsappURL = `https://wa.me/${phoneNumber}?text=${encodedMessage}`;
            window.open(whatsappURL, "_blank");

            closeCartModal();
            cart = [];
            updateCartCount();
        }

        // ========== B√öSQUEDA ==========
        function normalizeSearchTerm(term) {
            let normalized = term.toLowerCase().trim();
            normalized = normalized.replace(/[^\w\s]/g, ' ');
            normalized = normalized.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            normalized = normalized.replace(/\s+/g, ' ');
            return normalized;
        }

        function expandSearchTerms(searchTerm) {
            const normalizedTerm = normalizeSearchTerm(searchTerm);
            const words = normalizedTerm.split(' ');
            const expandedTerms = new Set();
            
            expandedTerms.add(normalizedTerm);
            
            words.forEach(word => {
                if (word.length < 2) return;
                
                expandedTerms.add(word);
                
                for (const [key, synonyms] of Object.entries(SEARCH_DICTIONARY)) {
                    if (key === word) {
                        synonyms.forEach(synonym => expandedTerms.add(synonym));
                    }
                    
                    if (synonyms.includes(word)) {
                        expandedTerms.add(key);
                        synonyms.forEach(synonym => expandedTerms.add(synonym));
                    }
                }
            });
            
            if (words.length > 1) {
                expandedTerms.add(words.join(''));
                expandedTerms.add(words.join('-'));
                
                if (words.length === 2) {
                    expandedTerms.add(`${words[1]} ${words[0]}`);
                }
            }
            
            return Array.from(expandedTerms);
        }

        function searchProducts(searchTerm) {
            if (!products || products.length === 0) return [];
            if (searchTerm.length < 2) return [];
            
            const expandedTerms = expandSearchTerms(searchTerm);
            
            const results = products.filter(product => {
                const productName = normalizeSearchTerm(product.name);
                const hasStock = product.stock === "STOCK" || product.stockNumber > 0;
                
                if (!hasStock) return false;
                
                return expandedTerms.some(term => {
                    if (productName.includes(term) && term.length > 1) return true;
                    
                    if (term.length <= 3 && term.length > 1) {
                        const initials = productName.split(' ')
                            .map(word => word.charAt(0))
                            .join('');
                        if (initials.includes(term)) return true;
                    }
                    
                    if (term.length > 3) {
                        if (productName.includes(term.substring(0, Math.max(3, term.length - 1)))) {
                            return true;
                        }
                    }
                    
                    return false;
                });
            });
            
            results.sort((a, b) => {
                const nameA = normalizeSearchTerm(a.name);
                const nameB = normalizeSearchTerm(b.name);
                
                const exactMatchA = expandedTerms.some(term => nameA === term);
                const exactMatchB = expandedTerms.some(term => nameB === term);
                
                if (exactMatchA && !exactMatchB) return -1;
                if (!exactMatchA && exactMatchB) return 1;
                
                if (a.stockNumber !== b.stockNumber) {
                    return b.stockNumber - a.stockNumber;
                }
                
                if (a.hasPromo !== b.hasPromo) {
                    return b.hasPromo - a.hasPromo;
                }
                
                return 0;
            });
            
            return results;
        }

        // ========== CARGA DE PRODUCTOS ==========
        async function loadProductsFromSheets() {
            try {
                productsGrid.innerHTML = '<div class="loading">üîÑ Cargando productos...</div>';

                const PROXY_URL = 'https://corsproxy.io/?';
                const sheetNames = ['inventario', 'Inventario', 'Stock', 'stock'];
                let response = null;
                let csvText = '';

                for (let i = 0; i < sheetNames.length; i++) {
                    let sheet = sheetNames[i];
                    let SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheet)}&_cb=${Date.now()}`;
                    let URL_CON_PROXY = PROXY_URL + encodeURIComponent(SHEET_URL);
                    console.log('Intentando with sheet:', sheet, URL_CON_PROXY);

                    try {
                        response = await fetch(URL_CON_PROXY);
                        if (response && response.ok) {
                            csvText = await response.text();
                            if (csvText && csvText.trim() !== '') {
                                console.log('CSV obtenido desde hoja:', sheet);
                                break;
                            }
                        }
                    } catch (errFetch) {
                        console.warn('Error fetching sheet', sheet, errFetch);
                    }
                }

                if (!csvText || csvText.trim() === '') {
                    throw new Error('No se pudo obtener CSV v√°lido.');
                }

                processCSVData(csvText);
            } catch (error) {
                console.error('Error en loadProductsFromSheets:', error);
                loadBackupProducts();
            }
        }

        function processCSVData(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim() !== '');
            
            if (lines.length < 2) {
                throw new Error('No hay suficientes datos en el Sheets');
            }
            
            const headers = parseCSVLine(lines[0]);
            const stockColumnIndex = findStockColumn(headers);
            const ofertas1ColumnIndex = findColumnByName(headers, ['ofertas1', 'oferta1', 'oferta']);
            const ofertas2ColumnIndex = findColumnByName(headers, ['ofertas2', 'oferta2', 'porcentaje']);
            const priceColumnIndex = findPriceColumn(headers);
            
            products = lines.slice(1).map((line, index) => {
                const values = parseCSVLine(line);
                if (values.length < 2) return null;
                
                const nombreProducto = values[0] || '';
                const nombreImagen = simplificarNombre(nombreProducto) + '.jpg';
                
                let stock = "";
                let stockNumber = 0;
                
                if (stockColumnIndex !== -1 && values[stockColumnIndex] !== undefined) {
                    const stockValue = values[stockColumnIndex].toString().trim();
                    stockNumber = parseInt(stockValue) || 0;
                    
                    if (stockNumber > 10) {
                        stock = "STOCK";
                    } else if (stockNumber > 0 && stockNumber <= 10) {
                        stock = "STOCK BAJO";
                    } else {
                        stock = "SIN STOCK";
                    }
                }
                
                // Obtener valores de ofertas
                let ofertas1 = '';
                let ofertas2 = '';
                
                if (ofertas1ColumnIndex !== -1 && values[ofertas1ColumnIndex] !== undefined) {
                    ofertas1 = values[ofertas1ColumnIndex].toString().trim();
                }
                
                if (ofertas2ColumnIndex !== -1 && values[ofertas2ColumnIndex] !== undefined) {
                    ofertas2 = values[ofertas2ColumnIndex].toString().trim();
                }
                
                // Obtener precio
                let price = 0;
                if (priceColumnIndex !== -1 && values[priceColumnIndex] !== undefined) {
                    price = parseInt(values[priceColumnIndex]) || 0;
                } else if (values.length > 1) {
                    price = parseInt(values[1]) || 0;
                }
                
                // Calcular precios CON REDONDEO A FAVOR DEL CLIENTE
                const precioConDescuento = calcularPrecioConDescuento(price, ofertas1, ofertas2, 1);
                
                // Calcular descuento REAL (post-redondeo)
                const descuentoReal = price > precioConDescuento 
                    ? Math.round(((price - precioConDescuento) / price) * 100)
                    : 0;
                
                const textoOferta = descuentoReal > 0 ? `${descuentoReal}% OFF` : '';
                const tieneOferta = descuentoReal > 0;
                
                // Calcular l√≠mites de ofertas2
                const limiteOfertas2 = obtenerLimiteOfertas2(ofertas2);
                const textoLimiteOfertas2 = obtenerTextoLimiteOfertas2(ofertas2);
                
                return {
                    id: index + 1,
                    name: nombreProducto,
                    price: price,
                    category: values[2] || 'ALMACEN',
                    description: values[3] || '',
                    image: `imagenes-productos/${nombreImagen}`,
                    stock: stock,
                    stockNumber: stockNumber,
                    nombreArchivo: nombreImagen,
                    hasPromo: tieneOferta,
                    ofertas1: ofertas1,
                    ofertas2: ofertas2,
                    discountedPrice: precioConDescuento,
                    discountPercent: descuentoReal, // DESCUENTO REAL (no te√≥rico)
                    offerText: textoOferta,
                    ofertaDetalles: ofertas1 ? OFERTAS_SISTEMA[ofertas1] : null,
                    limiteOfertas2: limiteOfertas2,
                    textoLimiteOfertas2: textoLimiteOfertas2
                };
            }).filter(product => product && product.name && product.name.trim() !== '');
            
            if (products.length === 0) {
                throw new Error('No se pudieron cargar productos v√°lidos');
            }
            
            renderCategories();
            renderProducts();
        }

        function findStockColumn(headers) {
            const stockKeywords = ['stock', 'inventario', 'cantidad', 'disponible', 'existencia'];
            
            for (let i = 0; i < headers.length; i++) {
                const header = headers[i].toLowerCase().trim();
                if (stockKeywords.some(keyword => header.includes(keyword))) {
                    return i;
                }
            }
            
            return headers.length > 4 ? 4 : -1;
        }

        function findColumnByName(headers, possibleNames) {
            for (let i = 0; i < headers.length; i++) {
                const header = headers[i].toLowerCase().trim();
                if (possibleNames.some(name => header.includes(name))) {
                    return i;
                }
            }
            return -1;
        }

        function findPriceColumn(headers) {
            const priceKeywords = ['precio', 'valor', 'costo', 'importe'];
            
            for (let i = 0; i < headers.length; i++) {
                const header = headers[i].toLowerCase().trim();
                if (priceKeywords.some(keyword => header.includes(keyword))) {
                    return i;
                }
            }
            
            return 1;
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current.trim());
            return result.map(field => field.replace(/^"|"$/g, ''));
        }

        function simplificarNombre(nombre) {
            return nombre
                .toLowerCase()
                .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
                .replace(/[^a-z0-9 ]/g, "")
                .replace(/\s+/g, '-')
                .replace(/-+/g, '-')
                .trim();
        }

        function loadBackupProducts() {
            products = [
                { 
                    id: 1, 
                    name: "CERVEZA QUILMES CLASICA 473CC - OFERTA 1", 
                    price: 3500,
                    category: "BEBIDAS", 
                    stock: "STOCK", 
                    stockNumber: 8,
                    image: "imagenes-productos/cerveza-quilmes-1l.jpg",
                    hasPromo: true,
                    ofertas1: "1",
                    ofertas2: "",
                    discountedPrice: calcularPrecioConDescuento(3500, "1", "", 1),
                    discountPercent: Math.round(((3500 - calcularPrecioConDescuento(3500, "1", "", 1)) / 3500) * 100),
                    offerText: `${Math.round(((3500 - calcularPrecioConDescuento(3500, "1", "", 1)) / 3500) * 100)}% OFF`,
                    ofertaDetalles: OFERTAS_SISTEMA["1"],
                    limiteOfertas2: null,
                    textoLimiteOfertas2: ""
                },
                { 
                    id: 2, 
                    name: "CERVEZA BUDWEISER 710CC - 25%", 
                    price: 4500,
                    category: "BEBIDAS", 
                    stock: "STOCK BAJO", 
                    stockNumber: 3,
                    image: "imagenes-productos/cerveza-budweiser-710cc.jpg",
                    hasPromo: true,
                    ofertas1: "",
                    ofertas2: "25",
                    discountedPrice: calcularPrecioConDescuento(4500, "", "25", 1),
                    discountPercent: 25,
                    offerText: "25% OFF",
                    ofertaDetalles: null,
                    limiteOfertas2: null,
                    textoLimiteOfertas2: ""
                },
                { 
                    id: 3, 
                    name: "ARROZ 1 KG MOLINOS ALA NO SE PASA", 
                    price: 4500,
                    category: "ALMACEN", 
                    stock: "STOCK", 
                    stockNumber: 4,
                    image: "imagenes-productos/arroz-1kg.jpg",
                    hasPromo: true,
                    ofertas1: "5",
                    ofertas2: "",
                    discountedPrice: calcularPrecioConDescuento(4500, "5", "", 1),
                    discountPercent: Math.round(((4500 - calcularPrecioConDescuento(4500, "5", "", 1)) / 4500) * 100),
                    offerText: `${Math.round(((4500 - calcularPrecioConDescuento(4500, "5", "", 1)) / 4500) * 100)}% OFF`,
                    ofertaDetalles: OFERTAS_SISTEMA["5"],
                    limiteOfertas2: null,
                    textoLimiteOfertas2: ""
                }
            ];
            
            renderCategories();
            renderProducts();
            
            productsGrid.innerHTML = `
                <div class="demo-notification" style="background: #e3f2fd; padding: 1rem; border-radius: 10px; margin-bottom: 1rem; text-align: center; border-left: 4px solid #2196f3;">
                    <strong>üîß Modo Demo Activado</strong>
                    <br>
                    <small>Usando datos de ejemplo. Cuando tu Google Sheets est√© listo, se conectar√°n autom√°ticamente.</small>
                    <br>
                    <small><strong>üéØ SISTEMA SIMPLIFICADO FUNCIONANDO:</strong></small><br>
                    <small>‚úÖ OFERTAS1: 1=10%, 2=10-20%, 3=10-30%, 4=10-40%, 5=10-50%</small><br>
                    <small>‚úÖ OFERTAS2: N√∫mero 10-99 = % directo (prioridad)</small><br>
                    <small>‚úÖ L√≠mites: 3 (m√°x 10u), 4-5 (m√°x 6u) por grupo familiar</small><br>
                    <small>‚úÖ Redondeo a favor del cliente activado</small><br>
                    <small>‚úÖ Descuento REAL mostrado (post-redondeo)</small>
                </div>
                ${productsGrid.innerHTML}
            `;
        }

        // ========== MENSAJES TEMPORADA ==========
        function obtenerMensajeEstacional() {
            const hoy = new Date();
            const mes = hoy.getMonth() + 1;
            const dia = hoy.getDate();

            if (mes === 1 && dia <= 5) return "¬°Feliz A√±o Nuevo! üéâ Gracias por comprar con nosotros.";
            if (mes === 1) return "Arrancando el a√±o con toda la energ√≠a üí™.";
            if (mes === 4 && dia <= 10) return "¬°Felices Pascuas! üê£ Gracias por elegirnos.";
            if (mes === 5 && dia === 25) return "¬°Feliz 25 de Mayo! üá¶üá∑.";
            if (mes === 6 && dia >= 10 && dia <= 20) return "¬°Feliz D√≠a del Padre! ‚ù§Ô∏è.";
            if (mes === 7) return "Vacaciones de invierno ‚ùÑÔ∏è ¬°Abrigate bien!";
            if (mes === 8 && dia >= 10 && dia <= 25) return "¬°Feliz D√≠a de las Infancias! üéà.";
            if (mes === 9 && dia >= 21 && dia <= 25) return "¬°Feliz Primavera! üå∏.";
            if (mes === 10 && dia >= 10 && dia <= 20) return "¬°Feliz D√≠a de la Madre! üíê.";
            if (mes === 12 && dia >= 1 && dia <= 24) return "¬°Se viene Navidad! üéÑ Gracias por elegirnos.";
            if (mes === 12 && dia === 25) return "¬°Feliz Navidad! üéÑ.";
            if (mes === 12 && dia >= 26) return "Cerrando el a√±o üéÜ ¬°Gracias por estar con nosotros!";

            return "Gracias por elegirnos üôå.";
        }

        // ========== INTERFAZ ==========
        function init() {
            detectarAdmin();
            loadProductsFromSheets();
            setupEventListeners();
            setupSearch();
            updateCartCount();
            initPWA();
        }

        function detectarAdmin() {
            const urlParams = new URLSearchParams(window.location.search);
            esAdmin = urlParams.has('admin');
            
            if (esAdmin) {
                adminBadge.style.display = 'inline-block';
                adminNotification.style.display = 'block';
            }
        }

        function setupEventListeners() {
            cartIcon.addEventListener("click", openCart);
            floatingCart.addEventListener("click", openCart);
            floatingSearch.addEventListener("click", openSearchModal);
            closeSearch.addEventListener("click", closeSearchModal);
            closeCart.addEventListener("click", closeCartModal);
            sendOrder.addEventListener("click", sendOrderViaWhatsApp);
            
            clearSearchBtn.addEventListener("click", clearSearch);
            clearMobileSearchBtn.addEventListener("click", clearMobileSearch);
            
            cartModal.addEventListener("click", function(e) {
                if (e.target === cartModal) {
                    closeCartModal();
                }
            });
            
            searchModal.addEventListener("click", function(e) {
                if (e.target === searchModal) {
                    closeSearchModal();
                }
            });
        }

        function setupSearch() {
            productSearch.addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase().trim();
                toggleClearButton(clearSearchBtn, searchTerm);
                
                if (searchTerm === '') {
                    clearSearch();
                    return;
                }
                
                if (searchTerm.length >= 2) {
                    filterProducts(searchTerm);
                }
            });
            
            productSearch.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const searchTerm = this.value.trim();
                    if (searchTerm.length >= 2) {
                        filterProducts(searchTerm);
                    }
                }
            });
            
            mobileSearch.addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase().trim();
                toggleClearButton(clearMobileSearchBtn, searchTerm);
                
                if (searchTerm === '') {
                    mobileSearchResults.innerHTML = '';
                    return;
                }
                
                if (searchTerm.length >= 2) {
                    filterMobileProducts(searchTerm);
                }
            });
        }

        function toggleClearButton(button, searchTerm) {
            button.style.display = searchTerm.length > 0 ? 'block' : 'none';
        }

        function openSearchModal() {
            searchModal.style.display = "flex";
            mobileSearch.focus();
            mobileSearchResults.innerHTML = '';
        }

        function closeSearchModal() {
            searchModal.style.display = "none";
            mobileSearch.value = '';
            mobileSearchResults.innerHTML = '';
            clearMobileSearchBtn.style.display = 'none';
        }

        function clearMobileSearch() {
            mobileSearch.value = '';
            mobileSearchResults.innerHTML = '';
            clearMobileSearchBtn.style.display = 'none';
        }

        function filterProducts(searchTerm) {
            if (!products || products.length === 0) return;
            
            isSearching = true;
            const filtered = searchProducts(searchTerm);
            renderFilteredProducts(filtered, searchTerm);
        }

        function filterMobileProducts(searchTerm) {
            if (!products || products.length === 0) return;
            
            const filtered = searchProducts(searchTerm);
            
            if (filtered.length === 0) {
                mobileSearchResults.innerHTML = `
                    <div style="text-align: center; padding: 1rem; color: #666;">
                        üîç No se encontraron productos para "<strong>${searchTerm}</strong>"
                    </div>
                `;
                return;
            }
            
            let resultsHTML = '<div style="display: grid; gap: 1rem;">';
            
            filtered.forEach(product => {
                const hasStock = product.stock === "STOCK" || product.stockNumber > 0;
                const isLowStock = product.stockNumber > 0 && product.stockNumber <= 3;
                const isOutOfStock = product.stockNumber === 0;
                
                let stockText = '';
                let stockClass = '';
                
                if (isOutOfStock) {
                    stockText = '‚ùå Sin Stock';
                    stockClass = 'out-of-stock';
                } else if (isLowStock) {
                    stockText = `‚ö†Ô∏è Stock Bajo (${product.stockNumber})`;
                    stockClass = 'low-stock';
                } else {
                    stockText = `‚úÖ En Stock (${product.stockNumber})`;
                    stockClass = 'in-stock';
                }
                
                const addButton = isOutOfStock 
                    ? `<button class="add-to-cart" disabled>‚ùå Sin Stock</button>`
                    : `<button class="add-to-cart" data-id="${product.id}">üõí Agregar al Carrito</button>`;
                
                const offerBadge = product.hasPromo && product.offerText 
                    ? `<div class="offer-badge">${product.offerText}</div>`
                    : '';
                
                const descripcionOferta = product.ofertas1 ? obtenerDescripcionOferta(product.ofertas1) : '';
                
                resultsHTML += `
                    <div class="product-card" style="margin: 0;">
                        ${offerBadge}
                        <div class="product-image">
                            <img src="${product.image}" 
                                 alt="${product.name}"
                                 onerror="handleImageError(this, '${product.name.replace(/'/g, "\\'")}')">
                        </div>
                        <div class="product-info">
                            <div class="product-name">${product.name}</div>
                            ${descripcionOferta ? `<div class="offer-description">${descripcionOferta}</div>` : ''}
                            <div class="product-price-container">
                                ${product.hasPromo && product.discountedPrice < product.price ? 
                                    `<span class="original-price">$${product.price}</span>` : ''}
                                <span class="product-price">$${product.discountedPrice}</span>
                                ${product.hasPromo && product.discountPercent > 0 ? 
                                    `<span class="discount-percent">${product.offerText}</span>` : ''}
                            </div>
                            ${product.ofertaDetalles && product.ofertaDetalles.maxUnidades !== null ? `
                                <div class="promo-limit">
                                    ‚ö†Ô∏è M√°x. ${product.ofertaDetalles.maxUnidades} unidades por grupo familiar
                                </div>
                            ` : ''}
                            ${product.textoLimiteOfertas2 ? `
                                <div class="promo-limit" style="color: #ff6f00;">
                                    ${product.textoLimiteOfertas2}
                                </div>
                            ` : ''}
                            <div class="product-stock ${stockClass}">
                                ${stockText}
                            </div>
                            ${addButton}
                        </div>
                    </div>
                `;
            });
            
            resultsHTML += '</div>';
            mobileSearchResults.innerHTML = resultsHTML;
            
            setTimeout(() => {
                addCartEventListeners();
            }, 100);
        }

        function renderFilteredProducts(filteredProducts, searchTerm) {
            if (filteredProducts.length === 0) {
                productsGrid.innerHTML = `
                    <div class="loading" style="text-align: center; padding: 2rem;">
                        üîç No se encontraron productos para "<strong>${searchTerm}</strong>"
                        <br><br>
                        <button onclick="clearSearch()" class="retry-btn">
                            ‚ú® Ver todos los productos
                        </button>
                    </div>
                `;
                return;
            }
            
            renderProductsFromArray(filteredProducts, searchTerm);
        }

        function clearSearch() {
            productSearch.value = '';
            mobileSearch.value = '';
            isSearching = false;
            clearSearchBtn.style.display = 'none';
            clearMobileSearchBtn.style.display = 'none';
            renderProducts();
            currentCategory = "TODOS";
            
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-category') === 'TODOS') {
                    btn.classList.add('active');
                }
            });
        }

        function renderCategories() {
            const categories = [...new Set(products.map(p => p.category))];
            
            categoriesContainer.innerHTML = categories.map(category => `
                <button class="category-btn ${category === currentCategory ? 'active' : ''}" 
                        data-category="${category}">
                    ${category}
                </button>
            `).join("");
            
            if (categories.length > 0 && currentCategory === "TODOS") {
                currentCategory = categories[0];
                document.querySelector(`[data-category="${categories[0]}"]`).classList.add('active');
            }
            
            document.querySelectorAll(".category-btn").forEach(btn => {
                btn.addEventListener("click", function() {
                    currentCategory = this.getAttribute("data-category");
                    document.querySelectorAll(".category-btn").forEach(b => b.classList.remove("active"));
                    this.classList.add("active");
                    renderProducts();
                });
            });
        }

        function renderProducts() {
            const filteredProducts = products.filter(p => p.category === currentCategory);
            renderProductsFromArray(filteredProducts);
        }

        function renderProductsFromArray(productsArray, searchTerm = '') {
            const productsToShow = productsArray.filter(product => {
                return product.stock === "STOCK" || product.stockNumber > 0;
            });
            
            if (productsToShow.length === 0) {
                productsGrid.innerHTML = '<div class="loading">No hay productos disponibles</div>';
                return;
            }
            
            productsGrid.innerHTML = productsToShow.map(product => {
                const hasStock = product.stock === "STOCK" || product.stockNumber > 0;
                const isLowStock = product.stockNumber > 0 && product.stockNumber <= 3;
                const isOutOfStock = product.stockNumber === 0;
                
                let stockText = '';
                let stockClass = '';
                
                if (isOutOfStock) {
                    stockText = '‚ùå Sin Stock';
                    stockClass = 'out-of-stock';
                } else if (isLowStock) {
                    stockText = `‚ö†Ô∏è Stock Bajo (${product.stockNumber})`;
                    stockClass = 'low-stock';
                } else {
                    stockText = `‚úÖ En Stock (${product.stockNumber})`;
                    stockClass = 'in-stock';
                }
                
                const addButton = isOutOfStock 
                    ? `<button class="add-to-cart" disabled>‚ùå Sin Stock</button>`
                    : `<button class="add-to-cart" data-id="${product.id}">üõí Agregar al Carrito</button>`;
                
                // DESCUENTO REAL (post-redondeo)
                const precioFinal = product.discountedPrice;
                const descuentoReal = product.price > precioFinal 
                    ? Math.round(((product.price - precioFinal) / product.price) * 100)
                    : 0;
                
                const offerText = descuentoReal > 0 
                    ? `${descuentoReal}% OFF`
                    : '';
                
                const offerBadge = descuentoReal > 0 
                    ? `<div class="offer-badge">${offerText}</div>`
                    : '';
                
                const descripcionOferta = product.ofertas1 ? obtenerDescripcionOferta(product.ofertas1) : '';
                
                // OBTENER L√çMITES
                const limiteOferta1 = product.ofertaDetalles ? product.ofertaDetalles.maxUnidades : null;
                const tieneLimiteOferta2 = product.textoLimiteOfertas2 !== '';
                
                return `
                    <div class="product-card">
                        ${offerBadge}
                        <div class="product-image">
                            <img src="${product.image}" 
                                 alt="${product.name}"
                                 onerror="handleImageError(this, '${product.name.replace(/'/g, "\\'")}')">
                        </div>
                        <div class="product-info">
                            <div class="product-name">${product.name}</div>
                            ${descripcionOferta ? `<div class="offer-description">${descripcionOferta}</div>` : ''}
                            <div class="product-price-container">
                                ${precioFinal < product.price ? 
                                    `<span class="original-price">$${product.price}</span>` : ''}
                                <span class="product-price">$${precioFinal}</span>
                                ${descuentoReal > 0 ? 
                                    `<span class="discount-percent">${offerText}</span>` : ''}
                            </div>
                            <!-- MOSTRAR L√çMITES -->
                            ${limiteOferta1 !== null ? `
                                <div class="promo-limit">
                                    ‚ö†Ô∏è M√°x. ${limiteOferta1} unidades por grupo familiar
                                </div>
                            ` : ''}
                            ${tieneLimiteOferta2 ? `
                                <div class="promo-limit" style="color: #ff6f00;">
                                    ${product.textoLimiteOfertas2}
                                </div>
                            ` : ''}
                            <div class="product-stock ${stockClass}">
                                ${stockText}
                            </div>
                            ${addButton}
                        </div>
                    </div>
                `;
            }).join("");
            
            setTimeout(() => {
                addCartEventListeners();
            }, 100);
            
            if (searchTerm) {
                const searchHeader = `
                    <div class="search-results">
                        <strong>üîç B√∫squeda inteligente: "${searchTerm}"</strong>
                        <br>
                        <small>Encontraste ${productsToShow.length} producto(s)</small>
                        <button onclick="clearSearch()" style="margin-left: 10px; padding: 6px 12px; 
                                background: #ff6f00; color: white; border: none; border-radius: 15px; 
                                cursor: pointer; font-size: 0.8rem;">
                            ‚úñÔ∏è Limpiar b√∫squeda
                        </button>
                    </div>
                `;
                productsGrid.innerHTML = searchHeader + productsGrid.innerHTML;
            }
        }

        function addCartEventListeners() {
            document.querySelectorAll(".add-to-cart").forEach(btn => {
                btn.replaceWith(btn.cloneNode(true));
            });
            
            document.querySelectorAll(".add-to-cart").forEach(btn => {
                btn.addEventListener("click", function() {
                    const productId = parseInt(this.getAttribute("data-id"));
                    addToCart(productId);
                });
            });
        }

        function addToCart(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            const availableStock = product.stockNumber;
            const existingItem = cart.find(item => item.id === productId);
            const currentQuantityInCart = existingItem ? existingItem.quantity : 0;
            
            if (currentQuantityInCart >= availableStock) {
                showStockError(product.name, availableStock);
                return;
            }
            
            // VERIFICAR L√çMITE DE OFERTAS1
            if (product.ofertaDetalles && product.ofertaDetalles.maxUnidades !== null) {
                const newQuantity = currentQuantityInCart + 1;
                if (newQuantity > product.ofertaDetalles.maxUnidades) {
                    showLimitError(product.name, product.ofertaDetalles.maxUnidades, product.ofertaDetalles.nombre);
                    return;
                }
            }
            
            // VERIFICAR L√çMITE DE OFERTAS2 (descuentos altos)
            if (product.ofertas2) {
                const limiteOferta2 = obtenerLimiteOfertas2(product.ofertas2);
                if (limiteOferta2 !== null) {
                    const newQuantity = currentQuantityInCart + 1;
                    if (newQuantity > limiteOferta2) {
                        showLimitError(product.name, limiteOferta2, `${product.ofertas2}% OFF`);
                        return;
                    }
                }
            }
            
            if (existingItem) {
                existingItem.quantity += 1;
                existingItem.price = calcularPrecioConDescuento(
                    product.price, 
                    product.ofertas1, 
                    product.ofertas2, 
                    existingItem.quantity
                );
            } else {
                const initialPrice = calcularPrecioConDescuento(
                    product.price, 
                    product.ofertas1, 
                    product.ofertas2, 
                    1
                );
                
                const initialDiscount = product.price > initialPrice 
                    ? Math.round(((product.price - initialPrice) / product.price) * 100)
                    : 0;
                
                cart.push({
                    id: product.id,
                    name: product.name,
                    price: initialPrice,
                    originalPrice: product.price,
                    hasPromo: product.hasPromo,
                    ofertas1: product.ofertas1,
                    ofertas2: product.ofertas2,
                    ofertaDetalles: product.ofertaDetalles,
                    quantity: 1,
                    maxStock: availableStock,
                    maxOfertaLimit: product.ofertaDetalles ? product.ofertaDetalles.maxUnidades : null,
                    maxOferta2Limit: obtenerLimiteOfertas2(product.ofertas2)
                });
                
                if (initialDiscount > 0) {
                    showAddToCartFeedback(product.name, initialDiscount);
                } else {
                    showAddToCartFeedback(product.name);
                }
            }
            
            updateCartCount();
        }

        function showAddToCartFeedback(productName, discount = 0) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 100px;
                left: 50%;
                transform: translateX(-50%);
                background: var(--primary);
                color: white;
                padding: 12px 20px;
                border-radius: 25px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                z-index: 1002;
                font-weight: 500;
                animation: slideDown 0.3s ease;
            `;
            
            if (discount > 0) {
                notification.innerHTML = `‚úÖ ${productName} agregado (${discount}% OFF)`;
            } else {
                notification.innerHTML = `‚úÖ ${productName} agregado al carrito`;
            }
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 2000);
        }

        function showStockError(productName, availableStock) {
            const notification = document.createElement('div');
            notification.className = 'stock-notification';
            notification.innerHTML = `‚ùå No hay suficiente stock de ${productName}. M√°ximo: ${availableStock} unidades`;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function showLimitError(productName, limit, promoName) {
            const notification = document.createElement('div');
            notification.className = 'limit-notification';
            notification.innerHTML = `üö´ ${promoName}: m√°ximo ${limit} unidades por grupo familiar de ${productName}`;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function updateCartCount() {
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            cartCount.textContent = totalItems;
            floatingCartCount.textContent = totalItems;
        }

        function openCart() {
            renderCartItems();
            cartModal.style.display = "flex";
        }

        function closeCartModal() {
            cartModal.style.display = "none";
        }

        function renderCartItems() {
            if (cart.length === 0) {
                cartItems.innerHTML = "<p>Tu carrito est√° vac√≠o</p>";
                cartTotal.textContent = "Total: $0";
                return;
            }
            
            let totalNormalPrice = 0;
            let totalWithPromos = 0;
            let totalSavings = 0;
            let cartItemsHTML = '';
            
            cart.forEach(item => {
                const product = products.find(p => p.id === item.id);
                if (!product) return;
                
                const itemNormalPrice = product.price * item.quantity;
                const itemFinalPrice = item.price * item.quantity;
                const itemSavings = itemNormalPrice - itemFinalPrice;
                
                totalNormalPrice += itemNormalPrice;
                totalWithPromos += itemFinalPrice;
                totalSavings += itemSavings;
                
                const discountPercent = item.price < product.price 
                    ? Math.round(((product.price - item.price) / product.price) * 100)
                    : 0;
                
                cartItemsHTML += `
                    <div class="cart-item">
                        <div class="cart-item-info">
                            <div class="cart-item-name">${item.name}</div>
                            <div class="cart-item-price">
                                ${item.price < product.price 
                                    ? `<span style="text-decoration: line-through; color: #999; margin-right: 5px;">$${product.price}</span>` 
                                    : ''}
                                $${item.price} c/u
                                ${discountPercent > 0 ? `<span style="color: #4caf50; font-size: 0.8rem; margin-left: 5px;">(${discountPercent}% OFF)</span>` : ''}
                            </div>
                        </div>
                        <div class="cart-item-quantity">
                            <button class="quantity-btn" data-id="${item.id}" data-action="decrease">-</button>
                            <span class="quantity-value">${item.quantity}</span>
                            <button class="quantity-btn" data-id="${item.id}" data-action="increase">+</button>
                        </div>
                    </div>
                `;
            });
            
            cartItems.innerHTML = cartItemsHTML;
            
            let totalHTML = '';
            if (totalSavings > 0) {
                totalHTML = `
                    <div class="cart-total">
                        <div>Subtotal normal: $${totalNormalPrice}</div>
                        <div class="total-savings">
                            üéâ ¬°Ahorras: $${totalSavings}!
                        </div>
                        <div><strong>Total a pagar: $${totalWithPromos}</strong></div>
                    </div>
                `;
            } else {
                totalHTML = `
                    <div class="cart-total">
                        <div><strong>Total: $${totalNormalPrice}</strong></div>
                    </div>
                `;
            }
            
            cartTotal.innerHTML = totalHTML;
            
            document.querySelectorAll(".quantity-btn").forEach(btn => {
                btn.addEventListener("click", function() {
                    const productId = parseInt(this.getAttribute("data-id"));
                    const action = this.getAttribute("data-action");
                    updateCartItemQuantity(productId, action);
                });
            });
        }

        function updateCartItemQuantity(productId, action) {
            const item = cart.find(item => item.id === productId);
            if (!item) return;
            
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            if (action === "increase") {
                if (item.quantity >= item.maxStock) {
                    showStockError(item.name, item.maxStock);
                    return;
                }
                
                if (item.maxOfertaLimit !== null && item.quantity >= item.maxOfertaLimit) {
                    showLimitError(item.name, item.maxOfertaLimit, item.ofertaDetalles?.nombre || "oferta");
                    return;
                }
                
                if (item.maxOferta2Limit !== null && item.quantity >= item.maxOferta2Limit) {
                    showLimitError(item.name, item.maxOferta2Limit, `${product.ofertas2}% OFF`);
                    return;
                }
                
                item.quantity += 1;
                
            } else if (action === "decrease") {
                item.quantity -= 1;
                if (item.quantity <= 0) {
                    cart = cart.filter(i => i.id !== productId);
                    updateCartCount();
                    renderCartItems();
                    return;
                }
            }
            
            // Recalcular precio
            item.price = calcularPrecioConDescuento(
                product.price, 
                product.ofertas1, 
                product.ofertas2, 
                item.quantity
            );
            
            updateCartCount();
            renderCartItems();
        }

        function handleImageError(imgElement, productName) {
            console.log('‚ö†Ô∏è Imagen no encontrada para:', productName);
            imgElement.src = `https://via.placeholder.com/200x150/E8F5E9/1B5E20?text=${encodeURIComponent(productName.substring(0, 20))}`;
        }

        // FUNCIONES AUXILIARES PARA OFERTAS
        function obtenerDescripcionOferta(ofertas1) {
            if (!ofertas1 || ofertas1 === '') return "";
            
            const ofertaNum = parseInt(ofertas1);
            if (isNaN(ofertaNum) || ofertaNum < 1 || ofertaNum > 5) return "";
            
            const oferta = OFERTAS_SISTEMA[ofertaNum.toString()];
            if (!oferta) return "";
            
            let descripcion = `Descuento escalonado: `;
            oferta.descuentos.forEach((desc, index) => {
                const porcentaje = Math.round(desc * 100);
                const unidades = index + 1;
                if (unidades === 1) {
                    descripcion += `${unidades}u=${porcentaje}%`;
                } else if (unidades === oferta.descuentos.length) {
                    descripcion += `, ${unidades}+u=${porcentaje}%`;
                } else {
                    descripcion += `, ${unidades}u=${porcentaje}%`;
                }
            });
            
            if (oferta.maxUnidades !== null) {
                descripcion += ` (M√°x. ${oferta.maxUnidades}u/familia)`;
            }
            
            return descripcion;
        }

        function obtenerDescuentoActual(ofertas1, cantidad) {
            if (!ofertas1 || ofertas1 === '') return 0;
            
            const ofertaNum = parseInt(ofertas1);
            if (isNaN(ofertaNum) || ofertaNum < 1 || ofertaNum > 5) return 0;
            
            const oferta = OFERTAS_SISTEMA[ofertaNum.toString()];
            if (!oferta) return 0;
            
            let descuentoAplicar;
            if (cantidad >= oferta.descuentos.length) {
                descuentoAplicar = oferta.descuentos[oferta.descuentos.length - 1];
            } else if (cantidad > 0) {
                descuentoAplicar = oferta.descuentos[cantidad - 1];
            } else {
                descuentoAplicar = 0;
            }
            
            return Math.round(descuentoAplicar * 100);
        }

        document.addEventListener("DOMContentLoaded", init);
    </script>
</body>
</html>