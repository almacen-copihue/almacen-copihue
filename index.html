<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Almac√©n Copihue - Productos de calidad con la confianza de siempre</title>
    
    <!-- META TAGS PARA PWA -->
    <meta name="theme-color" content="#2e7d32">
    <meta name="description" content="Almac√©n Copihue">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Almac√©n Copihue">
    
    <!-- SISTEMA ANTI-CACHE -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <!-- ICONOS -->
    <link rel="icon" href="iconos-pwa/android/android-launchericon-48-48.png" type="image/png">
    <link rel="apple-touch-icon" href="iconos-pwa/ios/180.png">
    <link rel="manifest" href="manifest.json">
    
    <style>
        :root {
            --primary: #2e7d32;
            --primary-dark: #1b5e20;
            --primary-light: #4caf50;
            --secondary: #ff6f00;
            --secondary-dark: #f57c00;
            --accent: #ffeb3b;
            --light: #f8fff8;
            --dark: #1b5e20;
            --gray: #757575;
            --white: #ffffff;
            --card-bg: #ffffff;
            --shadow: 0 4px 15px rgba(46,125,50,0.1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--light);
            color: var(--dark);
            line-height: 1.6;
            background-image: linear-gradient(135deg, #f8fff8 0%, #e8f5e9 100%);
        }
        
        header {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: var(--white);
            padding: 1rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow);
        }
        
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .logo-icon {
            width: 48px;
            height: 48px;
        }

        .admin-badge {
            background: var(--secondary);
            color: white;
            padding: 0.2rem 0.6rem;
            border-radius: 12px;
            font-size: 0.7rem;
            margin-left: 0.5rem;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        .cart-icon {
            position: relative;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: background 0.3s;
        }
        
        .cart-icon:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .cart-count {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--secondary);
            color: white;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }
        
        .hero {
            background: linear-gradient(135deg, rgba(46,125,50,0.9), rgba(76,175,80,0.8));
            color: white;
            padding: 3rem 1rem;
            text-align: center;
            border-radius: 15px;
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
        }
        
        .hero h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .hero p {
            font-size: 1.1rem;
            margin-bottom: 1rem;
            opacity: 0.9;
        }
        
        .info-bar {
            background-color: var(--white);
            padding: 1.2rem;
            border-radius: 12px;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-around;
            text-align: center;
            border-left: 4px solid var(--secondary);
        }
        
        .info-item {
            margin: 0.5rem;
            font-weight: 500;
        }

/* Agregar al CSS existente */
.cart-item-info small {
    display: block;
    font-size: 0.8rem;
    margin-top: 2px;
    color: #4caf50 !important;
    font-weight: bold;
}

.cart-item .oferta-badge {
    background: #ffeb3b;
    color: #d50000;
    padding: 2px 6px;
    border-radius: 8px;
    font-size: 0.7rem;
    font-weight: bold;
    margin-left: 5px;
    display: inline-block;
}

        /* ========== CONTENEDOR GEN√âRICO OFERTAS ========== */
        .ofertas-container {
            display: none;
            margin-bottom: 2rem;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
            border: 3px solid;
            position: relative;
        }

        .ofertas-container.relampago {
            border-color: #ff3d00;
            background: linear-gradient(135deg, #fff8e1, #ffecb3);
        }

        .ofertas-container.destacadas {
            border-color: #ff6f00;
            background: linear-gradient(135deg, #fff3e0, #ffe0b2);
        }

        .ofertas-container.especiales {
            border-color: #2196f3;
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
        }

        .ofertas-header {
            color: white;
            padding: 1rem;
            text-align: center;
            position: relative;
        }

        .ofertas-container.relampago .ofertas-header {
            background: linear-gradient(135deg, #ff3d00, #d50000);
        }

        .ofertas-container.destacadas .ofertas-header {
            background: linear-gradient(135deg, #ff6f00, #f57c00);
        }

        .ofertas-container.especiales .ofertas-header {
            background: linear-gradient(135deg, #2196f3, #1976d2);
        }

        .ofertas-header h2 {
            font-size: 1.4rem;
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .ofertas-badge {
            background: #ffff00;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
            animation: flash 1.5s infinite;
        }

        .ofertas-container.relampago .ofertas-badge {
            color: #d50000;
        }

        .ofertas-container.destacadas .ofertas-badge {
            color: #ff6f00;
        }

        .ofertas-container.especiales .ofertas-badge {
            color: #1976d2;
        }

        @keyframes flash {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .ofertas-timer {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 15px;
            border-radius: 25px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
            font-weight: bold;
            font-size: 1rem;
        }

        .ofertas-products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            padding: 1.5rem;
            background: white;
        }

        .ofertas-product-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border: 2px solid;
            transition: all 0.3s ease;
            position: relative;
        }

        .ofertas-container.relampago .ofertas-product-card {
            border-color: #ffccbc;
        }

        .ofertas-container.destacadas .ofertas-product-card {
            border-color: #ffe0b2;
        }

        .ofertas-container.especiales .ofertas-product-card {
            border-color: #bbdefb;
        }

        .ofertas-product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .ofertas-exclusive-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
            z-index: 10;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
        }

        .ofertas-container.relampago .ofertas-exclusive-badge {
            background: linear-gradient(135deg, #ff3d00, #ff6d00);
        }

        .ofertas-container.destacadas .ofertas-exclusive-badge {
            background: linear-gradient(135deg, #ff6f00, #f57c00);
        }

        .ofertas-container.especiales .ofertas-exclusive-badge {
            background: linear-gradient(135deg, #2196f3, #1976d2);
        }

        .ofertas-stock-warning {
            background: #ffecb3;
            color: #ff6f00;
            padding: 0.8rem;
            border-radius: 8px;
            margin: 1rem 1.5rem;
            text-align: center;
            font-size: 0.9rem;
            border-left: 4px solid #ff9800;
        }

        .search-container {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            padding: 1rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #e8f5e9;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-radius: 12px;
            position: relative;
        }
        
        .search-wrapper {
            position: relative;
            width: 100%;
        }
        
        .search-input {
            width: 100%;
            padding: 14px 50px 14px 20px;
            border: 2px solid var(--primary);
            border-radius: 25px;
            font-size: 1rem;
            background: white;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(46,125,50,0.1);
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--primary-dark);
            box-shadow: 0 0 0 3px rgba(46,125,50,0.2);
        }
        
        .clear-search {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: var(--gray);
            transition: color 0.3s;
            padding: 5px;
            z-index: 2;
            display: none;
        }
        
        .clear-search:hover {
            color: var(--primary);
        }
        
        .search-results {
            text-align: center;
            padding: 12px;
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            border-radius: 10px;
            margin-bottom: 1rem;
            border-left: 4px solid #2196f3;
        }

        .categories {
            display: flex;
            overflow-x: auto;
            gap: 0.6rem;
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
            scrollbar-color: #0288D1 #e8f5e9;
        }

        .categories::-webkit-scrollbar {
            height: 6px;
        }

        .categories::-webkit-scrollbar-track {
            background: #e8f5e9;
            border-radius: 10px;
        }

        .categories::-webkit-scrollbar-thumb {
            background: #0288D1;
            border-radius: 10px;
        }

        .category-btn {
            background: #29B6F6;
            border: 2px solid #0288D1;
            color: #FFFFFF;
            box-shadow: 0 2px 6px rgba(2, 136, 209, 0.2);
            font-weight: 600;
            padding: 0.8rem 1rem;
            border-radius: 25px;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.25s ease;
            position: relative;
            user-select: none;
            min-width: max-content;
            flex-shrink: 0;
            font-size: 0.85rem;
        }

        .category-btn.active {
            background: #0288D1;
            border-color: #29B6F6;
            color: #FFFFFF;
            box-shadow: 0 4px 12px rgba(41, 182, 246, 0.3);
            transform: translateY(-1px);
        }

        @media (hover: hover) {
            .category-btn:hover:not(.active) {
                background: #03A9F4;
                border-color: #0277BD;
                transform: translateY(-1px);
                box-shadow: 0 3px 8px rgba(2, 119, 189, 0.25);
            }
            .category-btn.active:hover {
                background: #0277BD;
                border-color: #4FC3F7;
            }
        }

        @media (min-width: 768px) {
            .categories {
                display: flex;
                flex-wrap: wrap;
                gap: 0.8rem;
                margin-bottom: 2rem;
                justify-content: flex-start;
            }
            
            .category-btn {
                padding: 0.8rem 1.5rem;
                font-size: 0.9rem;
                min-width: auto;
            }
        }

        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        @media (min-width: 1200px) {
            .products-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        @media (min-width: 768px) and (max-width: 1199px) {
            .products-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 767px) {
            .products-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .cart-icon {
                display: none;
            }
            
            .search-container {
                display: none;
            }
        }

        @media (max-width: 480px) {
            .products-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .product-card {
            background-color: var(--card-bg);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            border: 1px solid #e8f5e9;
            position: relative;
        }
        
        .product-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 8px 25px rgba(46,125,50,0.15);
        }
        
        .product-image {
            height: 160px;
            background: linear-gradient(135deg, #e8f5e8, #c8e6c9);
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0.8rem;
            position: relative;
            overflow: hidden;
        }
        
        .product-image img {
            max-width: 100%;
            max-height: 130px;
            object-fit: contain;
            transition: transform 0.3s ease;
        }
        
        .product-card:hover .product-image img {
            transform: scale(1.05);
        }
        
        .product-info {
            padding: 1rem;
        }
        
        .product-name {
            font-weight: 600;
            margin-bottom: 0.4rem;
            font-size: 0.9rem;
            color: var(--dark);
            line-height: 1.3;
            min-height: 2.6rem;
        }
        
        .product-price-container {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 0.5rem;
            flex-wrap: wrap;
        }
        
        .original-price {
            color: var(--gray);
            text-decoration: line-through;
            font-size: 0.9rem;
        }
        
        .product-price {
            color: var(--secondary);
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        .discount-percent {
            background: #ffeb3b;
            color: #333;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: bold;
        }
        
        .product-stock {
            font-size: 0.75rem;
            margin-bottom: 0.8rem;
            font-weight: 500;
        }
        
        .in-stock {
            color: var(--primary-light);
        }
        
        .out-of-stock {
            color: var(--gray);
        }

        .low-stock {
            color: #ff9800;
            font-weight: bold;
        }
        
        .add-to-cart {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            border: none;
            padding: 0.7rem;
            border-radius: 8px;
            width: 100%;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .add-to-cart:hover {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary));
            transform: translateY(-2px);
        }
        
        .add-to-cart:disabled {
            background: var(--gray);
            cursor: not-allowed;
            transform: none;
        }

        .cart-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .cart-content {
            background-color: var(--white);
            width: 90%;
            max-width: 500px;
            border-radius: 15px;
            padding: 1.5rem;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow);
        }
        
        .cart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            border-bottom: 2px solid #e8f5e9;
            padding-bottom: 0.8rem;
        }
        
        .close-cart {
            background: none;
            border: none;
            font-size: 1.8rem;
            cursor: pointer;
            color: var(--gray);
            transition: color 0.3s;
        }
        
        .close-cart:hover {
            color: var(--primary);
        }
        
        .cart-items {
            margin-bottom: 1rem;
        }
        
        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.8rem 0;
            border-bottom: 1px solid #e8f5e9;
        }
        
        .cart-item-info {
            flex-grow: 1;
        }
        
        .cart-item-name {
            font-weight: bold;
            color: var(--dark);
        }
        
        .cart-item-price {
            color: var(--gray);
            font-size: 0.9rem;
        }
        
        .cart-item-quantity {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .quantity-btn {
            background-color: var(--light);
            border: 1px solid #c8e6c9;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .quantity-btn:hover {
            background-color: var(--primary-light);
            color: white;
        }
        
        .quantity-value {
            margin: 0 0.5rem;
            font-weight: bold;
            min-width: 20px;
            text-align: center;
        }
        
        .cart-total {
            font-weight: bold;
            font-size: 1.3rem;
            text-align: right;
            margin-bottom: 1rem;
            color: var(--primary);
            padding-top: 1rem;
            border-top: 2px solid #e8f5e9;
        }
        
        .total-savings {
            background: #4caf50;
            color: white;
            padding: 0.8rem;
            border-radius: 8px;
            margin: 0.5rem 0;
            text-align: center;
            font-weight: bold;
        }
        
        .send-order {
            background: linear-gradient(135deg, var(--secondary), var(--secondary-dark));
            color: white;
            border: none;
            padding: 1.2rem;
            border-radius: 10px;
            width: 100%;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .send-order:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255,111,0,0.3);
        }
        
        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--gray);
            font-size: 1.1rem;
        }
        
        .error-message {
            text-align: center;
            padding: 2rem;
            color: #d32f2f;
            background: #ffebee;
            border-radius: 10px;
            margin: 1rem 0;
            border-left: 4px solid #d32f2f;
        }
        
        .retry-btn {
            margin-top: 10px;
            padding: 10px 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.3s;
        }
        
        .retry-btn:hover {
            background: var(--primary-dark);
        }
        
        footer {
            background: linear-gradient(135deg, var(--dark), var(--primary));
            color: var(--white);
            padding: 2rem 1rem;
            text-align: center;
            margin-top: 3rem;
        }
        
        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
        }

        .admin-notification {
            background: linear-gradient(135deg, #ff9800, #f57c00);
            color: white;
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            text-align: center;
            animation: slideIn 0.5s ease;
        }

        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .floating-cart {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, var(--secondary), var(--secondary-dark));
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(255,111,0,0.4);
            z-index: 999;
            transition: all 0.3s ease;
            font-size: 1.5rem;
        }
        
        .floating-cart:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(255,111,0,0.6);
        }
        
        .floating-cart .cart-count {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--primary);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.8rem;
            font-weight: bold;
            border: 2px solid white;
        }

        .floating-search {
            position: fixed;
            bottom: 90px;
            right: 20px;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: none;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(46,125,50,0.4);
            z-index: 998;
            transition: all 0.3s ease;
            font-size: 1.5rem;
        }

        @media (max-width: 767px) {
            .floating-search {
                display: flex;
            }
        }
        
        .floating-search:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(46,125,50,0.6);
        }

        .search-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1001;
            justify-content: center;
            align-items: flex-start;
            padding-top: 80px;
        }
        
        .search-modal-content {
            background-color: var(--white);
            width: 90%;
            max-width: 500px;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            max-height: 70vh;
            overflow-y: auto;
        }
        
        .search-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            border-bottom: 2px solid #e8f5e9;
            padding-bottom: 0.8rem;
        }
        
        .close-search {
            background: none;
            border: none;
            font-size: 1.8rem;
            cursor: pointer;
            color: var(--gray);
            transition: color 0.3s;
        }
        
        .close-search:hover {
            color: var(--primary);
        }

        .mobile-search-results {
            margin-top: 1rem;
        }

        .stock-notification {
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1002;
            font-weight: 500;
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from { 
                transform: translateX(-50%) translateY(-20px); 
                opacity: 0; 
            }
            to { 
                transform: translateX(-50%) translateY(0); 
                opacity: 1; 
            }
        }
    </style>
</head>
<body>
<header>
    <div class="header-content">
        <div class="logo">
            <img src="iconos-pwa/android/android-launchericon-48-48.png" alt="Logo Almac√©n Copihue" class="logo-icon">
            Almac√©n Copihue
            <span id="adminBadge" class="admin-badge" style="display: none;">ADMIN</span>
        </div>
        <div class="cart-icon" id="cartIcon">
            üõí <span class="cart-count" id="cartCount">0</span>
        </div>
    </div>
</header>

<div class="container">
    <div id="adminNotification" class="admin-notification" style="display: none;">
        <strong>üîê MODO ADMIN ACTIVADO</strong> - Recibir√°s alertas de stock bajo
    </div>

    <section class="hero">
        <h1>"Almac√©n Copihue"</h1>
        <p>Productos de calidad con la confianza de siempre</p>
    </section>

    <section class="info-bar">
        <div class="info-item">
            <strong>üìç Retiro en el local:</strong> Copihue 457
        </div>
        <div class="info-item">
            <strong>üìû WhatsApp:</strong> +5492944907380
        </div>
        <div class="info-item">
            <strong>‚è∞ Horario:</strong> 11:30 a 23:30 hrs.
        </div>
    </section>

    <!-- ========== OFERTAS REL√ÅMPAGO ========== -->
    <div class="ofertas-container relampago" id="ofertasRelampago">
        <div class="ofertas-header">
            <h2>
                ‚ö° OFERTAS REL√ÅMPAGO 
                <span class="ofertas-badge">HOY SOLO</span>
            </h2>
            <div class="ofertas-timer" id="relampago-timer">
                ‚è∞ Termina en: <span id="relampago-countdown">--:--:--</span>
            </div>
        </div>
        
        <div class="ofertas-stock-warning">
            ‚ö†Ô∏è <strong>ATENCI√ìN:</strong> Ofertas v√°lidas solo de Lunes a Jueves, de 11:30 a 17:00.
            ¬°Apurate, stock limitado!
        </div>
        
        <div class="ofertas-products-grid" id="relampago-grid">
            <!-- Productos rel√°mpago -->
        </div>
    </div>

    <!-- ========== OFERTAS DESTACADAS ========== -->
    <div class="ofertas-container destacadas" id="ofertasDestacadas">
        <div class="ofertas-header">
            <h2>
                üî• OFERTAS DESTACADAS 
                <span class="ofertas-badge">FINDE</span>
            </h2>
            <div class="ofertas-timer" id="destacadas-timer">
                ‚è∞ Termina en: <span id="destacadas-countdown">--:--:--</span>
            </div>
        </div>
        
        <div class="ofertas-stock-warning">
            ‚≠ê <strong>ESPECIAL FINDE:</strong> Viernes y S√°bados de 20:00 a 23:00.
            ¬°Los mejores descuentos de la semana!
        </div>
        
        <div class="ofertas-products-grid" id="destacadas-grid">
            <!-- Productos destacadas -->
        </div>
    </div>

    <!-- ========== OFERTAS ESPECIALES ========== -->
    <div class="ofertas-container especiales" id="ofertasEspeciales">
        <div class="ofertas-header">
            <h2>
                ‚≠ê OFERTAS ESPECIALES 
                <span class="ofertas-badge">NOCHE</span>
            </h2>
            <div class="ofertas-timer" id="especiales-timer">
                ‚è∞ Termina en: <span id="especiales-countdown">--:--:--</span>
            </div>
        </div>
        
        <div class="ofertas-stock-warning">
            üåô <strong>ESPECIAL NOCTURNO:</strong> Lunes a Jueves de 18:00 a 23:00.
            ¬°Aprovech√° estas ofertas √∫nicas!
        </div>
        
        <div class="ofertas-products-grid" id="especiales-grid">
            <!-- Productos especiales -->
        </div>
    </div>

    <div class="search-container" id="desktopSearch">
        <div class="search-wrapper">
            <input type="text" id="productSearch" class="search-input" 
                   placeholder="üîç Buscar productos por nombre...">
            <button class="clear-search" id="clearSearchBtn">‚úñÔ∏è</button>
        </div>
    </div>

    <section class="categories" id="categories">
        <!-- Categor√≠as din√°micas -->
    </section>

    <section class="products-grid" id="productsGrid">
        <div class="loading">üîÑ Cargando productos desde tu API...</div>
    </section>
</div>

<!-- BOTONES FLOTANTES -->
<div class="floating-search" id="floatingSearch">
    üîç
</div>

<div class="floating-cart" id="floatingCart">
    üõí
    <span class="cart-count" id="floatingCartCount">0</span>
</div>

<div class="search-modal" id="searchModal">
    <div class="search-modal-content">
        <div class="search-modal-header">
            <h2>Buscar Productos</h2>
            <button class="close-search" id="closeSearch">&times;</button>
        </div>
        <div class="search-wrapper">
            <input type="text" id="mobileSearch" class="search-input" 
                   placeholder="üîç Escribe nombre...">
            <button class="clear-search" id="clearMobileSearchBtn">‚úñÔ∏è</button>
        </div>
        <div class="mobile-search-results" id="mobileSearchResults">
            <!-- Resultados b√∫squeda m√≥vil -->
        </div>
    </div>
</div>

<div class="cart-modal" id="cartModal">
    <div class="cart-content">
        <div class="cart-header">
            <h2>Tu Pedido</h2>
            <button class="close-cart" id="closeCart">&times;</button>
        </div>
        <div class="cart-items" id="cartItems">
            <!-- Items del carrito -->
        </div>
        <div class="cart-total" id="cartTotal">Total: $0</div>
        <button class="send-order" id="sendOrder">Enviar Pedido por WhatsApp</button>
    </div>
</div>

<footer>
    <div class="footer-content">
        <p>Almac√©n Copihue - Productos de calidad con la confianza de siempre</p>
        <p>üìç Copihue 457 | üìû +5492944907380 | ‚è∞ 11:30 a 23:30 hrs.</p>
    </div>
</footer>

<script>
// ========== VERSI√ìN Y CONFIGURACI√ìN ==========
const APP_VERSION = 'V2.0-SISTEMA-3-OFERTAS';

// ========== MAPEO DE OFERTAS REL√ÅMPAGO ==========
// ========== MAPEO DE OFERTAS REL√ÅMPAGO ==========
const OFERTAS_RELAMPAGO_SISTEMA = {
'1': { 
        nombre: "2x1", 
        tipo: "2x1", 
        eslogan: "üéÅ LA 2DA UNIDAD GRATIS",
        cantidad: 2,
        pagas: 1,
        color: "#d50000"
    },
    '2': { 
        nombre: "3x2", 
        tipo: "3x2", 
        eslogan: "üéÅ LA 3RA UNIDAD GRATIS",
        cantidad: 3,
        pagas: 2,
        color: "#ff6f00"
    },
    '3': { 
        nombre: "4x3", 
        tipo: "4x3", 
        eslogan: "üéÅ LA 4TA UNIDAD GRATIS",
        cantidad: 4,
        pagas: 3,
        color: "#2196f3"
    },
    '4': { 
        nombre: "5x4", 
        tipo: "5x4", 
        eslogan: "üéÅ LA 5TA UNIDAD GRATIS",
        cantidad: 5,
        pagas: 4,
        color: "#9c27b0"
    },
    '5': { 
        nombre: "6x5", 
        tipo: "6x5", 
        eslogan: "üéÅ LA 6TA UNIDAD GRATIS",
        cantidad: 6,
        pagas: 5,
        color: "#ff4081"
    },
    '6': { 
        nombre: "7x6", 
        tipo: "7x6", 
        eslogan: "üéÅ LA 7MA UNIDAD GRATIS",
        cantidad: 7,
        pagas: 6,
        color: "#00bcd4"
    },
    '10': { 
        nombre: "2da50", 
        tipo: "2da50", 
        eslogan: "üéÅ LA 2DA UNIDAD AL 50% OFF",
        cantidad: 2,
        pagas: 1.5,
        color: "#e91e63"
    }
};


// ========== VARIABLES GLOBALES ==========
let products = [];
let cart = [];
let currentCategory = "ALMACEN";
let isSearching = false;
let esAdmin = false;

// Pools de ofertas
let poolRelampago = [];
let poolDestacadas = [];
let poolEspeciales = [];

// Productos activos en cada secci√≥n
let productosRelampago = [];
let productosDestacadas = [];
let productosEspeciales = [];

// IDs de productos ya mostrados (anti-duplicados)
let idsEnOfertas = new Set();

// ========== SISTEMA DE ROTACI√ìN DIARIA ==========
const ROTACION_SISTEMA = {
    getDateKey() {
        const now = new Date();
        return `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')}`;
    },
    
    getRotationIndex(poolSize, visibleCount, storageKey) {
        const dateKey = this.getDateKey();
        const savedData = localStorage.getItem(storageKey);
        
        if (savedData) {
            try {
                const data = JSON.parse(savedData);
                if (data.date === dateKey) {
                    return data.index;
                }
            } catch (e) {
                console.warn('Error leyendo rotaci√≥n:', e);
            }
        }
        
        // Nueva rotaci√≥n
        const lastIndex = parseInt(localStorage.getItem(`${storageKey}_lastIndex`)) || 0;
        const newIndex = (lastIndex + visibleCount) % poolSize;
        
        localStorage.setItem(storageKey, JSON.stringify({
            date: dateKey,
            index: newIndex
        }));
        localStorage.setItem(`${storageKey}_lastIndex`, newIndex);
        
        return newIndex;
    },
    
    selectRotatedProducts(pool, visibleCount, storageKey) {
        if (pool.length === 0) return [];
        if (pool.length <= visibleCount) return pool;
        
        const startIndex = this.getRotationIndex(pool.length, visibleCount, storageKey);
        const selected = [];
        
        for (let i = 0; i < visibleCount; i++) {
            const index = (startIndex + i) % pool.length;
            selected.push(pool[index]);
        }
        
        return selected;
    }
};

// ========== VALIDACI√ìN HORARIOS ==========
const HORARIOS = {
    relampago: {
        dias: [1, 2, 3, 4], // Lunes a Jueves
        horaInicio: 11,
        minInicio: 30,
        horaFin: 17,
        minFin: 0
    },
    destacadas: {
        dias: [5, 6], // Viernes y S√°bado
        horaInicio: 20,
        minInicio: 0,
        horaFin: 23,
        minFin: 0
    },
    especiales: {
        dias: [1, 2, 3, 4], // Lunes a Jueves
        horaInicio: 18,
        minInicio: 0,
        horaFin: 23,
        minFin: 0
    }
};

function validarHorario(tipo) {
    const now = new Date();
    const dia = now.getDay();
    const hora = now.getHours();
    const min = now.getMinutes();
    
    const config = HORARIOS[tipo];
    if (!config) return false;
    
    // Validar d√≠a
    if (!config.dias.includes(dia)) return false;
    
    // Validar hora
    const horaActual = hora * 60 + min;
    const horaInicio = config.horaInicio * 60 + config.minInicio;
    const horaFin = config.horaFin * 60 + config.minFin;
    
    return horaActual >= horaInicio && horaActual < horaFin;
}

// ========== CONSTRUCCI√ìN DE POOLS ==========
function construirPools() {
    if (!products || products.length === 0) return;
    
    console.log('üèóÔ∏è Construyendo pools de ofertas...');
    
    // POOL REL√ÅMPAGO: solo productos con relampago > 0
    poolRelampago = products.filter(p => 
        p.relampago > 0 && 
        p.stockNumber > 0 &&
        OFERTAS_RELAMPAGO_SISTEMA[p.relampago]
    );
    
    // POOL DESTACADAS: solo productos con destacada > 0
    poolDestacadas = products.filter(p => 
        p.destacada > 0 && 
        p.stockNumber > 0
    ).sort((a, b) => b.destacada - a.destacada); // Ordenar por % DESC
    
    // POOL ESPECIALES: solo productos con especial = 1
    poolEspeciales = products.filter(p => 
        p.especial === 1 && 
        p.stockNumber > 0
    );
    
    console.log(`‚ö° Pool Rel√°mpago: ${poolRelampago.length} productos`);
    console.log(`üî• Pool Destacadas: ${poolDestacadas.length} productos`);
    console.log(`‚≠ê Pool Especiales: ${poolEspeciales.length} productos`);
}

// ========== SELECCI√ìN Y EXCLUSI√ìN ==========
function seleccionarProductosOfertas() {
    idsEnOfertas.clear();
    productosRelampago = [];
    productosDestacadas = [];
    productosEspeciales = [];
    
    // 1. REL√ÅMPAGO (prioridad m√°xima)
    if (validarHorario('relampago')) {
        productosRelampago = ROTACION_SISTEMA.selectRotatedProducts(
            poolRelampago, 
            3, 
            'rotacion_relampago'
        );
        productosRelampago.forEach(p => idsEnOfertas.add(p.id));
        console.log(`‚ö° Rel√°mpago activo: ${productosRelampago.length} productos`);
    }
    
    // 2. DESTACADAS (segunda prioridad)
    if (validarHorario('destacadas')) {
        const poolFiltrado = poolDestacadas.filter(p => !idsEnOfertas.has(p.id));
        productosDestacadas = poolFiltrado.slice(0, 9); // Sin rotaci√≥n
        productosDestacadas.forEach(p => idsEnOfertas.add(p.id));
        console.log(`üî• Destacadas activo: ${productosDestacadas.length} productos`);
    }
    
    // 3. ESPECIALES (solo si NO hay destacadas)
    if (validarHorario('especiales') && productosDestacadas.length === 0) {
        const poolFiltrado = poolEspeciales.filter(p => !idsEnOfertas.has(p.id));
        productosEspeciales = ROTACION_SISTEMA.selectRotatedProducts(
            poolFiltrado, 
            2, 
            'rotacion_especiales'
        );
        productosEspeciales.forEach(p => idsEnOfertas.add(p.id));
        console.log(`‚≠ê Especiales activo: ${productosEspeciales.length} productos`);
    }
}

// ========== RENDERIZADO DE CONTENEDORES ==========
function renderizarContenedorOfertas(tipo, productos) {
    const containerId = tipo === 'relampago' ? 'ofertasRelampago' :
                       tipo === 'destacadas' ? 'ofertasDestacadas' :
                       'ofertasEspeciales';
    
    const gridId = `${tipo}-grid`;
    const container = document.getElementById(containerId);
    const grid = document.getElementById(gridId);
    
    if (!container || !grid) return;
    
    if (productos.length === 0) {
        container.style.display = 'none';
        return;
    }
    
    container.style.display = 'block';
    
    grid.innerHTML = productos.map(product => {
        let textoOferta = '';
        let precioHTML = '';
        let mostrarPrecioOriginal = false;
        let precioMostrar = product.price;
        let descuento = 0;
        
        /* ================= REL√ÅMPAGO ================= */
        if (tipo === 'relampago' && product.relampago) {
            const oferta = OFERTAS_RELAMPAGO_SISTEMA[product.relampago];
            if (oferta) {
                const cantidad = oferta.cantidad;
                const pagas = oferta.pagas;

                const totalPagar = Math.round(product.price * pagas);
                const precioUnitario = Math.round(totalPagar / cantidad);

                textoOferta = oferta.eslogan;
                const precioNormal = product.price * cantidad;

                precioHTML = `
                    <div style="font-weight:bold; color:#d50000; font-size:1rem;">
                        üí∞ Llevando ${cantidad} pag√°s $${totalPagar}
                    </div>
                    <div style="font-size:0.75rem; color:#555;">
                        ($${precioUnitario} c/u)
                    </div>
                    <div style="font-size:0.7rem; color:#999; text-decoration:line-through;">
                        Antes: $${precioNormal}
                    </div>
                `;
            }
        }

        /* ================= DESTACADAS ================= */
        else if (tipo === 'destacadas' && product.destacada) {
            descuento = product.destacada;
            precioMostrar = Math.round(product.price * (1 - descuento / 100));
            textoOferta = `${descuento}% OFF`;
            mostrarPrecioOriginal = true;
        }

        /* ================= ESPECIALES ================= */
        else if (tipo === 'especiales' && product.especial) {
            descuento = 10;
            precioMostrar = Math.round(product.price * 0.9);
            textoOferta = `üéÅ OFERTA ESPECIAL -10%`;
            mostrarPrecioOriginal = true;
        }
        
        const badge = tipo === 'relampago' ? '‚ö° REL√ÅMPAGO' :
                     tipo === 'destacadas' ? 'üî• DESTACADA' :
                     '‚≠ê ESPECIAL';
        
        return `
            <div class="ofertas-product-card">
                <div class="ofertas-exclusive-badge">${badge}</div>
                
                <div class="product-image">
                    <img src="${product.image}" 
                         alt="${product.name}"
                         onerror="handleImageError(this, '${product.name.replace(/'/g, "\\'")}')">
                </div>
                
                <div class="product-info">
                    <div class="product-name">${product.name}</div>
                    
                    ${textoOferta ? `
                        <div style="color:#ff6f00;font-weight:bold;margin:8px 0;font-size:0.85rem;">
                            ${textoOferta}
                        </div>
                    ` : ''}
                    
                    <div class="product-price-container">
                        ${
                            tipo === 'relampago'
                            ? precioHTML
                            : mostrarPrecioOriginal
                                ? `
                                    <span class="original-price">$${product.price}</span>
                                    <span class="product-price">$${precioMostrar}</span>
                                    <span class="discount-percent">${descuento}%</span>
                                  `
                                : `
                                    <span class="product-price">$${product.price}</span>
                                  `
                        }
                    </div>
                    
                    <div class="product-stock in-stock">
                        ‚úÖ Stock: ${product.stockNumber}
                    </div>
                    
                    <button class="add-to-cart" data-id="${product.id}">
                        üõí Agregar al Carrito
                    </button>
                </div>
            </div>
        `;
    }).join('');
    
    iniciarCountdown(tipo);
}

// ========== COUNTDOWN ==========
function iniciarCountdown(tipo) {
    const countdownId = `${tipo}-countdown`;
    const config = HORARIOS[tipo];
    
    if (!config) return;
    
    const countdownElement = document.getElementById(countdownId);
    if (!countdownElement) return;
    
    const updateCountdown = () => {
        const now = new Date();
        const endTime = new Date();
        
        endTime.setHours(config.horaFin, config.minFin, 0, 0);
        
        if (now >= endTime) {
            countdownElement.textContent = '00:00:00';
            return;
        }
        
        const diff = endTime - now;
        const hours = Math.floor(diff / (1000 * 60 * 60));
        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((diff % (1000 * 60)) / 1000);
        
        countdownElement.textContent = 
            `${hours.toString().padStart(2, '0')}:` +
            `${minutes.toString().padStart(2, '0')}:` +
            `${seconds.toString().padStart(2, '0')}`;
        
        setTimeout(updateCountdown, 1000);
    };
    
    updateCountdown();
}

// ========== RENDERIZADO PRODUCTOS NORMALES ==========
function renderizarProductosNormales() {
    const productsGrid = document.getElementById('productsGrid');
    if (!productsGrid) return;
    
    // Filtrar productos que NO est√°n en ofertas
    const productosNormales = products.filter(p => 
        !idsEnOfertas.has(p.id) && 
        p.stockNumber > 0
    );
    
    // Filtrar por categor√≠a si no estamos en b√∫squeda
    let productosFiltrados = productosNormales;
    if (!isSearching && currentCategory !== 'ALL') {
        productosFiltrados = productosNormales.filter(p => 
            p.category === currentCategory
        );
    }
    
    if (productosFiltrados.length === 0) {
        productsGrid.innerHTML = `
            <div class="loading">
                <div style="font-size: 3rem; margin-bottom: 1rem;">üòï</div>
                <h3>No hay productos disponibles</h3>
            </div>
        `;
        return;
    }
    
    productsGrid.innerHTML = productosFiltrados.map(product => `
        <div class="product-card">
            <div class="product-image">
                <img src="${product.image}" 
                     alt="${product.name}"
                     onerror="handleImageError(this, '${product.name.replace(/'/g, "\\'")}')">
            </div>
            <div class="product-info">
                <div class="product-name">${product.name}</div>
                <div class="product-price-container">
                    <span class="product-price">${product.price}</span>
                </div>
                <div class="product-stock in-stock">
                    ‚úÖ Stock: ${product.stockNumber}
                </div>
                <button class="add-to-cart" data-id="${product.id}">
                    üõí Agregar al Carrito
                </button>
            </div>
        </div>
    `).join('');
    
    // LOS EVENT LISTENERS YA NO SON NECESARIOS AQU√ç
    // porque usamos event delegation en setupEventListeners
}

// ========== ACTUALIZAR TODAS LAS VISTAS ==========
function actualizarTodasLasVistas() {
    construirPools();
    seleccionarProductosOfertas();
    
    renderizarContenedorOfertas('relampago', productosRelampago);
    renderizarContenedorOfertas('destacadas', productosDestacadas);
    renderizarContenedorOfertas('especiales', productosEspeciales);
    
    renderizarProductosNormales();
}

// ========== CARGAR PRODUCTOS DESDE API ==========
async function loadProductsFromAPI() {
    try {
        console.log('üöÄ Cargando productos desde API...');
        
        const TU_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxhKFk2WAi-KRY5xGBsI6_6Pvp3jDjt8mSRXvy7I1WehNmBpJamqK9G9Q1ZJSCSgAdfDA/exec';
        
        const urlConCache = TU_APPS_SCRIPT_URL + '?cache=' + Date.now();
        
        const respuesta = await fetch(urlConCache, {
            method: 'GET',
            headers: {
                'Accept': 'application/json'
            }
        });
        
        if (!respuesta.ok) {
            throw new Error(`Error ${respuesta.status}`);
        }
        
        const datos = await respuesta.json();
        
        if (datos.productos && Array.isArray(datos.productos)) {
            processAPIData(datos);
        } else if (Array.isArray(datos)) {
            processAPIData({ productos: datos });
        } else {
            throw new Error('Formato de datos no reconocido');
        }
        
    } catch (error) {
        console.error('üí• ERROR:', error);
        document.getElementById('productsGrid').innerHTML = `
            <div class="error-message">
                <h3>Error al cargar productos</h3>
                <p>${error.message}</p>
                <button onclick="loadProductsFromAPI()" class="retry-btn">
                    üîÑ Reintentar
                </button>
            </div>
        `;
    }
}

function processAPIData(apiData) {
    console.log('üì¶ Procesando datos de API...');
    
    const productosArray = apiData.productos || apiData;
    
    // ========== ADAPTADOR: CONVERTIR NOMBRES ANTIGUOS ==========
    console.log('üîÑ Adaptando nombres de columnas...');
    productosArray.forEach(item => {
        // Convertir oferta1 ‚Üí relampago
        if (item.oferta1 !== undefined && item.relampago === undefined) {
            item.relampago = parseInt(item.oferta1) || 0;
        }
        
        // Convertir oferta2 ‚Üí destacada
        if (item.oferta2 !== undefined && item.destacada === undefined) {
            item.destacada = parseInt(item.oferta2) || 0;
        }
        
        // Convertir categoriaOferta ‚Üí especial
        if (item.categoriaOferta !== undefined && item.especial === undefined) {
            item.especial = parseInt(item.categoriaOferta) || 0;
        }
    });
    console.log('‚úÖ Adaptaci√≥n completada');
    // ========== FIN ADAPTADOR ==========
    
    products = [];
    
    productosArray.forEach((item, index) => {
        const nombre = item.name || 'Producto sin nombre';
        const precio = parseInt(item.price) || 0;
        const descripcion = item.descripcion || `ID${String(index).padStart(3, '0')}`;
        const categoria = String(item.category || 'ALMACEN').trim().toUpperCase();
        const stockNumber = parseInt(item.stock) || 0;
        
        // Leer columnas de ofertas (ahora adaptadas)
        const relampago = parseInt(item.relampago) || 0;
        const destacada = parseInt(item.destacada) || 0;
        const especial = parseInt(item.especial) || 0;
        
        // Validar anti-duplicados
        let ofertasActivas = 0;
        if (relampago > 0) ofertasActivas++;
        if (destacada > 0) ofertasActivas++;
        if (especial > 0) ofertasActivas++;
        
        if (ofertasActivas > 1) {
            console.warn(`‚ö†Ô∏è DUPLICADO: ${nombre} tiene ${ofertasActivas} ofertas`);
        }
        
        const product = {
            id: item.id || index + 1,
            name: nombre,
            price: precio,
            category: categoria,
            stockNumber: stockNumber,
            image: `imagenes-productos/${simplificarNombre(nombre)}.jpg`,
            descripcion: descripcion,
            relampago: relampago,
            destacada: destacada,
            especial: especial
        };
        
        products.push(product);
    });
    
    console.log(`‚úÖ ${products.length} productos cargados`);
    
    renderCategories();
    actualizarTodasLasVistas();
    
    // Actualizar cada minuto
    setInterval(actualizarTodasLasVistas, 60000);
}

function simplificarNombre(nombre) {
    return nombre
        .toLowerCase()
        .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
        .replace(/[^a-z0-9 ]/g, "")
        .replace(/\s+/g, '-')
        .replace(/-+/g, '-')
        .trim();
}

// ========== CATEGOR√çAS ==========
function renderCategories() {
    const categoriesContainer = document.getElementById('categories');
    if (!categoriesContainer) return;
    
    const categories = [...new Set(products.map(p => p.category))];
    
    categoriesContainer.innerHTML = categories.map(category => `
        <button class="category-btn ${category === currentCategory ? 'active' : ''}" 
                data-category="${category}">
            ${category}
        </button>
    `).join('');
    
    categoriesContainer.querySelectorAll('.category-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            currentCategory = this.getAttribute('data-category');
            categoriesContainer.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            renderizarProductosNormales();
        });
    });
}

// ========== FUNCIONES DE C√ÅLCULO DE OFERTAS ==========
function calcularPrecioConOferta(producto, cantidad, esRelampago = false, ofertaRelampago = null) {
    if (!producto) return producto.price * cantidad;
    
    // Si es oferta rel√°mpago y tenemos config
    if (esRelampago && ofertaRelampago) {
        const tipo = ofertaRelampago.tipo;
        const cantidadOferta = ofertaRelampago.cantidad;
        const pagas = ofertaRelampago.pagas;
        
        switch(tipo) {
            case "2x1":
                // 2x1: pagas 1 por cada 2 unidades
                const pares2x1 = Math.floor(cantidad / 2);
                const resto2x1 = cantidad % 2;
                return (pares2x1 + resto2x1) * producto.price;
                
            case "3x2":
                // 3x2: pagas 2 por cada 3 unidades
                const grupos3x2 = Math.floor(cantidad / 3);
                const resto3x2 = cantidad % 3;
                return (grupos3x2 * 2 + resto3x2) * producto.price;
                
            case "4x3":
                // 4x3: pagas 3 por cada 4 unidades
                const grupos4x3 = Math.floor(cantidad / 4);
                const resto4x3 = cantidad % 4;
                return (grupos4x3 * 3 + resto4x3) * producto.price;
                
            case "5x4":
                // 5x4: pagas 4 por cada 5 unidades
                const grupos5x4 = Math.floor(cantidad / 5);
                const resto5x4 = cantidad % 5;
                return (grupos5x4 * 4 + resto5x4) * producto.price;
                
            case "6x5":
                // 6x5: pagas 5 por cada 6 unidades
                const grupos6x5 = Math.floor(cantidad / 6);
                const resto6x5 = cantidad % 6;
                return (grupos6x5 * 5 + resto6x5) * producto.price;
                
            case "7x6":
                // 7x6: pagas 6 por cada 7 unidades
                const grupos7x6 = Math.floor(cantidad / 7);
                const resto7x6 = cantidad % 7;
                return (grupos7x6 * 6 + resto7x6) * producto.price;
                
            case "2da50":
                // 2da unidad 50% OFF: pagas 1.5 por cada 2 unidades
                const pares2da50 = Math.floor(cantidad / 2);
                const resto2da50 = cantidad % 2;
                const precioPar = producto.price * 1.5; // 100% + 50% = 150%
                return (pares2da50 * precioPar) + (resto2da50 * producto.price);
                
            default:
                return producto.price * cantidad;
        }
    }
    // Si es oferta destacada
    else if (producto.destacada && producto.destacada > 0) {
        const descuento = producto.destacada / 100;
        return Math.round(producto.price * (1 - descuento) * cantidad);
    }
    // Si es oferta especial
    else if (producto.especial && producto.especial === 1) {
        return Math.round(producto.price * 0.9 * cantidad);
    }
    
    // Sin oferta
    return producto.price * cantidad;
}

function calcularAhorro(producto, cantidad, esRelampago = false, ofertaRelampago = null) {
    const precioNormal = producto.price * cantidad;
    const precioConOferta = calcularPrecioConOferta(producto, cantidad, esRelampago, ofertaRelampago);
    return Math.max(0, precioNormal - precioConOferta);
}

function calcularAhorro(product, cantidad) {
    const precioNormal = product.price * cantidad;
    const precioConOferta = calcularPrecioConOferta(product, cantidad);
    return precioNormal - precioConOferta;
}

function addToCart(productId) {
    const product = products.find(p => p.id === productId);
    if (!product) {
        showNotification("‚ùå Producto no encontrado", "error");
        return;
    }
    
    const existingItem = cart.find(item => item.id === productId);
    const currentQuantity = existingItem ? existingItem.quantity : 0;
    
    // Verificar stock
    if (currentQuantity >= product.stockNumber) {
        showNotification(`‚ö†Ô∏è Stock m√°ximo: ${product.stockNumber} unidades`, 'warning');
        return;
    }
    
    // Determinar tipo de oferta activa
    let esOfertaEspecial = false;
    let esOfertaDestacada = false;
    let esOfertaRelampago = false;
    let ofertaConfig = null;
    
    // Verificar ofertas ACTIVAS seg√∫n horario
    if (productosEspeciales.some(p => p.id === productId) && validarHorario('especiales')) {
        esOfertaEspecial = true;
        ofertaConfig = {
            nombre: "Especial",
            tipo: "especial",
            descuento: 10,
            eslogan: "üéÅ OFERTA ESPECIAL -10%"
        };
    } 
    else if (productosDestacadas.some(p => p.id === productId) && validarHorario('destacadas')) {
        esOfertaDestacada = true;
        ofertaConfig = {
            nombre: "Destacada",
            tipo: "destacada",
            descuento: product.destacada,
            eslogan: `${product.destacada}% OFF`
        };
    }
    else if (productosRelampago.some(p => p.id === productId) && validarHorario('relampago')) {
        esOfertaRelampago = true;
        const configRelampago = OFERTAS_RELAMPAGO_SISTEMA[product.relampago];
        if (configRelampago) {
            ofertaConfig = {
                nombre: configRelampago.nombre,
                tipo: configRelampago.tipo,
                eslogan: configRelampago.eslogan,
                cantidad: configRelampago.cantidad,
                pagas: configRelampago.pagas
            };
        }
    }
    
    // Actualizar o agregar al carrito
    if (existingItem) {
        existingItem.quantity++;
        if (ofertaConfig) {
            existingItem.oferta = ofertaConfig;
            existingItem.esOfertaEspecial = esOfertaEspecial;
            existingItem.esOfertaDestacada = esOfertaDestacada;
            existingItem.esOfertaRelampago = esOfertaRelampago;
        }
    } else {
        cart.push({
            id: product.id,
            name: product.name,
            price: product.price,
            quantity: 1,
            maxStock: product.stockNumber,
            oferta: ofertaConfig,
            esOfertaEspecial: esOfertaEspecial,
            esOfertaDestacada: esOfertaDestacada,
            esOfertaRelampago: esOfertaRelampago,
            productRef: product // Referencia al producto original
        });
    }
    
    updateCartCount();
    renderCartItems();
    
    // Mensaje de confirmaci√≥n
    let mensaje = `‚úÖ ${product.name} agregado`;
    if (esOfertaEspecial) mensaje = `‚úÖ ${product.name} (üéÅ OFERTA ESPECIAL -10%)`;
    else if (esOfertaDestacada) mensaje = `‚úÖ ${product.name} (üî• ${product.destacada}% OFF)`;
    else if (esOfertaRelampago && ofertaConfig) mensaje = `‚úÖ ${product.name} (‚ö° ${ofertaConfig.eslogan})`;
    
    showNotification(mensaje, 'success');
}

function updateCartCount() {
    const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
    const cartCountElement = document.getElementById('cartCount');
    const floatingCartCountElement = document.getElementById('floatingCartCount');
    
    if (cartCountElement) cartCountElement.textContent = totalItems;
    if (floatingCartCountElement) floatingCartCountElement.textContent = totalItems;
    
    console.log('üõí Carrito actualizado:', totalItems, 'productos');
}

function renderCartItems() {
    const cartItems = document.getElementById('cartItems');
    const cartTotal = document.getElementById('cartTotal');
    
    if (cart.length === 0) {
        cartItems.innerHTML = "<p style='text-align: center; padding: 2rem; color: #666;'>Tu carrito est√° vac√≠o</p>";
        cartTotal.textContent = "Total: $0";
        return;
    }
    
    let total = 0;
    let totalNormal = 0;
    let totalAhorro = 0;
    
    cartItems.innerHTML = cart.map(item => {
        // Encontrar producto original
        const product = item.productRef || products.find(p => p.id === item.id);
        if (!product) return '';
        
        // Calcular precios
        const precioNormalTotal = product.price * item.quantity;
        totalNormal += precioNormalTotal;
        
        let precioUnitario = product.price;
        let precioTotalItem = precioNormalTotal;
        let ahorroItem = 0;
        let badgeOferta = '';
        
        // Aplicar ofertas
        if (item.esOfertaEspecial && item.oferta) {
            // Oferta especial -10%
            precioUnitario = Math.round(product.price * 0.9);
            precioTotalItem = precioUnitario * item.quantity;
            ahorroItem = precioNormalTotal - precioTotalItem;
            badgeOferta = `<span class="oferta-badge">${item.oferta.nombre}</span>`;
        } 
        else if (item.esOfertaDestacada && item.oferta) {
            // Oferta destacada (%)
            const descuento = item.oferta.descuento / 100;
            precioUnitario = Math.round(product.price * (1 - descuento));
            precioTotalItem = precioUnitario * item.quantity;
            ahorroItem = precioNormalTotal - precioTotalItem;
            badgeOferta = `<span class="oferta-badge">üî• ${item.oferta.descuento}%</span>`;
        }
        else if (item.esOfertaRelampago && item.oferta) {
            // Oferta rel√°mpago (2x1, 3x2, etc)
            precioTotalItem = calcularPrecioConOferta(
                product, 
                item.quantity, 
                true, 
                item.oferta
            );
            ahorroItem = precioNormalTotal - precioTotalItem;
            precioUnitario = Math.round(precioTotalItem / item.quantity);
            badgeOferta = `<span class="oferta-badge">‚ö° ${item.oferta.nombre}</span>`;
        }
        
        total += precioTotalItem;
        totalAhorro += ahorroItem;
        
        return `
            <div class="cart-item">
                <div class="cart-item-info">
                    <div class="cart-item-name">
                        ${item.name} ${badgeOferta}
                    </div>
                    <div class="cart-item-price">
                        ${precioUnitario} c/u
                        ${ahorroItem > 0 ? 
                            `<br><small style="color: #4caf50;">‚úÖ Ahorraste: $${ahorroItem}</small>` 
                            : ''}
                    </div>
                </div>
                <div class="cart-item-quantity">
                    <button class="quantity-btn decrease-btn" data-id="${item.id}">-</button>
                    <span class="quantity-value">${item.quantity}</span>
                    <button class="quantity-btn increase-btn" data-id="${item.id}">+</button>
                </div>
            </div>
        `;
    }).join('');
    
    cartTotal.textContent = `TOTAL: $${total}`;
    
    // Mostrar ahorro total si hay ofertas
    if (totalAhorro > 0) {
        const totalSavingsElement = document.getElementById('totalSavings');
        if (!totalSavingsElement) {
            const savingsHTML = `
                <div class="total-savings" id="totalSavings">
                    üéâ ¬°AHORRASTE: $${totalAhorro}! 
                    <small>(Precio normal: $${totalNormal})</small>
                </div>
            `;
            cartItems.insertAdjacentHTML('beforeend', savingsHTML);
        } else {
            totalSavingsElement.innerHTML = `
                üéâ ¬°AHORRASTE: $${totalAhorro}! 
                <small>(Precio normal: $${totalNormal})</small>
            `;
        }
    } else {
        const totalSavingsElement = document.getElementById('totalSavings');
        if (totalSavingsElement) totalSavingsElement.remove();
    }
    
    // Event listeners para cantidades
    setTimeout(() => {
        cartItems.querySelectorAll('.increase-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const productId = parseInt(btn.getAttribute('data-id'));
                addToCart(productId);
            });
        });
        
        cartItems.querySelectorAll('.decrease-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const productId = parseInt(btn.getAttribute('data-id'));
                updateCartQuantity(productId, -1);
            });
        });
    }, 100);
}

function updateCartQuantity(productId, change) {
    const itemIndex = cart.findIndex(item => item.id === productId);
    if (itemIndex === -1) return;
    
    const item = cart[itemIndex];
    const product = item.productRef || products.find(p => p.id === productId);
    
    if (!product) {
        cart.splice(itemIndex, 1);
        updateCartCount();
        renderCartItems();
        return;
    }
    
    const newQuantity = item.quantity + change;
    
    // Verificar l√≠mites
    if (newQuantity < 1) {
        cart.splice(itemIndex, 1);
        showNotification(`‚ùå ${item.name} eliminado del carrito`, "info");
    } else if (newQuantity > product.stockNumber) {
        showNotification(`‚ö†Ô∏è Stock m√°ximo: ${product.stockNumber} unidades`, 'warning');
        return;
    } else {
        item.quantity = newQuantity;
    }
    
    updateCartCount();
    renderCartItems();
}

function sendOrderViaWhatsApp() {
    if (cart.length === 0) {
        showNotification("‚ö†Ô∏è Tu carrito est√° vac√≠o", "warning");
        return;
    }
    
    const phoneNumber = "5492944907380";
    
    let total = 0;
    let totalNormal = 0;
    let orderLines = [];
    let tieneOfertas = false;
    
    cart.forEach(item => {
        // Encontrar producto original
        const product = item.productRef || products.find(p => p.id === item.id);
        if (!product) return;
        
        // Calcular precios
        const precioNormalItem = product.price * item.quantity;
        totalNormal += precioNormalItem;
        
        let precioItem = precioNormalItem;
        let precioUnitario = product.price;
        let ofertaInfo = '';
        
        // Aplicar ofertas
        if (item.esOfertaEspecial && item.oferta) {
            precioUnitario = Math.round(product.price * 0.9);
            precioItem = precioUnitario * item.quantity;
            ofertaInfo = `\n   üéÅ ${item.oferta.eslogan}`;
            tieneOfertas = true;
        }
        else if (item.esOfertaDestacada && item.oferta) {
            const descuento = item.oferta.descuento / 100;
            precioUnitario = Math.round(product.price * (1 - descuento));
            precioItem = precioUnitario * item.quantity;
            ofertaInfo = `\n   üî• ${item.oferta.eslogan}`;
            tieneOfertas = true;
        }
        else if (item.esOfertaRelampago && item.oferta) {
            precioItem = calcularPrecioConOferta(
                product,
                item.quantity,
                true,
                item.oferta
            );
            precioUnitario = Math.round(precioItem / item.quantity);
            ofertaInfo = `\n   ‚ö° ${item.oferta.eslogan}`;
            tieneOfertas = true;
        }
        
        total += precioItem;
        const ahorroItem = precioNormalItem - precioItem;
        const ahorroTexto = ahorroItem > 0 ? ` (üéâ Ahorro: $${ahorroItem})` : '';
        
        orderLines.push(`‚úÖ ${item.name}${ofertaInfo}\n   ${item.quantity} √ó $${precioUnitario} = $${precioItem}${ahorroTexto}`);
    });
    
    // Construir mensaje
    let message = `*üõí PEDIDO ALMAC√âN COPIHUE*\n`;
    message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
    message += `üì¶ *TU COMPRA:*\n\n`;
    message += orderLines.join('\n\n');
    message += `\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
    
    // Totales
    if (tieneOfertas) {
        const ahorroTotal = totalNormal - total;
        message += `üí∞ *SUBTOTAL (sin ofertas):* $${totalNormal}\n`;
        message += `üéâ *AHORRO TOTAL:* $${ahorroTotal}\n`;
        message += `üíµ *TOTAL A PAGAR:* $${total}\n`;
    } else {
        message += `üíµ *TOTAL A PAGAR:* $${total}\n`;
    }
    
    message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
    message += `üìç *Direcci√≥n:* Copihue 457\n`;
    message += `‚è∞ *Horario:* 11:30 a 23:30 hs\n`;
    message += `üì± *Confirm√° por este WhatsApp*\n\n`;
    message += `‚è≥ *Pedido listo en 15-20 minutos*\n`;
    message += `üéâ *Gracias por elegir tu almac√©n de confianza*`;
    
    const encodedMessage = encodeURIComponent(message);
    const whatsappURL = `https://wa.me/${phoneNumber}?text=${encodedMessage}`;
    
    // Limpiar carrito
    cart = [];
    updateCartCount();
    closeCartModal();
    
    // Mostrar confirmaci√≥n
    showNotification("üì§ Enviando pedido por WhatsApp...", "success");
    
    // Abrir WhatsApp
    setTimeout(() => {
        window.open(whatsappURL, "_blank");
    }, 1000);
}

// ========== B√öSQUEDA ==========
function setupSearch() {
    const productSearch = document.getElementById('productSearch');
    const mobileSearch = document.getElementById('mobileSearch');
    const clearSearchBtn = document.getElementById('clearSearchBtn');
    const clearMobileSearchBtn = document.getElementById('clearMobileSearchBtn');
    
    productSearch.addEventListener('input', function(e) {
        const searchTerm = e.target.value.toLowerCase().trim();
        clearSearchBtn.style.display = searchTerm.length > 0 ? 'block' : 'none';
        
        if (searchTerm === '') {
            isSearching = false;
            renderizarProductosNormales();
            return;
        }
        
        if (searchTerm.length >= 2) {
            isSearching = true;
            filterProducts(searchTerm);
        }
    });
    
    mobileSearch.addEventListener('input', function(e) {
        const searchTerm = e.target.value.toLowerCase().trim();
        clearMobileSearchBtn.style.display = searchTerm.length > 0 ? 'block' : 'none';
        
        if (searchTerm === '') {
            document.getElementById('mobileSearchResults').innerHTML = '';
            return;
        }
        
        if (searchTerm.length >= 2) {
            filterMobileProducts(searchTerm);
        }
    });
    
    clearSearchBtn.addEventListener('click', clearSearch);
    clearMobileSearchBtn.addEventListener('click', clearMobileSearch);
}

function filterProducts(searchTerm) {
    const productsGrid = document.getElementById('productsGrid');
    
    const results = products.filter(p => 
        p.name.toLowerCase().includes(searchTerm) && 
        p.stockNumber > 0
    );
    
    if (results.length === 0) {
        productsGrid.innerHTML = `
            <div class="loading">
                <div style="font-size: 3rem; margin-bottom: 1rem;">üîç</div>
                <h3>No se encontraron productos para "${searchTerm}"</h3>
                <button onclick="clearSearch()" class="retry-btn">
                    ‚ú® Ver todos los productos
                </button>
            </div>
        `;
        return;
    }
    
    productsGrid.innerHTML = `
        <div class="search-results">
            <strong>üîç B√∫squeda: "${searchTerm}"</strong>
            <br>
            <small>Encontraste ${results.length} producto(s)</small>
            <button onclick="clearSearch()" style="margin-left: 10px; padding: 6px 12px; 
                    background: #ff6f00; color: white; border: none; border-radius: 15px; 
                    cursor: pointer; font-size: 0.8rem;">
                ‚úñÔ∏è Limpiar b√∫squeda
            </button>
        </div>
    ` + results.map(product => `
        <div class="product-card">
            <div class="product-image">
                <img src="${product.image}" 
                     alt="${product.name}"
                     onerror="handleImageError(this, '${product.name.replace(/'/g, "\\'")}')">
            </div>
            <div class="product-info">
                <div class="product-name">${product.name}</div>
                <div class="product-price-container">
                    <span class="product-price">${product.price}</span>
                </div>
                <div class="product-stock in-stock">
                    ‚úÖ Stock: ${product.stockNumber}
                </div>
                <button class="add-to-cart" data-id="${product.id}">
                    üõí Agregar al Carrito
                </button>
            </div>
        </div>
    `).join('');
    
    // LOS EVENT LISTENERS YA NO SON NECESARIOS AQU√ç
    // porque usamos event delegation en setupEventListeners
}

function testCalculosOfertas() {
    console.log("üß™ TEST DE C√ÅLCULOS DE OFERTAS");
    
    // Crear producto de prueba
    const productoTest = {
        id: 999,
        name: "Producto Test",
        price: 100,
        stockNumber: 10,
        destacada: 20, // 20% OFF
        especial: 1, // -10%
        relampago: 1 // 2x1
    };
    
    // Test oferta destacada (20% OFF)
    const precioDestacada = calcularPrecioConOferta(productoTest, 2);
    console.log(`üî• Oferta Destacada (20% OFF):`);
    console.log(`   Precio normal: $${productoTest.price * 2} = $200`);
    console.log(`   Con oferta: $${precioDestacada}`);
    console.log(`   Ahorro: $${calcularAhorro(productoTest, 2)}`);
    
    // Test oferta especial (-10%)
    const precioEspecial = calcularPrecioConOferta(productoTest, 3);
    console.log(`üéÅ Oferta Especial (-10%):`);
    console.log(`   Precio normal: $${productoTest.price * 3} = $300`);
    console.log(`   Con oferta: $${precioEspecial}`);
    console.log(`   Ahorro: $${calcularAhorro(productoTest, 3)}`);
    
    // Test oferta rel√°mpago (2x1)
    const config2x1 = OFERTAS_RELAMPAGO_SISTEMA[1];
    const precioRelampago = calcularPrecioConOferta(productoTest, 5, true, config2x1);
    console.log(`‚ö° Oferta Rel√°mpago (2x1):`);
    console.log(`   Precio normal: $${productoTest.price * 5} = $500`);
    console.log(`   Con oferta: $${precioRelampago}`);
    console.log(`   Ahorro: $${calcularAhorro(productoTest, 5, true, config2x1)}`);
    
    console.log("‚úÖ Test completado");
}

// Llamar despu√©s de init()
setTimeout(() => testCalculosOfertas(), 2000);

function filterMobileProducts(searchTerm) {
    const resultsContainer = document.getElementById('mobileSearchResults');
    
    const results = products.filter(p => 
        p.name.toLowerCase().includes(searchTerm) && 
        p.stockNumber > 0
    );
    
    if (results.length === 0) {
        resultsContainer.innerHTML = `
            <div style="text-align: center; padding: 2rem; color: #666;">
                üîç No se encontraron productos para "<strong>${searchTerm}</strong>"
            </div>
        `;
        return;
    }
    
    resultsContainer.innerHTML = '<div style="display: grid; gap: 1rem;">' + 
        results.map(product => `
            <div class="product-card" style="margin: 0;">
                <div class="product-image">
                    <img src="${product.image}" 
                         alt="${product.name}"
                         onerror="handleImageError(this, '${product.name.replace(/'/g, "\\'")}')">
                </div>
                <div class="product-info">
                    <div class="product-name">${product.name}</div>
                    <div class="product-price-container">
                        <span class="product-price">${product.price}</span>
                    </div>
                    <div class="product-stock in-stock">
                        ‚úÖ Stock: ${product.stockNumber}
                    </div>
                    <button class="add-to-cart" data-id="${product.id}">
                        üõí Agregar al Carrito
                    </button>
                </div>
            </div>
        `).join('') + '</div>';
    
    setTimeout(() => {
        resultsContainer.querySelectorAll('.add-to-cart').forEach(btn => {
            btn.addEventListener('click', () => {
                const productId = parseInt(btn.getAttribute('data-id'));
                addToCart(productId);
            });
        });
    }, 100);
}

function clearSearch() {
    document.getElementById('productSearch').value = '';
    document.getElementById('clearSearchBtn').style.display = 'none';
    isSearching = false;
    renderizarProductosNormales();
}

function clearMobileSearch() {
    document.getElementById('mobileSearch').value = '';
    document.getElementById('clearMobileSearchBtn').style.display = 'none';
    document.getElementById('mobileSearchResults').innerHTML = '';
}

// ========== MODALES ==========
function openCart() {
    renderCartItems();
    document.getElementById('cartModal').style.display = "flex";
}

function closeCartModal() {
    document.getElementById('cartModal').style.display = "none";
}

function openSearchModal() {
    document.getElementById('searchModal').style.display = "flex";
    document.getElementById('mobileSearch').focus();
}

function closeSearchModal() {
    document.getElementById('searchModal').style.display = "none";
    clearMobileSearch();
}

// ========== UTILIDADES ==========
function handleImageError(img, productName) {
    const colors = ['#e8f5e9', '#f1f8e9', '#f9fbe7', '#fffde7', '#fff3e0'];
    const randomColor = colors[Math.floor(Math.random() * colors.length)];
    
    img.src = '';
    img.onerror = null;
    
    const container = img.parentElement;
    container.style.background = `linear-gradient(135deg, ${randomColor}, #c8e6c9)`;
    container.style.display = 'flex';
    container.style.justifyContent = 'center';
    container.style.alignItems = 'center';
    
    const icon = document.createElement('div');
    icon.innerHTML = 'üõí';
    icon.style.fontSize = '3rem';
    icon.style.opacity = '0.5';
    
    const text = document.createElement('div');
    text.textContent = productName.length > 20 ? productName.substring(0, 20) + '...' : productName;
    text.style.position = 'absolute';
    text.style.bottom = '10px';
    text.style.fontSize = '0.7rem';
    text.style.color = '#666';
    text.style.padding = '0 10px';
    text.style.textAlign = 'center';
    
    container.innerHTML = '';
    container.appendChild(icon);
    container.appendChild(text);
}

function showNotification(message, type = 'success') {
    const notification = document.createElement('div');
    notification.className = 'stock-notification';
    notification.style.background = type === 'success' ? '#4CAF50' : '#ff9800';
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 2000);
}

// ========== EVENT LISTENERS ==========
function setupEventListeners() {
    // Carrito
    document.getElementById('cartIcon').addEventListener('click', openCart);
    document.getElementById('floatingCart').addEventListener('click', openCart);
    document.getElementById('closeCart').addEventListener('click', closeCartModal);
    
    // B√∫squeda
    document.getElementById('floatingSearch').addEventListener('click', openSearchModal);
    document.getElementById('closeSearch').addEventListener('click', closeSearchModal);
    
    // WhatsApp
    document.getElementById('sendOrder').addEventListener('click', sendOrderViaWhatsApp);
    
    // Modales
    document.getElementById('cartModal').addEventListener('click', function(e) {
        if (e.target === this) closeCartModal();
    });
    
    document.getElementById('searchModal').addEventListener('click', function(e) {
        if (e.target === this) closeSearchModal();
    });
    
    // EVENT DELEGATION PARA TODOS LOS BOTONES "AGREGAR AL CARRITO"
    document.addEventListener('click', function(e) {
        // Verificar si el clic fue en un bot√≥n "Agregar al Carrito" o en un elemento dentro
        const addToCartBtn = e.target.closest('.add-to-cart');
        if (addToCartBtn) {
            const productId = parseInt(addToCartBtn.getAttribute('data-id'));
            if (!isNaN(productId)) {
                addToCart(productId);
            }
        }
    });
}

// ========== ADMIN ==========
function detectarAdmin() {
    const urlParams = new URLSearchParams(window.location.search);
    esAdmin = urlParams.has('admin');
    
    if (esAdmin) {
        document.getElementById('adminBadge').style.display = 'inline-block';
        document.getElementById('adminNotification').style.display = 'block';
        console.log('üîê Modo Admin activado');
    }
}

// ========== INICIALIZACI√ìN ==========
function init() {
    console.log('üöÄ Inicializando Almac√©n Copihue ' + APP_VERSION);
    
    detectarAdmin();
    setupEventListeners();
    setupSearch();
    updateCartCount();
    
    loadProductsFromAPI();
    
    // Service Worker
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./sw.js?v=' + APP_VERSION)
            .then(registration => {
                console.log('‚úÖ Service Worker registrado');
            })
            .catch(error => {
                console.error('‚ùå Error Service Worker:', error);
            });
    }
}

document.addEventListener("DOMContentLoaded", init);

console.log('üéØ Sistema de 3 Ofertas cargado - Versi√≥n ' + APP_VERSION);
</script>
</body>
</html>
