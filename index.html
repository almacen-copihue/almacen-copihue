<!DOCTYPE html>
<html lang="es">
<head>
    <!-- tooladminOFERTAS REELAMPAGO Y DESTACADAS SEPARADAS Y NUEVOS HORARIOSmas utiladminreparaofertasdestacadastoolv31.html -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Almacén Copihue - Productos de calidad con la confianza de siempre</title>
    
    <!-- META TAGS PARA PWA -->
    <meta name="theme-color" content="#2e7d32">
    <meta name="description" content="Almacén Copihue">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Almacén Copihue">
    
    <!-- SISTEMA ANTI-CACHE CAPA 1 -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <!-- ICONOS -->
    <link rel="icon" href="iconos-pwa/android/android-launchericon-48-48.png" type="image/png">
    <link rel="apple-touch-icon" href="iconos-pwa/ios/180.png">
    <link rel="apple-touch-icon" sizes="152x152" href="iconos-pwa/ios/152.png">
    <link rel="apple-touch-icon" sizes="167x167" href="iconos-pwa/ios/167.png">
    <link rel="apple-touch-icon" sizes="180x180" href="iconos-pwa/ios/180.png">
    <link rel="apple-touch-startup-image" href="iconos-pwa/ios/1024.png">
    
    <!-- MANIFEST EXTERNO -->
    <link rel="manifest" href="manifest.json">
    
    <!-- ESTILOS -->
    <style>
        /* ESTILOS EXISTENTES - SE MANTIENEN IGUAL */
        :root {
            --primary: #2e7d32;
            --primary-dark: #1b5e20;
            --primary-light: #4caf50;
            --secondary: #ff6f00;
            --secondary-dark: #f57c00;
            --accent: #ffeb3b;
            --light: #f8fff8;
            --dark: #1b5e20;
            --gray: #757575;
            --white: #ffffff;
            --card-bg: #ffffff;
            --shadow: 0 4px 15px rgba(46,125,50,0.1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--light);
            color: var(--dark);
            line-height: 1.6;
            background-image: linear-gradient(135deg, #f8fff8 0%, #e8f5e9 100%);
        }
        
        header {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: var(--white);
            padding: 1rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow);
        }
        
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .logo-icon {
            font-size: 1.8rem;
        }

        .admin-badge {
            background: var(--secondary);
            color: white;
            padding: 0.2rem 0.6rem;
            border-radius: 12px;
            font-size: 0.7rem;
            margin-left: 0.5rem;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        .cart-icon {
            position: relative;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: background 0.3s;
        }
        
        .cart-icon:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .cart-count {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--secondary);
            color: white;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }
        
        .hero {
            background: linear-gradient(135deg, rgba(46,125,50,0.9), rgba(76,175,80,0.8));
            background-size: cover;
            color: white;
            padding: 3rem 1rem;
            text-align: center;
            border-radius: 15px;
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
        }
        
        .hero h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .hero p {
            font-size: 1.1rem;
            margin-bottom: 1rem;
            opacity: 0.9;
        }
        
        .info-bar {
            background-color: var(--white);
            padding: 1.2rem;
            border-radius: 12px;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-around;
            text-align: center;
            border-left: 4px solid var(--secondary);
        }
        
        .info-item {
            margin: 0.5rem;
            font-weight: 500;
        }
        
        /* ========== OFERTAS RELÁMPAGO ========== */
        .flash-sales-container {
            display: none;
            margin-bottom: 2rem;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 30px rgba(255, 0, 0, 0.15);
            border: 3px solid #ff3d00;
            position: relative;
            background: linear-gradient(135deg, #fff8e1, #ffecb3);
        }
        
        .flash-sales-header {
            background: linear-gradient(135deg, #ff3d00, #d50000);
            color: white;
            padding: 1rem;
            text-align: center;
            position: relative;
        }
        
        .flash-sales-header h2 {
            font-size: 1.4rem;
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .flash-badge {
            background: #ffff00;
            color: #d50000;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
            animation: flash 1.5s infinite;
        }
        
        @keyframes flash {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .flash-timer {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 15px;
            border-radius: 25px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        .flash-products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            padding: 1.5rem;
            background: white;
        }
        
        .flash-product-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(255, 61, 0, 0.1);
            border: 2px solid #ffccbc;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .flash-product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(255, 61, 0, 0.2);
            border-color: #ff3d00;
        }
        
        .flash-exclusive-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            background: linear-gradient(135deg, #ff3d00, #ff6d00);
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
            z-index: 10;
            box-shadow: 0 3px 10px rgba(255, 61, 0, 0.3);
        }
        
        .flash-price {
            color: #d50000;
            font-size: 1.3rem;
            font-weight: bold;
            margin: 5px 0;
        }
        
        .flash-discount {
            background: #ffeb3b;
            color: #d50000;
            padding: 3px 8px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 0.9rem;
            margin-left: 10px;
        }
        
        .flash-stock-warning {
            background: #ffecb3;
            color: #ff6f00;
            padding: 0.8rem;
            border-radius: 8px;
            margin-top: 1rem;
            text-align: center;
            font-size: 0.9rem;
            border-left: 4px solid #ff9800;
        }
        
        .flash-countdown-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
            border-radius: 15px;
        }
        
        .countdown-message {
            text-align: center;
            padding: 2rem;
        }
        
        .countdown-message h3 {
            color: #d50000;
            margin-bottom: 1rem;
        }
        
        .tomorrow-countdown {
            background: #e8f5e9;
            padding: 1rem;
            border-radius: 10px;
            text-align: center;
            margin-top: 1rem;
            border: 2px dashed #4CAF50;
        }
        
        .featured-offers {
            margin-bottom: 2rem;
            text-align: center;
        }
        
        .featured-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding: 0 0.5rem;
        }
        
        .featured-title {
            font-size: 1.5rem;
            color: var(--primary);
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .view-all-offers {
            background: linear-gradient(135deg, #ff6f00, #f57c00);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9rem;
            transition: all 0.3s;
        }
        
        .view-all-offers:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255,111,0,0.3);
        }
        
        .search-container {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            padding: 1rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #e8f5e9;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-radius: 12px;
            position: relative;
        }
        
        .search-wrapper {
            position: relative;
            width: 100%;
        }
        
        .search-input {
            width: 100%;
            padding: 14px 50px 14px 20px;
            border: 2px solid var(--primary);
            border-radius: 25px;
            font-size: 1rem;
            background: white;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(46,125,50,0.1);
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--primary-dark);
            box-shadow: 0 0 0 3px rgba(46,125,50,0.2);
        }
        
        .clear-search {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: var(--gray);
            transition: color 0.3s;
            padding: 5px;
            z-index: 2;
            display: none;
        }
        
        .clear-search:hover {
            color: var(--primary);
        }
        
        .search-results {
            text-align: center;
            padding: 12px;
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            border-radius: 10px;
            margin-bottom: 1rem;
            border-left: 4px solid #2196f3;
        }

        /* ========== SISTEMA CIAN/AZUL PARA CATEGORÍAS ========== */
        /* ========== MÓVIL: SCROLL HORIZONTAL ========== */
        /* ========== DESKTOP: BOTONES NORMALES ========== */

        /* ----- BOTÓN BASE ----- */
        .category-btn {
            background: #29B6F6;
            border: 2px solid #0288D1;
            color: #FFFFFF;
            box-shadow: 0 2px 6px rgba(2, 136, 209, 0.2);
            font-weight: 600;
            padding: 0.7rem 1.2rem;
            border-radius: 25px;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.25s ease;
            position: relative;
            user-select: none;
        }

        /* ----- BOTÓN ACTIVO (categoría seleccionada) ----- */
        .category-btn.active {
            background: #0288D1;
            border-color: #29B6F6;
            color: #FFFFFF;
            box-shadow: 0 4px 12px rgba(41, 182, 246, 0.3);
            transform: translateY(-1px);
        }

        /* ----- HOVER (solo desktop - opcional) ----- */
        @media (hover: hover) {
            .category-btn:hover:not(.active) {
                background: #03A9F4;
                border-color: #0277BD;
                transform: translateY(-1px);
                box-shadow: 0 3px 8px rgba(2, 119, 189, 0.25);
            }
            .category-btn.active:hover {
                background: #0277BD;
                border-color: #4FC3F7;
            }
        }
        
        /* ----- BADGE DE OFERTAS (naranja vibrante) ----- */
        .offer-count-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #FF6F00;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: bold;
            min-width: 20px;
            text-align: center;
            border: 2px solid #FFFFFF;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 1;
        }

        /* ----- CATEGORÍAS EN DESKTOP ----- */
        @media (min-width: 768px) {
            .categories {
                display: flex;
                flex-wrap: wrap;
                gap: 0.8rem;
                margin-bottom: 2rem;
                justify-content: flex-start;
            }
            
            .category-btn {
                padding: 0.8rem 1.5rem;
                font-size: 0.9rem;
                min-width: auto;
            }
            
            .offer-count-badge {
                top: -6px;
                right: -6px;
                font-size: 0.75rem;
                padding: 2px 6px;
                min-width: 22px;
            }
        }

        /* ----- CATEGORÍAS EN MÓVIL (SCROLL HORIZONTAL) ----- */
        @media (max-width: 767px) {
            .categories {
                display: flex;
                overflow-x: auto;
                gap: 0.6rem;
                margin-bottom: 1.5rem;
                padding-bottom: 0.5rem;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: thin;
                scrollbar-color: #0288D1 #e8f5e9;
            }
            
            .categories::-webkit-scrollbar {
                height: 6px;
            }
            
            .categories::-webkit-scrollbar-track {
                background: #e8f5e9;
                border-radius: 10px;
            }
            
            .categories::-webkit-scrollbar-thumb {
                background: #0288D1;
                border-radius: 10px;
            }
            
            .category-btn {
                padding: 0.8rem 1rem;
                font-size: 0.85rem;
                min-width: max-content;
                flex-shrink: 0;
            }
            
            /* Ocultar dropdown en móvil */
            .categories-dropdown-container {
                display: none !important;
            }
            
            .offer-count-badge {
                top: -5px;
                right: -5px;
                font-size: 0.65rem;
                padding: 1px 4px;
                min-width: 18px;
            }
        }

        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        @media (min-width: 1200px) {
            .products-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        @media (min-width: 768px) and (max-width: 1199px) {
            .products-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 767px) {
            .products-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .cart-icon {
                display: none;
            }
            
            .featured-header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }
        }

        @media (max-width: 480px) {
            .products-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .product-card {
            background-color: var(--card-bg);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            border: 1px solid #e8f5e9;
            position: relative;
        }
        
        .product-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 8px 25px rgba(46,125,50,0.15);
        }
        
        .offer-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: linear-gradient(135deg, #ff6f00, #f57c00);
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.75rem;
            font-weight: bold;
            z-index: 10;
            box-shadow: 0 3px 10px rgba(255,111,0,0.3);
        }
        
        .promo-badge {
            position: absolute;
            top: 40px;
            right: 10px;
            background: linear-gradient(135deg, #4caf50, #2e7d32);
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.7rem;
            font-weight: bold;
            z-index: 10;
            box-shadow: 0 3px 10px rgba(46,125,50,0.3);
        }
        
        .product-image {
            height: 160px;
            background: linear-gradient(135deg, #e8f5e8, #c8e6c9);
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0.8rem;
            position: relative;
            overflow: hidden;
        }
        
        .product-image img {
            max-width: 100%;
            max-height: 130px;
            object-fit: contain;
            transition: transform 0.3s ease;
        }
        
        .product-card:hover .product-image img {
            transform: scale(1.05);
        }
        
        .product-info {
            padding: 1rem;
        }
        
        .product-name {
            font-weight: 600;
            margin-bottom: 0.4rem;
            font-size: 0.9rem;
            color: var(--dark);
            line-height: 1.3;
        }
        
        .product-price-container {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 0.5rem;
        }
        
        .original-price {
            color: var(--gray);
            text-decoration: line-through;
            font-size: 0.9rem;
        }
        
        .product-price {
            color: var(--secondary);
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        .discount-percent {
            background: #ffeb3b;
            color: #333;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: bold;
        }
        
        .product-stock {
            font-size: 0.75rem;
            margin-bottom: 0.8rem;
            font-weight: 500;
        }
        
        .in-stock {
            color: var(--primary-light);
        }
        
        .out-of-stock {
            color: var(--gray);
        }

        .low-stock {
            color: #ff9800;
            font-weight: bold;
        }
        
        .add-to-cart {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            border: none;
            padding: 0.7rem;
            border-radius: 8px;
            width: 100%;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .add-to-cart:hover {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary));
            transform: translateY(-2px);
        }
        
        .add-to-cart:disabled {
            background: var(--gray);
            cursor: not-allowed;
            transform: none;
        }

        .cart-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .cart-content {
            background-color: var(--white);
            width: 90%;
            max-width: 500px;
            border-radius: 15px;
            padding: 1.5rem;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow);
        }
        
        .cart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            border-bottom: 2px solid #e8f5e9;
            padding-bottom: 0.8rem;
        }
        
        .close-cart {
            background: none;
            border: none;
            font-size: 1.8rem;
            cursor: pointer;
            color: var(--gray);
            transition: color 0.3s;
        }
        
        .close-cart:hover {
            color: var(--primary);
        }
        
        .cart-items {
            margin-bottom: 1rem;
        }
        
        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.8rem 0;
            border-bottom: 1px solid #e8f5e9;
        }
        
        .cart-item-info {
            flex-grow: 1;
        }
        
        .cart-item-name {
            font-weight: bold;
            color: var(--dark);
        }
        
        .cart-item-price {
            color: var(--gray);
            font-size: 0.9rem;
        }
        
        .cart-item-quantity {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .quantity-btn {
            background-color: var(--light);
            border: 1px solid #c8e6c9;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .quantity-btn:hover {
            background-color: var(--primary-light);
            color: white;
        }
        
        .quantity-value {
            margin: 0 0.5rem;
            font-weight: bold;
            min-width: 20px;
            text-align: center;
        }
        
        .cart-total {
            font-weight: bold;
            font-size: 1.3rem;
            text-align: right;
            margin-bottom: 1rem;
            color: var(--primary);
            padding-top: 1rem;
            border-top: 2px solid #e8f5e9;
        }
        
        .total-savings {
            background: #4caf50;
            color: white;
            padding: 0.8rem;
            border-radius: 8px;
            margin: 0.5rem 0;
            text-align: center;
            font-weight: bold;
        }
        
        .send-order {
            background: linear-gradient(135deg, var(--secondary), var(--secondary-dark));
            color: white;
            border: none;
            padding: 1.2rem;
            border-radius: 10px;
            width: 100%;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .send-order:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255,111,0,0.3);
        }
        
        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--gray);
            font-size: 1.1rem;
        }
        
        .error-message {
            text-align: center;
            padding: 2rem;
            color: #d32f2f;
            background: #ffebee;
            border-radius: 10px;
            margin: 1rem 0;
            border-left: 4px solid #d32f2f;
        }
        
        .retry-btn {
            margin-top: 10px;
            padding: 10px 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.3s;
        }
        
        .retry-btn:hover {
            background: var(--primary-dark);
        }
        
        footer {
            background: linear-gradient(135deg, var(--dark), var(--primary));
            color: var(--white);
            padding: 2rem 1rem;
            text-align: center;
            margin-top: 3rem;
        }
        
        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
        }

        .admin-notification {
            background: linear-gradient(135deg, #ff9800, #f57c00);
            color: white;
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            text-align: center;
            animation: slideIn 0.5s ease;
        }

        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* PWA */
        .install-prompt {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 15px 20px;
            border-radius: 50px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            cursor: pointer;
            z-index: 1000;
            display: none;
            align-items: center;
            gap: 10px;
            font-weight: bold;
            font-size: 16px;
            animation: slideUp 0.5s ease;
            border: 2px solid white;
        }
        
        @keyframes slideUp {
            from { transform: translateY(100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .install-prompt:hover {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary));
            transform: scale(1.05);
        }
        
        .success-notification {
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: #4CAF50;
            color: white;
            padding: 15px 30px;
            border-radius: 50px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            z-index: 10000;
            font-weight: bold;
            text-align: center;
            animation: fadeInOut 3s ease;
        }
        
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
            20% { opacity: 1; transform: translateX(-50%) translateY(0); }
            80% { opacity: 1; transform: translateX(-50%) translateY(0); }
            100% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
        }

        /* FLOTANTE CELULAR */
        .floating-cart {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, var(--secondary), var(--secondary-dark));
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(255,111,0,0.4);
            z-index: 999;
            transition: all 0.3s ease;
            font-size: 1.5rem;
        }
        
        .floating-cart:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(255,111,0,0.6);
        }
        
        .floating-cart .cart-count {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--primary);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.8rem;
            font-weight: bold;
            border: 2px solid white;
        }

        .floating-search {
            position: fixed;
            bottom: 90px;
            right: 20px;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: none;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(46,125,50,0.4);
            z-index: 998;
            transition: all 0.3s ease;
            font-size: 1.5rem;
        }
        
        .floating-search:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(46,125,50,0.6);
        }

        .search-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1001;
            justify-content: center;
            align-items: flex-start;
            padding-top: 80px;
        }
        
        .search-modal-content {
            background-color: var(--white);
            width: 90%;
            max-width: 500px;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
        }
        
        .search-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            border-bottom: 2px solid #e8f5e9;
            padding-bottom: 0.8rem;
        }
        
        .close-search {
            background: none;
            border: none;
            font-size: 1.8rem;
            cursor: pointer;
            color: var(--gray);
            transition: color 0.3s;
        }
        
        .close-search:hover {
            color: var(--primary);
        }

        @media (max-width: 767px) {
            .search-container {
                display: none;
            }
            
            .floating-search {
                display: flex;
            }
        }

        .stock-notification {
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: #f44336;
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1002;
            font-weight: 500;
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from { 
                transform: translateX(-50%) translateY(-20px); 
                opacity: 0; 
            }
            to { 
                transform: translateX(-50%) translateY(0); 
                opacity: 1; 
            }
        }
        
        .search-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            z-index: 1000;
            max-height: 300px;
            overflow-y: auto;
            display: none;
        }
        
        .suggestion-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
        }
        
        .suggestion-item:hover {
            background: #f5f5f5;
        }
        
        .suggestion-name {
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .suggestion-details {
            font-size: 0.8rem;
            color: #666;
        }
        
        .suggestion-badge {
            background: #ff9800;
            color: white;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 0.7rem;
        }

        .mobile-search-results {
            margin-top: 1rem;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .promo-limit {
            font-size: 0.7rem;
            color: #666;
            margin-bottom: 5px;
            font-style: italic;
        }
        
        .offer-description {
            font-size: 0.8rem;
            color: #ff6f00;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .limit-notification {
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: #ff9800;
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1002;
            font-weight: 500;
            animation: slideDown 0.3s ease;
        }
        
        .tipo-venta-icon {
            font-size: 0.8rem;
            margin-right: 4px;
            vertical-align: middle;
        }
        
        .stock-tipo {
            display: inline-block;
            margin-left: 5px;
            font-size: 0.7rem;
            color: #666;
            font-weight: 500;
        }
        
        /* Ocultar botón Ver productos con oferta en TODA la página */
        #viewAllOffers,
        .view-all-offers {
            display: none !important;
        }
        
        /* Botón "Compartir esta OFERTA" (solo aparece en la mayor oferta) */
        .share-offer-btn {
            margin-top: 8px;
            width: 100%;
            padding: 10px 14px;
            border: none;
            border-radius: 18px;
            font-size: 14px;
            font-weight: 600;
            background: linear-gradient(135deg,#00c853,#00b14a);
            color: white;
            cursor: pointer;
            box-shadow: 0 3px 12px rgba(0,0,0,0.18);
        }
        .share-offer-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 18px rgba(0,0,0,0.22);
        }

        /* Ocultar dropdown en toda la página */
        .categories-dropdown-container {
            display: none !important;
        }

        /* NUEVOS ESTILOS PARA TEXTO DE OFERTA PROGRESIVA */
        .progressive-offer-info {
            background: #e8f5e9;
            border-radius: 8px;
            padding: 8px 10px;
            margin: 5px 0 10px 0;
            border-left: 3px solid #4CAF50;
            font-size: 0.75rem;
        }
        
        .progressive-level {
            display: inline-block;
            margin-right: 6px;
            padding: 2px 6px;
            background: #4CAF50;
            color: white;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.7rem;
        }
        
        .progressive-text {
            color: #1b5e20;
            font-weight: 500;
        }
        
        .progressive-highlight {
            color: #ff6f00;
            font-weight: bold;
        }
        
        /* ESTILOS PARA OFERTA 3x2 ESPECÍFICOS */
        .oferta-3x2-detalle {
            background: #fff8e1;
            border-radius: 8px;
            padding: 8px 10px;
            margin: 5px 0 10px 0;
            border-left: 3px solid #ff9800;
            font-size: 0.75rem;
            color: #5d4037;
        }
        
        .oferta-3x2-titulo {
            font-weight: bold;
            color: #ff6f00;
            margin-bottom: 3px;
        }
        
        .oferta-3x2-ejemplo {
            font-size: 0.7rem;
            color: #795548;
        }
        
        /* ========== OFERTAS ESPECIALES ========== */
        .especiales-container {
            margin-bottom: 2rem;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 30px rgba(156, 39, 176, 0.15);
            border: 3px solid #9c27b0;
            position: relative;
            background: linear-gradient(135deg, #f3e5f5, #e1bee7);
        }

        .especiales-header {
            background: linear-gradient(135deg, #9c27b0, #7b1fa2);
            color: white;
            padding: 1rem;
            text-align: center;
            position: relative;
        }

        .especiales-header h2 {
            font-size: 1.4rem;
            margin: 0;
            display: flex;
                align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .especial-badge {
            background: #ffeb3b;
            color: #7b1fa2;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
            animation: pulse 1.5s infinite;
        }

        .especial-timer {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 15px;
            border-radius: 25px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
            font-weight: bold;
            font-size: 1rem;
        }

        .especiales-products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            padding: 1.5rem;
            background: white;
        }

        .especiales-info {
            background: #f3e5f5;
            color: #6a1b9a;
            padding: 0.8rem;
            text-align: center;
            font-size: 0.9rem;
            border-top: 2px dashed #ba68c8;
        }

        .jerarquia-especiales {
            border: 2px solid #9c27b0;
            box-shadow: 0 0 10px rgba(156, 39, 176, 0.2);
        }
        
        /* ESTILOS PARA BOTÓN CASITA FLOTANTE */
        .floating-home {
            position: fixed;
            bottom: 160px;
            right: 20px;
            background: linear-gradient(135deg, #2196F3, #0D47A1);
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(33, 150, 243, 0.4);
            z-index: 997;
            transition: all 0.3s ease;
            font-size: 1.8rem;
        }

        .floating-home:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(33, 150, 243, 0.6);
        }

        /* Ajustar posición de otros botones flotantes */
        .floating-search {
            bottom: 90px; /* Subimos la búsqueda */
        }

        .floating-cart {
            bottom: 20px; /* El carrito queda abajo */
        }

        /* En móvil, reorganizar los botones */
        @media (max-width: 767px) {
            .floating-home {
                bottom: 150px;
                right: 20px;
                width: 55px;
                height: 55px;
                font-size: 1.6rem;
            }
            
            .floating-search {
                bottom: 85px;
                width: 55px;
                height: 55px;
                font-size: 1.3rem;
            }
            
            .floating-cart {
                bottom: 20px;
                width: 55px;
                height: 55px;
                font-size: 1.3rem;
            }
            
            .floating-cart .cart-count {
                width: 22px;
                height: 22px;
                font-size: 0.7rem;
            }
        }

        /* ESTILOS PARA EL MENÚ DE ADMINISTRACIÓN */
        .admin-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .admin-btn:hover {
            background: #45a049;
            transform: translateY(-2px);
        }
        
        .admin-btn.active {
            background: #2e7d32;
            box-shadow: 0 0 0 2px white, 0 0 0 4px #4CAF50;
        }
        
        .admin-btn-relampago {
            background: #ff3d00;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .admin-btn-relampago:hover {
            background: #d50000;
            transform: translateY(-2px);
        }
        
        .admin-btn-relampago.active {
            background: #b71c1c;
            box-shadow: 0 0 0 2px white, 0 0 0 4px #ff3d00;
        }
        
        .admin-btn-secundario {
            background: #2196F3;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .admin-btn-secundario:hover {
            background: #1976D2;
        }
        
        .admin-btn.danger {
            background: #f44336;
        }
        
        .admin-btn.danger:hover {
            background: #d32f2f;
        }
        
        .admin-btn-avanzado {
            background: #9c27b0;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.8rem;
            transition: all 0.2s;
        }
        
        .admin-btn-avanzado:hover {
            background: #7b1fa2;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        /* Estilos responsivos para menú admin */
        @media (max-width: 767px) {
            #adminMenuPanel {
                width: 90% !important;
                right: 5% !important;
                left: 5% !important;
                max-height: 80vh;
                overflow-y: auto;
            }
            
            #adminMenuPanel .admin-btn,
            #adminMenuPanel .admin-btn-relampago,
            #adminMenuPanel .admin-btn-secundario {
                padding: 10px !important;
                font-size: 0.9rem !important;
            }
        }
        
        @media (max-width: 480px) {
            #adminMenuPanel {
                padding: 15px !important;
            }
            
            #adminMenuPanel h3 {
                font-size: 1.2rem !important;
            }
            
            #adminMenuPanel h4 {
                font-size: 1rem !important;
            }
        }
        
        /* ESTILOS PARA JERARQUÍA DE OFERTAS */
        .jerarquia-relampago {
            border: 3px solid #ff3d00;
            box-shadow: 0 0 15px rgba(255, 61, 0, 0.2);
        }
        
        .jerarquia-destacadas {
            border: 2px solid #ff9800;
            box-shadow: 0 0 10px rgba(255, 152, 0, 0.2);
        }
        
        .jerarquia-reserva {
            border: 2px dashed #9c27b0;
            background: #f3e5f5;
        }
        
        .horario-destacadas {
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* NUEVO: PANEL DE ADMINISTRACIÓN FLOTANTE */
        .admin-panel {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            z-index: 9999;
            width: 320px;
            max-height: 80vh;
            overflow-y: auto;
            display: none;
            border: 3px solid #2e7d32;
            animation: slideInRight 0.3s ease;
        }

        .admin-panel-header {
            background: linear-gradient(135deg, #2e7d32, #1b5e20);
            color: white;
            padding: 15px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .admin-panel-header h3 {
            margin: 0;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .admin-panel-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.3s;
        }

        .admin-panel-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .admin-panel-content {
            padding: 15px;
        }

        .admin-section {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        .admin-section h4 {
            color: #2e7d32;
            margin-bottom: 10px;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .admin-buttons-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .admin-button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-align: center;
        }

        .admin-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .admin-button.danger {
            background: #f44336;
        }

        .admin-button.warning {
            background: #ff9800;
        }

        .admin-button.info {
            background: #2196F3;
        }

        .admin-button.success {
            background: #4CAF50;
        }

        .admin-button.purple {
            background: #9c27b0;
        }

        .admin-status {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 8px;
            font-size: 0.85rem;
            margin-top: 10px;
            border-left: 4px solid #4CAF50;
        }

        .admin-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .admin-toggle:hover {
            background: #e9ecef;
        }

        .admin-toggle-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }

        .admin-toggle-switch {
            width: 50px;
            height: 26px;
            background: #ccc;
            border-radius: 13px;
            position: relative;
            transition: background 0.3s;
        }

        .admin-toggle-switch.active {
            background: #4CAF50;
        }

        .admin-toggle-switch::before {
            content: '';
            position: absolute;
            width: 22px;
            height: 22px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: transform 0.3s;
        }

        .admin-toggle-switch.active::before {
            transform: translateX(24px);
        }

        .admin-floating-button {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: linear-gradient(135deg, #2e7d32, #1b5e20);
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: none;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(46,125,50,0.4);
            z-index: 9998;
            transition: all 0.3s ease;
            font-size: 1.5rem;
            border: 3px solid white;
        }

        .admin-floating-button:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(46,125,50,0.6);
        }

        /* Ajustar otros botones flotantes cuando admin está visible */
        body.admin-panel-visible .floating-home {
            bottom: 90px;
        }

        body.admin-panel-visible .floating-search {
            bottom: 160px;
        }

        body.admin-panel-visible .floating-cart {
            bottom: 230px;
        }

        @media (max-width: 767px) {
            .admin-panel {
                width: 90%;
                left: 5%;
                right: 5%;
                bottom: 10px;
            }
            
            .admin-floating-button {
                width: 50px;
                height: 50px;
                font-size: 1.3rem;
                bottom: 10px;
                left: 10px;
            }
            
            body.admin-panel-visible .floating-home {
                bottom: 70px;
            }
            
            body.admin-panel-visible .floating-search {
                bottom: 130px;
            }
            
            body.admin-panel-visible .floating-cart {
                bottom: 190px;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <div class="logo">
                <img src="iconos-pwa/android/android-launchericon-48-48.png" alt="Logo Almacén Copihue" class="logo-icon">
                Almacén Copihue
                <span id="adminBadge" class="admin-badge" style="display: none;">ADMIN</span>
                <span id="adminOfertasContador" style="display: none;"></span>
                <span id="adminReservaContador" style="display: none;"></span>
            </div>
            <div class="cart-icon" id="cartIcon">
                🛒 <span class="cart-count" id="cartCount">0</span>
            </div>
        </div>
    </header>

    <div class="container">
        <div id="adminNotification" class="admin-notification" style="display: none;">
            <strong>🔔 MODO ADMIN ACTIVADO</strong> - Recibirás alertas de stock bajo
        </div>

        <section class="hero">
            <h1>"Almacén Copihue"</h1>
            <p>Productos de calidad con la confianza de siempre</p>
        </section>

        <section class="info-bar">
            <div class="info-item">
                <strong>📍 Retiro en el local:</strong> Copihue 457
            </div>
            <div class="info-item">
                <strong>📞 WhatsApp:</strong> +5492944907380
            </div>
            <div class="info-item">
                <strong>⏰ Horario:</strong> 11:30 a 23:30 hrs.
            </div>
        </section>

        <!-- ========== OFERTAS RELÁMPAGO ========== -->
        <div class="flash-sales-container" id="flashSalesContainer">
            <div class="flash-sales-header">
                <h2>
                    ⚡ OFERTAS RELÁMPAGO 
                    <span class="flash-badge">URGENCIA MÁXIMA</span>
                </h2>
                <div class="flash-timer" id="flashTimer">
                    ⏰ ¡ÚLTIMA OPORTUNIDAD! Termina en: <span id="countdown">--:--:--</span>
                </div>
            </div>
            
            <div class="flash-stock-warning">
                ⚠️ <strong>NIVEL MÁXIMO:</strong> Solo 3 productos por día. 
                Descuentos superiores al 40% OFF. ¡Selección exclusiva!
            </div>
            
            <div class="flash-products-grid" id="flashProductsGrid">
                <!-- Productos relámpago se cargan aquí -->
            </div>
            
            <div class="flash-countdown-overlay" id="flashCountdownOverlay">
                <div class="countdown-message">
                    <h3>⏰ OFERTAS RELÁMPAGO FINALIZADAS</h3>
                    <p>Las ofertas relámpago de hoy han terminado.</p>
                    <p>Volverán mañana de 11:30 a 17:00 hrs.</p>
                    <div class="tomorrow-countdown">
                        <strong>🔄 Próximas ofertas relámpago en:</strong>
                        <div id="nextFlashCountdown">--:--:--</div>
                    </div>
                </div>
            </div>
        </div>

        <section class="featured-offers" id="featuredOffers" style="display: none;">
            <div class="featured-header">
                <div class="featured-title">
                    🔥 OFERTAS DESTACADAS
                </div>
                <button class="view-all-offers" id="viewAllOffers">
                    Ver todas las ofertas
                </button>
            </div>
            <div class="products-grid" id="featuredProductsGrid">
                <!-- Ofertas destacadas dinámicas -->
            </div>
        </section>

        <div class="search-container" id="desktopSearch">
            <div class="search-wrapper">
                <input type="text" id="productSearch" class="search-input" 
                       placeholder="🔍 Buscar productos por nombre, abreviatura o sinónimo...">
                <button class="clear-search" id="clearSearchBtn">✖️</button>
                <div id="searchSuggestions" class="search-suggestions"></div>
            </div>
        </div>

        <!-- CATEGORÍAS ÚNICAS - SCROLL HORIZONTAL EN MÓVIL -->
        <section class="categories" id="categories">
            <!-- Categorías dinámicas -->
        </section>

        <section class="products-grid" id="productsGrid">
            <div class="loading">🔄 Cargando productos desde tu API...</div>
        </section>
    </div>

    <!-- ========== OFERTAS ESPECIALES ROTATIVAS ========== -->
    <div class="especiales-container" id="especialesContainer" style="display: none;">
        <div class="especiales-header">
            <h2>
                🎁 OFERTA ESPECIAL DEL DÍA
                <span class="especial-badge">¡Solo 2 productos!</span>
            </h2>
            <div class="especial-timer">
                ⏰ Rotación diaria - Nuevos productos cada día
            </div>
        </div>
        
        <div class="especiales-products-grid" id="especialesProductsGrid">
            <!-- Productos especiales rotativos se cargan aquí -->
        </div>
        
        <div class="especiales-info">
            <small>🎯 Descuentos del 1% al 14% OFF • Máximo 2 productos diferentes por día</small>
        </div>
    </div>

    <!-- BOTONES FLOTANTES -->
    <div class="floating-home" id="floatingHome">
        🏠
    </div>
    
    <div class="floating-search" id="floatingSearch">
        🔍
    </div>

    <div class="floating-cart" id="floatingCart">
        🛒
        <span class="cart-count" id="floatingCartCount">0</span>
    </div>

    <!-- Botón flotante de administración -->
    <div class="admin-floating-button" id="adminFloatingButton">
        ⚙️
    </div>

    <!-- Panel de administración -->
    <div class="admin-panel" id="adminPanel">
        <div class="admin-panel-header">
            <h3>🔧 PANEL ADMINISTRACIÓN</h3>
            <button class="admin-panel-close" id="adminPanelClose">&times;</button>
        </div>
        <div class="admin-panel-content">
            <div class="admin-section">
                <h4>🔓 FORZAR VISIBILIDAD</h4>
                <div class="admin-buttons-grid">
                    <button class="admin-button info" id="adminForceRelampago">
                        ⚡ Relámpago
                    </button>
                    <button class="admin-button warning" id="adminForceDestacadas">
                        🔥 Destacadas
                    </button>
                    <button class="admin-button purple" id="adminForceEspeciales">
                        🎁 Especiales
                    </button>
                </div>
                <div class="admin-status" id="adminForcedStatus">
                    🔄 Forzado: Ninguno
                </div>
            </div>

            <div class="admin-section">
                <h4>🗑️ LIMPIAR CACHE</h4>
                <div class="admin-buttons-grid">
                    <button class="admin-button danger" id="adminClearCache">
                        🧹 Limpiar Todo
                    </button>
                    <button class="admin-button" id="adminClearLocal">
                        📱 LocalStorage
                    </button>
                    <button class="admin-button" id="adminClearSession">
                        💾 SessionStorage
                    </button>
                    <button class="admin-button" id="adminClearFlash">
                        ⚡ Flash Sales
                    </button>
                </div>
            </div>

            <div class="admin-section">
                <h4>👁️ VISIBILIDAD</h4>
                <div class="admin-toggle" id="adminToggleOcultos">
                    <div class="admin-toggle-label">
                        👁️ Mostrar productos ocultos
                    </div>
                    <div class="admin-toggle-switch"></div>
                </div>
                <div class="admin-toggle" id="adminToggleDebug">
                    <div class="admin-toggle-label">
                        🔬 Modo debug
                    </div>
                    <div class="admin-toggle-switch"></div>
                </div>
                <div class="admin-buttons-grid">
                    <button class="admin-button" id="adminRefreshData">
                        🔄 Recargar datos
                    </button>
                    <button class="admin-button" id="adminTestAPI">
                        🧪 Test API
                    </button>
                </div>
            </div>

            <div class="admin-section">
                <h4>🔬 TEST SECCIONES</h4>
                <div class="admin-buttons-grid">
                    <button class="admin-button info" id="adminTestRelampago">
                        ⚡ Test Relámpago
                    </button>
                    <button class="admin-button warning" id="adminTestDestacadas">
                        🔥 Test Destacadas
                    </button>
                    <button class="admin-button purple" id="adminTestEspeciales">
                        🎁 Test Especiales
                    </button>
                    <button class="admin-button" id="adminTestHorarios">
                        🕒 Test Horarios
                    </button>
                </div>
            </div>

            <div class="admin-section">
                <h4>📊 INFORMACIÓN DEL SISTEMA</h4>
                <div class="admin-status" id="adminSystemInfo">
                    Cargando información del sistema...
                </div>
                <div class="admin-buttons-grid">
                    <button class="admin-button" id="adminExportData">
                        📤 Exportar datos
                    </button>
                    <button class="admin-button danger" id="adminResetAll">
                        🚨 Reset total
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="search-modal" id="searchModal">
        <div class="search-modal-content">
            <div class="search-modal-header">
                <h2>Buscar Productos</h2>
                <button class="close-search" id="closeSearch">&times;</button>
            </div>
            <div class="search-wrapper">
                <input type="text" id="mobileSearch" class="search-input" 
                       placeholder="🔍 Escribe nombre, abreviatura o sinónimo..."
                       onkeydown="handleMobileSearchEnter(event)">
                <button class="clear-search" id="clearMobileSearchBtn">✖️</button>
            </div>
            <div class="mobile-search-results" id="mobileSearchResults">
                <!-- Resultados búsqueda móvil -->
            </div>
        </div>
    </div>

    <div class="cart-modal" id="cartModal">
        <div class="cart-content">
            <div class="cart-header">
                <h2>Tu Pedido</h2>
                <button class="close-cart" id="closeCart">&times;</button>
            </div>
            <div class="cart-items" id="cartItems">
                <!-- Items del carrito -->
            </div>
            <div class="cart-total" id="cartTotal">Total: $0</div>
            <button class="send-order" id="sendOrder">Enviar Pedido por WhatsApp</button>
        </div>
    </div>

    <div class="install-prompt" id="installPrompt">
        <span>📱 Instalar App</span>
    </div>

    <div class="ios-instructions" id="iosInstructions" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 10000; justify-content: center; align-items: center; padding: 20px;">
        <div style="background: white; border-radius: 20px; padding: 30px; max-width: 400px; text-align: center; position: relative;">
            <!-- Botón cerrar (X) -->
            <button onclick="document.getElementById('iosInstructions').style.display='none'" 
                    style="position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 24px; cursor: pointer; color: #666; padding: 5px; line-height: 1;">
                &times;
            </button>
            
            <h2 style="color: #2e7d32; margin-bottom: 20px; padding-right: 30px;">📱 Instalar en iPhone/iPad</h2>
            <div style="text-align: left; margin: 20px 0; font-size: 16px; line-height: 1.8;">
                <p>1. Toca el botón <strong style="color: #2e7d32;">Compartir</strong> 📤</p>
                <p>2. Desplázate hacia abajo</p>
                <p>3. Selecciona <strong style="color: #2e7d32;">"Agregar a Inicio"</strong></p>
                <p>4. Toca <strong style="color: #2e7d32;">"Agregar"</strong></p>
            </div>
            <button onclick="document.getElementById('iosInstructions').style.display='none'" 
                    style="background: #2e7d32; color: white; border: none; padding: 12px 30px; 
                           border-radius: 25px; font-size: 16px; font-weight: bold; cursor: pointer; 
                           margin-top: 10px; width: 100%;">
                Entendido
            </button>
        </div>
    </div>

    <footer>
        <div class="footer-content">
            <p>Almacén Copihue - Productos de calidad con la confianza de siempre</p>
            <p>📍 Copihue 457 | 📞 +5492944907380 | ⏰ 11:30 a 23:30 hrs.</p>
        </div>
    </footer>

    <script>
        // ========== CONTROL DE INICIALIZACIÓN ==========
        
        // ========== VERSIÓN Y CONFIGURACIÓN ==========
        const APP_VERSION = '20241220-SISTEMA-PERFECTO-JERARQUICO-OFERTAS-ADMIN';
        
        // ========== VARIABLES GLOBALES ==========
        let products = [];
        let cart = [];
        let currentCategory = "ALMACEN";
        let lowStockAlertSent = false;
        let esAdmin = false;
        let isSearching = false;
        let mostrarProductosOcultos = false;
        let modoDebug = false;
        
        // ¡NUEVA VARIABLE PARA CONTROL DE INICIALIZACIÓN!
        let appInitialized = false;
        
        // Inicializar arrays globales
        window.productosRelampagoIds = [];
        window.productosDestacadosIds = [];
        window.productosEspecialesIds = [];
        window.productosReservaIds = [];
        
        // Variables de control admin
        window.ADMIN_TOOLS = {
            forcedSections: {
                relampago: false,
                destacadas: false,
                especiales: false
            },
            showHidden: false,
            debugMode: false
        };
        
        // ========== FUNCIONES AUXILIARES FALTANTES ==========
        function handleImageError(imgElement, productName) {
            console.warn(`⚠️ Imagen no encontrada para: ${productName}`);
            imgElement.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect width="100" height="100" fill="%23e8f5e9"/><text x="50" y="50" text-anchor="middle" dy=".3em" font-size="12" fill="%232e7d32">' + encodeURIComponent(productName.substring(0, 15)) + '</text></svg>';
            imgElement.style.objectFit = 'contain';
            imgElement.style.padding = '10px';
        }
        
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            const colors = {
                'error': '#f44336',
                'success': '#4CAF50', 
                'info': '#2196F3',
                'warning': '#ff9800'
            };
            
            notification.style.cssText = `
                position: fixed;
                top: 100px;
                left: 50%;
                transform: translateX(-50%);
                background: ${colors[type] || colors.info};
                color: white;
                padding: 12px 24px;
                border-radius: 25px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                z-index: 10000;
                font-weight: 500;
                animation: slideDown 0.3s ease;
                border: 2px solid white;
            `;
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => notification.remove(), 3000);
        }
        
        function mostrarErrorFormato(datos) {
            console.error('Formato de datos inesperado:', datos);
            if (productsGrid) {
                productsGrid.innerHTML = `
                    <div class="error-message">
                        ⚠️ Error en el formato de datos recibido
                        <br><br>
                        <button class="retry-btn" onclick="loadProductsFromAPI()">Reintentar</button>
                    </div>
                `;
            }
        }
        
        function mostrarErrorAmigable(error) {
            console.error('Error detallado:', error);
            if (productsGrid) {
                productsGrid.innerHTML = `
                    <div class="error-message">
                        ⚠️ No se pudieron cargar los productos
                        <br><br>
                        <small>${error.message || 'Error de conexión'}</small>
                        <br><br>
                        <button class="retry-btn" onclick="loadProductsFromAPI()">Reintentar carga</button>
                    </div>
                `;
            }
        }
        
        // ========== SISTEMA DE ROTACIÓN COMPLETO - IMPLEMENTACIÓN FINAL ==========
        
        // 1. ACTUALIZAR JERARQUÍA DE OFERTAS CON NUEVOS HORARIOS
        const JERARQUIA_OFERTAS = {
            // NIVEL 1: RELÁMPAGO (URGENCIA MÁXIMA) - DOMINGO A JUEVES 11:30-17:00
            'relampago': {
                nombre: 'RELÁMPAGO',
                icono: '⚡',
                descuentoMinimo: 33,
                stockMaximo: 5,
                cantidadVisible: 3,
                color: '#ff3d00',
                horario: { 
                    start: 11, 
                    startMinutes: 30, 
                    end: 17, 
                    endMinutes: 0 
                },
                dias: [0, 1, 2, 3, 4], // Domingo(0) a Jueves(4)
                mensaje: '¡ÚLTIMA OPORTUNIDAD! Se acaba HOY',
                pool: []
            },
            
            // NIVEL 2: DESTACADAS (OFERTAS MEDIAS) - VIERNES Y SÁBADO 18:00-23:00
            'destacadas': {
                nombre: 'DESTACADAS',
                icono: '🔥',
                descuentoMinimo: 15,
                descuentoMaximo: 32,
                stockMaximo: 10,
                cantidadVisible: 9,
                color: '#ff9800',
                horario: { 
                    start: 18, 
                    startMinutes: 0, 
                    end: 23, 
                    endMinutes: 0 
                },
                dias: [5, 6], // Viernes(5) y Sábado(6)
                mensaje: 'OFERTAS ESPECIALES - Precios rebajados',
                pool: []
            },
            
            // NUEVO NIVEL 3: ESPECIALES (OFERTAS SUAVES) - DIARIAMENTE 11:30-23:30
            'especiales': {
                nombre: 'ESPECIALES',
                icono: '🎁',
                descuentoMinimo: 1,
                descuentoMaximo: 14,
                stockMaximo: 10,
                cantidadVisible: 2,
                color: '#9c27b0',
                horario: { 
                    start: 11, 
                    startMinutes: 30, 
                    end: 23, 
                    endMinutes: 30 
                },
                dias: [0, 1, 2, 3, 4, 5, 6], // Todos los días
                mensaje: '🎁 OFERTA ESPECIAL DEL DÍA - ¡Solo 2 productos!',
                pool: []
            }
        };
        
        const OFERTAS_SISTEMA = {
            '1': { 
                nombre: "2x1", 
                tipo: "2x1", 
                eslogan: "💥 ¡2x1! - Llevá 2, Pagá 1",
                ejemplo: "2 unidades = 50% OFF (¡MITAD DE PRECIO!)",
                color: "#d50000",
                descuentoReal: 50
            },
            '2': { 
                nombre: "3x2", 
                tipo: "3x2", 
                eslogan: "🎯 3x2 - Llevá 3, Pagá 2",
                ejemplo: "3 unidades = 33% OFF (una GRATIS)",
                color: "#ff6f00",
                descuentoReal: 33
            },
            '3': { 
                nombre: "4x3", 
                tipo: "4x3", 
                eslogan: "🏆 4x3 - Llevá 4, Pagá 3",
                ejemplo: "4 unidades = 25% OFF",
                color: "#2196f3",
                descuentoReal: 25
            },
            '4': { 
                nombre: "5x4", 
                tipo: "5x4", 
                eslogan: "💎 5x4 - Llevá 5, Pagá 4",
                ejemplo: "5 unidades = 20% OFF",
                color: "#9c27b0",
                descuentoReal: 20
            },
            '5': { 
                nombre: "6x5", 
                tipo: "6x5", 
                eslogan: "👑 6x5 - Llevá 6, Pagá 5",
                ejemplo: "6 unidades = 17% OFF",
                color: "#ff4081",
                descuentoReal: 17
            },
            '6': { 
                nombre: "7x6", 
                tipo: "7x6", 
                eslogan: "🚀 7x6 - Llevá 7, Pagá 6",
                ejemplo: "7 unidades = 14% OFF",
                color: "#00bcd4",
                descuentoReal: 14
            },
            '7': { 
                nombre: "8x7", 
                tipo: "8x7", 
                eslogan: "🌟 8x7 - Llevá 8, Pagá 7",
                ejemplo: "8 unidades = 13% OFF",
                color: "#8e24aa",
                descuentoReal: 13
            },
            '8': { 
                nombre: "9x8", 
                tipo: "9x8", 
                eslogan: "💫 9x8 - Llevá 9, Pagá 8",
                ejemplo: "9 unidades = 11% OFF",
                color: "#43a047",
                descuentoReal: 11
            },
            '9': { 
                nombre: "10x9", 
                tipo: "10x9", 
                eslogan: "🎊 10x9 - Llevá 10, Pagá 9",
                ejemplo: "10 unidades = 10% OFF",
                color: "#fb8c00",
                descuentoReal: 10
            },
            '10': { 
                nombre: "2da50", 
                tipo: "2da50", 
                eslogan: "🎁 2da unidad 50% OFF",
                ejemplo: "2 unidades = 25% OFF en total",
                color: "#e91e63",
                descuentoReal: 25
            },
            '11': { 
                nombre: "30progresivo", 
                tipo: "30progresivo", 
                eslogan: "📈 30% desde la 2da",
                ejemplo: "2da: 15% OFF | 3ra+: 20% OFF",
                color: "#3f51b5",
                descuentoReal: 20
            }
        };
        
        // ========== FUNCIÓN CRÍTICA: OBTENER DESCUENTO REAL ==========
        function obtenerDescuentoRealProducto(producto) {
            if (producto.ofertas2 && producto.ofertas2 !== '0' && producto.ofertas2 !== '') {
                const descuento = parseInt(producto.ofertas2);
                if (!isNaN(descuento) && descuento > 0) {
                    return descuento;
                }
            }
            
            if (producto.ofertas1 && producto.ofertas1 !== '0' && producto.ofertas1 !== '') {
                const oferta = OFERTAS_SISTEMA[producto.ofertas1];
                if (oferta && oferta.descuentoReal) {
                    return oferta.descuentoReal;
                }
            }
            
            return 0;
        }
        
        // ========== FUNCIONES DE OFERTAS ==========
        function redondearPrecioAlmacenCopihue(precio) {
            if (typeof precio !== 'number' || isNaN(precio) || precio <= 0) return 0;
            
            if (precio === Math.floor(precio)) {
                return precio;
            }
            
            return Math.round(precio);
        }
        
        function calcularPrecioConDescuento(precioOriginal, ofertas1, ofertas2, cantidad) {
            if (!precioOriginal || precioOriginal <= 0 || !cantidad || cantidad <= 0) {
                return precioOriginal || 0;
            }
            
            if (ofertas2 && !isNaN(parseInt(ofertas2))) {
                const descuentoPorcentaje = parseInt(ofertas2);
                
                if (descuentoPorcentaje > 0 && descuentoPorcentaje <= 100) {
                    const limiteOferta2 = obtenerLimiteOfertas2(ofertas2);
                    if (limiteOferta2 !== null && cantidad > limiteOferta2) {
                        cantidad = limiteOferta2;
                    }
                    
                    const descuentoDecimal = descuentoPorcentaje / 100;
                    const precioTotal = precioOriginal * cantidad;
                    const precioConDescuento = precioTotal * (1 - descuentoDecimal);
                    
                    return redondearPrecioAlmacenCopihue(precioConDescuento) / cantidad;
                }
            }
            
            if (ofertas1 && OFERTAS_SISTEMA[ofertas1]) {
                const oferta = OFERTAS_SISTEMA[ofertas1];
                
                let totalAPagar = 0;
                
                switch(oferta.tipo) {
                    case '2x1':
                        const grupos2 = Math.floor(cantidad / 2);
                        const sobras2 = cantidad % 2;
                        totalAPagar = (grupos2 * precioOriginal * 1) + (sobras2 * precioOriginal);
                        break;
                        
                    case '3x2':
                        const grupos3 = Math.floor(cantidad / 3);
                        const sobras3 = cantidad % 3;
                        totalAPagar = (grupos3 * precioOriginal * 2) + (sobras3 * precioOriginal);
                        break;
                        
                    case '4x3':
                        const grupos4 = Math.floor(cantidad / 4);
                        const sobras4 = cantidad % 4;
                        totalAPagar = (grupos4 * precioOriginal * 3) + (sobras4 * precioOriginal);
                        break;
                        
                    case '5x4':
                        const grupos5 = Math.floor(cantidad / 5);
                        const sobras5 = cantidad % 5;
                        totalAPagar = (grupos5 * precioOriginal * 4) + (sobras5 * precioOriginal);
                        break;
                        
                    case '6x5':
                        const grupos6 = Math.floor(cantidad / 6);
                        const sobras6 = cantidad % 6;
                        totalAPagar = (grupos6 * precioOriginal * 5) + (sobras6 * precioOriginal);
                        break;
                        
                    case '2da50':
                        const pares = Math.floor(cantidad / 2);
                        const impares = cantidad % 2;
                        totalAPagar = (pares * (precioOriginal + (precioOriginal * 0.5))) + (impares * precioOriginal);
                        break;
                        
                    case '30progresivo':
                        let descuento = 0;
                        if (cantidad === 1) descuento = 0;
                        else if (cantidad === 2) descuento = 0.15;
                        else descuento = 0.20;
                        
                        totalAPagar = precioOriginal * cantidad * (1 - descuento);
                        break;
                        
                    default:
                        totalAPagar = precioOriginal * cantidad;
                }
                
                return totalAPagar / cantidad;
            }
            
            return precioOriginal;
        }
        
        function calcularDescuentoReal(precioOriginal, precioFinal) {
            if (precioOriginal <= 0 || precioFinal >= precioOriginal) return 0;
            return Math.round(((precioOriginal - precioFinal) / precioOriginal) * 100);
        }
        
        function obtenerDescripcionOferta(ofertas1, ofertas2, precioOriginal, cantidad = 1) {
            if (ofertas2 && !isNaN(parseInt(ofertas2))) {
                const descuento = parseInt(ofertas2);
                if (descuento > 0 && descuento <= 100) {
                    const precioConDescuento = calcularPrecioConDescuento(precioOriginal, ofertas1, ofertas2, 1);
                    const ahorro = precioOriginal - precioConDescuento;
                    return `🔥 ¡${descuento}% OFF! Ahorrá $${Math.round(ahorro)} por unidad`;
                }
            }
            
            if (ofertas1 && OFERTAS_SISTEMA[ofertas1]) {
                const oferta = OFERTAS_SISTEMA[ofertas1];
                return oferta.eslogan;
            }
            
            return "";
        }
        
        function obtenerTextoCortoOferta(ofertas1, ofertas2) {
            if (ofertas2 && !isNaN(parseInt(ofertas2))) {
                const descuento = parseInt(ofertas2);
                if (descuento > 0 && descuento <= 100) {
                    return `🔥 ${descuento}% OFF`;
                }
            }
            
            if (ofertas1 && OFERTAS_SISTEMA[ofertas1]) {
                const oferta = OFERTAS_SISTEMA[ofertas1];
                return `🎯 ${oferta.nombre}`;
            }
            
            return "";
        }
        
        function obtenerDetalleOferta3x2(ofertas1, precioOriginal, cantidad = 1) {
            if (!ofertas1 || !OFERTAS_SISTEMA[ofertas1]) return "";
            
            const oferta = OFERTAS_SISTEMA[ofertas1];
            
            switch(oferta.tipo) {
                case '3x2':
                    let detalle3x2 = `<div class="oferta-3x2-detalle">
                        <div class="oferta-3x2-titulo">🎯 OFERTA 3x2 REAL</div>
                        <div class="oferta-3x2-ejemplo">`;
                    
                    if (cantidad === 1) {
                        detalle3x2 += `• 1 unidad: $${precioOriginal} (normal)`;
                    } else if (cantidad === 2) {
                        detalle3x2 += `• 2 unidades: $${precioOriginal * 2} (normales)`;
                    } else if (cantidad === 3) {
                        const precio3unidades = redondearPrecioAlmacenCopihue(calcularPrecioConDescuento(precioOriginal, ofertas1, '', 3) * 3);
                        detalle3x2 += `• 3 unidades: $${precio3unidades} (la 3ra GRATIS)`;
                    } else if (cantidad === 4) {
                        const precio4unidades = redondearPrecioAlmacenCopihue(calcularPrecioConDescuento(precioOriginal, ofertas1, '', 4) * 4);
                        detalle3x2 += `• 4 unidades: $${precio4unidades} (3x2 + 1 normal)`;
                    } else if (cantidad === 6) {
                        const precio6unidades = redondearPrecioAlmacenCopihue(calcularPrecioConDescuento(precioOriginal, ofertas1, '', 6) * 6);
                        detalle3x2 += `• 6 unidades: $${precio6unidades} (2 paquetes 3x2)`;
                    } else {
                        detalle3x2 += oferta.ejemplo;
                    }
                    
                    detalle3x2 += `</div></div>`;
                    return detalle3x2;
                    
                case '2da50':
                    return `<div class="oferta-3x2-detalle">
                        <div class="oferta-3x2-titulo">${oferta.eslogan}</div>
                        <div class="oferta-3x2-ejemplo">${oferta.ejemplo}</div>
                    </div>`;
                    
                case '30progresivo':
                    return `<div class="oferta-3x2-detalle">
                        <div class="oferta-3x2-titulo">${oferta.eslogan}</div>
                        <div class="oferta-3x2-ejemplo">${oferta.ejemplo}</div>
                    </div>`;
                    
                default:
                    return "";
            }
        }
        
        function obtenerMayorOfertaDelDia() {
            if (!products || products.length === 0) return null;
            
            const ofertas = products.filter(p => 
                Number(p.ofertas2) > 0 && 
                (p.stock === "STOCK" || p.stockNumber > 0)
            );
            
            if (ofertas.length === 0) return null;
            
            ofertas.sort((a, b) => Number(b.ofertas2) - Number(a.ofertas2));
            return ofertas[0];
        }
        
        function obtenerEtiquetaOfertaDestacada(descuento) {
            const desc = Number(descuento);
            if (desc >= 50) return "🏆 ¡SUPER OFERTÓN!";
            if (desc >= 30) return "🔥 ¡OFERTÓN!";
            if (desc >= 20) return "✨ ¡GRAN OFERTA!";
            if (desc > 0) return "👍 ¡OFERTA!";
            return "";
        }
        
        // ===============================
        // CATEGORÍA SEGÚN % DE DESCUENTO
        // ===============================
        function obtenerFraseCategoria(descuento) {
            if (descuento >= 70) return "🚨 REMATE · Se va o se va";
            if (descuento >= 60) return "🚨 Liquidación · Hasta agotar stock";
            if (descuento >= 40) return "🔥 Alta oferta · Precio que no se ve siempre";
            if (descuento >= 25) return "🟠 OFERTÓN";
            if (descuento >= 15) return "🟡 En oferta";
            return "🟢 Buen precio";
        }
        
        function compartirMegaOferta(id) {
            console.log('🤝 Compartiendo oferta ID:', id);

            const producto = window.products?.find(p => p.id === id);
            if (!producto) {
                alert('No se pudo encontrar el producto');
                return;
            }

            const precioOriginal = producto.price || 0;
            const precioOferta = producto.discountedPrice || precioOriginal;
            const ahorro = Math.round(precioOriginal - precioOferta);
            const descuento = producto.ofertas2 ? parseInt(producto.ofertas2) : 0;

            const categoria = obtenerFraseCategoria(descuento);

            const linkOferta = "https://almacen-copihue.vercel.app";

            let mensaje = `${categoria}\n\n`;
            mensaje += `Hola, mirá esta oferta del Almacén Copihue 👇\n\n`;
            mensaje += `🛒 *${producto.name}*\n\n`;
            mensaje += `💰 Antes: $${precioOriginal}\n`;
            mensaje += `🔥 Ahora: *$${precioOferta}*\n`;
            if (ahorro > 0) mensaje += `💸 Ahorrás $${ahorro}\n\n`;

            mensaje += `👉 Ver las ofertas acá:\n${linkOferta}\n\n`;
            mensaje += `Almacén Copihue\n`;
            mensaje += `Productos de calidad con la confianza de siempre`;

            console.log('📤 Mensaje generado:', mensaje);

            window.open(
                `https://wa.me/?text=${encodeURIComponent(mensaje)}`,
                "_blank",
                "noopener,noreferrer"
            );
        }
        
        function mostrarFeedbackWhatsApp() {
            try {
                document.querySelectorAll('.feedback-whatsapp').forEach(el => el.remove());
                
                const feedback = document.createElement('div');
                feedback.className = 'feedback-whatsapp';
                
                feedback.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="font-size: 28px; animation: pulse 1.5s infinite;">📱</div>
                        <div>
                            <div style="font-weight: bold; font-size: 16px;">¡Abriendo WhatsApp!</div>
                            <div style="font-size: 13px; opacity: 0.9; margin-top: 3px;">
                                Mensaje listo para enviar al Almacén Copihue
                            </div>
                        </div>
                    </div>
                `;
                
                feedback.style.cssText = `
                    position: fixed;
                    top: 130px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: linear-gradient(135deg, #25D366, #128C7E);
                    color: white;
                    padding: 18px 24px;
                    border-radius: 14px;
                    box-shadow: 0 10px 30px rgba(37, 211, 102, 0.5);
                    z-index: 10000;
                    animation: slideDown 0.4s ease;
                    border: 3px solid white;
                    min-width: 340px;
                    max-width: 90%;
                `;
                
                document.body.appendChild(feedback);
                
                setTimeout(() => {
                    if (feedback.parentNode) {
                        feedback.parentNode.removeChild(feedback);
                    }
                }, 3000);
                
            } catch (error) {
                console.warn('⚠️ Error en feedback:', error);
            }
        }
        
        if (!document.querySelector('style#pulse-animation')) {
            const style = document.createElement('style');
            style.id = 'pulse-animation';
            style.textContent = `
                @keyframes pulse {
                    0% { transform: scale(1); }
                    50% { transform: scale(1.1); }
                    100% { transform: scale(1); }
                }
            `;
            document.head.appendChild(style);
        }
        
        function compartirPorWhatsApp(mensaje) {
            const phoneNumber = "5492944907380";
            const encodedMessage = encodeURIComponent(mensaje);
            const whatsappURL = `https://wa.me/${phoneNumber}?text=${encodedMessage}`;
            
            console.log('📲 Abriendo WhatsApp:', whatsappURL);
            
            const nuevaVentana = window.open(whatsappURL, '_blank', 'noopener,noreferrer');
            
            if (!nuevaVentana) {
                alert('⚠️ Por favor, permite ventanas emergentes para compartir por WhatsApp');
                console.error('❌ Bloqueo de ventanas emergentes detectado');
            }
            
            mostrarFeedbackCompartir();
        }
        
        function mostrarFeedbackCompartir(productName = '') {
            try {
                const notificacionesPrevias = document.querySelectorAll('.feedback-compartir');
                notificacionesPrevias.forEach(el => el.remove());
                
                const notification = document.createElement('div');
                notification.className = 'feedback-compartir';
                
                const mensaje = productName 
                    ? `✅ ¡Oferta de "${productName}" lista para compartir!` 
                    : `✅ ¡Oferta lista para compartir por WhatsApp!`;
                
                notification.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="font-size: 20px;">📱</div>
                        <div>
                            <div style="font-weight: bold;">${mensaje}</div>
                            <div style="font-size: 12px; opacity: 0.9;">Se abrirá WhatsApp en una nueva pestaña</div>
                        </div>
                    </div>
                `;
                
                notification.style.cssText = `
                    position: fixed;
                    top: 120px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: linear-gradient(135deg, #25D366, #128C7E);
                    color: white;
                    padding: 15px 25px;
                    border-radius: 15px;
                    box-shadow: 0 6px 20px rgba(37, 211, 102, 0.5);
                    z-index: 1003;
                    font-weight: 600;
                    font-size: 14px;
                    animation: slideDown 0.3s ease;
                    border: 2px solid white;
                    text-align: center;
                    min-width: 300px;
                    max-width: 90%;
                `;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 3000);
                
            } catch (error) {
                console.warn('⚠️ Error en mostrarFeedbackCompartir:', error);
            }
        }
        
        function mostrarInfoAdmin(producto) {
            if (!esAdmin) return '';
            
            let info = '<div style="font-size: 0.7rem; color: #666; background: #f5f5f5; padding: 5px; margin-top: 5px; border-radius: 5px; border-left: 3px solid #ff9800;">';
            info += '<strong>👁️ INFO ADMIN:</strong><br>';
            
            if (producto.ofertas2 && producto.ofertas2 !== '0') {
                info += `Ofertas2: ${producto.ofertas2}%<br>`;
            }
            if (producto.ofertas1 && producto.ofertas1 !== '0') {
                const oferta = OFERTAS_SISTEMA[producto.ofertas1];
                if (oferta) {
                    info += `Ofertas1: ${oferta.nombre} (${oferta.descuentoReal}% real)<br>`;
                }
            }
            
            const descuentoReal = calcularDescuentoReal(producto.price, producto.discountedPrice);
            if (descuentoReal > 0) {
                info += `Descuento real: ${descuentoReal}%<br>`;
                info += `Precio unit. real: $${(producto.discountedPrice).toFixed(2)}`;
            }
            info += '</div>';
            
            return info;
        }
        
        function obtenerLimiteOfertas2(ofertas2) {
            if (!ofertas2 || ofertas2 === '') return null;
            
            const porcentaje = parseInt(ofertas2);
            if (isNaN(porcentaje)) return null;
            
            if (porcentaje >= 70 && porcentaje <= 99) {
                return 3;
            } else if (porcentaje >= 50 && porcentaje <= 69) {
                return 5;
            }
            
            return null;
        }
        
        function obtenerTextoLimiteOfertas2(ofertas2, nombreProducto = '') {
            const limite = obtenerLimiteOfertas2(ofertas2);
            if (limite === null) return '';
            
            const tipoVenta = obtenerTipoDeVenta(nombreProducto);
            
            switch(tipoVenta) {
                case 'peso':
                    const nombreLower = nombreProducto.toLowerCase();
                    if (nombreLower.includes('gr') || nombreLower.includes('gramo')) {
                        return `<span class="tipo-venta-icon">⚖️</span> Máx. ${limite * 1000} GRAMOS por familia`;
                    } else {
                        return `<span class="tipo-venta-icon">⚖️</span> Máx. ${limite} KILOS por familia`;
                    }
                case 'unidad':
                    return `<span class="tipo-venta-icon">📦</span> Máx. ${limite} UNIDADES por familia`;
                case 'empaque':
                    return `<span class="tipo-venta-icon">🎁</span> Máx. ${limite} PAQUETES por familia`;
                default:
                    return `<span class="tipo-venta-icon">📦</span> Máx. ${limite} unidades por familia`;
            }
        }
        
        function obtenerTextoStock(product) {
            const tipoVenta = obtenerTipoDeVenta(product.name);
            const stockNumber = product.stockNumber || 0;
            
            if (stockNumber === 0) {
                return '❌ Sin Stock';
            }
            
            let icono = '';
            let unidad = '';
            
            if (tipoVenta === 'peso') {
                const nombreLower = product.name.toLowerCase();
                
                if (nombreLower.includes(' gr') || nombreLower.includes('gramo') || 
                    /\bgr\b/i.test(product.name)) {
                    icono = '⚖️';
                    unidad = `${stockNumber}g`;
                } else {
                    icono = '⚖️';
                    unidad = `${stockNumber}kg`;
                }
            } 
            else if (tipoVenta === 'unidad') {
                icono = '📦';
                unidad = `${stockNumber}u`;
            }
            else if (tipoVenta === 'empaque') {
                icono = '🎁';
                unidad = `${stockNumber}pqt`;
            }
            else {
                icono = '📦';
                unidad = `${stockNumber}u`;
            }
            
            if (stockNumber > 0 && stockNumber <= 3) {
                return `⚠️ Stock Bajo ${icono} <span class="stock-tipo">(${unidad})</span>`;
            } else {
                return `✅ En Stock ${icono} <span class="stock-tipo">(${unidad})</span>`;
            }
        }
        
        function obtenerTipoDeVenta(nombreProducto) {
            const nombre = nombreProducto.toLowerCase().trim();
            
            const tieneGramosEspecificados = /\d+\s*(gr|g|gramo|gramos)\b/i.test(nombreProducto);
            if (tieneGramosEspecificados) {
                const esProductoSuelto = /^(jengibre|pimienta|comino|oregano|pimenton|laurel|provenzal)\s+gr?\b/i.test(nombreProducto);
                if (!esProductoSuelto) {
                    return 'unidad';
                }
            }
            
            if (nombre.includes(' kg') || /\bkg\b/i.test(nombreProducto)) {
                const excepcionesUnidad = ['arroz', 'azucar', 'azúcar', 'harina', 'sal', 'yerba', 'polenta', 'grasa'];
                const esExcepcion = excepcionesUnidad.some(ex => 
                    nombre.includes(ex) && nombre.includes('1 kg')
                );
                if (!esExcepcion) return 'peso';
            }
            
            if (nombre.includes('gaseosa') || nombre.includes('jugo') || 
                nombre.includes('bebida') || nombre.includes('refresco') ||
                nombre.includes('agua') || nombre.includes('helado') ||
                nombre.includes('vino') || nombre.includes('cerveza') ||
                nombre.includes('fernet') || nombre.includes('manaos') ||
                nombre.includes('cunnington') || nombre.includes('powerade')) {
                return 'unidad';
            }
            
            if (nombre.includes('alfajor') || nombre.includes('galletita') ||
                nombre.includes('galleta') || nombre.includes('chocolate') ||
                nombre.includes('caramelo') || nombre.includes('chicle') ||
                nombre.includes('turron') || nombre.includes('golosina') ||
                nombre.includes('snack') || nombre.includes('budin') ||
                nombre.includes('pan dulce') || nombre.includes('pure de tomate') ||
                nombre.includes('salsa de tomate') || nombre.includes('pure') ||
                nombre.includes('salsa')) {
                return 'unidad';
            }
            
            const frutasVerduras = ['tomate', 'durazno', 'manzana', 'naranja', 
                                   'cebolla', 'papa', 'zanahoria', 'lechuga',
                                   'limon', 'mandarina', 'banana'];
            
            for (const fv of frutasVerduras) {
                if (nombre.includes(fv)) {
                    if (!nombre.includes('unidad') && !nombre.includes('unid') && 
                        !nombre.includes('u ') && !nombre.includes(' c/u')) {
                        return 'peso';
                    }
                }
            }
            
            const especiasSuelto = ['jengibre gr', 'pimienta gr', 'comino gr', 
                                   'oregano gr', 'pimenton gr', 'laurel gr', 
                                   'provenzal gr', 'aji molido gr'];
            
            for (const especia of especiasSuelto) {
                if (nombre.includes(especia)) {
                    return 'peso';
                }
            }
            
            return 'unidad';
        }
        
        // ========== CLASIFICACIÓN POR JERARQUÍA ==========
        function clasificarProductosPorJerarquia() {
            console.log('🎯 CLASIFICANDO productos por jerarquía...');
            
            window.productosRelampagoIds = [];
            window.productosDestacadosIds = [];
            window.productosReservaIds = [];
            
            const productosConOferta = products.filter(p => {
                return p.descuentoReal > 0 && p.stockNumber > 0;
            });
            
            console.log(`📊 Productos con oferta y stock: ${productosConOferta.length}`);
            
            const candidatosRelampago = productosConOferta.filter(p => 
                p.descuentoReal >= JERARQUIA_OFERTAS.relampago.descuentoMinimo
            );
            
            candidatosRelampago.sort((a, b) => b.descuentoReal - a.descuentoReal);
            
            const productosRelampago = candidatosRelampago.slice(0, 
                JERARQUIA_OFERTAS.relampago.cantidadVisible
            );
            
            window.productosRelampagoIds = productosRelampago.map(p => p.id);
            
            const candidatosDestacadas = productosConOferta.filter(p => {
                const descuento = p.descuentoReal;
                const esValido = descuento >= JERARQUIA_OFERTAS.destacadas.descuentoMinimo &&
                                descuento <= JERARQUIA_OFERTAS.destacadas.descuentoMaximo;
                
                return esValido && !window.productosRelampagoIds.includes(p.id);
            });
            
            candidatosDestacadas.sort((a, b) => b.descuentoReal - a.descuentoReal);
            
            const productosDestacadas = candidatosDestacadas.slice(0, 
                JERARQUIA_OFERTAS.destacadas.cantidadVisible
            );
            
            window.productosDestacadosIds = productosDestacadas.map(p => p.id);
            
            window.productosReservaIds = productosConOferta
                .filter(p => 
                    !window.productosRelampagoIds.includes(p.id) &&
                    !window.productosDestacadosIds.includes(p.id)
                )
                .map(p => p.id);
            
            console.log('📊 RESULTADO JERARQUÍA:');
            console.log(`⚡ RELÁMPAGO: ${window.productosRelampagoIds.length} productos (≥40% OFF)`);
            console.log(`🔥 DESTACADAS: ${window.productosDestacadosIds.length} productos (15-39% OFF)`);
            console.log(`🫥 RESERVA: ${window.productosReservaIds.length} productos (<15% OFF o no seleccionados)`);
            
            return { 
                productosRelampago, 
                productosDestacadas, 
                productosReserva: window.productosReservaIds.map(id => 
                    products.find(p => p.id === id)
                )
            };
        }
        
        // ========== CONTROL AUTOMÁTICO DE HORARIOS ACTUALIZADO ==========
        function controlarVisibilidadPorHorario() {
            const ahora = new Date();
            const hora = ahora.getHours();
            const minutos = ahora.getMinutes();
            const diaSemana = ahora.getDay();
            const horaDecimal = hora + (minutos / 100);
            
            // RELÁMPAGO: Dom-Jue | 11:30-17:00
            const enDiaRelampago = JERARQUIA_OFERTAS.relampago.dias.includes(diaSemana);
            const enHorarioRelampago = enDiaRelampago && 
                                       (hora > 11 || (hora === 11 && minutos >= 30)) && 
                                       (hora < 17 || (hora === 17 && minutos === 0));
            const relampagoContainer = document.getElementById('flashSalesContainer');
            
            // DESTACADAS: Viernes y Sábado | 18:00-23:00
            const enDiaDestacadas = JERARQUIA_OFERTAS.destacadas.dias.includes(diaSemana);
            const enHorarioDestacadas = enDiaDestacadas && 
                                        (hora >= 18) && (hora < 23);
            const destacadasSection = document.getElementById('featuredOffers');
            
            // ESPECIALES: Diariamente | 11:30-23:30
            const enDiaEspeciales = JERARQUIA_OFERTAS.especiales.dias.includes(diaSemana);
            const enHorarioEspeciales = enDiaEspeciales && 
                                        ((hora > 11 || (hora === 11 && minutos >= 30)) && 
                                         (hora < 23 || (hora === 23 && minutos <= 30)));
            const especialesContainer = document.getElementById('especialesContainer');
            
            if (relampagoContainer) {
                const adminForzado = esAdmin && window.ADMIN_TOOLS?.forcedSections?.relampago;
                
                if (enHorarioRelampago || adminForzado) {
                    relampagoContainer.style.display = 'block';
                    console.log('⚡ OFERTAS RELÁMPAGO: ACTIVAS');
                    
                    if (typeof FLASH_SALES_SYSTEM !== 'undefined') {
                        FLASH_SALES_SYSTEM.isActive = true;
                        FLASH_SALES_SYSTEM.updateUI();
                    }
                } else {
                    relampagoContainer.style.display = 'none';
                    console.log('⚡ OFERTAS RELÁMPAGO: OCULTAS (fuera de horario/día)');
                    
                    if (typeof FLASH_SALES_SYSTEM !== 'undefined') {
                        FLASH_SALES_SYSTEM.isActive = false;
                        FLASH_SALES_SYSTEM.updateUI();
                    }
                }
            }
            
            if (destacadasSection) {
                const adminForzadoDestacadas = esAdmin && window.ADMIN_TOOLS?.forcedSections?.destacadas;
                
                if (enHorarioDestacadas || adminForzadoDestacadas) {
                    destacadasSection.style.display = 'block';
                    
                    if (adminForzadoDestacadas && !enHorarioDestacadas) {
                        mostrarOfertasDestacadasForzadas();
                    } else {
                        clasificarProductosPorJerarquia();
                        mostrarOfertasDestacadas();
                    }
                } else {
                    destacadasSection.style.display = 'none';
                    console.log('🔥 OFERTAS DESTACADAS: OCULTAS (fuera de horario)');
                    
                    const existingMsg = document.querySelector('.horario-destacadas');
                    if (!existingMsg && productsGrid && !esAdmin) {
                        const mensajeHorario = document.createElement('div');
                        mensajeHorario.className = 'horario-destacadas';
                        mensajeHorario.innerHTML = `
                            <div style="background: #ff9800; color: white; padding: 15px; 
                                border-radius: 10px; text-align: center; margin-bottom: 20px;
                                border-left: 5px solid #ff5722;">
                                <strong>⏰ OFERTAS DESTACADAS</strong><br>
                                <div style="font-size: 0.9rem; margin-top: 5px;">
                                    Disponibles solo <strong>Viernes y Sábado de 18:00 a 23:00 hrs</strong><br>
                                    <small>Descuentos del 15% al 32% OFF</small>
                                </div>
                            </div>
                        `;
                        productsGrid.parentNode.insertBefore(mensajeHorario, productsGrid);
                    }
                }
            }
            
            if (especialesContainer) {
                const adminForzadoEspeciales = esAdmin && window.ADMIN_TOOLS?.forcedSections?.especiales;
                
                if (enHorarioEspeciales || adminForzadoEspeciales) {
                    especialesContainer.style.display = 'block';
                    mostrarOfertasEspeciales();
                } else {
                    especialesContainer.style.display = 'none';
                    console.log('🎁 OFERTAS ESPECIALES: OCULTAS (fuera de horario)');
                }
            }
            
            if (esAdmin && modoDebug) {
                console.log('🕒 CONTROL HORARIO ADMIN:', {
                    hora: `${hora}:${minutos.toString().padStart(2, '0')}`,
                    dia: ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'][diaSemana],
                    relampago: enHorarioRelampago ? 'ACTIVO' : 'INACTIVO',
                    destacadas: enHorarioDestacadas ? 'ACTIVO' : 'INACTIVO',
                    especiales: enHorarioEspeciales ? 'ACTIVO' : 'INACTIVO',
                    adminForzadoRelampago: window.ADMIN_TOOLS?.forcedSections?.relampago,
                    adminForzadoDestacadas: window.ADMIN_TOOLS?.forcedSections?.destacadas,
                    adminForzadoEspeciales: window.ADMIN_TOOLS?.forcedSections?.especiales
                });
            }
            
            setTimeout(controlarVisibilidadPorHorario, 60000);
        }
            
        // ========== MOSTRAR OFERTAS ESPECIALES ==========
        function mostrarOfertasEspeciales() {
            console.log('🎁 OFERTAS ESPECIALES - Sistema rotativo');
            
            const especialesContainer = document.getElementById('especialesContainer');
            const especialesGrid = document.getElementById('especialesProductsGrid');
            
            if (!especialesContainer || !especialesGrid) return;
            
            const productosEspeciales = products.filter(p => 
                window.productosEspecialesIds.includes(p.id)
            );
            
            if (productosEspeciales.length === 0) {
                especialesContainer.style.display = 'none';
                return;
            }
            
            especialesContainer.style.display = 'block';
            
            especialesGrid.innerHTML = productosEspeciales.map(producto => {
                const stockText = obtenerTextoStock(producto);
                const descripcionOferta = obtenerDescripcionOferta(
                    producto.ofertas1, 
                    producto.ofertas2,
                    producto.price
                );
                
                return `
                    <div class="product-card jerarquia-especiales">
                        <div class="offer-badge">🎁 ESPECIAL</div>
                        
                        <div class="product-image">
                            <img src="${producto.image}" 
                                 alt="${producto.name}"
                                 onerror="handleImageError(this, '${producto.name.replace(/'/g, "\\'")}')">
                        </div>
                        
                        <div class="product-info" style="padding: 1.2rem;">
                            <div class="product-name" style="font-size: 1rem; font-weight: bold; color: #7b1fa2;">
                                ${producto.name}
                            </div>
                            
                            <div class="offer-description" style="color: #9c27b0; font-weight: bold; margin: 8px 0;">
                                ${descripcionOferta}
                            </div>
                            
                            <div style="background: #f3e5f5; padding: 8px; border-radius: 8px; margin: 8px 0; border-left: 3px solid #9c27b0;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <strong style="color: #7b1fa2;">🎁 NIVEL ESPECIAL</strong>
                                    <span style="background: #9c27b0; color: white; padding: 3px 8px; border-radius: 12px; font-weight: bold;">
                                        ${producto.descuentoReal}% OFF
                                    </span>
                                </div>
                                <div style="font-size: 0.8rem; color: #666; margin-top: 4px;">
                                    Descuento 1-14% - Rotación diaria
                                </div>
                            </div>
                            
                            <div class="product-price-container" style="margin: 10px 0;">
                                <span class="original-price" style="font-size: 1rem;">$${producto.price}</span>
                                <span class="product-price">$${Math.round(producto.discountedPrice)}</span>
                                <span class="discount-percent">${producto.descuentoReal}% OFF</span>
                            </div>
                            
                            <div class="product-stock in-stock" style="margin: 8px 0;">
                                ${stockText}
                            </div>
                            
                            <button class="add-to-cart" 
                                    data-id="${producto.id}"
                                    style="background: linear-gradient(135deg, #9c27b0, #7b1fa2);">
                                🛒 Agregar al Carrito
                            </button>
                            
                            <div style="font-size: 0.75rem; color: #666; margin-top: 8px; text-align: center;">
                                🎯 Producto especial del día - Cambia mañana
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // ========== SISTEMA OFERTAS RELÁMPAGO ==========
        const FLASH_SALES_SYSTEM = {
            ENABLED: true,
            ACTIVE_HOURS: JERARQUIA_OFERTAS.relampago.horario,
            ACTIVE_DAYS: [0, 1, 2, 3, 4], // Domingo a Jueves
            POOL_SIZE: 15,
            DAILY_SELECTION: 3,
            
            isActive: false,
            todaySelection: [],
            yesterdaySelection: [],
            productPool: [],
            
            init: function() {
                console.log('⚡ Inicializando sistema de ofertas relámpago...');
                this.checkTimeAndDay();
                this.loadHistory();
                this.loadProductPool();
                this.generateDailySelection();
                this.updateUI();
                this.startCountdown();
                console.log('✅ Sistema relámpago listo. Activo:', this.isActive);
            },
            
            checkTimeAndDay: function() {
                const now = new Date();
                const currentDay = now.getDay();
                const currentHour = now.getHours();
                const currentMinutes = now.getMinutes();
                
                const isActiveDay = this.ACTIVE_DAYS.includes(currentDay);
                
                let isActiveHour = false;
                
                if (currentHour > this.ACTIVE_HOURS.start && 
                    currentHour < this.ACTIVE_HOURS.end) {
                    isActiveHour = true;
                } else if (currentHour === this.ACTIVE_HOURS.start) {
                    isActiveHour = currentMinutes >= this.ACTIVE_HOURS.startMinutes;
                } else if (currentHour === this.ACTIVE_HOURS.end) {
                    isActiveHour = currentMinutes < this.ACTIVE_HOURS.endMinutes;
                }
                
                this.isActive = isActiveDay && isActiveHour && this.ENABLED;
                
                return this.isActive;
            },
            
            loadHistory: function() {
                try {
                    const today = this.getTodayKey();
                    const yesterday = this.getYesterdayKey();
                    
                    const todayData = localStorage.getItem(`flash_sales_${today}`);
                    if (todayData) {
                        this.todaySelection = JSON.parse(todayData);
                    }
                    
                    const yesterdayData = localStorage.getItem(`flash_sales_${yesterday}`);
                    if (yesterdayData) {
                        this.yesterdaySelection = JSON.parse(yesterdayData);
                    }
                } catch (error) {
                    console.error('❌ Error cargando historial:', error);
                    this.clearHistory();
                }
            },
            
            saveTodaySelection: function() {
                try {
                    const today = this.getTodayKey();
                    localStorage.setItem(`flash_sales_${today}`, JSON.stringify(this.todaySelection));
                    this.updateHistory();
                } catch (error) {
                    console.error('❌ Error guardando selección:', error);
                }
            },
            
            updateHistory: function() {
                try {
                    const today = this.getTodayKey();
                    let history = {};
                    
                    const historyData = localStorage.getItem('flash_sales_history');
                    if (historyData) {
                        history = JSON.parse(historyData);
                    }
                    
                    history[today] = {
                        date: new Date().toISOString(),
                        products: this.todaySelection.map(p => p.descripcion),
                        count: this.todaySelection.length
                    };
                    
                    const keys = Object.keys(history);
                    if (keys.length > 30) {
                        const oldestKey = keys.sort()[0];
                        delete history[oldestKey];
                    }
                    
                    localStorage.setItem('flash_sales_history', JSON.stringify(history));
                } catch (error) {
                    console.error('❌ Error actualizando historial:', error);
                }
            },
            
            clearHistory: function() {
                const keysToRemove = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key.startsWith('flash_sales_')) {
                        keysToRemove.push(key);
                    }
                }
                
                keysToRemove.forEach(key => localStorage.removeItem(key));
            },
            
            loadProductPool: function() {
                if (!window.products || window.products.length === 0) {
                    this.productPool = [];
                    return;
                }
                
                const candidates = window.products.filter(product => {
                    const descuentoReal = obtenerDescuentoRealProducto(product);
                    const calificaRelampago = descuentoReal >= JERARQUIA_OFERTAS.relampago.descuentoMinimo;
                    
                    const tieneStock = product.stockNumber > 0;
                    const tieneDescripcion = product.descripcion || product.id;
                    
                    return calificaRelampago && tieneStock && tieneDescripcion;
                });
                
                candidates.sort((a, b) => {
                    const descA = obtenerDescuentoRealProducto(a);
                    const descB = obtenerDescuentoRealProducto(b);
                    return descB - descA;
                });
                
                this.productPool = candidates.slice(0, this.POOL_SIZE);
            },
            
            generateDailySelection: function() {
                if (this.todaySelection.length > 0) {
                    return;
                }
                
                if (this.productPool.length === 0) {
                    this.todaySelection = [];
                    return;
                }
                
                let availablePool = [...this.productPool];
                const yesterdayIds = this.yesterdaySelection.map(p => p.descripcion || p.id);
                availablePool = availablePool.filter(p => 
                    !yesterdayIds.includes(p.descripcion || p.id)
                );
                
                if (availablePool.length < this.DAILY_SELECTION) {
                    availablePool = [...this.productPool];
                }
                
                const selected = [];
                const maxAttempts = 50;
                let attempts = 0;
                
                while (selected.length < this.DAILY_SELECTION && 
                       availablePool.length > 0 && 
                       attempts < maxAttempts) {
                    
                    const randomIndex = Math.floor(Math.random() * availablePool.length);
                    const product = availablePool[randomIndex];
                    
                    const alreadySelected = selected.some(p => 
                        (p.descripcion || p.id) === (product.descripcion || product.id)
                    );
                    
                    if (!alreadySelected) {
                        const flashProduct = {
                            ...product,
                            flashPrice: calcularPrecioConDescuento(
                                product.price,
                                '',
                                product.ofertas2,
                                1
                            ),
                            flashDiscount: obtenerDescuentoRealProducto(product),
                            flashOriginalPrice: product.price,
                            flashId: product.descripcion || product.id
                        };
                        
                        selected.push(flashProduct);
                        availablePool.splice(randomIndex, 1);
                    }
                    
                    attempts++;
                }
                
                this.todaySelection = selected;
                this.saveTodaySelection();
            },
            
            renderFlashProducts: function() {
                const container = document.getElementById('flashProductsGrid');
                if (!container) return;
                
                if (this.todaySelection.length === 0) {
                    container.innerHTML = `
                        <div style="grid-column: 1 / -1; text-align: center; padding: 2rem; color: #666;">
                            ⏳ No hay ofertas relámpago disponibles por el momento.
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = this.todaySelection.map(product => {
                    const descuentoReal = obtenerDescuentoRealProducto(product);
                    const descripcionOferta = obtenerDescripcionOferta(
                        '', 
                        product.ofertas2,
                        product.price
                    );
                    
                    const textoLimiteOfertas2 = obtenerTextoLimiteOfertas2(product.ofertas2, product.name);
                    const stockText = obtenerTextoStock(product);
                    
                    return `
                        <div class="flash-product-card jerarquia-relampago">
                            <div class="flash-exclusive-badge">⚡ EXCLUSIVO</div>
                            
                            <div class="product-image" style="height: 180px;">
                                <img src="${product.image}" 
                                     alt="${product.name}"
                                     onerror="handleImageError(this, '${product.name.replace(/'/g, "\\'")}')">
                            </div>
                            
                            <div class="product-info" style="padding: 1.2rem;">
                                <div class="product-name" style="font-size: 1rem; font-weight: bold; color: #d50000;">
                                    ${product.name}
                                </div>
                                
                                <div class="offer-description" style="color: #ff6f00; font-weight: bold; margin: 8px 0;">
                                    ${descripcionOferta}
                                </div>
                                
                                <div style="background: #ffebee; padding: 8px; border-radius: 8px; margin: 8px 0; border-left: 3px solid #ff3d00;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <strong style="color: #d50000;">⚡ NIVEL RELÁMPAGO</strong>
                                        <span style="background: #d50000; color: white; padding: 3px 8px; border-radius: 12px; font-weight: bold;">
                                            ${descuentoReal}% OFF
                                        </span>
                                    </div>
                                    <div style="font-size: 0.8rem; color: #666; margin-top: 4px;">
                                        Descuento ≥40% - Solo hoy hasta las 17:00
                                    </div>
                                </div>
                                
                                <div class="product-price-container" style="margin: 10px 0;">
                                    <span class="original-price" style="font-size: 1rem;">$${product.price}</span>
                                    <span class="flash-price">$${Math.round(product.flashPrice)}</span>
                                    <span class="flash-discount">${descuentoReal}% OFF</span>
                                </div>
                                
                                ${textoLimiteOfertas2 ? `
                                    <div class="promo-limit" style="color: #ff3d00; font-weight: bold; margin: 5px 0;">
                                        ⚠️ ${textoLimiteOfertas2}
                                    </div>
                                ` : ''}
                                
                                <div class="product-stock in-stock" style="margin: 8px 0;">
                                    ${stockText}
                                </div>
                                
                                <button class="add-to-cart" 
                                        data-id="${product.id}"
                                        style="background: linear-gradient(135deg, #ff3d00, #d50000);">
                                    🛒 Agregar al Carrito
                                </button>
                                
                                <div style="font-size: 0.75rem; color: #666; margin-top: 8px; text-align: center;">
                                    ⚡ Oferta válida solo hoy hasta las 17:00
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            },
            
            updateUI: function() {
                const container = document.getElementById('flashSalesContainer');
                const timer = document.getElementById('flashTimer');
                const overlay = document.getElementById('flashCountdownOverlay');
                
                if (!container || !timer || !overlay) return;
                
                const adminForzado = esAdmin && window.ADMIN_TOOLS?.forcedSections?.relampago;
                
                if (this.isActive || adminForzado) {
                    container.style.display = 'block';
                    timer.style.display = 'inline-flex';
                    overlay.style.display = 'none';
                    this.renderFlashProducts();
                    
                    if (adminForzado && !this.isActive) {
                        const adminWarning = document.createElement('div');
                        adminWarning.style.cssText = `
                            background: #ff9800;
                            color: white;
                            padding: 8px;
                            text-align: center;
                            font-size: 0.8rem;
                            font-weight: bold;
                            border-bottom: 2px dashed white;
                        `;
                        adminWarning.innerHTML = '🛠️ MODO TEST: Ofertas relámpago forzadas (fuera de horario)';
                        
                        const header = container.querySelector('.flash-sales-header');
                        if (header && !container.querySelector('.admin-warning')) {
                            header.parentNode.insertBefore(adminWarning, header.nextSibling);
                            adminWarning.className = 'admin-warning';
                        }
                    }
                } else {
                    container.style.display = 'none';
                }
            },
            
            startCountdown: function() {
                if (!this.isActive) {
                    this.startTomorrowCountdown();
                    return;
                }
                
                const countdownElement = document.getElementById('countdown');
                if (!countdownElement) return;
                
                const updateCountdown = () => {
                    const now = new Date();
                    const endTime = new Date();
                    
                    endTime.setHours(this.ACTIVE_HOURS.end, this.ACTIVE_HOURS.endMinutes, 0, 0);
                    
                    if (now >= endTime) {
                        this.isActive = false;
                        this.updateUI();
                        return;
                    }
                    
                    const diff = endTime - now;
                    const hours = Math.floor(diff / (1000 * 60 * 60));
                    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                    
                    const hoursStr = isNaN(hours) ? "00" : hours.toString().padStart(2, '0');
                    const minutesStr = isNaN(minutes) ? "00" : minutes.toString().padStart(2, '0');
                    const secondsStr = isNaN(seconds) ? "00" : seconds.toString().padStart(2, '0');
                    
                    countdownElement.textContent = `${hoursStr}:${minutesStr}:${secondsStr}`;
                    
                    if (hours === 0 && minutes < 30) {
                        countdownElement.style.color = '#ff3d00';
                        countdownElement.style.fontWeight = 'bold';
                    }
                    
                    requestAnimationFrame(updateCountdown);
                };
                
                updateCountdown();
            },
            
            startTomorrowCountdown: function() {
                const nextCountdownElement = document.getElementById('nextFlashCountdown');
                if (!nextCountdownElement) return;
                
                const updateNextCountdown = () => {
                    const now = new Date();
                    let nextFlashTime = new Date();
                    
                    const currentDay = now.getDay();
                    const currentHour = now.getHours();
                    
                    if (this.ACTIVE_DAYS.includes(currentDay) && 
                        currentHour >= this.ACTIVE_HOURS.end) {
                        nextFlashTime.setDate(now.getDate() + 1);
                    }
                    
                    while (!this.ACTIVE_DAYS.includes(nextFlashTime.getDay())) {
                        nextFlashTime.setDate(nextFlashTime.getDate() + 1);
                    }
                    
                    nextFlashTime.setHours(this.ACTIVE_HOURS.start, 
                                         this.ACTIVE_HOURS.startMinutes, 0, 0);
                    
                    const diff = nextFlashTime - now;
                    
                    if (diff <= 0) {
                        requestAnimationFrame(updateNextCountdown);
                        return;
                    }
                    
                    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                    
                    let countdownText = '';
                    if (days > 0) {
                        countdownText += `${days}d `;
                    }
                    countdownText += 
                        `${hours.toString().padStart(2, '0')}:` +
                        `${minutes.toString().padStart(2, '0')}:` +
                        `${seconds.toString().padStart(2, '0')}`;
                    
                    nextCountdownElement.textContent = countdownText;
                    
                    requestAnimationFrame(updateNextCountdown);
                };
                
                updateNextCountdown();
            },
            
            renderTomorrowCountdown: function() {
                const element = document.getElementById('nextFlashCountdown');
                if (!element) return;
                
                this.startTomorrowCountdown();
            },
            
            getTodayKey: function() {
                const today = new Date();
                return `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}-${today.getDate().toString().padStart(2, '0')}`;
            },
            
            getYesterdayKey: function() {
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                return `${yesterday.getFullYear()}-${(yesterday.getMonth() + 1).toString().padStart(2, '0')}-${yesterday.getDate().toString().padStart(2, '0')}`;
            }
        };
        
        // ========== ELEMENTOS DOM ==========
        const categoriesContainer = document.getElementById("categories");
        const productsGrid = document.getElementById("productsGrid");
        const featuredOffers = document.getElementById("featuredOffers");
        const featuredProductsGrid = document.getElementById("featuredProductsGrid");
        const viewAllOffers = document.getElementById("viewAllOffers");
        const cartIcon = document.getElementById("cartIcon");
        const floatingCart = document.getElementById("floatingCart");
        const floatingSearch = document.getElementById("floatingSearch");
        const floatingHome = document.getElementById("floatingHome");
        const adminFloatingButton = document.getElementById("adminFloatingButton");
        const adminPanel = document.getElementById("adminPanel");
        const adminPanelClose = document.getElementById("adminPanelClose");
        const searchModal = document.getElementById("searchModal");
        const closeSearch = document.getElementById("closeSearch");
        const mobileSearch = document.getElementById("mobileSearch");
        const mobileSearchResults = document.getElementById("mobileSearchResults");
        const cartModal = document.getElementById("cartModal");
        const closeCart = document.getElementById("closeCart");
        const cartItems = document.getElementById("cartItems");
        const cartTotal = document.getElementById("cartTotal");
        const cartCount = document.getElementById("cartCount");
        const floatingCartCount = document.getElementById("floatingCartCount");
        const sendOrder = document.getElementById("sendOrder");
        const adminBadge = document.getElementById("adminBadge");
        const adminNotification = document.getElementById("adminNotification");
        const productSearch = document.getElementById("productSearch");
        const clearSearchBtn = document.getElementById("clearSearchBtn");
        const clearMobileSearchBtn = document.getElementById("clearMobileSearchBtn");
        const searchSuggestions = document.getElementById("searchSuggestions");
        
        // ========== FUNCIONES PRINCIPALES ==========
        window.handleMobileSearchEnter = function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const searchTerm = mobileSearch.value.trim();
                if (searchTerm.length >= 2) {
                    filterMobileProducts(searchTerm);
                    mobileSearch.blur();
                }
            }
        };
        
        function sendOrderViaWhatsApp() {
            if (cart.length === 0) {
                showNotification("Tu carrito está vacío.", "error");
                return;
            }
            
            const phoneNumber = "5492944907380";
            
            let totalOriginal = 0;
            let totalWithPromos = 0;
            let totalSavings = 0;
            let orderLines = [];
            let ofertasCount = 0;

            cart.forEach(item => {
                const product = products.find(p => p.id === item.id);
                if (!product) return;
                
                const precioConDescuentoUnitario = calcularPrecioConDescuento(
                    product.price, 
                    product.ofertas1, 
                    product.ofertas2, 
                    item.quantity
                );
                
                const precioNormalTotal = product.price * item.quantity;
                const precioDescuentoTotal = precioConDescuentoUnitario * item.quantity;
                
                totalOriginal += precioNormalTotal;
                totalWithPromos += precioDescuentoTotal;
                totalSavings += precioNormalTotal - precioDescuentoTotal;
                
                if (precioConDescuentoUnitario < product.price) {
                    ofertasCount++;
                }
                
                let nombreUpper = product.name.toUpperCase();
                let icono = precioConDescuentoUnitario < product.price ? '🔥' : '✅';
                
                let tipoOferta = '';
                if (product.ofertas2 && product.ofertas2 !== '0') {
                    const descuento = parseInt(product.ofertas2);
                    if (descuento >= 50) tipoOferta = ` (¡OFERTÓN ${descuento}% OFF!)`;
                    else if (descuento >= 30) tipoOferta = ` (¡OFERTA ${descuento}% OFF!)`;
                    else tipoOferta = ` (${descuento}% OFF)`;
                } else if (product.ofertas1 && product.ofertas1 !== '0') {
                    const oferta = OFERTAS_SISTEMA[product.ofertas1];
                    if (oferta) tipoOferta = ` (${oferta.nombre})`;
                }
                
                const precioUnitarioRedondeado = Math.round(precioConDescuentoUnitario);
                const precioTotalRedondeado = Math.round(precioDescuentoTotal);
                
                let descripcion = `${icono} *${nombreUpper}*${tipoOferta}\n`;
                descripcion += `   ${item.quantity} × $${precioUnitarioRedondeado} = $${precioTotalRedondeado}`;
                
                if (product.ofertas1 === '1' && item.quantity >= 3) {
                    const grupos3x2 = Math.floor(item.quantity / 3);
                    const sobrantes = item.quantity % 3;
                    
                    if (grupos3x2 > 0) {
                        descripcion += `\n   📦 ¡${grupos3x2} promo(s) 3x2 incluida(s)!`;
                    }
                }
                
                orderLines.push(descripcion);
            });

            const ahorroTotal = Math.round(totalSavings);
            const totalAPagar = Math.round(totalWithPromos);
            const porcentajeTotal = totalOriginal > 0 ? 
                Math.round((ahorroTotal / totalOriginal) * 100) : 0;
            
            const ahora = new Date();
            const mes = ahora.getMonth();
            const dia = ahora.getDate();
            const diaSemana = ahora.getDay();
            const currentYear = new Date().getFullYear();
            
            let saludoEspecial = "";
            let calendarioMensaje = "";
            
            if (mes === 0) {
                saludoEspecial = "🎉 *¡FELIZ AÑO NUEVO!* 🎉\nComienza el año con las mejores ofertas\n";
                calendarioMensaje = "📅 *Calendario Anual*\nEnero: ¡Año nuevo, ofertas nuevas!\nFebrero: Descuentos de verano\nMarzo: Vuelta al cole con precios especiales\nAbril: Semana Santa con promociones\nMayo: Día de la madre\nJunio: Invierno con calor de hogar\nJulio: Vacaciones de invierno\nAgosto: Día del niño\nSeptiembre: Primavera florida\nOctubre: Día de la madre (Arg)\nNoviembre: Preparando Navidad\nDiciembre: ¡La mejor Navidad!\n\n";
            } else if (mes === 11) {
                saludoEspecial = "🎄 *¡FELIZ NAVIDAD!* 🎅\nQue la luz de la Navidad ilumine tu hogar\n";
                calendarioMensaje = "📅 *Calendario Navideño*\n• Diciembre 24: Nochebuena\n• Diciembre 25: Navidad\n• Diciembre 31: Año Nuevo\n\n🌟 *Promesa para el 2025:*\nSeguiremos siendo tu almacén de confianza\n\n";
            } else if (mes === 9) {
                saludoEspecial = "🌸 *¡FELIZ DÍA DE LA MADRE!* 💐\nPara la reina del hogar, los mejores precios\n";
            } else if (mes === 7) {
                saludoEspecial = "🎈 *¡FELIZ DÍA DEL NIÑO!* 🎁\nPara los más chicos, las mejores golosinas\n";
            } else if (mes === 4) {
                saludoEspecial = "💐 *¡FELIZ DÍA DE LA MADRE!* 🌹\nCelebremos a las mamás con amor\n";
            } else if (mes === 2) {
                saludoEspecial = "📚 *¡VUELTA AL COLE!* ✏️\nTodo lo que necesitan para estudiar\n";
            }
            
            if (diaSemana === 0 || diaSemana === 6) {
                saludoEspecial += "🏖️ *¡FELIZ FIN DE SEMANA!*\nDisfruta con los mejores productos\n\n";
            }
            
            let message = `*🛒 PEDIDO ALMACÉN COPIHUE*\n`;
            message += `━━━━━━━━━━━━━━━━━━━━━━\n\n`;
            
            if (saludoEspecial) {
                message += saludoEspecial;
                message += `━━━━━━━━━━━━━━━━━━━━━━\n\n`;
            }
            
            message += `📦 *TU COMPRA:*\n\n`;
            
            orderLines.forEach(line => {
                message += line + '\n\n';
            });
            
            message += `━━━━━━━━━━━━━━━━━━━━━━\n`;
            
            if (ofertasCount > 0) {
                message += `🎊 *¡APROVECHASTE ${ofertasCount} OFERTA(S)!*\n`;
            }
            
            message += `🛍️  *Productos:* ${cart.length} items\n`;
            message += `📊 *Unidades:* ${cart.reduce((sum, item) => sum + item.quantity, 0)}\n\n`;
            
            if (ahorroTotal > 0) {
                message += `💰 *Precio normal:* $${Math.round(totalOriginal)}\n`;
                message += `⚡ *¡AHORRASTE $${ahorroTotal}!*\n`;
                message += `🎯 *Descuento total: ${porcentajeTotal}%*\n\n`;
                
                if (porcentajeTotal >= 30) {
                    message += `🏆 *¡Compra inteligente!*\n\n`;
                }
            }
            
            message += `━━━━━━━━━━━━━━━━━━━━━━\n`;
            message += `💵 *TOTAL A PAGAR:* $${totalAPagar}\n`;
            message += `━━━━━━━━━━━━━━━━━━━━━━\n\n`;
            
            if (calendarioMensaje) {
                message += calendarioMensaje;
                message += `━━━━━━━━━━━━━━━━━━━━━━\n\n`;
            }
            
            message += `🚀 *¡TU PEDIDO ESTÁ LISTO PARA RETIRAR!*\n\n`;
            
            message += `✅ *Retiro rápido en 15-20 minutos*\n`;
            message += `✅ *Productos frescos y de calidad*\n`;
            message += `✅ *Atención personalizada*\n`;
            message += `✅ *Precios de barrio*\n\n`;
            
            message += `📍 *Dirección:* Copihue 457\n`;
            message += `⏰ *Horario:* 11:30 a 23:30 hs\n`;
            message += `📱 *Confirmá por este WhatsApp*\n\n`;
            
            if (ahorroTotal > 0) {
                message += `💡 *¿Sabías que ahorraste $${ahorroTotal}?*\n`;
                message += `🎉 *¡Ese ahorro ya es ganancia para vos!*\n\n`;
            }
            
            if (mes === 11) {
                message += `🎅 *¡Que tengas una Feliz Navidad y Próspero Año Nuevo!*\n`;
                message += `🌟 *De todo el equipo de Almacén Copihue*\n\n`;
            } else if (mes === 0) {
                message += `✨ *¡Te deseamos un año ${currentYear} lleno de prosperidad!*\n`;
                message += `🎯 *Siempre a tu servicio en Almacén Copihue*\n\n`;
            } else {
                message += `⏳ *Pedido listo en 15-20 minutos*\n`;
                message += `🎁 *Gracias por elegir tu almacén de confianza*\n\n`;
            }
            
            message += `#AlmacénCopihue #PreciosDeBarrio #LaConfianzaDeSiempre`;
            
            const encodedMessage = encodeURIComponent(message);
            const whatsappURL = `https://wa.me/${phoneNumber}?text=${encodedMessage}`;
            
            showNotification("📱 Abriendo WhatsApp...", "info");
            
            cart = [];
            updateCartCount();
            closeCartModal();
            
            window.open(whatsappURL, "_blank");
        }
        
        // ========== EVENT LISTENERS ==========
        cartIcon.addEventListener("click", openCart);
        floatingCart.addEventListener("click", openCart);
        closeCart.addEventListener("click", closeCartModal);
        floatingSearch.addEventListener("click", openSearchModal);
        closeSearch.addEventListener("click", closeSearchModal);
        floatingHome.addEventListener("click", () => { 
            currentCategory = "TODOS"; 
            renderCategories(); 
            renderProducts(); 
            showHomeFeedback(); 
        });
        clearSearchBtn.addEventListener("click", clearSearch);
        clearMobileSearchBtn.addEventListener("click", clearMobileSearch);
        viewAllOffers.addEventListener("click", verTodasLasOfertas);
        
        // ========== BÚSQUEDA ==========
        const SEARCH_DICTIONARY = {
            'tomate': ['tomates'],
            'durazno': ['duraznos'],
            'manzana': ['manzanas'],
            'naranja': ['naranjas'],
            'limon': ['limones'],
            'cebolla': ['cebollas'],
            'papa': ['papas'],
            'zanahoria': ['zanahorias'],
            'lechuga': ['lechugas'],
            'kg': ['kilo', 'kilos'],
            'gr': ['gramo', 'gramos'],
            'unid': ['unidad', 'unidades'],
            'alfajor': ['alfajores'],
            'alfajores': ['alfajor'],
            'galletita': ['galletitas', 'galletas'],
            'galleta': ['galletas', 'galletita'],
            'chocolate': ['chocolates'],
            'chocolates': ['chocolate']
        };
        
        function normalizeSearchTerm(term) {
            let normalized = term.toLowerCase().trim();
            normalized = normalized.replace(/[^\w\s]/g, ' ');
            normalized = normalized.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            normalized = normalized.replace(/\s+/g, ' ');
            return normalized;
        }
        
        function expandSearchTerms(searchTerm) {
            const normalizedTerm = normalizeSearchTerm(searchTerm);
            const words = normalizedTerm.split(' ');
            const expandedTerms = new Set();
            
            expandedTerms.add(normalizedTerm);
            
            words.forEach(word => {
                if (word.length < 2) return;
                
                expandedTerms.add(word);
                
                for (const [key, synonyms] of Object.entries(SEARCH_DICTIONARY)) {
                    if (key === word) {
                        synonyms.forEach(synonym => expandedTerms.add(synonym));
                    }
                    
                    if (synonyms.includes(word)) {
                        expandedTerms.add(key);
                        synonyms.forEach(synonym => expandedTerms.add(synonym));
                    }
                }
            });
            
            if (words.length > 1) {
                expandedTerms.add(words.join(''));
                expandedTerms.add(words.join('-'));
                
                if (words.length === 2) {
                    expandedTerms.add(`${words[1]} ${words[0]}`);
                }
            }
            
            return Array.from(expandedTerms);
        }
        
        function searchProducts(searchTerm) {
            if (!products || products.length === 0) return [];
            if (searchTerm.length < 2) return [];
            
            const expandedTerms = expandSearchTerms(searchTerm);
            
            const results = products.filter(product => {
                const productName = normalizeSearchTerm(product.name);
                const hasStock = product.stock === "STOCK" || product.stockNumber > 0;
                
                if (!hasStock && !ADMIN_TOOLS.showHidden) return false;
                
                return expandedTerms.some(term => {
                    if (productName.includes(term) && term.length > 1) return true;
                    
                    if (term.length <= 3 && term.length > 1) {
                        const initials = productName.split(' ')
                            .map(word => word.charAt(0))
                            .join('');
                        if (initials.includes(term)) return true;
                    }
                    
                    if (term.length > 3) {
                        if (productName.includes(term.substring(0, Math.max(3, term.length - 1)))) {
                            return true;
                        }
                    }
                    
                    return false;
                });
            });
            
            results.sort((a, b) => {
                const nameA = normalizeSearchTerm(a.name);
                const nameB = normalizeSearchTerm(b.name);
                
                const exactMatchA = expandedTerms.some(term => nameA === term);
                const exactMatchB = expandedTerms.some(term => nameB === term);
                
                if (exactMatchA && !exactMatchB) return -1;
                if (!exactMatchA && exactMatchB) return 1;
                
                if (a.stockNumber !== b.stockNumber) {
                    return b.stockNumber - a.stockNumber;
                }
                
                if (a.hasPromo !== b.hasPromo) {
                    return b.hasPromo - a.hasPromo;
                }
                
                return 0;
            });
            
            return results;
        }
        
        // ========== CARGAR PRODUCTOS ==========
        async function loadProductsFromAPI() {
            if (window.appInitialized) {
                console.log('⚠️ Ya cargué antes');
                return;
            }
            
            window.appInitialized = true;
            
            try {
                console.log('🚀 Cargando productos...');
                
                if (productsGrid) {
                    productsGrid.innerHTML = '<div class="loading">🔄 Contactando base de datos...</div>';
                }
                
                const TU_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxhKFk2WAi-KRY5xGBsI6_6Pvp3jDjt8mSRXvy7I1WehNmBpJamqK9G9Q1ZJSCSgAdfDA/exec';
                const urlConCache = TU_APPS_SCRIPT_URL + '?cache=' + Date.now();
                
                const respuesta = await fetch(urlConCache, {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                });
                
                if (!respuesta.ok) throw new Error(`Error ${respuesta.status}`);
                
                const datos = await respuesta.json();
                
                if (datos.productos && Array.isArray(datos.productos)) {
                    processAPIData(datos);
                } else if (Array.isArray(datos)) {
                    processAPIData({ productos: datos });
                } else if (datos.values && Array.isArray(datos.values)) {
                    const productosConvertidos = datos.values.slice(1).map((fila, index) => ({
                        id: index + 1,
                        name: fila[0] || '',
                        price: parseInt(fila[1]) || 0,
                        category: fila[2] || 'ALMACEN',
                        stock: parseInt(fila[3]) || 0,
                        oferta1: fila[4] || '',
                        oferta2: fila[5] || '',
                        descripcion: fila[6] || `producto_${index + 1}`
                    }));
                    processAPIData({ productos: productosConvertidos });
                } else {
                    mostrarErrorFormato(datos);
                }
                
            } catch (error) {
                console.error('💥 ERROR:', error);
                mostrarErrorAmigable(error);
            }
        }
        
        function processAPIData(apiData) {
            console.log('📦 Datos recibidos:', apiData);
            
            const productosArray = apiData.productos || apiData;
            console.log('🔄 Procesando', productosArray.length, 'productos desde API');
            
            products = [];
            window.products = products;
            
            productosArray.forEach((item, index) => {
                try {
                    const nombre = item.name || 'Producto sin nombre';
                    const precio = parseInt(item.price) || 0;
                    const descripcion = item.descripcion || item.name.replace(/\s+/g, '_').toLowerCase() || `producto_${index}`;
                    
                    let categoriaRaw = item.category;
                    let categoria = 'ALMACEN';
                    if (categoriaRaw) {
                        categoria = String(categoriaRaw).trim().toUpperCase();
                    }
                    
                    const stockValue = item.stock || 0;
                    const ofertas1 = item.oferta1 || '';
                    const ofertas2 = item.oferta2 || '';
                    
                    let stockNumber = parseInt(stockValue);
                    if (isNaN(stockNumber) || stockNumber < 0) stockNumber = 0;
                    let stockStatus = "STOCK";
                    if (stockNumber === 0) {
                        stockStatus = "SIN STOCK";
                    } else if (stockNumber > 0 && stockNumber <= 3) {
                        stockStatus = "STOCK BAJO";
                    }
                    
                    const tieneOferta1 = ofertas1 && ofertas1 !== '' && ofertas1 !== '0';
                    const tieneOferta2 = ofertas2 && ofertas2 !== '' && ofertas2 !== '0';
                    const tieneOferta = tieneOferta1 || tieneOferta2;
                    
                    const descuentoReal = obtenerDescuentoRealProducto({
                        ofertas1: ofertas1,
                        ofertas2: ofertas2
                    });
                    
                    let precioConDescuento = precio;
                    let textoCortoOferta = '';
                    
                    if (tieneOferta2) {
                        const porcentaje = parseInt(ofertas2);
                        if (porcentaje > 0 && porcentaje <= 100) {
                            precioConDescuento = calcularPrecioConDescuento(precio, '', ofertas2, 1);
                            textoCortoOferta = obtenerTextoCortoOferta('', ofertas2);
                        }
                    } 
                    else if (tieneOferta1) {
                        if (OFERTAS_SISTEMA[ofertas1]) {
                            const oferta = OFERTAS_SISTEMA[ofertas1];
                            precioConDescuento = calcularPrecioConDescuento(precio, ofertas1, '', 1);
                            textoCortoOferta = obtenerTextoCortoOferta(ofertas1, '');
                        }
                    }
                    
                    precioConDescuento = redondearPrecioAlmacenCopihue(precioConDescuento);
                    
                    const tipoVenta = obtenerTipoDeVenta(nombre);
                    const textoStock = obtenerTextoStock({
                        name: nombre,
                        stockNumber: stockNumber
                    });
                    
                    const product = {
                        id: item.id || index + 1,
                        name: nombre,
                        price: precio,
                        category: categoria,
                        stock: stockStatus,
                        stockNumber: stockNumber,
                        image: `imagenes-productos/${simplificarNombre(nombre)}.jpg`,
                        descripcion: descripcion,
                        hasPromo: tieneOferta,
                        ofertas1: ofertas1,
                        ofertas2: ofertas2,
                        discountedPrice: precioConDescuento,
                        discountPercent: descuentoReal,
                        descuentoReal: descuentoReal,
                        offerText: textoCortoOferta,
                        tipoVenta: tipoVenta,
                        textoStock: textoStock,
                        precioUnitarioReal: precioConDescuento,
                        ahorroPorUnidad: precio - precioConDescuento,
                        tieneOferta1: tieneOferta1,
                        tieneOferta2: tieneOferta2,
                    };
                    
                    products.push(product);
                    
                } catch (error) {
                    console.warn(`⚠️ Error procesando producto ${index}:`, error.message, item);
                }
            });
            
            console.log('✅', products.length, 'productos listos para mostrar');
            
            const productosConOferta = products.filter(p => p.hasPromo).length;
            const productosConStock = products.filter(p => p.stockNumber > 0).length;
            
            if (productsGrid) {
                productsGrid.innerHTML = `
                    <div style="background: linear-gradient(135deg, #4CAF50, #2e7d32); 
                                color: white; padding: 12px; border-radius: 10px; 
                                margin-bottom: 1rem; text-align: center;">
                        ✅ <strong>${products.length} productos cargados desde tu base de datos</strong>
                        <div style="display: flex; justify-content: center; gap: 20px; margin-top: 8px; font-size: 0.9rem;">
                            <span>📦 ${productosConStock} con stock</span>
                            <span>🔥 ${productosConOferta} con ofertas</span>
                            <span>🏪 ${[...new Set(products.map(p => p.category))].length} categorías</span>
                        </div>
                    </div>
                `;
            }
            
            renderCategories();
            
            clasificarProductosPorJerarquia();
            
            mostrarOfertasDestacadas();
            
            renderProducts();
            
            setTimeout(() => {
                controlarVisibilidadPorHorario();
                if (typeof FLASH_SALES_SYSTEM !== 'undefined' && 
                    FLASH_SALES_SYSTEM.init) {
                    FLASH_SALES_SYSTEM.init();
                }
            }, 500);
        }
        
        function simplificarNombre(nombre) {
            return nombre
                .toLowerCase()
                .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
                .replace(/[^a-z0-9 ]/g, "")
                .replace(/\s+/g, '-')
                .replace(/-+/g, '-')
                .trim();
        }
        
        // ========== INTERFAZ ==========
        function detectarAdmin() {
            const urlParams = new URLSearchParams(window.location.search);
            const hasAdminParam = urlParams.has('admin');
            const adminKey = urlParams.get('key');
            
            const ADMIN_PASSWORD = "AlmacenCopihue2024";
            
            if (hasAdminParam) {
                if (adminKey === ADMIN_PASSWORD) {
                    esAdmin = true;
                } 
                else if (!adminKey) {
                    const password = prompt("🔒 MODO ADMINISTRADOR\n\nIntroduce la clave de acceso:", "");
                    if (password === ADMIN_PASSWORD) {
                        esAdmin = true;
                        urlParams.set('key', ADMIN_PASSWORD);
                        const newUrl = `${window.location.pathname}?${urlParams.toString()}`;
                        window.history.replaceState({}, '', newUrl);
                    } else {
                        esAdmin = false;
                        alert("❌ Clave incorrecta. Modo administrador desactivado.");
                        urlParams.delete('admin');
                        urlParams.delete('key');
                        const newUrl = `${window.location.pathname}${urlParams.toString() ? '?' + urlParams.toString() : ''}`;
                        window.history.replaceState({}, '', newUrl);
                    }
                } 
                else {
                    esAdmin = false;
                    alert("❌ Clave incorrecta en URL. Modo administrador desactivado.");
                    urlParams.delete('admin');
                    urlParams.delete('key');
                    const newUrl = `${window.location.pathname}${urlParams.toString() ? '?' + urlParams.toString() : ''}`;
                    window.history.replaceState({}, '', newUrl);
                }
            } else {
                esAdmin = false;
            }
            
            if (esAdmin) {
                adminBadge.style.display = 'inline-block';
                adminNotification.style.display = 'block';
                adminFloatingButton.style.display = 'flex';
                console.log('🔧 MODO ADMIN ACTIVADO - Acceso seguro');
                
                // Inicializar panel admin
                initAdminPanel();
            }
        }
        
        // ========== PANEL DE ADMINISTRACIÓN ==========
        function initAdminPanel() {
            console.log('🛠️ Inicializando panel de administración...');
            
            // Mostrar botón flotante
            adminFloatingButton.style.display = 'flex';
            
            // Event listeners para panel admin
            adminFloatingButton.addEventListener('click', toggleAdminPanel);
            adminPanelClose.addEventListener('click', closeAdminPanel);
            
            // Botones de forzar visibilidad
            document.getElementById('adminForceRelampago').addEventListener('click', () => {
                ADMIN_TOOLS.forcedSections.relampago = !ADMIN_TOOLS.forcedSections.relampago;
                updateAdminForcedStatus();
                controlarVisibilidadPorHorario();
                showNotification(`⚡ Relámpago ${ADMIN_TOOLS.forcedSections.relampago ? 'forzado' : 'normal'}`, 'info');
            });
            
            document.getElementById('adminForceDestacadas').addEventListener('click', () => {
                ADMIN_TOOLS.forcedSections.destacadas = !ADMIN_TOOLS.forcedSections.destacadas;
                updateAdminForcedStatus();
                controlarVisibilidadPorHorario();
                showNotification(`🔥 Destacadas ${ADMIN_TOOLS.forcedSections.destacadas ? 'forzadas' : 'normal'}`, 'info');
            });
            
            document.getElementById('adminForceEspeciales').addEventListener('click', () => {
                ADMIN_TOOLS.forcedSections.especiales = !ADMIN_TOOLS.forcedSections.especiales;
                updateAdminForcedStatus();
                controlarVisibilidadPorHorario();
                showNotification(`🎁 Especiales ${ADMIN_TOOLS.forcedSections.especiales ? 'forzados' : 'normal'}`, 'info');
            });
            
            // Botones de limpiar cache
            document.getElementById('adminClearCache').addEventListener('click', limpiarCacheCompleto);
            document.getElementById('adminClearLocal').addEventListener('click', () => {
                localStorage.clear();
                showNotification('🗑️ LocalStorage limpiado', 'success');
                updateSystemInfo();
            });
            document.getElementById('adminClearSession').addEventListener('click', () => {
                sessionStorage.clear();
                showNotification('🗑️ SessionStorage limpiado', 'success');
                updateSystemInfo();
            });
            document.getElementById('adminClearFlash').addEventListener('click', () => {
                if (typeof FLASH_SALES_SYSTEM !== 'undefined' && FLASH_SALES_SYSTEM.clearHistory) {
                    FLASH_SALES_SYSTEM.clearHistory();
                    showNotification('⚡ Historial Flash Sales limpiado', 'success');
                    updateSystemInfo();
                }
            });
            
            // Toggles
            document.getElementById('adminToggleOcultos').addEventListener('click', () => {
                ADMIN_TOOLS.showHidden = !ADMIN_TOOLS.showHidden;
                const toggle = document.querySelector('#adminToggleOcultos .admin-toggle-switch');
                toggle.classList.toggle('active', ADMIN_TOOLS.showHidden);
                mostrarProductosOcultos = ADMIN_TOOLS.showHidden;
                showNotification(`👁️ Productos ocultos ${ADMIN_TOOLS.showHidden ? 'visibles' : 'ocultos'}`, 'info');
                renderProducts();
                updateSystemInfo();
            });
            
            document.getElementById('adminToggleDebug').addEventListener('click', () => {
                ADMIN_TOOLS.debugMode = !ADMIN_TOOLS.debugMode;
                const toggle = document.querySelector('#adminToggleDebug .admin-toggle-switch');
                toggle.classList.toggle('active', ADMIN_TOOLS.debugMode);
                modoDebug = ADMIN_TOOLS.debugMode;
                showNotification(`🔬 Modo debug ${ADMIN_TOOLS.debugMode ? 'activado' : 'desactivado'}`, 'info');
                updateSystemInfo();
            });
            
            // Botones de recargar/test
            document.getElementById('adminRefreshData').addEventListener('click', () => {
                window.appInitialized = false;
                loadProductsFromAPI();
                showNotification('🔄 Recargando datos...', 'info');
            });
            
            document.getElementById('adminTestAPI').addEventListener('click', testAPI);
            
            // Botones de test de secciones
            document.getElementById('adminTestRelampago').addEventListener('click', () => {
                testSeccion('relampago');
            });
            
            document.getElementById('adminTestDestacadas').addEventListener('click', () => {
                testSeccion('destacadas');
            });
            
            document.getElementById('adminTestEspeciales').addEventListener('click', () => {
                testSeccion('especiales');
            });
            
            document.getElementById('adminTestHorarios').addEventListener('click', testHorarios);
            
            // Botones de sistema
            document.getElementById('adminExportData').addEventListener('click', exportarDatos);
            document.getElementById('adminResetAll').addEventListener('click', resetTotal);
            
            // Actualizar información inicial
            updateAdminForcedStatus();
            updateSystemInfo();
            
            console.log('✅ Panel de administración listo');
        }
        
        function toggleAdminPanel() {
            if (adminPanel.style.display === 'block') {
                closeAdminPanel();
            } else {
                openAdminPanel();
            }
        }
        
        function openAdminPanel() {
            adminPanel.style.display = 'block';
            document.body.classList.add('admin-panel-visible');
            updateSystemInfo();
        }
        
        function closeAdminPanel() {
            adminPanel.style.display = 'none';
            document.body.classList.remove('admin-panel-visible');
        }
        
        function updateAdminForcedStatus() {
            const statusElement = document.getElementById('adminForcedStatus');
            if (!statusElement) return;
            
            const forced = [];
            if (ADMIN_TOOLS.forcedSections.relampago) forced.push('⚡ Relámpago');
            if (ADMIN_TOOLS.forcedSections.destacadas) forced.push('🔥 Destacadas');
            if (ADMIN_TOOLS.forcedSections.especiales) forced.push('🎁 Especiales');
            
            if (forced.length === 0) {
                statusElement.innerHTML = '🔄 Forzado: Ninguno';
            } else {
                statusElement.innerHTML = `🔄 Forzado: ${forced.join(', ')}`;
            }
        }
        
        function updateSystemInfo() {
            const infoElement = document.getElementById('adminSystemInfo');
            if (!infoElement) return;
            
            const ahora = new Date();
            const diaSemana = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'][ahora.getDay()];
            const hora = ahora.getHours().toString().padStart(2, '0');
            const minutos = ahora.getMinutes().toString().padStart(2, '0');
            
            const productosTotal = products.length;
            const productosConStock = products.filter(p => p.stockNumber > 0).length;
            const productosConOferta = products.filter(p => p.descuentoReal > 0).length;
            
            let info = `📅 ${diaSemana} ${hora}:${minutos}<br>`;
            info += `📦 Productos: ${productosTotal} total, ${productosConStock} con stock<br>`;
            info += `🔥 Ofertas: ${productosConOferta} productos con descuento<br>`;
            info += `⚡ Relámpago: ${window.productosRelampagoIds?.length || 0} productos<br>`;
            info += `🔧 Admin: ${ADMIN_TOOLS.showHidden ? '👁️ Ocultos visibles' : '👁️ Ocultos ocultos'} | ${ADMIN_TOOLS.debugMode ? '🔬 Debug ON' : '🔬 Debug OFF'}`;
            
            infoElement.innerHTML = info;
        }
        
        function limpiarCacheCompleto() {
            // Limpiar localStorage
            localStorage.clear();
            
            // Limpiar sessionStorage
            sessionStorage.clear();
            
            // Limpiar caché de imágenes
            if ('caches' in window) {
                caches.keys().then(function(names) {
                    for (let name of names) {
                        caches.delete(name);
                    }
                });
            }
            
            // Forzar recarga sin cache
            window.appInitialized = false;
            
            showNotification('🧹 Caché completo limpiado', 'success');
            
            // Recargar productos
            setTimeout(() => {
                loadProductsFromAPI();
            }, 1000);
            
            updateSystemInfo();
        }
        
        async function testAPI() {
            try {
                showNotification('🧪 Probando conexión con API...', 'info');
                
                const TU_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxhKFk2WAi-KRY5xGBsI6_6Pvp3jDjt8mSRXvy7I1WehNmBpJamqK9G9Q1ZJSCSgAdfDA/exec';
                const startTime = Date.now();
                
                const respuesta = await fetch(TU_APPS_SCRIPT_URL + '?test=' + Date.now());
                const endTime = Date.now();
                const tiempoRespuesta = endTime - startTime;
                
                if (respuesta.ok) {
                    showNotification(`✅ API respondió en ${tiempoRespuesta}ms`, 'success');
                    console.log('✅ Test API exitoso:', { tiempoRespuesta });
                } else {
                    showNotification(`❌ API error: ${respuesta.status}`, 'error');
                }
            } catch (error) {
                showNotification(`❌ Error de conexión: ${error.message}`, 'error');
            }
        }
        
        function testSeccion(seccion) {
            const tests = {
                relampago: {
                    nombre: '⚡ Relámpago',
                    dias: JERARQUIA_OFERTAS.relampago.dias,
                    horario: JERARQUIA_OFERTAS.relampago.horario
                },
                destacadas: {
                    nombre: '🔥 Destacadas',
                    dias: JERARQUIA_OFERTAS.destacadas.dias,
                    horario: JERARQUIA_OFERTAS.destacadas.horario
                },
                especiales: {
                    nombre: '🎁 Especiales',
                    dias: JERARQUIA_OFERTAS.especiales.dias,
                    horario: JERARQUIA_OFERTAS.especiales.horario
                }
            };
            
            const test = tests[seccion];
            if (!test) return;
            
            const ahora = new Date();
            const hora = ahora.getHours();
            const minutos = ahora.getMinutes();
            const diaSemana = ahora.getDay();
            
            const enDiaCorrecto = test.dias.includes(diaSemana);
            const horaDecimal = hora + (minutos / 100);
            const horaInicio = test.horario.start + (test.horario.startMinutes / 100);
            const horaFin = test.horario.end + (test.horario.endMinutes / 100);
            
            const enHorarioCorrecto = horaDecimal >= horaInicio && horaDecimal <= horaFin;
            
            let mensaje = `🧪 Test ${test.nombre}:\n`;
            mensaje += `• Día actual: ${['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'][diaSemana]}\n`;
            mensaje += `• Días válidos: ${test.dias.map(d => ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'][d]).join(', ')}\n`;
            mensaje += `• Día correcto: ${enDiaCorrecto ? '✅' : '❌'}\n`;
            mensaje += `• Hora actual: ${hora}:${minutos.toString().padStart(2, '0')}\n`;
            mensaje += `• Horario válido: ${test.horario.start}:${test.horario.startMinutes.toString().padStart(2, '0')} - ${test.horario.end}:${test.horario.endMinutes.toString().padStart(2, '0')}\n`;
            mensaje += `• Horario correcto: ${enHorarioCorrecto ? '✅' : '❌'}\n`;
            mensaje += `• Sección debería estar: ${(enDiaCorrecto && enHorarioCorrecto) ? 'VISIBLE' : 'OCULTA'}`;
            
            alert(mensaje);
            console.log(`🧪 Test ${seccion}:`, { 
                diaActual: diaSemana, 
                horaActual: `${hora}:${minutos}`,
                enDiaCorrecto, 
                enHorarioCorrecto,
                deberiaEstarVisible: (enDiaCorrecto && enHorarioCorrecto)
            });
        }
        
        function testHorarios() {
            const ahora = new Date();
            const hora = ahora.getHours();
            const minutos = ahora.getMinutes();
            const diaSemana = ahora.getDay();
            const nombreDia = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'][diaSemana];
            
            let mensaje = `🕒 TEST HORARIOS COMPLETO:\n\n`;
            mensaje += `📅 ${nombreDia} ${hora}:${minutos.toString().padStart(2, '0')}\n\n`;
            
            // Test Relámpago
            const enDiaRelampago = JERARQUIA_OFERTAS.relampago.dias.includes(diaSemana);
            const enHorarioRelampago = (hora > 11 || (hora === 11 && minutos >= 30)) && 
                                       (hora < 17 || (hora === 17 && minutos === 0));
            mensaje += `⚡ RELÁMPAGO (Dom-Jue 11:30-17:00):\n`;
            mensaje += `  • Días: ${JERARQUIA_OFERTAS.relampago.dias.map(d => ['D', 'L', 'M', 'X', 'J', 'V', 'S'][d]).join(', ')}\n`;
            mensaje += `  • Día actual válido: ${enDiaRelampago ? '✅' : '❌'}\n`;
            mensaje += `  • Horario actual válido: ${enHorarioRelampago ? '✅' : '❌'}\n`;
            mensaje += `  • VISIBLE: ${(enDiaRelampago && enHorarioRelampago) ? '✅ SÍ' : '❌ NO'}\n\n`;
            
            // Test Destacadas
            const enDiaDestacadas = JERARQUIA_OFERTAS.destacadas.dias.includes(diaSemana);
            const enHorarioDestacadas = (hora >= 18) && (hora < 23);
            mensaje += `🔥 DESTACADAS (Vie-Sáb 18:00-23:00):\n`;
            mensaje += `  • Días: ${JERARQUIA_OFERTAS.destacadas.dias.map(d => ['D', 'L', 'M', 'X', 'J', 'V', 'S'][d]).join(', ')}\n`;
            mensaje += `  • Día actual válido: ${enDiaDestacadas ? '✅' : '❌'}\n`;
            mensaje += `  • Horario actual válido: ${enHorarioDestacadas ? '✅' : '❌'}\n`;
            mensaje += `  • VISIBLE: ${(enDiaDestacadas && enHorarioDestacadas) ? '✅ SÍ' : '❌ NO'}\n\n`;
            
            // Test Especiales
            const enDiaEspeciales = JERARQUIA_OFERTAS.especiales.dias.includes(diaSemana);
            const enHorarioEspeciales = ((hora > 11 || (hora === 11 && minutos >= 30)) && 
                                         (hora < 23 || (hora === 23 && minutos <= 30)));
            mensaje += `🎁 ESPECIALES (Diario 11:30-23:30):\n`;
            mensaje += `  • Días: ${JERARQUIA_OFERTAS.especiales.dias.map(d => ['D', 'L', 'M', 'X', 'J', 'V', 'S'][d]).join(', ')}\n`;
            mensaje += `  • Día actual válido: ${enDiaEspeciales ? '✅' : '❌'}\n`;
            mensaje += `  • Horario actual válido: ${enHorarioEspeciales ? '✅' : '❌'}\n`;
            mensaje += `  • VISIBLE: ${(enDiaEspeciales && enHorarioEspeciales) ? '✅ SÍ' : '❌ NO'}\n\n`;
            
            // Estado forzado admin
            mensaje += `🔧 ESTADO ADMIN FORZADO:\n`;
            mensaje += `  • ⚡ Relámpago: ${ADMIN_TOOLS.forcedSections.relampago ? '✅ FORZADO' : '🔄 NORMAL'}\n`;
            mensaje += `  • 🔥 Destacadas: ${ADMIN_TOOLS.forcedSections.destacadas ? '✅ FORZADO' : '🔄 NORMAL'}\n`;
            mensaje += `  • 🎁 Especiales: ${ADMIN_TOOLS.forcedSections.especiales ? '✅ FORZADO' : '🔄 NORMAL'}`;
            
            alert(mensaje);
        }
        
        function exportarDatos() {
            const datos = {
                version: APP_VERSION,
                timestamp: new Date().toISOString(),
                productos: products.length,
                categorias: [...new Set(products.map(p => p.category))],
                estadisticas: {
                    total: products.length,
                    conStock: products.filter(p => p.stockNumber > 0).length,
                    conOferta: products.filter(p => p.descuentoReal > 0).length,
                    relampago: window.productosRelampagoIds?.length || 0,
                    destacadas: window.productosDestacadosIds?.length || 0,
                    especiales: window.productosEspecialesIds?.length || 0
                },
                configuracion: {
                    horarios: JERARQUIA_OFERTAS,
                    admin: ADMIN_TOOLS
                }
            };
            
            const datosStr = JSON.stringify(datos, null, 2);
            const blob = new Blob([datosStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `almacen-copihue-export-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showNotification('📤 Datos exportados', 'success');
        }
        
        function resetTotal() {
            if (confirm('🚨 ¿ESTÁS SEGURO DE QUERER RESETEAR TODO?\n\nEsto limpiará:\n• Caché completo\n• Historial Flash Sales\n• Configuraciones admin\n\nLa acción NO se puede deshacer.')) {
                // Limpiar todo
                localStorage.clear();
                sessionStorage.clear();
                
                if (typeof FLASH_SALES_SYSTEM !== 'undefined' && FLASH_SALES_SYSTEM.clearHistory) {
                    FLASH_SALES_SYSTEM.clearHistory();
                }
                
                // Resetear variables admin
                ADMIN_TOOLS.forcedSections = {
                    relampago: false,
                    destacadas: false,
                    especiales: false
                };
                ADMIN_TOOLS.showHidden = false;
                ADMIN_TOOLS.debugMode = false;
                
                // Recargar página
                window.location.reload();
            }
        }
        
        function showHomeFeedback(mensaje = "🏠 Volviendo al inicio") {
            try {
                const oldNotifications = document.querySelectorAll('.home-feedback-notification');
                oldNotifications.forEach(el => el.remove());
                
                const notification = document.createElement('div');
                notification.className = 'home-feedback-notification';
                notification.innerHTML = mensaje;
                
                notification.style.cssText = `
                    position: fixed;
                    top: 100px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: linear-gradient(135deg, #2196F3, #0D47A1);
                    color: white;
                    padding: 12px 24px;
                    border-radius: 25px;
                    box-shadow: 0 4px 15px rgba(33, 150, 243, 0.4);
                    z-index: 99999;
                    font-weight: 600;
                    font-size: 14px;
                    animation: slideDown 0.3s ease;
                    border: 2px solid white;
                    text-align: center;
                    min-width: 200px;
                    max-width: 80%;
                `;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 1500);
                
            } catch (error) {
                console.warn('⚠️ Error en showHomeFeedback():', error);
            }
        }
        
        function setupSearch() {
            productSearch.addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase().trim();
                toggleClearButton(clearSearchBtn, searchTerm);
                
                if (searchTerm === '') {
                    clearSearch();
                    return;
                }
                
                if (searchTerm.length >= 2) {
                    filterProducts(searchTerm);
                }
            });
            
            productSearch.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const searchTerm = this.value.trim();
                    if (searchTerm.length >= 2) {
                        filterProducts(searchTerm);
                    }
                }
            });
            
            mobileSearch.addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase().trim();
                toggleClearButton(clearMobileSearchBtn, searchTerm);
                
                if (searchTerm === '') {
                    mobileSearchResults.innerHTML = '';
                    return;
                }
                
                if (searchTerm.length >= 2) {
                    filterMobileProducts(searchTerm);
                }
            });
        }
        
        function toggleClearButton(button, searchTerm) {
            button.style.display = searchTerm.length > 0 ? 'block' : 'none';
        }
        
        function openSearchModal() {
            searchModal.style.display = "flex";
            mobileSearch.focus();
            mobileSearchResults.innerHTML = '';
        }
        
        function closeSearchModal() {
            searchModal.style.display = "none";
            mobileSearch.value = '';
            mobileSearchResults.innerHTML = '';
            clearMobileSearchBtn.style.display = 'none';
        }
        
        function clearMobileSearch() {
            mobileSearch.value = '';
            mobileSearchResults.innerHTML = '';
            clearMobileSearchBtn.style.display = 'none';
        }
        
        function filterProducts(searchTerm) {
            if (!products || products.length === 0) return;
            
            isSearching = true;
            const filtered = searchProducts(searchTerm);
            renderFilteredProducts(filtered, searchTerm);
        }
        
        function filterMobileProducts(searchTerm) {
            if (!products || products.length === 0) return;
            
            const filtered = searchProducts(searchTerm);
            
            if (filtered.length === 0) {
                mobileSearchResults.innerHTML = `
                    <div style="text-align: center; padding: 1rem; color: #666;">
                        🔍 No se encontraron productos para "<strong>${searchTerm}</strong>"
                    </div>
                `;
                return;
            }
            
            let resultsHTML = '<div style="display: grid; gap: 1rem;">';
            
            filtered.forEach(product => {
                const stockText = obtenerTextoStock(product);
                
                let stockClass = '';
                if (product.stockNumber === 0) {
                    stockClass = 'out-of-stock';
                } else if (product.stockNumber > 0 && product.stockNumber <= 3) {
                    stockClass = 'low-stock';
                } else {
                    stockClass = 'in-stock';
                }
                
                const addButton = product.stockNumber === 0
                    ? `<button class="add-to-cart" disabled>❌ Sin Stock</button>`
                    : `<button class="add-to-cart" data-id="${product.id}">🛒 Agregar al Carrito</button>`;
                
                const textoCortoOferta = obtenerTextoCortoOferta(product.ofertas1, product.ofertas2);
                const offerBadge = textoCortoOferta 
                    ? `<div class="offer-badge">${textoCortoOferta}</div>`
                    : '';
                
                const descripcionOferta = obtenerDescripcionOferta(product.ofertas1, product.ofertas2, product.price);
                const detalleOferta = product.ofertas1 ? 
                    obtenerDetalleOferta3x2(product.ofertas1, product.price, 1) : '';
                
                const textoLimiteOfertas2 = obtenerTextoLimiteOfertas2(product.ofertas2, product.name);
                
                resultsHTML += `
                    <div class="product-card">
                        ${offerBadge}
                        <div class="product-image">
                            <img src="${product.image}" 
                                 alt="${product.name}"
                                 onerror="handleImageError(this, '${product.name.replace(/'/g, "\\'")}')">
                        </div>
                        <div class="product-info">
                            <div class="product-name">${product.name}</div>
                            ${descripcionOferta ? `<div class="offer-description">${descripcionOferta}</div>` : ''}
                            ${detalleOferta}
                            <div class="product-price-container">
                                ${product.hasPromo && product.discountedPrice < product.price ? 
                                    `<span class="original-price">$${product.price}</span>` : ''}
                                <span class="product-price">$${Math.round(product.discountedPrice)}</span>
                                ${textoCortoOferta ? 
                                    `<span class="discount-percent">${textoCortoOferta.replace('🔥 ', '').replace('🎯 ', '')}</span>` : ''}
                            </div>
                            ${textoLimiteOfertas2 ? `
                                <div class="promo-limit" style="color: #ff6f00; font-weight: 500;">
                                    ${textoLimiteOfertas2}
                                </div>
                            ` : ''}
                            <div class="product-stock ${stockClass}">
                                ${stockText}
                            </div>
                            ${addButton}
                        </div>
                    </div>
                `;
            });
            
            resultsHTML += '</div>';
            mobileSearchResults.innerHTML = resultsHTML;
        }
        
        function renderFilteredProducts(filteredProducts, searchTerm = '') {
            if (filteredProducts.length === 0) {
                productsGrid.innerHTML = `
                    <div class="loading" style="text-align: center; padding: 2rem;">
                        🔍 No se encontraron productos para "<strong>${searchTerm}</strong>"
                        <br><br>
                        <button onclick="clearSearch()" class="retry-btn">
                            ✨ Ver todos los productos
                        </button>
                    </div>
                `;
                return;
            }
            
            renderProductsFromArray(filteredProducts, searchTerm);
        }
        
        function clearSearch() {
            productSearch.value = '';
            mobileSearch.value = '';
            isSearching = false;
            clearSearchBtn.style.display = 'none';
            clearMobileSearchBtn.style.display = 'none';

            currentCategory = "ALMACEN";

            renderProducts();

            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.toggle(
                    'active',
                    btn.getAttribute('data-category') === "ALMACEN"
                );
            });
        }
        
        // ========== SISTEMA PERFECTO DE CATEGORÍAS ==========
        function renderCategories() {
            const categories = [...new Set(products.map(p => p.category))];
            
            const allCategories = ['TODOS', ...categories];
            
            categoriesContainer.innerHTML = allCategories.map(category => {
                const isAll = category === 'TODOS';
                const isActive = (isAll && currentCategory === 'TODOS') || (!isAll && category === currentCategory);
                
                return `
                    <button class="category-btn ${isActive ? 'active' : ''}" 
                            data-category="${category}">
                        ${category}
                    </button>
                `;
            }).join("");
            
            if (categories.length > 0) {
                if (!currentCategory || currentCategory === 'TODOS') {
                    currentCategory = 'TODOS';
                }
                
                document.querySelectorAll('.category-btn').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.getAttribute('data-category') === currentCategory) {
                        btn.classList.add('active');
                    }
                });
            }
            
            document.querySelectorAll(".category-btn").forEach(btn => {
                btn.addEventListener("click", function() {
                    currentCategory = this.getAttribute("data-category");
                    document.querySelectorAll(".category-btn").forEach(b => b.classList.remove("active"));
                    this.classList.add("active");
                    renderProducts();
                });
            });
        }
        
        // ========== MOSTRAR OFERTAS DESTACADAS ==========
        function mostrarOfertasDestacadas() {
            console.log('🔥 OFERTAS DESTACADAS - Sistema jerárquico');
            
            if (!window.productosDestacadosIds) {
                clasificarProductosPorJerarquia();
            }
            
            const productosDestacadas = products.filter(p => 
                window.productosDestacadosIds.includes(p.id)
            );
            
            const ahora = new Date();
            const hora = ahora.getHours();
            const minutos = ahora.getMinutes();
            const horaDecimal = hora + (minutos / 100);
            
            // Destacadas solo Viernes y Sábado 18:00-23:00
            const enDiaDestacadas = JERARQUIA_OFERTAS.destacadas.dias.includes(ahora.getDay());
            const enHorarioDestacadas = horaDecimal >= 18.00 && horaDecimal < 23.00;
            
            if (!enHorarioDestacadas || !enDiaDestacadas) {
                console.log('⏰ Fuera de horario/día de destacadas (Vie-Sáb 18-23hrs)');
                if (featuredOffers) {
                    featuredOffers.style.display = 'none';
                    
                    const existingMsg = document.querySelector('.horario-destacadas');
                    if (!existingMsg && productsGrid) {
                        const mensajeHorario = document.createElement('div');
                        mensajeHorario.className = 'horario-destacadas';
                        mensajeHorario.innerHTML = `
                            <div style="background: #ff9800; color: white; padding: 15px; 
                                border-radius: 10px; text-align: center; margin-bottom: 20px;
                                border-left: 5px solid #ff5722;">
                                <strong>⏰ OFERTAS DESTACADAS</strong><br>
                                <div style="font-size: 0.9rem; margin-top: 5px;">
                                    Disponibles solo <strong>Viernes y Sábado de 18:00 a 23:00 hrs</strong><br>
                                    <small>Descuentos del 15% al 32% OFF</small>
                                </div>
                            </div>
                        `;
                        productsGrid.parentNode.insertBefore(mensajeHorario, productsGrid);
                    }
                }
                return;
            }
            
            if (productosDestacadas.length > 0 && featuredOffers && featuredProductsGrid) {
                featuredOffers.style.display = 'block';
                
                const headerDestacadas = `
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div style="display: inline-flex; align-items: center; gap: 10px; 
                            background: ${JERARQUIA_OFERTAS.destacadas.color}; 
                            color: white; padding: 10px 20px; border-radius: 25px;
                            font-weight: bold; font-size: 1.1rem; box-shadow: 0 4px 12px rgba(255, 152, 0, 0.3);">
                            ${JERARQUIA_OFERTAS.destacadas.icono} 
                            ${JERARQUIA_OFERTAS.destacadas.nombre}
                            <span style="font-size: 0.9rem; opacity: 0.9; margin-left: 8px;">
                                (${productosDestacadas.length} ofertas seleccionadas)
                            </span>
                        </div>
                        <div style="margin-top: 10px; color: #666; font-size: 0.9rem;">
                            ${JERARQUIA_OFERTAS.destacadas.mensaje}
                        </div>
                    </div>
                `;
                
                featuredProductsGrid.innerHTML = headerDestacadas + renderProductsToHTML(productosDestacadas);
                
                console.log('✅ DESTACADAS VISIBLES (Vie-Sáb 18-23hrs)');
                
                const mensajeExistente = document.querySelector('.horario-destacadas');
                if (mensajeExistente) mensajeExistente.remove();
                
            } else {
                if (featuredOffers) featuredOffers.style.display = 'none';
            }
        }
        
        // ========== RENDERIZAR PRODUCTOS CON JERARQUÍA ==========
        function renderProducts() {
            console.log('🔍 renderProducts() - Sistema jerárquico activo');
            
            if (!window.productosRelampagoIds || !window.productosDestacadosIds) {
                clasificarProductosPorJerarquia();
            }
            
            let filteredProducts = [];
            
            if (currentCategory === 'TODOS') {
                filteredProducts = products.filter(p => {
                    const tieneStock = p.stockNumber > 0;
                    
                    if (p.descuentoReal > 0) {
                        const estaEnRelampago = window.productosRelampagoIds.includes(p.id);
                        const estaEnDestacadas = window.productosDestacadosIds.includes(p.id);
                        const estaEnReserva = window.productosReservaIds.includes(p.id);
                        
                        if (!esAdmin && !ADMIN_TOOLS.showHidden) {
                            return false;
                        }
                    }
                    
                    return tieneStock || ADMIN_TOOLS.showHidden;
                });
            } else {
                filteredProducts = products.filter(p => {
                    const enCategoriaCorrecta = p.category === currentCategory;
                    const tieneStock = p.stockNumber > 0;
                    
                    if (p.descuentoReal > 0) {
                        const estaEnRelampago = window.productosRelampagoIds.includes(p.id);
                        const estaEnDestacadas = window.productosDestacadosIds.includes(p.id);
                        const estaEnReserva = window.productosReservaIds.includes(p.id);
                        
                        if (!esAdmin && !ADMIN_TOOLS.showHidden) {
                            return false;
                        }
                    }
                    
                    return enCategoriaCorrecta && (tieneStock || ADMIN_TOOLS.showHidden);
                });
            }
            
            console.log(`📦 Productos en categoría "${currentCategory}": ${filteredProducts.length}`);
            
            if (filteredProducts.length === 0) {
                productsGrid.innerHTML = `
                    <div class="loading" style="text-align: center; padding: 2rem;">
                        🛒 No hay productos disponibles en "${currentCategory}"
                    </div>
                `;
                return;
            }
            
            renderProductsFromArray(filteredProducts);
        }
        
        function renderProductsFromArray(productsArray, searchTerm = '') {
            const productsToShow = productsArray;
            
            if (productsToShow.length === 0) {
                productsGrid.innerHTML = '<div class="loading">No hay productos disponibles</div>';
                return;
            }
            
            productsGrid.innerHTML = productsToShow.map(product => {
                const isOutOfStock = product.stockNumber === 0;
                const stockText = obtenerTextoStock(product);
                
                let stockClass = '';
                if (product.stockNumber === 0) {
                    stockClass = 'out-of-stock';
                } else if (product.stockNumber > 0 && product.stockNumber <= 3) {
                    stockClass = 'low-stock';
                } else {
                    stockClass = 'in-stock';
                }
                
                const addButton = isOutOfStock 
                    ? `<button class="add-to-cart" disabled>❌ Sin Stock</button>`
                    : `<button class="add-to-cart" data-id="${product.id}">🛒 Agregar al Carrito</button>`;
                
                const tieneOfertaPeroOculta = product.descuentoReal > 0;
                const esAdminIndicator = (esAdmin || ADMIN_TOOLS.showHidden) && tieneOfertaPeroOculta;
                
                // Si es admin o showHidden está activado, mostrar ofertas normalmente
                if (esAdmin || ADMIN_TOOLS.showHidden) {
                    const textoCortoOferta = obtenerTextoCortoOferta(product.ofertas1, product.ofertas2);
                    const descripcionOferta = obtenerDescripcionOferta(product.ofertas1, product.ofertas2, product.price);
                    const detalleOferta = product.ofertas1 ? 
                        obtenerDetalleOferta3x2(product.ofertas1, product.price, 1) : '';
                    const textoLimiteOfertas2 = obtenerTextoLimiteOfertas2(product.ofertas2, product.name);
                    
                    return `
                        <div class="product-card ${tieneOfertaPeroOculta ? 'jerarquia-reserva' : ''}">
                            ${textoCortoOferta ? `<div class="offer-badge">${textoCortoOferta}</div>` : ''}
                            <div class="product-image">
                                <img src="${product.image}" 
                                     alt="${product.name}"
                                     onerror="handleImageError(this, '${product.name.replace(/'/g, "\\'")}')">
                            </div>
                            <div class="product-info">
                                <div class="product-name">${product.name}</div>
                                ${descripcionOferta ? `<div class="offer-description">${descripcionOferta}</div>` : ''}
                                ${detalleOferta}
                                <div class="product-price-container">
                                    ${product.discountedPrice < product.price ? 
                                        `<span class="original-price">$${product.price}</span>` : ''}
                                    <span class="product-price">$${Math.round(product.discountedPrice)}</span>
                                    ${textoCortoOferta ? 
                                        `<span class="discount-percent">${textoCortoOferta.replace('🔥 ', '').replace('🎯 ', '')}</span>` : ''}
                                </div>
                                ${textoLimiteOfertas2 ? `
                                    <div class="promo-limit" style="color: #ff6f00; font-weight: 500;">
                                        ${textoLimiteOfertas2}
                                    </div>
                                ` : ''}
                                <div class="product-stock ${stockClass}">
                                    ${stockText}
                                </div>
                                ${addButton}
                                ${esAdminIndicator ? 
                                    `<div style="font-size:0.7rem; color:#666; background:#f3e5f5; padding:4px; margin-top:5px; border-radius:4px; border-left:3px solid #9c27b0;">
                                        ⚠️ Este producto tiene ${product.descuentoReal}% OFF pero está OCULTO para clientes
                                        <div style="font-size:0.6rem; margin-top:2px;">
                                            O1:${product.ofertas1} | O2:${product.ofertas2}
                                        </div>
                                    </div>` 
                                    : ''}
                            </div>
                        </div>
                    `;
                } else {
                    // Para clientes normales, solo mostrar productos sin oferta o con oferta visible
                    return `
                        <div class="product-card">
                            <div class="product-image">
                                <img src="${product.image}" 
                                     alt="${product.name}"
                                     onerror="handleImageError(this, '${product.name.replace(/'/g, "\\'")}')">
                            </div>
                            <div class="product-info">
                                <div class="product-name">${product.name}</div>
                                
                                <div class="product-price-container">
                                    <span class="product-price">$${Math.round(product.price)}</span>
                                </div>
                                
                                <div class="product-stock ${stockClass}">
                                    ${stockText}
                                </div>
                                ${addButton}
                            </div>
                        </div>
                    `;
                }
            }).join("");
            
            if (searchTerm) {
                const searchHeader = `
                    <div class="search-results">
                        <strong>🔍 Búsqueda inteligente: "${searchTerm}"</strong>
                        <br>
                        <small>Encontraste ${productsToShow.length} producto(s)</small>
                        <button onclick="clearSearch()" style="margin-left: 10px; padding: 6px 12px; 
                                background: #ff6f00; color: white; border: none; border-radius: 15px; 
                                cursor: pointer; font-size: 0.8rem;">
                            ✖️ Limpiar búsqueda
                        </button>
                    </div>
                `;
                productsGrid.innerHTML = searchHeader + productsGrid.innerHTML;
            }
        }
        
        function renderProductsToHTML(productsArray) {
            return productsArray.map(product => {
                const isOutOfStock = product.stockNumber === 0;
                const mayorOferta = obtenerMayorOfertaDelDia();
                const esMayorOferta = mayorOferta && mayorOferta.id === product.id;
                const etiquetaOferta = obtenerEtiquetaOfertaDestacada(product.ofertas2);

                const botonCompartir = esMayorOferta ? `
                    <button class="share-offer-btn" onclick="compartirMegaOferta(${product.id})">
                        🤝 Compartir esta OFERTA
                    </button>
                ` : '';
                
                const stockText = obtenerTextoStock(product);
                
                let stockClass = '';
                if (product.stockNumber === 0) {
                    stockClass = 'out-of-stock';
                } else if (product.stockNumber > 0 && product.stockNumber <= 3) {
                    stockClass = 'low-stock';
                } else {
                    stockClass = 'in-stock';
                }
                
                const addButton = isOutOfStock 
                    ? `<button class="add-to-cart" disabled>❌ Sin Stock</button>`
                    : `<button class="add-to-cart" data-id="${product.id}">🛒 Agregar al Carrito</button>`;
                
                if (!product.descuentoReal) {
                    product.descuentoReal = obtenerDescuentoRealProducto(product);
                }
                
                let tipoOfertaTexto = '';
                let tipoOfertaDetalle = '';
                
                if (product.ofertas2 && product.ofertas2 !== '0') {
                    tipoOfertaTexto = `${product.ofertas2}% OFF`;
                    tipoOfertaDetalle = `Descuento directo`;
                } else if (product.ofertas1 && product.ofertas1 !== '0' && OFERTAS_SISTEMA[product.ofertas1]) {
                    const oferta = OFERTAS_SISTEMA[product.ofertas1];
                    tipoOfertaTexto = `${oferta.nombre}`;
                    tipoOfertaDetalle = `${oferta.eslogan} (${product.descuentoReal}% OFF)`;
                }
                
                const textoCortoOferta = obtenerTextoCortoOferta(product.ofertas1, product.ofertas2);
                const offerBadge = textoCortoOferta 
                    ? `<div class="offer-badge">${textoCortoOferta}</div>`
                    : '';
                
                const descripcionOferta = obtenerDescripcionOferta(
                    product.ofertas1, 
                    product.ofertas2,
                    product.price
                );
                
                const detalleOferta = product.ofertas1 ? 
                    obtenerDetalleOferta3x2(product.ofertas1, product.price, 1) : '';
                
                const textoLimiteOfertas2 = obtenerTextoLimiteOfertas2(product.ofertas2, product.name);
                
                return `
                    <div class="product-card jerarquia-destacadas">
                        ${offerBadge}
                        ${esMayorOferta ? `<div class="promo-badge">🔥 MEGA OFERTA</div>` : ''}
                        <div class="product-image">
                            <img src="${product.image}" 
                                 alt="${product.name}"
                                 onerror="handleImageError(this, '${product.name.replace(/'/g, "\\'")}')">
                        </div>
                        <div class="product-info">
                            <div class="product-name">${product.name}</div>
                            ${tipoOfertaTexto ? `
                                <div class="offer-description" style="color: #ff6f00; font-weight: bold; margin: 5px 0;">
                                    🎯 ${tipoOfertaTexto}
                                    ${tipoOfertaDetalle ? `<div style="font-size: 0.8rem; color: #666; margin-top: 2px;">${tipoOfertaDetalle}</div>` : ''}
                                </div>
                            ` : ''}
                            ${descripcionOferta ? `<div class="offer-description">${descripcionOferta}</div>` : ''}
                            ${detalleOferta}
                            ${etiquetaOferta ? `<div class="offer-description" style="color: #d50000; font-weight: bold;">${etiquetaOferta}</div>` : ''}
                            ${esMayorOferta ? `<div class="offer-description" style="color: #d50000; font-weight: bold;">🎯 ¡LA MEJOR OFERTA DEL DÍA!</div>` : ''}
                            <div class="product-price-container">
                                ${product.discountedPrice < product.price ? 
                                    `<span class="original-price">$${product.price}</span>` : ''}
                                <span class="product-price">$${Math.round(product.discountedPrice)}</span>
                                ${textoCortoOferta ? 
                                    `<span class="discount-percent">${textoCortoOferta.replace('🔥 ', '').replace('🎯 ', '')}</span>` : ''}
                            </div>
                            ${textoLimiteOfertas2 ? `
                                <div class="promo-limit" style="color: #ff6f00; font-weight: 500;">
                                    ${textoLimiteOfertas2}
                                </div>
                            ` : ''}
                            <div class="product-stock ${stockClass}">
                                ${stockText}
                            </div>
                            ${addButton}
                            ${botonCompartir}
                            ${esAdmin ? mostrarInfoAdmin(product) : ''}
                        </div>
                    </div>
                `;
            }).join("");
        }
        
        function verTodasLasOfertas() {
            const categoriasConOfertas = [...new Set(products
                .filter(p => p.hasPromo && (p.stock === "STOCK" || p.stockNumber > 0))
                .map(p => p.category)
            )];
            
            if (categoriasConOfertas.length > 0) {
                currentCategory = categoriasConOfertas[0];
                document.querySelectorAll(".category-btn").forEach(b => b.classList.remove("active"));
                const ofertasBtn = document.querySelector(`[data-category="${categoriasConOfertas[0]}"]`);
                if (ofertasBtn) {
                    ofertasBtn.classList.add("active");
                }
                renderProducts();
                
                document.querySelector('.products-grid').scrollIntoView({ behavior: 'smooth' });
            } else {
                alert("No hay ofertas disponibles en este momento");
            }
        }
        
        // ========== SISTEMA DELEGACIÓN DE EVENTOS - REPARADO ==========
        function setupEventDelegation() {
            console.log('🎯 Configurando delegación de eventos...');
            
            // Delegación en el contenedor principal de productos
            document.addEventListener('click', function(e) {
                const addToCartBtn = e.target.closest('.add-to-cart');
                
                if (addToCartBtn && !addToCartBtn.disabled) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const productId = parseInt(addToCartBtn.getAttribute('data-id'));
                    if (productId && !isNaN(productId)) {
                        console.log(`✅ Click detectado en producto ID: ${productId}`);
                        addToCart(productId);
                    }
                }
            });
            
            // También configuramos delegación específica en cada contenedor de productos
            const containers = [
                document.getElementById('productsGrid'),
                document.getElementById('featuredProductsGrid'),
                document.getElementById('flashProductsGrid'),
                document.getElementById('especialesProductsGrid'),
                document.getElementById('mobileSearchResults')
            ];
            
            containers.forEach(container => {
                if (container) {
                    container.addEventListener('click', function(e) {
                        const btn = e.target.closest('.add-to-cart');
                        if (btn && !btn.disabled) {
                            e.preventDefault();
                            e.stopPropagation();
                            const productId = parseInt(btn.getAttribute('data-id'));
                            if (productId) {
                                addToCart(productId);
                            }
                        }
                    });
                }
            });
            
            console.log('✅ Delegación de eventos configurada');
        }
        
        function addToCart(productId) {
            console.log(`🛒 Agregando producto ID: ${productId} al carrito`);
            
            const product = products.find(p => p.id === productId);
            if (!product) {
                console.error(`❌ Producto no encontrado: ${productId}`);
                return;
            }
            
            const availableStock = product.stockNumber;
            const existingItem = cart.find(item => item.id === productId);
            const currentQuantityInCart = existingItem ? existingItem.quantity : 0;
            
            if (currentQuantityInCart >= availableStock) {
                showStockError(product.name, availableStock);
                return;
            }
            
            if (product.ofertas2) {
                const limiteOferta2 = obtenerLimiteOfertas2(product.ofertas2);
                if (limiteOferta2 !== null) {
                    const newQuantity = currentQuantityInCart + 1;
                    if (newQuantity > limiteOferta2) {
                        showLimitError(product.name, limiteOferta2, `${product.ofertas2}% OFF`);
                        return;
                    }
                }
            }
            
            const newQuantity = currentQuantityInCart + 1;
            
            if (existingItem) {
                existingItem.quantity = newQuantity;
                existingItem.price = calcularPrecioConDescuento(
                    product.price, 
                    product.ofertas1, 
                    product.ofertas2, 
                    newQuantity
                );
            } else {
                const initialPrice = calcularPrecioConDescuento(
                    product.price, 
                    product.ofertas1, 
                    product.ofertas2, 
                    1
                );
                
                cart.push({
                    id: product.id,
                    name: product.name,
                    price: initialPrice,
                    originalPrice: product.price,
                    hasPromo: product.hasPromo,
                    ofertas1: product.ofertas1,
                    ofertas2: product.ofertas2,
                    quantity: 1,
                    maxStock: availableStock,
                    maxOferta2Limit: obtenerLimiteOfertas2(product.ofertas2)
                });
                
                if (product.ofertas1 === '1') {
                    showAddToCartFeedback(product.name, 0, "3x2");
                } else {
                    const initialDiscount = calcularDescuentoReal(product.price, initialPrice);
                    showAddToCartFeedback(product.name, initialDiscount);
                }
            }
            
            updateCartCount();
            renderCartItems();
            
            // Feedback visual
            const btn = document.querySelector(`.add-to-cart[data-id="${productId}"]`);
            if (btn) {
                const originalText = btn.innerHTML;
                btn.innerHTML = '✅ Agregado';
                btn.style.background = 'linear-gradient(135deg, #4CAF50, #2e7d32)';
                
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.style.background = 'linear-gradient(135deg, var(--primary), var(--primary-light))';
                }, 1000);
            }
        }
        
        function showAddToCartFeedback(productName, discount = 0, tipoOferta = '') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 100px;
                left: 50%;
                transform: translateX(-50%);
                background: var(--primary);
                color: white;
                padding: 12px 20px;
                border-radius: 25px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                z-index: 1002;
                font-weight: 500;
                animation: slideDown 0.3s ease;
            `;
            
            if (tipoOferta === '3x2') {
                notification.innerHTML = `✅ ${productName} agregado (🎯 3x2 activo)`;
            } else if (discount > 0) {
                notification.innerHTML = `✅ ${productName} agregado (🔥 OFERTA)`;
            } else {
                notification.innerHTML = `✅ ${productName} agregado al carrito`;
            }
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 2000);
        }
        
        function showStockError(productName, availableStock) {
            const notification = document.createElement('div');
            notification.className = 'stock-notification';
            notification.innerHTML = `❌ No hay suficiente stock de ${productName}. Máximo: ${availableStock} unidades`;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
        
        function showLimitError(productName, limite, tipoOferta) {
            const notification = document.createElement('div');
            notification.className = 'limit-notification';
            notification.innerHTML = `⚠️ Límite de ${tipoOferta}: Máximo ${limite} unidades por familia`;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
        
        function updateCartCount() {
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            cartCount.textContent = totalItems;
            floatingCartCount.textContent = totalItems;
        }
        
        function openCart() {
            renderCartItems();
            cartModal.style.display = "flex";
        }
        
        function closeCartModal() {
            cartModal.style.display = "none";
        }
        
        function renderCartItems() {
            if (cart.length === 0) {
                cartItems.innerHTML = "<p style='text-align: center; padding: 2rem; color: #666;'>Tu carrito está vacío</p>";
                cartTotal.textContent = "Total: $0";
                
                const existingSavings = document.querySelector('.total-savings');
                if (existingSavings) existingSavings.remove();
                
                const existingOriginal = document.querySelector('.original-total');
                if (existingOriginal) existingOriginal.remove();
                
                return;
            }
            
            let totalNormalPrice = 0;
            let totalWithPromos = 0;
            
            cartItems.innerHTML = cart.map(item => {
                const product = products.find(p => p.id === item.id);
                if (!product) return '';
                
                const pricePerUnit = calcularPrecioConDescuento(
                    product.price,
                    product.ofertas1,
                    product.ofertas2,
                    item.quantity
                );
                
                const normalPrice = product.price * item.quantity;
                const promoPrice = pricePerUnit * item.quantity;
                
                totalNormalPrice += normalPrice;
                totalWithPromos += promoPrice;
                
                return `
                    <div class="cart-item">
                        <div class="cart-item-info">
                            <div class="cart-item-name">${product.name}</div>
                            <div class="cart-item-price">
                                $${Math.round(pricePerUnit)} c/u
                                ${product.ofertas2 ? `<span style="color:#ff6f00; font-size:0.8em;">(${product.ofertas2}% OFF)</span>` : ''}
                            </div>
                        </div>
                        <div class="cart-item-quantity">
                            <button class="quantity-btn" onclick="updateCartQuantity(${item.id}, ${item.quantity - 1})">-</button>
                            <span class="quantity-value">${item.quantity}</span>
                            <button class="quantity-btn" onclick="updateCartQuantity(${item.id}, ${item.quantity + 1})">+</button>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Calcular y mostrar totales
            const totalSavings = Math.round(totalNormalPrice - totalWithPromos);
            const totalRedondeado = Math.round(totalWithPromos);
            
            cartTotal.textContent = `Total: $${totalRedondeado}`;
            
            // Limpiar elementos anteriores
            const existingSavings = document.querySelector('.total-savings');
            if (existingSavings) existingSavings.remove();
            
            const existingOriginal = document.querySelector('.original-total');
            if (existingOriginal) existingOriginal.remove();
            
            // Agregar ahorro si existe
            if (totalSavings > 0) {
                const savingsElement = document.createElement('div');
                savingsElement.className = 'total-savings';
                savingsElement.innerHTML = `🎉 ¡Ahorraste $${totalSavings}!`;
                cartTotal.parentNode.insertBefore(savingsElement, cartTotal);
            }
        }
        
        function updateCartQuantity(productId, newQuantity) {
            if (newQuantity < 0) return;
            
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            const itemIndex = cart.findIndex(item => item.id === productId);
            if (itemIndex === -1) return;
            
            // Verificar stock máximo
            if (newQuantity > product.stockNumber) {
                showStockError(product.name, product.stockNumber);
                return;
            }
            
            // Verificar límite de oferta2 si aplica
            if (product.ofertas2) {
                const limiteOferta2 = obtenerLimiteOfertas2(product.ofertas2);
                if (limiteOferta2 !== null && newQuantity > limiteOferta2) {
                    showLimitError(product.name, limiteOferta2, `${product.ofertas2}% OFF`);
                    return;
                }
            }
            
            if (newQuantity === 0) {
                // Eliminar del carrito
                cart.splice(itemIndex, 1);
            } else {
                // Actualizar cantidad
                cart[itemIndex].quantity = newQuantity;
                cart[itemIndex].price = calcularPrecioConDescuento(
                    product.price,
                    product.ofertas1,
                    product.ofertas2,
                    newQuantity
                );
            }
            
            updateCartCount();
            renderCartItems();
        }
        
        // ========== INICIALIZACIÓN ==========
        function mostrarOfertasDestacadasForzadas() {
            console.log('🛠️ ADMIN: Mostrando ofertas destacadas forzadas');
            mostrarOfertasDestacadas();
        }
        
        function init() {
            detectarAdmin();
            loadProductsFromAPI();
            setupSearch();
            setupEventDelegation(); // ¡NUEVA LÍNEA CRÍTICA!
            
            // Configurar botón de enviar pedido
            if (sendOrder) {
                sendOrder.addEventListener('click', sendOrderViaWhatsApp);
            }
            
            // Agregar evento para cerrar modal al hacer clic fuera
            window.addEventListener('click', (e) => {
                if (e.target === cartModal) {
                    closeCartModal();
                }
                if (e.target === searchModal) {
                    closeSearchModal();
                }
                if (e.target === adminPanel) {
                    closeAdminPanel();
                }
            });
            
            console.log('🚀 Almacén Copihue inicializado');
        }
        
        // Inicializar cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
