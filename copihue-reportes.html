<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Copihue ¬∑ Reportes</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;700;900&display=swap" rel="stylesheet">
<style>
:root {
    --verde:       #2e7d32;
    --verde-dark:  #1b5e20;
    --verde-deep:  #0a3d0f;
    --verde-light: #e8f5e9;
    --naranja:     #f57c00;
    --naranja-light:#fff3e0;
    --rojo:        #c62828;
    --rojo-light:  #ffebee;
    --azul:        #1565c0;
    --azul-light:  #e3f2fd;
    --gris:        #546e7a;
    --texto:       #1a2e1c;
    --bg:          #f5faf5;
    --blanco:      #ffffff;
    --borde:       #c8e6c9;
}
* { box-sizing:border-box; margin:0; padding:0; -webkit-tap-highlight-color:transparent; }
body { font-family:'DM Sans',sans-serif; background:var(--bg); color:var(--texto); min-height:100dvh; }

/* HEADER */
.header {
    background:linear-gradient(135deg,var(--verde-deep),var(--verde-dark),var(--verde));
    padding:12px 16px; display:flex; align-items:center; gap:12px;
    box-shadow:0 2px 12px rgba(27,94,32,0.4); position:sticky; top:0; z-index:100;
}
.header-icon { font-size:1.6rem; }
.header-titulo { color:white; font-size:1rem; font-weight:900; }
.header-sub { color:rgba(255,255,255,0.7); font-size:0.65rem; letter-spacing:2px; text-transform:uppercase; }
.btn-volver { margin-left:auto; background:rgba(255,255,255,0.15); border:none; color:white; border-radius:20px; padding:6px 14px; font-size:0.78rem; font-weight:700; cursor:pointer; font-family:inherit; text-decoration:none; display:inline-flex; align-items:center; }

/* LOADING */
.loading { text-align:center; padding:60px 20px; color:var(--gris); }
.spinner { width:36px; height:36px; border:3px solid var(--verde-light); border-top-color:var(--verde); border-radius:50%; animation:spin 0.8s linear infinite; margin:0 auto 12px; }
@keyframes spin { to { transform:rotate(360deg); } }

/* LAYOUT */
.seccion { padding:14px 14px 0; }
.seccion-titulo { font-size:0.72rem; font-weight:700; color:var(--gris); text-transform:uppercase; letter-spacing:1.5px; margin-bottom:10px; }

/* MES NAV */
.mes-nav { display:flex; align-items:center; justify-content:space-between; background:white; border-radius:14px; padding:10px 14px; border:1px solid var(--borde); margin-bottom:14px; }
.mes-nombre { font-size:1.1rem; font-weight:900; color:var(--verde-dark); }
.btn-mes { width:32px; height:32px; border:none; border-radius:50%; background:var(--verde-light); color:var(--verde-dark); font-size:1.1rem; cursor:pointer; display:flex; align-items:center; justify-content:center; font-weight:900; }

/* FILTROS */
.filtros-wrap { display:flex; gap:6px; flex-wrap:wrap; margin-bottom:14px; }
.chip { padding:5px 12px; border:2px solid var(--borde); border-radius:20px; background:white; font-size:0.75rem; font-weight:700; cursor:pointer; color:var(--gris); font-family:inherit; transition:all 0.15s; white-space:nowrap; }
.chip.activo { background:var(--verde-dark); border-color:var(--verde-dark); color:white; }
.chip.vendedor.activo { background:var(--azul); border-color:var(--azul); }

/* CALENDARIO */
.calendario { background:white; border-radius:16px; border:1px solid var(--borde); overflow:hidden; margin-bottom:14px; }
.cal-semanas { display:grid; grid-template-columns:repeat(7,1fr); border-bottom:1px solid var(--borde); }
.cal-dia-nombre { text-align:center; padding:6px 2px; font-size:0.65rem; font-weight:700; color:var(--gris); text-transform:uppercase; }
.cal-dias { display:grid; grid-template-columns:repeat(7,1fr); }
.cal-dia { border:1px solid transparent; border-radius:10px; margin:3px; padding:5px 2px; text-align:center; cursor:pointer; transition:all 0.15s; min-height:54px; display:flex; flex-direction:column; align-items:center; gap:1px; }
.cal-dia.vacio { cursor:default; }
.cal-dia.tiene-ventas { background:var(--verde-light); border-color:var(--borde); }
.cal-dia.seleccionado { background:var(--verde-dark) !important; border-color:var(--verde-deep) !important; }
.cal-dia.seleccionado .dia-num { color:white !important; background:transparent !important; }
.cal-dia.seleccionado .dia-monto { color:rgba(255,255,255,0.85) !important; }
.cal-dia.hoy .dia-num { background:var(--naranja); color:white; border-radius:50%; width:22px; height:22px; display:flex; align-items:center; justify-content:center; }
.dia-num { font-size:0.82rem; font-weight:700; color:var(--texto); line-height:1; }
.dia-monto { font-size:0.58rem; font-weight:700; color:var(--verde-dark); line-height:1; }
.dia-ganancia { font-size:0.55rem; font-weight:700; color:var(--naranja); line-height:1; }
.dia-punto { width:5px; height:5px; border-radius:50%; background:var(--naranja); margin-top:1px; }

/* ACCIONES */
.acciones-cal { display:flex; gap:6px; margin-bottom:14px; flex-wrap:wrap; }
.btn-accion { flex:1; min-width:calc(50% - 3px); padding:7px; border:1px solid var(--borde); border-radius:10px; background:white; font-size:0.72rem; font-weight:700; cursor:pointer; color:var(--gris); font-family:inherit; }
.btn-accion:active { background:var(--verde-light); }

/* TARJETAS RESUMEN */
.cards-grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:14px; }
.card { background:white; border-radius:14px; padding:14px; border:1px solid var(--borde); }
.card.verde { background:linear-gradient(135deg,var(--verde-deep),var(--verde)); color:white; border:none; }
.card.naranja { background:linear-gradient(135deg,#e65100,var(--naranja)); color:white; border:none; }
.card.full { grid-column:1/-1; }
.card-label { font-size:0.68rem; opacity:0.8; text-transform:uppercase; letter-spacing:1px; margin-bottom:4px; }
.card-valor { font-size:1.5rem; font-weight:900; line-height:1; }
.card-sub { font-size:0.72rem; opacity:0.75; margin-top:4px; }
.card-label-dark { font-size:0.68rem; color:var(--gris); text-transform:uppercase; letter-spacing:1px; margin-bottom:4px; }
.card-valor-dark { font-size:1.5rem; font-weight:900; color:var(--verde-dark); }

/* TARJETA CONTENIDO */
.tarjeta { background:white; border-radius:14px; border:1px solid var(--borde); padding:14px; margin-bottom:10px; }
.tarjeta-titulo { font-size:0.72rem; font-weight:700; color:var(--gris); text-transform:uppercase; letter-spacing:1px; margin-bottom:10px; }

/* ROWS */
.row { display:flex; justify-content:space-between; align-items:center; padding:7px 0; border-bottom:1px solid #f5f5f5; }
.row:last-child { border-bottom:none; }
.row-label { font-size:0.85rem; color:var(--gris); }
.row-valor { font-weight:900; font-size:0.9rem; }
.row-pct { font-size:0.72rem; color:var(--gris); background:var(--verde-light); padding:2px 6px; border-radius:10px; margin-left:6px; }

/* BARRAS */
.prod-row { margin-bottom:10px; }
.prod-header { display:flex; justify-content:space-between; margin-bottom:3px; }
.prod-nombre { font-size:0.8rem; font-weight:700; color:var(--texto); }
.prod-detalle { font-size:0.75rem; color:var(--gris); }
.barra-bg { background:var(--verde-light); border-radius:20px; height:7px; }
.barra-fill { border-radius:20px; height:7px; transition:width 0.4s; }
.barra-verde { background:linear-gradient(90deg,var(--verde-dark),#66bb6a); }
.barra-ganancia { background:linear-gradient(90deg,#f57c00,#ffd54f); }

/* COMPARAR SEMANAS/MESES */
.comp-row { display:flex; align-items:center; gap:10px; margin-bottom:8px; }
.comp-label { font-size:0.78rem; font-weight:700; color:var(--gris); min-width:50px; }
.comp-barra-bg { flex:1; background:#f5f5f5; border-radius:20px; height:12px; position:relative; overflow:hidden; }
.comp-barra { height:12px; border-radius:20px; }
.comp-valor { font-size:0.78rem; font-weight:700; color:var(--verde-dark); min-width:72px; text-align:right; }

/* VENCIMIENTOS */
.venc-item { display:flex; justify-content:space-between; align-items:center; padding:8px 0; border-bottom:1px solid #f5f5f5; }
.venc-item:last-child { border-bottom:none; }
.venc-nombre { font-size:0.82rem; font-weight:600; flex:1; }
.badge-venc { font-size:0.68rem; font-weight:700; padding:2px 8px; border-radius:20px; white-space:nowrap; }
.badge-vencido { background:var(--rojo-light); color:var(--rojo); }
.badge-critico { background:#fff3e0; color:#e65100; }
.badge-proximo { background:#fff8e1; color:#f57c00; }

/* DETALLE D√çAS */
.dia-detalle { background:white; border-radius:12px; border:1px solid var(--borde); margin-bottom:8px; overflow:hidden; }
.dia-det-header { display:flex; justify-content:space-between; align-items:center; padding:10px 12px; background:var(--verde-light); cursor:pointer; }
.dia-det-fecha { font-weight:700; font-size:0.88rem; }
.dia-det-monto { font-weight:900; color:var(--verde-dark); font-size:0.88rem; }
.dia-det-ganancia { font-size:0.78rem; color:var(--naranja); font-weight:700; }
.dia-det-body { padding:8px 12px; display:none; border-top:1px solid var(--borde); }
.dia-det-body.open { display:block; }
.venta-item { display:flex; justify-content:space-between; padding:4px 0; font-size:0.78rem; border-bottom:1px solid #f9f9f9; color:var(--gris); }
.venta-item:last-child { border-bottom:none; }
.vendedor-tag { font-size:0.65rem; background:var(--azul-light); color:var(--azul); padding:1px 6px; border-radius:10px; font-weight:700; margin-left:4px; }

.empty { text-align:center; padding:30px 20px; color:#bbb; }
.pb { padding-bottom:30px; }
</style>
</head>
<body>

<div class="header">
    <div class="header-icon">üè™</div>
    <div>
        <div class="header-titulo">Copihue</div>
        <div class="header-sub">Reportes</div>
    </div>
    <a href="venta.html" class="btn-volver">‚Üê Volver</a>
</div>

<div id="appContent">
    <div class="loading"><div class="spinner"></div><div>Cargando reportes...</div></div>
</div>

<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbxhKFk2WAi-KRY5xGBsI6_6Pvp3jDjt8mSRXvy7I1WehNmBpJamqK9G9Q1ZJSCSgAdfDA/exec';
const MESES = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
const DIAS_SEM = ['Dom','Lun','Mar','Mi√©','Jue','Vie','S√°b'];

let rawData = null;
let mesActual = new Date().getMonth();
let anioActual = new Date().getFullYear();
let diasSel = new Set();
let metodosActivos = new Set(['TODOS']);
let vendedoresActivos = new Set(['TODOS']);
let tabActiva = 'ventas'; // ventas | ganancia | comparar | venc

async function init() {
    try {
        const r = await fetch(API_URL + '?action=getReportes', { redirect:'follow' });
        const data = await r.json();
        if (data.error) throw new Error(data.error);
        rawData = data;
        diasSel.add(new Date().toISOString().slice(0,10));
        renderApp();
    } catch(e) {
        document.getElementById('appContent').innerHTML =
            '<div class="loading" style="color:var(--rojo);">‚ùå '+e.message+'</div>';
    }
}

// ========== HELPERS ==========
const fmt = n => '$' + Math.round(n).toLocaleString('es-AR');
const fmtPct = n => (n >= 0 ? '+' : '') + Math.round(n) + '%';

function ventasItems() {
    return (rawData.ventas||[]).filter(v => v.tipo === 'item');
}
function ventasTotales() {
    return (rawData.ventas||[]).filter(v => v.tipo === 'total');
}

function getMetodos() {
    const s = new Set();
    ventasTotales().forEach(v => { if(v.metodo) s.add(v.metodo.toUpperCase()); });
    return Array.from(s).sort();
}
function getVendedores() {
    const s = new Set();
    ventasTotales().forEach(v => { if(v.vendedor) s.add(v.vendedor); });
    return Array.from(s).sort();
}

function filtrarPorDias(dias) {
    const set = new Set(dias);
    // Items del per√≠odo
    const items = ventasItems().filter(v => set.has(v.fecha));
    // Totales del per√≠odo
    const tots = ventasTotales().filter(v => set.has(v.fecha));
    // Filtrar por m√©todo
    let ticketsFilt = new Set(tots.map(t => t.fecha+'_'+t.ticket));
    if (!metodosActivos.has('TODOS')) {
        ticketsFilt = new Set(tots
            .filter(t => Array.from(metodosActivos).some(m => (t.metodo||'').toUpperCase().includes(m)))
            .map(t => t.fecha+'_'+t.ticket));
    }
    if (!vendedoresActivos.has('TODOS')) {
        const vend = vendedoresActivos;
        ticketsFilt = new Set([...ticketsFilt].filter(tk => {
            const [f,ti] = tk.split('_');
            const tot = tots.find(t => t.fecha===f && t.ticket===ti);
            return tot && vend.has(tot.vendedor);
        }));
    }
    const itemsFilt = items.filter(v => ticketsFilt.has(v.fecha+'_'+v.ticket));
    const totsFilt  = tots.filter(v => ticketsFilt.has(v.fecha+'_'+v.ticket));
    return { items: itemsFilt, totals: totsFilt };
}

function calcTotales(items, totals) {
    const venta   = totals.reduce((s,t) => s+(t.total||0), 0);
    const ganancia= items.reduce((s,i) => s+(i.ganancia||0), 0);
    const metodos = {};
    const vendedores = {};
    totals.forEach(t => {
        const m = (t.metodo||'EFECTIVO').toUpperCase();
        metodos[m] = (metodos[m]||0) + (t.total||0);
        const v = t.vendedor || 'Sin nombre';
        vendedores[v] = (vendedores[v]||0) + (t.total||0);
    });
    const topProd = {};
    items.forEach(i => {
        const n = i.nombre||'';
        if(!topProd[n]) topProd[n] = {qty:0,total:0,ganancia:0};
        topProd[n].qty      += i.qty||0;
        topProd[n].total    += i.subtotal||0;
        topProd[n].ganancia += i.ganancia||0;
    });
    const top = Object.entries(topProd).sort((a,b)=>b[1].total-a[1].total).slice(0,15)
        .map(([n,d])=>({nombre:n,qty:Math.round(d.qty),total:d.total,ganancia:d.ganancia}));
    return { venta, ganancia, metodos, vendedores, top, nTickets: totals.length };
}

function diasDelMes() {
    return Array.from({length: new Date(anioActual,mesActual+1,0).getDate()}, (_,i)=>{
        return anioActual+'-'+String(mesActual+1).padStart(2,'0')+'-'+String(i+1).padStart(2,'0');
    });
}

// ========== RENDER ==========
function renderApp() {
    const diasSolicitados = Array.from(diasSel);
    const {items, totals} = filtrarPorDias(diasSolicitados);
    const stats = calcTotales(items, totals);
    const hoyStr = new Date().toISOString().slice(0,10);

    // Datos por d√≠a del mes (sin filtro de m√©todo para mostrar en calendario)
    const porDiaMes = {};
    filtrarPorDias(diasDelMes()).items.forEach(v => {
        if(!porDiaMes[v.fecha]) porDiaMes[v.fecha] = {total:0,ganancia:0};
        porDiaMes[v.fecha].total += v.subtotal||0;
        porDiaMes[v.fecha].ganancia += v.ganancia||0;
    });

    // Calendario
    const primerDia = new Date(anioActual,mesActual,1).getDay();
    const diasEnMes = new Date(anioActual,mesActual+1,0).getDate();
    let calHTML = '<div class="cal-semanas">'+DIAS_SEM.map(d=>'<div class="cal-dia-nombre">'+d+'</div>').join('')+'</div><div class="cal-dias">';
    for(let i=0;i<primerDia;i++) calHTML+='<div class="cal-dia vacio"></div>';
    for(let d=1;d<=diasEnMes;d++){
        const ds = anioActual+'-'+String(mesActual+1).padStart(2,'0')+'-'+String(d).padStart(2,'0');
        const info = porDiaMes[ds];
        const sel = diasSel.has(ds), esHoy = ds===hoyStr;
        let cls = 'cal-dia'+(info?' tiene-ventas':'')+(sel?' seleccionado':'')+(esHoy?' hoy':'');
        const monto = info?'<div class="dia-monto">'+fmt(info.total)+'</div>':'';
        const ganHtml = info?'<div class="dia-ganancia">+'+fmt(info.ganancia)+'</div>':'';
        const punto = (info&&!sel)?'<div class="dia-punto"></div>':'';
        calHTML+='<div class="'+cls+'" onclick="toggleDia(\''+ds+'\')"><div class="dia-num">'+d+'</div>'+monto+ganHtml+punto+'</div>';
    }
    calHTML+='</div>';

    // Filtros m√©todo
    const metodos = getMetodos();
    const filtrosMetHTML = '<div class="filtros-wrap">'+
        '<button class="chip'+(metodosActivos.has('TODOS')?' activo':'')+'" onclick="toggleMetodo(\'TODOS\')">üìã Todos</button>'+
        metodos.map(m=>{
            const ic=m.includes('EFECTIVO')?'üíµ':m.includes('TRANSF')?'üì±':m.includes('QR')?'üì≤':m.includes('POSNET')?'üí≥':'üîÄ';
            return '<button class="chip'+(metodosActivos.has(m)?' activo':'')+'" onclick="toggleMetodo(\''+m+'\')">'+ic+' '+m+'</button>';
        }).join('')+'</div>';

    // Filtros vendedor
    const vendedores = getVendedores();
    const filtrosVendHTML = vendedores.length > 1 ?
        '<div class="seccion-titulo">Vendedor</div><div class="filtros-wrap">'+
        '<button class="chip vendedor'+(vendedoresActivos.has('TODOS')?' activo':'')+'" onclick="toggleVendedor(\'TODOS\')">üë• Todos</button>'+
        vendedores.map(v=>'<button class="chip vendedor'+(vendedoresActivos.has(v)?' activo':'')+'" onclick="toggleVendedor(\''+v+'\')">üë§ '+v+'</button>').join('')+
        '</div>' : '';

    // Cards resumen
    const pctGan = stats.venta > 0 ? Math.round(stats.ganancia/stats.venta*100) : 0;
    const cardsHTML =
        '<div class="cards-grid">'+
        '<div class="card verde full">'+
            '<div class="card-label">Ventas per√≠odo</div>'+
            '<div class="card-valor">'+fmt(stats.venta)+'</div>'+
            '<div class="card-sub">'+stats.nTickets+' tickets ¬∑ '+diasSolicitados.length+' d√≠as</div>'+
        '</div>'+
        '<div class="card naranja">'+
            '<div class="card-label">Ganancia</div>'+
            '<div class="card-valor">'+fmt(stats.ganancia)+'</div>'+
            '<div class="card-sub">'+pctGan+'% margen</div>'+
        '</div>'+
        '<div class="card">'+
            '<div class="card-label-dark">Ticket promedio</div>'+
            '<div class="card-valor-dark">'+fmt(stats.nTickets>0?stats.venta/stats.nTickets:0)+'</div>'+
        '</div>'+
        '</div>';

    // M√©todos
    const metodosRows = Object.entries(stats.metodos).sort((a,b)=>b[1]-a[1]).map(([m,t])=>{
        const pct = stats.venta>0?Math.round(t/stats.venta*100):0;
        return '<div class="row"><span class="row-label">'+m+'</span><span><strong class="row-valor">'+fmt(t)+'</strong><span class="row-pct">'+pct+'%</span></span></div>';
    }).join('');

    // Vendedores
    const vendedoresRows = Object.entries(stats.vendedores).sort((a,b)=>b[1]-a[1]).map(([v,t])=>{
        const pct = stats.venta>0?Math.round(t/stats.venta*100):0;
        return '<div class="row"><span class="row-label">üë§ '+v+'</span><span><strong class="row-valor">'+fmt(t)+'</strong><span class="row-pct">'+pct+'%</span></span></div>';
    }).join('');

    // Top productos (por venta)
    const maxVenta = stats.top.length?stats.top[0].total:1;
    const maxGan   = stats.top.length?Math.max(...stats.top.map(p=>p.ganancia)):1;
    const topsHTML = stats.top.length ? stats.top.map((p,i)=>{
        const pct = Math.round(p.total/maxVenta*100);
        const pctG= Math.round(p.ganancia/maxGan*100);
        const medal = i===0?'ü•á':i===1?'ü•à':i===2?'ü•â':'';
        return '<div class="prod-row">'+
            '<div class="prod-header">'+
                '<span class="prod-nombre">'+medal+' '+p.nombre.substring(0,30)+'</span>'+
                '<span class="prod-detalle">'+p.qty+' u</span>'+
            '</div>'+
            '<div style="display:flex;gap:4px;align-items:center;margin-bottom:2px;">'+
                '<div class="barra-bg" style="flex:1"><div class="barra-fill barra-verde" style="width:'+pct+'%"></div></div>'+
                '<span style="font-size:0.72rem;font-weight:700;color:var(--verde-dark);min-width:68px;text-align:right;">'+fmt(p.total)+'</span>'+
            '</div>'+
            '<div style="display:flex;gap:4px;align-items:center;">'+
                '<div class="barra-bg" style="flex:1"><div class="barra-fill barra-ganancia" style="width:'+pctG+'%"></div></div>'+
                '<span style="font-size:0.68rem;font-weight:700;color:var(--naranja);min-width:68px;text-align:right;">+'+fmt(p.ganancia)+'</span>'+
            '</div>'+
        '</div>';
    }).join('') : '<div class="empty">Sin ventas en la selecci√≥n</div>';

    // Comparar meses
    const ventasPorMes = {};
    ventasTotales().forEach(t=>{
        const m = t.fecha?t.fecha.slice(0,7):'';
        if(m) ventasPorMes[m]=(ventasPorMes[m]||0)+(t.total||0);
    });
    const ganPorMes = {};
    ventasItems().forEach(i=>{
        const m = i.fecha?i.fecha.slice(0,7):'';
        if(m) ganPorMes[m]=(ganPorMes[m]||0)+(i.ganancia||0);
    });
    const ultMeses = Object.keys(ventasPorMes).sort().slice(-6);
    const maxMesV = Math.max(...ultMeses.map(m=>ventasPorMes[m]||0),1);
    const maxMesG = Math.max(...ultMeses.map(m=>ganPorMes[m]||0),1);
    const compMesesHTML = ultMeses.reverse().map(m=>{
        const [a,mo] = m.split('-');
        const label = MESES[parseInt(mo)-1].substring(0,3)+' '+a.slice(2);
        const pctV = Math.round((ventasPorMes[m]||0)/maxMesV*100);
        const pctG = Math.round((ganPorMes[m]||0)/maxMesG*100);
        return '<div class="comp-row">'+
            '<span class="comp-label">'+label+'</span>'+
            '<div style="flex:1;display:flex;flex-direction:column;gap:3px;">'+
                '<div class="comp-barra-bg"><div class="comp-barra barra-verde" style="width:'+pctV+'%"></div></div>'+
                '<div class="comp-barra-bg"><div class="comp-barra barra-ganancia" style="width:'+pctG+'%"></div></div>'+
            '</div>'+
            '<div style="min-width:80px;text-align:right;">'+
                '<div style="font-size:0.72rem;font-weight:700;color:var(--verde-dark);">'+fmt(ventasPorMes[m]||0)+'</div>'+
                '<div style="font-size:0.65rem;color:var(--naranja);">+'+fmt(ganPorMes[m]||0)+'</div>'+
            '</div>'+
        '</div>';
    }).join('');

    // Comparar semanas del mes
    const ventasPorSemana = {};
    filtrarPorDias(diasDelMes()).totals.forEach(t=>{
        if(!t.fecha) return;
        const d = new Date(t.fecha+'T12:00:00');
        const sem = 'S'+(Math.ceil(d.getDate()/7));
        ventasPorSemana[sem]=(ventasPorSemana[sem]||0)+(t.total||0);
    });
    const ganPorSemana = {};
    filtrarPorDias(diasDelMes()).items.forEach(i=>{
        if(!i.fecha) return;
        const d = new Date(i.fecha+'T12:00:00');
        const sem = 'S'+(Math.ceil(d.getDate()/7));
        ganPorSemana[sem]=(ganPorSemana[sem]||0)+(i.ganancia||0);
    });
    const sems = ['S1','S2','S3','S4','S5'].filter(s=>ventasPorSemana[s]||ganPorSemana[s]);
    const maxSemV = Math.max(...sems.map(s=>ventasPorSemana[s]||0),1);
    const compSemsHTML = sems.map(s=>{
        const pctV = Math.round((ventasPorSemana[s]||0)/maxSemV*100);
        return '<div class="comp-row">'+
            '<span class="comp-label">'+s+'</span>'+
            '<div class="comp-barra-bg" style="flex:1"><div class="comp-barra barra-verde" style="width:'+pctV+'%"></div></div>'+
            '<div style="min-width:75px;text-align:right;">'+
                '<div style="font-size:0.72rem;font-weight:700;color:var(--verde-dark);">'+fmt(ventasPorSemana[s]||0)+'</div>'+
                '<div style="font-size:0.65rem;color:var(--naranja);">+'+fmt(ganPorSemana[s]||0)+'</div>'+
            '</div>'+
        '</div>';
    }).join('');

    // Vencimientos
    const venc = (rawData.vencProximos||[]);
    const vencHTML = venc.length ? venc.map(v=>{
        let cls='badge-proximo', label=v.dias+' d√≠as';
        if(v.vencido){cls='badge-vencido';label='VENCIDO';}
        else if(v.dias<=7){cls='badge-critico';label=v.dias+' d√≠as';}
        return '<div class="venc-item">'+
            '<div>'+
                '<div class="venc-nombre">'+v.nombre.substring(0,32)+'</div>'+
                '<div style="font-size:0.72rem;color:var(--gris);">Stock: '+v.stock+' ¬∑ '+v.fecha+'</div>'+
            '</div>'+
            '<span class="badge-venc '+cls+'">'+label+'</span>'+
        '</div>';
    }).join('') : '<div class="empty">‚úÖ Sin vencimientos pr√≥ximos</div>';

    // Detalle por d√≠a seleccionado
    const diasOrd = Array.from(diasSel).sort();
    const detalleHTML = diasOrd.map(ds=>{
        const vDia = filtrarPorDias([ds]);
        const totDia = vDia.totals.reduce((s,t)=>s+(t.total||0),0);
        const ganDia = vDia.items.reduce((s,i)=>s+(i.ganancia||0),0);
        const [a,m,d] = ds.split('-');
        const fechaLabel = parseInt(d)+' de '+MESES[parseInt(m)-1];
        const itemsHTML = vDia.totals.length ?
            vDia.totals.map(t=>{
                const prods = vDia.items.filter(i=>i.ticket===t.ticket&&i.fecha===t.fecha);
                return '<div style="background:#f9f9f9;border-radius:8px;padding:8px;margin-bottom:6px;">'+
                    '<div style="display:flex;justify-content:space-between;margin-bottom:4px;">'+
                        '<span style="font-size:0.72rem;font-weight:700;color:var(--gris);">üé´ Ticket '+t.ticket+'</span>'+
                        '<span style="font-size:0.72rem;">'+t.hora+' <span class="vendedor-tag">'+t.vendedor+'</span></span>'+
                    '</div>'+
                    prods.map(p=>'<div class="venta-item"><span>'+p.qty+'√ó '+p.nombre.substring(0,25)+'</span><span>'+fmt(p.subtotal)+'</span></div>').join('')+
                    '<div style="display:flex;justify-content:space-between;padding-top:4px;font-size:0.8rem;">'+
                        '<span style="color:var(--gris);">'+t.metodo+'</span>'+
                        '<strong>'+fmt(t.total)+'</strong>'+
                    '</div>'+
                '</div>';
            }).join('') :
            '<div style="font-size:0.8rem;color:#bbb;padding:6px 0;">Sin ventas este d√≠a</div>';
        return '<div class="dia-detalle">'+
            '<div class="dia-det-header" onclick="toggleDetalle(this)">'+
                '<span class="dia-det-fecha">üìÖ '+fechaLabel+'</span>'+
                '<div style="text-align:right;">'+
                    '<div class="dia-det-monto">'+fmt(totDia)+'</div>'+
                    '<div class="dia-det-ganancia">+'+fmt(ganDia)+'</div>'+
                '</div>'+
            '</div>'+
            '<div class="dia-det-body">'+itemsHTML+'</div>'+
        '</div>';
    }).join('');

    document.getElementById('appContent').innerHTML =
        '<div class="seccion">'+
            // Nav mes
            '<div class="mes-nav"><button class="btn-mes" onclick="cambiarMes(-1)">‚Äπ</button><span class="mes-nombre">'+MESES[mesActual]+' '+anioActual+'</span><button class="btn-mes" onclick="cambiarMes(1)">‚Ä∫</button></div>'+
            // Filtros
            '<div class="seccion-titulo">M√©todo de pago</div>'+filtrosMetHTML+
            filtrosVendHTML+
            // Calendario
            '<div class="seccion-titulo">Seleccion√° los d√≠as</div>'+
            '<div class="calendario">'+calHTML+'</div>'+
            // Acciones
            '<div class="acciones-cal">'+
                '<button class="btn-accion" onclick="selTodo()">‚úÖ Todo el mes</button>'+
                '<button class="btn-accion" onclick="deselTodo()">‚¨ú Ninguno</button>'+
                '<button class="btn-accion" onclick="selSemana()">üìÖ Esta semana</button>'+
                '<button class="btn-accion" onclick="selHoy()">üìç Hoy</button>'+
            '</div>'+
            // Cards resumen
            cardsHTML+
            // M√©todos breakdown
            (Object.keys(stats.metodos).length?'<div class="tarjeta"><div class="tarjeta-titulo">üí≥ Por m√©todo de pago</div>'+metodosRows+'</div>':'')+
            // Vendedores
            (Object.keys(stats.vendedores).length>1?'<div class="tarjeta"><div class="tarjeta-titulo">üë• Por vendedor</div>'+vendedoresRows+'</div>':'')+
            // Top productos
            '<div class="tarjeta"><div class="tarjeta-titulo">üèÜ Top productos ‚Äî üü© Venta ¬∑ üüß Ganancia</div>'+topsHTML+'</div>'+
            // Comparar
            (compMesesHTML?'<div class="tarjeta"><div class="tarjeta-titulo">üìÖ √öltimos 6 meses</div>'+compMesesHTML+'</div>':'')+
            (compSemsHTML?'<div class="tarjeta"><div class="tarjeta-titulo">üìä Semanas de '+MESES[mesActual]+'</div>'+compSemsHTML+'</div>':'')+
            // Vencimientos
            '<div class="tarjeta"><div class="tarjeta-titulo">‚è∞ Vencimientos pr√≥ximos (30 d√≠as)</div>'+vencHTML+'</div>'+
            // Detalle d√≠as
            (diasOrd.length?'<div class="seccion-titulo" style="margin-top:4px;">üìã Detalle por d√≠a</div>'+detalleHTML:'')+
        '</div><div class="pb"></div>';
}

// ========== INTERACCIONES ==========
function toggleDia(ds){diasSel.has(ds)?diasSel.delete(ds):diasSel.add(ds);renderApp();}
function toggleMetodo(m){
    if(m==='TODOS'){metodosActivos.clear();metodosActivos.add('TODOS');}
    else{metodosActivos.delete('TODOS');metodosActivos.has(m)?metodosActivos.delete(m):metodosActivos.add(m);if(!metodosActivos.size)metodosActivos.add('TODOS');}
    renderApp();
}
function toggleVendedor(v){
    if(v==='TODOS'){vendedoresActivos.clear();vendedoresActivos.add('TODOS');}
    else{vendedoresActivos.delete('TODOS');vendedoresActivos.has(v)?vendedoresActivos.delete(v):vendedoresActivos.add(v);if(!vendedoresActivos.size)vendedoresActivos.add('TODOS');}
    renderApp();
}
function cambiarMes(d){
    mesActual+=d;
    if(mesActual<0){mesActual=11;anioActual--;}
    if(mesActual>11){mesActual=0;anioActual++;}
    diasSel.clear();renderApp();
}
function selTodo(){const n=new Date(anioActual,mesActual+1,0).getDate();for(let d=1;d<=n;d++)diasSel.add(anioActual+'-'+String(mesActual+1).padStart(2,'0')+'-'+String(d).padStart(2,'0'));renderApp();}
function deselTodo(){diasSel.clear();renderApp();}
function selHoy(){diasSel.clear();diasSel.add(new Date().toISOString().slice(0,10));renderApp();}
function selSemana(){
    diasSel.clear();const hoy=new Date(),ds=hoy.getDay();
    for(let i=0;i<7;i++){const d=new Date(hoy);d.setDate(hoy.getDate()-ds+i);diasSel.add(d.toISOString().slice(0,10));}
    renderApp();
}
function toggleDetalle(h){h.nextElementSibling.classList.toggle('open');}

init();
</script>
</body>
</html>
