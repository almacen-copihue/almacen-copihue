// ========== PWA - SOLUCI√ìN DEFINITIVA ==========
let deferredPrompt;
const installPrompt = document.getElementById('installPrompt');

// 1. CREAR MANIFEST EST√ÅTICO SIMPLE
function createStaticManifest() {
    // En lugar de crear un manifest din√°mico, vamos a crear uno simple en el HTML
    const manifestLink = document.getElementById('appManifest');
    
    // Si el manifest ya existe en el HTML, eliminarlo
    if (manifestLink) {
        manifestLink.remove();
    }
    
    // Crear un nuevo manifest link con datos base64
    const newManifestLink = document.createElement('link');
    newManifestLink.id = 'appManifest';
    newManifestLink.rel = 'manifest';
    
    // Datos del manifest en base64
    const manifestData = {
        "name": "Almac√©n Copihue",
        "short_name": "Almac√©n",
        "description": "Tu almac√©n de barrio",
        "start_url": ".",
        "display": "standalone",
        "background_color": "#2e7d32",
        "theme_color": "#2e7d32",
        "icons": [
            {
                "src": "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjE5MiIgaGVpZ2h0PSIxOTIiIGZpbGw9IiMyRTdEMzIiLz48dGV4dCB4PSI1MCUiIHk9IjUwJSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjQ4IiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZG9taW5hbnQtYmFzZWxpbmU9Im1pZGRsZSI+QUM8L3RleHQ+PC9zdmc+",
                "sizes": "192x192",
                "type": "image/svg+xml"
            }
        ],
        "orientation": "portrait",
        "scope": "."
    };
    
    // Crear blob y URL
    const blob = new Blob([JSON.stringify(manifestData)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    newManifestLink.href = url;
    
    // Agregar al head
    document.head.appendChild(newManifestLink);
    
    console.log('‚úÖ Manifest est√°tico creado');
    return url;
}

// 2. SERVICE WORKER M√çNIMO Y FUNCIONAL
function registerServiceWorker() {
    if ('serviceWorker' in navigator) {
        console.log('üîß Registrando Service Worker...');
        
        // Service Worker EXTREMADAMENTE simple
        const swCode = `
            self.addEventListener('install', function(e) {
                console.log('[SW] Instalado');
                self.skipWaiting();
            });
            
            self.addEventListener('activate', function(e) {
                console.log('[SW] Activado');
                return self.clients.claim();
            });
            
            // Solo para cumplir con PWA, no manejamos cach√©
            self.addEventListener('fetch', function(e) {
                // Dejar pasar todas las peticiones
            });
        `;
        
        try {
            // Crear blob para el SW
            const blob = new Blob([swCode], { type: 'application/javascript' });
            const swUrl = URL.createObjectURL(blob);
            
            // Registrar el SW
            navigator.serviceWorker.register(swUrl, {
                scope: './'
            })
            .then(function(registration) {
                console.log('‚úÖ SW registrado exitosamente en:', registration.scope);
                
                // Verificar estado
                if (registration.installing) {
                    console.log('üîÑ SW instalando...');
                    registration.installing.addEventListener('statechange', function(e) {
                        console.log('üìä Estado SW:', e.target.state);
                    });
                }
                
                if (registration.active) {
                    console.log('‚úÖ SW activo');
                }
                
                if (registration.waiting) {
                    console.log('‚è≥ SW esperando');
                }
            })
            .catch(function(error) {
                console.error('‚ùå Error registrando SW:', error);
                
                // Intentar sin scope
                const swUrl2 = URL.createObjectURL(new Blob([`
                    self.addEventListener('install', (e) => self.skipWaiting());
                    self.addEventListener('activate', (e) => self.clients.claim());
                `], { type: 'application/javascript' }));
                
                navigator.serviceWorker.register(swUrl2)
                    .then(r => console.log('‚úÖ SW alternativo registrado'))
                    .catch(e => console.error('‚ùå SW alternativo tambi√©n fall√≥:', e));
            });
            
        } catch (error) {
            console.error('‚ùå Error creando SW:', error);
        }
    } else {
        console.log('‚ö†Ô∏è Service Worker no soportado');
    }
}

// 3. DETECTAR Y MANEJAR INSTALACI√ìN
window.addEventListener('beforeinstallprompt', function(e) {
    console.log('üéØ Evento beforeinstallprompt detectado');
    
    // Prevenir que Chrome muestre el banner autom√°tico
    e.preventDefault();
    
    // Guardar el evento para usarlo m√°s tarde
    deferredPrompt = e;
    
    // Solo mostrar en dispositivos m√≥viles
    const isMobile = /Android|iPhone|iPad|iPod|Mobile/i.test(navigator.userAgent);
    
    if (isMobile) {
        console.log('üì± Dispositivo m√≥vil detectado');
        
        // Mostrar bot√≥n despu√©s de 3 segundos
        setTimeout(function() {
            if (deferredPrompt && !isPWAInstalled()) {
                console.log('üîÑ Mostrando bot√≥n de instalaci√≥n');
                showInstallButton();
            }
        }, 3000);
    }
});

// Funci√≥n para mostrar el bot√≥n de instalaci√≥n
function showInstallButton() {
    if (installPrompt) {
        installPrompt.style.display = 'flex';
        installPrompt.style.animation = 'slideUp 0.3s ease';
        
        console.log('‚úÖ Bot√≥n de instalaci√≥n visible');
        
        // Ocultar despu√©s de 20 segundos si no se usa
        setTimeout(function() {
            if (installPrompt && installPrompt.style.display !== 'none') {
                installPrompt.style.display = 'none';
                console.log('‚è∞ Bot√≥n ocultado por timeout');
            }
        }, 20000);
    }
}

// Verificar si la PWA ya est√° instalada
function isPWAInstalled() {
    // M√©todo 1: Para navegadores que soportan display-mode
    if (window.matchMedia('(display-mode: standalone)').matches) {
        console.log('üè† PWA instalada (standalone mode)');
        return true;
    }
    
    // M√©todo 2: Para iOS
    if (window.navigator.standalone === true) {
        console.log('üçé PWA instalada en iOS');
        return true;
    }
    
    // M√©todo 3: Verificar si est√° en pantalla completa
    if (document.fullscreenElement || 
        document.webkitFullscreenElement || 
        document.mozFullScreenElement) {
        console.log('üì± PWA en modo pantalla completa');
        return true;
    }
    
    return false;
}

// Evento click en el bot√≥n de instalaci√≥n
if (installPrompt) {
    installPrompt.addEventListener('click', async function() {
        console.log('üñ±Ô∏è Bot√≥n de instalaci√≥n clickeado');
        
        if (!deferredPrompt) {
            console.log('‚ö†Ô∏è No hay prompt disponible');
            
            // Si es iOS, mostrar instrucciones
            if (/iPhone|iPad|iPod/.test(navigator.userAgent)) {
                showIOSInstructions();
                return;
            }
            
            // Intentar recargar para activar el prompt
            console.log('üîÑ Recargando para activar prompt...');
            location.reload();
            return;
        }
        
        try {
            // Mostrar el prompt de instalaci√≥n
            console.log('üì± Mostrando di√°logo de instalaci√≥n...');
            deferredPrompt.prompt();
            
            // Esperar la respuesta del usuario
            const choiceResult = await deferredPrompt.userChoice;
            
            console.log(`üìä Resultado: ${choiceResult.outcome}`);
            
            // Limpiar el prompt
            deferredPrompt = null;
            
            // Ocultar el bot√≥n
            if (installPrompt) {
                installPrompt.style.display = 'none';
            }
            
            if (choiceResult.outcome === 'accepted') {
                console.log('üéâ ¬°Usuario acept√≥ la instalaci√≥n!');
                showSuccessMessage('¬°App instalada exitosamente!');
            }
            
        } catch (error) {
            console.error('‚ùå Error en la instalaci√≥n:', error);
            showSuccessMessage('Error en la instalaci√≥n. Intenta nuevamente.');
        }
    });
}

// Mostrar instrucciones para iOS
function showIOSInstructions() {
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.9);
        z-index: 10000;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
    `;
    
    modal.innerHTML = `
        <div style="background: white; border-radius: 15px; padding: 30px; max-width: 400px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
            <h2 style="color: #2e7d32; margin-bottom: 20px;">üì± Instalar en iPhone/iPad</h2>
            <div style="text-align: left; margin: 20px 0; font-size: 16px;">
                <p>1. Toca el bot√≥n <strong style="color: #2e7d32;">Compartir</strong> <span style="font-size: 20px;">üì§</span></p>
                <p>2. Despl√°zate hacia abajo</p>
                <p>3. Selecciona <strong style="color: #2e7d32;">"Agregar a Inicio"</strong></p>
                <p>4. Toca <strong style="color: #2e7d32;">"Agregar"</strong></p>
            </div>
            <button onclick="this.closest('div[style*=\"background: white\"]').parentElement.remove()" 
                    style="background: #2e7d32; color: white; border: none; padding: 12px 30px; 
                           border-radius: 25px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px;">
                Entendido
            </button>
        </div>
    `;
    
    document.body.appendChild(modal);
}

// Mostrar mensaje de √©xito
function showSuccessMessage(message) {
    const msg = document.createElement('div');
    msg.style.cssText = `
        position: fixed;
        top: 100px;
        left: 50%;
        transform: translateX(-50%);
        background: #4CAF50;
        color: white;
        padding: 15px 25px;
        border-radius: 25px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        z-index: 9999;
        font-weight: bold;
        text-align: center;
        animation: fadeInOut 3s ease;
    `;
    
    // Agregar animaci√≥n si no existe
    if (!document.querySelector('style#fadeAnimation')) {
        const style = document.createElement('style');
        style.id = 'fadeAnimation';
        style.textContent = `
            @keyframes fadeInOut {
                0% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
                15% { opacity: 1; transform: translateX(-50%) translateY(0); }
                85% { opacity: 1; transform: translateX(-50%) translateY(0); }
                100% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
            }
        `;
        document.head.appendChild(style);
    }
    
    msg.textContent = message;
    document.body.appendChild(msg);
    
    // Auto-eliminar despu√©s de 3 segundos
    setTimeout(() => {
        if (msg.parentNode) {
            msg.parentNode.removeChild(msg);
        }
    }, 3000);
}

// 4. INICIALIZACI√ìN SIMPLIFICADA
function initPWA() {
    console.log('üöÄ Iniciando sistema PWA...');
    console.log('üìä Navegador:', navigator.userAgent);
    console.log('üîó Protocolo:', window.location.protocol);
    console.log('üìç URL:', window.location.href);
    
    // Solo inicializar PWA si estamos en HTTPS o localhost
    const isSecure = window.location.protocol === 'https:' || 
                     window.location.hostname === 'localhost' || 
                     window.location.hostname === '127.0.0.1';
    
    if (!isSecure) {
        console.warn('‚ö†Ô∏è PWA funciona mejor con HTTPS');
        // A√∫n as√≠ intentamos, pero con advertencia
    }
    
    // 1. Crear manifest est√°tico
    createStaticManifest();
    
    // 2. Registrar Service Worker (con retraso para asegurar que el DOM est√© listo)
    setTimeout(registerServiceWorker, 1000);
    
    // 3. Verificar si ya est√° instalada
    setTimeout(() => {
        if (isPWAInstalled()) {
            console.log('‚úÖ PWA ya est√° instalada, ocultando bot√≥n');
            if (installPrompt) {
                installPrompt.style.display = 'none';
            }
        } else {
            console.log('üì± PWA no instalada a√∫n');
            
            // Si es m√≥vil y no hay prompt despu√©s de 5 segundos, mostrar bot√≥n
            const isMobile = /Android|iPhone|iPad|iPod|Mobile/i.test(navigator.userAgent);
            if (isMobile) {
                setTimeout(() => {
                    if (!deferredPrompt && installPrompt) {
                        console.log('üîÑ Mostrando bot√≥n de instalaci√≥n (fallback)');
                        showInstallButton();
                    }
                }, 5000);
            }
        }
    }, 2000);
}

// 5. AGREGAR A TU FUNCI√ìN init() EXISTENTE
// Busca tu funci√≥n init() y a√±ade initPWA() al final:

function init() {
    detectarAdmin();
    loadProductsFromSheets();
    setupEventListeners();
    setupSearch();
    updateCartCount();
    
    // INICIAR PWA - A√ëADIR ESTA L√çNEA
    initPWA();
}

// 6. ESCUCHAR EVENTOS IMPORTANTES
window.addEventListener('load', function() {
    console.log('üìÑ P√°gina completamente cargada');
    
    // Verificar instalaci√≥n despu√©s de que todo cargue
    setTimeout(() => {
        if (isPWAInstalled() && installPrompt) {
            installPrompt.style.display = 'none';
        }
    }, 3000);
});

// Detectar cuando se instala la app
window.addEventListener('appinstalled', function() {
    console.log('üéâ ¬°PWA instalada exitosamente!');
    
    if (installPrompt) {
        installPrompt.style.display = 'none';
    }
    
    deferredPrompt = null;
    
    // Mostrar mensaje de √©xito
    showSuccessMessage('¬°App instalada correctamente!');
});
