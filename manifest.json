// ========== PWA - INSTALACI√ìN EN M√ìVILES ==========
let deferredPrompt;
const installPrompt = document.getElementById('installPrompt');

// 1. CREAR MANIFEST DIN√ÅMICAMENTE CORREGIDO
function createDynamicManifest() {
    const manifest = {
        "name": "Almac√©n Copihue",
        "short_name": "Almac√©n Copihue",
        "description": "Tu almac√©n de barrio - Productos de calidad con la confianza de siempre",
        "start_url": window.location.href,
        "display": "standalone",
        "background_color": "#2e7d32",
        "theme_color": "#2e7d32",
        "icons": [
            {
                "src": "https://via.placeholder.com/192x192/2e7d32/ffffff?text=AC",
                "sizes": "192x192",
                "type": "image/png"
            },
            {
                "src": "https://via.placeholder.com/512x512/2e7d32/ffffff?text=AC",
                "sizes": "512x512",
                "type": "image/png"
            }
        ],
        "orientation": "portrait",
        "scope": window.location.origin + "/"
    };
    
    // Crear el JSON correctamente
    const manifestJSON = JSON.stringify(manifest, null, 2);
    console.log('üì± Manifest JSON creado:', manifestJSON);
    
    // Crear Blob URL
    const manifestBlob = new Blob([manifestJSON], { 
        type: 'application/manifest+json; charset=utf-8' 
    });
    const manifestURL = URL.createObjectURL(manifestBlob);
    
    // Actualizar el link del manifest
    const manifestLink = document.getElementById('appManifest');
    manifestLink.href = manifestURL;
    
    console.log('‚úÖ Manifest PWA creado y configurado');
    return manifestURL;
}

// 2. REGISTRAR SERVICE WORKER CORREGIDO
function registerServiceWorker() {
    if ('serviceWorker' in navigator) {
        console.log('üîç Intentando registrar Service Worker...');
        
        // SW m√°s simple y robusto
        const swContent = `
            // Cache Name
            const CACHE_NAME = 'almacen-copihue-v1.0.0';
            
            // Instalar Service Worker
            self.addEventListener('install', (event) => {
                console.log('üîÑ Service Worker instalando...');
                self.skipWaiting();
            });
            
            // Activar Service Worker
            self.addEventListener('activate', (event) => {
                console.log('‚úÖ Service Worker activado');
                event.waitUntil(self.clients.claim());
            });
            
            // Interceptar peticiones
            self.addEventListener('fetch', (event) => {
                // Dejar pasar todas las peticiones
                return;
            });
        `;
        
        // Crear URL para el SW
        const blob = new Blob([swContent], { type: 'application/javascript' });
        const swURL = URL.createObjectURL(blob);
        
        // Registrar el SW
        navigator.serviceWorker.register(swURL, { 
            scope: './',
            updateViaCache: 'none' 
        })
        .then(registration => {
            console.log('‚úÖ Service Worker registrado exitosamente');
            console.log('üìå Scope:', registration.scope);
            console.log('üìå Estado:', registration.active ? 'Activo' : 'Inactivo');
            
            // Verificar si hay errores de instalaci√≥n
            if (registration.installing) {
                registration.installing.addEventListener('statechange', (e) => {
                    console.log('üìå Estado del SW:', e.target.state);
                });
            }
        })
        .catch(error => {
            console.error('‚ùå Error registrando Service Worker:', error);
            console.error('üìå Detalles del error:', error.message);
            
            // Intentar con un SW a√∫n m√°s simple
            registerFallbackServiceWorker();
        });
    } else {
        console.log('‚ö†Ô∏è Service Worker no soportado en este navegador');
    }
}

// SW de respaldo extremadamente simple
function registerFallbackServiceWorker() {
    console.log('üîÑ Intentando SW de respaldo...');
    
    const fallbackSW = `
        self.addEventListener('install', (event) => {
            console.log('‚úÖ SW de respaldo instalado');
            self.skipWaiting();
        });
        
        self.addEventListener('activate', (event) => {
            console.log('‚úÖ SW de respaldo activado');
        });
    `;
    
    try {
        const blob = new Blob([fallbackSW], { type: 'application/javascript' });
        const swURL = URL.createObjectURL(blob);
        
        navigator.serviceWorker.register(swURL)
            .then(reg => {
                console.log('‚úÖ SW de respaldo registrado');
                console.log('üìå Scope:', reg.scope);
            })
            .catch(err => {
                console.error('‚ùå Fall√≥ SW de respaldo:', err);
                console.log('‚ö†Ô∏è PWA funcionar√° sin Service Worker');
            });
    } catch (e) {
        console.error('‚ùå Error creando SW de respaldo:', e);
    }
}

// 3. MANEJAR INSTALACI√ìN PWA - VERSI√ìN SIMPLIFICADA
window.addEventListener('beforeinstallprompt', (e) => {
    console.log('üì± beforeinstallprompt disparado - M√≥vil detectado');
    
    // Prevenir que el banner aparezca autom√°ticamente
    e.preventDefault();
    
    // Guardar el evento para usarlo m√°s tarde
    deferredPrompt = e;
    
    // Mostrar bot√≥n de instalaci√≥n SOLO en m√≥viles
    if (/Android|iPhone|iPad|iPod|Mobile/i.test(navigator.userAgent)) {
        console.log('üì± Dispositivo m√≥vil confirmado - Preparando instalaci√≥n');
        
        // Mostrar el bot√≥n despu√©s de 2 segundos
        setTimeout(() => {
            if (deferredPrompt && !checkIfPWAInstalled()) {
                console.log('üì± Mostrando bot√≥n de instalaci√≥n');
                showInstallButton();
            }
        }, 2000);
    }
});

// Funci√≥n para mostrar el bot√≥n de instalaci√≥n
function showInstallButton() {
    if (installPrompt) {
        installPrompt.style.display = 'flex';
        console.log('‚úÖ Bot√≥n de instalaci√≥n visible');
        
        // Ocultar despu√©s de 30 segundos
        setTimeout(() => {
            if (installPrompt.style.display !== 'none') {
                installPrompt.style.display = 'none';
                console.log('‚è∞ Bot√≥n de instalaci√≥n ocultado por timeout');
            }
        }, 30000);
    }
}

// Verificar si ya est√° instalada
function checkIfPWAInstalled() {
    console.log('üîç Verificando si PWA ya est√° instalada...');
    
    // M√©todo 1: Para iOS
    if (window.navigator.standalone === true) {
        console.log('üì± PWA ya instalada en iOS (window.navigator.standalone)');
        if (installPrompt) installPrompt.style.display = 'none';
        return true;
    }
    
    // M√©todo 2: Para Android/Chrome
    if (window.matchMedia('(display-mode: standalone)').matches) {
        console.log('üì± PWA ya instalada (display-mode: standalone)');
        if (installPrompt) installPrompt.style.display = 'none';
        return true;
    }
    
    // M√©todo 3: Para otros navegadores
    if (window.matchMedia('(display-mode: fullscreen)').matches || 
        window.matchMedia('(display-mode: minimal-ui)').matches) {
        console.log('üì± PWA ya instalada (otros modos)');
        if (installPrompt) installPrompt.style.display = 'none';
        return true;
    }
    
    console.log('üì± PWA NO est√° instalada');
    return false;
}

// Evento para el bot√≥n de instalaci√≥n
if (installPrompt) {
    installPrompt.addEventListener('click', async () => {
        console.log('üñ±Ô∏è Bot√≥n de instalaci√≥n clickeado');
        
        if (!deferredPrompt) {
            console.log('‚ö†Ô∏è No hay prompt de instalaci√≥n disponible');
            
            // Intentar m√©todo alternativo para iOS
            if (/iPhone|iPad|iPod/.test(navigator.userAgent)) {
                showIOSInstallInstructions();
                return;
            }
            
            return;
        }
        
        console.log('üì± Mostrando di√°logo de instalaci√≥n...');
        
        try {
            // Mostrar el prompt de instalaci√≥n
            deferredPrompt.prompt();
            
            // Esperar a que el usuario responda
            const choiceResult = await deferredPrompt.userChoice;
            
            console.log(`Usuario ${choiceResult.outcome === 'accepted' ? 'acept√≥' : 'rechaz√≥'} la instalaci√≥n`);
            
            // Limpiar la variable
            deferredPrompt = null;
            
            // Ocultar el bot√≥n
            if (installPrompt) {
                installPrompt.style.display = 'none';
            }
            
            if (choiceResult.outcome === 'accepted') {
                console.log('üéâ Instalaci√≥n aceptada');
                showInstallSuccess();
            }
            
        } catch (error) {
            console.error('‚ùå Error durante la instalaci√≥n:', error);
        }
    });
}

// Instrucciones para iOS
function showIOSInstallInstructions() {
    const instructions = document.createElement('div');
    instructions.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.8);
        color: white;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 10000;
        padding: 20px;
        text-align: center;
    `;
    
    instructions.innerHTML = `
        <div style="background: white; color: #333; padding: 30px; border-radius: 15px; max-width: 400px;">
            <h2 style="color: #2e7d32;">üì± Instalar en iOS</h2>
            <ol style="text-align: left; margin: 20px 0;">
                <li>Toca el bot√≥n <strong>Compartir</strong> (üì§)</li>
                <li>Despl√°zate hacia abajo</li>
                <li>Selecciona <strong>"Agregar a Inicio"</strong></li>
                <li>Toca <strong>"Agregar"</strong></li>
            </ol>
            <button onclick="this.parentElement.parentElement.remove()" 
                    style="background: #2e7d32; color: white; border: none; padding: 10px 20px; 
                           border-radius: 10px; cursor: pointer; font-weight: bold;">
                Entendido
            </button>
        </div>
    `;
    
    document.body.appendChild(instructions);
}

// Detectar si la app ya est√° instalada
window.addEventListener('appinstalled', () => {
    console.log('‚úÖ PWA instalada exitosamente (evento appinstalled)');
    
    if (installPrompt) {
        installPrompt.style.display = 'none';
    }
    
    deferredPrompt = null;
    
    // Mostrar notificaci√≥n de √©xito
    showInstallSuccess();
});

// Mostrar notificaci√≥n de √©xito
function showInstallSuccess() {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 100px;
        left: 50%;
        transform: translateX(-50%);
        background: #4CAF50;
        color: white;
        padding: 15px 25px;
        border-radius: 25px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        z-index: 10000;
        font-weight: bold;
        text-align: center;
        animation: slideIn 0.5s ease;
    `;
    
    // Agregar animaci√≥n si no existe
    if (!document.querySelector('style#slideInAnimation')) {
        const style = document.createElement('style');
        style.id = 'slideInAnimation';
        style.textContent = `
            @keyframes slideIn {
                from { 
                    transform: translateX(-50%) translateY(-50px); 
                    opacity: 0; 
                }
                to { 
                    transform: translateX(-50%) translateY(0); 
                    opacity: 1; 
                }
            }
        `;
        document.head.appendChild(style);
    }
    
    notification.innerHTML = '‚úÖ ¬°App instalada exitosamente!';
    
    document.body.appendChild(notification);
    
    // Remover despu√©s de 3 segundos
    setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(-50%) translateY(-20px)';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 500);
    }, 3000);
}

// 4. INICIALIZAR PWA - VERSI√ìN ROBUSTA
function initPWA() {
    console.log('üöÄ Inicializando PWA...');
    console.log('üìç URL actual:', window.location.href);
    console.log('üì± User Agent:', navigator.userAgent);
    console.log('üîå Online:', navigator.onLine);
    
    // Verificar HTTPS (importante para PWA)
    if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost') {
        console.warn('‚ö†Ô∏è PWA requiere HTTPS para funcionar completamente');
    }
    
    // Crear manifest din√°mico
    try {
        createDynamicManifest();
    } catch (error) {
        console.error('‚ùå Error creando manifest:', error);
    }
    
    // Registrar Service Worker
    try {
        registerServiceWorker();
    } catch (error) {
        console.error('‚ùå Error inicializando Service Worker:', error);
    }
    
    // Verificar si ya est√° instalada
    setTimeout(() => {
        checkIfPWAInstalled();
    }, 1000);
    
    // Forzar verificaci√≥n de instalaci√≥n peri√≥dicamente
    setInterval(() => {
        checkIfPWAInstalled();
    }, 5000);
    
    // Mostrar bot√≥n de instalaci√≥n en m√≥viles si no hay prompt autom√°tico
    if (/Android|iPhone|iPad|iPod|Mobile/i.test(navigator.userAgent)) {
        setTimeout(() => {
            if (!deferredPrompt && !checkIfPWAInstalled()) {
                console.log('üì± Mostrando bot√≥n de instalaci√≥n (fallback para m√≥vil)');
                showInstallButton();
            }
        }, 5000);
    }
}

// Agregar esta funci√≥n a tu init() existente
function init() {
    detectarAdmin();
    loadProductsFromSheets();
    setupEventListeners();
    setupSearch();
    updateCartCount();
    
    // INICIALIZAR PWA
    initPWA();
}

// Iniciar cuando el DOM est√© listo
document.addEventListener('DOMContentLoaded', () => {
    console.log('üìÑ DOM completamente cargado');
    init();
});

// Tambi√©n iniciar cuando la ventana se cargue completamente// ========== PWA - INSTALACI√ìN EN M√ìVILES ==========
let deferredPrompt;
const installPrompt = document.getElementById('installPrompt');

// 1. CREAR MANIFEST DIN√ÅMICAMENTE CORREGIDO
function createDynamicManifest() {
    const manifest = {
        "name": "Almac√©n Copihue",
        "short_name": "Almac√©n Copihue",
        "description": "Tu almac√©n de barrio - Productos de calidad con la confianza de siempre",
        "start_url": window.location.href,
        "display": "standalone",
        "background_color": "#2e7d32",
        "theme_color": "#2e7d32",
        "icons": [
            {
                "src": "https://via.placeholder.com/192x192/2e7d32/ffffff?text=AC",
                "sizes": "192x192",
                "type": "image/png"
            },
            {
                "src": "https://via.placeholder.com/512x512/2e7d32/ffffff?text=AC",
                "sizes": "512x512",
                "type": "image/png"
            }
        ],
        "orientation": "portrait",
        "scope": window.location.origin + "/"
    };
    
    // Crear el JSON correctamente
    const manifestJSON = JSON.stringify(manifest, null, 2);
    console.log('üì± Manifest JSON creado:', manifestJSON);
    
    // Crear Blob URL
    const manifestBlob = new Blob([manifestJSON], { 
        type: 'application/manifest+json; charset=utf-8' 
    });
    const manifestURL = URL.createObjectURL(manifestBlob);
    
    // Actualizar el link del manifest
    const manifestLink = document.getElementById('appManifest');
    manifestLink.href = manifestURL;
    
    console.log('‚úÖ Manifest PWA creado y configurado');
    return manifestURL;
}

// 2. REGISTRAR SERVICE WORKER CORREGIDO
function registerServiceWorker() {
    if ('serviceWorker' in navigator) {
        console.log('üîç Intentando registrar Service Worker...');
        
        // SW m√°s simple y robusto
        const swContent = `
            // Cache Name
            const CACHE_NAME = 'almacen-copihue-v1.0.0';
            
            // Instalar Service Worker
            self.addEventListener('install', (event) => {
                console.log('üîÑ Service Worker instalando...');
                self.skipWaiting();
            });
            
            // Activar Service Worker
            self.addEventListener('activate', (event) => {
                console.log('‚úÖ Service Worker activado');
                event.waitUntil(self.clients.claim());
            });
            
            // Interceptar peticiones
            self.addEventListener('fetch', (event) => {
                // Dejar pasar todas las peticiones
                return;
            });
        `;
        
        // Crear URL para el SW
        const blob = new Blob([swContent], { type: 'application/javascript' });
        const swURL = URL.createObjectURL(blob);
        
        // Registrar el SW
        navigator.serviceWorker.register(swURL, { 
            scope: './',
            updateViaCache: 'none' 
        })
        .then(registration => {
            console.log('‚úÖ Service Worker registrado exitosamente');
            console.log('üìå Scope:', registration.scope);
            console.log('üìå Estado:', registration.active ? 'Activo' : 'Inactivo');
            
            // Verificar si hay errores de instalaci√≥n
            if (registration.installing) {
                registration.installing.addEventListener('statechange', (e) => {
                    console.log('üìå Estado del SW:', e.target.state);
                });
            }
        })
        .catch(error => {
            console.error('‚ùå Error registrando Service Worker:', error);
            console.error('üìå Detalles del error:', error.message);
            
            // Intentar con un SW a√∫n m√°s simple
            registerFallbackServiceWorker();
        });
    } else {
        console.log('‚ö†Ô∏è Service Worker no soportado en este navegador');
    }
}

// SW de respaldo extremadamente simple
function registerFallbackServiceWorker() {
    console.log('üîÑ Intentando SW de respaldo...');
    
    const fallbackSW = `
        self.addEventListener('install', (event) => {
            console.log('‚úÖ SW de respaldo instalado');
            self.skipWaiting();
        });
        
        self.addEventListener('activate', (event) => {
            console.log('‚úÖ SW de respaldo activado');
        });
    `;
    
    try {
        const blob = new Blob([fallbackSW], { type: 'application/javascript' });
        const swURL = URL.createObjectURL(blob);
        
        navigator.serviceWorker.register(swURL)
            .then(reg => {
                console.log('‚úÖ SW de respaldo registrado');
                console.log('üìå Scope:', reg.scope);
            })
            .catch(err => {
                console.error('‚ùå Fall√≥ SW de respaldo:', err);
                console.log('‚ö†Ô∏è PWA funcionar√° sin Service Worker');
            });
    } catch (e) {
        console.error('‚ùå Error creando SW de respaldo:', e);
    }
}

// 3. MANEJAR INSTALACI√ìN PWA - VERSI√ìN SIMPLIFICADA
window.addEventListener('beforeinstallprompt', (e) => {
    console.log('üì± beforeinstallprompt disparado - M√≥vil detectado');
    
    // Prevenir que el banner aparezca autom√°ticamente
    e.preventDefault();
    
    // Guardar el evento para usarlo m√°s tarde
    deferredPrompt = e;
    
    // Mostrar bot√≥n de instalaci√≥n SOLO en m√≥viles
    if (/Android|iPhone|iPad|iPod|Mobile/i.test(navigator.userAgent)) {
        console.log('üì± Dispositivo m√≥vil confirmado - Preparando instalaci√≥n');
        
        // Mostrar el bot√≥n despu√©s de 2 segundos
        setTimeout(() => {
            if (deferredPrompt && !checkIfPWAInstalled()) {
                console.log('üì± Mostrando bot√≥n de instalaci√≥n');
                showInstallButton();
            }
        }, 2000);
    }
});

// Funci√≥n para mostrar el bot√≥n de instalaci√≥n
function showInstallButton() {
    if (installPrompt) {
        installPrompt.style.display = 'flex';
        console.log('‚úÖ Bot√≥n de instalaci√≥n visible');
        
        // Ocultar despu√©s de 30 segundos
        setTimeout(() => {
            if (installPrompt.style.display !== 'none') {
                installPrompt.style.display = 'none';
                console.log('‚è∞ Bot√≥n de instalaci√≥n ocultado por timeout');
            }
        }, 30000);
    }
}

// Verificar si ya est√° instalada
function checkIfPWAInstalled() {
    console.log('üîç Verificando si PWA ya est√° instalada...');
    
    // M√©todo 1: Para iOS
    if (window.navigator.standalone === true) {
        console.log('üì± PWA ya instalada en iOS (window.navigator.standalone)');
        if (installPrompt) installPrompt.style.display = 'none';
        return true;
    }
    
    // M√©todo 2: Para Android/Chrome
    if (window.matchMedia('(display-mode: standalone)').matches) {
        console.log('üì± PWA ya instalada (display-mode: standalone)');
        if (installPrompt) installPrompt.style.display = 'none';
        return true;
    }
    
    // M√©todo 3: Para otros navegadores
    if (window.matchMedia('(display-mode: fullscreen)').matches || 
        window.matchMedia('(display-mode: minimal-ui)').matches) {
        console.log('üì± PWA ya instalada (otros modos)');
        if (installPrompt) installPrompt.style.display = 'none';
        return true;
    }
    
    console.log('üì± PWA NO est√° instalada');
    return false;
}

// Evento para el bot√≥n de instalaci√≥n
if (installPrompt) {
    installPrompt.addEventListener('click', async () => {
        console.log('üñ±Ô∏è Bot√≥n de instalaci√≥n clickeado');
        
        if (!deferredPrompt) {
            console.log('‚ö†Ô∏è No hay prompt de instalaci√≥n disponible');
            
            // Intentar m√©todo alternativo para iOS
            if (/iPhone|iPad|iPod/.test(navigator.userAgent)) {
                showIOSInstallInstructions();
                return;
            }
            
            return;
        }
        
        console.log('üì± Mostrando di√°logo de instalaci√≥n...');
        
        try {
            // Mostrar el prompt de instalaci√≥n
            deferredPrompt.prompt();
            
            // Esperar a que el usuario responda
            const choiceResult = await deferredPrompt.userChoice;
            
            console.log(`Usuario ${choiceResult.outcome === 'accepted' ? 'acept√≥' : 'rechaz√≥'} la instalaci√≥n`);
            
            // Limpiar la variable
            deferredPrompt = null;
            
            // Ocultar el bot√≥n
            if (installPrompt) {
                installPrompt.style.display = 'none';
            }
            
            if (choiceResult.outcome === 'accepted') {
                console.log('üéâ Instalaci√≥n aceptada');
                showInstallSuccess();
            }
            
        } catch (error) {
            console.error('‚ùå Error durante la instalaci√≥n:', error);
        }
    });
}

// Instrucciones para iOS
function showIOSInstallInstructions() {
    const instructions = document.createElement('div');
    instructions.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.8);
        color: white;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 10000;
        padding: 20px;
        text-align: center;
    `;
    
    instructions.innerHTML = `
        <div style="background: white; color: #333; padding: 30px; border-radius: 15px; max-width: 400px;">
            <h2 style="color: #2e7d32;">üì± Instalar en iOS</h2>
            <ol style="text-align: left; margin: 20px 0;">
                <li>Toca el bot√≥n <strong>Compartir</strong> (üì§)</li>
                <li>Despl√°zate hacia abajo</li>
                <li>Selecciona <strong>"Agregar a Inicio"</strong></li>
                <li>Toca <strong>"Agregar"</strong></li>
            </ol>
            <button onclick="this.parentElement.parentElement.remove()" 
                    style="background: #2e7d32; color: white; border: none; padding: 10px 20px; 
                           border-radius: 10px; cursor: pointer; font-weight: bold;">
                Entendido
            </button>
        </div>
    `;
    
    document.body.appendChild(instructions);
}

// Detectar si la app ya est√° instalada
window.addEventListener('appinstalled', () => {
    console.log('‚úÖ PWA instalada exitosamente (evento appinstalled)');
    
    if (installPrompt) {
        installPrompt.style.display = 'none';
    }
    
    deferredPrompt = null;
    
    // Mostrar notificaci√≥n de √©xito
    showInstallSuccess();
});

// Mostrar notificaci√≥n de √©xito
function showInstallSuccess() {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 100px;
        left: 50%;
        transform: translateX(-50%);
        background: #4CAF50;
        color: white;
        padding: 15px 25px;
        border-radius: 25px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        z-index: 10000;
        font-weight: bold;
        text-align: center;
        animation: slideIn 0.5s ease;
    `;
    
    // Agregar animaci√≥n si no existe
    if (!document.querySelector('style#slideInAnimation')) {
        const style = document.createElement('style');
        style.id = 'slideInAnimation';
        style.textContent = `
            @keyframes slideIn {
                from { 
                    transform: translateX(-50%) translateY(-50px); 
                    opacity: 0; 
                }
                to { 
                    transform: translateX(-50%) translateY(0); 
                    opacity: 1; 
                }
            }
        `;
        document.head.appendChild(style);
    }
    
    notification.innerHTML = '‚úÖ ¬°App instalada exitosamente!';
    
    document.body.appendChild(notification);
    
    // Remover despu√©s de 3 segundos
    setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(-50%) translateY(-20px)';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 500);
    }, 3000);
}

// 4. INICIALIZAR PWA - VERSI√ìN ROBUSTA
function initPWA() {
    console.log('üöÄ Inicializando PWA...');
    console.log('üìç URL actual:', window.location.href);
    console.log('üì± User Agent:', navigator.userAgent);
    console.log('üîå Online:', navigator.onLine);
    
    // Verificar HTTPS (importante para PWA)
    if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost') {
        console.warn('‚ö†Ô∏è PWA requiere HTTPS para funcionar completamente');
    }
    
    // Crear manifest din√°mico
    try {
        createDynamicManifest();
    } catch (error) {
        console.error('‚ùå Error creando manifest:', error);
    }
    
    // Registrar Service Worker
    try {
        registerServiceWorker();
    } catch (error) {
        console.error('‚ùå Error inicializando Service Worker:', error);
    }
    
    // Verificar si ya est√° instalada
    setTimeout(() => {
        checkIfPWAInstalled();
    }, 1000);
    
    // Forzar verificaci√≥n de instalaci√≥n peri√≥dicamente
    setInterval(() => {
        checkIfPWAInstalled();
    }, 5000);
    
    // Mostrar bot√≥n de instalaci√≥n en m√≥viles si no hay prompt autom√°tico
    if (/Android|iPhone|iPad|iPod|Mobile/i.test(navigator.userAgent)) {
        setTimeout(() => {
            if (!deferredPrompt && !checkIfPWAInstalled()) {
                console.log('üì± Mostrando bot√≥n de instalaci√≥n (fallback para m√≥vil)');
                showInstallButton();
            }
        }, 5000);
    }
}

// Agregar esta funci√≥n a tu init() existente
function init() {
    detectarAdmin();
    loadProductsFromSheets();
    setupEventListeners();
    setupSearch();
    updateCartCount();
    
    // INICIALIZAR PWA
    initPWA();
}

// Iniciar cuando el DOM est√© listo
document.addEventListener('DOMContentLoaded', () => {
    console.log('üìÑ DOM completamente cargado');
    init();
});

// Tambi√©n iniciar cuando la ventana se cargue completamente
window.addEventListener('load', () => {
    console.log('üîÑ Ventana completamente cargada');
    // Verificar instalaci√≥n nuevamente
    setTimeout(checkIfPWAInstalled, 2000);
});
window.addEventListener('load', () => {
    console.log('üîÑ Ventana completamente cargada');
    // Verificar instalaci√≥n nuevamente
    setTimeout(checkIfPWAInstalled, 2000);
});
